<!doctype html><html lang=ja dir=ltr itemscope itemtype=http://schema.org/Article data-r-output-format=print><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.145.0"><meta name=generator content="Relearn 7.6.1+81b6d3c32c77aeecc29c4700d2123bd2fb3401c2"><meta name=description content="The following workshops require Ninja skills, wax on, wax off."><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Splunk4Ninjas Workshops :: Splunk Observability Cloud Workshops"><meta name=twitter:description content="The following workshops require Ninja skills, wax on, wax off."><meta property="og:url" content="https://splunk.github.io/observability-workshop/v5.97/ja/ninja-workshops/index.html"><meta property="og:site_name" content="Splunk Observability Cloud Workshops"><meta property="og:title" content="Splunk4Ninjas Workshops :: Splunk Observability Cloud Workshops"><meta property="og:description" content="The following workshops require Ninja skills, wax on, wax off."><meta property="og:locale" content="ja"><meta property="og:type" content="website"><meta itemprop=name content="Splunk4Ninjas Workshops :: Splunk Observability Cloud Workshops"><meta itemprop=description content="The following workshops require Ninja skills, wax on, wax off."><meta itemprop=dateModified content="2025-05-13T09:11:25+09:00"><meta itemprop=wordCount content="4"><title>Splunk4Ninjas Workshops :: Splunk Observability Cloud Workshops</title>
<link href=https://splunk.github.io/observability-workshop/v5.97/en/ninja-workshops/index.html rel=alternate hreflang=x-default><link href=https://splunk.github.io/observability-workshop/v5.97/en/ninja-workshops/index.html rel=alternate hreflang=en><link href=https://splunk.github.io/observability-workshop/v5.97/ja/ninja-workshops/index.html rel=alternate hreflang=ja><link href=https://splunk.github.io/observability-workshop/v5.97/ja/ninja-workshops/index.html rel=canonical type=text/html title="Splunk4Ninjas Workshops :: Splunk Observability Cloud Workshops"><link href=/observability-workshop/v5.97/images/favicon.ico?1752005933 rel=icon type=image/x-icon sizes=any><link href=/observability-workshop/v5.97/css/auto-complete/auto-complete.min.css?1752005933 rel=stylesheet><script src=/observability-workshop/v5.97/js/auto-complete/auto-complete.min.js?1752005933 defer></script><script src=/observability-workshop/v5.97/js/search-lunr.min.js?1752005933 defer></script><script src=/observability-workshop/v5.97/js/search.min.js?1752005933 defer></script><script>window.relearn=window.relearn||{},window.relearn.index_js_url="/observability-workshop/v5.97/searchindex.ja.js?1752005933"</script><script src=/observability-workshop/v5.97/js/lunr/lunr.min.js?1752005933 defer></script><script src=/observability-workshop/v5.97/js/lunr/lunr.stemmer.support.min.js?1752005933 defer></script><script src=/observability-workshop/v5.97/js/lunr/lunr.multi.min.js?1752005933 defer></script><script src=/observability-workshop/v5.97/js/lunr/tinyseg.js?1752005933 defer></script><script src=/observability-workshop/v5.97/js/lunr/lunr.ja.min.js?1752005933 defer></script><script>window.relearn=window.relearn||{},window.relearn.contentLangs=["ja"]</script><link href=/observability-workshop/v5.97/fonts/fontawesome/css/fontawesome-all.min.css?1752005933 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v5.97/fonts/fontawesome/css/fontawesome-all.min.css?1752005933 rel=stylesheet></noscript><link href=/observability-workshop/v5.97/css/perfect-scrollbar/perfect-scrollbar.min.css?1752005933 rel=stylesheet><link href=/observability-workshop/v5.97/css/theme.min.css?1752005933 rel=stylesheet><link href=/observability-workshop/v5.97/css/format-print.min.css?1752005933 rel=stylesheet id=R-format-style><script>window.relearn=window.relearn||{},window.relearn.min=`.min`,window.relearn.path="/ninja-workshops/index.html",window.relearn.relBasePath="../..",window.relearn.relBaseUri="../../../..",window.relearn.absBaseUri="https://splunk.github.io/observability-workshop/v5.97",window.relearn.disableAnchorCopy=!1,window.relearn.disableAnchorScrolling=!1,window.relearn.disableInlineCopyToClipboard=!0,window.relearn.enableBlockCodeWrap=!0,window.relearn.getItem=(e,t)=>e.getItem(t),window.relearn.setItem=(e,t,n)=>e.setItem(t,n),window.relearn.removeItem=(e,t)=>e.removeItem(t),window.T_Copy_to_clipboard=`クリップボードにコピー`,window.T_Copied_to_clipboard=`クリップボードにコピー!`,window.T_Copy_link_to_clipboard=`リンクをクリップボードにコピー`,window.T_Link_copied_to_clipboard=`リンクをクリップボードにコピーしました!`,window.T_Reset_view=`ビューのリセット`,window.T_View_reset=`リセットを見る`,window.T_No_results_found=`"{0}" の結果が見つかりません`,window.T_N_results_found=`"{0}" で {1} 件の結果が見つかりました`,window.relearn.themevariants=["auto","splunk-light","splunk-dark"],window.relearn.customvariantname="my-custom-variant",window.relearn.changeVariant=function(e){var t=document.documentElement.dataset.rThemeVariant;window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e),document.documentElement.dataset.rThemeVariant=e,t!=e&&(document.dispatchEvent(new CustomEvent("themeVariantLoaded",{detail:{variant:e,oldVariant:t}})),window.relearn.markVariant())},window.relearn.markVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant");document.querySelectorAll(".R-variantswitcher select").forEach(t=>{t.value=e})},window.relearn.initVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant")??"";e==window.relearn.customvariantname||(!e||!window.relearn.themevariants.includes(e))&&(e=window.relearn.themevariants[0],window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e)),document.documentElement.dataset.rThemeVariant=e},window.relearn.initVariant(),window.relearn.markVariant()</script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js crossorigin=anonymous></script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web-session-recorder.js crossorigin=anonymous></script><script>SplunkRum.init({realm:"us1",rumAccessToken:"Z8JjZ8iNiF4jSfNHvJIRJg",applicationName:"observability-workshop",deploymentEnvironment:"splunk.github.io",version:"1.0"}),SplunkSessionRecorder.init({app:"observability-workshop",realm:"us1",rumAccessToken:"Z8JjZ8iNiF4jSfNHvJIRJg"})</script></script><style>:root{--MAIN-WIDTH-MAX:130rem;--MENU-WIDTH-L:23rem}p{margin:.75rem 0}.highlight{max-height:500px;overflow-y:auto}pre:not(.mermaid){margin:0}</style></head><body class="mobile-support print" data-url=/observability-workshop/v5.97/ja/ninja-workshops/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="メニュー (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div><div class="topbar-button topbar-button-toc" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title="目次 (CTRL+ALT+t)"><i class="fa-fw fas fa-list-alt"></i></button><div class=topbar-content><div class=topbar-content-wrapper></div></div></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v5.97/ja/index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Splunk4Ninjas Workshops</span><meta itemprop=position content="2"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-print" data-content-empty=disable data-width-s=area-more data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v5.97/ja/ninja-workshops/index.print.html title="章全体を印刷する (CTRL+ALT+p)"><i class="fa-fw fas fa-print"></i></a></div><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v5.97/ja/splunk4rookies/observability-cloud/10-wrap-up/key-takeaways/index.html title="主要なポイント (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v5.97/ja/ninja-workshops/6-lambda-kinesis/index.html title="AWS Lambda関数の分散トレーシング (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a></div><div class="topbar-button topbar-button-more" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title=更に><i class="fa-fw fas fa-ellipsis-v"></i></button><div class=topbar-content><div class=topbar-content-wrapper><div class="topbar-area topbar-area-more" data-area=more></div></div></div></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable ninja-workshops" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=splunk4ninjas-workshops>Splunk4Ninjas Workshops</h1><ul class="children children-li children-sort-"><li class=children-title><a href=/observability-workshop/v5.97/ja/ninja-workshops/6-lambda-kinesis/index.html>Lambdaトレーシング</a><p>このワークショップでは、AWS Lambdaで実行される小規模なサーバーレスアプリケーションの分散トレースを構築し、AWS Kinesisを介してメッセージをproduceおよびconsumeする方法を学びます</p></li><li class=children-title><a href=/observability-workshop/v5.97/ja/ninja-workshops/8-docker-k8s-otel/index.html>OpenTelemetry、Docker、K8sを実践で学ぶ</a><p>このワークショップでは、これらの概念を説明するためにシンプルな.NETアプリケーションを使用します。さあ、始めましょう！ワークショップの終わりまでに、OpenTelemetryを使用した.NETアプリケーションの計装の実践経験を積み、そのアプリケーションのDocker化およびKubernetesへのデプロイを行います。また、Helmを使用したOpenTelemetryコレクターのデプロイ、コレクター設定のカスタマイズ、コレクター設定の問題のトラブルシューティングの経験も得られます。</p></li></ul><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/05/13</span></span></footer></article><section><h1 class=a11y-only>Splunk4Ninjas Workshopsのサブセクション</h1><article class=default><header class=headline></header><h1 id=aws-lambda関数の分散トレーシング>AWS Lambda関数の分散トレーシング</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>45 minutes</span>
</span>&nbsp;
<span class="badge cstyle blue badge-with-title"><span class=badge-title class=text-muted>Author
</span><span class=badge-content>Guy-Francis Kono</span></span><p>このワークショップでは、AWS Lambda で実行される小規模なサーバーレスアプリケーションの分散トレースを構築し、AWS Kinesis を介してメッセージを produce および consume する方法を学びます。</p><p>まず、OpenTelemetry の自動計装がどのようにトレースをキャプチャし、選択した宛先にエクスポートするかを確認します。</p><p>次に、手動計装によってコンテキスト伝播を有効にする方法を見ていきます。</p><p>このワークショップのために、Splunk は AWS/EC2 上の Ubuntu Linux インスタンスを事前に構成しています。このインスタンスにアクセスするには、ワークショップインストラクターが提供する URL にアクセスしてください。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/05/29</span></span></footer></article><section><h1 class=a11y-only>Lambdaトレーシングのサブセクション</h1><article class=default><header class=headline></header><h1 id=セットアップ>セットアップ</h1><p><a href=#R-image-3418b6dd533822283e38ce3fa86f6f15 class=lightbox-link><img alt=手動計装されていないLambdaアプリケーション class="lazy lightbox figure-image" loading=lazy src=../images/01-Architecture.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-3418b6dd533822283e38ce3fa86f6f15><img alt=手動計装されていないLambdaアプリケーション class="lazy lightbox lightbox-image" loading=lazy src=../images/01-Architecture.png></a></p><h2 id=前提条件>前提条件</h2><h3 id=observability-ワークショップインスタンス>Observability ワークショップインスタンス</h3><p>Observability ワークショップは、多くの場合、Splunk が提供する事前設定済みの Ubuntu EC2 インスタンス上で実施されます。</p><p>ワークショップのインストラクターから、割り当てられたワークショップインスタンスの認証情報が提供されます。</p><p>インスタンスには以下の環境変数が既に設定されているはずです：</p><ul><li><strong>ACCESS_TOKEN</strong></li><li><strong>REALM</strong><ul><li><em>これらはワークショップ用の Splunk Observability Cloud の <strong>Access Token</strong> と <strong>Realm</strong> です。</em></li><li><em>これらは OpenTelemetry Collector によって、データを正しい Splunk Observability Cloud 組織に転送するために使用されます。</em></li></ul></li></ul><details open class="box cstyle notices note"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-exclamation-circle"></i><br></summary><div class=box-content><p><em>また、Multipass を使用してローカルの Observability ワークショップインスタンスをデプロイすることもできます。</em></p></div></details><h3 id=aws-command-line-interface-awscli>AWS Command Line Interface (awscli)</h3><p>AWS Command Line Interface、または<code>awscli</code>は、AWS リソースと対話するために使用される API です。このワークショップでは、特定のスクリプトがデプロイするリソースと対話するために使用されます。</p><p>Splunk が提供するワークショップインスタンスには、既に <strong>awscli</strong> がインストールされているはずです。</p><ul><li><p>インスタンスに <strong>aws</strong> コマンドがインストールされているか、次のコマンドで確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>which aws</span></span></code></pre></div><ul><li><em>予想される出力は <strong>/usr/local/bin/aws</strong> です</em></li></ul></li><li><p>インスタンスに <strong>aws</strong> コマンドがインストールされていない場合は、次のコマンドを実行します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt install awscli</span></span></code></pre></div></li></ul><h3 id=terraform>Terraform</h3><p>Terraform は、リソースを構成ファイルで定義することで、デプロイ、管理、破棄するための Infrastructure as Code（IaC）プラットフォームです。Terraform は HCL を使用してこれらのリソースを定義し、さまざまなプラットフォームやテクノロジのための複数のプロバイダーをサポートしています。</p><p>このワークショップでは、コマンドラインで Terraform を使用して、以下のリソースをデプロイします：</p><ol><li>AWS API Gateway</li><li>Lambda 関数</li><li>Kinesis Stream</li><li>CloudWatch ロググループ</li><li>S3 バケット<ul><li><em>およびその他のサポートリソース</em></li></ul></li></ol><p>Splunk が提供するワークショップインスタンスには、既に <strong>terraform</strong> がインストールされているはずです。</p><ul><li><p>インスタンスに <strong>terraform</strong> コマンドがインストールされているか確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>which terraform</span></span></code></pre></div><ul><li><em>予想される出力は <strong>/usr/local/bin/terraform</strong> です</em></li></ul></li><li><p>インスタンスに <strong>terraform</strong> コマンドがインストールされていない場合は、以下の Terraform が推奨するインストールコマンドを実行してください：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget -O- https://apt.releases.hashicorp.com/gpg <span class=p>|</span> sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com </span><span class=k>$(</span>lsb_release -cs<span class=k>)</span><span class=s2> main&#34;</span> <span class=p>|</span> sudo tee /etc/apt/sources.list.d/hashicorp.list
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sudo apt update <span class=o>&amp;&amp;</span> sudo apt install terraform</span></span></code></pre></div></li></ul><h3 id=ワークショップディレクトリ-o11y-lambda-workshop>ワークショップディレクトリ (o11y-lambda-workshop)</h3><p>ワークショップディレクトリ <code>o11y-lambda-workshop</code> は、今日使用する例の Lambda ベースのアプリケーションの自動計装と手動計装の両方を完了するための、すべての設定ファイルとスクリプトを含むリポジトリです。</p><ul><li><p>ホームディレクトリにワークショップディレクトリがあることを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> <span class=o>&amp;&amp;</span> ls</span></span></code></pre></div><ul><li><em>予想される出力には <strong>o11y-lambda-workshop</strong> が含まれるはずです</em></li></ul></li><li><p><strong>o11y-lambda-workshop</strong> ディレクトリがホームディレクトリにない場合は、次のコマンドでクローンします：</p></li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone https://github.com/gkono-splunk/o11y-lambda-workshop.git</span></span></code></pre></div><h3 id=aws--terraform-変数>AWS & Terraform 変数</h3><h4 id=aws>AWS</h4><p>AWS の CLI では、サービスによってデプロイされたリソースにアクセスし管理するための認証情報が必要です。このワークショップでは、Terraform と Python スクリプトの両方がタスクを実行するためにこれらの変数を必要とします。</p><ul><li><p>このワークショップのために <strong>awscli</strong> を <em><strong>access key ID</strong></em>、<em><strong>secret access key</strong></em> および <em><strong>region</strong></em> で構成します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws configure</span></span></code></pre></div><ul><li><p><em>このコマンドは以下のようなプロンプトを表示するはずです：</em></p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>AWS Access Key ID <span class=o>[</span>None<span class=o>]</span>: XXXXXXXXXXXXXXXX
</span></span><span class=line><span class=cl>AWS Secret Acces Key <span class=o>[</span>None<span class=o>]</span>: XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
</span></span><span class=line><span class=cl>Default region name <span class=o>[</span>None<span class=o>]</span>: us-east-1
</span></span><span class=line><span class=cl>Default outoput format <span class=o>[</span>None<span class=o>]</span>:</span></span></code></pre></div></li></ul></li><li><p>インスタンスで <strong>awscli</strong> が設定されていない場合は、次のコマンドを実行し、インストラクターから提供される値を入力してください。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws configure</span></span></code></pre></div></li></ul><h4 id=terraform-1>Terraform</h4><p>Terraform では、機密情報や動的データを.tf 設定ファイルにハードコーディングさせない、またはそれらの値をリソース定義全体で再利用できるようにするため、変数の受け渡しをサポートしています。</p><p>このワークショップでは、OpenTelemetry Lambda layer の適切な値で Lambda 関数をデプロイするため、Splunk Observability Cloud の取り込み値のため、そして環境とリソースを独自で即座に認識できるようにするための変数を Terraform で必要とします。</p><p>Terraform 変数(variable)は以下の方法で定義されます：</p><ul><li>変数を <em><strong>main.tf</strong></em> ファイルまたは <em><strong>variables.tf</strong></em> に定義する</li><li>以下のいずれかの方法で変数の値を設定する：<ul><li>ホストレベルで環境変数を設定し、その定義と同じ変数名を使用して、接頭辞として <em><strong>TF_VAR</strong></em> をつける</li><li><em><strong>terraform.tfvars</strong></em> ファイルに変数の値を設定する</li><li>terraform apply 実行時に引数として値を渡す</li></ul></li></ul><p>このワークショップでは、<em><strong>variables.tf</strong></em> と <em><strong>terraform.tfvars</strong></em> ファイルの組み合わせを使用して変数を設定します。</p><ul><li><p><strong>vi</strong> または <strong>nano</strong> のいずれかを使用して、<strong>auto</strong> または <strong>manual</strong> ディレクトリにある <em><strong>terraform.tfvars</strong></em> ファイルを開きます</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi ~/o11y-lambda-workshop/auto/terraform.tfvars</span></span></code></pre></div></li><li><p>変数に値を設定します。<strong>CHANGEME</strong> プレースホルダーをインストラクターから提供された値に置き換えてください。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>o11y_access_token</span> <span class=o>=</span> <span class=s2>&#34;CHANGEME&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>o11y_realm</span>        <span class=o>=</span> <span class=s2>&#34;CHANGEME&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>otel_lambda_layer</span> <span class=o>=</span> <span class=o>[</span><span class=s2>&#34;CHANGEME&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>prefix</span>            <span class=o>=</span> <span class=s2>&#34;CHANGEME&#34;</span></span></span></code></pre></div><ul><li><em>引用符（"）や括弧 ( [ ] ) はそのまま残し、プレースホルダー<code>CHANGEME</code>のみを変更してください。</em></li><li><em><strong>prefix</strong></em> は、他の参加者のリソースと区別するため、任意の文字列で設定する固有の識別子です。氏名やメールアドレスのエイリアスを使用することをお勧めします。</li><li><em><strong>prefix</strong> には小文字のみを使用してください。S3 のような特定の AWS リソースでは、大文字を使用するとエラーが発生します。</em></li></ul></li><li><p>ファイルを保存してエディタを終了します。</p></li><li><p>最後に、編集した <em><strong>terraform.tfvars</strong></em> ファイルを他のディレクトリにコピーします。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cp ~/o11y-lambda-workshop/auto/terraform.tfvars ~/o11y-lambda-workshop/manual</span></span></code></pre></div><ul><li><em>これは、自動計装と手動計装の両方の部分で同じ値を使用するためです</em></li></ul></li></ul><h3 id=ファイル権限>ファイル権限</h3><p>他のすべてのファイルはそのままでよいですが、<code>auto</code>と<code>manual</code>の両方にある<strong>send_message.py</strong>スクリプトは、ワークショップの一部として実行する必要があります。そのため、期待通りに実行するには、適切な権限が必要です。以下の手順に従って設定してください。</p><ul><li><p>まず、<code>o11y-lambda-workshop</code>ディレクトリにいることを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop</span></span></code></pre></div></li><li><p>次に、以下のコマンドを実行して<code>send_message.py</code>スクリプトに実行権限を設定します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo chmod <span class=m>755</span> auto/send_message.py manual/send_message.py</span></span></code></pre></div></li></ul><p>これで前提条件が整いましたので、ワークショップを始めることができます！</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/05/29</span></span></footer></article><article class=default><header class=headline></header><h1 id=自動計装>自動計装</h1><p>ワークショップの最初の部分では、OpenTelemetry による自動計装がどのようにして OpenTelemetry Collector に関数がどの言語で書かれているかを自動検出させ、それらの関数のトレースの取得を開始させるかを示します。</p><h3 id=自動計装ワークショップディレクトリとコンテンツ>自動計装ワークショップディレクトリとコンテンツ</h3><p>まず、<code>o11y-lambda-workshop/auto</code>ディレクトリとそのファイルの一部を見てみましょう。ここにはワークショップの自動計装部分のすべてのコンテンツがあります。</p><h4 id=auto-ディレクトリ><code>auto</code> ディレクトリ</h4><ul><li><p>以下のコマンドを実行して <strong>o11y-lambda-workshop/auto</strong> ディレクトリに移動します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/auto</span></span></code></pre></div></li><li><p>このディレクトリの内容を確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ls</span></span></code></pre></div><ul><li><p><em>出力には以下のファイルとディレクトリが含まれるはずです：</em></p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>handler             outputs.tf          terraform.tf        variables.tf
</span></span><span class=line><span class=cl>main.tf             send_message.py     terraform.tfvars</span></span></code></pre></div></li><li><p><em>出力には以下のファイルとディレクトリが含まれるはずです：</em></p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>get_logs.py    main.tf       send_message.py
</span></span><span class=line><span class=cl>handler        outputs.tf    terraform.tf</span></span></code></pre></div></li></ul></li></ul><h4 id=maintf-ファイル><code>main.tf</code> ファイル</h4><ul><li><p><code>main.tf</code> ファイルをより詳しく見てみましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat main.tf</span></span></code></pre></div></li></ul><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
ワークショップの質問</summary><div class=box-content><ul><li>このテンプレートによってどの AWS リソースが作成されているか特定できますか？</li><li>OpenTelemetry 計装がどこでセットアップされているか特定できますか？<ul><li><em>ヒント: Lambda 関数の定義を調べてください</em></li></ul></li><li>以前に設定した環境変数によってどの計装情報が提供されているか判断できますか？</li></ul></div></details><p>各 Lambda 関数の環境変数が設定されているセクションが見つかるはずです。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>environment <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>variables</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>SPLUNK_ACCESS_TOKEN</span> <span class=o>=</span> var.o11y_access_token
</span></span><span class=line><span class=cl>    <span class=nv>SPLUNK_REALM</span> <span class=o>=</span> var.o11y_realm
</span></span><span class=line><span class=cl>    <span class=nv>OTEL_SERVICE_NAME</span> <span class=o>=</span> <span class=s2>&#34;producer-lambda&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>OTEL_RESOURCE_ATTRIBUTES</span> <span class=o>=</span> <span class=s2>&#34;deployment.environment=</span><span class=si>${</span><span class=nv>var</span><span class=p>.prefix</span><span class=si>}</span><span class=s2>-lambda-shop&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>AWS_LAMBDA_EXEC_WRAPPER</span> <span class=o>=</span> <span class=s2>&#34;/opt/nodejs-otel-handler&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>KINESIS_STREAM</span> <span class=o>=</span> aws_kinesis_stream.lambda_streamer.name
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div><p>これらの環境変数を使用することで、いくつかの方法で自動計装を構成しています：</p><ul><li><p>環境変数を設定して、データのエクスポート先となる Splunk Observability Cloud 組織を OpenTelemetry collector に伝えています。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>SPLUNK_ACCESS_TOKEN</span> <span class=o>=</span> var.o11y_access_token
</span></span><span class=line><span class=cl><span class=nv>SPLUNK_ACCESS_TOKEN</span> <span class=o>=</span> var.o11y_realm</span></span></code></pre></div></li><li><p>また、OpenTelemetry が関数/サービスを識別し、それが属する環境/アプリケーションを認識するのに役立つ変数も設定しています。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>OTEL_SERVICE_NAME</span> <span class=o>=</span> <span class=s2>&#34;producer-lambda&#34;</span> <span class=c1># consumer関数の場合はconsumer-lambda</span>
</span></span><span class=line><span class=cl><span class=nv>OTEL_RESOURCE_ATTRIBUTES</span> <span class=o>=</span> <span class=s2>&#34;deployment.environment=</span><span class=si>${</span><span class=nv>var</span><span class=p>.prefix</span><span class=si>}</span><span class=s2>-lambda-shop&#34;</span></span></span></code></pre></div></li><li><p>コード言語に基づいて、関数のハンドラーに自動的にトレースデータを取得するために適用する必要があるラッパーを OpenTelemetry に知らせる環境変数を設定しています。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>AWS_LAMBDA_EXEC_WRAPPER - <span class=s2>&#34;/opt/nodejs-otel-handler&#34;</span></span></span></code></pre></div></li><li><p><code>producer-lambda</code>関数の場合、レコードを配置する Kinesis ストリームを関数に知らせるための環境変数を設定しています。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KINESIS_STREAM</span> <span class=o>=</span> aws_kinesis_stream.lambda_streamer.name</span></span></code></pre></div></li><li><p>これらの値は、「前提条件」セクションで設定した環境変数、および、この Terraform 構成ファイルの一部としてデプロイされるリソースから取得されます。</p></li></ul><p>また、各関数に Splunk OpenTelemetry Lambda layer を設定する引数も確認できるはずです</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>layers</span> <span class=o>=</span> var.otel_lambda_layer</span></span></code></pre></div><ul><li><p>OpenTelemetry Lambda layer は、Lambda 関数の呼び出し時に計測データを収集、処理、およびエクスポートするために必要なライブラリと依存関係を含むパッケージです。</p></li><li><p>すべての OpenTelemetry サポート言語のライブラリと依存関係を持つ一般的な OTel Lambda layer がありますが、関数をさらに軽量化するための言語固有の Lambda layer も存在します。</p><ul><li><em>各 AWS リージョンの関連する Splunk OpenTelemetry Lambda layer ARN（Amazon Resource Name）と最新バージョンは<a href=https://github.com/signalfx/lambda-layer-versions/blob/main/splunk-apm/splunk-apm.md rel=external target=_blank>こちら</a>で確認できます</em></li></ul></li></ul><h4 id=producermjs-ファイル><code>producer.mjs</code> ファイル</h4><p>次に、<code>producer-lambda</code>関数のコードを見てみましょう：</p><ul><li><p>以下のコマンドを実行して<code>producer.mjs</code>ファイルの内容を表示します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/o11y-lambda-workshop/auto/handler/producer.mjs</span></span></code></pre></div><ul><li>この NodeJS モジュールにはプロデューサー関数のコードが含まれています。</li><li>基本的に、この関数はメッセージを受け取り、そのメッセージを対象の Kinesis ストリームにレコードとして配置します</li></ul></li></ul><h3 id=lambda-関数のデプロイとトレースデータの生成>Lambda 関数のデプロイとトレースデータの生成</h3><p><code>auto</code>ディレクトリの内容に慣れたところで、ワークショップ用のリソースをデプロイし、Lambda 関数からトレースデータを生成していきます。</p><h4 id=autoディレクトリで-terraform-を初期化する><code>auto</code>ディレクトリで Terraform を初期化する</h4><p><code>main.tf</code>ファイルで定義されたリソースをデプロイするには、まず Terraform がそのファイルと同じフォルダで初期化されていることを確認する必要があります。</p><ul><li><p><code>auto</code> ディレクトリにいることを確認します:</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwd</span></span></code></pre></div><ul><li><em>予想される出力は <strong>~/o11y-lambda-workshop/auto</strong> です</em></li></ul></li><li><p><code>auto</code> ディレクトリにいない場合は、次のコマンドを実行します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/auto</span></span></code></pre></div></li><li><p>次のコマンドを実行して、このディレクトリで Terraform を初期化します</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform init</span></span></code></pre></div><ul><li>このコマンドは同じフォルダにいくつかの要素を作成します：<ul><li><code>.terraform.lock.hcl</code> ファイル：リソースを提供するために使用するプロバイダーを記録します</li><li><code>.terraform</code> ディレクトリ：プロバイダーの構成を保存します</li></ul></li><li>上記のファイルに加えて、<code>apply</code> サブコマンドを使用して terraform を実行すると、デプロイされたリソースの状態を追跡するために <code>terraform.tfstate</code> ファイルが作成されます。</li><li>これらにより、Terraform は <code>auto</code> ディレクトリの <code>main.tf</code> ファイル内で定義されたとおりに、リソースの作成、状態、破棄を管理できます</li></ul></li></ul><h4 id=lambda-関数とその他の-aws-リソースをデプロイする>Lambda 関数とその他の AWS リソースをデプロイする</h4><p>このディレクトリで Terraform を初期化したら、リソースのデプロイに進むことができます。</p><ul><li><p>まず、<strong>terraform plan</strong> コマンドを実行して、Terraform が問題なくリソースを作成できることを確認します。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform plan</span></span></code></pre></div><ul><li><em>これにより、リソースをデプロイするプランといくつかのデータが出力され、意図したとおりに動作することを確認できます。</em></li><li><em>プランに表示される値の一部は、作成後に判明するか、セキュリティ上の理由でマスクされていることに注意してください。</em></li></ul></li><li><p>次に、<strong>terraform apply</strong> コマンドを実行して、<strong>main.tf</strong> ファイルから Lambda 関数とその他のサポートリソースをデプロイします：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform apply</span></span></code></pre></div><ul><li><p><em><strong>Enter a value:</strong> プロンプトが表示されたら <strong>yes</strong> と応答します</em></p></li><li><p>これにより、以下のような出力が得られます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Outputs:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>base_url</span> <span class=o>=</span> <span class=s2>&#34;https://______.amazonaws.com/serverless_stage/producer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>consumer_function_name</span> <span class=o>=</span> <span class=s2>&#34;_____-consumer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>consumer_log_group_arn</span> <span class=o>=</span> <span class=s2>&#34;arn:aws:logs:us-east-1:############:log-group:/aws/lambda/______-consumer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>consumer_log_group_name</span> <span class=o>=</span> <span class=s2>&#34;/aws/lambda/______-consumer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>environment</span> <span class=o>=</span> <span class=s2>&#34;______-lambda-shop&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>lambda_bucket_name</span> <span class=o>=</span> <span class=s2>&#34;lambda-shop-______-______&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>producer_function_name</span> <span class=o>=</span> <span class=s2>&#34;______-producer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>producer_log_group_arn</span> <span class=o>=</span> <span class=s2>&#34;arn:aws:logs:us-east-1:############:log-group:/aws/lambda/______-producer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>producer_log_group_name</span> <span class=o>=</span> <span class=s2>&#34;/aws/lambda/______-producer&#34;</span></span></span></code></pre></div><ul><li><em>Terraform 出力は <strong>outputs.tf</strong> ファイルで定義されています。</em></li><li><em>これらの出力は、ワークショップの他の部分でもプログラム的に使用されます。</em></li></ul></li></ul></li></ul><h4 id=producer-lambda-url-base_url-にトラフィックを送信する><code>producer-lambda</code> URL (<code>base_url</code>) にトラフィックを送信する</h4><p>デプロイした Lambda 関数からトレースを取得し始めるには、トラフィックを生成する必要があります。<code>producer-lambda</code>関数のエンドポイントにメッセージを送信し、それを Kinesis ストリームにレコードとして配置し、その後<code>consumer-lambda</code>関数によってストリームから取得されるようにします。</p><ul><li><p><code>auto</code> ディレクトリにいることを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwd</span></span></code></pre></div><ul><li><em>予想される出力は <strong>~/o11y-lambda-workshop/auto</strong> です</em></li></ul></li><li><p><code>auto</code> ディレクトリにいない場合は、次のコマンドを実行します</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/auto</span></span></code></pre></div></li></ul><p><code>send_message.py</code> スクリプトは、コマンドラインで入力を受け取り、JSON ディクショナリに追加し、while ループの一部として <code>producer-lambda</code> 関数のエンドポイントに繰り返し送信する Python スクリプトです。</p><ul><li><p>Run the <code>send_message.py</code> script as a background process</p><ul><li><em><code>--name</code> と <code>--superpower</code> 引数が必要です</em></li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nohup ./send_message.py --name CHANGEME --superpower CHANGEME <span class=p>&amp;</span></span></span></code></pre></div><ul><li><p>メッセージが成功した場合は、以下のような出力が表示されるはずです</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>1<span class=o>]</span> <span class=m>79829</span>
</span></span><span class=line><span class=cl>user@host manual % appending output to nohup.out</span></span></code></pre></div><ul><li><em>ここで重要な情報は 2 つあります:</em><ul><li><em>1 行目のプロセス ID（この例では <code>79829</code>）、および</em></li><li><em><code>appending output to nohup.out</code> メッセージ</em></li></ul></li><li><em><code>nohup</code> コマンドはスクリプトがバックグラウンドに送られた時に切断されないようにします。また、コマンドからの curl 出力を、現在いるフォルダと同じフォルダにある nohup.out ファイルにキャプチャします。</em></li><li><em><code>&</code> はシェルプロセスにこのプロセスをバックグラウンドで実行するよう指示し、シェルが他のコマンドを実行できるようにします。</em></li></ul></li></ul></li><li><p>次に、<code>response.logs</code> ファイルの内容を確認して、<code>producer-lambda</code> エンドポイントへのリクエストが成功したことを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat response.logs</span></span></code></pre></div><ul><li>メッセージが成功していれば、画面に印刷された行の中に次の出力が表示されるはずです：</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Message placed in the Event Stream: {prefix}-lambda_stream&#34;</span><span class=o>}</span></span></span></code></pre></div><ul><li>失敗した場合は、次のように表示されます：</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Internal server error&#34;</span><span class=o>}</span></span></span></code></pre></div></li></ul><details open class="box cstyle notices important"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-bolt"></i>
重要</summary><div class=box-content><p>この場合は、ワークショップ進行役の一人に支援を求めてください。</p></div></details><h4 id=lambda-関数のログを表示する>Lambda 関数のログを表示する</h4><p>次に、Lambda 関数のログを確認しましょう。</p><ul><li><p><strong>producer-lambda</strong> ログを表示するには、<strong>producer.logs</strong> ファイルを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat producer.logs</span></span></code></pre></div></li><li><p><strong>consumer-lambda</strong> ログを表示するには、<strong>consumer.logs</strong> ファイルを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat consumer.logs</span></span></code></pre></div></li></ul><p>ログを注意深く調べてください。</p><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
ワークショップの質問</summary><div class=box-content><ul><li>OpenTelemetry が読み込まれているのが見えますか？<code>splunk-extension-wrapper</code>のある行に注目してください<ul><li><ul><li><em><strong>splunk-extension-wrapper</strong>が読み込まれているのを見るために<code>head -n 50 producer.logs</code>または<code>head -n 50 consumer.logs</code>の実行を検討してください。</em></li></ul></li></ul></li></ul></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/05/29</span></span></footer></article><article class=default><header class=headline></header><h1 id=splunk-apmlambda関数およびトレース>Splunk APM、Lambda関数およびトレース</h1><p>Lambda 関数は相当量のトレースデータを生成しているはずで、それを確認する必要があります。Lambda 関数のリソース定義で構成された環境変数と OpenTelemetry Lambda layer の組み合わせにより、Splunk APM で関数とトレースを表示する準備が整いました。</p><h4 id=splunk-apm-概要で環境名を確認する>Splunk APM 概要で環境名を確認する</h4><p>まず、Splunk APM が受信しているトレースデータから<code>Environment</code>を認識していることを確認しましょう。これは<code>main.tf</code>の Lambda 関数定義で設定した<code>OTEL_RESOURCE_ATTRIBUTES</code>変数の一部として設定した<code>deployment.name</code>です。これは先ほど実行した<code>terraform apply</code>コマンドの出力の 1 つでもありました。</p><p>Splunk Observability Cloud で：</p><ul><li><p>左側のメインメニューから<code>APM</code>ボタンをクリックします。これにより Splunk APM 概要に移動します。</p></li><li><p><code>Environment:</code>ドロップダウンからあなたの APM 環境を選択します。</p><ul><li><em>APM 環境は<code>PREFIX-lambda-shop</code>形式になっているはずです。<code>PREFIX</code>は前提条件セクションで設定した環境変数から取得されます</em></li></ul></li></ul><details open class="box cstyle notices note"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-exclamation-circle"></i>
メモ</summary><div class=box-content><p>トレースが Splunk APM に表示されるまで数分かかる場合があります。環境のリストにあなたの環境名が表示されるまで、ブラウザの更新ボタンを押してみてください</p></div></details><p><a href=#R-image-0129cab742476f08f97433f2a0f10776 class=lightbox-link><img alt="Splunk APM, Environment Name" class="lazy lightbox figure-image" loading=lazy src=../images/02-Auto-APM-EnvironmentName.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-0129cab742476f08f97433f2a0f10776><img alt="Splunk APM, Environment Name" class="lazy lightbox lightbox-image" loading=lazy src=../images/02-Auto-APM-EnvironmentName.png></a></p><h4 id=環境のサービスマップを表示する>環境のサービスマップを表示する</h4><p>Environment ドロップダウンから環境名を選択したら、Lambda 関数のサービスマップを確認できます。</p><ul><li>APM 概要ページの右側にある<code>Service Map</code>ボタンをクリックします。これによりサービスマップビューに移動します。</li></ul><p><a href=#R-image-3f13e0b92571eb5c7ff9388fcb16fda0 class=lightbox-link><img alt="Splunk APM、サービスマップボタン" class="lazy lightbox figure-image" loading=lazy src=../images/03-Auto-ServiceMapButton.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-3f13e0b92571eb5c7ff9388fcb16fda0><img alt="Splunk APM、サービスマップボタン" class="lazy lightbox lightbox-image" loading=lazy src=../images/03-Auto-ServiceMapButton.png></a></p><p><code>producer-lambda</code>関数とそのレコードを配置するために Kinesis ストリームに対して行っている呼び出しが表示されるはずです。</p><p><a href=#R-image-17b0306a912c8b407423506886d82b85 class=lightbox-link><img alt="Splunk APM、サービスマップ" class="lazy lightbox figure-image" loading=lazy src=../images/04-Auto-ServiceMap.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-17b0306a912c8b407423506886d82b85><img alt="Splunk APM、サービスマップ" class="lazy lightbox lightbox-image" loading=lazy src=../images/04-Auto-ServiceMap.png></a></p><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
ワークショップの質問</summary><div class=box-content><p>あなたの<code>consumer-lambda</code>関数はどうなっていますか？</p></div></details><h4 id=lambda-関数からのトレースを調査する>Lambda 関数からのトレースを調査する</h4><ul><li><code>Traces</code>ボタンをクリックしてトレースアナライザーを表示します。</li></ul><p><a href=#R-image-50c23cb8fa824b48e607a7375eaae934 class=lightbox-link><img alt="Splunk APM、トレースボタン" class="lazy lightbox figure-image" loading=lazy src=../images/05-Auto-TraceButton.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-50c23cb8fa824b48e607a7375eaae934><img alt="Splunk APM、トレースボタン" class="lazy lightbox lightbox-image" loading=lazy src=../images/05-Auto-TraceButton.png></a></p><p>このページでは、<code>producer-lambda</code>関数の OpenTelemetry Lambda layer から取り込まれたトレースを確認できます。</p><p><a href=#R-image-59930fba65b450030b6b58dd6bc76f5b class=lightbox-link><img alt="Splunk APM、トレースアナライザー" class="lazy lightbox figure-image" loading=lazy src=../images/06-Auto-TraceAnalyzer.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-59930fba65b450030b6b58dd6bc76f5b><img alt="Splunk APM、トレースアナライザー" class="lazy lightbox lightbox-image" loading=lazy src=../images/06-Auto-TraceAnalyzer.png></a></p><ul><li>リストからハイパーリンクされた<code>Trace ID</code>をクリックして、調査するトレースを選択します。</li></ul><p><a href=#R-image-728322a33ac6a595aa5c35f602d86b1f class=lightbox-link><img alt="Splunk APM、トレースとスパン" class="lazy lightbox figure-image" loading=lazy src=../images/07-Auto-TraceNSpans.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-728322a33ac6a595aa5c35f602d86b1f><img alt="Splunk APM、トレースとスパン" class="lazy lightbox lightbox-image" loading=lazy src=../images/07-Auto-TraceNSpans.png></a></p><p><code>producer-lambda</code>関数が Kinesis ストリームにレコードを配置しているのが確認できます。しかし、<code>consumer-lambda</code>関数のアクションが見当たりません！</p><p>これはトレースコンテキストが伝播されていないためです。このワークショップの時点では、Kinesis サービスはトレースコンテキスト伝播をすぐには対応していません。分散トレースは Kinesis サービスで止まっており、そのコンテキストがストリームを通じて自動的に伝播されないため、それ以上先を見ることができません。</p><p>少なくとも、今はまだ&mldr;</p><p>次のセクションでこの問題にどう対処するか見ていきましょう。しかしその前に、後片付けをしましょう！</p><h3 id=クリーンアップ>クリーンアップ</h3><p>この自動計装演習の一部としてデプロイしたリソースはクリーンアップする必要があります。同様に、<code>producer-lambda</code>エンドポイントに対してトラフィックを生成していたスクリプトも、まだ実行中であれば停止する必要があります。以下の手順に従ってクリーンアップを行ってください。</p><h4 id=send_messageの停止><code>send_message</code>の停止</h4><ul><li><p><code>send_message.py</code>スクリプトがまだ実行中の場合は、次のコマンドで停止します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>fg</span></span></code></pre></div><ul><li>これによりバックグラウンドプロセスがフォアグラウンドに移動します。</li><li>次に<code>[CONTROL-C]</code>を押してプロセスを終了できます。</li></ul></li></ul><h4 id=全ての-aws-リソースを破棄する>全ての AWS リソースを破棄する</h4><p>Terraform は個々のリソースの状態をデプロイメントとして管理するのに優れています。定義に変更があっても、デプロイされたリソースを更新することもできます。しかし、一からやり直すために、リソースを破棄し、このワークショップの手動計装部分の一部として再デプロイします。</p><p>以下の手順に従ってリソースを破棄してください：</p><ul><li><p><code>auto</code>ディレクトリにいることを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwd</span></span></code></pre></div><ul><li><em>期待される出力は <strong>~/o11y-lambda-workshop/auto</strong> です</em></li></ul></li><li><p><code>auto</code>ディレクトリにいない場合は、以下のコマンドを実行します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/auto</span></span></code></pre></div></li><li><p>先ほどデプロイした Lambda 関数とその他の AWS リソースを破棄します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform destroy</span></span></code></pre></div><ul><li><code>Enter a value:</code>プロンプトが表示されたら<code>yes</code>と応答します</li><li>これによりリソースが破棄され、クリーンな環境が残ります</li></ul></li></ul><p>このプロセスにより、私たちの活動の結果として作成されたファイルとディレクトリは残ります。それらについては心配する必要はありません。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/05/29</span></span></footer></article><article class=default><header class=headline></header><h1 id=手動計装>手動計装</h1><p>ワークショップの第 2 部では、OpenTelemetry による手動計装が計測データ収集を強化する方法を実演することに焦点を当てます。より具体的には、今回のケースでは、<code>producer-lambda</code>関数から<code>consumer-lambda</code>関数にトレースコンテキストデータを伝播させることができるようになります。これにより、現在は自動コンテキスト伝播をサポートしていない Kinesis ストリームを介しても、2 つの関数間の関係を見ることができるようになります。</p><h3 id=手動計装ワークショップディレクトリとコンテンツ>手動計装ワークショップディレクトリとコンテンツ</h3><p>再度、作業ディレクトリとそのファイルの一部を確認することから始めます。今回は <code>o11y-lambda-workshop/manual</code> ディレクトリです。ここにはワークショップの手動計装部分のすべてのコンテンツがあります。</p><h4 id=manual-ディレクトリ><code>manual</code> ディレクトリ</h4><ul><li><p>以下のコマンドを実行して <code>o11y-lambda-workshop/manual</code> ディレクトリに移動します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/manual</span></span></code></pre></div></li><li><p><code>ls</code> コマンドでこのディレクトリの内容を確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ls</span></span></code></pre></div><ul><li><p><em>出力には以下のファイルとディレクトリが含まれるはずです：</em></p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>handler             outputs.tf          terraform.tf        variables.tf
</span></span><span class=line><span class=cl>main.tf             send_message.py     terraform.tfvars</span></span></code></pre></div></li></ul></li></ul><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
ワークショップの質問</summary><div class=box-content><p>このディレクトリと最初に始めた auto ディレクトリに何か違いがありますか？</p></div></details><h4 id=auto-と-manual-のファイルを比較する><code>auto</code> と <code>manual</code> のファイルを比較する</h4><p>見た目が同じように見えるこれらのファイルが実際に同じかどうか確認しましょう。</p><ul><li><p><code>auto</code> と <code>manual</code> ディレクトリの <code>main.tf</code> ファイルを比較します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>diff ~/o11y-lambda-workshop/auto/main.tf ~/o11y-lambda-workshop/manual/main.tf</span></span></code></pre></div><ul><li>違いはありません！<em>(違いがあるはずはありません。もし違いがあれば、ワークショップ進行役に支援を求めてください)</em></li></ul></li><li><p>次に、<code>producer.mjs</code> ファイルを比較してみましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>diff ~/o11y-lambda-workshop/auto/handler/producer.mjs ~/o11y-lambda-workshop/manual/handler/producer.mjs</span></span></code></pre></div><ul><li>ここにはかなりの違いがあります！</li></ul></li><li><p>ファイル全体を表示してその内容を調べたい場合は以下を実行します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/o11y-lambda-workshop/handler/producer.mjs</span></span></code></pre></div><ul><li>必要な手動計装タスクを処理するために、いくつかの OpenTelemetry オブジェクトを関数に直接インポートしていることに注目してください。</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>context</span><span class=p>,</span> <span class=nx>propagation</span><span class=p>,</span> <span class=nx>trace</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;@opentelemetry/api&#34;</span><span class=p>;</span></span></span></code></pre></div><ul><li>プロデューサー関数でコンテキストを伝播するために、<a href=https://www.npmjs.com/package/@opentelemetry/api rel=external target=_blank>@opentelemetry/api</a> から次のオブジェクトをインポートしています：<ul><li>context</li><li>propagation</li><li>trace</li></ul></li></ul></li><li><p>最後に、<code>consumer.mjs</code> ファイルを比較します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>diff ~/o11y-lambda-workshop/auto/handler/consumer.mjs ~/o11y-lambda-workshop/manual/handler/consumer.mjs</span></span></code></pre></div><ul><li><p>ここにもいくつかの注目すべき違いがあります。より詳しく見てみましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat handler/consumer.mjs</span></span></code></pre></div><ul><li>このファイルでは、次の <a href=https://www.npmjs.com/package/@opentelemetry/api rel=external target=_blank>@opentelemetry/api</a> オブジェクトをインポートしています：<ul><li>propagation</li><li>trace</li><li>ROOT_CONTEXT</li></ul></li><li>これらを使用して、プロデューサー関数から伝播されたトレースコンテキストを抽出します</li><li>その後、抽出したトレースコンテキストに <code>name</code> と <code>superpower</code> に基づいた新しいスパン属性を追加します</li></ul></li></ul></li></ul><h4 id=プロデューサー関数からのトレースコンテキスト伝播>プロデューサー関数からのトレースコンテキスト伝播</h4><p>以下のコードはプロデューサー関数内で次のステップを実行します：</p><ol><li>このトレース用のトレーサーを取得する</li><li>コンテキストキャリアオブジェクトを初期化する</li><li>アクティブスパンのコンテキストをキャリアオブジェクトに注入する</li><li>Kinesis ストリームに配置しようとしているレコードを修正し、アクティブスパンのコンテキストをコンシューマーに運ぶキャリアを含める</li></ol><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>context</span><span class=p>,</span> <span class=nx>propagation</span><span class=p>,</span> <span class=nx>trace</span><span class=p>,</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;@opentelemetry/api&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>tracer</span> <span class=o>=</span> <span class=nx>trace</span><span class=p>.</span><span class=nx>getTracer</span><span class=p>(</span><span class=s1>&#39;lambda-app&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>tracer</span><span class=p>.</span><span class=nx>startActiveSpan</span><span class=p>(</span><span class=s1>&#39;put-record&#39;</span><span class=p>,</span> <span class=kr>async</span><span class=p>(</span><span class=nx>span</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>carrier</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=nx>propagation</span><span class=p>.</span><span class=nx>inject</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>active</span><span class=p>(),</span> <span class=nx>carrier</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>eventBody</span> <span class=o>=</span> <span class=nx>Buffer</span><span class=p>.</span><span class=nx>from</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>body</span><span class=p>,</span> <span class=s1>&#39;base64&#39;</span><span class=p>).</span><span class=nx>toString</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>data</span> <span class=o>=</span> <span class=s2>&#34;{\&#34;tracecontext\&#34;: &#34;</span> <span class=o>+</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>carrier</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34;, \&#34;record\&#34;: &#34;</span> <span class=o>+</span> <span class=nx>eventBody</span> <span class=o>+</span> <span class=s2>&#34;}&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=sb>`Record with Trace Context added:
</span></span></span><span class=line><span class=cl><span class=sb>      </span><span class=si>${</span><span class=nx>data</span><span class=si>}</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>await</span> <span class=nx>kinesis</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=nx>PutRecordCommand</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>StreamName</span><span class=o>:</span> <span class=nx>streamName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>PartitionKey</span><span class=o>:</span> <span class=s2>&#34;1234&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>Data</span><span class=o>:</span> <span class=nx>data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>}),</span>
</span></span><span class=line><span class=cl>        <span class=nx>message</span> <span class=o>=</span> <span class=sb>`Message placed in the Event Stream: </span><span class=si>${</span><span class=nx>streamName</span><span class=si>}</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>span</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span></span></span></code></pre></div><h4 id=コンシューマー関数でのトレースコンテキスト抽出>コンシューマー関数でのトレースコンテキスト抽出</h4><p>以下のコードはコンシューマー関数内で次のステップを実行します：</p><ol><li><code>producer-lambda</code>から取得したコンテキストをキャリアオブジェクトに抽出する</li><li>現在のコンテキストからトレーサーを抽出する</li><li>抽出したコンテキスト内でトレーサーを使用して新しいスパンを開始する</li><li>ボーナス：メッセージからの値を含むカスタム属性など、追加の属性をスパンに追加する！</li><li>完了したら、スパンを終了する</li></ol><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>propagation</span><span class=p>,</span> <span class=nx>trace</span><span class=p>,</span> <span class=nx>ROOT_CONTEXT</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;@opentelemetry/api&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>carrier</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span> <span class=nx>message</span> <span class=p>).</span><span class=nx>tracecontext</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>parentContext</span> <span class=o>=</span> <span class=nx>propagation</span><span class=p>.</span><span class=nx>extract</span><span class=p>(</span><span class=nx>ROOT_CONTEXT</span><span class=p>,</span> <span class=nx>carrier</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>tracer</span> <span class=o>=</span> <span class=nx>trace</span><span class=p>.</span><span class=nx>getTracer</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>OTEL_SERVICE_NAME</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>span</span> <span class=o>=</span> <span class=nx>tracer</span><span class=p>.</span><span class=nx>startSpan</span><span class=p>(</span><span class=s2>&#34;Kinesis.getRecord&#34;</span><span class=p>,</span> <span class=kc>undefined</span><span class=p>,</span> <span class=nx>parentContext</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>span</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s2>&#34;span.kind&#34;</span><span class=p>,</span> <span class=s2>&#34;server&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>body</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span> <span class=nx>message</span> <span class=p>).</span><span class=nx>record</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>body</span><span class=p>.</span><span class=nx>name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>span</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s2>&#34;custom.tag.name&#34;</span><span class=p>,</span> <span class=nx>body</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>body</span><span class=p>.</span><span class=nx>superpower</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>span</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s2>&#34;custom.tag.superpower&#34;</span><span class=p>,</span> <span class=nx>body</span><span class=p>.</span><span class=nx>superpower</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>      <span class=nx>span</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span></span></span></code></pre></div><p>これでどのような違いが生まれるか見てみましょう！</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/05/13</span></span></footer></article><article class=default><header class=headline></header><h1 id=lambda関数のデプロイとトレースデータの生成>Lambda関数のデプロイとトレースデータの生成</h1><p>トレースデータを収集したい関数やサービスに手動計装を適用する方法がわかったので、Lambda 関数を再度デプロイして、<code>producer-lambda</code>エンドポイントに対するトラフィックを生成していきましょう。</p><h4 id=manual-ディレクトリで-terraform-を初期化する><code>manual</code> ディレクトリで Terraform を初期化する</h4><p>新しいディレクトリにいるので、ここでもう一度 Terraform を初期化する必要があります。</p><ul><li><p><code>manual</code> ディレクトリにいることを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwd</span></span></code></pre></div><ul><li><em>予想される出力は <strong>~/o11y-lambda-workshop/manual</strong> です</em></li></ul></li><li><p><code>manual</code> ディレクトリにいない場合は、次のコマンドを実行します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/manual</span></span></code></pre></div></li><li><p>次のコマンドを実行して、このディレクトリで Terraform を初期化します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform init</span></span></code></pre></div></li></ul><h4 id=lambda-関数とその他の-aws-リソースをデプロイする>Lambda 関数とその他の AWS リソースをデプロイする</h4><p>それでは、これらのリソースを再度デプロイしましょう！</p><ul><li><p>問題がないことを確認するために、<strong>terraform plan</strong> コマンドを実行します。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform plan</span></span></code></pre></div></li><li><p>続いて、<strong>terraform apply</strong> コマンドを使用して <strong>main.tf</strong> ファイルから Lambda 関数とその他のサポートリソースをデプロイします：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform apply</span></span></code></pre></div><ul><li><p><em><strong>Enter a value:</strong> プロンプトが表示されたら <strong>yes</strong> と応答します</em></p></li><li><p>これにより、以下のような出力が得られます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Outputs:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>base_url</span> <span class=o>=</span> <span class=s2>&#34;https://______.amazonaws.com/serverless_stage/producer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>consumer_function_name</span> <span class=o>=</span> <span class=s2>&#34;_____-consumer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>consumer_log_group_arn</span> <span class=o>=</span> <span class=s2>&#34;arn:aws:logs:us-east-1:############:log-group:/aws/lambda/______-consumer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>consumer_log_group_name</span> <span class=o>=</span> <span class=s2>&#34;/aws/lambda/______-consumer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>environment</span> <span class=o>=</span> <span class=s2>&#34;______-lambda-shop&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>lambda_bucket_name</span> <span class=o>=</span> <span class=s2>&#34;lambda-shop-______-______&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>producer_function_name</span> <span class=o>=</span> <span class=s2>&#34;______-producer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>producer_log_group_arn</span> <span class=o>=</span> <span class=s2>&#34;arn:aws:logs:us-east-1:############:log-group:/aws/lambda/______-producer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>producer_log_group_name</span> <span class=o>=</span> <span class=s2>&#34;/aws/lambda/______-producer&#34;</span></span></span></code></pre></div></li></ul></li></ul><p>見ての通り、base_url の最初の部分とログループ ARN 以外は、このワークショップの自動計装部分をこの同じ時点まで実行したときと出力は概ね同じはずです。</p><h4 id=producer-lambda-エンドポイント-base_url-にトラフィックを送信する><code>producer-lambda</code> エンドポイント (base_url) にトラフィックを送信する</h4><p>もう一度、<code>name</code> と <code>superpower</code> をメッセージとしてエンドポイントに送信します。これはトレースコンテキストとともに、Kinesis ストリーム内のレコードに追加されます。</p><ul><li><p><code>manual</code> ディレクトリにいることを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwd</span></span></code></pre></div><ul><li><em>予想される出力は <strong>~/o11y-lambda-workshop/manual</strong> です</em></li></ul></li><li><p><code>manual</code> ディレクトリにいない場合は、次のコマンドを実行します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/manual</span></span></code></pre></div></li><li><p><code>send_message.py</code> スクリプトをバックグラウンドプロセスとして実行します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nohup ./send_message.py --name CHANGEME --superpower CHANGEME <span class=p>&amp;</span></span></span></code></pre></div></li><li><p>次に、response.logs ファイルの内容を確認して、<strong>producer-lambda</strong>エンドポイントへの呼び出しが成功しているか確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat response.logs</span></span></code></pre></div><ul><li><p>メッセージが成功していれば、画面に表示される行の中に次の出力が表示されるはずです：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Message placed in the Event Stream: hostname-eventStream&#34;</span><span class=o>}</span></span></span></code></pre></div></li><li><p>失敗した場合は、次のように表示されます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Internal server error&#34;</span><span class=o>}</span></span></span></code></pre></div></li></ul></li></ul><details open class="box cstyle notices important"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-bolt"></i>
重要</summary><div class=box-content><p>これが発生した場合は、ワークショップ進行役の一人に支援を求めてください。</p></div></details><h4 id=lambda-関数のログの確認>Lambda 関数のログの確認</h4><p>ログがどのようになっているか見てみましょう。</p><ul><li><p><strong>producer.logs</strong> ファイルを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat producer.logs</span></span></code></pre></div></li><li><p>そして <strong>consumer.logs</strong> ファイルを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat consumer.logs</span></span></code></pre></div></li></ul><p>ログを注意深く調べてください。</p><h5 id=ワークショップの質問><em>ワークショップの質問</em></h5><blockquote><p>違いに気づきましたか？</p></blockquote><h4 id=consumer-lambda-ログからのトレース-id-のコピー><code>consumer-lambda</code> ログからのトレース ID のコピー</h4><p>今回は、consumer-lambda のロググループが、我々が伝播した<code>tracecontext</code>とともに、メッセージを<code>record</code>としてログに記録しているのが確認できます。</p><p>トレース ID をコピーするには：</p><ul><li><code>Kinesis Message</code>ログの 1 つを見てみましょう。その中には<code>data</code>ディクショナリがあります</li><li>ネストされた<code>tracecontext</code>ディクショナリを見るために、<code>data</code>をより詳しく見てください</li><li><code>tracecontext</code>ディクショナリ内には、<code>traceparent</code>というキーと値のペアがあります</li><li><code>traceparent</code>キーと値のペアには、私たちが探しているトレース ID が含まれています<ul><li><code>-</code>で区切られた 4 つの値のグループがあります。トレース ID は 2 番目の文字グループです</li></ul></li><li><strong>トレース ID をコピーして保存してください。</strong> このワークショップの後のステップで必要になります</li></ul><p><a href=#R-image-dbf41db0fa390e66c085f1d7364e19fc class=lightbox-link><img alt="Lambda Consumer Logs、手動計装" class="lazy lightbox figure-image" loading=lazy src=../images/08-Manual-ConsumerLogs.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-dbf41db0fa390e66c085f1d7364e19fc><img alt="Lambda Consumer Logs、手動計装" class="lazy lightbox lightbox-image" loading=lazy src=../images/08-Manual-ConsumerLogs.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/05/29</span></span></footer></article><article class=default><header class=headline></header><h1 id=splunk-apmlambda関数とトレース再び>Splunk APM、Lambda関数とトレース、再び！</h1><p>ログの外部でコンテキスト伝播の結果を確認するために、もう一度<a href=https://app.us1.signalfx.com/#/apm rel=external target=_blank>Splunk APM UI</a>を参照します。</p><h4 id=splunk-apm-サービスマップで-lambda-関数を表示する>Splunk APM サービスマップで Lambda 関数を表示する</h4><p>もう一度 APM で環境のサービスマップを確認してみましょう。</p><p>Splunk Observability Cloud で：</p><ul><li><p>メインメニューの<code>APM</code>ボタンをクリックします。</p></li><li><p><code>Environment:</code>ドロップダウンからあなたの APM 環境を選択します。</p></li><li><p>APM 概要ページの右側にある<code>Service Map</code>ボタンをクリックします。これによりサービスマップビューに移動します。</p></li></ul><details open class="box cstyle notices note"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-exclamation-circle"></i>
> <em>注意：トレースが Splunk APM に表示されるまで数分かかる場合があります。環境のリストにあなたの環境名が表示されるまで、ブラウザの更新ボタンを押してみてください</em></summary></details><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
ワークショップの質問</summary><div class=box-content><p>違いに気づきましたか？</p></div></details><ul><li>今回は、伝播されたコンテキストによってリンクされた<code>producer-lambda</code>と<code>consumer-lambda</code>関数が見えるはずです！</li></ul><p><a href=#R-image-0136227221f95b9f0d58e364a8049200 class=lightbox-link><img alt="Splunk APM、サービスマップ" class="lazy lightbox figure-image" loading=lazy src=../images/09-Manual-ServiceMap.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-0136227221f95b9f0d58e364a8049200><img alt="Splunk APM、サービスマップ" class="lazy lightbox lightbox-image" loading=lazy src=../images/09-Manual-ServiceMap.png></a></p><h4 id=トレース-id-で-lambda-トレースを調査する>トレース ID で Lambda トレースを調査する</h4><p>次に、環境に関連するトレースをもう一度確認します。</p><ul><li>コンシューマー関数のログからコピーしたトレース ID を、Traces 下の<code>View Trace ID</code>検索ボックスに貼り付け、<code>Go</code>をクリックします</li></ul><p><a href=#R-image-755a7f1c59912951d16ced182fa2a08a class=lightbox-link><img alt="Splunk APM、トレースボタン" class="lazy lightbox figure-image" loading=lazy src=../images/10-Manual-TraceButton.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-755a7f1c59912951d16ced182fa2a08a><img alt="Splunk APM、トレースボタン" class="lazy lightbox lightbox-image" loading=lazy src=../images/10-Manual-TraceButton.png></a></p><details open class="box cstyle notices note"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-exclamation-circle"></i>
メモ</summary><div class=box-content><p>トレース ID は、私たちが伝播したトレースコンテキストの一部でした。</p></div></details><p>最も一般的な 2 つの伝播規格について読むことができます：</p><ol><li><a href=https:///www.w3.org/TR/trace-context/#traceparent-header rel=external target=_blank>W3C</a></li><li><a href=https://github.com/openzipkin/b3-propagation#overall-process rel=external target=_blank>B3</a></li></ol><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
ワークショップの質問</summary><div class=box-content><p>私たちはどちらを使用していますか？</p><ul><li><em>私たちの NodeJS 関数をサポートする Splunk Distribution of Opentelemetry JS は、<a href=https://docs.splunk.com/observability/en/gdi/get-data-in/application/nodejs/splunk-nodejs-otel-distribution.html#defaults-of-the-splunk-distribution-of-opentelemetry-js rel=external target=_blank>デフォルト</a>で<code>W3C</code>標準を使用しています</em></li></ul></div></details><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
ワークショップの質問</summary><div class=box-content><p>ボーナス質問：W3C ヘッダーと B3 ヘッダーを混在させるとどうなりますか？</p></div></details><p><a href=#R-image-d056c422f432e1389c05360c58822849 class=lightbox-link><img alt="Splunk APM、IDによるトレース" class="lazy lightbox figure-image" loading=lazy src=../images/11-Manual-TraceByID.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d056c422f432e1389c05360c58822849><img alt="Splunk APM、IDによるトレース" class="lazy lightbox lightbox-image" loading=lazy src=../images/11-Manual-TraceByID.png></a></p><p><code>consumer-lambda</code>スパンをクリックしてください。</p><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
ワークショップの質問</summary><div class=box-content><p>あなたのメッセージからの属性を見つけることができますか？</p></div></details><p><a href=#R-image-5c4aa2e11fb496a891e9511e306860a7 class=lightbox-link><img alt="Splunk APM、スパンタグ" class="lazy lightbox figure-image" loading=lazy src=../images/12-Manual-SpanTags.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5c4aa2e11fb496a891e9511e306860a7><img alt="Splunk APM、スパンタグ" class="lazy lightbox lightbox-image" loading=lazy src=../images/12-Manual-SpanTags.png></a></p><h3 id=クリーンアップ>クリーンアップ</h3><p>いよいよワークショップの最後に来ました。後片付けをしましょう！</p><h4 id=send_messageの停止><code>send_message</code>の停止</h4><ul><li><p><code>send_message.py</code>スクリプトがまだ実行中の場合は、次のコマンドで停止します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>fg</span></span></code></pre></div><ul><li>これによりバックグラウンドプロセスがフォアグラウンドに移動します。</li><li>次に<code>[CONTROL-C]</code>を押してプロセスを終了できます。</li></ul></li></ul><h4 id=すべての-aws-リソースを破棄する>すべての AWS リソースを破棄する</h4><p>Terraform は個々のリソースの状態をデプロイメントとして管理するのに優れています。定義に変更があっても、デプロイされたリソースを更新することもできます。しかし、一からやり直すために、リソースを破棄し、このワークショップの手動計装部分の一部として再デプロイします。</p><p>以下の手順に従ってリソースを破棄してください：</p><ul><li><p><code>manual</code>ディレクトリにいることを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwd</span></span></code></pre></div><ul><li><em>予想される出力は <strong>~/o11y-lambda-workshop/manual</strong> です</em></li></ul></li><li><p><code>manual</code>ディレクトリにいない場合は、次のコマンドを実行します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/manual</span></span></code></pre></div></li><li><p>以前にデプロイした Lambda 関数とその他の AWS リソースを破棄します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform destroy</span></span></code></pre></div><ul><li><code>Enter a value:</code>プロンプトが表示されたら<code>yes</code>と応答します</li><li>これにより、リソースが破棄され、クリーンな環境が残ります</li></ul></li></ul><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/05/13</span></span></footer></article><article class=default><header class=headline></header><h1 id=結論>結論</h1><p>Lambda Tracing ワークショップを終えたことをおめでとうございます！自動計装を手動のステップで補完して、<code>producer-lambda</code>関数のコンテキストを Kinesis ストリーム内のレコードを介して<code>consumer-lambda</code>関数に送信する方法を見てきました。これにより、期待される分散トレースを構築し、Splunk APM で両方の関数間の関係をコンテキスト化することができました。</p><p><a href=#R-image-e386b0fa41cb697f02bf69f1451b9d45 class=lightbox-link><img alt=完全に計装されたLambdaアプリケーション class="lazy lightbox figure-image" loading=lazy src=../images/13-Architecture_Instrumented.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e386b0fa41cb697f02bf69f1451b9d45><img alt=完全に計装されたLambdaアプリケーション class="lazy lightbox lightbox-image" loading=lazy src=../images/13-Architecture_Instrumented.png></a></p><p>これで、2 つの異なる関数を手動でリンクしてトレースを構築することができます。これは、自動計装や第三者のシステムがコンテキスト伝播を標準でサポートしていない場合や、より関連性の高いトレース分析のためにカスタム属性をトレースに追加したい場合に役立ちます。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/05/13</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=opentelemetrydockerk8sを実践で学ぶ>OpenTelemetry、Docker、K8sを実践で学ぶ</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>2 minutes</span>
</span>&nbsp;
<span class="badge cstyle blue badge-with-title"><span class=badge-title class=text-muted>Author
</span><span class=badge-content>Derek Mitchell</span></span><p>このワークショップでは、以下の項目について実践経験を積むことができます：</p><ul><li>Linux および Kubernetes 環境で、Splunk ディストリビューションの OpenTelemetry .NET を使用してコレクターのデプロイと.NET アプリケーションの計装を実践します。</li><li>.NET アプリケーションの「Docker 化」、Docker での実行、そして Splunk OpenTelemetry 計装の追加を実践します。</li><li>Helm を使用した K8s 環境での Splunk ディストロのコレクターのデプロイを実践します。その後、コレクター設定をカスタマイズし、問題のトラブルシューティングを行います。</li></ul><details open class="box cstyle notices primary"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-lightbulb"></i>
Tip</summary><div class=box-content><p>このワークショップを最も簡単にナビゲートする方法は以下を使用することです：</p><ul><li>このページの右上にある左右の矢印（<strong>&lt;</strong> | <strong>></strong>）</li><li>キーボードの左（◀️）と右（▶️）のカーソルキー</li></ul></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/06/17</span></span></footer></article><section><h1 class=a11y-only>OpenTelemetry、Docker、K8sを実践で学ぶのサブセクション</h1><article class=default><header class=headline></header><h1 id=ec2インスタンスへの接続>EC2インスタンスへの接続</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>5 minutes</span>
</span>&nbsp;<h2 id=ec2-インスタンスへ接続>EC2 インスタンスへ接続</h2><p>各参加者のために、AWS/EC2 に Ubuntu Linux インスタンスを用意しました。</p><p>インストラクターから提供された IP アドレスとパスワードを使用して、以下のいずれかの方法で EC2 インスタンスに接続してください：</p><ul><li>Mac OS / Linux<ul><li>ssh splunk@IP アドレス</li></ul></li><li>Windows 10+<ul><li>OpenSSH クライアントを使用</li></ul></li><li>以前のバージョンの Windows<ul><li>Putty を使用</li></ul></li></ul><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/06/16</span></span></footer></article><article class=default><header class=headline></header><h1 id=opentelemetryコレクターのデプロイ>OpenTelemetryコレクターのデプロイ</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<h2 id=opentelemetry-コレクターのアンインストール>OpenTelemetry コレクターのアンインストール</h2><p>EC2 インスタンスには、すでに Splunk Distribution の OpenTelemetry コレクターの古いバージョンが
インストールされている可能性があります。先に進む前に、次のコマンドを使用してアンインストールしましょう：</p><div class=tab-panel data-tab-group=27c707e995b107170de1241301068b00><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("27c707e995b107170de1241301068b00","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("27c707e995b107170de1241301068b00","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -sSL https://dl.signalfx.com/splunk-otel-collector.sh &gt; /tmp/splunk-otel-collector.sh<span class=p>;</span>
</span></span><span class=line><span class=cl>sudo sh /tmp/splunk-otel-collector.sh --uninstall</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Reading package lists... Done
</span></span><span class=line><span class=cl>Building dependency tree... Done
</span></span><span class=line><span class=cl>Reading state information... Done
</span></span><span class=line><span class=cl>The following packages will be REMOVED:
</span></span><span class=line><span class=cl>  splunk-otel-collector*
</span></span><span class=line><span class=cl><span class=m>0</span> upgraded, <span class=m>0</span> newly installed, <span class=m>1</span> to remove and <span class=m>167</span> not upgraded.
</span></span><span class=line><span class=cl>After this operation, <span class=m>766</span> MB disk space will be freed.
</span></span><span class=line><span class=cl><span class=o>(</span>Reading database ... <span class=m>157441</span> files and directories currently installed.<span class=o>)</span>
</span></span><span class=line><span class=cl>Removing splunk-otel-collector <span class=o>(</span>0.92.0<span class=o>)</span> ...
</span></span><span class=line><span class=cl><span class=o>(</span>Reading database ... <span class=m>147373</span> files and directories currently installed.<span class=o>)</span>
</span></span><span class=line><span class=cl>Purging configuration files <span class=k>for</span> splunk-otel-collector <span class=o>(</span>0.92.0<span class=o>)</span> ...
</span></span><span class=line><span class=cl>Scanning processes...
</span></span><span class=line><span class=cl>Scanning candidates...
</span></span><span class=line><span class=cl>Scanning linux images...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Running kernel seems to be up-to-date.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Restarting services...
</span></span><span class=line><span class=cl> systemctl restart fail2ban.service falcon-sensor.service
</span></span><span class=line><span class=cl>Service restarts being deferred:
</span></span><span class=line><span class=cl> systemctl restart networkd-dispatcher.service
</span></span><span class=line><span class=cl> systemctl restart unattended-upgrades.service
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>No containers need to be restarted.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>No user sessions are running outdated binaries.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>No VM guests are running outdated hypervisor <span class=o>(</span>qemu<span class=o>)</span> binaries on this host.
</span></span><span class=line><span class=cl>Successfully removed the splunk-otel-collector package</span></span></code></pre></div></div></div></div></div><h2 id=opentelemetry-collector-のデプロイ>OpenTelemetry collector のデプロイ</h2><p>Linux EC2 インスタンスに、Splunk Distribution の OpenTelemetry コレクターの最新バージョンをデプロイしましょう。</p><p>これは<code>curl</code>を使用してコレクターバイナリをダウンロードし、特定の引数を指定して実行することで可能です。
これらの引数は、データを送信する realm、使用するアクセストークン、
およびデータを送信するデプロイメント環境をコレクターに指示します。</p><blockquote><p>Splunk Observability Cloud におけるデプロイメント環境とは、システムまたはアプリケーションの個別のデプロイメントであり、同じアプリケーションの他のデプロイメントの設定と重複しない設定を行うことができます。</p></blockquote><div class=tab-panel data-tab-group=15047963691483ae71634f3eaeea31b9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("15047963691483ae71634f3eaeea31b9","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("15047963691483ae71634f3eaeea31b9","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -sSL https://dl.signalfx.com/splunk-otel-collector.sh &gt; /tmp/splunk-otel-collector.sh<span class=p>;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>sudo sh /tmp/splunk-otel-collector.sh <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--realm <span class=nv>$REALM</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--mode agent <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--without-instrumentation <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--deployment-environment otel-<span class=nv>$INSTANCE</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-- <span class=nv>$ACCESS_TOKEN</span></span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Splunk OpenTelemetry Collector Version: latest
</span></span><span class=line><span class=cl>Memory Size in MIB: <span class=m>512</span>
</span></span><span class=line><span class=cl>Realm: us1
</span></span><span class=line><span class=cl>Ingest Endpoint: https://ingest.us1.signalfx.com
</span></span><span class=line><span class=cl>API Endpoint: https://api.us1.signalfx.com
</span></span><span class=line><span class=cl>HEC Endpoint: https://ingest.us1.signalfx.com/v1/log
</span></span><span class=line><span class=cl>etc.</span></span></code></pre></div></div></div></div></div><p>詳細については、<a href=https://docs.splunk.com/observability/en/gdi/opentelemetry/collector-linux/install-linux.html#otel-install-linux rel=external target=_blank>インストーラースクリプトを使用した Linux 用コレクターのインストール</a>
を参照してください。</p><h2 id=コレクターが実行中であることを確認>コレクターが実行中であることを確認</h2><p>インスタンスでコレクターが正常に実行されていることを確認しましょう。</p><blockquote><p>ステータスコマンドを終了するには、Ctrl + C を押します。</p></blockquote><div class=tab-panel data-tab-group=5ff4fba98d27a3543b5952692316c9be><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5ff4fba98d27a3543b5952692316c9be","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("5ff4fba98d27a3543b5952692316c9be","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl status splunk-otel-collector</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>● splunk-otel-collector.service - Splunk OpenTelemetry Collector
</span></span><span class=line><span class=cl>     Loaded: loaded <span class=o>(</span>/lib/systemd/system/splunk-otel-collector.service<span class=p>;</span> enabled<span class=p>;</span> vendor preset: enabled<span class=o>)</span>
</span></span><span class=line><span class=cl>    Drop-In: /etc/systemd/system/splunk-otel-collector.service.d
</span></span><span class=line><span class=cl>             └─service-owner.conf
</span></span><span class=line><span class=cl>     Active: active <span class=o>(</span>running<span class=o>)</span> since Fri 2024-12-20 00:13:14 UTC<span class=p>;</span> 45s ago
</span></span><span class=line><span class=cl>   Main PID: <span class=m>14465</span> <span class=o>(</span>otelcol<span class=o>)</span>
</span></span><span class=line><span class=cl>      Tasks: <span class=m>9</span> <span class=o>(</span>limit: 19170<span class=o>)</span>
</span></span><span class=line><span class=cl>     Memory: 117.4M
</span></span><span class=line><span class=cl>        CPU: 681ms
</span></span><span class=line><span class=cl>     CGroup: /system.slice/splunk-otel-collector.service
</span></span><span class=line><span class=cl>             └─14465 /usr/bin/otelcol</span></span></code></pre></div></div></div></div></div><h2 id=コレクターログの確認方法>コレクターログの確認方法</h2><p><code>journalctl</code>を使用してコレクターログを表示できます：</p><blockquote><p>ログの監視を終了するには、Ctrl + C を押します。</p></blockquote><div class=tab-panel data-tab-group=0cbaa653e5e0061d5eaf95650fe5d5fb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0cbaa653e5e0061d5eaf95650fe5d5fb","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("0cbaa653e5e0061d5eaf95650fe5d5fb","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo journalctl -u splunk-otel-collector -f -n <span class=m>100</span></span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Dec <span class=m>20</span> 00:13:14 derek-1 systemd<span class=o>[</span>1<span class=o>]</span>: Started Splunk OpenTelemetry Collector.
</span></span><span class=line><span class=cl>Dec <span class=m>20</span> 00:13:14 derek-1 otelcol<span class=o>[</span>14465<span class=o>]</span>: 2024/12/20 00:13:14 settings.go:483: Set config to /etc/otel/collector/agent_config.yaml
</span></span><span class=line><span class=cl>Dec <span class=m>20</span> 00:13:14 derek-1 otelcol<span class=o>[</span>14465<span class=o>]</span>: 2024/12/20 00:13:14 settings.go:539: Set memory limit to <span class=m>460</span> MiB
</span></span><span class=line><span class=cl>Dec <span class=m>20</span> 00:13:14 derek-1 otelcol<span class=o>[</span>14465<span class=o>]</span>: 2024/12/20 00:13:14 settings.go:524: Set soft memory limit <span class=nb>set</span> to <span class=m>460</span> MiB
</span></span><span class=line><span class=cl>Dec <span class=m>20</span> 00:13:14 derek-1 otelcol<span class=o>[</span>14465<span class=o>]</span>: 2024/12/20 00:13:14 settings.go:373: Set garbage collection target percentage <span class=o>(</span>GOGC<span class=o>)</span> to <span class=m>400</span>
</span></span><span class=line><span class=cl>Dec <span class=m>20</span> 00:13:14 derek-1 otelcol<span class=o>[</span>14465<span class=o>]</span>: 2024/12/20 00:13:14 settings.go:414: <span class=nb>set</span> <span class=s2>&#34;SPLUNK_LISTEN_INTERFACE&#34;</span> to <span class=s2>&#34;127.0.0.1&#34;</span>
</span></span><span class=line><span class=cl>etc.</span></span></code></pre></div></div></div></div></div><h2 id=コレクターの設定>コレクターの設定</h2><p>このコレクターが使用している設定はどこで見つけられるでしょうか？</p><p>その設定は<code>/etc/otel/collector</code>ディレクトリにあります。コレクターを<code>agent</code>モードで
インストールしたため、コレクター設定は<code>agent_config.yaml</code>ファイルにあります。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/06/17</span></span></footer></article><article class=default><header class=headline></header><h1 id=netアプリケーションのデプロイ>.NETアプリケーションのデプロイ</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<h2 id=前提条件>前提条件</h2><p>アプリケーションをデプロイする前に、インスタンスに.NET 8 SDK をインストールする必要があります。</p><div class=tab-panel data-tab-group=7c4fce40f92485650572569a90ebb729><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7c4fce40f92485650572569a90ebb729","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("7c4fce40f92485650572569a90ebb729","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt-get update <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  sudo apt-get install -y dotnet-sdk-8.0</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Hit:1 http://us-west-1.ec2.archive.ubuntu.com/ubuntu jammy InRelease
</span></span><span class=line><span class=cl>Hit:2 http://us-west-1.ec2.archive.ubuntu.com/ubuntu jammy-updates InRelease
</span></span><span class=line><span class=cl>Hit:3 http://us-west-1.ec2.archive.ubuntu.com/ubuntu jammy-backports InRelease
</span></span><span class=line><span class=cl>Hit:4 http://security.ubuntu.com/ubuntu jammy-security InRelease
</span></span><span class=line><span class=cl>Ign:5 https://splunk.jfrog.io/splunk/otel-collector-deb release InRelease
</span></span><span class=line><span class=cl>Hit:6 https://splunk.jfrog.io/splunk/otel-collector-deb release Release
</span></span><span class=line><span class=cl>Reading package lists... Done
</span></span><span class=line><span class=cl>Reading package lists... Done
</span></span><span class=line><span class=cl>Building dependency tree... Done
</span></span><span class=line><span class=cl>Reading state information... Done
</span></span><span class=line><span class=cl>The following additional packages will be installed:
</span></span><span class=line><span class=cl>  aspnetcore-runtime-8.0 aspnetcore-targeting-pack-8.0 dotnet-apphost-pack-8.0 dotnet-host-8.0 dotnet-hostfxr-8.0 dotnet-runtime-8.0 dotnet-targeting-pack-8.0 dotnet-templates-8.0 liblttng-ust-common1
</span></span><span class=line><span class=cl>  liblttng-ust-ctl5 liblttng-ust1 netstandard-targeting-pack-2.1-8.0
</span></span><span class=line><span class=cl>The following NEW packages will be installed:
</span></span><span class=line><span class=cl>  aspnetcore-runtime-8.0 aspnetcore-targeting-pack-8.0 dotnet-apphost-pack-8.0 dotnet-host-8.0 dotnet-hostfxr-8.0 dotnet-runtime-8.0 dotnet-sdk-8.0 dotnet-targeting-pack-8.0 dotnet-templates-8.0
</span></span><span class=line><span class=cl>  liblttng-ust-common1 liblttng-ust-ctl5 liblttng-ust1 netstandard-targeting-pack-2.1-8.0
</span></span><span class=line><span class=cl><span class=m>0</span> upgraded, <span class=m>13</span> newly installed, <span class=m>0</span> to remove and <span class=m>0</span> not upgraded.
</span></span><span class=line><span class=cl>Need to get <span class=m>138</span> MB of archives.
</span></span><span class=line><span class=cl>After this operation, <span class=m>495</span> MB of additional disk space will be used.
</span></span><span class=line><span class=cl>etc.</span></span></code></pre></div></div></div></div></div><p>詳細については、<a href="https://learn.microsoft.com/en-us/dotnet/core/install/linux-ubuntu-install?tabs=dotnet8&pivots=os-linux-ubuntu-2404" rel=external target=_blank>Ubuntu に.NET SDK または.NET Runtime をインストールする</a>
を参照してください。</p><h2 id=net-アプリケーションの確認>.NET アプリケーションの確認</h2><p>ターミナルで、アプリケーションディレクトリに移動します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/workshop/docker-k8s-otel/helloworld</span></span></code></pre></div><p>このワークショップでは、シンプルな「Hello World」.NET アプリケーションを使用します。主要なロジックは
HelloWorldController.cs ファイルにあります：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kd>public</span> <span class=k>class</span> <span class=nc>HelloWorldController</span> <span class=p>:</span> <span class=n>ControllerBase</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>ILogger</span><span class=p>&lt;</span><span class=n>HelloWorldController</span><span class=p>&gt;</span> <span class=n>logger</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>HelloWorldController</span><span class=p>(</span><span class=n>ILogger</span><span class=p>&lt;</span><span class=n>HelloWorldController</span><span class=p>&gt;</span> <span class=n>logger</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=n>logger</span> <span class=p>=</span> <span class=n>logger</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>    [HttpGet(&#34;/hello/{name?}&#34;)]</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>string</span> <span class=n>Hello</span><span class=p>(</span><span class=kt>string</span> <span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>IsNullOrEmpty</span><span class=p>(</span><span class=n>name</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>           <span class=n>logger</span><span class=p>.</span><span class=n>LogInformation</span><span class=p>(</span><span class=s>&#34;/hello endpoint invoked anonymously&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>           <span class=k>return</span> <span class=s>&#34;Hello, World!&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=p>.</span><span class=n>LogInformation</span><span class=p>(</span><span class=s>&#34;/hello endpoint invoked by {name}&#34;</span><span class=p>,</span> <span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>String</span><span class=p>.</span><span class=n>Format</span><span class=p>(</span><span class=s>&#34;Hello, {0}!&#34;</span><span class=p>,</span> <span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h2 id=net-アプリケーションのビルドと実行>.NET アプリケーションのビルドと実行</h2><p>以下のコマンドを使用してアプリケーションをビルドできます：</p><div class=tab-panel data-tab-group=9ab47a6f0237167f422067feb1464343><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9ab47a6f0237167f422067feb1464343","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("9ab47a6f0237167f422067feb1464343","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dotnet build</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>MSBuild version 17.8.5+b5265ef37 <span class=k>for</span> .NET
</span></span><span class=line><span class=cl>  Determining projects to restore...
</span></span><span class=line><span class=cl>  All projects are up-to-date <span class=k>for</span> restore.
</span></span><span class=line><span class=cl>  helloworld -&gt; /home/splunk/workshop/docker-k8s-otel/helloworld/bin/Debug/net8.0/helloworld.dll
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Build succeeded.
</span></span><span class=line><span class=cl>    <span class=m>0</span> Warning<span class=o>(</span>s<span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=m>0</span> Error<span class=o>(</span>s<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Time Elapsed 00:00:02.04</span></span></code></pre></div></div></div></div></div><p>ビルドが成功したら、次のように実行できます：</p><div class=tab-panel data-tab-group=91476db16b03c9ba38a8f871c437f79d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("91476db16b03c9ba38a8f871c437f79d","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("91476db16b03c9ba38a8f871c437f79d","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dotnet run</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Building...
</span></span><span class=line><span class=cl>info: Microsoft.Hosting.Lifetime<span class=o>[</span>14<span class=o>]</span>
</span></span><span class=line><span class=cl>      Now listening on: http://localhost:8080
</span></span><span class=line><span class=cl>info: Microsoft.Hosting.Lifetime<span class=o>[</span>0<span class=o>]</span>
</span></span><span class=line><span class=cl>      Application started. Press Ctrl+C to shut down.
</span></span><span class=line><span class=cl>info: Microsoft.Hosting.Lifetime<span class=o>[</span>0<span class=o>]</span>
</span></span><span class=line><span class=cl>      Hosting environment: Development
</span></span><span class=line><span class=cl>info: Microsoft.Hosting.Lifetime<span class=o>[</span>0<span class=o>]</span>
</span></span><span class=line><span class=cl>      Content root path: /home/splunk/workshop/docker-k8s-otel/helloworld</span></span></code></pre></div></div></div></div></div><p>実行したら、Ubuntu インスタンスへの SSH 接続を 2 つ目のターミナルで開き、curl を使用してアプリケーションにアクセスします：</p><div class=tab-panel data-tab-group=9186b307a608acee11d983378b58d2ba><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9186b307a608acee11d983378b58d2ba","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("9186b307a608acee11d983378b58d2ba","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://localhost:8080/hello</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Hello, World!</span></span></code></pre></div></div></div></div></div><p>名前を渡すこともできます：</p><div class=tab-panel data-tab-group=8ba9e7012c8a6944f1def6c7ce9f14ac><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8ba9e7012c8a6944f1def6c7ce9f14ac","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("8ba9e7012c8a6944f1def6c7ce9f14ac","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://localhost:8080/hello/Tom</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Hello, Tom!</span></span></code></pre></div></div></div></div></div><blockquote><p>次のステップに進む前に、Ctrl + C を押して Helloworld アプリを終了してください。</p></blockquote><h2 id=次のステップ>次のステップ</h2><p>アプリケーションを OpenTelemetry で計装するために使用できる 3 つの方法は何でしょうか？</p><p><a href=#R-image-4e24201ad5c10b823d9b1e735a6758ea class=lightbox-link><img alt=Traces class="lazy lightbox figure-image" loading=lazy src=../images/NetInstrumentation.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-4e24201ad5c10b823d9b1e735a6758ea><img alt=Traces class="lazy lightbox lightbox-image" loading=lazy src=../images/NetInstrumentation.png></a></p><p>オプションの詳細については、<a href=https://docs.splunk.com/observability/en/gdi/get-data-in/application/otel-dotnet/instrumentation/instrument-dotnet-application.html rel=external target=_blank>Splunk Observability Cloud 用の.NET アプリケーションの計装</a>
を参照してください。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/06/17</span></span></footer></article><article class=default><header class=headline></header><h1 id=opentelemetryでnetアプリケーションを計装する>OpenTelemetryで.NETアプリケーションを計装する</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>20 minutes</span>
</span>&nbsp;<h2 id=splunk-distribution-of-opentelemetry-のダウンロード>Splunk Distribution of OpenTelemetry のダウンロード</h2><p>このワークショップでは、NuGet パッケージを使用せず、Splunk Distribution of OpenTelemetry を
手動でインストールします。</p><p>最新の<code>splunk-otel-dotnet-install.sh</code>ファイルをダウンロードすることから始めます。
これを使用して.NET アプリケーションを計装します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/workshop/docker-k8s-otel/helloworld
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>curl -sSfL https://github.com/signalfx/splunk-otel-dotnet/releases/latest/download/splunk-otel-dotnet-install.sh -O</span></span></code></pre></div><p>インストールプロセスの詳細については、<a href=https://docs.splunk.com/observability/en/gdi/get-data-in/application/otel-dotnet/instrumentation/instrument-dotnet-application.html#install-the-splunk-distribution-of-opentelemetry-net-manually rel=external target=_blank>Splunk Distribution of OpenTelemetry .NET の手動インストール</a>
を参照してください。</p><h2 id=ディストリビューションのインストール>ディストリビューションのインストール</h2><p>ターミナルで、以下のようにディストリビューションをインストールします</p><div class=tab-panel data-tab-group=cb7d92b8a26c362664ffb7f75c427498><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("cb7d92b8a26c362664ffb7f75c427498","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("cb7d92b8a26c362664ffb7f75c427498","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sh ./splunk-otel-dotnet-install.sh</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Downloading v1.8.0 <span class=k>for</span> linux-glibc <span class=o>(</span>/tmp/tmp.m3tSdtbmge/splunk-opentelemetry-dotnet-linux-glibc-x64.zip<span class=o>)</span>...</span></span></code></pre></div></div></div></div></div><blockquote><p>注意：上記のコマンドを実行する際には、ARCHITECTURE 環境変数を含める必要がある場合があります：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>ARCHITECTURE</span><span class=o>=</span>x64 sh ./splunk-otel-dotnet-install.sh</span></span></code></pre></div></blockquote><h2 id=計装の有効化>計装の有効化</h2><p>次に、OpenTelemetry 計装を有効化できます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. <span class=nv>$HOME</span>/.splunk-otel-dotnet/instrument.sh</span></span></code></pre></div><h2 id=デプロイメント環境の設定>デプロイメント環境の設定</h2><p>デプロイメント環境を設定して、データが Splunk Observability Cloud 内の独自の
環境に流れるようにしましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>OTEL_RESOURCE_ATTRIBUTES</span><span class=o>=</span>deployment.environment<span class=o>=</span>otel-<span class=nv>$INSTANCE</span></span></span></code></pre></div><h2 id=計装を使用したアプリケーションの実行>計装を使用したアプリケーションの実行</h2><p>以下のようにアプリケーションを実行できます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dotnet run</span></span></code></pre></div><h2 id=チャレンジ>チャレンジ</h2><p>Linux インスタンスから C#アプリケーションによってエクスポートされているトレースをどのように確認できるでしょうか？</p><details><summary><b>答えを見るにはここをクリック</b></summary><p>これを行う方法は 2 つあります：</p><ol><li><code>dotnet run</code>コマンドの開始時に<code>OTEL_TRACES_EXPORTER=otlp,console</code>を追加することで、トレースが OTLP 経由でコレクターに書き込まれるとともに、コンソールにも書き込まれるようになります。</li></ol><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>OTEL_TRACES_EXPORTER</span><span class=o>=</span>otlp,console dotnet run</span></span></code></pre></div><ol start=2><li>あるいは、コレクター設定にデバッグエクスポーターを追加し、それをトレースパイプラインに追加することで、トレースがコレクターログに書き込まれるようになります。</li></ol><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbosity</span><span class=p>:</span><span class=w> </span><span class=l>detailed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>jaeger, otlp, zipkin]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlphttp, signalfx, debug]</span></span></span></code></pre></div></details><h2 id=アプリケーションへのアクセス>アプリケーションへのアクセス</h2><p>アプリケーションが実行中になったら、2 つ目の SSH ターミナルを使用して curl でアクセスします：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://localhost:8080/hello</span></span></code></pre></div><p>以前と同様に、<code>Hello, World!</code>が返されるはずです。</p><p>トレースログを有効にした場合は、以下のようなトレースがコンソールまたはコレクターログに書き込まれているのを確認できるはずです：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>info: Program<span class=o>[</span>0<span class=o>]</span>
</span></span><span class=line><span class=cl>      /hello endpoint invoked anonymously
</span></span><span class=line><span class=cl>Activity.TraceId:            c7bbf57314e4856447508cd8addd49b0
</span></span><span class=line><span class=cl>Activity.SpanId:             1c92ac653c3ece27
</span></span><span class=line><span class=cl>Activity.TraceFlags:         Recorded
</span></span><span class=line><span class=cl>Activity.ActivitySourceName: Microsoft.AspNetCore
</span></span><span class=line><span class=cl>Activity.DisplayName:        GET /hello/<span class=o>{</span>name?<span class=o>}</span>
</span></span><span class=line><span class=cl>Activity.Kind:               Server
</span></span><span class=line><span class=cl>Activity.StartTime:          2024-12-20T00:45:25.6551267Z
</span></span><span class=line><span class=cl>Activity.Duration:           00:00:00.0006464
</span></span><span class=line><span class=cl>Activity.Tags:
</span></span><span class=line><span class=cl>    server.address: localhost
</span></span><span class=line><span class=cl>    server.port: <span class=m>8080</span>
</span></span><span class=line><span class=cl>    http.request.method: GET
</span></span><span class=line><span class=cl>    url.scheme: http
</span></span><span class=line><span class=cl>    url.path: /hello
</span></span><span class=line><span class=cl>    network.protocol.version: 1.1
</span></span><span class=line><span class=cl>    user_agent.original: curl/7.81.0
</span></span><span class=line><span class=cl>    http.route: /hello/<span class=o>{</span>name?<span class=o>}</span>
</span></span><span class=line><span class=cl>    http.response.status_code: <span class=m>200</span>
</span></span><span class=line><span class=cl>Resource associated with Activity:
</span></span><span class=line><span class=cl>    splunk.distro.version: 1.8.0
</span></span><span class=line><span class=cl>    telemetry.distro.name: splunk-otel-dotnet
</span></span><span class=line><span class=cl>    telemetry.distro.version: 1.8.0
</span></span><span class=line><span class=cl>    service.name: helloworld
</span></span><span class=line><span class=cl>    os.type: linux
</span></span><span class=line><span class=cl>    os.description: Ubuntu 22.04.5 LTS
</span></span><span class=line><span class=cl>    os.build_id: 6.8.0-1021-aws
</span></span><span class=line><span class=cl>    os.name: Ubuntu
</span></span><span class=line><span class=cl>    os.version: 22.04
</span></span><span class=line><span class=cl>    host.name: derek-1
</span></span><span class=line><span class=cl>    host.id: 20cf15fcc7054b468647b73b8f87c556
</span></span><span class=line><span class=cl>    process.owner: splunk
</span></span><span class=line><span class=cl>    process.pid: <span class=m>16997</span>
</span></span><span class=line><span class=cl>    process.runtime.description: .NET 8.0.11
</span></span><span class=line><span class=cl>    process.runtime.name: .NET
</span></span><span class=line><span class=cl>    process.runtime.version: 8.0.11
</span></span><span class=line><span class=cl>    container.id: <span class=m>2</span>
</span></span><span class=line><span class=cl>    telemetry.sdk.name: opentelemetry
</span></span><span class=line><span class=cl>    telemetry.sdk.language: dotnet
</span></span><span class=line><span class=cl>    telemetry.sdk.version: 1.9.0
</span></span><span class=line><span class=cl>    deployment.environment: otel-derek-1</span></span></code></pre></div><h2 id=splunk-observability-cloud-でのアプリケーションの確認>Splunk Observability Cloud でのアプリケーションの確認</h2><p>セットアップが完了したので、トレースが<strong>Splunk Observability Cloud</strong>に送信されていることを確認しましょう。アプリケーションが初回デプロイされた場合、データが表示されるまでに数分かかる場合があることに注意してください。</p><p>APM にナビゲートし、Environment ドロップダウンを使用してあなたの環境（つまり<code>otel-instancename</code>）を選択します。</p><p>すべてが正しくデプロイされている場合、サービスのリストに<code>helloworld</code>が表示されるはずです：</p><p><a href=#R-image-0d2a182380ddc99c40700d94c2bc5b65 class=lightbox-link><img alt="APM Overview" class="lazy lightbox figure-image" loading=lazy src=../images/apm_overview.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-0d2a182380ddc99c40700d94c2bc5b65><img alt="APM Overview" class="lazy lightbox lightbox-image" loading=lazy src=../images/apm_overview.png></a></p><p>右側の<strong>Service Map</strong>をクリックしてサービスマップを表示します。</p><p><a href=#R-image-d35f92083e8129e80add8f82bafbca62 class=lightbox-link><img alt="Service Map" class="lazy lightbox figure-image" loading=lazy src=../images/service_map.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d35f92083e8129e80add8f82bafbca62><img alt="Service Map" class="lazy lightbox lightbox-image" loading=lazy src=../images/service_map.png></a></p><p>次に、右側の<strong>Traces</strong>をクリックして、このアプリケーションでキャプチャされたトレースを確認します。</p><p><a href=#R-image-04d1b81ffb31c797f06af8e14aaf68e2 class=lightbox-link><img alt=Traces class="lazy lightbox figure-image" loading=lazy src=../images/traces.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-04d1b81ffb31c797f06af8e14aaf68e2><img alt=Traces class="lazy lightbox lightbox-image" loading=lazy src=../images/traces.png></a></p><p>個別のトレースは以下のように表示されるはずです：</p><p><a href=#R-image-95f92dd08ca55a9c39249fb3eeb7c729 class=lightbox-link><img alt=Traces class="lazy lightbox figure-image" loading=lazy src=../images/trace.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-95f92dd08ca55a9c39249fb3eeb7c729><img alt=Traces class="lazy lightbox lightbox-image" loading=lazy src=../images/trace.png></a></p><blockquote><p>次のステップに進む前に、Ctrl + C を押して Helloworld アプリを終了してください。</p></blockquote><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/06/17</span></span></footer></article><article class=default><header class=headline></header><h1 id=アプリケーションのdocker化>アプリケーションのDocker化</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>15 minutes</span>
</span>&nbsp;<p>このワークショップの後半では、.NET アプリケーションを Kubernetes クラスターにデプロイします。</p><p>しかし、どのようにそれを行うのでしょうか？</p><p>最初のステップは、アプリケーション用の Docker イメージを作成することです。これは
アプリケーションの「Docker 化」として知られており、プロセスは<code>Dockerfile</code>の作成から始まります。</p><p>しかし、まず重要な用語を定義しましょう。</p><h2 id=重要な用語>重要な用語</h2><h3 id=docker-とは何ですか>Docker とは何ですか？</h3><blockquote><p>「Docker は、コンテナと呼ばれる緩い分離環境でアプリケーションをパッケージ化して実行する機能を提供します。分離とセキュリティにより、指定されたホスト上で同時に多くのコンテナを実行できます。コンテナは軽量で、アプリケーションの実行に必要なすべてを含んでいるため、ホストにインストールされているものに依存する必要がありません。」</p></blockquote><p>ソース: <a href=https://docs.docker.com/get-started/docker-overview/ rel=external target=_blank>https://docs.docker.com/get-started/docker-overview/</a></p><h3 id=コンテナとは何ですか>コンテナとは何ですか？</h3><blockquote><p>「コンテナは、アプリのコンポーネントごとの分離されたプロセスです。各コンポーネントは&mldr;独自の分離された環境で実行され、マシン上の他のすべてのものから完全に分離されています。」</p></blockquote><p>ソース: <a href=https://docs.docker.com/get-started/docker-concepts/the-basics/what-is-a-container/ rel=external target=_blank>https://docs.docker.com/get-started/docker-concepts/the-basics/what-is-a-container/</a></p><h3 id=コンテナイメージとは何ですか>コンテナイメージとは何ですか？</h3><blockquote><p>「コンテナイメージは、コンテナを実行するためのすべてのファイル、バイナリ、ライブラリ、および設定を含む標準化されたパッケージです。」</p></blockquote><h3 id=dockerfile>Dockerfile</h3><blockquote><p>「Dockerfile は、コンテナイメージを作成するために使用されるテキストベースのドキュメントです。実行するコマンド、コピーするファイル、起動コマンドなどに関するイメージビルダーへの指示を提供します。」</p></blockquote><h2 id=dockerfile-の作成>Dockerfile の作成</h2><p><code>/home/splunk/workshop/docker-k8s-otel/helloworld</code>ディレクトリに<code>Dockerfile</code>という名前のファイルを作成しましょう。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /home/splunk/workshop/docker-k8s-otel/helloworld</span></span></code></pre></div><p>ファイルの作成には vi または nano を使用できます。vi を使用した例を示します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi Dockerfile</span></span></code></pre></div><p>新しく開いたファイルに以下の内容をコピー＆ペーストします：</p><blockquote><p>以下のテキストを貼り付ける前に、vi で「i」を押して挿入モードに入ってください。</p></blockquote><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> mcr.microsoft.com/dotnet/aspnet:8.0 AS base</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>USER</span><span class=s> app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>EXPOSE</span><span class=s> 8080</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> mcr.microsoft.com/dotnet/sdk:8.0 AS build</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>BUILD_CONFIGURATION</span><span class=o>=</span>Release
</span></span><span class=line><span class=cl><span class=k>WORKDIR</span><span class=s> /src</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> <span class=o>[</span><span class=s2>&#34;helloworld.csproj&#34;</span>, <span class=s2>&#34;helloworld/&#34;</span><span class=o>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet restore <span class=s2>&#34;./helloworld/./helloworld.csproj&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> &#34;/src/helloworld&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet build <span class=s2>&#34;./helloworld.csproj&#34;</span> -c <span class=nv>$BUILD_CONFIGURATION</span> -o /app/build<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> build AS publish</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>BUILD_CONFIGURATION</span><span class=o>=</span>Release
</span></span><span class=line><span class=cl><span class=k>RUN</span> dotnet publish <span class=s2>&#34;./helloworld.csproj&#34;</span> -c <span class=nv>$BUILD_CONFIGURATION</span> -o /app/publish /p:UseAppHost<span class=o>=</span>false<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> base AS final</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>publish /app/publish .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;dotnet&#34;</span><span class=p>,</span> <span class=s2>&#34;helloworld.dll&#34;</span><span class=p>]</span></span></span></code></pre></div><blockquote><p>vi での変更を保存するには、<code>esc</code>キーを押してコマンドモードに入り、<code>:wq!</code>と入力してから<code>enter/return</code>キーを押します。</p></blockquote><p>これはすべて何を意味するのでしょうか？詳しく見てみましょう。</p><h2 id=dockerfile-の詳細解説>Dockerfile の詳細解説</h2><p>この例では、マルチステージ Dockerfile を使用しており、Docker イメージ作成プロセスを以下のステージに分けています：</p><ul><li>Base（ベース）</li><li>Build（ビルド）</li><li>Publish（パブリッシュ）</li><li>Final（最終）</li></ul><p>マルチステージアプローチはより複雑ですが、デプロイメント用により
軽量なランタイムイメージを作成することができます。以下では、
これらの各ステージの目的を説明します。</p><h3 id=ベースステージ>ベースステージ</h3><p>ベースステージでは、アプリを実行するユーザー、作業ディレクトリを定義し、
アプリにアクセスするために使用されるポートを公開します。
これは Microsoft の<code>mcr.microsoft.com/dotnet/aspnet:8.0</code>イメージをベースにしています：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> mcr.microsoft.com/dotnet/aspnet:8.0 AS base</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>USER</span><span class=s> app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>EXPOSE</span><span class=s> 8080</span></span></span></code></pre></div><p>なお、<code>mcr.microsoft.com/dotnet/aspnet:8.0</code>イメージには.NET runtime のみが含まれており、
SDK は含まれていないため、比較的軽量です。これは Debian 12 Linux
distribution がベースになっています。ASP.NET Core Runtime Docker イメージの詳細については
<a href=https://github.com/dotnet/dotnet-docker/blob/main/README.aspnet.md rel=external target=_blank>GitHub</a>で確認できます。</p><h3 id=build-ステージ>Build ステージ</h3><p>Dockerfile の次のステージは build ステージです。このステージでは、
<code>mcr.microsoft.com/dotnet/sdk:8.0</code>イメージが使用されます。これも Debian 12 がベースになっていますが、
runtime だけでなく完全な<a href=https://github.com/dotnet/dotnet-docker/blob/main/README.sdk.md rel=external target=_blank>.NET SDK</a>が含まれています。</p><p>このステージでは<code>.csproj</code>ファイルを build イメージにコピーし、その後<code>dotnet restore</code>を使用して
アプリケーションが使用する依存関係をダウンロードします。</p><p>次に、アプリケーションコードを build イメージにコピーし、
<code>dotnet build</code>を使用してプロジェクトとその依存関係を
<code>.dll</code>バイナリのセットにビルドします：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> mcr.microsoft.com/dotnet/sdk:8.0 AS build</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>BUILD_CONFIGURATION</span><span class=o>=</span>Release
</span></span><span class=line><span class=cl><span class=k>WORKDIR</span><span class=s> /src</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> <span class=o>[</span><span class=s2>&#34;helloworld.csproj&#34;</span>, <span class=s2>&#34;helloworld/&#34;</span><span class=o>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet restore <span class=s2>&#34;./helloworld/./helloworld.csproj&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> &#34;/src/helloworld&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet build <span class=s2>&#34;./helloworld.csproj&#34;</span> -c <span class=nv>$BUILD_CONFIGURATION</span> -o /app/build</span></span></code></pre></div><h3 id=publish-ステージ>Publish ステージ</h3><p>3 番目のステージは publish で、これは Microsoft イメージではなく build ステージイメージをベースにしています。このステージでは、<code>dotnet publish</code>を使用して
アプリケーションとその依存関係を deployment 用にパッケージ化します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> build AS publish</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>BUILD_CONFIGURATION</span><span class=o>=</span>Release
</span></span><span class=line><span class=cl><span class=k>RUN</span> dotnet publish <span class=s2>&#34;./helloworld.csproj&#34;</span> -c <span class=nv>$BUILD_CONFIGURATION</span> -o /app/publish /p:UseAppHost<span class=o>=</span>false</span></span></code></pre></div><h3 id=final-ステージ>Final ステージ</h3><p>4 番目のステージは最終ステージで、これは base
ステージイメージをベースにしています（build と publish ステージよりも軽量）。publish ステージイメージからの出力をコピーし、
アプリケーションの entry point を定義します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> base AS final</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>publish /app/publish .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;dotnet&#34;</span><span class=p>,</span> <span class=s2>&#34;helloworld.dll&#34;</span><span class=p>]</span></span></span></code></pre></div><h2 id=docker-イメージのビルド>Docker イメージのビルド</h2><p><code>Dockerfile</code>ができたので、これを使用してアプリケーションを含む Docker イメージを
ビルドできます：</p><div class=tab-panel data-tab-group=2b121c2f04bcecc1c1bcca97548c9ff0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2b121c2f04bcecc1c1bcca97548c9ff0","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("2b121c2f04bcecc1c1bcca97548c9ff0","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker build -t helloworld:1.0 .</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>DEPRECATED: The legacy builder is deprecated and will be removed in a future release.
</span></span><span class=line><span class=cl>            Install the buildx component to build images with BuildKit:
</span></span><span class=line><span class=cl>            https://docs.docker.com/go/buildx/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Sending build context to Docker daemon  281.1kB
</span></span><span class=line><span class=cl>Step 1/19 : FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS base
</span></span><span class=line><span class=cl>8.0: Pulling from dotnet/aspnet
</span></span><span class=line><span class=cl>af302e5c37e9: Pull <span class=nb>complete</span>
</span></span><span class=line><span class=cl>91ab5e0aabf0: Pull <span class=nb>complete</span>
</span></span><span class=line><span class=cl>1c1e4530721e: Pull <span class=nb>complete</span>
</span></span><span class=line><span class=cl>1f39ca6dcc3a: Pull <span class=nb>complete</span>
</span></span><span class=line><span class=cl>ea20083aa801: Pull <span class=nb>complete</span>
</span></span><span class=line><span class=cl>64c242a4f561: Pull <span class=nb>complete</span>
</span></span><span class=line><span class=cl>Digest: sha256:587c1dd115e4d6707ff656d30ace5da9f49cec48e627a40bbe5d5b249adc3549
</span></span><span class=line><span class=cl>Status: Downloaded newer image <span class=k>for</span> mcr.microsoft.com/dotnet/aspnet:8.0
</span></span><span class=line><span class=cl> ---&gt; 0ee5d7ddbc3b
</span></span><span class=line><span class=cl>Step 2/19 : USER app
</span></span><span class=line><span class=cl>etc,</span></span></code></pre></div></div></div></div></div><p>これは、現在のディレクトリの<code>Dockerfile</code>を使用して<code>helloworld:1.0</code>のタグでイメージをビルドするよう Docker に指示します。</p><p>以下のコマンドで正常に作成されたことを確認できます：</p><div class=tab-panel data-tab-group=557a747f0f1ef6e4fbd1a163b066538f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("557a747f0f1ef6e4fbd1a163b066538f","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("557a747f0f1ef6e4fbd1a163b066538f","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker images</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>REPOSITORY   TAG       IMAGE ID       CREATED          SIZE
</span></span><span class=line><span class=cl>helloworld   1.0       db19077b9445   <span class=m>20</span> seconds ago   217MB</span></span></code></pre></div></div></div></div></div><h2 id=docker-イメージのテスト>Docker イメージのテスト</h2><blockquote><p>続行する前に、以前に開始したアプリケーションがインスタンス上で実行されていないことを確認してください。</p></blockquote><p>Docker イメージを使用して以下のようにアプリケーションを実行できます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run --name helloworld <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--detach <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--expose <span class=m>8080</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--network<span class=o>=</span>host <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>helloworld:1.0</span></span></code></pre></div><blockquote><p>注意：<code>--network=host</code>パラメータを含めて、Docker コンテナが
インスタンス上のリソースにアクセスできるようにしています。これは後でアプリケーションが
localhost 上で実行されているコレクターにデータを送信する必要がある場合に重要です。</p></blockquote><p>Docker コンテナが実行されていることを確認しましょう：</p><div class=tab-panel data-tab-group=78308e04169d5d4636057ffa032ccc2d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("78308e04169d5d4636057ffa032ccc2d","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("78308e04169d5d4636057ffa032ccc2d","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker ps</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ docker ps
</span></span><span class=line><span class=cl>CONTAINER ID   IMAGE            COMMAND                  CREATED       STATUS       PORTS     NAMES
</span></span><span class=line><span class=cl>5f5b9cd56ac5   helloworld:1.0   <span class=s2>&#34;dotnet helloworld.d…&#34;</span>   <span class=m>2</span> mins ago    Up <span class=m>2</span> mins              helloworld</span></span></code></pre></div></div></div></div></div><p>以前と同様にアプリケーションにアクセスできます：</p><div class=tab-panel data-tab-group=30c4b2f8d7afae007e10dc6472c608b5><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("30c4b2f8d7afae007e10dc6472c608b5","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("30c4b2f8d7afae007e10dc6472c608b5","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://localhost:8080/hello/Docker</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Hello, Docker!</span></span></code></pre></div></div></div></div></div><p>おめでとうございます。ここまで到達したということは、.NET アプリケーションの Docker 化に成功したということです。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/06/17</span></span></footer></article><article class=default><header class=headline></header><h1 id=dockerfileに計装を追加する>Dockerfileに計装を追加する</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<p>アプリケーションを正常に Docker 化したので、次に OpenTelemetry による計装 を追加しましょう。</p><p>これは、Linux で実行しているアプリケーションを計装した際の手順と似ていますが、
注意すべきいくつかの重要な違いがあります。</p><h2 id=dockerfile-の更新>Dockerfile の更新</h2><p><code>/home/splunk/workshop/docker-k8s-otel/helloworld</code>ディレクトリの<code>Dockerfile</code>を更新しましょう。</p><p>Dockerfile で.NET アプリケーションがビルドされた後、以下の操作を行いたいと思います：</p><ul><li><code>splunk-otel-dotnet-install.sh</code>をダウンロードして実行するために必要な依存関係を追加する</li><li>Splunk OTel .NET インストーラーをダウンロードする</li><li>ディストリビューションをインストールする</li></ul><p>Dockerfile のビルドステージに以下を追加できます。vi で Dockerfile を開きましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi /home/splunk/workshop/docker-k8s-otel/helloworld/Dockerfile</span></span></code></pre></div><blockquote><p>vi では「i」キーを押して編集モードに入ります
&lsquo;NEW CODE&rsquo;とマークされている行を Dockerfile のビルドステージセクションに貼り付けてください：</p></blockquote><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=c># CODE ALREADY IN YOUR DOCKERFILE:</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> mcr.microsoft.com/dotnet/sdk:8.0 AS build</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>BUILD_CONFIGURATION</span><span class=o>=</span>Release
</span></span><span class=line><span class=cl><span class=k>WORKDIR</span><span class=s> /src</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> <span class=o>[</span><span class=s2>&#34;helloworld.csproj&#34;</span>, <span class=s2>&#34;helloworld/&#34;</span><span class=o>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet restore <span class=s2>&#34;./helloworld/./helloworld.csproj&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> &#34;/src/helloworld&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet build <span class=s2>&#34;./helloworld.csproj&#34;</span> -c <span class=nv>$BUILD_CONFIGURATION</span> -o /app/build<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: add dependencies for splunk-otel-dotnet-install.sh</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apt-get update <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> apt-get install -y unzip<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: download Splunk OTel .NET installer</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> curl -sSfL https://github.com/signalfx/splunk-otel-dotnet/releases/latest/download/splunk-otel-dotnet-install.sh -O<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: install the distribution</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> sh ./splunk-otel-dotnet-install.sh</span></span></code></pre></div><p>次に、以下の変更で Dockerfile の最終ステージを更新します：</p><ul><li>ビルドイメージから最終イメージに/root/.splunk-otel-dotnet/をコピーする</li><li>entrypoint.sh ファイルもコピーする</li><li><code>OTEL_SERVICE_NAME</code>と<code>OTEL_RESOURCE_ATTRIBUTES</code>環境変数を設定する</li><li><code>ENTRYPOINT</code>を<code>entrypoint.sh</code>に設定する</li></ul><p>最も簡単な方法は、最終ステージ全体を以下の内容で置き換えることです：</p><blockquote><p><strong>重要</strong> Dockerfile の<code>$INSTANCE</code>をあなたのインスタンス名に置き換えてください。
インスタンス名は<code>echo $INSTANCE</code>を実行することで確認できます。</p></blockquote><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=c># CODE ALREADY IN YOUR DOCKERFILE</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> base AS final</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: Copy instrumentation file tree</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> &#34;//home/app/.splunk-otel-dotnet&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>build /root/.splunk-otel-dotnet/ .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># CODE ALREADY IN YOUR DOCKERFILE</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>publish /app/publish .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: copy the entrypoint.sh script</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> entrypoint.sh .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: set OpenTelemetry environment variables</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> <span class=nv>OTEL_SERVICE_NAME</span><span class=o>=</span>helloworld
</span></span><span class=line><span class=cl><span class=k>ENV</span> <span class=nv>OTEL_RESOURCE_ATTRIBUTES</span><span class=o>=</span><span class=s1>&#39;deployment.environment=otel-$INSTANCE&#39;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: replace the prior ENTRYPOINT command with the following two lines</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;sh&#34;</span><span class=p>,</span> <span class=s2>&#34;entrypoint.sh&#34;</span><span class=p>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;dotnet&#34;</span><span class=p>,</span> <span class=s2>&#34;helloworld.dll&#34;</span><span class=p>]</span></span></span></code></pre></div><blockquote><p>vi での変更を保存するには、<code>esc</code>キーを押してコマンドモードに入り、<code>:wq!</code>と入力してから<code>enter/return</code>キーを押します。</p></blockquote><p>これらすべての変更の後、Dockerfile は以下のようになるはずです：</p><blockquote><p><strong>重要</strong> このコンテンツを自分の Dockerfile にコピー＆ペーストする場合は、
Dockerfile の<code>$INSTANCE</code>をあなたのインスタンス名に置き換えてください。
インスタンス名は<code>echo $INSTANCE</code>を実行することで確認できます。</p></blockquote><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> mcr.microsoft.com/dotnet/aspnet:8.0 AS base</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>USER</span><span class=s> app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>EXPOSE</span><span class=s> 8080</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> mcr.microsoft.com/dotnet/sdk:8.0 AS build</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>BUILD_CONFIGURATION</span><span class=o>=</span>Release
</span></span><span class=line><span class=cl><span class=k>WORKDIR</span><span class=s> /src</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> <span class=o>[</span><span class=s2>&#34;helloworld.csproj&#34;</span>, <span class=s2>&#34;helloworld/&#34;</span><span class=o>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet restore <span class=s2>&#34;./helloworld/./helloworld.csproj&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> &#34;/src/helloworld&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet build <span class=s2>&#34;./helloworld.csproj&#34;</span> -c <span class=nv>$BUILD_CONFIGURATION</span> -o /app/build<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: add dependencies for splunk-otel-dotnet-install.sh</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apt-get update <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> apt-get install -y unzip<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: download Splunk OTel .NET installer</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> curl -sSfL https://github.com/signalfx/splunk-otel-dotnet/releases/latest/download/splunk-otel-dotnet-install.sh -O<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: install the distribution</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> sh ./splunk-otel-dotnet-install.sh<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> build AS publish</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>BUILD_CONFIGURATION</span><span class=o>=</span>Release
</span></span><span class=line><span class=cl><span class=k>RUN</span> dotnet publish <span class=s2>&#34;./helloworld.csproj&#34;</span> -c <span class=nv>$BUILD_CONFIGURATION</span> -o /app/publish /p:UseAppHost<span class=o>=</span>false<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> base AS final</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: Copy instrumentation file tree</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> &#34;//home/app/.splunk-otel-dotnet&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>build /root/.splunk-otel-dotnet/ .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>publish /app/publish .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: copy the entrypoint.sh script</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> entrypoint.sh .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: set OpenTelemetry environment variables</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> <span class=nv>OTEL_SERVICE_NAME</span><span class=o>=</span>helloworld
</span></span><span class=line><span class=cl><span class=k>ENV</span> <span class=nv>OTEL_RESOURCE_ATTRIBUTES</span><span class=o>=</span><span class=s1>&#39;deployment.environment=otel-$INSTANCE&#39;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: replace the prior ENTRYPOINT command with the following two lines</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;sh&#34;</span><span class=p>,</span> <span class=s2>&#34;entrypoint.sh&#34;</span><span class=p>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;dotnet&#34;</span><span class=p>,</span> <span class=s2>&#34;helloworld.dll&#34;</span><span class=p>]</span></span></span></code></pre></div><h2 id=entrypointsh-ファイルの作成>entrypoint.sh ファイルの作成</h2><p>また、<code>/home/splunk/workshop/docker-k8s-otel/helloworld</code>フォルダに<code>entrypoint.sh</code>という名前のファイルを
以下の内容で作成する必要があります：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi /home/splunk/workshop/docker-k8s-otel/helloworld/entrypoint.sh</span></span></code></pre></div><p>次に、新しく作成したファイルに以下のコードを貼り付けます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># Read in the file of environment settings</span>
</span></span><span class=line><span class=cl>. /<span class=nv>$HOME</span>/.splunk-otel-dotnet/instrument.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Then run the CMD</span>
</span></span><span class=line><span class=cl><span class=nb>exec</span> <span class=s2>&#34;</span><span class=nv>$@</span><span class=s2>&#34;</span></span></span></code></pre></div><blockquote><p>vi での変更を保存するには、<code>esc</code>キーを押してコマンドモードに入り、<code>:wq!</code>と入力してから<code>enter/return</code>キーを押します。</p></blockquote><p><code>entrypoint.sh</code>スクリプトは、計装に含まれる instrument.sh スクリプトが環境変数を<strong>コンテナ起動時に</strong>取得するために必要です。これにより、各プラットフォームに対して環境変数が正しく設定されることが保証されます。</p><blockquote><p>「なぜ Linux ホスト上で OpenTelemetry .NET instrumentation を有効化したときのように、
Dockerfile に以下のコマンドを含めるだけではだめなのか？」と疑問に思うかもしれません。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>RUN</span> . <span class=nv>$HOME</span>/.splunk-otel-dotnet/instrument.sh</span></span></code></pre></div><p>この方法の問題点は、各 Dockerfile RUN ステップが新しいコンテナと新しいシェルで実行されることです。
あるシェルで環境変数を設定しようとしても、後で見ることはできません。
この問題は、ここで行ったようにエントリポイントスクリプトを使用することで解決されます。
この問題についての詳細は、こちらの<a href=https://stackoverflow.com/questions/55921914/how-to-source-a-script-with-environment-variables-in-a-docker-build-process rel=external target=_blank>Stack Overflow の投稿</a>を参照してください。</p></blockquote><h2 id=docker-イメージのビルド>Docker イメージのビルド</h2><p>OpenTelemetry .NET instrumentation を含む新しい Docker イメージをビルドしましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker build -t helloworld:1.1 .</span></span></code></pre></div><blockquote><p>注：以前のバージョンと区別するために、異なるバージョン（1.1）を使用しています。
古いバージョンをクリーンアップするには、以下のコマンドでコンテナ ID を取得します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker ps -a</span></span></code></pre></div><p>次に、以下のコマンドでコンテナを削除します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker rm &lt;old container id&gt; --force</span></span></code></pre></div><p>次にコンテナイメージ ID を取得します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker images <span class=p>|</span> grep 1.0</span></span></code></pre></div><p>最後に、以下のコマンドで古いイメージを削除できます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker image rm &lt;old image id&gt;</span></span></code></pre></div></blockquote><h2 id=アプリケーションの実行>アプリケーションの実行</h2><p>新しい Docker イメージを実行しましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run --name helloworld <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--detach <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--expose <span class=m>8080</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--network<span class=o>=</span>host <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>helloworld:1.1</span></span></code></pre></div><p>以下を使用してアプリケーションにアクセスできます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://localhost:8080/hello</span></span></code></pre></div><p>トラフィックを生成するために上記のコマンドを数回実行しましょう。</p><p>1 分ほど経過したら、Splunk Observability Cloud に新しいトレースが表示されることを確認します。</p><blockquote><p>あなたの特定の環境でトレースを探すことを忘れないでください。</p></blockquote><h2 id=トラブルシューティング>トラブルシューティング</h2><p>Splunk Observability Cloud にトレースが表示されない場合は、以下のようにトラブルシューティングを行うことができます。</p><p>まず、コレクター設定ファイルを編集用に開きます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo vi /etc/otel/collector/agent_config.yaml</span></span></code></pre></div><p>次に、トレースパイプラインにデバッグエクスポーターを追加します。これにより、トレースがコレクターログに書き込まれるようになります：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>health_check, http_forwarder, zpages, smartagent]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>jaeger, otlp, zipkin]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#- resource/add_environment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># NEW CODE: デバッグエクスポーターをここに追加</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlphttp, signalfx, debug]</span></span></span></code></pre></div><p>その後、コレクターを再起動して設定変更を適用します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl restart splunk-otel-collector</span></span></code></pre></div><p><code>journalctl</code>を使用してコレクターログを表示できます：</p><blockquote><p>ログの追跡を終了するには、Ctrl + C を押します。</p></blockquote><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo journalctl -u splunk-otel-collector -f -n <span class=m>100</span></span></span></code></pre></div><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/06/17</span></span></footer></article><article class=default><header class=headline></header><h1 id=k8sでopentelemetryコレクターをインストール>K8sでOpenTelemetryコレクターをインストール</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>15 minutes</span>
</span>&nbsp;<h2 id=ワークショップパート-1-の振り返り>ワークショップパート 1 の振り返り</h2><p>ワークショップのこの時点で、以下を正常に完了しました：</p><ul><li>Linux ホストに Splunk distribution of OpenTelemetry コレクターをデプロイ</li><li>Splunk Observability Cloud にトレースとメトリクスを送信するよう設定</li><li>.NET アプリケーションをデプロイし、OpenTelemetry で計装</li><li>.NET アプリケーションを Docker 化し、o11y cloud にトレースが流れることを確認</li></ul><p>上記のステップを<strong>完了していない</strong>場合は、ワークショップの残りの部分に進む前に以下のコマンドを実行してください：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cp /home/splunk/workshop/docker-k8s-otel/docker/Dockerfile /home/splunk/workshop/docker-k8s-otel/helloworld/
</span></span><span class=line><span class=cl>cp /home/splunk/workshop/docker-k8s-otel/docker/entrypoint.sh /home/splunk/workshop/docker-k8s-otel/helloworld/</span></span></code></pre></div><blockquote><p><strong>重要</strong> これらのファイルがコピーされたら、<code>/home/splunk/workshop/docker-k8s-otel/helloworld/Dockerfile</code> を
エディターで開き、Dockerfile の <code>$INSTANCE</code> をあなたのインスタンス名に置き換えてください。
インスタンス名は <code>echo $INSTANCE</code> を実行することで確認できます。</p></blockquote><h2 id=ワークショップパート-2-の紹介>ワークショップパート 2 の紹介</h2><p>ワークショップの次の部分では、Kubernetes でアプリケーションを実行したいと思います。
そのため、Kubernetes クラスターに Splunk distribution of OpenTelemetry コレクターを
デプロイする必要があります。</p><p>まず、いくつかの重要な用語を定義しましょう。</p><h3 id=重要な用語>重要な用語</h3><h4 id=kubernetes-とは何ですか>Kubernetes とは何ですか？</h4><p><em>「Kubernetes は、宣言的な設定と自動化の両方を促進する、コンテナ化されたワークロードとサービスを管理するためのポータブルで拡張可能なオープンソースプラットフォームです。」</em></p><p>Source: <a href=https://kubernetes.io/docs/concepts/overview/ rel=external target=_blank>https://kubernetes.io/docs/concepts/overview/</a></p><p>Dockerfile に小さな修正を加えた後、アプリケーション用に以前ビルドした Docker イメージを
Kubernetes クラスターにデプロイします。</p><h4 id=helm-とは何ですか>Helm とは何ですか？</h4><p>Helm は Kubernetes 用のパッケージマネージャーです。</p><p><em>「最も複雑な Kubernetes アプリケーションだとしても、定義、インストール、アップグレード役立ちます」</em></p><h4 id=helm-を使用したコレクターのインストール>Helm を使用したコレクターのインストール</h4><p>プロダクト内ウィザードではなくコマンドラインを使用して、コレクターをインストールするための独自の
<code>helm</code>コマンドを作成しましょう。</p><p>まず、helm リポジトリを追加する必要があります：ます。」</p><p>Source: <a href=https://helm.sh/ rel=external target=_blank>https://helm.sh/</a></p><p>Helm を使用して K8s クラスターに OpenTelemetry コレクターをデプロイします。</p><h4 id=helm-の利点>Helm の利点</h4><ul><li>複雑性の管理<ul><li>数十のマニフェストファイルではなく、単一の values.yaml ファイルを扱う</li></ul></li><li>簡単な更新<ul><li>インプレースアップグレード</li></ul></li><li>ロールバックサポート<ul><li>helm rollback を使用してリリースの古いバージョンにロールバック</li></ul></li></ul><h2 id=ホストコレクターのアンインストール>ホストコレクターのアンインストール</h2><p>先に進む前に、Linux ホストに先ほどインストールしたコレクターを削除しましょう：
\</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -sSL https://dl.signalfx.com/splunk-otel-collector.sh &gt; /tmp/splunk-otel-collector.sh<span class=p>;</span>
</span></span><span class=line><span class=cl>sudo sh /tmp/splunk-otel-collector.sh --uninstall</span></span></code></pre></div><h2 id=helm-を利用して-collector-をインストールする>Helm を利用して Collector をインストールする</h2><p>ウィザードの代わりに、コマンドラインを利用して collector をインストールします。</p><p>まず初めに、Helm リポジトリに登録する必要があります</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm repo add splunk-otel-collector-chart https://signalfx.github.io/splunk-otel-collector-chart</span></span></code></pre></div><p>リポジトリが最新であることを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm repo update</span></span></code></pre></div><p>helm チャートのデプロイメントを設定するために、<code>/home/splunk</code>ディレクトリに<code>values.yaml</code>という名前の新しいファイルを作成しましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># swith to the /home/splunk dir</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> /home/splunk
</span></span><span class=line><span class=cl><span class=c1># create a values.yaml file in vi</span>
</span></span><span class=line><span class=cl>vi values.yaml</span></span></code></pre></div><blockquote><p>Press ‘i’ to enter into insert mode in vi before pasting the text below.　&ldquo;i"を押下すると vi はインサートモードになります。ペースト前に押下してください</p></blockquote><p>そして、下記のコードをコピーしてください</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>logsEngine</span><span class=p>:</span><span class=w> </span><span class=l>otel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>agent</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hostmetrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>collection_interval</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>root_path</span><span class=p>:</span><span class=w> </span><span class=l>/hostfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>scrapers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>disk</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>filesystem</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>exclude_mount_points</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>match_type</span><span class=p>:</span><span class=w> </span><span class=l>regexp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>mount_points</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>/var/*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>/snap/*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>/boot/*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>/boot</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>/opt/orbstack/*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>/mnt/machines/*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>/Users/*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>load</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>network</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>paging</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>processes</span><span class=p>:</span><span class=w> </span><span class=kc>null</span></span></span></code></pre></div><blockquote><p>vi での変更を保存するには、<code>esc</code>キーを押してコマンドモードに入り、<code>:wq!</code>と入力してから<code>enter/return</code>キーを押します。</p></blockquote><p>次のコマンドを使用してコレクターをインストールできます：</p><div class=tab-panel data-tab-group=032204f25e6b647497ed3827198b9e8a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("032204f25e6b647497ed3827198b9e8a","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("032204f25e6b647497ed3827198b9e8a","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>  helm install splunk-otel-collector --version 0.111.0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkObservability.realm=</span><span class=nv>$REALM</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkObservability.accessToken=</span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;clusterName=</span><span class=nv>$INSTANCE</span><span class=s2>-cluster&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;environment=otel-</span><span class=nv>$INSTANCE</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.token=</span><span class=nv>$HEC_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.endpoint=</span><span class=nv>$HEC_URL</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.index=splunk4rookies-workshop&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -f values.yaml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  splunk-otel-collector-chart/splunk-otel-collector</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>NAME: splunk-otel-collector
</span></span><span class=line><span class=cl>LAST DEPLOYED: Fri Dec <span class=m>20</span> 01:01:43 <span class=m>2024</span>
</span></span><span class=line><span class=cl>NAMESPACE: default
</span></span><span class=line><span class=cl>STATUS: deployed
</span></span><span class=line><span class=cl>REVISION: <span class=m>1</span>
</span></span><span class=line><span class=cl>TEST SUITE: None
</span></span><span class=line><span class=cl>NOTES:
</span></span><span class=line><span class=cl>Splunk OpenTelemetry Collector is installed and configured to send data to Splunk Observability realm us1.</span></span></code></pre></div></div></div></div></div><h2 id=コレクターが実行中であることを確認>コレクターが実行中であることを確認</h2><p>以下のコマンドでコレクターが実行されているかどうかを確認できます：</p><div class=tab-panel data-tab-group=9b8afc0096704ea8c518ef42fe0aa0af><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9b8afc0096704ea8c518ef42fe0aa0af","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("9b8afc0096704ea8c518ef42fe0aa0af","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pods</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>NAME                                                         READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>splunk-otel-collector-agent-8xvk8                            1/1     Running   <span class=m>0</span>          49s
</span></span><span class=line><span class=cl>splunk-otel-collector-k8s-cluster-receiver-d54857c89-tx7qr   1/1     Running   <span class=m>0</span>          49s</span></span></code></pre></div></div></div></div></div><h2 id=o11y-cloud-で-k8s-クラスターを確認>O11y Cloud で K8s クラスターを確認</h2><p>Splunk Observability Cloud で、<strong>Infrastructure</strong> -> <strong>Kubernetes</strong> -> <strong>Kubernetes Clusters</strong>にナビゲートし、
クラスター名（<code>$INSTANCE-cluster</code>）を検索します：</p><p><a href=#R-image-29c0088c54d207c9aaa5653a5547ddd1 class=lightbox-link><img alt="Kubernetes node" class="lazy lightbox figure-image" loading=lazy src=../images/k8snode.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-29c0088c54d207c9aaa5653a5547ddd1><img alt="Kubernetes node" class="lazy lightbox lightbox-image" loading=lazy src=../images/k8snode.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/06/17</span></span></footer></article><article class=default><header class=headline></header><h1 id=アプリケーションをk8sにデプロイ>アプリケーションをK8sにデプロイ</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>15 minutes</span>
</span>&nbsp;<h2 id=dockerfile-の更新>Dockerfile の更新</h2><p>Kubernetes では、環境変数は通常、Docker イメージに組み込むのではなく<code>.yaml</code>マニフェストファイルで管理されます。そこで、Dockerfile から以下の 2 つの環境変数を削除しましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi /home/splunk/workshop/docker-k8s-otel/helloworld/Dockerfile</span></span></code></pre></div><p>次に、以下の 2 つの環境変数を削除します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>ENV</span> <span class=nv>OTEL_SERVICE_NAME</span><span class=o>=</span>helloworld
</span></span><span class=line><span class=cl><span class=k>ENV</span> <span class=nv>OTEL_RESOURCE_ATTRIBUTES</span><span class=o>=</span><span class=s1>&#39;deployment.environment=otel-$INSTANCE&#39;</span></span></span></code></pre></div><blockquote><p>vi での変更を保存するには、<code>esc</code>キーを押してコマンドモードに入り、<code>:wq!</code>と入力してから<code>enter/return</code>キーを押します。</p></blockquote><h2 id=新しい-docker-イメージのビルド>新しい Docker イメージのビルド</h2><p>環境変数を除外した新しい Docker イメージをビルドしましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /home/splunk/workshop/docker-k8s-otel/helloworld
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>docker build -t helloworld:1.2 .</span></span></code></pre></div><blockquote><p>Note: we&rsquo;ve used a different version (1.2) to distinguish the image from our earlier version.
To clean up the older versions, run the following command to get the container id:</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker ps -a</span></span></code></pre></div><p>Then run the following command to delete the container:</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker rm &lt;old container id&gt; --force</span></span></code></pre></div><p>Now we can get the container image id:</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker images <span class=p>|</span> grep 1.1</span></span></code></pre></div><p>Finally, we can run the following command to delete the old image:</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker image rm &lt;old image id&gt;</span></span></code></pre></div></blockquote><h2 id=docker-イメージを-kubernetes-にインポート>Docker イメージを Kubernetes にインポート</h2><p>通常であれば、Docker イメージを Docker Hub などのリポジトリにプッシュします。
しかし、今回のセッションでは、k3s に直接インポートする回避策を使用します。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /home/splunk
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Export the image from docker</span>
</span></span><span class=line><span class=cl>docker save --output helloworld.tar helloworld:1.2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Import the image into k3s</span>
</span></span><span class=line><span class=cl>sudo k3s ctr images import helloworld.tar</span></span></code></pre></div><h2 id=net-アプリケーションのデプロイ>.NET アプリケーションのデプロイ</h2><blockquote><p>ヒント：vi で編集モードに入るには「i」キーを押します。変更を保存するには、<code>esc</code>キーを押してコマンドモードに入り、<code>:wq!</code>と入力してから<code>enter/return</code>キーを押します。</p></blockquote><p>.NET アプリケーションを K8s にデプロイするために、<code>/home/splunk</code>に<code>deployment.yaml</code>という名前のファイルを作成しましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi /home/splunk/deployment.yaml</span></span></code></pre></div><p>そして以下を貼り付けます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/library/helloworld:1.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>PORT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;8080&#34;</span></span></span></code></pre></div><details class="box cstyle notices tip expand"><summary class=box-label><i class="expander-icon fa-fw fas fa-chevron-right"></i>
<i class="fa-fw fas fa-lightbulb"></i>
Kubernetes における Deployment とは？</summary><div class=box-content><p>deployment.yaml ファイルは、deployment リソースを定義するために使用される kubernetes 設定ファイルです。このファイルは Kubernetes でアプリケーションを管理するための基盤となります！deployment 設定は deployment の <strong><em>望ましい状態</em></strong> を定義し、Kubernetes が <strong><em>実際の状態</em></strong> がそれと一致するよう保証します。これにより、アプリケーション pod の自己修復が可能になり、アプリケーションの簡単な更新やロールバックも可能になります。</p></div></details><p>次に、同じディレクトリに<code>service.yaml</code>という名前の 2 つ目のファイルを作成します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi /home/splunk/service.yaml</span></span></code></pre></div><p>そして以下を貼り付けます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span></span></span></code></pre></div><details class="box cstyle notices tip expand"><summary class=box-label><i class="expander-icon fa-fw fas fa-chevron-right"></i>
<i class="fa-fw fas fa-lightbulb"></i>
Kubernetes における Service とは？</summary><div class=box-content><p>Kubernetes の Service は抽象化レイヤーであり、仲介者のような役割を果たします。Pod にアクセスするための固定 IP アドレスや DNS 名を提供し、時間の経過とともに Pod が追加、削除、または交換されても同じままです。</p></div></details><p>これらのマニフェストファイルを使用してアプリケーションをデプロイできます：</p><div class=tab-panel data-tab-group=876da96ce39adb8344d39da7f8f81e7b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("876da96ce39adb8344d39da7f8f81e7b","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("876da96ce39adb8344d39da7f8f81e7b","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># create the deployment</span>
</span></span><span class=line><span class=cl>kubectl apply -f deployment.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># create the service</span>
</span></span><span class=line><span class=cl>kubectl apply -f service.yaml</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>deployment.apps/helloworld created
</span></span><span class=line><span class=cl>service/helloworld created</span></span></code></pre></div></div></div></div></div><h2 id=アプリケーションのテスト>アプリケーションのテスト</h2><p>アプリケーションにアクセスするには、まず IP アドレスを取得する必要があります：</p><div class=tab-panel data-tab-group=8e77f9d732f83d9b7e4726c5e0e50c73><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8e77f9d732f83d9b7e4726c5e0e50c73","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("8e77f9d732f83d9b7e4726c5e0e50c73","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe svc helloworld <span class=p>|</span> grep IP:</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>IP:                10.43.102.103</span></span></code></pre></div></div></div></div></div><p>その後、前のコマンドから返された Cluster IP を使用してアプリケーションにアクセスできます。
例：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://10.43.102.103:8080/hello/Kubernetes</span></span></code></pre></div><h2 id=opentelemetry-の設定>OpenTelemetry の設定</h2><p>.NET OpenTelemetry 計装はすでに Docker イメージに組み込まれています。しかし、データの送信先を指定するためにいくつかの環境変数を設定する必要があります。</p><p>先ほど作成した<code>deployment.yaml</code>ファイルに以下を追加します：</p><blockquote><p><strong>重要</strong> 以下の YAML の<code>$INSTANCE</code>をあなたのインスタンス名に置き換えてください。
インスタンス名は<code>echo $INSTANCE</code>を実行することで確認できます。</p></blockquote><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>PORT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;8080&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>NODE_IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>status.hostIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_EXPORTER_OTLP_ENDPOINT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;http://$(NODE_IP):4318&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_SERVICE_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;helloworld&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_RESOURCE_ATTRIBUTES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;deployment.environment=otel-$INSTANCE&#34;</span></span></span></code></pre></div><p>完全な<code>deployment.yaml</code>ファイルは以下のようになります（<code>$INSTANCE</code>ではなく<strong>あなたの</strong>インスタンス名を使用してください）：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/library/helloworld:1.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>PORT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;8080&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>NODE_IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>status.hostIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_EXPORTER_OTLP_ENDPOINT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;http://$(NODE_IP):4318&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_SERVICE_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;helloworld&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_RESOURCE_ATTRIBUTES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;deployment.environment=otel-$INSTANCE&#34;</span></span></span></code></pre></div><p>以下のコマンドで変更を適用します：</p><div class=tab-panel data-tab-group=922039d5d70ea030b96bb62ea5bbd728><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("922039d5d70ea030b96bb62ea5bbd728","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("922039d5d70ea030b96bb62ea5bbd728","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f deployment.yaml</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>deployment.apps/helloworld configured</span></span></code></pre></div></div></div></div></div><p>その後、<code>curl</code>を使用してトラフィックを生成します。</p><p>1 分ほど経過すると、o11y cloud でトレースが流れているのが確認できるはずです。ただし、より早くトレースを確認したい場合は、以下の方法があります&mldr;</p><h2 id=チャレンジ>チャレンジ</h2><p>開発者として、トレース ID を素早く取得するか、コンソールフィードバックを見たい場合、deployment.yaml ファイルにどのような環境変数を追加できるでしょうか？</p><details><summary><b>答えを見るにはここをクリック</b></summary><p>セクション 4「.NET Application を OpenTelemetry で計装する」のチャレンジで思い出していただければ、<code>OTEL_TRACES_EXPORTER</code>環境変数を使って trace を console に書き込むトリックをお見せしました。この変数を deployment.yaml に追加し、アプリケーションを再 deploy して、helloworld アプリから log を tail することで、trace id を取得して Splunk Observability Cloud で trace を見つけることができます。（ワークショップの次のセクションでは、debug exporter の使用についても説明します。これは K8s 環境でアプリケーションを debug する際の典型的な方法です。）</p><p>まず、vi で deployment.yaml ファイルを開きます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi deployment.yaml</span></span></code></pre></div><p>次に、<code>OTEL_TRACES_EXPORTER</code>環境変数を追加します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>PORT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;8080&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>NODE_IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>status.hostIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_EXPORTER_OTLP_ENDPOINT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;http://$(NODE_IP):4318&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_SERVICE_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;helloworld&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_RESOURCE_ATTRIBUTES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;deployment.environment=YOURINSTANCE&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># NEW VALUE HERE:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_TRACES_EXPORTER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;otlp,console&#34;</span></span></span></code></pre></div><p>変更を保存してからアプリケーションを再 deploy します：</p><div class=tab-panel data-tab-group=8dd2ac003d946fb3b438baa1172ed6fd><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8dd2ac003d946fb3b438baa1172ed6fd","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("8dd2ac003d946fb3b438baa1172ed6fd","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f deployment.yaml</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>deployment.apps/helloworld configured</span></span></code></pre></div></div></div></div></div><p>helloworld の log を tail します：</p><div class=tab-panel data-tab-group=88bd3bf181fc9680db2ea8a50a962084><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("88bd3bf181fc9680db2ea8a50a962084","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("88bd3bf181fc9680db2ea8a50a962084","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl logs -l <span class=nv>app</span><span class=o>=</span>helloworld -f</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>info: HelloWorldController<span class=o>[</span>0<span class=o>]</span>
</span></span><span class=line><span class=cl>      /hello endpoint invoked by K8s9
</span></span><span class=line><span class=cl>Activity.TraceId:            5bceb747cc7b79a77cfbde285f0f09cb
</span></span><span class=line><span class=cl>Activity.SpanId:             ac67afe500e7ad12
</span></span><span class=line><span class=cl>Activity.TraceFlags:         Recorded
</span></span><span class=line><span class=cl>Activity.ActivitySourceName: Microsoft.AspNetCore
</span></span><span class=line><span class=cl>Activity.DisplayName:        GET hello/<span class=o>{</span>name?<span class=o>}</span>
</span></span><span class=line><span class=cl>Activity.Kind:               Server
</span></span><span class=line><span class=cl>Activity.StartTime:          2025-02-04T15:22:48.2381736Z
</span></span><span class=line><span class=cl>Activity.Duration:           00:00:00.0027334
</span></span><span class=line><span class=cl>Activity.Tags:
</span></span><span class=line><span class=cl>    server.address: 10.43.226.224
</span></span><span class=line><span class=cl>    server.port: <span class=m>8080</span>
</span></span><span class=line><span class=cl>    http.request.method: GET
</span></span><span class=line><span class=cl>    url.scheme: http
</span></span><span class=line><span class=cl>    url.path: /hello/K8s9
</span></span><span class=line><span class=cl>    network.protocol.version: 1.1
</span></span><span class=line><span class=cl>    user_agent.original: curl/7.81.0
</span></span><span class=line><span class=cl>    http.route: hello/<span class=o>{</span>name?<span class=o>}</span>
</span></span><span class=line><span class=cl>    http.response.status_code: <span class=m>200</span>
</span></span><span class=line><span class=cl>Resource associated with Activity:
</span></span><span class=line><span class=cl>    splunk.distro.version: 1.8.0
</span></span><span class=line><span class=cl>    telemetry.distro.name: splunk-otel-dotnet
</span></span><span class=line><span class=cl>    telemetry.distro.version: 1.8.0
</span></span><span class=line><span class=cl>    os.type: linux
</span></span><span class=line><span class=cl>    os.description: Debian GNU/Linux <span class=m>12</span> <span class=o>(</span>bookworm<span class=o>)</span>
</span></span><span class=line><span class=cl>    os.build_id: 6.2.0-1018-aws
</span></span><span class=line><span class=cl>    os.name: Debian GNU/Linux
</span></span><span class=line><span class=cl>    os.version: <span class=m>12</span>
</span></span><span class=line><span class=cl>    host.name: helloworld-69f5c7988b-dxkwh
</span></span><span class=line><span class=cl>    process.owner: app
</span></span><span class=line><span class=cl>    process.pid: <span class=m>1</span>
</span></span><span class=line><span class=cl>    process.runtime.description: .NET 8.0.12
</span></span><span class=line><span class=cl>    process.runtime.name: .NET
</span></span><span class=line><span class=cl>    process.runtime.version: 8.0.12
</span></span><span class=line><span class=cl>    container.id: 39c2061d7605d8c390b4fe5f8054719f2fe91391a5c32df5684605202ca39ae9
</span></span><span class=line><span class=cl>    telemetry.sdk.name: opentelemetry
</span></span><span class=line><span class=cl>    telemetry.sdk.language: dotnet
</span></span><span class=line><span class=cl>    telemetry.sdk.version: 1.9.0
</span></span><span class=line><span class=cl>    service.name: helloworld
</span></span><span class=line><span class=cl>    deployment.environment: otel-jen-tko-1b75</span></span></code></pre></div></div></div></div></div><p>次に、別の terminal window で curl コマンドを使って trace を生成します。log を tail している console で trace id が表示されるはずです。<code>Activity.TraceId:</code>の値をコピーして、APM の Trace 検索フィールドに貼り付けてください。</p></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/06/17</span></span></footer></article><article class=default><header class=headline></header><h1 id=opentelemetryコレクター設定のカスタマイズ>OpenTelemetryコレクター設定のカスタマイズ</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>20 minutes</span>
</span>&nbsp;<p>デフォルト設定を使用して K8s クラスターに Splunk Distribution of OpenTelemetry コレクターを
デプロイしました。このセクションでは、コレクター設定をカスタマイズする方法をいくつかの例で
説明します。</p><h2 id=コレクター設定の取得>コレクター設定の取得</h2><p>コレクター設定をカスタマイズする前に、現在の設定がどのようになっているかを
どのように確認するのでしょうか？</p><p>Kubernetes 環境では、コレクター設定は Config Map を使用して保存されます。</p><p>以下のコマンドで、クラスターに存在する config map を確認できます：</p><div class=tab-panel data-tab-group=64c335f559a7fee47f151fac5fe34177><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("64c335f559a7fee47f151fac5fe34177","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("64c335f559a7fee47f151fac5fe34177","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get cm -l <span class=nv>app</span><span class=o>=</span>splunk-otel-collector</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>NAME                                                 DATA   AGE
</span></span><span class=line><span class=cl>splunk-otel-collector-otel-k8s-cluster-receiver   <span class=m>1</span>      3h37m
</span></span><span class=line><span class=cl>splunk-otel-collector-otel-agent                  <span class=m>1</span>      3h37m</span></span></code></pre></div></div></div></div></div><blockquote><p>なぜ 2 つの config map があるのでしょうか？</p></blockquote><p>次に、以下のようにコレクターエージェントの config map を表示できます：</p><div class=tab-panel data-tab-group=f750f858ef312251c1d729aa1f5bcccf><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f750f858ef312251c1d729aa1f5bcccf","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("f750f858ef312251c1d729aa1f5bcccf","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe cm splunk-otel-collector-otel-agent</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Name:         splunk-otel-collector-otel-agent
</span></span><span class=line><span class=cl>Namespace:    default
</span></span><span class=line><span class=cl>Labels:       <span class=nv>app</span><span class=o>=</span>splunk-otel-collector
</span></span><span class=line><span class=cl>              app.kubernetes.io/instance<span class=o>=</span>splunk-otel-collector
</span></span><span class=line><span class=cl>              app.kubernetes.io/managed-by<span class=o>=</span>Helm
</span></span><span class=line><span class=cl>              app.kubernetes.io/name<span class=o>=</span>splunk-otel-collector
</span></span><span class=line><span class=cl>              app.kubernetes.io/version<span class=o>=</span>0.113.0
</span></span><span class=line><span class=cl>              <span class=nv>chart</span><span class=o>=</span>splunk-otel-collector-0.113.0
</span></span><span class=line><span class=cl>              helm.sh/chart<span class=o>=</span>splunk-otel-collector-0.113.0
</span></span><span class=line><span class=cl>              <span class=nv>heritage</span><span class=o>=</span>Helm
</span></span><span class=line><span class=cl>              <span class=nv>release</span><span class=o>=</span>splunk-otel-collector
</span></span><span class=line><span class=cl>Annotations:  meta.helm.sh/release-name: splunk-otel-collector
</span></span><span class=line><span class=cl>              meta.helm.sh/release-namespace: default
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>Data</span>
</span></span><span class=line><span class=cl><span class=o>====</span>
</span></span><span class=line><span class=cl>relay:
</span></span><span class=line><span class=cl>----
</span></span><span class=line><span class=cl>exporters:
</span></span><span class=line><span class=cl>  otlphttp:
</span></span><span class=line><span class=cl>    headers:
</span></span><span class=line><span class=cl>      X-SF-Token: <span class=si>${</span><span class=nv>SPLUNK_OBSERVABILITY_ACCESS_TOKEN</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    metrics_endpoint: https://ingest.us1.signalfx.com/v2/datapoint/otlp
</span></span><span class=line><span class=cl>    traces_endpoint: https://ingest.us1.signalfx.com/v2/trace/otlp
</span></span><span class=line><span class=cl>    <span class=o>(</span>followed by the rest of the collector config in yaml format<span class=o>)</span></span></span></code></pre></div></div></div></div></div><h2 id=k8s-でコレクター設定を更新する方法>K8s でコレクター設定を更新する方法</h2><p>Linux インスタンスでコレクターを実行した以前の例では、コレクター設定は
<code>/etc/otel/collector/agent_config.yaml</code>ファイルで利用可能でした。その場合にコレクター設定を
変更する必要があれば、単純にこのファイルを編集し、変更を保存してから
コレクターを再起動すればよかったのです。</p><p>K8s では、少し異なる動作をします。<code>agent_config.yaml</code>を直接変更する代わりに、
helm チャートをデプロイするために使用される<code>values.yaml</code>ファイルを変更することで
コレクター設定をカスタマイズします。</p><p><a href=https://github.com/signalfx/splunk-otel-collector-chart/blob/main/helm-charts/splunk-otel-collector/values.yaml rel=external target=_blank>GitHub</a>の values.yaml ファイルには、
利用可能なカスタマイズオプションが記載されています。</p><p>例を見てみましょう。</p><h2 id=infrastructure-events-monitoring-の追加>Infrastructure Events Monitoring の追加</h2><p>最初の例として、K8s クラスターの infrastructure events monitoring を有効にしましょう。</p><blockquote><p>これにより、charts の Events Feed セクションの一部として Kubernetes イベントを確認できるようになります。
cluster receiver は、kubernetes-events
monitor を使用して Smart Agent receiver で設定され、custom イベントを送信します。詳細については<a href=https://docs.splunk.com/observability/en/gdi/opentelemetry/collector-kubernetes/kubernetes-config-logs.html#collect-kubernetes-events rel=external target=_blank>Collect Kubernetes events</a>を参照してください。</p></blockquote><p>これは<code>values.yaml</code>ファイルに以下の行を追加することで実行されます：</p><blockquote><p>ヒント：vi での開き方と保存方法は前のステップにあります。</p></blockquote><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>logsEngine</span><span class=p>:</span><span class=w> </span><span class=l>otel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>splunkObservability</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>infrastructureMonitoringEventsEnabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>agent:</span></span></span></code></pre></div><p>ファイルが保存されたら、以下のコマンドで変更を適用できます：</p><div class=tab-panel data-tab-group=21b45c5117a0dce51736bfab1f4ad3bf><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("21b45c5117a0dce51736bfab1f4ad3bf","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("21b45c5117a0dce51736bfab1f4ad3bf","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm upgrade splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkObservability.realm=</span><span class=nv>$REALM</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkObservability.accessToken=</span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;clusterName=</span><span class=nv>$INSTANCE</span><span class=s2>-cluster&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;environment=otel-</span><span class=nv>$INSTANCE</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.token=</span><span class=nv>$HEC_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.endpoint=</span><span class=nv>$HEC_URL</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.index=splunk4rookies-workshop&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -f values.yaml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>splunk-otel-collector-chart/splunk-otel-collector</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Release <span class=s2>&#34;splunk-otel-collector&#34;</span> has been upgraded. Happy Helming!
</span></span><span class=line><span class=cl>NAME: splunk-otel-collector
</span></span><span class=line><span class=cl>LAST DEPLOYED: Fri Dec <span class=m>20</span> 01:17:03 <span class=m>2024</span>
</span></span><span class=line><span class=cl>NAMESPACE: default
</span></span><span class=line><span class=cl>STATUS: deployed
</span></span><span class=line><span class=cl>REVISION: <span class=m>2</span>
</span></span><span class=line><span class=cl>TEST SUITE: None
</span></span><span class=line><span class=cl>NOTES:
</span></span><span class=line><span class=cl>Splunk OpenTelemetry Collector is installed and configured to send data to Splunk Observability realm us1.</span></span></code></pre></div></div></div></div></div><p>その後、config map を表示して変更が適用されたことを確認できます：</p><div class=tab-panel data-tab-group=01eac6f959c973b8d42694d842641b55><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("01eac6f959c973b8d42694d842641b55","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("01eac6f959c973b8d42694d842641b55","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe cm splunk-otel-collector-otel-k8s-cluster-receiver</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><p><code>smartagent/kubernetes-events</code>が agent config に含まれていることを確認してください：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>  smartagent/kubernetes-events:
</span></span><span class=line><span class=cl>    alwaysClusterReporter: <span class=nb>true</span>
</span></span><span class=line><span class=cl>    type: kubernetes-events
</span></span><span class=line><span class=cl>    whitelistedEvents:
</span></span><span class=line><span class=cl>    - involvedObjectKind: Pod
</span></span><span class=line><span class=cl>      reason: Created
</span></span><span class=line><span class=cl>    - involvedObjectKind: Pod
</span></span><span class=line><span class=cl>      reason: Unhealthy
</span></span><span class=line><span class=cl>    - involvedObjectKind: Pod
</span></span><span class=line><span class=cl>      reason: Failed
</span></span><span class=line><span class=cl>    - involvedObjectKind: Job
</span></span><span class=line><span class=cl>      reason: FailedCreate</span></span></code></pre></div></div></div></div></div><blockquote><p>これらの特定の変更が適用されるのは
cluster receiver config map なので、そちらを指定していることに注意してください。</p></blockquote><h2 id=debug-exporter-の追加>Debug Exporter の追加</h2><p>collector に送信される trace と log を確認して、
Splunk に送信する前に検査したいとします。この目的のために debug exporter を使用できます。これは
OpenTelemetry 関連の問題のトラブルシューティングに役立ちます。</p><p>values.yaml ファイルの下部に以下のように debug exporter を追加しましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>logsEngine</span><span class=p>:</span><span class=w> </span><span class=l>otel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>splunkObservability</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>infrastructureMonitoringEventsEnabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>agent</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>verbosity</span><span class=p>:</span><span class=w> </span><span class=l>detailed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>debug</span></span></span></code></pre></div><p>ファイルが保存されたら、以下のコマンドで変更を適用できます：</p><div class=tab-panel data-tab-group=6d2ed0eae3365adf329515845074e255><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6d2ed0eae3365adf329515845074e255","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("6d2ed0eae3365adf329515845074e255","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm upgrade splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkObservability.realm=</span><span class=nv>$REALM</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkObservability.accessToken=</span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;clusterName=</span><span class=nv>$INSTANCE</span><span class=s2>-cluster&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;environment=otel-</span><span class=nv>$INSTANCE</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.token=</span><span class=nv>$HEC_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.endpoint=</span><span class=nv>$HEC_URL</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.index=splunk4rookies-workshop&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -f values.yaml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>splunk-otel-collector-chart/splunk-otel-collector</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Release <span class=s2>&#34;splunk-otel-collector&#34;</span> has been upgraded. Happy Helming!
</span></span><span class=line><span class=cl>NAME: splunk-otel-collector
</span></span><span class=line><span class=cl>LAST DEPLOYED: Fri Dec <span class=m>20</span> 01:32:03 <span class=m>2024</span>
</span></span><span class=line><span class=cl>NAMESPACE: default
</span></span><span class=line><span class=cl>STATUS: deployed
</span></span><span class=line><span class=cl>REVISION: <span class=m>3</span>
</span></span><span class=line><span class=cl>TEST SUITE: None
</span></span><span class=line><span class=cl>NOTES:
</span></span><span class=line><span class=cl>Splunk OpenTelemetry Collector is installed and configured to send data to Splunk Observability realm us1.</span></span></code></pre></div></div></div></div></div><p>curl を使用してアプリケーションを数回実行してから、以下のコマンドで agent collector の log を tail します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl logs -l <span class=nv>component</span><span class=o>=</span>otel-collector-agent -f</span></span></code></pre></div><p>以下のような trace が agent collector の log に書き込まれているのが確認できるはずです：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code>2024-12-20T01:43:52.929Z info Traces {&#34;kind&#34;: &#34;exporter&#34;, &#34;data_type&#34;: &#34;traces&#34;, &#34;name&#34;: &#34;debug&#34;, &#34;resource spans&#34;: 1, &#34;spans&#34;: 2}
2024-12-20T01:43:52.929Z info ResourceSpans #0
Resource SchemaURL: https://opentelemetry.io/schemas/1.6.1
Resource attributes:
     -&gt; splunk.distro.version: Str(1.8.0)
     -&gt; telemetry.distro.name: Str(splunk-otel-dotnet)
     -&gt; telemetry.distro.version: Str(1.8.0)
     -&gt; os.type: Str(linux)
     -&gt; os.description: Str(Debian GNU/Linux 12 (bookworm))
     -&gt; os.build_id: Str(6.8.0-1021-aws)
     -&gt; os.name: Str(Debian GNU/Linux)
     -&gt; os.version: Str(12)
     -&gt; host.name: Str(derek-1)
     -&gt; process.owner: Str(app)
     -&gt; process.pid: Int(1)
     -&gt; process.runtime.description: Str(.NET 8.0.11)
     -&gt; process.runtime.name: Str(.NET)
     -&gt; process.runtime.version: Str(8.0.11)
     -&gt; container.id: Str(78b452a43bbaa3354a3cb474010efd6ae2367165a1356f4b4000be031b10c5aa)
     -&gt; telemetry.sdk.name: Str(opentelemetry)
     -&gt; telemetry.sdk.language: Str(dotnet)
     -&gt; telemetry.sdk.version: Str(1.9.0)
     -&gt; service.name: Str(helloworld)
     -&gt; deployment.environment: Str(otel-derek-1)
     -&gt; k8s.pod.ip: Str(10.42.0.15)
     -&gt; k8s.pod.labels.app: Str(helloworld)
     -&gt; k8s.pod.name: Str(helloworld-84865965d9-nkqsx)
     -&gt; k8s.namespace.name: Str(default)
     -&gt; k8s.pod.uid: Str(38d39bc6-1309-4022-a569-8acceef50942)
     -&gt; k8s.node.name: Str(derek-1)
     -&gt; k8s.cluster.name: Str(derek-1-cluster)</code></pre></div><p>そして以下のような log エントリも確認できます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code>2024-12-20T01:43:53.215Z info Logs {&#34;kind&#34;: &#34;exporter&#34;, &#34;data_type&#34;: &#34;logs&#34;, &#34;name&#34;: &#34;debug&#34;, &#34;resource logs&#34;: 1, &#34;log records&#34;: 2}
2024-12-20T01:43:53.215Z info ResourceLog #0
Resource SchemaURL: https://opentelemetry.io/schemas/1.6.1
Resource attributes:
     -&gt; splunk.distro.version: Str(1.8.0)
     -&gt; telemetry.distro.name: Str(splunk-otel-dotnet)
     -&gt; telemetry.distro.version: Str(1.8.0)
     -&gt; os.type: Str(linux)
     -&gt; os.description: Str(Debian GNU/Linux 12 (bookworm))
     -&gt; os.build_id: Str(6.8.0-1021-aws)
     -&gt; os.name: Str(Debian GNU/Linux)
     -&gt; os.version: Str(12)
     -&gt; host.name: Str(derek-1)
     -&gt; process.owner: Str(app)
     -&gt; process.pid: Int(1)
     -&gt; process.runtime.description: Str(.NET 8.0.11)
     -&gt; process.runtime.name: Str(.NET)
     -&gt; process.runtime.version: Str(8.0.11)
     -&gt; container.id: Str(78b452a43bbaa3354a3cb474010efd6ae2367165a1356f4b4000be031b10c5aa)
     -&gt; telemetry.sdk.name: Str(opentelemetry)
     -&gt; telemetry.sdk.language: Str(dotnet)
     -&gt; telemetry.sdk.version: Str(1.9.0)
     -&gt; service.name: Str(helloworld)
     -&gt; deployment.environment: Str(otel-derek-1)
     -&gt; k8s.node.name: Str(derek-1)
     -&gt; k8s.cluster.name: Str(derek-1-cluster)</code></pre></div><p>ただし、Splunk Observability Cloud に戻ると、アプリケーションから trace と log が
もはやそこに送信されていないことに気づくでしょう。</p><p>なぜそうなったと思いますか？次のセクションで詳しく説明します。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/06/17</span></span></footer></article><article class=default><header class=headline></header><h1 id=troubleshoot-opentelemetry-collector-issues>Troubleshoot OpenTelemetry Collector Issues</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>20 minutes</span>
</span>&nbsp;<p>前のセクションでは、debug エクスポーターをコレクターの設定に追加し、
トレースとログのパイプラインの一部にしました。期待通りに、debug 出力が
エージェントコレクターのログに書き込まれているのが確認できます。</p><p>しかし、トレースが o11y cloud に送信されなくなっています。なぜなのかを把握して修正しましょう。</p><h2 id=コレクター設定を確認する>コレクター設定を確認する</h2><p><code>values.yaml</code>ファイルを通じてコレクター設定が変更された場合は、
config map を確認してコレクターに実際に適用された設定を確認することが役立ちます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe cm splunk-otel-collector-otel-agent</span></span></code></pre></div><p>エージェントコレクター設定のログとトレースのパイプラインを確認しましょう。次のようになっているはずです：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>k8sattributes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>filter/logs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/logs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_environment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>filelog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>fluentforward</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>k8sattributes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_environment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>jaeger</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>smartagent/signalfx-forwarder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>zipkin</span></span></span></code></pre></div><p>問題がわかりますか？debug エクスポーターのみがトレースとログのパイプラインに含まれています。
以前のトレースパイプライン設定にあった<code>otlphttp</code>と<code>signalfx</code>エクスポーターがなくなっています。
これが、もう o11y cloud でトレースが見えなくなった理由です。ログパイプラインについても、<code>splunk_hec/platform_logs</code>
エクスポーターが削除されています。</p><blockquote><p>どのような特定のエクスポーターが以前含まれていたかをどのように知ったか？それを見つけるには、
以前のカスタマイズを元に戻してから、config map を確認して
トレースパイプラインに元々何が含まれていたかを見ることもできました。あるいは、
<a href=https://github.com/signalfx/splunk-otel-collector-chart/blob/main/examples/default/rendered_manifests/configmap-agent.yaml rel=external target=_blank>splunk-otel-collector-chart の GitHub リポジトリ</a>
の例を参照することもでき、これにより Helm チャートで使用されるデフォルトのエージェント設定が分かります。</p></blockquote><h2 id=これらのエクスポーターはどのように削除されたのか>これらのエクスポーターはどのように削除されたのか？</h2><p><code>values.yaml</code>ファイルに追加したカスタマイズを確認しましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>logsEngine</span><span class=p>:</span><span class=w> </span><span class=l>otel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>splunkObservability</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>infrastructureMonitoringEventsEnabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>agent</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>verbosity</span><span class=p>:</span><span class=w> </span><span class=l>detailed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>debug</span></span></span></code></pre></div><p><code>helm upgrade</code>を使ってコレクターに<code>values.yaml</code>ファイルを適用したとき、
カスタム設定は以前のコレクター設定とマージされました。
これが発生すると、リストを含む<code>yaml</code>設定のセクション、
例えばパイプラインセクションのエクスポーターのリストは、<code>values.yaml</code>ファイルに
含めたもの（debug エクスポーターのみ）で置き換えられます。</p><h2 id=問題を修正しましょう>問題を修正しましょう</h2><p>既存のパイプラインをカスタマイズする場合、設定のその部分を完全に再定義する必要があります。
したがって、<code>values.yaml</code>ファイルを次のように更新する必要があります：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>logsEngine</span><span class=p>:</span><span class=w> </span><span class=l>otel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>splunkObservability</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>infrastructureMonitoringEventsEnabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>agent</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>verbosity</span><span class=p>:</span><span class=w> </span><span class=l>detailed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>otlphttp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>signalfx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>splunk_hec/platform_logs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>debug</span></span></span></code></pre></div><p>変更を適用しましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm upgrade splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkObservability.realm=</span><span class=nv>$REALM</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkObservability.accessToken=</span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;clusterName=</span><span class=nv>$INSTANCE</span><span class=s2>-cluster&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;environment=otel-</span><span class=nv>$INSTANCE</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.token=</span><span class=nv>$HEC_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.endpoint=</span><span class=nv>$HEC_URL</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.index=splunk4rookies-workshop&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -f values.yaml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>splunk-otel-collector-chart/splunk-otel-collector</span></span></code></pre></div><p>それからエージェント config map を確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe cm splunk-otel-collector-otel-agent</span></span></code></pre></div><p>今度は、ログとトレースの両方について完全に定義されたエクスポーターパイプラインが表示されるはずです：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>  pipelines:
</span></span><span class=line><span class=cl>    logs:
</span></span><span class=line><span class=cl>      exporters:
</span></span><span class=line><span class=cl>      - splunk_hec/platform_logs
</span></span><span class=line><span class=cl>      - debug
</span></span><span class=line><span class=cl>      processors:
</span></span><span class=line><span class=cl>      ...
</span></span><span class=line><span class=cl>    traces:
</span></span><span class=line><span class=cl>      exporters:
</span></span><span class=line><span class=cl>      - otlphttp
</span></span><span class=line><span class=cl>      - signalfx
</span></span><span class=line><span class=cl>      - debug
</span></span><span class=line><span class=cl>      processors:
</span></span><span class=line><span class=cl>      ...</span></span></code></pre></div><h2 id=ログ出力の確認>ログ出力の確認</h2><p><strong>Splunk Distribution of OpenTelemetry .NET</strong>は、ログに使用するアプリケーション
（サンプルアプリでも使用している）から、トレースコンテキストで強化されたログを自動的にエクスポートします。</p><p>アプリケーションログはトレースメタデータで強化され、その後
OpenTelemetry Collector のローカルインスタンスに OTLP 形式でエクスポートされます。</p><p>debug エクスポーターによってキャプチャされたログを詳しく見て、それが発生しているかを確認しましょう。
コレクターログを tail するには、次のコマンドを使用できます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl logs -l <span class=nv>component</span><span class=o>=</span>otel-collector-agent -f</span></span></code></pre></div><p>ログを tail したら、curl を使ってさらにトラフィックを生成できます。そうすると
次のようなものが表示されるはずです：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code>2024-12-20T21:56:30.858Z info Logs {&#34;kind&#34;: &#34;exporter&#34;, &#34;data_type&#34;: &#34;logs&#34;, &#34;name&#34;: &#34;debug&#34;, &#34;resource logs&#34;: 1, &#34;log records&#34;: 1}
2024-12-20T21:56:30.858Z info ResourceLog #0
Resource SchemaURL: https://opentelemetry.io/schemas/1.6.1
Resource attributes:
     -&gt; splunk.distro.version: Str(1.8.0)
     -&gt; telemetry.distro.name: Str(splunk-otel-dotnet)
     -&gt; telemetry.distro.version: Str(1.8.0)
     -&gt; os.type: Str(linux)
     -&gt; os.description: Str(Debian GNU/Linux 12 (bookworm))
     -&gt; os.build_id: Str(6.8.0-1021-aws)
     -&gt; os.name: Str(Debian GNU/Linux)
     -&gt; os.version: Str(12)
     -&gt; host.name: Str(derek-1)
     -&gt; process.owner: Str(app)
     -&gt; process.pid: Int(1)
     -&gt; process.runtime.description: Str(.NET 8.0.11)
     -&gt; process.runtime.name: Str(.NET)
     -&gt; process.runtime.version: Str(8.0.11)
     -&gt; container.id: Str(5bee5b8f56f4b29f230ffdd183d0367c050872fefd9049822c1ab2aa662ba242)
     -&gt; telemetry.sdk.name: Str(opentelemetry)
     -&gt; telemetry.sdk.language: Str(dotnet)
     -&gt; telemetry.sdk.version: Str(1.9.0)
     -&gt; service.name: Str(helloworld)
     -&gt; deployment.environment: Str(otel-derek-1)
     -&gt; k8s.node.name: Str(derek-1)
     -&gt; k8s.cluster.name: Str(derek-1-cluster)
ScopeLogs #0
ScopeLogs SchemaURL:
InstrumentationScope HelloWorldController
LogRecord #0
ObservedTimestamp: 2024-12-20 21:56:28.486804 +0000 UTC
Timestamp: 2024-12-20 21:56:28.486804 +0000 UTC
SeverityText: Information
SeverityNumber: Info(9)
Body: Str(/hello endpoint invoked by {name})
Attributes:
     -&gt; name: Str(Kubernetes)
Trace ID: 78db97a12b942c0252d7438d6b045447
Span ID: 5e9158aa42f96db3
Flags: 1
 {&#34;kind&#34;: &#34;exporter&#34;, &#34;data_type&#34;: &#34;logs&#34;, &#34;name&#34;: &#34;debug&#34;}</code></pre></div><p>この例では、Trace ID と Span ID が
OpenTelemetry .NET 計装によってログ出力に自動的に書き込まれていることがわかります。これにより、
Splunk Observability Cloud でログとトレースを関連付けることができます。</p><p>ただし、Helm を使って K8s クラスターに OpenTelemetry collector をデプロイし、
ログ収集オプションを含める場合、OpenTelemetry collector は File Log receiver を使用して
コンテナーログを自動的にキャプチャすることを覚えておいてください。</p><p>これにより、アプリケーションの重複ログがキャプチャされることになります。例えば、次のスクリーンショットでは
サービスへの各リクエストに対して 2 つのログエントリーが表示されています：</p><p><a href=#R-image-ecfcd8db281156abdcbb93e810fdce67 class=lightbox-link><img alt="Duplicate Log Entries" class="lazy lightbox figure-image" loading=lazy src=../images/duplicate_logs.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ecfcd8db281156abdcbb93e810fdce67><img alt="Duplicate Log Entries" class="lazy lightbox lightbox-image" loading=lazy src=../images/duplicate_logs.png></a></p><p>これをどのように回避しますか？</p><h2 id=k8s-での重複ログの回避>K8s での重複ログの回避</h2><p>重複ログをキャプチャしないようにするには、<code>OTEL_LOGS_EXPORTER</code>環境変数を<code>none</code>に設定して、
Splunk Distribution of OpenTelemetry .NET が OTLP を使用してコレクターにログをエクスポートしないようにできます。
これは、<code>deployment.yaml</code>ファイルに<code>OTEL_LOGS_EXPORTER</code>環境変数を追加することで実行できます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>PORT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;8080&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>NODE_IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>status.hostIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_EXPORTER_OTLP_ENDPOINT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;http://$(NODE_IP):4318&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_SERVICE_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;helloworld&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_RESOURCE_ATTRIBUTES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;deployment.environment=otel-$INSTANCE&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_LOGS_EXPORTER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;none&#34;</span></span></span></code></pre></div><p>それから次を実行します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># update the deployment</span>
</span></span><span class=line><span class=cl>kubectl apply -f deployment.yaml</span></span></code></pre></div><p><code>OTEL_LOGS_EXPORTER</code>環境変数を<code>none</code>に設定するのは簡単です。しかし、Trace ID と
Span ID はアプリケーションによって生成された stdout ログに書き込まれないため、
ログとトレースを関連付けることができなくなります。</p><p>これを解決するには、
<code>/home/splunk/workshop/docker-k8s-otel/helloworld/SplunkTelemetryConfigurator.cs</code>で定義されている例のような、カスタムロガーを定義する必要があります。</p><p>次のように<code>Program.cs</code>ファイルを更新することで、これをアプリケーションに含めることができます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>using</span> <span class=nn>SplunkTelemetry</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>Microsoft.Extensions.Logging.Console</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>builder</span> <span class=p>=</span> <span class=n>WebApplication</span><span class=p>.</span><span class=n>CreateBuilder</span><span class=p>(</span><span class=n>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>builder</span><span class=p>.</span><span class=n>Services</span><span class=p>.</span><span class=n>AddControllers</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>SplunkTelemetryConfigurator</span><span class=p>.</span><span class=n>ConfigureLogger</span><span class=p>(</span><span class=n>builder</span><span class=p>.</span><span class=n>Logging</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>app</span> <span class=p>=</span> <span class=n>builder</span><span class=p>.</span><span class=n>Build</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=p>.</span><span class=n>MapControllers</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=p>.</span><span class=n>Run</span><span class=p>();</span></span></span></code></pre></div><p>その後、カスタムログ設定を含む新しい Docker イメージをビルドします：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /home/splunk/workshop/docker-k8s-otel/helloworld
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>docker build -t helloworld:1.3 .</span></span></code></pre></div><p>それから更新されたイメージを Kubernetes にインポートします：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /home/splunk
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Export the image from docker</span>
</span></span><span class=line><span class=cl>docker save --output helloworld.tar helloworld:1.3
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Import the image into k3s</span>
</span></span><span class=line><span class=cl>sudo k3s ctr images import helloworld.tar</span></span></code></pre></div><p>最後に、<code>deployment.yaml</code>ファイルを更新してコンテナーイメージの 1.3 バージョンを使用する必要があります：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/library/helloworld:1.3</span></span></span></code></pre></div><p>それから変更を適用します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># update the deployment</span>
</span></span><span class=line><span class=cl>kubectl apply -f deployment.yaml</span></span></code></pre></div><p>これで重複したログエントリーが排除されたことがわかります。そして
残りのログエントリーは JSON としてフォーマットされ、span と trace ID が含まれています：</p><p><a href=#R-image-e44755603894822b6118864ca9546a01 class=lightbox-link><img alt="JSON Format Logs" class="lazy lightbox figure-image" loading=lazy src=../images/logs_json_format.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e44755603894822b6118864ca9546a01><img alt="JSON Format Logs" class="lazy lightbox lightbox-image" loading=lazy src=../images/logs_json_format.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/06/17</span></span></footer></article><article class=default><header class=headline></header><h1 id=summary>Summary</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>2 minutes</span>
</span>&nbsp;<p>このワークショップでは、以下の概念についてハンズオンで体験しました：</p><ul><li>Linux ホストに<strong>Splunk Distribution of the OpenTelemetry Collector</strong>をデプロイする方法。</li><li><strong>Splunk Distribution of OpenTelemetry .NET</strong>で.NET アプリケーションを計装する方法。</li><li>.NET アプリケーションを「Docker 化」し、<strong>Splunk Distribution of OpenTelemetry .NET</strong>で計装する方法。</li><li>Helm を使用して Kubernetes クラスターに<strong>Splunk Distribution of the OpenTelemetry Collector</strong>をデプロイする方法。</li><li>コレクター設定をカスタマイズして問題をトラブルシューティングする方法。</li></ul><p>他の言語と環境で OpenTelemetry がどのように計装されるかを確認するには、
<a href=https://github.com/signalfx/splunk-opentelemetry-examples rel=external target=_blank>Splunk OpenTelemetry Examples GitHub リポジトリ</a>をご覧ください。</p><p>将来このワークショップを独自に実行するには、これらの手順を参照して、Splunk Show の<strong>Splunk4Rookies - Observability</strong>
ワークショップテンプレートを使用して EC2 インスタンスをプロビジョニングしてください。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/06/16</span></span></footer></article></section></section></div></main></div><script src=/observability-workshop/v5.97/js/clipboard/clipboard.min.js?1752005933 defer></script><script src=/observability-workshop/v5.97/js/perfect-scrollbar/perfect-scrollbar.min.js?1752005933 defer></script><script src=/observability-workshop/v5.97/js/theme.min.js?1752005933 defer></script></body></html>