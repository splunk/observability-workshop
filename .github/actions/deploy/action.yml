name: 'Deploy'
description: 'Build and deploy workshop'

inputs:
  flavour:
    description: type of version to release
    required: true
    default: 'minor'

outputs:
  tag_name:
    description: name of tag created by bumpversion
    value: ${{ steps.bumpversion.outputs.tag_name }}

runs:
  using: "composite"
  steps:
    - name: Bumpversion and commit
      id: bumpversion
      shell: bash
      run: ./.github/ci/do_release -t ${{ inputs.flavour }}

    - name: Build Site
      shell: bash
      run: ./.github/ci/build_site -b ${{ steps.bumpversion.outputs.base_url }} -t ${{ steps.bumpversion.outputs.tag_name }}

    - name: Prepare and publish to GitHub pages
      shell: bash
      env:
        TAG: ${{ steps.bumpversion.outputs.tag_name }}
      run: |
        publish_dir="$(pwd)/site/v${{ steps.bumpversion.outputs.tag_name }}"
        remote=${{ github.repositoryUrl }}
        push_remote=https://${GITHUB_ACTOR}:${{ github.token }}@github.com/${REPOSITORY}.git
        prep_dir=$(mktemp -d)

        git clone --depth=1 --single-branch --branch gh-pages "${remote}" "${prep_dir}"
        git config user.name "${GITHUB_ACTOR}"
        git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"

        cd "${prep_dir}"

        mkdir "v${TAG}"
        rm -f latest || true
        ln -s "v${TAG}" latest
        git add latest

        cd "v${TAG}"
        rsync -a "${publish_dir}" .
        git add --all .

        git remote rm origin || true
        git remote add origin "${push_remote}"
        git commit -m "Docs: Releasing $TAG"
        git push origin gh-pages

    # - name: Deploy
    #   uses: peaceiris/actions-gh-pages@v3
    #   if: github.ref == 'refs/heads/master' && (inputs.flavour == 'minor' || inputs.flavour == 'major')
    #   with:
    #     github_token: ${{ github.token }}
    #     publish_dir: './site/v${{ steps.bumpversion.outputs.tag_name }}'
    #     destination_dir: 'v${{ steps.bumpversion.outputs.tag_name }}'
    #     commit_message: 'Docs: Releasing ${{ steps.bumpversion.outputs.tag_name }}'
