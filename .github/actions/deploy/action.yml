name: 'Deploy'
description: 'Build and deploy workshop'

inputs:
  flavour:
    description: type of version to release
    required: true
    default: 'minor'

outputs:
  tag_name:
    description: name of tag created by bumpversion
    value: ${{ steps.bumpversion.outputs.tag_name }}

runs:
  using: "composite"
  steps:
    - name: Bumpversion and commit
      id: bumpversion
      shell: bash
      run: ./.github/ci/do_release -t ${{ inputs.flavour }}

    - name: Build Site
      shell: bash
      run: ./.github/ci/build_site -b ${{ steps.bumpversion.outputs.base_url }} -t ${{ steps.bumpversion.outputs.tag_name }}

    - name: Build Site
      shell: bash
      env:
        TAG: ${{ steps.bumpversion.outputs.base_url }}
      run: |
        publish_dir=$(realpath './site/v${{ steps.bumpversion.outputs.tag_name }}')
        remote=${{ github.repositoryUrl }}
        prepDir=$(mktemp -d)

        git clone --depth=1 --single-branch --branch gh-pages ${remote} ${prepDir}
        git config user.name "${GITHUB_ACTOR}"
        git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"

        cd $prepDir
        git rm -r --ignore-unmatch '*'

        mkdir $TAG
        ln -s $TAG latest
        git add latest

        cd $TAG
        cp -RfL "${publish_dir}/*" "${publish_dir}/.*" "${prep_dir}/${TAG}"
        git add --all .

        git remote rm origin || true
        git remote add origin ${pages_remote}
        git commit -m "Docs: Releasing $TAG"
        git push origin gh-pages

    - name: Deploy
      uses: peaceiris/actions-gh-pages@v3
      if: github.ref == 'refs/heads/master' && (inputs.flavour == 'minor' || inputs.flavour == 'major')
      with:
        github_token: ${{ github.token }}
        publish_dir: './site/v${{ steps.bumpversion.outputs.tag_name }}'
        destination_dir: 'v${{ steps.bumpversion.outputs.tag_name }}'
        commit_message: 'Docs: Releasing ${{ steps.bumpversion.outputs.tag_name }}'
