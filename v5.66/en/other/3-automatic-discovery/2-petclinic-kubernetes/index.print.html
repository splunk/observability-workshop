<!doctype html><html lang=en dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.125.5"><meta name=generator content="Relearn 6.1.1+tip"><meta name=description content="Learn how to enable automatic discovery and configuration for your Java-based application running in Kubernetes. Experience real-time monitoring to help you maximize application behavior with end-to-end visibility."><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Spring PetClinic SpringBoot Based Microservices On Kubernetes :: Splunk Observability Cloud Workshops"><meta name=twitter:description content="Learn how to enable automatic discovery and configuration for your Java-based application running in Kubernetes. Experience real-time monitoring to help you maximize application behavior with end-to-end visibility."><meta property="og:url" content="https://splunk.github.io/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/index.html"><meta property="og:site_name" content="Splunk Observability Cloud Workshops"><meta property="og:title" content="Spring PetClinic SpringBoot Based Microservices On Kubernetes :: Splunk Observability Cloud Workshops"><meta property="og:description" content="Learn how to enable automatic discovery and configuration for your Java-based application running in Kubernetes. Experience real-time monitoring to help you maximize application behavior with end-to-end visibility."><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta itemprop=name content="Spring PetClinic SpringBoot Based Microservices On Kubernetes :: Splunk Observability Cloud Workshops"><meta itemprop=description content="Learn how to enable automatic discovery and configuration for your Java-based application running in Kubernetes. Experience real-time monitoring to help you maximize application behavior with end-to-end visibility."><meta itemprop=dateModified content="2024-08-20T15:53:10+01:00"><meta itemprop=wordCount content="143"><title>Spring PetClinic SpringBoot Based Microservices On Kubernetes :: Splunk Observability Cloud Workshops</title>
<link href=https://splunk.github.io/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/index.html rel=canonical type=text/html title="Spring PetClinic SpringBoot Based Microservices On Kubernetes :: Splunk Observability Cloud Workshops"><link href=/observability-workshop/v5.66/images/favicon.ico?1725879471 rel=icon type=image/x-icon sizes=any><link href=/observability-workshop/v5.66/css/fontawesome-all.min.css?1725879471 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v5.66/css/fontawesome-all.min.css?1725879471 rel=stylesheet></noscript><link href=/observability-workshop/v5.66/css/nucleus.css?1725879471 rel=stylesheet><link href=/observability-workshop/v5.66/css/auto-complete.css?1725879471 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v5.66/css/auto-complete.css?1725879471 rel=stylesheet></noscript><link href=/observability-workshop/v5.66/css/perfect-scrollbar.min.css?1725879471 rel=stylesheet><link href=/observability-workshop/v5.66/css/fonts.css?1725879471 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v5.66/css/fonts.css?1725879471 rel=stylesheet></noscript><link href=/observability-workshop/v5.66/css/theme.css?1725879471 rel=stylesheet><link href=/observability-workshop/v5.66/css/theme-splunk-light.css?1725879471 rel=stylesheet id=R-variant-style><link href=/observability-workshop/v5.66/css/chroma-relearn-light.css?1725879471 rel=stylesheet id=R-variant-chroma-style><link href=/observability-workshop/v5.66/css/variant.css?1725879471 rel=stylesheet><link href=/observability-workshop/v5.66/css/print.css?1725879471 rel=stylesheet media=print><link href=/observability-workshop/v5.66/css/format-print.css?1725879471 rel=stylesheet><script src=/observability-workshop/v5.66/js/variant.js?1725879471></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../../../..",window.relearn.relBaseUri="../../../../../..",window.relearn.absBaseUri="https://splunk.github.io/observability-workshop/v5.66",window.index_js_url="/observability-workshop/v5.66/en/index.search.js?1725879471",window.variants&&variants.init(["splunk-light","splunk-dark"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js crossorigin=anonymous></script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web-session-recorder.js crossorigin=anonymous></script><script>SplunkRum.init({realm:"us1",rumAccessToken:"dp3FKraOS_wVhe-l7eCOsA",applicationName:"observability-workshop",deploymentEnvironment:"splunk.github.io",version:"1.0"}),SplunkSessionRecorder.init({app:"observability-workshop",realm:"us1",rumAccessToken:"dp3FKraOS_wVhe-l7eCOsA"})</script></script><style>:root{--MAIN-WIDTH-MAX:130rem;--MENU-WIDTH-L:23rem}</style></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v5.66/en/index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v5.66/en/other/index.html><span itemprop=name>Ninja Workshops</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v5.66/en/other/3-automatic-discovery/index.html><span itemprop=name>Automatic Discovery Workshops</span></a><meta itemprop=position content="3">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>PetClinic Kubernetes Workshop</span><meta itemprop=position content="4"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v5.66/en/other/3-automatic-discovery/1-petclinic-monolith/5-log-observer/index.html title="4. Log Observer (ü°ê)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/1-architecture/index.html title="Architecture (ü°í)"><i class="fa-fw fas fa-chevron-right"></i></a></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable chapter narrow" tabindex=-1><div class=flex-block-wrapper><article class=chapter><header class=headline></header><h1 id=spring-petclinic-springboot-based-microservices-on-kubernetes>Spring PetClinic SpringBoot Based Microservices On Kubernetes</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>90 minutes</span>
</span>&nbsp;
<span class="badge cstyle blue badge-with-title"><span class=badge-title class=text-muted>Author
</span><span class=badge-content>Pieter Hagen</span></span><p>The goal of this workshop is to introduce the features of Splunk&rsquo;s <strong>automatic discovery and configuration</strong> for Java.</p><p>The workshop scenario will be created by installing a simple (<strong>un-instrumented</strong>) Java microservices application in Kubernetes.</p><p>By following the simple steps to install the Splunk OpenTelemetry Collector and enabling automatic discovery and configuration for existing Java based deployments you will learn how easy it is to send metrics, traces and logs to <strong>Splunk Observability Cloud</strong>.</p><div class="box notices cstyle primary"><div class=box-label><i class="fa-fw fas fa-info"></i> Prerequisites</div><div class=box-content><ul><li>Outbound SSH access to port <strong>2222</strong>.</li><li>Outbound HTTP access to port <strong>81</strong>.</li><li>Familiarity with the Linux command line.</li></ul></div></div><p>During this workshop we will cover the following components:</p><ul><li>Splunk Infrastructure Monitoring (<strong>IM</strong>)</li><li>Splunk automatic discovery and configuration for Java (<strong>APM</strong>)<ul><li>Database Query Performance</li><li>AlwaysOn Profiling</li></ul></li><li>Splunk Log Observer (<strong>LO</strong>)</li><li>Splunk Real User Monitoring (<strong>RUM</strong>)</li></ul><p><em>Splunk Synthetics is feeling a little left out here, but we cover that in other workshops</em> <i class="fa-fw fas fa-heart"></i></p><footer class=footline><span class="badge cstyle blue badge-with-title"><span class=badge-title class=text-muted>Author
</span><span class=badge-content>Pieter Hagen
</span></span>&nbsp;
<span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><section><h1 class=a11y-only>Subsections of Spring PetClinic SpringBoot Based Microservices On Kubernetes</h1><article class=default><header class=headline></header><h1 id=architecture>Architecture</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>5 minutes</span>
</span>&nbsp;<p>The diagram below details the architecture of the Spring PetClinic Java application running in Kubernetes with the Splunk OpenTelemetry Operator and automatic discovery and configuration enabled.</p><p>The Spring PetClinic Java application is a simple microservices application that consists of a frontend and backend services. The frontend service is a Spring Boot application that serves a web interface to interact with the backend services. The backend services are Spring Boot applications that serve RESTful API&rsquo;s to interact with a MySQL database.</p><p>By the end of this workshop, you will have a better understanding of how to enable <strong>automatic discovery and configuration</strong> for your Java-based applications running in Kubernetes.</p><p><a href=#R-image-147cffc43b7221736f0b38736a31557f class=lightbox-link><img alt="Splunk Otel Architecture" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/1-architecture/../images/auto-instrumentation-java-diagram.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-147cffc43b7221736f0b38736a31557f><img alt="Splunk Otel Architecture" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/1-architecture/../images/auto-instrumentation-java-diagram.png></a></p><hr><p>Based on the <a href=https://github.com/signalfx/splunk-otel-collector-chart/blob/main/examples/enable-operator-and-auto-instrumentation/spring-petclinic-java.md rel=external target=_blank><strong>example</strong></a> <strong>Josh Voravong</strong> has created.</p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><article class=chapter><header class=headline></header><h1 id=preparation-of-the-workshop-instance>Preparation of the Workshop instance</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>15 minutes</span>
</span>&nbsp;<p>The instructor will provide you with the login information for the instance that we will be using during the workshop.</p><p>When you first log into your instance, you will be greeted by the Splunk Logo as shown below. If you have any issues connecting to your workshop instance then please reach out to your Instructor.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ ssh -p 2222 splunk@&lt;ip-address&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó    ‚ñà‚ñà‚ïó  
</span></span><span class=line><span class=cl>‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ñà‚ñà‚ïî‚ïù    ‚ïö‚ñà‚ñà‚ïó 
</span></span><span class=line><span class=cl>‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù      ‚ïö‚ñà‚ñà‚ïó
</span></span><span class=line><span class=cl>‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ñà‚ñà‚ïó      ‚ñà‚ñà‚ïî‚ïù
</span></span><span class=line><span class=cl>‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïó    ‚ñà‚ñà‚ïî‚ïù 
</span></span><span class=line><span class=cl>‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù    ‚ïö‚ïê‚ïù  
</span></span><span class=line><span class=cl>Last login: Mon Feb  5 11:04:54 2024 from [Redacted]
</span></span><span class=line><span class=cl>Waiting for cloud-init status...
</span></span><span class=line><span class=cl>Your instance is ready!
</span></span><span class=line><span class=cl>splunk@show-no-config-i-0d1b29d967cb2e6ff:~$ </span></span></code></pre></div><p>To ensure your instance is configured correctly, we need to confirm that the required environment variables for this workshop are set correctly. In your terminal run the following script and check that the environment variables are present and set with actual valid values:</p><div class=tab-panel data-tab-group=3583389425004baae3a9dd43baff671a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3583389425004baae3a9dd43baff671a","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("3583389425004baae3a9dd43baff671a","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ~/workshop/petclinic/scripts/check_env.sh</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>ACCESS_TOKEN</span> <span class=o>=</span> &lt;redacted&gt;
</span></span><span class=line><span class=cl><span class=nv>REALM</span> <span class=o>=</span> &lt;e.g. eu0, us1, us2, jp0, au0 etc.&gt;
</span></span><span class=line><span class=cl><span class=nv>RUM_TOKEN</span> <span class=o>=</span> &lt;redacted&gt;
</span></span><span class=line><span class=cl><span class=nv>HEC_TOKEN</span> <span class=o>=</span> &lt;redacted&gt;
</span></span><span class=line><span class=cl><span class=nv>HEC_URL</span> <span class=o>=</span> https://&lt;...&gt;/services/collector/event
</span></span><span class=line><span class=cl><span class=nv>INSTANCE</span> <span class=o>=</span> &lt;instance_name&gt;</span></span></code></pre></div></div></div></div></div><p>Please make a note of the <code>INSTANCE</code> environment variable value as this will used later to filter data in <strong>Splunk Observability Cloud</strong>.</p><p>For this workshop, <strong>all</strong> of the above are required. If any have values missing, please contact your Instructor.</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Delete any existing OpenTelemetry Collectors</div><div class=box-content><p>If you have previously completed a Splunk Observability workshop using this EC2 instance, you need to ensure that any existing installation of the Splunk OpenTelemetry Collector is deleted. This can be achieved by running the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm delete splunk-otel-collector</span></span></code></pre></div></div></div><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><section><h1 class=a11y-only>Subsections of Preparation of the Workshop instance</h1><article class=default><header class=headline></header><h1 id=deploy-the-splunk-opentelemetry-collector>Deploy the Splunk OpenTelemetry Collector</h1><p>To get Observability signals (<strong>metrics, traces</strong> and <strong>logs</strong>) into <strong>Splunk Observability Cloud</strong> the Splunk OpenTelemetry Collector needs to be deployed into the Kubernetes cluster.</p><p>For this workshop, we will be using the Splunk OpenTelemetry Collector Helm Chart. First we need to add the Helm chart repository to Helm and update to ensure the latest version:</p><div class=tab-panel data-tab-group=5f9b02eaa0c2c88188169235165592a4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=install-helm-chart class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5f9b02eaa0c2c88188169235165592a4","install-helm-chart")'>
<span class=tab-nav-text>Install Helm Chart</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("5f9b02eaa0c2c88188169235165592a4","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=install-helm-chart class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm repo add splunk-otel-collector-chart https://signalfx.github.io/splunk-otel-collector-chart <span class=o>&amp;&amp;</span> helm repo update</span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Using ACCESS_TOKEN={REDACTED}
</span></span><span class=line><span class=cl>Using REALM=eu0
</span></span><span class=line><span class=cl>&#34;splunk-otel-collector-chart&#34; has been added to your repositories
</span></span><span class=line><span class=cl>Using ACCESS_TOKEN={REDACTED}
</span></span><span class=line><span class=cl>Using REALM=eu0
</span></span><span class=line><span class=cl>Hang tight while we grab the latest from your chart repositories...
</span></span><span class=line><span class=cl>...Successfully got an update from the &#34;splunk-otel-collector-chart&#34; chart repository
</span></span><span class=line><span class=cl>Update Complete. ‚éàHappy Helming!‚éà</span></span></code></pre></div></div></div></div></div><p><strong>Splunk Observability Cloud</strong> offers wizards in the UI to walk you through the setup of the OpenTelemetry Collector on Kubernetes, but in the interest of time, we will use the Helm install command below. Additional parameters are set to enable the operator and automatic discovery and configuration.</p><ul><li><code>--set="operator.enabled=true"</code> - this will install the Opentelemetry operator that will be used to handle automatic discovery and configuration.</li><li><code>--set="certmanager.enabled=true"</code> - this will install the required certificate manager for the operator.</li><li><code>--set="splunkObservability.profilingEnabled=true"</code> - this enables Code Profiling via the operator.</li></ul><p>To install the collector run the following command, do <strong>NOT</strong> edit this:</p><div class=tab-panel data-tab-group=db9c0071e80f9072fad9ec2a69708273><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=helm-install class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("db9c0071e80f9072fad9ec2a69708273","helm-install")'>
<span class=tab-nav-text>Helm Install</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("db9c0071e80f9072fad9ec2a69708273","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=helm-install class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm install splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;operator.enabled=true&#34;</span>, <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;certmanager.enabled=true&#34;</span>, <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.realm=</span><span class=nv>$REALM</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.accessToken=</span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;clusterName=</span><span class=nv>$INSTANCE</span><span class=s2>-k3s-cluster&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.logsEnabled=false&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;logsEngine=otel&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.profilingEnabled=true&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.infrastructureMonitoringEventsEnabled=true&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;environment=</span><span class=nv>$INSTANCE</span><span class=s2>-workshop&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkPlatform.endpoint=</span><span class=nv>$HEC_URL</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkPlatform.token=</span><span class=nv>$HEC_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkPlatform.index=splunk4rookies-workshop&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>splunk-otel-collector-chart/splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-f ~/workshop/k3s/otel-collector.yaml</span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>LAST DEPLOYED: Fri Apr 19 09:39:54 2024
</span></span><span class=line><span class=cl>NAMESPACE: default
</span></span><span class=line><span class=cl>STATUS: deployed
</span></span><span class=line><span class=cl>REVISION: 1
</span></span><span class=line><span class=cl>NOTES:
</span></span><span class=line><span class=cl>Splunk OpenTelemetry Collector is installed and configured to send data to Splunk Platform endpoint &#34;https://http-inputs-o11y-workshop-eu0.splunkcloud.com:443/services/collector/event&#34;.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Splunk OpenTelemetry Collector is installed and configured to send data to Splunk Observability realm eu0.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[INFO] You&#39;ve enabled the operator&#39;s auto-instrumentation feature (operator.enabled=true), currently considered ALPHA.
</span></span><span class=line><span class=cl>  - Instrumentation library maturity varies (e.g., Java is more mature than Go). For library stability, visit: https://opentelemetry.io/docs/instrumentation/#status-and-releases
</span></span><span class=line><span class=cl>  - Some libraries may be enabled by default. For current status, see: https://github.com/open-telemetry/opentelemetry-operator#controlling-instrumentation-capabilities
</span></span><span class=line><span class=cl>  - Splunk provides best-effort support for native OpenTelemetry libraries, and full support for Splunk library distributions. For used libraries, refer to the values.yaml under &#34;operator.instrumentation.spec&#34;.</span></span></code></pre></div></div></div></div></div><p>Ensure the Pods are reported as <strong>Running</strong> before continuing (this typically takes around 30 seconds).</p><div class=tab-panel data-tab-group=ac5a240a071921ee99d2f8c3551309f4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=kubectl-get-pods class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ac5a240a071921ee99d2f8c3551309f4","kubectl-get-pods")'>
<span class=tab-nav-text>kubectl get pods</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("ac5a240a071921ee99d2f8c3551309f4","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=kubectl-get-pods class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pods <span class=p>|</span> grep splunk-otel </span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>splunk-otel-collector-certmanager-cainjector-5c5dc4ff8f-95z49   1/1     Running   0          10m
</span></span><span class=line><span class=cl>splunk-otel-collector-certmanager-6d95596898-vjxss              1/1     Running   0          10m
</span></span><span class=line><span class=cl>splunk-otel-collector-certmanager-webhook-69f4ff754c-nghxz      1/1     Running   0          10m
</span></span><span class=line><span class=cl>splunk-otel-collector-k8s-cluster-receiver-6bd5567d95-5f8cj     1/1     Running   0          10m
</span></span><span class=line><span class=cl>splunk-otel-collector-agent-tspd2                               1/1     Running   0          10m
</span></span><span class=line><span class=cl>splunk-otel-collector-operator-69d476cb7-j7zwd                  2/2     Running   0          10m</span></span></code></pre></div></div></div></div></div><p>Ensure there are no errors reported by the Splunk OpenTelemetry Collector (press <code>ctrl + c</code> to exit) or use the installed <strong>awesome</strong> <code>k9s</code> terminal UI for bonus points!</p><div class=tab-panel data-tab-group=2a32b087f8347ec5deb85636679d7cbf><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=kubectl-logs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2a32b087f8347ec5deb85636679d7cbf","kubectl-logs")'>
<span class=tab-nav-text>kubectl logs</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("2a32b087f8347ec5deb85636679d7cbf","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=kubectl-logs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl logs -l <span class=nv>app</span><span class=o>=</span>splunk-otel-collector -f --container otel-collector</span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>2021-03-21T16:11:10.900Z        INFO    service/service.go:364  Starting receivers...
</span></span><span class=line><span class=cl>2021-03-21T16:11:10.900Z        INFO    builder/receivers_builder.go:70 Receiver is starting... {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;prometheus&#34;, &#34;component_name&#34;: &#34;prometheus&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    builder/receivers_builder.go:75 Receiver started.       {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;prometheus&#34;, &#34;component_name&#34;: &#34;prometheus&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    builder/receivers_builder.go:70 Receiver is starting... {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    k8sclusterreceiver@v0.21.0/watcher.go:195       Configured Kubernetes MetadataExporter  {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;, &#34;exporter_name&#34;: &#34;signalfx&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    builder/receivers_builder.go:75 Receiver started.       {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    healthcheck/handler.go:128      Health Check state change       {&#34;component_kind&#34;: &#34;extension&#34;, &#34;component_type&#34;: &#34;health_check&#34;, &#34;component_name&#34;: &#34;health_check&#34;, &#34;status&#34;: &#34;ready&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    service/service.go:267  Everything is ready. Begin running and processing data.
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    k8sclusterreceiver@v0.21.0/receiver.go:59       Starting shared informers and wait for initial cache sync.      {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.281Z        INFO    k8sclusterreceiver@v0.21.0/receiver.go:75       Completed syncing shared informer caches.       {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;}</span></span></code></pre></div></div></div></div></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Deleting a failed installation</div><div class=box-content><p>If you make an error installing the OpenTelemetry Collector you can start over by deleting the installation with the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>helm delete splunk-otel-collector</span></span></code></pre></div></div></div><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=deploy-the-petclinic-application>Deploy the PetClinic Application</h1><p>The first deployment of our application will be using prebuilt containers to give us the base scenario: a regular Java microservices-based application running in Kubernetes that we want to start observing. So let&rsquo;s deploy our application:</p><div class=tab-panel data-tab-group=2e09867fa8bfd21ecca9e43a4c899bf0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=kubectl-apply class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2e09867fa8bfd21ecca9e43a4c899bf0","kubectl-apply")'>
<span class=tab-nav-text>kubectl apply</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("2e09867fa8bfd21ecca9e43a4c899bf0","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=kubectl-apply class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f ~/workshop/petclinic/petclinic-deploy.yaml</span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>deployment.apps/config-server created
</span></span><span class=line><span class=cl>service/config-server created
</span></span><span class=line><span class=cl>deployment.apps/discovery-server created
</span></span><span class=line><span class=cl>service/discovery-server created
</span></span><span class=line><span class=cl>deployment.apps/api-gateway created
</span></span><span class=line><span class=cl>service/api-gateway created
</span></span><span class=line><span class=cl>service/api-gateway-external created
</span></span><span class=line><span class=cl>deployment.apps/customers-service created
</span></span><span class=line><span class=cl>service/customers-service created
</span></span><span class=line><span class=cl>deployment.apps/vets-service created
</span></span><span class=line><span class=cl>service/vets-service created
</span></span><span class=line><span class=cl>deployment.apps/visits-service created
</span></span><span class=line><span class=cl>service/visits-service created
</span></span><span class=line><span class=cl>deployment.apps/admin-server created
</span></span><span class=line><span class=cl>service/admin-server created
</span></span><span class=line><span class=cl>service/petclinic-db created
</span></span><span class=line><span class=cl>deployment.apps/petclinic-db created
</span></span><span class=line><span class=cl>configmap/petclinic-db-initdb-config created
</span></span><span class=line><span class=cl>deployment.apps/petclinic-loadgen-deployment created
</span></span><span class=line><span class=cl>configmap/scriptfile created</span></span></code></pre></div></div></div></div></div><p>At this point, we can verify the deployment by checking if the Pods are running. The containers need to be downloaded and started so this may take a couple of minutes.</p><div class=tab-panel data-tab-group=520e74645e2486d982c0ae2de8fab9c1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=kubectl-get-pods class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("520e74645e2486d982c0ae2de8fab9c1","kubectl-get-pods")'>
<span class=tab-nav-text>kubectl get pods</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("520e74645e2486d982c0ae2de8fab9c1","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=kubectl-get-pods class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pods</span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>NAME                                                            READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>splunk-otel-collector-certmanager-dc744986b-z2gzw               1/1     Running   0          114s
</span></span><span class=line><span class=cl>splunk-otel-collector-certmanager-cainjector-69546b87d6-d2fz2   1/1     Running   0          114s
</span></span><span class=line><span class=cl>splunk-otel-collector-certmanager-webhook-78b59ffc88-r2j8x      1/1     Running   0          114s
</span></span><span class=line><span class=cl>splunk-otel-collector-k8s-cluster-receiver-655dcd9b6b-dcvkb     1/1     Running   0          114s
</span></span><span class=line><span class=cl>splunk-otel-collector-agent-dg2vj                               1/1     Running   0          114s
</span></span><span class=line><span class=cl>splunk-otel-collector-operator-57cbb8d7b4-dk5wf                 2/2     Running   0          114s
</span></span><span class=line><span class=cl>petclinic-db-64d998bb66-2vzpn                                   1/1     Running   0          58s
</span></span><span class=line><span class=cl>api-gateway-d88bc765-jd5lg                                      1/1     Running   0          58s
</span></span><span class=line><span class=cl>visits-service-7f97b6c579-bh9zj                                 1/1     Running   0          58s
</span></span><span class=line><span class=cl>admin-server-76d8b956c5-mb2zv                                   1/1     Running   0          58s
</span></span><span class=line><span class=cl>customers-service-847db99f79-mzlg2                              1/1     Running   0          58s
</span></span><span class=line><span class=cl>vets-service-7bdcd7dd6d-2tcfd                                   1/1     Running   0          58s
</span></span><span class=line><span class=cl>petclinic-loadgen-deployment-5d69d7f4dd-xxkn4                   1/1     Running   0          58s
</span></span><span class=line><span class=cl>config-server-67f7876d48-qrsr5                                  1/1     Running   0          58s
</span></span><span class=line><span class=cl>discovery-server-554b45cfb-bqhgt                                1/1     Running   0          58s</span></span></code></pre></div></div></div></div></div><p>Make sure the output of <code>kubectl get pods</code> matches the output as shown above. Ensure all the services are shown as <strong>Running</strong> (or use <code>k9s</code> to contuuously monitor the status).</p><p>Once they are running, the application will take a few minutes to fully start up, create the database and synchronize all the services, so let&rsquo;s use the time to check the local private repository is active.</p><h4 id=verify-the-local-private-registry>Verify the local Private Registry</h4><p>Later on, when we test our <strong>automatic discovery and configuration</strong> we are going to build new containers to highlight some of the additional features of Splunk Observability Cloud.</p><p>As configuration files and source code will be changed, the containers will need to be built and stored in a local private registry (which has already been enabled for you).</p><p>To check if the private registry is avaiable, run the following command (this will return an empty list):</p><div class=tab-panel data-tab-group=05f1aed24a94d9823404ed1998f05026><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=check-the-local-private-registry class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("05f1aed24a94d9823404ed1998f05026","check-the-local-private-registry")'>
<span class=tab-nav-text>Check the local Private Registry</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("05f1aed24a94d9823404ed1998f05026","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=check-the-local-private-registry class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -X GET http://localhost:9999/v2/_catalog</span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>**{&#34;repositories&#34;:[]}**</span></span></code></pre></div></div></div></div></div><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=verify-kubernetes-cluster-metrics>Verify Kubernetes Cluster metrics</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<p>Once the installation has been completed, you can log in to <strong>Splunk Observability Cloud</strong> and verify that the metrics are flowing in from your Kubernetes cluster.</p><p>From the left-hand menu click on <strong>Infrastructure</strong> <a href=#R-image-d59c0edc42b067744302689703504d14 class=lightbox-link><img alt=infra class="noborder inline lazy lightbox noshadow figure-image" loading=lazy src="/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/3-verify-setup/../images/infra-icon.png?classes=inline&height=25px" style=height:25px;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d59c0edc42b067744302689703504d14><img alt=infra class="noborder inline lazy lightbox noshadow lightbox-image" loading=lazy src="/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/3-verify-setup/../images/infra-icon.png?classes=inline&height=25px"></a> and select <strong>Kubernetes</strong>, then select the <strong>Kubernetes nodes</strong> pane. Once you are in the <strong>Kubernetes nodes</strong> view, change the <strong>Time</strong> filter from <strong>-4h</strong> to the last 15 minutes <strong>(-15m)</strong> to focus on the latest data.</p><p>Next, click <strong>Add filters</strong> (next to the <strong>Time filter</strong>) and add the filter <code>k8s.cluster.name</code> <strong>(1)</strong>. Type or select the cluster name of your workshop instance (you can get the unique part from your cluster name by using the <code>INSTANCE</code> from the output from the shell script you ran earlier). You can also select your cluster by clicking on its image in the cluster pane. You will now only have your cluster visible <strong>(2)</strong>.</p><p><a href=#R-image-4a5bd76d8639e926ba3b2e89154bdb5e class=lightbox-link><img alt=Navigator class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/3-verify-setup/../images/navigator.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-4a5bd76d8639e926ba3b2e89154bdb5e><img alt=Navigator class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/3-verify-setup/../images/navigator.png></a></p><p>Scroll down the page to see the metrics coming in from your cluster. Locate the <strong>Node log events rate</strong> chart and click on a vertical bar to see the log entries coming in from your cluster.</p><p><a href=#R-image-879624279071bee10eabdd85108dbb0f class=lightbox-link><img alt=logs class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/3-verify-setup/../images/k8s-peek-at-logs.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-879624279071bee10eabdd85108dbb0f><img alt=logs class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/3-verify-setup/../images/k8s-peek-at-logs.png></a></p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><section><h1 class=a11y-only>Subsections of Verify Kubernetes Cluster metrics</h1><article class=default><header class=headline></header><h1 id=verify-the-petclinic-website>Verify the PetClinic Website</h1><p>To test the application you need to obtain the public IP address of the instance you are running on. You can do this by running the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://ifconfig.me</span></span></code></pre></div><p>You can validate if the application is running by visiting <strong>http://&lt;IP_ADDRESS>:81</strong> (replace <strong>&lt;IP_ADDRESS></strong> with the IP address you obtained above). You should see the PetClinic application running.</p><p><a href=#R-image-fe7c759dc453dfe5ab96b17eef54180a class=lightbox-link><img alt="Pet shop" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/3-verify-setup/1-website/../../images/petclinic.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-fe7c759dc453dfe5ab96b17eef54180a><img alt="Pet shop" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/3-verify-setup/1-website/../../images/petclinic.png></a></p><p>Make sure the application is working correctly by visiting the <strong>All Owners</strong> <strong>(1)</strong> and <strong>Veterinarians</strong> <strong>(2)</strong> tabs, you should get a list of names in each case.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>As each service needs to start up and synchronize with the database, it may take a few minutes for the application to fully start up.</p></div></div><p><a href=#R-image-107e033c03dbfba47c6a6695f8c6becd class=lightbox-link><img alt=owners class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/3-verify-setup/1-website/../../images/petclinic-owners.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-107e033c03dbfba47c6a6695f8c6becd><img alt=owners class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/3-verify-setup/1-website/../../images/petclinic-owners.png></a></p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><article class=chapter><header class=headline></header><h1 id=2-section-break>2. Section Break</h1><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=setting-up-automatic-discovery-and-configuration-for-apm>Setting up automatic discovery and configuration for APM</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<p>In this section we will enable <strong>automatic discovery and configuration</strong> for the Java services running in Kubernetes. This means that the OpenTelemetry Collector will look for Pod annotations that indicate that the Java application should be instrumented with the Splunk OpenTelemetry Java agent. This will allow us to get traces, spans, and profiling data from the Java services running on the cluster.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> automatic discovery and configuration</div><div class=box-content><p>It is important to understand that automatic discovery and configuration is designed to get <strong>trace, span & profiling</strong> data out of your application, without requiring code changes or recompilation.</p><p>This is a great way to get started with APM, but it is <strong>not</strong> a replacement for manual instrumentation. Manual instrumentation allows you to add custom spans, tags, and logs to your application, which can provide more context and detail to your traces.</p></div></div><p>For Java applications the OpenTelemetry Collector will look for the annotation <code>instrumentation.opentelemetry.io/inject-java</code>.</p><p>The annotation can have the value set <code>true</code> or to the <code>namespace/daemonset</code> of the OpenTelemetry Collector e.g. <code>default/splunk-otel-collector</code>. This allows working across namespaces and what we will use in this workshop.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Using the deployment.yaml</div><div class=box-content><p>If you want your Pods to send traces automatically, you can add the annotation to the <code>deployment.yaml</code> as shown below. This will add the instrumentation library during the initial deployment. To speed things up we have done that for the following Pods:</p><ul><li><strong>admin-server</strong></li><li><strong>config-server</strong></li><li><strong>discovery-server</strong></li></ul><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>admin-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/part-of</span><span class=p>:</span><span class=w> </span><span class=l>spring-petclinic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>admin-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>admin-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>instrumentation.opentelemetry.io/inject-java</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;default/splunk-otel-collector&#34;</span></span></span></code></pre></div></div></div><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><section><h1 class=a11y-only>Subsections of Setting up automatic discovery and configuration for APM</h1><article class=default><header class=headline></header><h1 id=patching-the-deployment>Patching the Deployment</h1><p>To configure <strong>automatic discovery and configuration</strong> the deployments need to be patched to add the instrumentation annotation. Once patched, the OpenTelemetry Collector will inject the automatic discovery and configuration library and the Pods will be restarted in order to start sending traces and profiling data. First, confirm that the <code>api-gateway</code> does not have the <code>splunk-otel-java</code> image.</p><div class=tab-panel data-tab-group=bfb512aee3fa57391f4b01bd9f56fb3c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=describe-api-gateway class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("bfb512aee3fa57391f4b01bd9f56fb3c","describe-api-gateway")'>
<span class=tab-nav-text>Describe api-gateway</span>
</button>
<button data-tab-item=describe-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("bfb512aee3fa57391f4b01bd9f56fb3c","describe-output")'>
<span class=tab-nav-text>Describe Output</span></button></div><div class=tab-content-container><div data-tab-item=describe-api-gateway class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe pods api-gateway <span class=p>|</span> grep Image:</span></span></code></pre></div></div></div><div data-tab-item=describe-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Image:         quay.io/phagen/spring-petclinic-api-gateway:0.0.2</span></span></code></pre></div></div></div></div></div><p>Next, enable the Java automatic discovery and configuration for all of the services by adding the annotation to the deployments. The following command will patch the all deployments. This will trigger the OpenTelemetry Operator to inject the <code>splunk-otel-java</code> image into the Pods:</p><div class=tab-panel data-tab-group=9e2d8ef0b79cd66d4889f4397f3dc2f3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=patch-all-petclinic-services class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9e2d8ef0b79cd66d4889f4397f3dc2f3","patch-all-petclinic-services")'>
<span class=tab-nav-text>Patch all PetClinic services</span>
</button>
<button data-tab-item=patch-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("9e2d8ef0b79cd66d4889f4397f3dc2f3","patch-output")'>
<span class=tab-nav-text>Patch Output</span></button></div><div class=tab-content-container><div data-tab-item=patch-all-petclinic-services class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get deployments -l app.kubernetes.io/part-of<span class=o>=</span>spring-petclinic -o name <span class=p>|</span> xargs -I % kubectl patch % -p <span class=s2>&#34;{\&#34;spec\&#34;: {\&#34;template\&#34;:{\&#34;metadata\&#34;:{\&#34;annotations\&#34;:{\&#34;instrumentation.opentelemetry.io/inject-java\&#34;:\&#34;default/splunk-otel-collector\&#34;}}}}}&#34;</span></span></span></code></pre></div></div></div><div data-tab-item=patch-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>deployment.apps/config-server patched (no change)
</span></span><span class=line><span class=cl>deployment.apps/admin-server patched (no change)
</span></span><span class=line><span class=cl>deployment.apps/customers-service patched
</span></span><span class=line><span class=cl>deployment.apps/visits-service patched
</span></span><span class=line><span class=cl>deployment.apps/discovery-server patched (no change)
</span></span><span class=line><span class=cl>deployment.apps/vets-service patched
</span></span><span class=line><span class=cl>deployment.apps/api-gateway patched</span></span></code></pre></div></div></div></div></div><p>There will be no change for the <strong>config-server</strong>, <strong>discovery-server</strong> and <strong>admin-server</strong> as these have already been patched.</p><p>To check the container image(s) of the <code>api-gateway</code> pod again, run the following command:</p><div class=tab-panel data-tab-group=0a08c4fc154ab5eb624cb5d968665cb3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=describe-api-gateway class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0a08c4fc154ab5eb624cb5d968665cb3","describe-api-gateway")'>
<span class=tab-nav-text>Describe api-gateway</span>
</button>
<button data-tab-item=describe-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("0a08c4fc154ab5eb624cb5d968665cb3","describe-output")'>
<span class=tab-nav-text>Describe Output</span></button></div><div class=tab-content-container><div data-tab-item=describe-api-gateway class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe pods api-gateway <span class=p>|</span> grep Image:</span></span></code></pre></div></div></div><div data-tab-item=describe-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Image:         ghcr.io/signalfx/splunk-otel-java/splunk-otel-java:v1.30.0
</span></span><span class=line><span class=cl>Image:         quay.io/phagen/spring-petclinic-api-gateway:0.0.2</span></span></code></pre></div></div></div></div></div><p>A new image has been added to the <code>api-gateway</code> which will pull <code>splunk-otel-java</code> from <code>ghcr.io</code> (if you see two <code>api-gateway</code> containers, the original one is probably still terminating, so give it a few seconds).</p><p>Navigate back to the Kubernetes Navigator in <strong>Splunk Observability Cloud</strong>. After a couple of minutes you will see that the Pods are being restarted by the operator and the automatic discovery and configuration container will be added. This will look similar to the screenshot below:</p><p><a href=#R-image-59356946d752b105cc738f826b7105e1 class=lightbox-link><img alt=restart class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/4-apm/1-patching-deployment/../../images/k8s-navigator-restarted-pods.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-59356946d752b105cc738f826b7105e1><img alt=restart class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/4-apm/1-patching-deployment/../../images/k8s-navigator-restarted-pods.png></a></p><p>Wait for the Pods to turn green in the Kubernetes Navigator, then go tho the next section.</p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=viewing-the-data-in-splunk-apm>Viewing the data in Splunk APM</h1><p>Log in to Splunk Observability Cloud, from the left-hand menu click on <strong>APM</strong> <a href=#R-image-60015ffabece9765d85223a6ba6bdd4a class=lightbox-link><img alt=APM class="noborder inline lazy lightbox noshadow figure-image" loading=lazy src="/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/4-apm/2-apm-data/../../images/apm-icon.png?classes=inline&height=25px" style=height:25px;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-60015ffabece9765d85223a6ba6bdd4a><img alt=APM class="noborder inline lazy lightbox noshadow lightbox-image" loading=lazy src="/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/4-apm/2-apm-data/../../images/apm-icon.png?classes=inline&height=25px"></a> to see the data generated by the traces from the newly instrumented services. Change the <strong>Environment</strong> filter <strong>(1)</strong> to the name of your workshop instance in the dropdown box (this will be <strong><code>&lt;INSTANCE>-workshop</code></strong> where <strong><code>INSTANCE</code></strong> is the value from the shell script you ran earlier) and make sure it is the only one selected.</p><p><a href=#R-image-ebe53d5c546ec59be0ee7b16d8f6e1db class=lightbox-link><img alt=apm class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/4-apm/2-apm-data/../../images/zero-config-first-services-overview.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ebe53d5c546ec59be0ee7b16d8f6e1db><img alt=apm class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/4-apm/2-apm-data/../../images/zero-config-first-services-overview.png></a></p><p>You will see the name <strong>(2)</strong> of the <strong>api-gateway</strong> service and metrics in the Latency and Request & Errors charts (you can ignore the Critical Alert, as it is caused by the sudden request increase generated by the load generator). You will also see the rest of the services appear.</p><p>Once you see the Customer service, Vets service and Visits services like show in the screenshot above, let&rsquo;s click on the <strong>Service Map</strong> <strong>(3)</strong> pane to get ready for the next section.</p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><article class=chapter><header class=headline></header><h1 id=3-section-break>3. Section Break</h1><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article></section><article class=chapter><header class=headline></header><h1 id=apm-features>APM Features</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>15 minutes</span>
</span>&nbsp;<p>As we have seen in the previous section, once you enable <strong>automatic discovery and configuration</strong> on your services, traces are sent to <strong>Splunk Observability Cloud</strong>.</p><p>With these traces, Splunk will automatically generate <strong>Service Maps</strong> and <strong>RED Metrics</strong>. These are the first steps in understanding the behavior of your services and how they interact with each other.</p><p>In this next section, we are going to examine the traces themselves and what information they provide to help you understand the behavior of your services all without touching your code.</p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><section><h1 class=a11y-only>Subsections of APM Features</h1><article class=default><header class=headline></header><h1 id=apm-service-map>APM Service Map</h1><p><a href=#R-image-12b502d8cce9de626f891f626f6372da class=lightbox-link><img alt="apm map" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/5-traces/1-service-map/../../images/zero-config-first-services-map.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-12b502d8cce9de626f891f626f6372da><img alt="apm map" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/5-traces/1-service-map/../../images/zero-config-first-services-map.png></a></p><p>The above map shows all the interactions between all of the services. The map may still be in an interim state as it will take the Petclinic Microservice application a few minutes to start up and fully synchronize. Reducing the time filter to a custom time of <strong>2 minutes</strong> will help. The initial startup-related errors (red dots) will eventually disappear.</p><p>Next, let&rsquo;s examine the metrics that are available for each service that is instrumented and visit the request, error, and duration (RED) metrics Dashboard</p><p>For this exercise we are going to use a common scenario you would use if the service operation was showing high latency, or errors for example.</p><p>Select (click) on the <strong>Customer Service</strong> in the Dependency map <strong>(1)</strong>, then make sure the <code>customers-service</code> is selected in the <strong>Services</strong> dropdown box <strong>(2)</strong>. Next, select <code>GET /Owners</code> from the Operations dropdown <strong>(3</strong>)**.</p><p>This should give you the workflow with a filter on <code>GET /owners</code> <strong>(1)</strong> as shown below.</p><p><a href=#R-image-ea0edf364ddfcb494063d5d01849b41f class=lightbox-link><img alt="select a trace" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/5-traces/1-service-map/../../images/select-workflow.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ea0edf364ddfcb494063d5d01849b41f><img alt="select a trace" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/5-traces/1-service-map/../../images/select-workflow.png></a></p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=apm-trace>APM Trace</h1><p>To pick a trace, select a line in the <code>Service Requests & Errors</code> chart <strong>(2)</strong>, when the dot appears click to get a list of sample traces:</p><p>Once you have the list of sample traces, click on the blue <strong>(3)</strong> Trace ID Link (make sure it has the same three services mentioned in the Service Column.)</p><p><a href=#R-image-59db3e025561717b693d833850d02ff5 class=lightbox-link><img alt=workflow-trace-pick class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/5-traces/2-trace/../../images/selecting-a-trace.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-59db3e025561717b693d833850d02ff5><img alt=workflow-trace-pick class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/5-traces/2-trace/../../images/selecting-a-trace.png></a></p><p>This brings us the the Trace selected in the Waterfall view:</p><p>Here we find several sections:</p><ul><li>The actual Waterfall Pane <strong>(1)</strong>, where you see the trace and all the instrumented functions visible as spans, with their duration representation and order/relationship showing.</li><li>The Trace Info Pane <strong>(2)</strong>, by default, shows the selected Span information (highlighted with a box around the Span in the Waterfall Pane).</li><li>The Span Pane <strong>(3)</strong>, here you can find all the Tags that have been sent in the selected Span, You can scroll down to see all of them.</li><li>The process Pane, with tags related to the process that created the Span (scroll down to see as it is not in the screenshot).</li><li>The Trace Properties at the top of the right-hand pane by default is collapsed as shown.</li></ul><p><a href=#R-image-e2ec4f4ed1e3ae5cb49a0996a028d4cc class=lightbox-link><img alt=waterfall class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/5-traces/2-trace/../../images/waterfall-view.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e2ec4f4ed1e3ae5cb49a0996a028d4cc><img alt=waterfall class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/5-traces/2-trace/../../images/waterfall-view.png></a></p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=apm-span>APM Span</h1><p>While we examine our spans, let&rsquo;s look at several features that you get out of the box without code modifications when using <strong>automatic discovery and configuration</strong> on top of tracing:</p><p>Due to the fact there are several different routes
First, in the Waterfall Pane, make sure the <code>customers-service:SELECT petclinic.owners</code> or similar span is selected as shown in the screenshot below:</p><p><a href=#R-image-5812058cc12005ce023e6b4698eb9598 class=lightbox-link><img alt=DB-query class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/5-traces/3-spans/../../images/db-query.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5812058cc12005ce023e6b4698eb9598><img alt=DB-query class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/5-traces/3-spans/../../images/db-query.png></a></p><ul><li>The basic latency information is shown as a bar for the instrumented function or call, in our example, it took 6.3 Milliseconds.</li><li>Several similar Spans <strong>(1)</strong>, are only visible if the span is repeated multiple times. In this case, there are 10 repeats in our example. (You can show/hide them all by clicking on the <code>10x</code> and all spans will show in order)</li><li><strong>Inferred Services</strong>: Calls made to external systems that are not instrumented, show up as a grey &lsquo;inferred&rsquo; span. The Inferred Service or span in our case here is a call to the Mysql Database <code>mysql:petclinic SELECT petclinic</code> <strong>(2)</strong> as shown above our selected span.</li><li><strong>Span Tags</strong>: In the Tag Pane, standard tags produced by the automatic discovery and configuration. In this case, the span is calling a Database, so it includes the <code>db.statement</code> tag <strong>(3)</strong>. This tag will hold the DB query statement and is used by the Database call performed during this span. This will be used by the DB-Query Performance feature. We look at DB-Query Performance in the next section.</li><li><strong>Always-on Profiling</strong>: <strong>IF</strong> the system is configured to and has captured Profiling data during a Span life cycle, it will show the number of Call Stacks captured in the Spans timeline (15 Call Stacks for the <code>customers-service:SELECT petclinic.owners</code> Span shown above).</li></ul><p>We will look at Profiling in the next section.</p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=service-centric-view>Service Centric View</h1><p>Splunk APM provide <strong>Service Centric Views</strong> that provide engineers a deep understanding of service performance in one centralized view. Now, across every service, engineers can quickly identify errors or bottlenecks from a service‚Äôs underlying infrastructure, pinpoint performance degradations from new deployments, and visualize the health of every third party dependency.</p><p>To see this dashboard for the <code>api-gateway</code>, make sure you have the <code>api-gateway</code> service selected in the Service Map, then click on the *<strong>View Service</strong> button in the top of the right-hand pane. This will bring you to the Service Centric View dashboard:</p><p>This view, which is available for each of your instrumented services, offers an overview of <strong>Service metrics</strong>, <strong>Runtime metrics</strong> and <strong>Infrastructure metrics</strong>.</p><p>You can select the *<em>Back</em> function of you browser to go back to the previous view.</p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><article class=chapter><header class=headline></header><h1 id=5-section-break>5. Section Break</h1><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article></section><article class=chapter><header class=headline></header><h1 id=always-on-profiling--db-query-performance>Always-On Profiling & DB Query Performance</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>15 minutes</span>
</span>&nbsp;<p>As we have seen in the previous chapter, you can trace your interactions between the various services using APM without touching your code, which will allow you to identify issues faster.</p><p>However, besides tracing <strong>automatic discovery and configuration</strong> offers additional features out of the box that can help you find issues even faster. In this section we are going to look at two of them:</p><ul><li><strong>Always-on Profiling and Java Metrics</strong></li><li><strong>Database Query Performance</strong></li></ul><p>If you want to dive deeper into Always-on Profiling or DB-Query performance, we have a separate Ninja Workshop called <a href=/observability-workshop/v5.66/en/scenarios/debug_problems/index.html><strong>Debug Problems in Microservices</strong></a> that you can follow.</p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><section><h1 class=a11y-only>Subsections of Always-On Profiling & DB Query Performance</h1><article class=default><header class=headline></header><h1 id=always-on-profiling--metrics>Always-On Profiling & Metrics</h1><p>When we installed the Splunk Distribution of the OpenTelemetry Collector using the Helm chart earlier, we configured it to enable <strong>AlwaysOn Profiling</strong> and <strong>Metrics</strong>. This means that the collector will automatically generate CPU and Memory profiles for the application and send them to Splunk Observability Cloud.</p><p>When you deploy the PetClinic application and set the annotation, the collector automatically detects the application and instruments it for traces and profiling. We can verify this by examining the startup logs of one of the Java containers we are instrumenting by running the following script:</p><p>The logs should show what flags were picked up by the Java automatic discovery and configuration:</p><p><div class=tab-panel data-tab-group=3aee804e0d7b105f8c30bb98d7a2d9ec><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=run-the-script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3aee804e0d7b105f8c30bb98d7a2d9ec","run-the-script")'>
<span class=tab-nav-text>Run the script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("3aee804e0d7b105f8c30bb98d7a2d9ec","example-output")'>
<span class=tab-nav-text>Example output</span></button></div><div class=tab-content-container><div data-tab-item=run-the-script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0><code class=language-logs data-lang=logs>.  ~/workshop/petclinic/scripts/get_logs.sh</code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>2024/02/15 09:42:00 Problem with dial: dial tcp 10.43.104.25:8761: connect: connection refused. Sleeping 1s
</span></span><span class=line><span class=cl>2024/02/15 09:42:01 Problem with dial: dial tcp 10.43.104.25:8761: connect: connection refused. Sleeping 1s
</span></span><span class=line><span class=cl>2024/02/15 09:42:02 Connected to tcp://discovery-server:8761
</span></span><span class=line><span class=cl>Picked up JAVA_TOOL_OPTIONS:  -javaagent:/otel-auto-instrumentation-java/javaagent.jar
</span></span><span class=line><span class=cl>Picked up _JAVA_OPTIONS: -Dspring.profiles.active=docker,mysql -Dsplunk.profiler.call.stack.interval=150
</span></span><span class=line><span class=cl>OpenJDK 64-Bit Server VM warning: Sharing is only supported for boot loader classes because bootstrap classpath has been appended
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:03:056 +0000] [main] INFO io.opentelemetry.javaagent.tooling.VersionLogger - opentelemetry-javaagent - version: splunk-1.30.1-otel-1.32.1
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:03:768 +0000] [main] INFO com.splunk.javaagent.shaded.io.micrometer.core.instrument.push.PushMeterRegistry - publishing metrics for SignalFxMeterRegistry every 30s
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:478 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger - -----------------------
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:478 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger - Profiler configuration:
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:480 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -                  splunk.profiler.enabled : true
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:505 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -                splunk.profiler.directory : /tmp
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:505 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -       splunk.profiler.recording.duration : 20s
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:506 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -               splunk.profiler.keep-files : false
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:510 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -            splunk.profiler.logs-endpoint : http://10.13.2.38:4317
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:513 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -              otel.exporter.otlp.endpoint : http://10.13.2.38:4317
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:513 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -           splunk.profiler.memory.enabled : true
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:515 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -             splunk.profiler.tlab.enabled : true
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:516 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -        splunk.profiler.memory.event.rate : 150/s
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:516 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -      splunk.profiler.call.stack.interval : PT0.15S
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:517 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -  splunk.profiler.include.internal.stacks : false
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:517 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -      splunk.profiler.tracing.stacks.only : false
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:517 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger - -----------------------
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:518 +0000] [main] INFO com.splunk.opentelemetry.profiler.JfrActivator - Profiler is active.</span></span></code></pre></div></div></div></div></div>We are interested in the section written by the <code>com.splunk.opentelemetry.profiler.ConfigurationLogger</code> or the <strong>Profiling Configuration</strong>.</p><p>We can see the various settings you can control, some that are useful depending on your use case like the <code>splunk.profiler.directory</code> - The location where the agent writes the call stacks before sending them to Splunk. This may be different depending on how you configure your containers.</p><p>Another parameter you may want to change is <code>splunk.profiler.call.stack.interval</code> This is how often the system takes a CPU Stack trace. You may want to reduce this if you have short spans like we have in our application. (we kept the default as the spans in this demo application are extremely short, so Span may not always have a CPU Call Stack related to it.)</p><p>You can find how to set these parameters <a href=https://docs.splunk.com/observability/en/gdi/get-data-in/application/java/configuration/advanced-java-otel-configuration.html#profiling-configuration-java rel=external target=_blank>here</a>. Below, is how you set a higher collection rate for call stack in your <code>deployment.yaml</code>, exactly how to pass any JAVA option to the Java application running in your container:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>env</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>JAVA_OPTIONS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;-Xdebug -Dsplunk.profiler.call.stack.interval=150&#34;</span></span></span></code></pre></div><p>If you don&rsquo;t see those lines as a result of the script, the startup may have taken too long and generated too many connection errors, try looking at the logs directly with <code>kubectl</code> or the <code>k9s</code> utility that is installed.</p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=always-on-profiling-in-the-trace-waterfall>Always-On Profiling in the Trace Waterfall</h1><p>Make sure you have your original (or similar) Trace & Span <strong>(1)</strong> selected in the APM Waterfall view and select <strong>Memory Stack Traces (2)</strong> from the right-hand pane:</p><p><a href=#R-image-41d38f7e05269ecdeec083f1ba079603 class=lightbox-link><img alt="profiling from span" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/6-profiling-db-query/2-waterfall/../../images/flamechart-in-waterfall.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-41d38f7e05269ecdeec083f1ba079603><img alt="profiling from span" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/6-profiling-db-query/2-waterfall/../../images/flamechart-in-waterfall.png></a></p><p>The pane should show you the Memory Stack Trace Flame Graph <strong>(3)</strong>, you can scroll down and/or make the pane for a better view by dragging the right side of the pane.</p><p>As AlwaysOn Profiling is constantly taking snapshots, or stack traces, of your application‚Äôs code and reading through thousands of stack traces is not practical, AlwaysOn Profiling aggregates and summarizes profiling data, providing a convenient way to explore Call Stacks in a view called the <strong>Flame Graph</strong>. It represents a summary of all stack traces captured from your application. You can use the Flame Graph to discover which lines of code might be causing performance issues and to confirm whether the changes you make to the code have the intended effect.</p><p>To dive deeper into the Always-on Profiling, select Span <strong>(3)</strong> in the Profiling Pane under <strong>Memory Stack Traces</strong>
This will bring you to the Always-on Profiling main screen, with the Memory view pre-selected:</p><p><a href=#R-image-c72c62c51e022dff85ddbffb2dd4cb86 class=lightbox-link><img alt="Profiling main" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/6-profiling-db-query/2-waterfall/../../images/profiling-memory.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c72c62c51e022dff85ddbffb2dd4cb86><img alt="Profiling main" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/6-profiling-db-query/2-waterfall/../../images/profiling-memory.png></a></p><ul><li>Java Memory Metric Charts <strong>(1)</strong>, Allow you to <code>Monitor Heap Memory, Application Activity</code> like <code>Memory Allocation Rate</code> and <code>Garbage Collecting</code> Metrics.</li><li>Ability to focus/see metrics and Stack Traces only related to the Span <strong>(2)</strong>, This will filter out background activities running in the Java application if required.</li><li>Java Function calls identified. <strong>(3)</strong>, allowing you to drill down into the Methods called from that function.</li><li>The Flame Graph <strong>(4)</strong>, with the visualization of hierarchy based on the stack traces of the profiled service.</li></ul><p>For further investigation the UI let&rsquo;s you grab the actual stack trace, so you can use in your coding platform to go to the actual lines of code used at this point (depending of course on your preferred Coding platform)</p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=database-query-performance>Database Query Performance</h1><p>With Database Query Performance, you can monitor the impact of your database queries on service availability directly in Splunk APM. This way, you can quickly identify long-running, unoptimized, or heavy queries and mitigate issues they might be causing, without having to instrument your databases.</p><p>To look at the performance of your database queries, make sure you are on the APM <strong>Explore</strong> page either by going back in the browser or navigating to the APM section in the Menu bar, then click on the <strong>Explore</strong> tile.
Select the inferred database service <code>mysql:petclinic</code> Inferred Database server in the Dependency map <strong>(1)</strong>, then scroll the right-hand pane to find the <strong>Database Query Performance</strong> Pane <strong>(2)</strong>.</p><p><a href=#R-image-5cf39a47a4923a56c0235d0780444deb class=lightbox-link><img alt="DB-query from map" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/6-profiling-db-query/3-dbquery/../../images/db-query-map.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5cf39a47a4923a56c0235d0780444deb><img alt="DB-query from map" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/6-profiling-db-query/3-dbquery/../../images/db-query-map.png></a></p><p>If the service you have selected in the map is indeed an (inferred) database server, this pane will populate with the top 90% (P90) database calls based on duration. To dive deeper into the db-query performance function click somewhere on the word <strong>Database Query Performance</strong> at the top of the pane.</p><p>This will bring us to the DB-query Performance overview screen:</p><p><a href=#R-image-afc4a6ca1808217f24f295ec4f23d9e0 class=lightbox-link><img alt="DB-query full" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/6-profiling-db-query/3-dbquery/../../images/db-query-full.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-afc4a6ca1808217f24f295ec4f23d9e0><img alt="DB-query full" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/6-profiling-db-query/3-dbquery/../../images/db-query-full.png></a></p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Database Query Normalization</div><div class=box-content><p>By default, Splunk APM instrumentation sanitizes database queries to remove or mask sensible data, such as secrets or personally identifiable information (PII) from the <code>db.statements</code>. You can find how to turn off database query normalization <a href=https://docs.splunk.com/observability/en/apm/db-query-perf/db-perf-troubleshooting.html#turn-off-database-query-normalization rel=external target=_blank>here</a>.</p></div></div><p>This screen will show us all the Database queries <strong>(1)</strong> done towards our database from your application, based on the Traces & Spans sent to the Splunk Observability Cloud. Note that you can compare them across a time block or sort them on Total Time, P90 Latency & Requests <strong>(2)</strong>.</p><p>For each Database query in the list, we see the highest latency, the total number of calls during the time window and the number of requests per second <strong>(3)</strong>. This allows you to identify places where you might optimize your queries.</p><p>You can select traces containing Database Calls via the two charts in the right-hand pane <strong>(5)</strong>. Use the Tag Spotlight pane <strong>(6)</strong> to drill down what tags are related to the database calls, based on endpoints or tags.</p><p>If you click on a specific Query <strong>(1)</strong> you get a detailed query Details pane appears <strong>(2)</strong>, which you can use for more detailed investigations:
<a href=#R-image-e33506f7c8f9ba39b10d118903099823 class=lightbox-link><img alt=details class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/6-profiling-db-query/3-dbquery/../../images/query-details.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e33506f7c8f9ba39b10d118903099823><img alt=details class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/6-profiling-db-query/3-dbquery/../../images/query-details.png></a></p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><article class=chapter><header class=headline></header><h1 id=4-section-break>4. Section Break</h1><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article></section><article class=chapter><header class=headline></header><h1 id=log-observer>Log Observer</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<p>Up until this point, there have been no code changes, yet tracing, profiling and Database Query Performance data is being sent to Splunk Observability Cloud.</p><p>Next we will add the <strong>Splunk Log Observer</strong> to the mix to obtain log data from the Spring PetClinic application.</p><p>This change will update the configuration of <a href=https://logback.qos.ch/ rel=external target=_blank><strong>logback</strong></a> in the Spring PetClinic application. This will allow the automatic discovery and configuration to add OpenTelemetry relevant information into the logs.</p><p>The <strong>Splunk Log Observer</strong> is then used to view the logs and with the changes to the log format the platform can automatically correlate log information with services and traces.</p><p>This feature is called <a href=https://docs.splunk.com/observability/en/metrics-and-metadata/relatedcontent.html rel=external target=_blank><strong>Related Content</strong></a>.</p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><section><h1 class=a11y-only>Subsections of Log Observer</h1><article class=default><header class=headline></header><h1 id=configuring-logback>Configuring Logback</h1><p>First, clone the PetClinic GitHub repository, as we will need this later in the workshop to compile, build, package and containerize the application:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~ <span class=o>&amp;&amp;</span> git clone https://github.com/hagen-p/spring-petclinic-microservices.git</span></span></code></pre></div><p>Then change into the <code>spring-petclinic-microservices</code> directory:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/spring-petclinic-microservices</span></span></code></pre></div><p>The Spring PetClinic application can be configured to use several different Java logging libraries. In this scenario, the application is using <code>logback</code>. To make sure we get the OpenTelemetry information in the logs we need to update a file named <code>logback.xml</code> with the log structure and add an OpenTelemetry dependency to the <code>pom.xml</code> of each of the services in the PetClinic microservices folders.</p><p>First, let&rsquo;s set the Log Structure/Format. SpringBoot will allow you to set a global template, but for ease of use, we will replace the existing content of the <code>logback-spring.xml</code> files of each service with the following XML content using a prepared script.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>The following entries will be added:</p><ul><li><strong>trace_id</strong></li><li><strong>span_id</strong></li><li><strong>trace_flags</strong></li><li><strong>service.name</strong></li><li><strong>deployment.environment</strong></li></ul></div></div><p>These fields allow the <strong>Splunk Observability Cloud</strong> to display <strong>Related Content</strong> when using the log pattern shown below:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;pattern&gt;</span>
</span></span><span class=line><span class=cl>  logback: %d{HH:mm:ss.SSS} [%thread] severity=%-5level %logger{36} - trace_id=%X{trace_id} span_id=%X{span_id} service.name=%property{otel.resource.service.name} trace_flags=%X{trace_flags} - %msg %kvp{DOUBLE}%n
</span></span><span class=line><span class=cl><span class=nt>&lt;/pattern&gt;</span></span></span></code></pre></div><p>The following script will update the <code>logback-spring.xml</code> for all of the services with the log structure in the format above:</p><div class=tab-panel data-tab-group=2e0c7f3258ecaccf28ebc87b45e8f2cf><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=update-logback-files class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2e0c7f3258ecaccf28ebc87b45e8f2cf","update-logback-files")'>
<span class=tab-nav-text>Update Logback files</span>
</button>
<button data-tab-item=replace-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("2e0c7f3258ecaccf28ebc87b45e8f2cf","replace-output")'>
<span class=tab-nav-text>Replace Output</span></button></div><div class=tab-content-container><div data-tab-item=update-logback-files class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ~/workshop/petclinic/scripts/update_logback.sh</span></span></code></pre></div></div></div><div data-tab-item=replace-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Overwritten /home/splunk/spring-petclinic-microservices/spring-petclinic-admin-server/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Overwritten /home/splunk/spring-petclinic-microservices/spring-petclinic-api-gateway/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Overwritten /home/splunk/spring-petclinic-microservices/spring-petclinic-config-server/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Overwritten /home/splunk/spring-petclinic-microservices/spring-petclinic-customers-service/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Overwritten /home/splunk/spring-petclinic-microservices/spring-petclinic-discovery-server/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Overwritten /home/splunk/spring-petclinic-microservices/spring-petclinic-vets-service/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Overwritten /home/splunk/spring-petclinic-microservices/spring-petclinic-visits-service/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Script execution completed.</span></span></code></pre></div></div></div></div></div><p>We can verify if the replacement has been successful by examining the <code>logback-spring.xml</code> file from one of the services:</p><div class=tab-panel data-tab-group=187978e5696c18696b0723b9ad772c4c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=cat-logback-springxml class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("187978e5696c18696b0723b9ad772c4c","cat-logback-springxml")'>
<span class=tab-nav-text>cat logback-spring.xml</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("187978e5696c18696b0723b9ad772c4c","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=cat-logback-springxml class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat /home/splunk/spring-petclinic-microservices/spring-petclinic-customers-service/src/main/resources/logback-spring.xml</span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
</span></span><span class=line><span class=cl>&lt;configuration&gt;
</span></span><span class=line><span class=cl>    &lt;appender name=&#34;console&#34; class=&#34;ch.qos.logback.core.ConsoleAppender&#34;&gt;
</span></span><span class=line><span class=cl>        &lt;encoder&gt;
</span></span><span class=line><span class=cl>            &lt;pattern&gt;
</span></span><span class=line><span class=cl>                logback: %d{HH:mm:ss.SSS} [%thread] severity=%-5level %logger{36} - trace_id=%X{trace_id} span_id=%X{span_id} service.name=%property{otel.resource.service.name} trace_flags=%X{trace_flags} - %msg %kvp{DOUBLE}%n
</span></span><span class=line><span class=cl>            &lt;/pattern&gt;
</span></span><span class=line><span class=cl>        &lt;/encoder&gt;
</span></span><span class=line><span class=cl>    &lt;/appender&gt;
</span></span><span class=line><span class=cl>    &lt;appender name=&#34;OpenTelemetry&#34;
</span></span><span class=line><span class=cl>              class=&#34;io.opentelemetry.instrumentation.logback.appender.v1_0.OpenTelemetryAppender&#34;&gt;
</span></span><span class=line><span class=cl>        &lt;captureExperimentalAttributes&gt;true&lt;/captureExperimentalAttributes&gt;
</span></span><span class=line><span class=cl>        &lt;captureKeyValuePairAttributes&gt;true&lt;/captureKeyValuePairAttributes&gt;
</span></span><span class=line><span class=cl>    &lt;/appender&gt;
</span></span><span class=line><span class=cl>    &lt;root level=&#34;INFO&#34;&gt;
</span></span><span class=line><span class=cl>        &lt;appender-ref ref=&#34;console&#34;/&gt;
</span></span><span class=line><span class=cl>        &lt;appender-ref ref=&#34;OpenTelemetry&#34;/&gt;
</span></span><span class=line><span class=cl>    &lt;/root&gt;
</span></span><span class=line><span class=cl>&lt;/configuration&gt;</span></span></code></pre></div></div></div></div></div><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=rebuild-petclinic>Rebuild PetClinic</h1><p>Before we can build the new services with the updated log format we need to add the OpenTelemetry dependency that handles field injection to the <code>pom.xml</code> of our services:<div class=tab-panel data-tab-group=624db6f5540d992553dd9f262353fe99><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=adding-otel-dependencies class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("624db6f5540d992553dd9f262353fe99","adding-otel-dependencies")'>
<span class=tab-nav-text>Adding OTel dependencies</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("624db6f5540d992553dd9f262353fe99","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=adding-otel-dependencies class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ~/workshop/petclinic/scripts/add_otel.sh</span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Dependencies added successfully in spring-petclinic-admin-server
</span></span><span class=line><span class=cl>Dependencies added successfully in spring-petclinic-api-gateway
</span></span><span class=line><span class=cl>Dependencies added successfully in spring-petclinic-config-server
</span></span><span class=line><span class=cl>Dependencies added successfully in spring-petclinic-discovery-server
</span></span><span class=line><span class=cl>Dependencies added successfully in spring-petclinic-customers-service
</span></span><span class=line><span class=cl>Dependencies added successfully in spring-petclinic-vets-service
</span></span><span class=line><span class=cl>Dependencies added successfully in spring-petclinic-visits-service
</span></span><span class=line><span class=cl>Dependency addition complete!</span></span></code></pre></div></div></div></div></div></p><p>The Services are now ready to be built, so run the script that will use the <code>maven</code> command to compile/build/package the PetClinic microservices:</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>Note the <code>-P buildDocker</code>, this will build the new containers and take 3-5 minutes to complete.</p></div></div><div class=tab-panel data-tab-group=d79247233d7e3a66525c1b48393bd07c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=running-maven class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d79247233d7e3a66525c1b48393bd07c","running-maven")'>
<span class=tab-nav-text>Running maven</span>
</button>
<button data-tab-item=maven-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("d79247233d7e3a66525c1b48393bd07c","maven-output")'>
<span class=tab-nav-text>Maven Output</span></button></div><div class=tab-content-container><div data-tab-item=running-maven class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./mvnw clean install -D skipTests -P buildDocker</span></span></code></pre></div></div></div><div data-tab-item=maven-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>Successfully tagged quay.io/phagen/spring-petclinic-api-gateway:latest
</span></span><span class=line><span class=cl>[INFO] Built quay.io/phagen/spring-petclinic-api-gateway
</span></span><span class=line><span class=cl>[INFO] ------------------------------------------------------------------------
</span></span><span class=line><span class=cl>[INFO] Reactor Summary:
</span></span><span class=line><span class=cl>[INFO] 
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-microservices 0.0.1 ............... SUCCESS [  0.770 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-admin-server ...................... SUCCESS [01:03 min]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-customers-service ................. SUCCESS [ 29.031 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-vets-service ...................... SUCCESS [ 22.145 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-visits-service .................... SUCCESS [ 20.451 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-config-server ..................... SUCCESS [ 12.260 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-discovery-server .................. SUCCESS [ 14.174 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-api-gateway 0.0.1 ................. SUCCESS [ 29.832 s]
</span></span><span class=line><span class=cl>[INFO] ------------------------------------------------------------------------
</span></span><span class=line><span class=cl>[INFO] BUILD SUCCESS
</span></span><span class=line><span class=cl>[INFO] ------------------------------------------------------------------------
</span></span><span class=line><span class=cl>[INFO] Total time: 03:14 min
</span></span><span class=line><span class=cl>[INFO] Finished at: 2024-01-02T12:43:20Z
</span></span><span class=line><span class=cl>[INFO] ------------------------------------------------------------------------</span></span></code></pre></div></div></div></div></div><p>Given that Kubernetes needs to pull these freshly built images from somewhere, we are going to store them in the repository we tested earlier. To do this, run the script that will push the newly built containers into our local repository:</p><div class=tab-panel data-tab-group=41a1576eb0eb4d8fa2204bbdfa219ffb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=pushing-containers class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("41a1576eb0eb4d8fa2204bbdfa219ffb","pushing-containers")'>
<span class=tab-nav-text>pushing Containers</span>
</button>
<button data-tab-item=docker-push-output-partial class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("41a1576eb0eb4d8fa2204bbdfa219ffb","docker-push-output-partial")'>
<span class=tab-nav-text>Docker Push Output (partial)</span></button></div><div class=tab-content-container><div data-tab-item=pushing-containers class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ~/workshop/petclinic/scripts/push_docker.sh </span></span></code></pre></div></div></div><div data-tab-item=docker-push-output-partial class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>The push refers to repository [localhost:5000/spring-petclinic-vets-service]
</span></span><span class=line><span class=cl>0391386bcb2a: Preparing
</span></span><span class=line><span class=cl>bbb67f51a186: Preparing
</span></span><span class=line><span class=cl>105351d0ada3: Preparing
</span></span><span class=line><span class=cl>49cfeae6cb9f: Preparing
</span></span><span class=line><span class=cl>b4da5101fcde: Preparing
</span></span><span class=line><span class=cl>49cfeae6cb9f: Pushed
</span></span><span class=line><span class=cl>e742c14be110: Mounted from spring-petclinic-visits-service
</span></span><span class=line><span class=cl>540aa741fede: Mounted from spring-petclinic-visits-service
</span></span><span class=line><span class=cl>a1dfe59d4939: Mounted from spring-petclinic-visits-service
</span></span><span class=line><span class=cl>1e99e92c46bf: Mounted from spring-petclinic-visits-service
</span></span><span class=line><span class=cl>f5aa38537736: Mounted from spring-petclinic-visits-service
</span></span><span class=line><span class=cl>d2210512edb4: Mounted from spring-petclinic-visits-service
</span></span><span class=line><span class=cl>8e87ff28f1b5: Mounted from spring-petclinic-visits-service
</span></span><span class=line><span class=cl>local: digest: sha256:42337b2a4ff7d0ac9b7c2cf3c70aa20b7b52d092f1e05d351e031dd7fad956fc size: 3040
</span></span><span class=line><span class=cl>The push refers to repository [localhost:5000/spring-petclinic-customers-service]
</span></span><span class=line><span class=cl>15d54d9adca8: Preparing
</span></span><span class=line><span class=cl>886f6def5b35: Preparing
</span></span><span class=line><span class=cl>1575ae90e858: Preparing
</span></span><span class=line><span class=cl>ccc884d92d18: Preparing
</span></span><span class=line><span class=cl>b4da5101fcde: Preparing
</span></span><span class=line><span class=cl>ccc884d92d18: Pushed
</span></span><span class=line><span class=cl>e742c14be110: Mounted from spring-petclinic-vets-service
</span></span><span class=line><span class=cl>540aa741fede: Mounted from spring-petclinic-vets-service
</span></span><span class=line><span class=cl>a1dfe59d4939: Mounted from spring-petclinic-vets-service
</span></span><span class=line><span class=cl>1e99e92c46bf: Mounted from spring-petclinic-vets-service
</span></span><span class=line><span class=cl>f5aa38537736: Mounted from spring-petclinic-vets-service
</span></span><span class=line><span class=cl>d2210512edb4: Mounted from spring-petclinic-vets-service
</span></span><span class=line><span class=cl>8e87ff28f1b5: Mounted from spring-petclinic-vets-service
</span></span><span class=line><span class=cl>local: digest: sha256:3601c6e7f58224001946058fb0400483fbb8f1b0ea8a6dbaf403c62b4c1908be size: 3042</span></span></code></pre></div></div></div></div></div><p>The containers should now be stored in the local repository, let&rsquo;s confirm by checking the catalog:</p><div class=tab-panel data-tab-group=818fea16de436cf6bf5ee8c0190ad310><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=check-catalog class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("818fea16de436cf6bf5ee8c0190ad310","check-catalog")'>
<span class=tab-nav-text>Check Catalog</span>
</button>
<button data-tab-item=catalog-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("818fea16de436cf6bf5ee8c0190ad310","catalog-output")'>
<span class=tab-nav-text>Catalog Output</span></button></div><div class=tab-content-container><div data-tab-item=check-catalog class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -X GET http://localhost:9999/v2/_catalog</span></span></code></pre></div></div></div><div data-tab-item=catalog-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;repositories&#34;</span><span class=p>:[</span><span class=s2>&#34;spring-petclinic-admin-server&#34;</span><span class=p>,</span><span class=s2>&#34;spring-petclinic-api-gateway&#34;</span><span class=p>,</span><span class=s2>&#34;spring-petclinic-config-server&#34;</span><span class=p>,</span><span class=s2>&#34;spring-petclinic-customers-service&#34;</span><span class=p>,</span><span class=s2>&#34;spring-petclinic-discovery-server&#34;</span><span class=p>,</span><span class=s2>&#34;spring-petclinic-vets-service&#34;</span><span class=p>,</span><span class=s2>&#34;spring-petclinic-visits-service&#34;</span><span class=p>]}</span></span></span></code></pre></div></div></div></div></div><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=deploy-to-kubernetes>Deploy to Kubernetes</h1><p>To see the changes in effect, we need to redeploy the services, First, let&rsquo;s change the location of the images from the external repo to the local one by running the following script:</p><div class=tab-panel data-tab-group=7a7134bca31fc49c61b5c924700a17dd><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=change-deployment-to-local-containers class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7a7134bca31fc49c61b5c924700a17dd","change-deployment-to-local-containers")'>
<span class=tab-nav-text>Change deployment to local containers</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("7a7134bca31fc49c61b5c924700a17dd","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=change-deployment-to-local-containers class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ~/workshop/petclinic/scripts/set_local.sh</span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Script execution completed. Modified content saved to /home/splunk/workshop/petclinic/petclinic-local.yaml</span></span></code></pre></div></div></div></div></div><p>The result is a new file on disk called <code>petclinic-local.yaml</code>. Switch to the local versions by using the new version of the deployment YAML. First delete the old containers from the original deployment with:</p><div class=tab-panel data-tab-group=7f18fbc9300d8986d367808d8bbc26aa><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=deleting-remote-petclinic-services class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7f18fbc9300d8986d367808d8bbc26aa","deleting-remote-petclinic-services")'>
<span class=tab-nav-text>Deleting remote Petclinic services</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("7f18fbc9300d8986d367808d8bbc26aa","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=deleting-remote-petclinic-services class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl delete -f ~/workshop/petclinic/petclinic-deploy.yaml</span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>deployment.apps &#34;config-server&#34; deleted
</span></span><span class=line><span class=cl>service &#34;config-server&#34; deleted
</span></span><span class=line><span class=cl>deployment.apps &#34;discovery-server&#34; deleted
</span></span><span class=line><span class=cl>service &#34;discovery-server&#34; deleted
</span></span><span class=line><span class=cl>deployment.apps &#34;api-gateway&#34; deleted
</span></span><span class=line><span class=cl>service &#34;api-gateway&#34; deleted
</span></span><span class=line><span class=cl>service &#34;api-gateway-external&#34; deleted
</span></span><span class=line><span class=cl>deployment.apps &#34;customers-service&#34; deleted
</span></span><span class=line><span class=cl>service &#34;customers-service&#34; deleted
</span></span><span class=line><span class=cl>deployment.apps &#34;vets-service&#34; deleted
</span></span><span class=line><span class=cl>service &#34;vets-service&#34; deleted
</span></span><span class=line><span class=cl>deployment.apps &#34;visits-service&#34; deleted
</span></span><span class=line><span class=cl>service &#34;visits-service&#34; deleted
</span></span><span class=line><span class=cl>deployment.apps &#34;admin-server&#34; deleted
</span></span><span class=line><span class=cl>service &#34;admin-server&#34; deleted
</span></span><span class=line><span class=cl>service &#34;petclinic-db&#34; deleted
</span></span><span class=line><span class=cl>deployment.apps &#34;petclinic-db&#34; deleted
</span></span><span class=line><span class=cl>configmap &#34;petclinic-db-initdb-config&#34; deleted
</span></span><span class=line><span class=cl>deployment.apps &#34;petclinic-loadgen-deployment&#34; deleted
</span></span><span class=line><span class=cl>configmap &#34;scriptfile&#34; deleted</span></span></code></pre></div></div></div></div></div><p>followed by:</p><div class=tab-panel data-tab-group=3385763a5832f74cb569e6ec2bcc7dc0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=starting-local-petclinic--services class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3385763a5832f74cb569e6ec2bcc7dc0","starting-local-petclinic--services")'>
<span class=tab-nav-text>Starting local Petclinic services</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("3385763a5832f74cb569e6ec2bcc7dc0","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=starting-local-petclinic--services class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f ~/workshop/petclinic/petclinic-local.yaml</span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>deployment.apps/config-server created
</span></span><span class=line><span class=cl>service/config-server created
</span></span><span class=line><span class=cl>deployment.apps/discovery-server created
</span></span><span class=line><span class=cl>service/discovery-server created
</span></span><span class=line><span class=cl>deployment.apps/api-gateway created
</span></span><span class=line><span class=cl>service/api-gateway created
</span></span><span class=line><span class=cl>service/api-gateway-external created
</span></span><span class=line><span class=cl>deployment.apps/customers-service created
</span></span><span class=line><span class=cl>service/customers-service created
</span></span><span class=line><span class=cl>deployment.apps/vets-service created
</span></span><span class=line><span class=cl>service/vets-service created
</span></span><span class=line><span class=cl>deployment.apps/visits-service created
</span></span><span class=line><span class=cl>service/visits-service created
</span></span><span class=line><span class=cl>deployment.apps/admin-server created
</span></span><span class=line><span class=cl>service/admin-server created
</span></span><span class=line><span class=cl>service/petclinic-db created
</span></span><span class=line><span class=cl>deployment.apps/petclinic-db created
</span></span><span class=line><span class=cl>configmap/petclinic-db-initdb-config created
</span></span><span class=line><span class=cl>deployment.apps/petclinic-loadgen-deployment created
</span></span><span class=line><span class=cl>configmap/scriptfile created</span></span></code></pre></div></div></div></div></div><p>This will cause the containers to be replaced with the local version, you can verify this by checking the containers:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe pods api-gateway <span class=p>|</span> grep Image:</span></span></code></pre></div><p>The resulting output will show <code>localhost:9999</code>:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>  Image:         localhost:9999/spring-petclinic-api-gateway:local</span></span></code></pre></div><p>However, as we only patched the deployment before, the new deployment does not have the right annotations for the <strong>automatic discovery and configuration</strong>, so let&rsquo;s fix that now by running the patch command again:</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>There will be no change for the <strong>admin-server</strong>, <strong>config-server</strong> and <strong>discovery-server</strong> as they are already annotated.</p></div></div><div class=tab-panel data-tab-group=d7e44432645483d11cdd589bee0cbde4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=patch-all-petclinic-services class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d7e44432645483d11cdd589bee0cbde4","patch-all-petclinic-services")'>
<span class=tab-nav-text>Patch all Petclinic services</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("d7e44432645483d11cdd589bee0cbde4","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=patch-all-petclinic-services class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get deployments -l app.kubernetes.io/part-of<span class=o>=</span>spring-petclinic -o name <span class=p>|</span> xargs -I % kubectl patch % -p <span class=s2>&#34;{\&#34;spec\&#34;: {\&#34;template\&#34;:{\&#34;metadata\&#34;:{\&#34;annotations\&#34;:{\&#34;instrumentation.opentelemetry.io/inject-java\&#34;:\&#34;default/splunk-otel-collector\&#34;}}}}}&#34;</span></span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>deployment.apps/config-server patched (no change)
</span></span><span class=line><span class=cl>deployment.apps/admin-server patched (no change)
</span></span><span class=line><span class=cl>deployment.apps/customers-service patched
</span></span><span class=line><span class=cl>deployment.apps/visits-service patched
</span></span><span class=line><span class=cl>deployment.apps/discovery-server patched (no change)
</span></span><span class=line><span class=cl>deployment.apps/vets-service patched
</span></span><span class=line><span class=cl>deployment.apps/api-gateway patched</span></span></code></pre></div></div></div></div></div><p>Check the <code>api-gateway</code> container (again if you see two <code>api-gateway</code> containers, it&rsquo;s the old container being terminated so give it a few seconds):</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe pods api-gateway <span class=p>|</span> grep Image:</span></span></code></pre></div><p>The resulting output will show the local api gateway version <code>localhost:9999</code> and the auto-instrumentation container:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>  Image:         ghcr.io/signalfx/splunk-otel-java/splunk-otel-java:v1.32.1
</span></span><span class=line><span class=cl>  Image:         localhost:9999/spring-petclinic-api-gateway:local</span></span></code></pre></div><p>Now that the Pods have been patched validate they are all running by executing the following command:</p><div class=tab-panel data-tab-group=16872d245ed7dd06df099d8b89a65e92><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=checking-if-all-pods-are-running class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("16872d245ed7dd06df099d8b89a65e92","checking-if-all-pods-are-running")'>
<span class=tab-nav-text>Checking if all Pods are running</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("16872d245ed7dd06df099d8b89a65e92","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=checking-if-all-pods-are-running class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pods</span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>NAME                                                           READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>splunk-otel-collector-certmanager-cainjector-cd8459647-d42ls   1/1     Running   0          22h
</span></span><span class=line><span class=cl>splunk-otel-collector-certmanager-85cbb786b6-xgjgb             1/1     Running   0          22h
</span></span><span class=line><span class=cl>splunk-otel-collector-certmanager-webhook-75d888f9f7-477x4     1/1     Running   0          22h
</span></span><span class=line><span class=cl>splunk-otel-collector-agent-nmmkm                              1/1     Running   0          22h
</span></span><span class=line><span class=cl>splunk-otel-collector-k8s-cluster-receiver-7f96c94fd9-fv4p8    1/1     Running   0          22h
</span></span><span class=line><span class=cl>splunk-otel-collector-operator-6b56bc9d79-r8p7w                2/2     Running   0          22h
</span></span><span class=line><span class=cl>petclinic-loadgen-deployment-765b96d4b9-gm8fp                  1/1     Running   0          21h
</span></span><span class=line><span class=cl>petclinic-db-774dbbf969-2q6md                                  1/1     Running   0          21h
</span></span><span class=line><span class=cl>config-server-5784c9fbb4-9pdc8                                 1/1     Running   0          21h
</span></span><span class=line><span class=cl>admin-server-849d877b6-pncr2                                   1/1     Running   0          21h
</span></span><span class=line><span class=cl>discovery-server-6d856d978b-7x69f                              1/1     Running   0          21h
</span></span><span class=line><span class=cl>visits-service-c7cd56876-grfn7                                 1/1     Running   0          21h
</span></span><span class=line><span class=cl>customers-service-6c57cb68fd-hx68n                             1/1     Running   0          21h
</span></span><span class=line><span class=cl>vets-service-688fd4cb47-z42t5                                  1/1     Running   0          21h
</span></span><span class=line><span class=cl>api-gateway-59f4c7fbd6-prx5f                                   1/1     Running   0          20h</span></span></code></pre></div></div></div></div></div><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=viewing-the-logs>Viewing the Logs</h1><p>In order to see logs click on the <strong>Log Observer</strong> <a href=#R-image-c606e41914d4a7a5b34cfc3fdde52e02 class=lightbox-link><img alt=Logo class="noborder inline lazy lightbox noshadow figure-image" loading=lazy src="/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/7-log-observer-connect/4-view-logs/../../images/logo-icon.png?classes=inline&height=25px" style=height:25px;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c606e41914d4a7a5b34cfc3fdde52e02><img alt=Logo class="noborder inline lazy lightbox noshadow lightbox-image" loading=lazy src="/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/7-log-observer-connect/4-view-logs/../../images/logo-icon.png?classes=inline&height=25px"></a> in the left-hand menu. Once in Log Observer please ensure <strong>Index</strong> on the filter bar is set to <strong>splunk4rookies-workshop</strong>.</p><p>Next, click <strong>Add Filter</strong> and search for the field <code>deployment.environment</code>, select your workshop instance and click <code>=</code> (to include). You will now see only the log messages from your PetClinic application.</p><p>Next search for the field <code>service_name</code>, select the value <code>customers-service</code> and click <code>=</code> (to include). Now the log entries will be reduced to show the entries from your <code>customers-service</code> only.</p><p>In the log entry you will see the message is formatted as per the pattern we configured for logback eariler <strong>(1)</strong>:</p><p><a href=#R-image-32a584e9942128b7240b8f4ab7aebc2b class=lightbox-link><img alt="Log Observer" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/7-log-observer-connect/4-view-logs/../../images/log-observer-trace-info.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-32a584e9942128b7240b8f4ab7aebc2b><img alt="Log Observer" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/7-log-observer-connect/4-view-logs/../../images/log-observer-trace-info.png></a></p><p>Click on an entry with an injected trace_id <strong>(1)</strong>. A side pane will open where you can see the detailed information, including the relevant trace and span IDs <strong>(2)</strong>.</p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=related-content>Related Content</h1><p>In the bottom pane is where any related content will be reported. In the screenshot below you can see that APM has found a trace that is related to this log line <strong>(1)</strong>:</p><p><a href=#R-image-4db4644452c9518d670ebf1fef926ace class=lightbox-link><img alt=RC class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/7-log-observer-connect/5-related-content/../../images/log-apm-rc.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-4db4644452c9518d670ebf1fef926ace><img alt=RC class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/7-log-observer-connect/5-related-content/../../images/log-apm-rc.png></a></p><p>By clicking on <strong>Trace for 0c5b37a751e1fc3e7a7191140ex714a0</strong> <strong>(2)</strong> will take us to the waterfall in APM for this specific trace that this log line was generated from:</p><p><a href=#R-image-ab1a7ff2017aaed2d6db5bd5eb4cd4a0 class=lightbox-link><img alt="waterfall logs" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/7-log-observer-connect/5-related-content/../../images/waterfall-with-logs.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ab1a7ff2017aaed2d6db5bd5eb4cd4a0><img alt="waterfall logs" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/7-log-observer-connect/5-related-content/../../images/waterfall-with-logs.png></a></p><p>Note that you now have Related Content pane for Logs appear <strong>(1)</strong>. Clicking on this will take you back to Log Observer and will display all the log lines that are part of this trace.</p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><article class=chapter><header class=headline></header><h1 id=6-section-break>6. Section Break</h1><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=real-user-monitoring>Real User Monitoring</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<p>To enable Real User Monitoring (RUM) instrumentation for your application, you need to add the Open Telemetry Javascript <a href=https://github.com/signalfx/splunk-otel-js-web rel=external target=_blank><strong>https://github.com/signalfx/splunk-otel-js-web</strong></a> snippet to your code.</p><p>The Spring PetClinic application uses a single HTML page as the &ldquo;index&rdquo; page, that is reused across all pages of the application. This is the perfect location to insert the Splunk RUM Instrumentation Library as it will be loaded for all pages automatically.</p><p>The following snippet is inserted into the <strong><head></strong>section of the <code>index.html</code> page:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;/static/env.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js&#34;</span> <span class=na>crossorigin</span><span class=o>=</span><span class=s>&#34;anonymous&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web-session-recorder.js&#34;</span> <span class=na>crossorigin</span><span class=o>=</span><span class=s>&#34;anonymous&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>realm</span> <span class=o>=</span> <span class=nx>env</span><span class=p>.</span><span class=nx>RUM_REALM</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Realm:&#39;</span><span class=p>,</span> <span class=nx>realm</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>auth</span> <span class=o>=</span> <span class=nx>env</span><span class=p>.</span><span class=nx>RUM_AUTH</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>appName</span> <span class=o>=</span> <span class=nx>env</span><span class=p>.</span><span class=nx>RUM_APP_NAME</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>environmentName</span> <span class=o>=</span> <span class=nx>env</span><span class=p>.</span><span class=nx>RUM_ENVIRONMENT</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>realm</span> <span class=o>&amp;&amp;</span> <span class=nx>auth</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>SplunkRum</span><span class=p>.</span><span class=nx>init</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=nx>realm</span><span class=o>:</span> <span class=nx>realm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>rumAccessToken</span><span class=o>:</span> <span class=nx>auth</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>applicationName</span><span class=o>:</span> <span class=nx>appName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>deploymentEnvironment</span><span class=o>:</span> <span class=nx>environmentName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>version</span><span class=o>:</span> <span class=s1>&#39;1.0.0&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>SplunkSessionRecorder</span><span class=p>.</span><span class=nx>init</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=nx>app</span><span class=o>:</span> <span class=nx>appName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>realm</span><span class=o>:</span> <span class=nx>realm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>rumAccessToken</span><span class=o>:</span> <span class=nx>auth</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>Provider</span> <span class=o>=</span> <span class=nx>SplunkRum</span><span class=p>.</span><span class=nx>provider</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>tracer</span><span class=o>=</span><span class=nx>Provider</span><span class=p>.</span><span class=nx>getTracer</span><span class=p>(</span><span class=s1>&#39;appModuleLoader&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Realm or auth is empty, provide default values or skip initialization
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Realm or auth is empty. Skipping Splunk Rum initialization.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div><p>The above snippet of code has already been added to <code>index.html</code> in the repository you cloned earlier, but it is not yet activated, we will do that in the next section.</p><p>If you want you can verify the snippet, we added to the index.html by viewing the file:</p><div class=tab-panel data-tab-group=857bfaee5489a7ab83184a450903ca1f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=view-indexhtml class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("857bfaee5489a7ab83184a450903ca1f","view-indexhtml")'>
<span class=tab-nav-text>View index.html</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("857bfaee5489a7ab83184a450903ca1f","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=view-indexhtml class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl> more ~/spring-petclinic-microservices/spring-petclinic-api-gateway/src/main/resources/static/index.html</span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>&lt;!DOCTYPE html&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;html ng-app=&#34;petClinicApp&#34; lang=&#34;en&#34;&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;head&gt;
</span></span><span class=line><span class=cl>    &lt;meta http-equiv=&#34;Content-Type&#34; content=&#34;text/html; charset=UTF-8&#34;/&gt;
</span></span><span class=line><span class=cl>    &lt;meta charset=&#34;utf-8&#34;/&gt;
</span></span><span class=line><span class=cl>    &lt;meta http-equiv=&#34;X-UA-Compatible&#34; content=&#34;IE=edge&#34;/&gt;
</span></span><span class=line><span class=cl>    &lt;meta name=&#34;viewport&#34; content=&#34;width=device-width, initial-scale=1, user-scalable=0, minimal-ui&#34;/&gt;
</span></span><span class=line><span class=cl>    &lt;!-- The above 4 meta tags *must* come first in the head; any other head content must come *after* these tags --&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    &lt;link rel=&#34;shortcut icon&#34; type=&#34;image/x-icon&#34; href=&#34;/images/favicon.png&#34;/&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    &lt;title&gt;PetClinic :: a Spring Framework demonstration&lt;/title&gt;
</span></span><span class=line><span class=cl>    &lt;link rel=&#34;stylesheet&#34; href=&#34;/webjars/bootstrap/css/bootstrap.min.css&#34;/&gt;
</span></span><span class=line><span class=cl>    &lt;link rel=&#34;stylesheet&#34; href=&#34;/css/petclinic.css&#34;/&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    &lt;script src=&#34;/webjars/jquery/jquery.min.js&#34;&gt;&lt;/script&gt;
</span></span><span class=line><span class=cl>    &lt;script src=&#34;/webjars/bootstrap/js/bootstrap.min.js&#34;&gt;&lt;/script&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    &lt;script src=&#34;/webjars/angularjs/angular.min.js&#34;&gt;&lt;/script&gt;
</span></span><span class=line><span class=cl>    &lt;script src=&#34;/webjars/angular-ui-router/angular-ui-router.min.js&#34;&gt;&lt;/script&gt;
</span></span><span class=line><span class=cl>    &lt;!-- Section added for  RUM --&gt;
</span></span><span class=line><span class=cl>    &lt;script src=&#34;/scripts/env.js&#34;&gt;&lt;/script&gt;
</span></span><span class=line><span class=cl>    &lt;script src=&#34;https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js&#34; crossorigin=&#34;anonymous&#34;&gt;&lt;/script&gt;
</span></span><span class=line><span class=cl>    &lt;script src=&#34;https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web-session-recorder.js&#34; crossorigin=&#34;anonymous&#34;&gt;&lt;/script&gt;
</span></span><span class=line><span class=cl>    &lt;script&gt;
</span></span><span class=line><span class=cl>        var realm = env.RUM_REALM;
</span></span><span class=line><span class=cl>        console.log(&#39;Realm:&#39;, realm);
</span></span><span class=line><span class=cl>        var auth = env.RUM_AUTH;
</span></span><span class=line><span class=cl>        var appName = env.RUM_APP_NAME;
</span></span><span class=line><span class=cl>        var environmentName = env.RUM_ENVIRONMENT
</span></span><span class=line><span class=cl>        if (realm &amp;&amp; auth) {
</span></span><span class=line><span class=cl>            SplunkRum.init({
</span></span><span class=line><span class=cl>                realm: realm,
</span></span><span class=line><span class=cl>                rumAccessToken: auth,
</span></span><span class=line><span class=cl>                applicationName: appName,
</span></span><span class=line><span class=cl>                deploymentEnvironment: environmentName,
</span></span><span class=line><span class=cl>                version: &#39;1.0.0&#39;,
</span></span><span class=line><span class=cl>            });
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            SplunkSessionRecorder.init({
</span></span><span class=line><span class=cl>                app: appName,
</span></span><span class=line><span class=cl>                realm: realm,
</span></span><span class=line><span class=cl>                rumAccessToken: auth
</span></span><span class=line><span class=cl>            });
</span></span><span class=line><span class=cl>            const Provider = SplunkRum.provider;
</span></span><span class=line><span class=cl>            var tracer=Provider.getTracer(&#39;appModuleLoader&#39;);
</span></span><span class=line><span class=cl>        } else {
</span></span><span class=line><span class=cl>        // Realm or auth is empty, provide default values or skip initialization
</span></span><span class=line><span class=cl>        console.log(&#34;Realm or auth is empty. Skipping Splunk Rum initialization.&#34;);
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    &lt;/script&gt;
</span></span><span class=line><span class=cl>     &lt;!-- Section added for  RUM --&gt;
</span></span><span class=line><span class=cl>    &lt;script src=&#34;/scripts/app.js&#34;&gt;&lt;/script&gt;</span></span></code></pre></div></div></div></div></div><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><section><h1 class=a11y-only>Subsections of Real User Monitoring</h1><article class=default><header class=headline></header><h1 id=rebuild-petclinic-with-rum-enabled>Rebuild PetClinic with RUM enabled</h1><p>At the top of the previous code snippet, there is a reference to the file <code>/static/env.js</code>, which contains/sets the variables used by RUM, currently these are not configured and therefore no RUM traces are currently being sent.</p><p>Run the script that will update variables to enable RUM traces so they are viewable in <strong>Splunk Observability Cloud</strong>. Note, that the <code>env.js</code> script contains a deliberate JavaScript error, that will be picked up in RUM:</p><div class=tab-panel data-tab-group=630234fd363f71c7c04d8fa60074f4bb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=update-envjs-for-rum class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("630234fd363f71c7c04d8fa60074f4bb","update-envjs-for-rum")'>
<span class=tab-nav-text>Update env.js for RUM</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("630234fd363f71c7c04d8fa60074f4bb","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=update-envjs-for-rum class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ~/workshop/petclinic/scripts/push_env.sh</span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Repository directory exists.
</span></span><span class=line><span class=cl>JavaScript file generated at: /home/splunk/spring-petclinic-microservices/spring-petclinic-api-gateway/src/main/resources/static/env.js</span></span></code></pre></div></div></div></div></div><p>Verify if the <code>env.js</code> has been created correctly:</p><div class=tab-panel data-tab-group=20f3adffcda104ecf75afc5bbcbe2c6b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=cat-envjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("20f3adffcda104ecf75afc5bbcbe2c6b","cat-envjs")'>
<span class=tab-nav-text>cat env.js</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("20f3adffcda104ecf75afc5bbcbe2c6b","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=cat-envjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/spring-petclinic-microservices/spring-petclinic-api-gateway/src/main/resources/static/scripts/env.js</span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl> <span class=nx>env</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>RUM_REALM</span><span class=o>:</span> <span class=s1>&#39;eu0&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>RUM_AUTH</span><span class=o>:</span> <span class=s1>&#39;[redacted]&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>RUM_APP_NAME</span><span class=o>:</span> <span class=s1>&#39;k8s-petclinic-workshop-store&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>RUM_ENVIRONMENT</span><span class=o>:</span> <span class=s1>&#39;k8s-petclinic-workshop-workshop&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Change into the <code>api-gateway</code> directory and force a new build for just the <code>api-gateway</code> service:</p><div class=tab-panel data-tab-group=441d626c6e9bf807605a3a0f9943bee6><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=building-api-gateway class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("441d626c6e9bf807605a3a0f9943bee6","building-api-gateway")'>
<span class=tab-nav-text>Building api-gateway</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("441d626c6e9bf807605a3a0f9943bee6","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=building-api-gateway class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span>  ~/spring-petclinic-microservices/spring-petclinic-api-gateway
</span></span><span class=line><span class=cl>../mvnw clean install -D skipTests -P buildDocker</span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Successfully built 2d409c1eeccc
</span></span><span class=line><span class=cl>Successfully tagged localhost:9999/spring-petclinic-api-gateway:local
</span></span><span class=line><span class=cl>[INFO] Built localhost:9999/spring-petclinic-api-gateway:local
</span></span><span class=line><span class=cl>[INFO] ------------------------------------------------------------------------
</span></span><span class=line><span class=cl>[INFO] BUILD SUCCESS
</span></span><span class=line><span class=cl>[INFO] ------------------------------------------------------------------------
</span></span><span class=line><span class=cl>[INFO] Total time: 26.250 s
</span></span><span class=line><span class=cl>[INFO] Finished at: 2024-05-31T15:51:20Z
</span></span><span class=line><span class=cl>[INFO] ------------------------------------------------------------------------</span></span></code></pre></div></div></div></div></div><p>and now push the new container to the local registry, the others get skipped:</p><div class=tab-panel data-tab-group=b97d02d495d36b901d26bf454985c0dd><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=updating-docker-repo-with-rum-api-gateway class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b97d02d495d36b901d26bf454985c0dd","updating-docker-repo-with-rum-api-gateway")'>
<span class=tab-nav-text>Updating docker repo with RUM api-gateway</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("b97d02d495d36b901d26bf454985c0dd","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=updating-docker-repo-with-rum-api-gateway class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ~/workshop/petclinic/scripts/push_docker.sh</span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>The push refers to repository [localhost:9999/spring-petclinic-api-gateway]
</span></span><span class=line><span class=cl>9a7b16677cf9: Pushed
</span></span><span class=line><span class=cl>f2e09ed98998: Layer already exists
</span></span><span class=line><span class=cl>291752eeb66b: Layer already exists
</span></span><span class=line><span class=cl>ac28fe526c24: Layer already exists
</span></span><span class=line><span class=cl>0a37fe4a02de: Layer already exists
</span></span><span class=line><span class=cl>4b1e7b998de9: Layer already exists
</span></span><span class=line><span class=cl>a2a8ef39e636: Layer already exists
</span></span><span class=line><span class=cl>86cb6a9eb3cd: Layer already exists
</span></span><span class=line><span class=cl>985fdc63de98: Layer already exists
</span></span><span class=line><span class=cl>4ab2850febd7: Layer already exists
</span></span><span class=line><span class=cl>2db7720a8970: Layer already exists
</span></span><span class=line><span class=cl>629ca62fb7c7: Layer already exists</span></span></code></pre></div></div></div></div></div><p>As soon as the container is pushed into the repository, just restart the <code>api-gateway</code> to apply the changes:</p><div class=tab-panel data-tab-group=b12ecc87016cd22deb794898c2d1d18d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=rollout-restart-api-gateway class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b12ecc87016cd22deb794898c2d1d18d","rollout-restart-api-gateway")'>
<span class=tab-nav-text>Rollout restart api-gateway</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("b12ecc87016cd22deb794898c2d1d18d","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=rollout-restart-api-gateway class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl rollout restart deployment api-gateway</span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>deployment.apps/api-gateway restarted</span></span></code></pre></div></div></div></div></div><p>Validate that the application is running by visiting <strong>http://&lt;IP_ADDRESS>:81</strong> (replace <strong>&lt;IP_ADDRESS></strong> with the IP address you obtained above). Make sure the application is working correctly by visiting the <strong>All Owners</strong> <strong>(1)</strong> and select an owner, then add a <strong>visit</strong> <strong>(2)</strong>. We will use this action when checking RUM</p><p><a href=#R-image-65f07e4d5ac8dc820a0560d6c66ee4a0 class=lightbox-link><img alt=pet class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/8-rum/1-rebuild-app/../../images/petclinic-pet.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-65f07e4d5ac8dc820a0560d6c66ee4a0><img alt=pet class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/8-rum/1-rebuild-app/../../images/petclinic-pet.png></a></p><p>If you want, you can access this website on your phone/tablet as well as this data will also show up in RUM.</p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=select-the-rum-view-for-the-petclinic-app>Select the RUM view for the Petclinic App</h1><p>Once RUM has been configured and you have added a visit for a pet, you can log in to <strong>Splunk Observability Cloud</strong> and verify that RUM traces are flowing in.</p><p>Lets start a quick high level tour into RUM by clicking <strong>RUM</strong> <a href=#R-image-4c06fde76edf288346b26c1023e1d363 class=lightbox-link><img alt=RUM class="noborder inline lazy lightbox noshadow figure-image" loading=lazy src="/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/8-rum/2-rum-tour-1/../../images/rum-icon.png?classes=inline&height=25px" style=height:25px;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-4c06fde76edf288346b26c1023e1d363><img alt=RUM class="noborder inline lazy lightbox noshadow lightbox-image" loading=lazy src="/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/8-rum/2-rum-tour-1/../../images/rum-icon.png?classes=inline&height=25px"></a> in the left-hand menu. Then change the <strong>Environment</strong> filter <strong>(1)</strong> to the name of your workshop instance from the dropdown box, it will be <strong><code>&lt;INSTANCE>-workshop</code></strong> <strong>(1)</strong> (where <strong><code>INSTANCE</code></strong> is the value from the shell script you ran earlier). Make sure it is the only one selected.</p><p>Then change the <strong>App</strong> <strong>(2)</strong> dropdown box to the name of your app, it will be <strong><code>&lt;INSTANCE>-store</code></strong></p><p><a href=#R-image-fedf2ab7c49f52a4ec7caab9d50aefe2 class=lightbox-link><img alt="rum select" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/8-rum/2-rum-tour-1/../../images/rum-env-select.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-fedf2ab7c49f52a4ec7caab9d50aefe2><img alt="rum select" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/8-rum/2-rum-tour-1/../../images/rum-env-select.png></a></p><p>Once you have selected your <strong>Environment</strong> and <strong>App</strong>, you will see an overview page showing the RUM status of your App (if your Summary Dashboard is just a single row of numbers, you are looking at the condensed view. You can expand it by clicking on the <strong>></strong> in front of the Application name). If any JavaScript error occurred they will show up as shown below:</p><p><a href=#R-image-824ffaac1a1f1d06472868664efcce1c class=lightbox-link><img alt="rum overview" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/8-rum/2-rum-tour-1/../../images/rum-overview.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-824ffaac1a1f1d06472868664efcce1c><img alt="rum overview" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/8-rum/2-rum-tour-1/../../images/rum-overview.png></a></p><p>To continue, click on the blue link (with your workshop name) to get to the details page, this will bring up a new dashboard view breaking down the interactions by UX Metrics, Front-end Health, Back-end Health and Custom Events and comparing them to historic metrics (1 hour by default).</p><p><a href=#R-image-3a8c2e96fe7b58d0afe728b41ff60681 class=lightbox-link><img alt="rum  main" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/8-rum/2-rum-tour-1/../../images/rum-main.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-3a8c2e96fe7b58d0afe728b41ff60681><img alt="rum  main" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/8-rum/2-rum-tour-1/../../images/rum-main.png></a>
Normally you have only one line inside the first chart, Click on the link that relates to your Petclinic shop,
http://198.19.249.62 in our example:</p><p>This will bring us to the Tag Spotlight page:</p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=rum-trace-waterfall-view--linking-to-apm>RUM trace Waterfall view & linking to APM</h1><p>In the TAG Spotlight view, you are presented with all the tags associated with the RUM data. Tags are key-value pairs that are used to identify the data. In this case, the tags are automatically generated by the OpenTelemetry instrumentation. The tags are used to filter the data and to create the charts and tables. The Tag Spotlight view allows you detect trends in behavior and to drill down into a user session.</p><p><a href=#R-image-2237c5cf6d1a1740b730909c8f6d18da class=lightbox-link><img alt="RUM TAG" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/8-rum/3-rum-tour-2/../../images/rum-tag-spotlight.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-2237c5cf6d1a1740b730909c8f6d18da><img alt="RUM TAG" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/8-rum/3-rum-tour-2/../../images/rum-tag-spotlight.png></a></p><p>Click on User Sessions <strong>(1)</strong>, this will show you the list of user session that occurred during the time window.
We want to look at one of the session , so click on <em>Duration</em> <strong>(2)</strong> to sort on duration, and make sure you click on the link of one of the longer ones <strong>(3)</strong>:</p><p><a href=#R-image-5ef76c53fdaeb717c0be26d2f1449b01 class=lightbox-link><img alt="User sessions" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/8-rum/3-rum-tour-2/../../images/rum-user-sessions.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5ef76c53fdaeb717c0be26d2f1449b01><img alt="User sessions" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/8-rum/3-rum-tour-2/../../images/rum-user-sessions.png></a></p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=rum-trace-waterfall-view--linking-to-apm>RUM trace Waterfall view & linking to APM</h1><p>We are now looking at the RUM Trace waterfall, this will tell you what happened during the session on the user device as they visited the page of our petclinic application.</p><p>If you scroll down the waterfall find click on the <strong>Vets</strong> segment on the right <strong>(1)</strong>, you see a list of action that occurred during the handling of the Vets request. Note, that the HTTP request have a blue <strong>APM</strong> link before the return code. Pick one, and click on the APM link. This will show you the APM info for this Ser vice call to our Microservices in Kubernetes.</p><p><a href=#R-image-7956c56b6cd96ea8d7677e73f23325f5 class=lightbox-link><img alt="rum apm link" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/8-rum/4-rum-tour-3/../../images/rum-trace.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-7956c56b6cd96ea8d7677e73f23325f5><img alt="rum apm link" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/8-rum/4-rum-tour-3/../../images/rum-trace.png></a></p><p>Note , that there give you the information what happened during action in the Microservices, and if you want to drill down to verify what happened with the request, click on the Trace ID url.</p><p>This will show you the trace related to your request from RUM:</p><p><a href=#R-image-aa505b32cce83c2b80f2927bf604d4d8 class=lightbox-link><img alt="RUm-apm linked" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/8-rum/4-rum-tour-3/../../images/rum-apm-waterfall.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-aa505b32cce83c2b80f2927bf604d4d8><img alt="RUm-apm linked" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/8-rum/4-rum-tour-3/../../images/rum-apm-waterfall.png></a></p><p>You can see that the entry point into your service now has a <strong>RUM (1)</strong> related content link added, allowing you to return back to your RUM session after you validated what happened in your Microservices.</p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article></section><article class=chapter><header class=headline></header><h1 id=workshop-wrap-up->Workshop Wrap-up üéÅ</h1><p>Congratulations, you have completed the <strong>Get the Most Out of Your Existing Kubernetes Java Applications Using Automatic Discovery and Configuration With OpenTelemetry</strong> workshop.</p><p>Today, you have learnt how easy it is to add Tracing, Code Profiling and Database Query Performance to your existing Java application in Kubernetes.</p><p>You immediately improved the observability of the application and infrastructure with out touching a line of code or configuration using <strong>Automatic Discovery and Configuration</strong>.</p><p>You also learnt that with simple configuration changes you can add even more observability (<strong>logging</strong> and <strong>RUM</strong>) to the application in order to provide end-to-end observability.</p><p><a href=#R-image-15dd459a856823323a23d67fa61eed91 class=lightbox-link><img alt=Champagne class="noborder lazy lightbox noshadow figure-image" loading=lazy src="/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/9-wrap-up/images/champagne.png?width=45vw" style=height:auto;width:45vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-15dd459a856823323a23d67fa61eed91><img alt=Champagne class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="/observability-workshop/v5.66/en/other/3-automatic-discovery/2-petclinic-kubernetes/9-wrap-up/images/champagne.png?width=45vw"></a></p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>rcastley</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>Aug 20, 2024</span></span></footer></article></section></div></main></div><script src=/observability-workshop/v5.66/js/clipboard.min.js?1725879471 defer></script><script src=/observability-workshop/v5.66/js/perfect-scrollbar.min.js?1725879471 defer></script><script src=/observability-workshop/v5.66/js/theme.js?1725879471 defer></script></body></html>