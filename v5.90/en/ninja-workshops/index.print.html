<!doctype html><html lang=en dir=ltr itemscope itemtype=http://schema.org/Article data-r-output-format=print><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.145.0"><meta name=generator content="Relearn 7.2.1"><meta name=description content="The following workshops require Ninja skills, wax on, wax off."><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Splunk4Ninjas Workshops :: Splunk Observability Cloud Workshops"><meta name=twitter:description content="The following workshops require Ninja skills, wax on, wax off."><meta property="og:url" content="https://splunk.github.io/observability-workshop/v5.90/en/ninja-workshops/index.html"><meta property="og:site_name" content="Splunk Observability Cloud Workshops"><meta property="og:title" content="Splunk4Ninjas Workshops :: Splunk Observability Cloud Workshops"><meta property="og:description" content="The following workshops require Ninja skills, wax on, wax off."><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta itemprop=name content="Splunk4Ninjas Workshops :: Splunk Observability Cloud Workshops"><meta itemprop=description content="The following workshops require Ninja skills, wax on, wax off."><meta itemprop=dateModified content="2025-04-28T10:27:04+01:00"><meta itemprop=wordCount content="214"><title>Splunk4Ninjas Workshops :: Splunk Observability Cloud Workshops</title>
<link href=https://splunk.github.io/observability-workshop/v5.90/en/ninja-workshops/index.html rel=canonical type=text/html title="Splunk4Ninjas Workshops :: Splunk Observability Cloud Workshops"><link href=/observability-workshop/v5.90/images/favicon.ico?1746614785 rel=icon type=image/x-icon sizes=any><link href=/observability-workshop/v5.90/css/fontawesome-all.min.css?1746614785 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v5.90/css/fontawesome-all.min.css?1746614785 rel=stylesheet></noscript><link href=/observability-workshop/v5.90/css/auto-complete.css?1746614785 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v5.90/css/auto-complete.css?1746614785 rel=stylesheet></noscript><link href=/observability-workshop/v5.90/css/perfect-scrollbar.min.css?1746614785 rel=stylesheet><link href=/observability-workshop/v5.90/css/theme.min.css?1746614785 rel=stylesheet><link href=/observability-workshop/v5.90/css/format-print.min.css?1746614785 rel=stylesheet id=R-format-style><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../..",window.relearn.relBaseUri="../../../..",window.relearn.absBaseUri="https://splunk.github.io/observability-workshop/v5.90",window.relearn.min=`.min`,window.relearn.disableAnchorCopy=!1,window.relearn.disableAnchorScrolling=!1,window.relearn.themevariants=["auto","splunk-light","splunk-dark"],window.relearn.customvariantname="my-custom-variant",window.relearn.changeVariant=function(e){var t=document.documentElement.dataset.rThemeVariant;window.localStorage.setItem(window.relearn.absBaseUri+"/variant",e),document.documentElement.dataset.rThemeVariant=e,t!=e&&document.dispatchEvent(new CustomEvent("themeVariantLoaded",{detail:{variant:e,oldVariant:t}}))},window.relearn.markVariant=function(){var t=window.localStorage.getItem(window.relearn.absBaseUri+"/variant"),e=document.querySelector("#R-select-variant");e&&(e.value=t)},window.relearn.initVariant=function(){var e=window.localStorage.getItem(window.relearn.absBaseUri+"/variant")??"";e==window.relearn.customvariantname||(!e||!window.relearn.themevariants.includes(e))&&(e=window.relearn.themevariants[0],window.localStorage.setItem(window.relearn.absBaseUri+"/variant",e)),document.documentElement.dataset.rThemeVariant=e},window.relearn.initVariant(),window.relearn.markVariant(),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js crossorigin=anonymous></script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web-session-recorder.js crossorigin=anonymous></script><script>SplunkRum.init({realm:"us1",rumAccessToken:"Z8JjZ8iNiF4jSfNHvJIRJg",applicationName:"observability-workshop",deploymentEnvironment:"splunk.github.io",version:"1.0"}),SplunkSessionRecorder.init({app:"observability-workshop",realm:"us1",rumAccessToken:"Z8JjZ8iNiF4jSfNHvJIRJg"})</script></script><style>:root{--MAIN-WIDTH-MAX:130rem;--MENU-WIDTH-L:23rem}p{margin:.75rem 0}.highlight{max-height:500px;overflow-y:auto}pre:not(.mermaid){margin:0}</style></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=/observability-workshop/v5.90/en/ninja-workshops/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div><div class="topbar-button topbar-button-toc" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title="Table of Contents (CTRL+ALT+t)"><i class="fa-fw fas fa-list-alt"></i></button><div class=topbar-content><div class=topbar-content-wrapper></div></div></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v5.90/en/index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Splunk4Ninjas Workshops</span><meta itemprop=position content="2"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-print" data-content-empty=disable data-width-s=area-more data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v5.90/en/ninja-workshops/index.print.html title="Print whole chapter (CTRL+ALT+p)"><i class="fa-fw fas fa-print"></i></a></div><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v5.90/en/splunk4rookies/observability-cloud/10-wrap-up/key-takeaways/index.html title="Key Takeaways (ðŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v5.90/en/ninja-workshops/1-automatic-discovery/index.html title="Automatic Discovery Workshops (ðŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a></div><div class="topbar-button topbar-button-more" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title=More><i class="fa-fw fas fa-ellipsis-v"></i></button><div class=topbar-content><div class=topbar-content-wrapper><div class="topbar-area topbar-area-more" data-area=more></div></div></div></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable ninja-workshops" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=splunk4ninjas-workshops>Splunk4Ninjas Workshops</h1><ul class="children children-li children-sort-"><li><a href=/observability-workshop/v5.90/en/ninja-workshops/1-automatic-discovery/index.html>Automatic Discovery Workshops</a><p>Automatic Discovery Workshops</p></li><li><a href=/observability-workshop/v5.90/en/ninja-workshops/2-hpa/index.html>Horizontal Pod Autoscaling</a><p>This workshop will equip you with the basic understanding of monitoring Kubernetes using the Splunk OpenTelemetry Collector</p></li><li><a href=/observability-workshop/v5.90/en/ninja-workshops/3-opentelemetry-collector-workshops/index.html>OpenTelemetry Collector Workshops</a><p><ul class="children children-li children-sort-"><li><a href=/observability-workshop/v5.90/en/ninja-workshops/3-opentelemetry-collector-workshops/1-opentelemetry-collector/index.html>OpenTelemetry Collector Concepts</a><p>Learn the concepts of the OpenTelemetry Collector and how to use it to send data to Splunk Observability Cloud.</p></li><li><a href=/observability-workshop/v5.90/en/ninja-workshops/3-opentelemetry-collector-workshops/2-advanced-collector/index.html>Advanced Collector Configuration</a><p>Practice setting up the OpenTelemetry Collector configuration from scratch and go though several advanced configuration scenarios's.</p></li></ul></p></li><li><a href=/observability-workshop/v5.90/en/ninja-workshops/4-synthetics-scripting/index.html>Splunk Synthetic Scripting</a><p>Proactively find and fix performance issues across user flows, business transactions and APIs to deliver better digital experiences.</p></li><li><a href=/observability-workshop/v5.90/en/ninja-workshops/6-lambda-kinesis/index.html>Lambda Tracing</a><p>This workshop will enable you to build a distributed trace for a small serverless application that runs on AWS Lambda, producing and consuming a message via AWS Kinesis</p></li><li><a href=/observability-workshop/v5.90/en/ninja-workshops/8-docker-k8s-otel/index.html>Hands-On OpenTelemetry, Docker, and K8s</a><p>By the end of this workshop you'll have gotten hands-on experience instrumenting a .NET application with OpenTelemetry, then Dockerizing the application and deploying it to Kubernetes. Youâ€™ll also gain experience deploying the OpenTelemetry collector using Helm, customizing the collector configuration, and troubleshooting collector configuration issues.</p></li><li><a href=/observability-workshop/v5.90/en/ninja-workshops/9-solving-problems-with-o11y-cloud/index.html>Solving Problems with O11y Cloud</a><p>By the end of this workshop you'll have gotten hands-on experience deploying the OpenTelemetry Collector, instrumenting an application with OpenTelemetry, capturing tags from the application, and using Troubleshooting MetricSets and Tag Spotlight to determine the root cause of an issue.</p></li><li><a href=/observability-workshop/v5.90/en/ninja-workshops/11-ingest_processor_for_observability_cloud/index.html>Ingest Processor for Observability Cloud</a><p>Scenario Description</p></li></ul><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Apr 28, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of Splunk4Ninjas Workshops</h1><article class=default><header class=headline></header><h1 id=automatic-discovery-workshops>Automatic Discovery Workshops</h1><ul class="children children-li children-sort-"><li><a href=/observability-workshop/v5.90/en/ninja-workshops/1-automatic-discovery/1-petclinic-monolith/index.html>PetClinic Monolith Workshop</a><p>A workshop using automatic discovery and configuration for Java.</p></li><li><a href=/observability-workshop/v5.90/en/ninja-workshops/1-automatic-discovery/2-petclinic-kubernetes/index.html>PetClinic Kubernetes Workshop</a><p>Learn how to enable automatic discovery and configuration for your Java-based application running in Kubernetes. Experience real-time monitoring to help you maximize application behavior with end-to-end visibility.</p></li></ul><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><section><h1 class=a11y-only>Subsections of Automatic Discovery Workshops</h1><article class=default><header class=headline></header><h1 id=petclinic-monolith-workshop>PetClinic Monolith Workshop</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>30 minutes</span>
</span>&nbsp;
<span class="badge cstyle blue badge-with-title"><span class=badge-title class=text-muted>Author
</span><span class=badge-content>Robert Castley</span></span><p>The goal is to walk through the basic steps to configure the following components of the <strong>Splunk Observability Cloud</strong> platform:</p><ul><li>Splunk Infrastructure Monitoring (IM)</li><li>Splunk Automatic Discovery for Java (APM)<ul><li>Database Query Performance</li><li>AlwaysOn Profiling</li></ul></li><li>Splunk Real User Monitoring (RUM)</li><li>RUM to APM Correlation</li><li>Splunk Log Observer (LO)</li></ul><p>We will also show the steps about how to clone (download) a sample Java application (Spring PetClinic), as well as how to compile, package and run the application.</p><p>Once the application is up and running, we will instantly start seeing metrics, traces and logs via the <strong>automatic discovery and configuration</strong> for Java 2.x that will be used by the <strong>Splunk APM</strong> product.</p><p>After that, we will instrument PetClinic&rsquo;s end user interface (HTML pages rendered by the application) with the <strong>Splunk OpenTelemetry Javascript Libraries (RUM)</strong> that will generate RUM traces around all the individual clicks and page loads executed by an end user.</p><p>Lastly, we will view the logs generated by the automatic injection of trace metadata into the PetClinic application logs.</p><details open class="box cstyle notices primary"><summary class=box-label><i class="fa-fw fas fa-info"></i>
Prerequisites</summary><div class=box-content><ul><li>Outbound SSH access to port <code>2222</code>.</li><li>Outbound HTTP access to port <code>8083</code>.</li><li>Familiarity with the <code>bash</code> shell and <code>vi/vim</code> editor.</li></ul></div></details><p><a href=#R-image-4ca5eecec942ea3c1c19def7af7a0950 class=lightbox-link><img alt="PetClinic Exercise" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.90/en/ninja-workshops/1-automatic-discovery/1-petclinic-monolith/images/petclinic-exercise.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-4ca5eecec942ea3c1c19def7af7a0950><img alt="PetClinic Exercise" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.90/en/ninja-workshops/1-automatic-discovery/1-petclinic-monolith/images/petclinic-exercise.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><section><h1 class=a11y-only>Subsections of PetClinic Monolith Workshop</h1><article class=default><header class=headline></header><h1 id=installing-the-opentelemetry-collector>Installing the OpenTelemetry Collector</h1><p>The Splunk OpenTelemetry Collector is the core component of instrumenting infrastructure and applications. Its role is to collect and send:</p><ul><li>Infrastructure metrics (disk, CPU, memory, etc.)</li><li>Application Performance Monitoring (APM) traces</li><li>Profiling data</li><li>Host and application logs</li></ul><details open class="box cstyle notices warning"><summary class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i>
Remove any existing OpenTelemetry Collectors</summary><div class=box-content><p>If you have completed the Splunk IM workshop, please ensure you have deleted the collector running in Kubernetes before continuing. This can be done by running the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm delete splunk-otel-collector</span></span></code></pre></div><p>The EC2 instance may already have an older version of the collector already installed. To uninstall the collector, run the following commands:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -sSL https://dl.signalfx.com/splunk-otel-collector.sh &gt; /tmp/splunk-otel-collector.sh
</span></span><span class=line><span class=cl>sudo sh /tmp/splunk-otel-collector.sh --uninstall</span></span></code></pre></div></div></details><p>To ensure your instance is configured correctly, we need to confirm that the required environment variables for this workshop are set correctly. In your terminal run the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ~/workshop/petclinic/scripts/check_env.sh</span></span></code></pre></div><p>In the output check that all the following environment variables are present and have values set. If any are missing, please contact your instructor:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>ACCESS_TOKEN
</span></span><span class=line><span class=cl>REALM
</span></span><span class=line><span class=cl>RUM_TOKEN
</span></span><span class=line><span class=cl>HEC_TOKEN
</span></span><span class=line><span class=cl>HEC_URL
</span></span><span class=line><span class=cl>INSTANCE</span></span></code></pre></div><p>We can then go ahead and install the Collector. Some additional parameters are passed to the installation script, they are:</p><ul><li><code>--with-instrumentation</code> - This will install the agent from the Splunk distribution of OpenTelemetry Java, which is then loaded automatically when the PetClinic Java application starts up. No configuration is required!</li><li><code>--deployment-environment</code> - Sets the resource attribute <code>deployment.environment</code> to the value passed. This is used to filter views in the UI.</li><li><code>--enable-profiler</code> - Enables the profiler for the Java application. This will generate CPU profiles for the application.</li><li><code>--enable-profiler-memory</code> - Enables the profiler for the Java application. This will generate memory profiles for the application.</li><li><code>--enable-metrics</code> - Enables the exporting of Micrometer metrics</li><li><code>--hec-token</code> - Sets the HEC token for the collector to use</li><li><code>--hec-url</code> - Sets the HEC URL for the collector to use</li></ul><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -sSL https://dl.signalfx.com/splunk-otel-collector.sh &gt; /tmp/splunk-otel-collector.sh <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>sudo sh /tmp/splunk-otel-collector.sh --realm <span class=nv>$REALM</span> -- <span class=nv>$ACCESS_TOKEN</span> --mode agent --without-fluentd --with-instrumentation --deployment-environment <span class=nv>$INSTANCE</span>-petclinic --enable-profiler --enable-profiler-memory --enable-metrics --hec-token <span class=nv>$HEC_TOKEN</span> --hec-url <span class=nv>$HEC_URL</span></span></span></code></pre></div><p>Next, we will patch the collector to expose the hostname of the instance and not the AWS instance ID. This will make it easier to filter data in the UI:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo sed -i <span class=s1>&#39;s/gcp, ecs, ec2, azure, system/system, gcp, ecs, ec2, azure/g&#39;</span> /etc/otel/collector/agent_config.yaml</span></span></code></pre></div><p>Once the <code>agent_config.yaml</code> has been patched, you will need to restart the collector:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl restart splunk-otel-collector</span></span></code></pre></div><p>Once the installation is completed, you can navigate to the <strong>Hosts with agent installed</strong> dashboard to see the data from your host, <strong>Dashboards â†’ Hosts with agent installed</strong>.</p><p>Use the dashboard filter and select <code>host.name</code> and type or select the hostname of your workshop instance (you can get this from the command prompt in your terminal session). Once you see data flowing for your host, we are then ready to get started with the APM component.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=building-the-spring-petclinic-application>Building the Spring PetClinic Application</h1><p>The first thing we need to set up APM is&mldr; well, an application. For this exercise, we will use the Spring PetClinic application. This is a very popular sample Java application built with the Spring framework (Springboot).</p><p>First, clone the PetClinic GitHub repository, and then we will compile, build, package and test the application:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone https://github.com/spring-projects/spring-petclinic</span></span></code></pre></div><p>Change into the <code>spring-petclinic</code> directory:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> spring-petclinic</span></span></code></pre></div><p>Using Docker, start a MySQL database for PetClinic to use:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run -d -e <span class=nv>MYSQL_USER</span><span class=o>=</span>petclinic -e <span class=nv>MYSQL_PASSWORD</span><span class=o>=</span>petclinic -e <span class=nv>MYSQL_ROOT_PASSWORD</span><span class=o>=</span>root -e <span class=nv>MYSQL_DATABASE</span><span class=o>=</span>petclinic -p 3306:3306 docker.io/biarms/mysql:5.7</span></span></code></pre></div><p>Next, we will start another container running Locust that will generate some simple traffic to the PetClinic application. Locust is a simple load-testing tool that can be used to generate traffic to a web application.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run --network<span class=o>=</span><span class=s2>&#34;host&#34;</span> -d -p 8090:8090 -v ~/workshop/petclinic:/mnt/locust docker.io/locustio/locust -f /mnt/locust/locustfile.py --headless -u <span class=m>1</span> -r <span class=m>1</span> -H http://127.0.0.1:8083</span></span></code></pre></div><p>Next, compile, build and package PetClinic using <code>maven</code>:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./mvnw package -Dmaven.test.skip<span class=o>=</span>true</span></span></code></pre></div><details open class="box cstyle notices info"><summary class=box-label><i class="fa-fw fas fa-info-circle"></i>
Info</summary><div class=box-content><p>This will take a few minutes the first time you run and will download a lot of dependencies before it compiles the application. Future builds will be a lot quicker.</p></div></details><p>Once the build completes, you need to obtain the public IP address of the instance you are running on. You can do this by running the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://ifconfig.me</span></span></code></pre></div><p>You will see an IP address returned, make a note of this as we will need it to validate that the application is running.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=automatic-discovery-and-configuration-for-java>Automatic discovery and configuration for Java</h1><p>You can now start the application with the following command. Notice that we are passing the <code>mysql</code> profile to the application, this will tell the application to use the MySQL database we started earlier. We are also setting the <code>otel.service.name</code> and <code>otel.resource.attributes</code> to a logical names using the instance name. These will also be used in the UI for filtering:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>java <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dserver.port<span class=o>=</span><span class=m>8083</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dotel.service.name<span class=o>=</span><span class=nv>$INSTANCE</span>-petclinic-service <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dotel.resource.attributes<span class=o>=</span>deployment.environment<span class=o>=</span><span class=nv>$INSTANCE</span>-petclinic-env <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-jar target/spring-petclinic-*.jar --spring.profiles.active<span class=o>=</span>mysql</span></span></code></pre></div><p>You can validate the application is running by visiting <code>http://&lt;IP_ADDRESS>:8083</code> (replace <code>&lt;IP_ADDRESS></code> with the IP address you obtained earlier).</p><p>When we installed the collector we configured it to enable <strong>AlwaysOn Profiling</strong> and <strong>Metrics</strong>. This means that the collector will automatically generate CPU and Memory profiles for the application and send them to Splunk Observability Cloud.</p><p>When you start the PetClinic application you will see the collector automatically detect the application and instrument it for traces and profiling.</p><div class=tab-panel data-tab-group=51b3997c695b1b23136c69529614defa><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("51b3997c695b1b23136c69529614defa","example-output")'>
<span class=tab-nav-text>Example output</span></button></div><div class=tab-content-container><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Picked up JAVA_TOOL_OPTIONS: -javaagent:/usr/lib/splunk-instrumentation/splunk-otel-javaagent.jar
</span></span><span class=line><span class=cl>OpenJDK 64-Bit Server VM warning: Sharing is only supported for boot loader classes because bootstrap classpath has been appended
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:58:970 +0000] [main] INFO io.opentelemetry.javaagent.tooling.VersionLogger - opentelemetry-javaagent - version: splunk-2.6.0-otel-2.6.0
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:730 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger - -----------------------
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:730 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger - Profiler configuration:
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:730 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -                  splunk.profiler.enabled : true
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:731 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -                splunk.profiler.directory : /tmp
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:731 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -       splunk.profiler.recording.duration : 20s
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:731 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -               splunk.profiler.keep-files : false
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:732 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -            splunk.profiler.logs-endpoint : null
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:732 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -              otel.exporter.otlp.endpoint : null
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:732 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -           splunk.profiler.memory.enabled : true
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:732 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -        splunk.profiler.memory.event.rate : 150/s
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:732 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -      splunk.profiler.call.stack.interval : PT10S
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:733 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -  splunk.profiler.include.internal.stacks : false
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:733 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -      splunk.profiler.tracing.stacks.only : false
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:733 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger - -----------------------
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:733 +0000] [main] INFO com.splunk.opentelemetry.profiler.JfrActivator - Profiler is active.</span></span></code></pre></div></div></div></div></div><p>You can now visit the Splunk APM UI and examine the application components, traces, profiling, DB Query performance and metrics. From the left-hand menu click <strong>APM</strong> and then click the <strong>Environment</strong> dropdown and select your environment e.g. <code>&lt;INSTANCE>-petclinic</code> (where<code>&lt;INSTANCE></code> is replaced with the value you noted down earlier).</p><p>Once your validation is complete you can stop the application by pressing <code>Ctrl-c</code>.</p><p>Resource attributes can be added to every reported span. For example <code>version=0.314</code>. A comma-separated list of resource attributes can also be defined e.g. <code>key1=val1,key2=val2</code>.</p><p>Let&rsquo;s launch the PetClinic again using new resource attributes. Note, that adding resource attributes to the run command will override what was defined when we installed the collector. Let&rsquo;s add a new resource attribute <code>version=0.314</code>:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>java <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dserver.port<span class=o>=</span><span class=m>8083</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dotel.service.name<span class=o>=</span><span class=nv>$INSTANCE</span>-petclinic-service <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dotel.resource.attributes<span class=o>=</span>deployment.environment<span class=o>=</span><span class=nv>$INSTANCE</span>-petclinic-env,version<span class=o>=</span>0.314 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-jar target/spring-petclinic-*.jar --spring.profiles.active<span class=o>=</span>mysql</span></span></code></pre></div><p>Back in the Splunk APM UI we can drill down on a recent trace and see the new <code>version</code> attribute in a span.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Nov 4, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=3-real-user-monitoring>3. Real User Monitoring</h1><p>For the Real User Monitoring (RUM) instrumentation, we will add the Open Telemetry Javascript <a href=https://github.com/signalfx/splunk-otel-js-web rel=external target=_blank><strong>https://github.com/signalfx/splunk-otel-js-web</strong></a> snippet in the pages, we will use the wizard again <strong>Data Management â†’ Add Integration â†’ RUM Instrumentation â†’ Browser Instrumentation</strong>.</p><p>Your instructor will inform you which token to use from the dropdown, click <strong>Next</strong>. Enter <strong>App name</strong> and <strong>Environment</strong> using the following syntax:</p><ul><li><code>&lt;INSTANCE>-petclinic-service</code> - replacing <code>&lt;INSTANCE></code> with the value you noted down earlier.</li><li><code>&lt;INSTANCE>-petclinic-env</code> - replacing <code>&lt;INSTANCE></code> with the value you noted down earlier.</li></ul><p>The wizard will then show a snippet of HTML code that needs to be placed at the top of the pages in the <code>&lt;head></code> section. The following is an example of the (do not use this snippet, use the one generated by the wizard):</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>/*
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>IMPORTANT: Replace the <span class=p>&lt;</span><span class=nt>version</span><span class=p>&gt;</span> placeholder in the src URL with a
</span></span><span class=line><span class=cl>version from https://github.com/signalfx/splunk-otel-js-web/releases
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>*/
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js&#34;</span> <span class=na>crossorigin</span><span class=o>=</span><span class=s>&#34;anonymous&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nx>SplunkRum</span><span class=p>.</span><span class=nx>init</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>realm</span><span class=o>:</span> <span class=s2>&#34;eu0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>rumAccessToken</span><span class=o>:</span> <span class=s2>&#34;&lt;redacted&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>applicationName</span><span class=o>:</span> <span class=s2>&#34;petclinic-1be0-petclinic-service&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>deploymentEnvironment</span><span class=o>:</span> <span class=s2>&#34;petclinic-1be0-petclinic-env&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div><p>The Spring PetClinic application uses a single HTML page as the &ldquo;layout&rdquo; page, that is reused across all pages of the application. This is the perfect location to insert the Splunk RUM Instrumentation Library as it will be loaded in all pages automatically.</p><p>Let&rsquo;s then edit the layout page:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi src/main/resources/templates/fragments/layout.html</span></span></code></pre></div><p>Next, insert the snippet we generated above in the <code>&lt;head></code> section of the page. Make sure you don&rsquo;t include the comment and replace <code>&lt;version></code> in the source URL to <code>latest</code> e.g.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!doctype html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span> <span class=na>th:fragment</span><span class=o>=</span><span class=s>&#34;layout (template, menu)&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js&#34;</span> <span class=na>crossorigin</span><span class=o>=</span><span class=s>&#34;anonymous&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nx>SplunkRum</span><span class=p>.</span><span class=nx>init</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>realm</span><span class=o>:</span> <span class=s2>&#34;eu0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>rumAccessToken</span><span class=o>:</span> <span class=s2>&#34;&lt;redacted&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>applicationName</span><span class=o>:</span> <span class=s2>&#34;petclinic-1be0-petclinic-service&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>deploymentEnvironment</span><span class=o>:</span> <span class=s2>&#34;petclinic-1be0-petclinic-env&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>...</span></span></code></pre></div><p>With the code changes complete, we need to rebuild the application and run it again. Run the <code>maven</code> command to compile/build/package PetClinic:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./mvnw package -Dmaven.test.skip<span class=o>=</span>true</span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>java <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dserver.port<span class=o>=</span><span class=m>8083</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dotel.service.name<span class=o>=</span><span class=nv>$INSTANCE</span>-petclinic-service <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dotel.resource.attributes<span class=o>=</span>deployment.environment<span class=o>=</span><span class=nv>$INSTANCE</span>-petclinic-env,version<span class=o>=</span>0.314 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-jar target/spring-petclinic-*.jar --spring.profiles.active<span class=o>=</span>mysql</span></span></code></pre></div><p>Then let&rsquo;s visit the application using a browser to generate real-user traffic <code>http://&lt;IP_ADDRESS>:8083</code>.</p><p>In RUM, filter down into the environment as defined in the RUM snippet above and click through to the dashboard.</p><p>When you drill down into a RUM trace you will see a link to APM in the spans. Clicking on the trace ID will take you to the corresponding APM trace for the current RUM trace.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=4-log-observer>4. Log Observer</h1><p>For the Splunk Log Observer component, the Splunk OpenTelemetry Collector automatically collects logs from the Spring PetClinic application and sends them to Splunk Observability Cloud using the OTLP exporter, anotating the log events with <code>trace_id</code>, <code>span_id</code> and trace flags.</p><p>Log Observer provides a real-time view of logs from your applications and infrastructure. It allows you to search, filter, and analyze logs to troubleshoot issues and monitor your environment.</p><p>Go back to the PetClinic web application and click on the <strong>Error</strong> link several times. This will generate some log messages in the PetClinic application logs.</p><p><a href=#R-image-b46225eace0d68a4209d4f8748f7489f class=lightbox-link><img alt="PetClinic Error" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/petclinic-error.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b46225eace0d68a4209d4f8748f7489f><img alt="PetClinic Error" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/petclinic-error.png></a></p><p>From the left-hand menu click on <strong>Log Observer</strong> and ensure <strong>Index</strong> is set to <strong>splunk4rookies-workshop</strong>.</p><p>Next, click <strong>Add Filter</strong> search for the field <code>service.name</code> select the value <code>&lt;INSTANCE>-petclinic-service</code> and click <code>=</code> (include). You should now see only the log messages from your PetClinic application.</p><p>Select one of the log entries that were generated by clicking on the <strong>Error</strong> link in the PetClinic application. You will see the log message and the trace metadata that was automatically injected into the log message. Also, you will notice that Related Content is available for APM and Infrastructure.</p><p><a href=#R-image-f48f51bbe738a550513bda9003e2d616 class=lightbox-link><img alt="Log Observer" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/log-observer.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-f48f51bbe738a550513bda9003e2d616><img alt="Log Observer" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/log-observer.png></a></p><p>This is the end of the workshop and we have certainly covered a lot of ground. At this point, you should have metrics, traces (APM & RUM), logs, database query performance and code profiling being reported into Splunk Observability Cloud and all without having to modify the PetClinic application code (well except for RUM).</p><p><strong>Congratulations!</strong></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=spring-petclinic-springboot-based-microservices-on-kubernetes>Spring PetClinic SpringBoot Based Microservices On Kubernetes</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>90 minutes</span>
</span>&nbsp;
<span class="badge cstyle blue badge-with-title"><span class=badge-title class=text-muted>Author
</span><span class=badge-content>Pieter Hagen</span></span><p>The goal of this workshop is to introduce the features of Splunk&rsquo;s <strong>automatic discovery and configuration</strong> for Java.</p><p>The workshop scenario will be created by installing a simple (<strong>un-instrumented</strong>) Java microservices application in Kubernetes.</p><p>Following simple steps to install the Splunk OpenTelemetry Collector with automatic discovery for existing Java based deployments, we will see how easy it is to send metrics, traces and logs to <strong>Splunk Observability Cloud</strong>.</p><details open class="box cstyle notices splunk"><summary class=box-label><i class="fa-fw fas fa-circle-info"></i>
Prerequisites</summary><div class=box-content><ul><li>Outbound SSH access to port <strong>2222</strong>.</li><li>Outbound HTTP access to port <strong>81</strong>.</li><li>Familiarity with the Linux command line.</li></ul></div></details><p>During this workshop we will cover the following components:</p><ul><li>Splunk Infrastructure Monitoring (<strong>IM</strong>)</li><li>Splunk automatic discovery and configuration for Java (<strong>APM</strong>)<ul><li>Database Query Performance</li><li>AlwaysOn Profiling</li></ul></li><li>Splunk Log Observer (<strong>LO</strong>)</li><li>Splunk Real User Monitoring (<strong>RUM</strong>)</li></ul><p><em>Splunk Synthetics is feeling a little left out here, but we cover that in other workshops</em> <i class="fa-fw fas fa-heart"></i></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 21, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of PetClinic Kubernetes Workshop</h1><article class=default><header class=headline></header><h1 id=architecture>Architecture</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>5 minutes</span>
</span>&nbsp;<p>The Spring PetClinic Java application is a simple microservices application that consists of frontend and backend services. The frontend service is a Spring Boot application that serves a web interface to interact with backend services. The backend services are Spring Boot applications that serve RESTful API&rsquo;s to interact with a MySQL database.</p><p>By the end of this workshop, you will have a better understanding of how to enable <strong>automatic discovery and configuration</strong> for your Java-based applications running in Kubernetes.</p><p>The diagram below details the architecture of the Spring PetClinic Java application running in Kubernetes with the Splunk OpenTelemetry Operator and automatic discovery and configuration enabled.</p><p><a href=#R-image-04ef23335c7eeaeee4e18ada014e9065 class=lightbox-link><img alt="Splunk Otel Architecture" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/auto-instrumentation-java-diagram.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-04ef23335c7eeaeee4e18ada014e9065><img alt="Splunk Otel Architecture" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/auto-instrumentation-java-diagram.png></a></p><hr><p>Based on the <a href=https://github.com/signalfx/splunk-otel-collector-chart/blob/main/examples/enable-operator-and-auto-instrumentation/spring-petclinic-java.md rel=external target=_blank><strong>example</strong></a> <strong>Josh Voravong</strong> created.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 21, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=preparation-of-the-workshop-instance>Preparation of the Workshop instance</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>15 minutes</span>
</span>&nbsp;<p>The instructor will provide you with the login information for the instance that we will be using during the workshop.</p><p>When you first log into your instance, you will be greeted by the Splunk Logo as shown below. If you have any issues connecting to your workshop instance, please reach out to your Instructor.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ ssh -p 2222 splunk@&lt;IP-ADDRESS&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—     â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—  
</span></span><span class=line><span class=cl>â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•    â•šâ–ˆâ–ˆâ•— 
</span></span><span class=line><span class=cl>â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•      â•šâ–ˆâ–ˆâ•—
</span></span><span class=line><span class=cl>â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•—      â–ˆâ–ˆâ•”â•
</span></span><span class=line><span class=cl>â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•”â• 
</span></span><span class=line><span class=cl>â•šâ•â•â•â•â•â•â•â•šâ•â•     â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•â•â•šâ•â•  â•šâ•â•    â•šâ•â•  
</span></span><span class=line><span class=cl>Last login: Mon Feb  5 11:04:54 2024 from [Redacted]
</span></span><span class=line><span class=cl>splunk@show-no-config-i-0d1b29d967cb2e6ff ~ $</span></span></code></pre></div><p>To ensure your instance is configured correctly, we need to confirm that the required environment variables for this workshop are set correctly. In your terminal, run the following script and check that the environment variables are present and set with actual valid values:</p><div class=tab-panel data-tab-group=52a571d4f84e53348ed909f885688d10><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("52a571d4f84e53348ed909f885688d10","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("52a571d4f84e53348ed909f885688d10","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ~/workshop/petclinic/scripts/check_env.sh</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>ACCESS_TOKEN</span> <span class=o>=</span> &lt;redacted&gt;
</span></span><span class=line><span class=cl><span class=nv>REALM</span> <span class=o>=</span> &lt;e.g. eu0, us1, us2, jp0, au0 etc.&gt;
</span></span><span class=line><span class=cl><span class=nv>RUM_TOKEN</span> <span class=o>=</span> &lt;redacted&gt;
</span></span><span class=line><span class=cl><span class=nv>HEC_TOKEN</span> <span class=o>=</span> &lt;redacted&gt;
</span></span><span class=line><span class=cl><span class=nv>HEC_URL</span> <span class=o>=</span> https://&lt;...&gt;/services/collector/event
</span></span><span class=line><span class=cl><span class=nv>INSTANCE</span> <span class=o>=</span> &lt;instance_name&gt;</span></span></code></pre></div></div></div></div></div><p>Please make a note of the <code>INSTANCE</code> environment variable value as this will be used later to filter data in <strong>Splunk Observability Cloud</strong>.</p><p>For this workshop, <strong>all</strong> the above environment variables are required. If any have values missing, please contact your Instructor.</p><details open class="box cstyle notices splunk"><summary class=box-label><i class="fa-fw fas fa-circle-info"></i>
Delete any existing OpenTelemetry Collectors</summary><div class=box-content><p>If you have previously completed a Splunk Observability workshop using this EC2 instance, you
need to ensure that any existing installation of the Splunk OpenTelemetry Collector is
deleted. This can be achieved by running the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm delete splunk-otel-collector</span></span></code></pre></div></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>May 7, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 2. Preparation</h1><article class=default><header class=headline></header><h1 id=deploy-the-splunk-opentelemetry-collector>Deploy the Splunk OpenTelemetry Collector</h1><p>To get Observability signals (<strong>metrics, traces</strong> and <strong>logs</strong>) into <strong>Splunk Observability Cloud</strong> we need to deploy the Splunk OpenTelemetry Collector into the Kubernetes cluster.</p><p>For this workshop, we will be using the Splunk OpenTelemetry Collector Helm Chart. First, we need to add the Helm chart repository to Helm and run <code>helm repo update</code> to ensure the latest version:</p><div class=tab-panel data-tab-group=2aaefa170db378d9d1e4f073d53cdfa0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=install-helm-chart class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2aaefa170db378d9d1e4f073d53cdfa0","install-helm-chart")'>
<span class=tab-nav-text>Install Helm Chart</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("2aaefa170db378d9d1e4f073d53cdfa0","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=install-helm-chart class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm repo add splunk-otel-collector-chart https://signalfx.github.io/splunk-otel-collector-chart <span class=o>&amp;&amp;</span> helm repo update</span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Using ACCESS_TOKEN={REDACTED}
</span></span><span class=line><span class=cl>Using REALM=eu0
</span></span><span class=line><span class=cl>&#34;splunk-otel-collector-chart&#34; has been added to your repositories
</span></span><span class=line><span class=cl>Using ACCESS_TOKEN={REDACTED}
</span></span><span class=line><span class=cl>Using REALM=eu0
</span></span><span class=line><span class=cl>Hang tight while we grab the latest from your chart repositories...
</span></span><span class=line><span class=cl>...Successfully got an update from the &#34;splunk-otel-collector-chart&#34; chart repository
</span></span><span class=line><span class=cl>Update Complete. âŽˆHappy Helming!âŽˆ</span></span></code></pre></div></div></div></div></div><p><strong>Splunk Observability Cloud</strong> offers wizards in the UI to walk you through the setup of the OpenTelemetry Collector on Kubernetes, but in the interest of time, we will use the Helm install command below. Additional parameters are set to enable the operator for automatic discovery and configuration and code profiling.</p><ul><li><code>--set="operator.enabled=true"</code> - this will install the OpenTelemetry operator that will be used to handle automatic discovery and configuration.</li><li><code>--set="splunkObservability.profilingEnabled=true"</code> - this enables Code Profiling via the operator.</li></ul><p>To install the collector run the following command. Do <strong>NOT</strong> edit this:</p><div class=tab-panel data-tab-group=6813796953341bff38940ed5186d6881><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=helm-install class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6813796953341bff38940ed5186d6881","helm-install")'>
<span class=tab-nav-text>Helm Install</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("6813796953341bff38940ed5186d6881","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=helm-install class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm install splunk-otel-collector --version 0.120.0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;operatorcrds.install=true&#34;</span>, <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;operator.enabled=true&#34;</span>, <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.realm=</span><span class=nv>$REALM</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.accessToken=</span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;clusterName=</span><span class=nv>$INSTANCE</span><span class=s2>-k3s-cluster&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.profilingEnabled=true&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;agent.service.enabled=true&#34;</span>  <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;environment=</span><span class=nv>$INSTANCE</span><span class=s2>-workshop&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkPlatform.endpoint=</span><span class=nv>$HEC_URL</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkPlatform.token=</span><span class=nv>$HEC_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkPlatform.index=splunk4rookies-workshop&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>splunk-otel-collector-chart/splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-f ~/workshop/k3s/otel-collector.yaml</span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>LAST DEPLOYED: Fri Apr 19 09:39:54 2024
</span></span><span class=line><span class=cl>NAMESPACE: default
</span></span><span class=line><span class=cl>STATUS: deployed
</span></span><span class=line><span class=cl>REVISION: 1
</span></span><span class=line><span class=cl>NOTES:
</span></span><span class=line><span class=cl>Splunk OpenTelemetry Collector is installed and configured to send data to Splunk Platform endpoint &#34;https://http-inputs-o11y-workshop-eu0.splunkcloud.com:443/services/collector/event&#34;.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Splunk OpenTelemetry Collector is installed and configured to send data to Splunk Observability realm eu0.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[INFO] You&#39;ve enabled the operator&#39;s auto-instrumentation feature (operator.enabled=true)! The operator can automatically instrument Kubernetes hosted applications.
</span></span><span class=line><span class=cl>  - Status: Instrumentation language maturity varies. See `operator.instrumentation.spec` and documentation for utilized instrumentation details.
</span></span><span class=line><span class=cl>  - Splunk Support: We offer full support for Splunk distributions and best-effort support for native OpenTelemetry distributions of auto-instrumentation libraries.</span></span></code></pre></div></div></div></div></div><p>Ensure the Pods are reported as <strong>Running</strong> before continuing (this typically takes around 30 seconds).</p><div class=tab-panel data-tab-group=1eaa198c5b25d4a2d4b3563ddd5a1fd7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=kubectl-get-pods class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1eaa198c5b25d4a2d4b3563ddd5a1fd7","kubectl-get-pods")'>
<span class=tab-nav-text>kubectl get pods</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("1eaa198c5b25d4a2d4b3563ddd5a1fd7","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=kubectl-get-pods class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pods <span class=p>|</span> grep splunk-otel </span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>splunk-otel-collector-k8s-cluster-receiver-6bd5567d95-5f8cj     1/1     Running   0          10m
</span></span><span class=line><span class=cl>splunk-otel-collector-agent-tspd2                               1/1     Running   0          10m
</span></span><span class=line><span class=cl>splunk-otel-collector-operator-69d476cb7-j7zwd                  2/2     Running   0          10m</span></span></code></pre></div></div></div></div></div><p>Ensure there are no errors reported by the Splunk OpenTelemetry Collector (press <code>ctrl + c</code> to exit) or use the installed <strong>awesome</strong> <code>k9s</code> terminal UI for bonus points!</p><div class=tab-panel data-tab-group=0f15414c120f7c4db4ddb78194468513><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=kubectl-logs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0f15414c120f7c4db4ddb78194468513","kubectl-logs")'>
<span class=tab-nav-text>kubectl logs</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("0f15414c120f7c4db4ddb78194468513","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=kubectl-logs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl logs -l <span class=nv>app</span><span class=o>=</span>splunk-otel-collector -f --container otel-collector</span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>2021-03-21T16:11:10.900Z        INFO    service/service.go:364  Starting receivers...
</span></span><span class=line><span class=cl>2021-03-21T16:11:10.900Z        INFO    builder/receivers_builder.go:70 Receiver is starting... {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;prometheus&#34;, &#34;component_name&#34;: &#34;prometheus&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    builder/receivers_builder.go:75 Receiver started.       {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;prometheus&#34;, &#34;component_name&#34;: &#34;prometheus&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    builder/receivers_builder.go:70 Receiver is starting... {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    k8sclusterreceiver@v0.21.0/watcher.go:195       Configured Kubernetes MetadataExporter  {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;, &#34;exporter_name&#34;: &#34;signalfx&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    builder/receivers_builder.go:75 Receiver started.       {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    healthcheck/handler.go:128      Health Check state change       {&#34;component_kind&#34;: &#34;extension&#34;, &#34;component_type&#34;: &#34;health_check&#34;, &#34;component_name&#34;: &#34;health_check&#34;, &#34;status&#34;: &#34;ready&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    service/service.go:267  Everything is ready. Begin running and processing data.
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    k8sclusterreceiver@v0.21.0/receiver.go:59       Starting shared informers and wait for initial cache sync.      {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.281Z        INFO    k8sclusterreceiver@v0.21.0/receiver.go:75       Completed syncing shared informer caches.       {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;}</span></span></code></pre></div></div></div></div></div><details open class="box cstyle notices info"><summary class=box-label><i class="fa-fw fas fa-info-circle"></i>
Deleting a failed installation</summary><div class=box-content><p>If you make an error installing the OpenTelemetry Collector you can start over by deleting the
installation with the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm delete splunk-otel-collector</span></span></code></pre></div></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>May 7, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=deploy-the-petclinic-application>Deploy the PetClinic Application</h1><p>The first deployment of our application will be using prebuilt containers to give this base scenario: a regular Java microservices-based application running in Kubernetes that we want to start observing. So let&rsquo;s deploy the application:</p><div class=tab-panel data-tab-group=0b8060061cce0adafb9a8ab2f1efe44a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=kubectl-apply class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0b8060061cce0adafb9a8ab2f1efe44a","kubectl-apply")'>
<span class=tab-nav-text>kubectl apply</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("0b8060061cce0adafb9a8ab2f1efe44a","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=kubectl-apply class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f ~/workshop/petclinic/deployment.yaml</span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>deployment.apps/config-server created
</span></span><span class=line><span class=cl>service/config-server created
</span></span><span class=line><span class=cl>deployment.apps/discovery-server created
</span></span><span class=line><span class=cl>service/discovery-server created
</span></span><span class=line><span class=cl>deployment.apps/api-gateway created
</span></span><span class=line><span class=cl>service/api-gateway created
</span></span><span class=line><span class=cl>service/api-gateway-external created
</span></span><span class=line><span class=cl>deployment.apps/customers-service created
</span></span><span class=line><span class=cl>service/customers-service created
</span></span><span class=line><span class=cl>deployment.apps/vets-service created
</span></span><span class=line><span class=cl>service/vets-service created
</span></span><span class=line><span class=cl>deployment.apps/visits-service created
</span></span><span class=line><span class=cl>service/visits-service created
</span></span><span class=line><span class=cl>deployment.apps/admin-server created
</span></span><span class=line><span class=cl>service/admin-server created
</span></span><span class=line><span class=cl>service/petclinic-db created
</span></span><span class=line><span class=cl>deployment.apps/petclinic-db created
</span></span><span class=line><span class=cl>configmap/petclinic-db-initdb-config created
</span></span><span class=line><span class=cl>deployment.apps/petclinic-loadgen-deployment created
</span></span><span class=line><span class=cl>configmap/scriptfile created</span></span></code></pre></div></div></div></div></div><p>At this point, we can verify the deployment by checking that the Pods are running. The containers need to be downloaded and started, so this may take a couple of minutes.</p><div class=tab-panel data-tab-group=aaa8b13d0f3f32f909d8feabf0c67076><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=kubectl-get-pods class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("aaa8b13d0f3f32f909d8feabf0c67076","kubectl-get-pods")'>
<span class=tab-nav-text>kubectl get pods</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("aaa8b13d0f3f32f909d8feabf0c67076","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=kubectl-get-pods class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pods</span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>NAME                                                            READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>splunk-otel-collector-k8s-cluster-receiver-655dcd9b6b-dcvkb     1/1     Running   <span class=m>0</span>          114s
</span></span><span class=line><span class=cl>splunk-otel-collector-agent-dg2vj                               1/1     Running   <span class=m>0</span>          114s
</span></span><span class=line><span class=cl>splunk-otel-collector-operator-57cbb8d7b4-dk5wf                 2/2     Running   <span class=m>0</span>          114s
</span></span><span class=line><span class=cl>petclinic-db-64d998bb66-2vzpn                                   1/1     Running   <span class=m>0</span>          58s
</span></span><span class=line><span class=cl>api-gateway-d88bc765-jd5lg                                      1/1     Running   <span class=m>0</span>          58s
</span></span><span class=line><span class=cl>visits-service-7f97b6c579-bh9zj                                 1/1     Running   <span class=m>0</span>          58s
</span></span><span class=line><span class=cl>admin-server-76d8b956c5-mb2zv                                   1/1     Running   <span class=m>0</span>          58s
</span></span><span class=line><span class=cl>customers-service-847db99f79-mzlg2                              1/1     Running   <span class=m>0</span>          58s
</span></span><span class=line><span class=cl>vets-service-7bdcd7dd6d-2tcfd                                   1/1     Running   <span class=m>0</span>          58s
</span></span><span class=line><span class=cl>petclinic-loadgen-deployment-5d69d7f4dd-xxkn4                   1/1     Running   <span class=m>0</span>          58s
</span></span><span class=line><span class=cl>config-server-67f7876d48-qrsr5                                  1/1     Running   <span class=m>0</span>          58s
</span></span><span class=line><span class=cl>discovery-server-554b45cfb-bqhgt                                1/1     Running   <span class=m>0</span>          58s</span></span></code></pre></div></div></div></div></div><p>Make sure the output of <code>kubectl get pods</code> matches the output as shown in the above Output tab. Ensure all the services are shown as <strong>Running</strong> (or use <code>k9s</code> to continuously monitor the status).</p><p>To test the application, you need to obtain the public IP address of your instance. You can do this by running the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://ifconfig.me</span></span></code></pre></div><p>Validate if the application is running by visiting <strong>http://&lt;IP_ADDRESS>:81</strong> (replace <strong>&lt;IP_ADDRESS></strong> with the IP address you obtained above). You should see the PetClinic application running. The application is also running on ports <strong>80</strong> & <strong>443</strong> if you prefer to use those or port <strong>81</strong> is unreachable.</p><p><a href=#R-image-0c94ad6b330086a8e96a624fe5d22152 class=lightbox-link><img alt="Pet shop" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/petclinic.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-0c94ad6b330086a8e96a624fe5d22152><img alt="Pet shop" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/petclinic.png></a></p><p>Make sure the application is working correctly by visiting the <strong>All Owners</strong> <strong>(1)</strong> and <strong>Veterinarians</strong> <strong>(2)</strong> tabs, confirming that you see a list of names on each page.</p><p><a href=#R-image-44d569618545b5c1d9d0a1f55b13c578 class=lightbox-link><img alt=Owners class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/petclinic-owners.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-44d569618545b5c1d9d0a1f55b13c578><img alt=Owners class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/petclinic-owners.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>May 7, 2025</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=verify-kubernetes-cluster-metrics>Verify Kubernetes Cluster metrics</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<p>Once the installation has completed, you can log in to <strong>Splunk Observability Cloud</strong> and verify that the metrics are flowing in from your Kubernetes cluster.</p><p>From the left-hand menu, click on <strong>Infrastructure</strong> and select <strong>Kubernetes</strong>, then select the <strong>Kubernetes nodes</strong> pane. Once you are in the <strong>Kubernetes nodes</strong> view, change the <strong>Time</strong> filter from <strong>-4h</strong> to the last 15 minutes <strong>(-15m)</strong> to focus on the latest data.</p><p>Next, from the list of nodes, select the Node name of your workshop instance. Note: You can get the unique part from your cluster name by using the <code>INSTANCE</code> from the output from the shell script you ran earlier. <strong>(1)</strong></p><p><a href=#R-image-9b87aab88b29c0aee2d41c482aa1c0f4 class=lightbox-link><img alt=NavigatorList class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/navigatorlist.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-9b87aab88b29c0aee2d41c482aa1c0f4><img alt=NavigatorList class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/navigatorlist.png></a></p><p>Open the <strong>Hierarchy Map</strong> by clicking on the <em>Hierarchy Map</em> link in the gray pane to show the graphical representation of your node.</p><p><a href=#R-image-8dcf6e43911cedb262f4aa4cb5dec1bf class=lightbox-link><img alt=HeirarchyMap class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/hierarchymap.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8dcf6e43911cedb262f4aa4cb5dec1bf><img alt=HeirarchyMap class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/hierarchymap.png></a></p><p>You will now only have your cluster visible. Scroll down the page to see the metrics coming in from your cluster. Locate the <strong>Node log events rate</strong> <strong>(1)</strong> chart and click on a vertical bar to see the log entries coming in from your cluster.</p><p><a href=#R-image-40feca6556a420a818565350eeaf4c43 class=lightbox-link><img alt=Logs class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/k8s-peek-at-logs.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-40feca6556a420a818565350eeaf4c43><img alt=Logs class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/k8s-peek-at-logs.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>May 7, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=setting-up-automatic-discovery-and-configuration-for-apm>Setting up automatic discovery and configuration for APM</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<p>In this section, we will enable <strong>automatic discovery and configuration</strong> for the Java services running in Kubernetes. This means that the OpenTelemetry Collector will look for Pod annotations that indicate that the Java application should be instrumented with the Splunk OpenTelemetry Java agent. This will allow us to get traces, spans, and profiling data from Java services running on the cluster.</p><details open class="box cstyle notices note"><summary class=box-label><i class="fa-fw fas fa-exclamation-circle"></i>
automatic discovery and configuration</summary><div class=box-content><p>It is important to understand that automatic discovery and configuration is designed to get <strong>trace, span & profiling</strong> data out of your application <strong>without requiring code changes or recompilation</strong>.</p><p>This is a great way to get started with APM, but it is <strong>not</strong> a replacement for manual instrumentation. Manual instrumentation allows you to add custom spans, tags, and logs to your application, which can provide more context and detail to your traces.</p></div></details><p>For Java applications, the OpenTelemetry Collector will look for the annotation <code>instrumentation.opentelemetry.io/inject-java</code>.</p><p>The annotation can have the value set to <code>true</code> or to the <code>namespace/daemonset</code> of the OpenTelemetry Collector e.g. <code>default/splunk-otel-collector</code>. This allows working across namespaces and is what we will use in this workshop.</p><details open class="box cstyle notices info"><summary class=box-label><i class="fa-fw fas fa-info-circle"></i>
Using the deployment.yaml</summary><div class=box-content><p>If you want your Pods to send traces automatically, you can add the annotation to the <code>deployment.yaml</code> as shown below. This will add the instrumentation library during the initial deployment. To speed things up we have done that for the following Pods:</p><ul><li><strong>admin-server</strong></li><li><strong>config-server</strong></li><li><strong>discovery-server</strong></li></ul><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>admin-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/part-of</span><span class=p>:</span><span class=w> </span><span class=l>spring-petclinic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>admin-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>admin-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>instrumentation.opentelemetry.io/inject-java</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;default/splunk-otel-collector&#34;</span></span></span></code></pre></div></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 21, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 4. Automatic discovery and configuration</h1><article class=default><header class=headline></header><h1 id=patching-the-deployment>Patching the Deployment</h1><p>To configure <strong>automatic discovery and configuration</strong>, the deployments need to be patched to add the instrumentation annotation. Once patched, the OpenTelemetry Collector will inject the automatic discovery and configuration library and the Pods will be restarted in order to start sending traces and profiling data. First, confirm that the <code>api-gateway</code> does not have the <code>splunk-otel-java</code> image by running the following:</p><div class=tab-panel data-tab-group=d58a9c43ab1589c5a456399534aba0fb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=describe-api-gateway class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d58a9c43ab1589c5a456399534aba0fb","describe-api-gateway")'>
<span class=tab-nav-text>Describe api-gateway</span>
</button>
<button data-tab-item=describe-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("d58a9c43ab1589c5a456399534aba0fb","describe-output")'>
<span class=tab-nav-text>Describe Output</span></button></div><div class=tab-content-container><div data-tab-item=describe-api-gateway class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe pods api-gateway <span class=p>|</span> grep Image:</span></span></code></pre></div></div></div><div data-tab-item=describe-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Image:         quay.io/phagen/spring-petclinic-api-gateway:0.0.2</span></span></code></pre></div></div></div></div></div><p>Next, enable the Java automatic discovery and configuration for all the services by adding the annotation to the deployments. The following command will patch the all deployments. This will trigger the OpenTelemetry Operator to inject the <code>splunk-otel-java</code> image into the Pods:</p><div class=tab-panel data-tab-group=4b57dd2c678ef7fe01116b4025e3e123><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=patch-all-petclinic-services class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4b57dd2c678ef7fe01116b4025e3e123","patch-all-petclinic-services")'>
<span class=tab-nav-text>Patch all PetClinic services</span>
</button>
<button data-tab-item=patch-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("4b57dd2c678ef7fe01116b4025e3e123","patch-output")'>
<span class=tab-nav-text>Patch Output</span></button></div><div class=tab-content-container><div data-tab-item=patch-all-petclinic-services class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get deployments -l app.kubernetes.io/part-of<span class=o>=</span>spring-petclinic -o name <span class=p>|</span> xargs -I % kubectl patch % -p <span class=s2>&#34;{\&#34;spec\&#34;: {\&#34;template\&#34;:{\&#34;metadata\&#34;:{\&#34;annotations\&#34;:{\&#34;instrumentation.opentelemetry.io/inject-java\&#34;:\&#34;default/splunk-otel-collector\&#34;}}}}}&#34;</span></span></span></code></pre></div></div></div><div data-tab-item=patch-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>deployment.apps/config-server patched (no change)
</span></span><span class=line><span class=cl>deployment.apps/admin-server patched (no change)
</span></span><span class=line><span class=cl>deployment.apps/customers-service patched
</span></span><span class=line><span class=cl>deployment.apps/visits-service patched
</span></span><span class=line><span class=cl>deployment.apps/discovery-server patched (no change)
</span></span><span class=line><span class=cl>deployment.apps/vets-service patched
</span></span><span class=line><span class=cl>deployment.apps/api-gateway patched</span></span></code></pre></div></div></div></div></div><p>There will be no change for the <strong>config-server</strong>, <strong>discovery-server</strong> and <strong>admin-server</strong> as these have already been patched.</p><p>To check the container image(s) of the <code>api-gateway</code> pod again, run the following command:</p><div class=tab-panel data-tab-group=c4a0bda932146ff292f354eeb0d172da><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=describe-api-gateway class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c4a0bda932146ff292f354eeb0d172da","describe-api-gateway")'>
<span class=tab-nav-text>Describe api-gateway</span>
</button>
<button data-tab-item=describe-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("c4a0bda932146ff292f354eeb0d172da","describe-output")'>
<span class=tab-nav-text>Describe Output</span></button></div><div class=tab-content-container><div data-tab-item=describe-api-gateway class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe pods api-gateway <span class=p>|</span> grep Image:</span></span></code></pre></div></div></div><div data-tab-item=describe-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Image:         ghcr.io/signalfx/splunk-otel-java/splunk-otel-java:v1.30.0
</span></span><span class=line><span class=cl>Image:         quay.io/phagen/spring-petclinic-api-gateway:0.0.2</span></span></code></pre></div></div></div></div></div><p>A new image has been added to the <code>api-gateway</code> which will pull <code>splunk-otel-java</code> from <code>ghcr.io</code> (Note: if you see two <code>api-gateway</code> containers, the original one is probably still terminating, so give it a few seconds).</p><p>Navigate back to the Kubernetes Navigator in <strong>Splunk Observability Cloud</strong>. After a couple of minutes, you will see that the Pods are being restarted by the operator and the automatic discovery and configuration container will be added. This will look similar to the screenshot below:</p><p><a href=#R-image-bdd84d0cdea930eb1a90b9894f157f39 class=lightbox-link><img alt=restart class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/k8s-navigator-restarted-pods.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-bdd84d0cdea930eb1a90b9894f157f39><img alt=restart class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/k8s-navigator-restarted-pods.png></a></p><p>Wait for the Pods to turn green in the Kubernetes Navigator, then go tho the next section.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>May 7, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=viewing-the-data-in-splunk-apm>Viewing the data in Splunk APM</h1><p>In the left-hand menu click on <strong>APM</strong> to see the data generated by the traces from the newly instrumented services. Change the <strong>Environment</strong> filter <strong>(1)</strong> to the name of your workshop instance in the dropdown box. (Note: this will be <strong><code>&lt;INSTANCE>-workshop</code></strong> where <strong><code>INSTANCE</code></strong> is the value from the shell script you ran earlier. Ensure it is the only one selected.)</p><p><a href=#R-image-ac9389a78199980ec3a6c031f61dd46c class=lightbox-link><img alt=apm class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/zero-config-first-services-overview.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ac9389a78199980ec3a6c031f61dd46c><img alt=apm class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/zero-config-first-services-overview.png></a></p><p>If you see a Critical Alert, you can ignore it as it is caused by the sudden request increase generated by the load generator <strong>(2)</strong>. Click on the <strong>Service Map</strong> <strong>(3)</strong> pane to get ready for the next section.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>May 7, 2025</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=apm-features>APM Features</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>15 minutes</span>
</span>&nbsp;<p>As we have seen in the previous section, once you enable <strong>automatic discovery and configuration</strong> on your services, traces are sent to <strong>Splunk Observability Cloud</strong>.</p><p>With these traces, Splunk will automatically generate <strong>Service Maps</strong> and <strong>RED Metrics</strong>. These are the first steps in understanding the behavior of your services and how they interact with each other.</p><p>In this next section, we are going to examine the traces themselves and the information they provide to help you understand the behavior of your services &ndash; all without touching your code!</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 21, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 5. APM Features</h1><article class=default><header class=headline></header><h1 id=apm-service-map>APM Service Map</h1><p><a href=#R-image-40e707d26e18039499b9037a463c5e30 class=lightbox-link><img alt="apm map" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/zero-config-first-services-map.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-40e707d26e18039499b9037a463c5e30><img alt="apm map" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/zero-config-first-services-map.png></a></p><p>The above map shows all the interactions between all the services. The map may still be in an interim state as it will take the PetClinic Microservice application a few minutes to start up and fully synchronize. Reducing the time filter to a custom time of <strong>2 minutes</strong> by entering <strong>-2m</strong> will help. You can click on the <strong>Refresh</strong> button <strong>(1)</strong> in the top right-hand corner of the screen. The initial startup-related errors indicated by red circles will eventually disappear.</p><p>Next, let&rsquo;s examine the metrics that are available for each service that is instrumented by visiting the request, error, and duration (RED) metrics Dashboard.</p><p>For this exercise, we are going to use a common scenario you would use if your service operation was showing high latency or errors.</p><p>Click on <strong>customers-service</strong> in the Dependency map, then make sure the <code>customers-service</code> is selected in the <strong>Services</strong> dropdown box <strong>(1)</strong>. Next, select <code>GET /owners</code> from the Operations dropdown <strong>(2)</strong> adjacent to the Service name.</p><p>This should give you the workflow with a filter on <code>GET /owners</code> as shown below:</p><p><a href=#R-image-2945cd1cfe3c16ffe8ac18afeae0eaf0 class=lightbox-link><img alt="select a trace" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/select-workflow.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-2945cd1cfe3c16ffe8ac18afeae0eaf0><img alt="select a trace" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/select-workflow.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>May 7, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=apm-trace>APM Trace</h1><p>To pick a trace, select a line in the <code>Service Requests & Errors</code> chart <strong>(1)</strong>. A selection of related traces will appear.</p><p>Once you have the list of related traces, click on the blue <strong>(2)</strong> Trace ID Link, making sure the trace you select has the same three services mentioned in the Services Column.</p><p><a href=#R-image-3bda1d71dd4b2e5450e787b710aa0954 class=lightbox-link><img alt=workflow-trace-pick class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/selecting-a-trace.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-3bda1d71dd4b2e5450e787b710aa0954><img alt=workflow-trace-pick class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/selecting-a-trace.png></a></p><p>This brings us to the selected Trace in the Waterfall view:</p><p>Here we find several sections:</p><ul><li>The Waterfall Pane <strong>(1)</strong>, where you see the trace and all the instrumented functions visible as spans, with their duration representation and order/relationship showing.</li><li>The Trace Info Pane <strong>(2)</strong>, which shows the selected Span information (highlighted with a box around the Span in the Waterfall Pane).</li><li>The Span Pane <strong>(3)</strong> where you can find all the Tags that have been sent in the selected Span. You can scroll down to see all of them.</li><li>The process Pane, with tags related to the process that created the Span (scroll down to see as it is not in the screenshot).</li><li>The Trace Properties, located at the top right-hand side of the pane is collapsed by default.</li></ul><p><a href=#R-image-76e9f5ced7a0b471f8607731d1e3b18d class=lightbox-link><img alt=waterfall class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/waterfall-view.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-76e9f5ced7a0b471f8607731d1e3b18d><img alt=waterfall class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/waterfall-view.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 21, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=apm-span>APM Span</h1><p>While we examine our spans, let&rsquo;s look at several out-of-the-box features that you get <strong>without code modifications</strong> when using <strong>automatic discovery and configuration</strong> on top of tracing:</p><p>First, in the Waterfall Pane, make sure the <code>customers-service:SELECT petclinic</code> or similar span is selected as shown in the screenshot below:</p><p><a href=#R-image-80753c7a2279fbaf2e98d948cec998ba class=lightbox-link><img alt=DB-query class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/db-query.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-80753c7a2279fbaf2e98d948cec998ba><img alt=DB-query class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/db-query.png></a></p><ul><li>The basic latency information is shown as a bar for the instrumented function or call. In our example above, it took 17.8 Milliseconds.</li><li>Several similar Spans <strong>(1)</strong> are only visible if the span is repeated multiple times. In this case, there are 10 repeats in our example. You can show/hide them all by clicking on the <code>10x</code> and all spans will show in order.</li><li><strong>Inferred Services</strong>: Calls made to external systems that are not instrumented show up as a grey &lsquo;inferred&rsquo; span. The Inferred Service or span in our example is a call to the Mysql Database <code>mysql:petclinic SELECT petclinic</code> <strong>(2)</strong> as shown above.</li><li><strong>Span Tags</strong>: In the Tag Pane, we see standard tags produced by the automatic discovery and configuration. In this case, the span is calling a Database, so it includes the <code>db.statement</code> tag <strong>(3)</strong>. This tag will hold the DB query statement and is used by the Database call performed during this span. This will be used by the DB-Query Performance feature. We look at DB-Query Performance in the next section.</li><li><strong>Always-on Profiling</strong>: <strong>IF</strong> the system is configured to capture Profiling data during a Span life cycle. It will show the number of Call Stacks captured in the Spans timeline. In our example above, we see 18 Call Stacks for the <code>customer-service:GET /owners</code> Span. <strong>(4)</strong></li></ul><p>We will look at Profiling in the next section.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 21, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=service-centric-view>Service Centric View</h1><p>Splunk APM provide <strong>Service Centric Views</strong> that provide engineers a deep understanding of service performance in one centralized view. Now, across every service, engineers can quickly identify errors or bottlenecks from a serviceâ€™s underlying infrastructure, pinpoint performance degradation from new deployments, and visualize the health of every third party dependency.</p><p>To see this dashboard for the <code>api-gateway</code>, click on <strong>APM</strong> from the left-hand menu and then click on the <code>api-gateway</code> service in the list. This will bring you to the Service Centric View dashboard:</p><p><a href=#R-image-d20d0365a1a5a8341f5eb689d9224889 class=lightbox-link><img alt=service_maps class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/service-view.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d20d0365a1a5a8341f5eb689d9224889><img alt=service_maps class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/service-view.png></a></p><p>This view, which is available for each of your instrumented services, offers an overview of <strong>Service metrics</strong>, <strong>Error breakdown</strong>, <strong>Runtime metrics (Java)</strong> and <strong>Infrastructure metrics</strong>.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>May 7, 2025</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=always-on-profiling--db-query-performance>Always-On Profiling & DB Query Performance</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>15 minutes</span>
</span>&nbsp;<p>As we have seen in the previous chapter, you can trace your interactions between the various services using APM without touching your code, allowing you to identify issues faster.</p><p>In addition to tracing, <strong>automatic discovery and configuration</strong> offers additional features out of the box that can help you find issues even faster! In this section we are going to look at two of them:</p><ul><li><strong>Always-on Profiling and Java Metrics</strong></li><li><strong>Database Query Performance</strong></li></ul><p>If you want to dive deeper into Always-on Profiling or DB-Query performance, we have a separate Ninja Workshop called <a href=/observability-workshop/v5.90/en/scenarios/debug_problems/index.html><strong>Debug Problems in Microservices</strong></a> that you can follow.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 21, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 6. Advanced Features</h1><article class=default><header class=headline></header><h1 id=always-on-profiling--metrics>Always-On Profiling & Metrics</h1><p>When we installed the Splunk Distribution of the OpenTelemetry Collector using the Helm chart earlier, we configured it to enable <strong>AlwaysOn Profiling</strong> and <strong>Metrics</strong>. This means that OpenTelemetry Java will automatically generate CPU and Memory profiling for the application, sending them to Splunk Observability Cloud.</p><p>When you deploy the PetClinic application and set the annotation, the collector automatically detects the application and instruments it for traces and profiling. We can verify this by examining the startup logs of one of the Java containers we are instrumenting by running the following script:</p><p>The logs will show the flags that were picked up by the Java automatic discovery and configuration:</p><p><div class=tab-panel data-tab-group=ed99105ba344e32b6079b3d780677e06><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=run-the-script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ed99105ba344e32b6079b3d780677e06","run-the-script")'>
<span class=tab-nav-text>Run the script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("ed99105ba344e32b6079b3d780677e06","example-output")'>
<span class=tab-nav-text>Example output</span></button></div><div class=tab-content-container><div data-tab-item=run-the-script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0><code class=language-logs data-lang=logs>.  ~/workshop/petclinic/scripts/get_logs.sh</code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>2024/02/15 09:42:00 Problem with dial: dial tcp 10.43.104.25:8761: connect: connection refused. Sleeping 1s
</span></span><span class=line><span class=cl>2024/02/15 09:42:01 Problem with dial: dial tcp 10.43.104.25:8761: connect: connection refused. Sleeping 1s
</span></span><span class=line><span class=cl>2024/02/15 09:42:02 Connected to tcp://discovery-server:8761
</span></span><span class=line><span class=cl>Picked up JAVA_TOOL_OPTIONS:  -javaagent:/otel-auto-instrumentation-java/javaagent.jar
</span></span><span class=line><span class=cl>Picked up _JAVA_OPTIONS: -Dspring.profiles.active=docker,mysql -Dsplunk.profiler.call.stack.interval=150
</span></span><span class=line><span class=cl>OpenJDK 64-Bit Server VM warning: Sharing is only supported for boot loader classes because bootstrap classpath has been appended
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:03:056 +0000] [main] INFO io.opentelemetry.javaagent.tooling.VersionLogger - opentelemetry-javaagent - version: splunk-1.30.1-otel-1.32.1
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:03:768 +0000] [main] INFO com.splunk.javaagent.shaded.io.micrometer.core.instrument.push.PushMeterRegistry - publishing metrics for SignalFxMeterRegistry every 30s
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:478 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger - -----------------------
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:478 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger - Profiler configuration:
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:480 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -                  splunk.profiler.enabled : true
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:505 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -                splunk.profiler.directory : /tmp
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:505 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -       splunk.profiler.recording.duration : 20s
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:506 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -               splunk.profiler.keep-files : false
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:510 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -            splunk.profiler.logs-endpoint : http://10.13.2.38:4317
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:513 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -              otel.exporter.otlp.endpoint : http://10.13.2.38:4317
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:513 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -           splunk.profiler.memory.enabled : true
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:515 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -             splunk.profiler.tlab.enabled : true
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:516 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -        splunk.profiler.memory.event.rate : 150/s
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:516 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -      splunk.profiler.call.stack.interval : PT0.15S
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:517 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -  splunk.profiler.include.internal.stacks : false
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:517 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -      splunk.profiler.tracing.stacks.only : false
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:517 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger - -----------------------
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:518 +0000] [main] INFO com.splunk.opentelemetry.profiler.JfrActivator - Profiler is active.</span></span></code></pre></div></div></div></div></div>We are interested in the section written by the <code>com.splunk.opentelemetry.profiler.ConfigurationLogger</code> or the <strong>Profiling Configuration</strong>.</p><p>We can see the various settings you can control, such as the <code>splunk.profiler.directory</code>, which is the location where the agent writes the call stacks before sending them to Splunk. (This may be different depending on how you configure your containers.)</p><p>Another parameter you may want to change is <code>splunk.profiler.call.stack.interval</code>. This is how often the system captures a CPU Stack trace. You may want to reduce this interval setting if you have short spans like the ones we have in our Pet Clinic application. For the demo application, we did not change the default interval value, so Spans may not always have a CPU Call Stack related to them.</p><p>You can find how to set these parameters <a href=https://docs.splunk.com/observability/en/gdi/get-data-in/application/java/configuration/advanced-java-otel-configuration.html#profiling-configuration-java rel=external target=_blank>here</a>. In the example below, we see how to set a higher collection rate for call stacks in the <code>deployment.yaml</code>, by setting this value in the JAVA_OPTIONS config section.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>env</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>JAVA_OPTIONS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;-Xdebug -Dsplunk.profiler.call.stack.interval=150&#34;</span></span></span></code></pre></div><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 21, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=always-on-profiling-in-the-trace-waterfall>Always-On Profiling in the Trace Waterfall</h1><p>Make sure you have your original (or similar) Trace & Span <strong>(1)</strong> selected in the APM Waterfall view and select <strong>Memory Stack Traces (2)</strong> from the right-hand pane:</p><p><a href=#R-image-2faed41c1fa97532012fa2f34c148dda class=lightbox-link><img alt="profiling from span" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/flamechart-in-waterfall.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-2faed41c1fa97532012fa2f34c148dda><img alt="profiling from span" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/flamechart-in-waterfall.png></a></p><p>The pane should show you the Memory Stack Trace Flame Graph <strong>(3)</strong>. You can scroll down and/or expand by dragging the right side of the pane.</p><p>AlwaysOn Profiling is constantly taking snapshots, or stack traces, of your applicationâ€™s code. Imagine having to read read through thousands of stack traces! It is simply not practical. To assist with this, AlwaysOn Profiling aggregates and summarizes profiling data, providing a convenient way to explore Call Stacks in a view called the <strong>Flame Graph</strong>. It represents a summary of all stack traces captured from your application. You can use the Flame Graph to discover which lines of code might be causing performance issues and to confirm whether changes you make to the code have the intended effect.</p><p>To dive deeper into Always-on Profiling, select Span <strong>(3)</strong> (as referenced in the above image) in the Profiling Pane under <strong>Memory Stack Traces</strong>. This will open the Always-on Profiling main screen, with the Memory view pre-selected:</p><p><a href=#R-image-17fd340da0a4e263fe4734b49e12ec47 class=lightbox-link><img alt="Profiling main" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/profiling-memory.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-17fd340da0a4e263fe4734b49e12ec47><img alt="Profiling main" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/profiling-memory.png></a></p><ul><li>The Time filter will be set to the time frame of the span we selected <strong>(1)</strong></li><li>Java Memory Metric Charts <strong>(2)</strong> allow you to <code>Monitor Heap Memory, Application Activity</code> like <code>Memory Allocation Rate</code> and <code>Garbage Collecting</code> Metrics.</li><li>Ability to focus/see metrics and Stack Traces only related to the Span <strong>(3)</strong>, This will filter out background activities running in the Java application if required.</li><li>Java Function calls identified <strong>(4)</strong>, allowing you to drill down into the Methods called from that function.</li><li>The Flame Graph <strong>(5)</strong>, with the visualization of hierarchy based on the stack traces of the profiled service.</li><li>Ability to select the Service instance <strong>(6)</strong> in case the service spins up multiple version of itself.</li></ul><p>For further investigation, the UI allows you to click a stack trace so that you can see the called function and the relevant line from the flame chart that you can then use in your coding platform to view the actual lines of code (depending of course on your preferred Coding platform).</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 21, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=database-query-performance>Database Query Performance</h1><p>With Database Query Performance, you can monitor the impact of your database queries on service availability directly in Splunk APM. This way, you can quickly identify long-running, un-optimized, or heavy queries and mitigate issues they might be causing, without having to instrument your databases.</p><p>To look at the performance of your database queries, make sure you are on the APM <strong>Service Map</strong> page either by going back in the browser or navigating to the APM section in the Menu bar, then click on the <strong>Service Map</strong> tile.</p><p>Select the inferred database service <code>mysql:petclinic</code> Inferred Database server in the Dependency map <strong>(1)</strong>, then scroll the right-hand pane to find the <strong>Database Query Performance</strong> Pane <strong>(2)</strong>.</p><p><a href=#R-image-b73852a2dd996ba4f75737026594c9c1 class=lightbox-link><img alt="DB-query from map" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/db-query-map.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b73852a2dd996ba4f75737026594c9c1><img alt="DB-query from map" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/db-query-map.png></a></p><p>If the service you have selected in the map is indeed an (inferred) database server, this pane will populate with the top 90% (P90) database calls based on duration. To dive deeper into the db-query performance function, click somewhere on the word <strong>Database Query Performance</strong> at the top of the pane.</p><p>This will bring us to the DB-query Performance overview screen:</p><p><a href=#R-image-07d33668f139775f33b7b892eb7f15c3 class=lightbox-link><img alt="DB-query full" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/db-query-full.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-07d33668f139775f33b7b892eb7f15c3><img alt="DB-query full" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/db-query-full.png></a></p><details open class="box cstyle notices info"><summary class=box-label><i class="fa-fw fas fa-info-circle"></i>
Database Query Normalization</summary><div class=box-content><p>By default, Splunk APM instrumentation sanitizes database queries to remove or mask sensible data, such as secrets or personally identifiable information (PII) from the <code>db.statements</code>. You can find how to turn off database query normalization <a href=https://docs.splunk.com/observability/en/apm/db-query-perf/db-perf-troubleshooting.html#turn-off-database-query-normalization rel=external target=_blank>here</a>.</p></div></details><p>This screen will show us all the Database queries <strong>(1)</strong> done to our database from your application, based on the Traces & Spans sent to the Splunk Observability Cloud. Note that you can compare them across a time block or sort them on Total Time, P90 Latency & Requests <strong>(2)</strong>.</p><p>For each Database query in the list, we see the highest latency, the total number of calls during the time window and the number of requests per second <strong>(3)</strong>. This allows you to identify places where you might optimize your queries.</p><p>You can select traces containing Database Calls via the two charts in the right-hand pane <strong>(5)</strong>. Use the Tag Spotlight pane <strong>(6)</strong> to drill down to see which tags are related to the database calls, based on endpoints or tags.</p><p>If you need to see a detailed view of a query:</p><p><a href=#R-image-9c4d717747ad1836293e35c686f19c33 class=lightbox-link><img alt=details class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/query-details.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-9c4d717747ad1836293e35c686f19c33><img alt=details class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/query-details.png></a></p><p>click on the specific Query <strong>(1)</strong>. This will open the Query Details pane <strong>(2)</strong>, which you can use for more detailed investigations.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 21, 2025</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=log-observer>Log Observer</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<p>Up until this point, there have been <strong>no code changes</strong>, yet tracing, profiling and Database Query Performance data is being sent to Splunk Observability Cloud.</p><p>Next, we will work with <strong>Splunk Log Observer</strong> to obtain log data from the Spring PetClinic application.</p><p>The <strong>Splunk OpenTelemetry Collector</strong> automatically collects logs from the Spring PetClinic application and sends them to Splunk Observability Cloud using the OTLP exporter, annotating the log events with <code>trace_id</code>, <code>span_id</code> and trace flags.</p><p><strong>Splunk Log Observer</strong> is then used to view the logs, automatically correlating log information with services and traces.</p><p>This feature is called <a href=https://docs.splunk.com/observability/en/metrics-and-metadata/relatedcontent.html rel=external target=_blank><strong>Related Content</strong></a>.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 21, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 7. Log Observer</h1><article class=default><header class=headline></header><h1 id=viewing-the-logs>Viewing the Logs</h1><p>In order to see logs click on the <a href=#R-image-9750b26852ed86772e85faf38d64c768 class=lightbox-link><img alt=Logo class="noborder inline lazy lightbox noshadow figure-image" loading=lazy src="../images/logo-icon.png?classes=inline&height=25px" style=height:25px;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-9750b26852ed86772e85faf38d64c768><img alt=Logo class="noborder inline lazy lightbox noshadow lightbox-image" loading=lazy src="../images/logo-icon.png?classes=inline&height=25px"></a> <strong>Log Observer</strong> in the left-hand menu. Once in Log Observer please ensure <strong>Index</strong> on the filter bar is set to <strong>splunk4rookies-workshop</strong>. <strong>(1)</strong></p><p>Next, click <strong>Add Filter</strong> and search, using the <em>Fields</em> <strong>(2)</strong> option for the field <code>deployment.environment</code> <strong>(3)</strong>. Then from the dropdown list, select your workshop instance, <strong>(4)</strong> and click <code>=</code> (to include). You will now see only the log messages from your PetClinic application.</p><p><a href=#R-image-47a892edfe2de9c10ba8024a4924ca76 class=lightbox-link><img alt="Log Observer sort" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/log-observer-sort.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-47a892edfe2de9c10ba8024a4924ca76><img alt="Log Observer sort" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/log-observer-sort.png></a></p><p>Next, search for the field <code>service.name</code>, selecting the value <code>customers-service</code> and click <code>=</code> (to include). This should now appear in the filter bar <strong>(1)</strong>. Next click on the Button <strong>Run Search</strong> <strong>(2)</strong>.</p><p><a href=#R-image-af17b239e64338b472e17c57743d9d54 class=lightbox-link><img alt="Log Observer run" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/log-observer-run.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-af17b239e64338b472e17c57743d9d54><img alt="Log Observer run" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/log-observer-run.png></a></p><p>This wil refresh the log entries and they will now be reduced to show the entries from your <code>customers-service</code> only.</p><p><a href=#R-image-85377c2b2ae0504649481d6c17b653c1 class=lightbox-link><img alt="Log Observer" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/log-observer-trace-info.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-85377c2b2ae0504649481d6c17b653c1><img alt="Log Observer" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/log-observer-trace-info.png></a></p><p>Click on an entry that starts with <em>&ldquo;Saving pet&rdquo;</em> <strong>(1)</strong>. A side pane will open where you can see the detailed information, including the relevant trace and span IDs <strong>(2)</strong>.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 21, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=related-content>Related Content</h1><p>The bottom pane is where any related content will be reported. In the screenshot below you can see that APM has found a trace that is related to this log line <strong>(1)</strong>:</p><p><a href=#R-image-b1f637e8ba3a3e43a8b6ec682f2e76bf class=lightbox-link><img alt=RC class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/log-apm-rc.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b1f637e8ba3a3e43a8b6ec682f2e76bf><img alt=RC class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/log-apm-rc.png></a></p><p>By clicking <strong>(2)</strong> on <strong>Trace for 960432ac9f16b98be84618778905af50</strong> we will be taken to the waterfall in APM for this specific trace, where this log line was generated:</p><p><a href=#R-image-ddedaddfcb17811ddf91ca0b2238fa74 class=lightbox-link><img alt="waterfall logs" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/waterfall-with-logs.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ddedaddfcb17811ddf91ca0b2238fa74><img alt="waterfall logs" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/waterfall-with-logs.png></a></p><p>Note that you now have a <strong>Related Content</strong> pane for Logs appearing <strong>(1)</strong>. Clicking on this will take you back to Log Observer and will display all the log lines that are part of this trace.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 21, 2025</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=real-user-monitoring>Real User Monitoring</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<p>To enable Real User Monitoring (RUM) instrumentation for an application, you need to add the Open Telemetry Javascript <a href=https://github.com/signalfx/splunk-otel-js-web rel=external target=_blank><strong>https://github.com/signalfx/splunk-otel-js-web</strong></a> snippet to the code base.</p><p>The Spring PetClinic application uses a single <a href=https://github.com/spring-petclinic/spring-petclinic-microservices/blob/main/spring-petclinic-api-gateway/src/main/resources/static/index.html rel=external target=_blank><strong>index</strong></a> HTML page, that is reused across all views of the application. This is the perfect location to insert the Splunk RUM instrumentation library as it will be loaded for all pages automatically.</p><p>The <code>api-gateway</code> service is already running the instrumentation and sending RUM traces to Splunk Observability Cloud and we will review the data in the next section.</p><p>If you&rsquo;d like to verify the snippet, you can view the page source in your browser by right-clicking on the page and selecting <strong>View Page Source</strong>.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;/env.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>  
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js&#34;</span> <span class=na>crossorigin</span><span class=o>=</span><span class=s>&#34;anonymous&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web-session-recorder.js&#34;</span> <span class=na>crossorigin</span><span class=o>=</span><span class=s>&#34;anonymous&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>realm</span> <span class=o>=</span> <span class=nx>env</span><span class=p>.</span><span class=nx>RUM_REALM</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Realm:&#39;</span><span class=p>,</span> <span class=nx>realm</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>auth</span> <span class=o>=</span> <span class=nx>env</span><span class=p>.</span><span class=nx>RUM_AUTH</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>appName</span> <span class=o>=</span> <span class=nx>env</span><span class=p>.</span><span class=nx>RUM_APP_NAME</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>environmentName</span> <span class=o>=</span> <span class=nx>env</span><span class=p>.</span><span class=nx>RUM_ENVIRONMENT</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>realm</span> <span class=o>&amp;&amp;</span> <span class=nx>auth</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>SplunkRum</span><span class=p>.</span><span class=nx>init</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=nx>realm</span><span class=o>:</span> <span class=nx>realm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>rumAccessToken</span><span class=o>:</span> <span class=nx>auth</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>applicationName</span><span class=o>:</span> <span class=nx>appName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>deploymentEnvironment</span><span class=o>:</span> <span class=nx>environmentName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>version</span><span class=o>:</span> <span class=s1>&#39;1.0.0&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>            <span class=nx>SplunkSessionRecorder</span><span class=p>.</span><span class=nx>init</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=nx>app</span><span class=o>:</span> <span class=nx>appName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>realm</span><span class=o>:</span> <span class=nx>realm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>rumAccessToken</span><span class=o>:</span> <span class=nx>auth</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>Provider</span> <span class=o>=</span> <span class=nx>SplunkRum</span><span class=p>.</span><span class=nx>provider</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>            <span class=kd>var</span> <span class=nx>tracer</span><span class=o>=</span><span class=nx>Provider</span><span class=p>.</span><span class=nx>getTracer</span><span class=p>(</span><span class=s1>&#39;appModuleLoader&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Realm or auth is empty, provide default values or skip initialization
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Realm or auth is empty. Skipping Splunk Rum initialization.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>     <span class=c>&lt;!-- Section added for  RUM --&gt;</span></span></span></code></pre></div><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 21, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 8. Real User Monitoring</h1><article class=default><header class=headline></header><h1 id=select-the-rum-view-for-the-petclinic-app>Select the RUM view for the Petclinic App</h1><p>Lets start with a quick, high level tour of RUM by clicking <strong>RUM</strong> in the left-hand menu. Then change the <strong>Environment</strong> filter <strong>(1)</strong> to the name of your workshop instance from the dropdown box, selecting <strong><code>&lt;INSTANCE>-workshop</code></strong> <strong>(1)</strong> (where <strong><code>INSTANCE</code></strong> is the value from the shell script you ran earlier). Make sure it is the only one selected.</p><p>Then change the <strong>App</strong> <strong>(2)</strong> dropdown box to the name of your app, it will be <strong><code>&lt;INSTANCE>-store</code></strong></p><p><a href=#R-image-b5c6609fac0eba96c634f3171ecd12ed class=lightbox-link><img alt="rum select" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/rum-env-select.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b5c6609fac0eba96c634f3171ecd12ed><img alt="rum select" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/rum-env-select.png></a></p><p>Once you have selected your <strong>Environment</strong> and <strong>App</strong>, you will see an overview page showing the RUM status of your Application. (If your Summary Dashboard is just a single row of numbers, you are looking at the condensed view. You can expand it by clicking on the <strong>> (1)</strong> in front of the Application name). If any JavaScript errors occurred, they will show up as shown below:</p><p><a href=#R-image-5cf326cd44bbde7d61618b12beeee1c5 class=lightbox-link><img alt="rum overview" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/rum-overview.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5cf326cd44bbde7d61618b12beeee1c5><img alt="rum overview" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/rum-overview.png></a></p><p>To continue, click on the blue link (with your workshop name) to get to the details page. This will bring up a new dashboard view breaking down the interactions by UX Metrics, Front-end Health, Back-end Health and Custom Events and comparing them to historic metrics (1 hour by default).</p><p><a href=#R-image-6582ce62480ea7c0b231b6ef790f6156 class=lightbox-link><img alt="rum  main" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/rum-main.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-6582ce62480ea7c0b231b6ef790f6156><img alt="rum  main" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/rum-main.png></a>
Normally, you have only one line inside the first chart. Click on the link that relates to your Petclinic shop,
http://198.19.249.202:81 in our example:</p><p>This will bring us to the Tag Spotlight page.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 21, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=rum-trace-waterfall-view--linking-to-apm>RUM trace Waterfall view & linking to APM</h1><p>In the TAG Spotlight view, you are presented with all the tags associated with the RUM data. Tags are key-value pairs that are used to identify the data. In this case, the tags are automatically generated by the OpenTelemetry instrumentation. The tags are used to filter the data and to create the charts and tables. The Tag Spotlight view allows you detect trends in behavior and to drill down into a user session.</p><p><a href=#R-image-60d8cbaff3cb07e0a264cd6017997f31 class=lightbox-link><img alt="RUM TAG" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/rum-tag-spotlight.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-60d8cbaff3cb07e0a264cd6017997f31><img alt="RUM TAG" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/rum-tag-spotlight.png></a></p><p>Click on User Sessions <strong>(1)</strong>, this will show you the list of user session that occurred during the time window.</p><p>We want to look at one of the session, so click on <em>Duration</em> <strong>(2)</strong> to sort on duration, and make sure you click on the link of one of the longer ones <strong>(3)</strong>:</p><p><a href=#R-image-5db6564f2ff579578f30ff7794eaeb83 class=lightbox-link><img alt="User sessions" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/rum-user-sessions.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5db6564f2ff579578f30ff7794eaeb83><img alt="User sessions" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/rum-user-sessions.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 21, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=rum-trace-waterfall-view--linking-to-apm>RUM trace Waterfall view & linking to APM</h1><p>We are now looking at the RUM Trace waterfall, this will tell you what happened during the session on the user device as they visited the page of our petclinic application.</p><p>If you scroll down the waterfall find click on the <strong>#!/owners/details</strong> segment on the right <strong>(1)</strong>, you see a list of actions that occurred during the handling of the Vets request. Note, that the HTTP request have a blue <strong>APM</strong> link before the return code. Pick one, and click on the APM link. This will show you the APM info for this backend service call hosted in Kubernetes.</p><p><a href=#R-image-ba737aa8cf9c1e0eba4942c91cc749c1 class=lightbox-link><img alt="rum apm link" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/rum-trace.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ba737aa8cf9c1e0eba4942c91cc749c1><img alt="rum apm link" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/rum-trace.png></a></p><p>Note, if you want to drill down to verify what happened with the request, click on the Trace ID url.</p><p>This will show you the trace related to your request from RUM:</p><p><a href=#R-image-00b37ec34c07a549e3e2646f7e5ce623 class=lightbox-link><img alt="RUm-apm linked" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/rum-apm-waterfall.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-00b37ec34c07a549e3e2646f7e5ce623><img alt="RUm-apm linked" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/rum-apm-waterfall.png></a></p><p>You can see that the entry point into your service now has a <strong>RUM (1)</strong> related content link added, allowing you to return back to your RUM session after you validated what happened in your backend service.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 21, 2025</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=workshop-wrap-up->Workshop Wrap-up ðŸŽ</h1><p>Congratulations, you have completed the <strong>Get the Most Out of Your Existing Kubernetes Java Applications Using Automatic Discovery and Configuration With OpenTelemetry</strong> workshop.</p><p>Today, you have learned how easy it is to add Tracing, Code Profiling and Database Query Performance to your existing Java application in Kubernetes.</p><p>You immediately improved the observability of the application and infrastructure without touching a line of code or configuration using <strong>Automatic Discovery and Configuration</strong>.</p><p>You also learned that with simple configuration changes, you can add even more observability (<strong>logging</strong> and <strong>RUM</strong>) to the application in order to provide end-to-end observability.</p><p><a href=#R-image-b0c00f017ed0bcd656343cd334772795 class=lightbox-link><img alt=Champagne class="noborder lazy lightbox noshadow figure-image" loading=lazy src="/observability-workshop/v5.90/en/ninja-workshops/1-automatic-discovery/2-petclinic-kubernetes/9-wrap-up/images/champagne.png?width=45vw" style=height:auto;width:45vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b0c00f017ed0bcd656343cd334772795><img alt=Champagne class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="/observability-workshop/v5.90/en/ninja-workshops/1-automatic-discovery/2-petclinic-kubernetes/9-wrap-up/images/champagne.png?width=45vw"></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 21, 2025</span></span></footer></article></section></section><article class=default><header class=headline></header><h1 id=monitoring-horizontal-pod-autoscaling-in-kubernetes>Monitoring Horizontal Pod Autoscaling in Kubernetes</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>45 minutes</span>
</span>&nbsp;
<span class="badge cstyle blue badge-with-title"><span class=badge-title class=text-muted>Author
</span><span class=badge-content>Robert Castley</span></span><p>This workshop will equip you with a basic understanding of monitoring Kubernetes using the Splunk OpenTelemetry Collector. During the workshop, you will deploy PHP/Apache and a load generator.</p><p>You will learn about OpenTelemetry Receivers, Kubernetes Namespaces, ReplicaSets, Kubernetes Horizontal Pod AutoScaling and how to monitor all this using the Splunk Observability Cloud. The main learnings from the workshop will be a better understanding of the Kubernetes Navigator (and Dashboards) in Splunk Observability Cloud as well as seeing Kubernetes metrics, events and Detectors.</p><p>For this workshop, Splunk has prepared an Ubuntu Linux instance in AWS/EC2 all pre-configured for you.</p><p>To get access to the instance that you will be using in the workshop, please visit the URL provided by the workshop leader.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><section><h1 class=a11y-only>Subsections of Horizontal Pod Autoscaling</h1><article class=default><header class=headline></header><h1 id=deploying-the-opentelemetry-collector-in-kubernetes>Deploying the OpenTelemetry Collector in Kubernetes</h1><h2 id=1-connect-to-ec2-instance>1. Connect to EC2 instance</h2><p>You will be able to connect to the workshop instance by using SSH from your Mac, Linux or Windows device. Open the link to the sheet provided by your instructor. This sheet contains the IP addresses and the password for the workshop instances.</p><details open class="box cstyle notices info"><summary class=box-label><i class="fa-fw fas fa-info-circle"></i>
Info</summary><div class=box-content><p>Your workshop instance has been pre-configured with the correct <strong>Access Token</strong> and <strong>Realm</strong> for this workshop. There is no need for you to configure these.</p></div></details><h2 id=2-install-splunk-otel-using-helm>2. Install Splunk OTel using Helm</h2><p>Install the OpenTelemetry Collector using the Splunk Helm chart. First, add the Splunk Helm chart repository and update:</p><div class=tab-panel data-tab-group=c1edf7bd5ca2726d69010543621f0584><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=helm-repo-add class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c1edf7bd5ca2726d69010543621f0584","helm-repo-add")'>
<span class=tab-nav-text>helm repo add</span>
</button>
<button data-tab-item=helm-repo-add-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("c1edf7bd5ca2726d69010543621f0584","helm-repo-add-output")'>
<span class=tab-nav-text>helm repo add output</span></button></div><div class=tab-content-container><div data-tab-item=helm-repo-add class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm repo add splunk-otel-collector-chart https://signalfx.github.io/splunk-otel-collector-chart <span class=o>&amp;&amp;</span> helm repo update</span></span></code></pre></div></div></div><div data-tab-item=helm-repo-add-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Using ACCESS_TOKEN=&lt;REDACTED&gt;
</span></span><span class=line><span class=cl>Using REALM=eu0
</span></span><span class=line><span class=cl>&#34;splunk-otel-collector-chart&#34; has been added to your repositories
</span></span><span class=line><span class=cl>Using ACCESS_TOKEN=&lt;REDACTED&gt;
</span></span><span class=line><span class=cl>Using REALM=eu0
</span></span><span class=line><span class=cl>Hang tight while we grab the latest from your chart repositories...
</span></span><span class=line><span class=cl>...Successfully got an update from the &#34;splunk-otel-collector-chart&#34; chart repository
</span></span><span class=line><span class=cl>Update Complete. âŽˆHappy Helming!âŽˆ</span></span></code></pre></div></div></div></div></div><p>Install the OpenTelemetry Collector Helm with the following commands, do <strong>NOT</strong> edit this:</p><div class=tab-panel data-tab-group=6a0feaf913bb7747e922a90009c60a88><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=helm-install class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6a0feaf913bb7747e922a90009c60a88","helm-install")'>
<span class=tab-nav-text>helm install</span></button></div><div class=tab-content-container><div data-tab-item=helm-install class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm install splunk-otel-collector --version 0.120.0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.realm=</span><span class=nv>$REALM</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.accessToken=</span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;clusterName=</span><span class=nv>$INSTANCE</span><span class=s2>-k3s-cluster&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;logsEngine=otel&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkPlatform.endpoint=</span><span class=nv>$HEC_URL</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkPlatform.token=</span><span class=nv>$HEC_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkPlatform.index=splunk4rookies-workshop&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>splunk-otel-collector-chart/splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-f ~/workshop/k3s/otel-collector.yaml</span></span></code></pre></div></div></div></div></div><h2 id=3-verify-deployment>3. Verify Deployment</h2><p>You can monitor the progress of the deployment by running <code>kubectl get pods</code> which should typically report that the new pods are up and running after about 30 seconds.</p><p>Ensure the status is reported as <strong>Running</strong> before continuing.</p><div class=tab-panel data-tab-group=e0b093ef86aad116b695fc94aef8b31a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=kubectl-get-pods class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e0b093ef86aad116b695fc94aef8b31a","kubectl-get-pods")'>
<span class=tab-nav-text>kubectl get pods</span>
</button>
<button data-tab-item=kubectl-get-pods-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("e0b093ef86aad116b695fc94aef8b31a","kubectl-get-pods-output")'>
<span class=tab-nav-text>kubectl get pods Output</span></button></div><div class=tab-content-container><div data-tab-item=kubectl-get-pods class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pods</span></span></code></pre></div></div></div><div data-tab-item=kubectl-get-pods-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>NAME                                                          READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>splunk-otel-collector-agent-pvstb                             2/2     Running   0          19s
</span></span><span class=line><span class=cl>splunk-otel-collector-k8s-cluster-receiver-6c454894f8-mqs8n   1/1     Running   0          19s</span></span></code></pre></div></div></div></div></div><p>Use the label set by the <code>helm</code> install to tail logs (You will need to press <code>ctrl + c</code> to exit).</p><div class=tab-panel data-tab-group=b11c1800c59b3bb44ffb130c5488f45f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=kubectl-logs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b11c1800c59b3bb44ffb130c5488f45f","kubectl-logs")'>
<span class=tab-nav-text>kubectl logs</span></button></div><div class=tab-content-container><div data-tab-item=kubectl-logs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl logs -l <span class=nv>app</span><span class=o>=</span>splunk-otel-collector -f --container otel-collector</span></span></code></pre></div></div></div></div></div><p>Or use the installed <code>k9s</code> terminal UI.</p><p><a href=#R-image-5b381d4f2e750bf490b6739bffefefa0 class=lightbox-link><img alt=k9s class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/k9s.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5b381d4f2e750bf490b6739bffefefa0><img alt=k9s class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/k9s.png></a></p><details open class="box cstyle notices warning"><summary class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i>
Deleting a failed installation</summary><div class=box-content><p>If you make an error installing the Splunk OpenTelemetry Collector you can start over by deleting the installation using:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>helm delete splunk-otel-collector</span></span></code></pre></div></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Nov 13, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=tour-of-the-kubernetes-navigator>Tour of the Kubernetes Navigator</h1><h2 id=1-cluster-vs-workload-view>1. Cluster vs Workload View</h2><p>The Kubernetes Navigator offers you two separate use cases to view your Kubernetes data.</p><ul><li>The <strong>K8s workloads</strong> are focusing on providing information in regards to workloads a.k.a. <em>your deployments</em>.</li><li>The <strong>K8s nodes</strong> are focusing on providing insight into the performance of clusters, nodes, pods and containers.</li></ul><p>You will initially select either view depending on your need (you can switch between the view on the fly if required). The most common one we will use in this workshop is the workload view and we will focus on that specifically.</p><h3 id=11-finding-your-k8s-cluster-name>1.1 Finding your K8s Cluster Name</h3><p>Your first task is to identify and find your cluster. The cluster will be named as determined by the preconfigured environment variable <code>INSTANCE</code>. To confirm the cluster name enter the following command in your terminal:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> <span class=nv>$INSTANCE</span>-k3s-cluster</span></span></code></pre></div><p>Please make a note of your cluster name as you will need this later in the workshop for filtering.</p><h2 id=2-workloads--workload-details-pane>2. Workloads & Workload Details Pane</h2><p>Go to the <strong>Infrastructure</strong> page in the Observability UI and select <strong>Kubernetes</strong>, this will offer you a set of Kubernetes services, one of them being the <strong>Kubernetes workloads</strong> pane. The pane will show a tiny graph giving you a bird&rsquo;s eye view of the load being handled across all workloads. Click on the <strong>Kubernetes workloads</strong> pane and you will be taken to the workload view.</p><p>Initially, you will see all the workloads for all clusters that are reported into your Observability Cloud Org. If an alert has fired for any of the workloads, it will be highlighted on the top right in the image below.</p><p><a href=#R-image-833713d6143ebb20caec266a45fdf83d class=lightbox-link><img alt=workloads class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/k8s-workloads-screen.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-833713d6143ebb20caec266a45fdf83d><img alt=workloads class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/k8s-workloads-screen.png></a></p><p>Now, let&rsquo;s find your cluster by filtering on <strong>Cluster</strong> in the filter toolbar.</p><details open class="box cstyle notices info"><summary class=box-label><i class="fa-fw fas fa-info-circle"></i>
Note</summary><div class=box-content><p>You can enter a partial name into the search box, such as <code>emea-ws-7*</code>, to quickly find your Cluster.</p><p>Also, it&rsquo;s a very good idea to switch the default time from the default <strong>-4h</strong> back to the last 15 minutes (<strong>-15m</strong>).</p></div></details><p><a href=#R-image-eda101a194d3287413e3223feed1f325 class=lightbox-link><img alt=workloads-filter class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/k8s-workloads-filter.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-eda101a194d3287413e3223feed1f325><img alt=workloads-filter class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/k8s-workloads-filter.png></a></p><p>You will now just see data just for your own cluster.</p><details open class="box cstyle notices tip"><summary class=box-label><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><p>How many workloads are running & how many namespaces are in your Cluster?</p></div></details><h3 id=21-using-the-navigator-selection-chart>2.1 Using the Navigator Selection Chart</h3><p>By default, the <strong>Kubernetes Workloads</strong> table filters by <code># Pods Failed</code> grouped by <code>k8s.namespace.name</code>. Go ahead and expand the <code>default</code> namespace to see the workloads in the namespace.</p><p><a href=#R-image-06d17e331feaac06de8656ff6a6e9d0d class=lightbox-link><img alt=k8s-workload-selection class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/workload-selection.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-06d17e331feaac06de8656ff6a6e9d0d><img alt=k8s-workload-selection class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/workload-selection.png></a></p><p>Now, let&rsquo;s change the list view to a heatmap view by selecting <strong>Map</strong> icon (next to the <strong>Table</strong> icon). Changing this option will result in the following visualization (or similar):</p><p><a href=#R-image-ee93652f199b6ab1e5a4151fe74ac0ed class=lightbox-link><img alt=k8s-Heat-map class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/workloads-heatmap.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ee93652f199b6ab1e5a4151fe74ac0ed><img alt=k8s-Heat-map class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/workloads-heatmap.png></a></p><p>In this view, you will note that each workload is now a colored square. These squares will change color according to the <strong>Color by</strong> option you select. The colors give a visual indication of health and/or usage. You can check the meaning by hovering over the <strong>legend</strong> exclamation icon <i class="fa-fw fas fa-exclamation-circle"></i> bottom right of the heatmaps.</p><p>Another valuable option in this screen is <strong>Find outliers</strong> which provides historical analytics of your clusters based on what is selected in the <strong>Color by</strong> dropdown.</p><p>Now, let&rsquo;s select the <strong>Network transferred (bytes)</strong> from the <strong>Color by</strong> drop-down box, then click on the <strong>Find outliers</strong> and change the <strong>Scope</strong> in the dialog to <strong>Per k8s.namespace.name</strong> and <strong>Deviation from Median</strong> as below:</p><p><a href=#R-image-f117f981f34a7802483ba1a2bae9d9c6 class=lightbox-link><img alt=k8s-Heat-map class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/set-find-outliers.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-f117f981f34a7802483ba1a2bae9d9c6><img alt=k8s-Heat-map class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/set-find-outliers.png></a></p><p>The <strong>Find Outliers</strong> view is very useful when you need to view a selection of your workloads (or any service depending on the Navigator used) and quickly need to figure out if something has changed.</p><p>It will give you fast insight into items (workloads in our case) that are performing differently (both increased or decreased) which helps to make it easier to spot problems.</p><h3 id=22-the-deployment-overview-pane>2.2 The Deployment Overview pane</h3><p>The Deployment Overview pane gives you a quick insight into the status of your deployments. You can see at once if the pods of your deployments are Pending, Running, Succeeded, Failed or in an Unknown state.</p><p><a href=#R-image-06d3bfd39563891f49ba364a646a2946 class=lightbox-link><img alt=k8s-workload-overview class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/k8s-deployment-overview.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-06d3bfd39563891f49ba364a646a2946><img alt=k8s-workload-overview class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/k8s-deployment-overview.png></a></p><ul><li><em>Running:</em> Pod is deployed and in a running state</li><li><em>Pending:</em> Waiting to be deployed</li><li><em>Succeeded:</em> Pod has been deployed and completed its job and is finished</li><li><em>Failed:</em> Containers in the pod have run and returned some kind of error</li><li><em>Unknown:</em> Kubernetes isn&rsquo;t reporting any of the known states. (This may be during the starting or stopping of pods, for example).</li></ul><p>You can expand the Workload name by hovering your mouse on it, in case the name is longer than the chart allows.</p><p>To filter to a specific workload, you can click on three dots <strong>&mldr;</strong> next to the workload name in the <strong>k8s.workload.name</strong> column and choose <strong>Filter</strong> from the dropdown box:</p><p><a href=#R-image-11c388df79d32e90f322a8f1e06f1c86 class=lightbox-link><img alt=workload-add-filter class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/workload-add-filter.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-11c388df79d32e90f322a8f1e06f1c86><img alt=workload-add-filter class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/workload-add-filter.png></a></p><p>This will add the selected workload to your filters. It would then list a single workload in the <strong>default</strong> namespace:</p><p><a href=#R-image-82b9d8222911d33b9eedbef045e6485b class=lightbox-link><img alt=workload-add-filter class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/heatmap-filter-down.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-82b9d8222911d33b9eedbef045e6485b><img alt=workload-add-filter class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/heatmap-filter-down.png></a></p><p>From the Heatmap above find the <strong>splunk-otel-collector-k8s-cluster-receiver</strong> in the <strong>default</strong> namespace and click on the square to see more information about the workload:</p><p><a href=#R-image-ce5c75db286173cfed7119aee5626e78 class=lightbox-link><img alt=workload-add-filter class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/k8s-workload-detail.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ce5c75db286173cfed7119aee5626e78><img alt=workload-add-filter class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/k8s-workload-detail.png></a></p><details open class="box cstyle notices tip"><summary class=box-label><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><p>What are the CPU request & CPU limit units for the otel-collector?</p></div></details><p>At this point, you can drill into the information of the pods, but that is outside the scope of this workshop.</p><h2 id=3-navigator-sidebar>3. Navigator Sidebar</h2><p>Later in the workshop, you will deploy an Apache server into your cluster which will display an icon in the <strong>Navigator Sidebar</strong>.</p><p>In navigators for Kubernetes, you can track dependent services and containers in the navigator sidebar. To get the most out of the navigator sidebar you configure the services you want to track by configuring an extra dimension called <code>service.name</code>. For this workshop, we have already configured the <code>extraDimensions</code> in the collector configuration for monitoring Apache e.g.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>extraDimensions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>service.name</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span></span></span></code></pre></div><p>The Navigator Sidebar will expand and a link to the discovered service will be added as seen in the image below:</p><p><a href=#R-image-4c515f39bb8644d36203c767674082e5 class=lightbox-link><img alt=Pivotbar class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/pivotbar.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-4c515f39bb8644d36203c767674082e5><img alt=Pivotbar class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/pivotbar.png></a></p><p>This will allow for easy switching between Navigators. The same applies to your Apache server instance, it will have a Navigator Sidebar allowing you to quickly jump back to the Kubernetes Navigator.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Nov 4, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=deploying-phpapache>Deploying PHP/Apache</h1><h2 id=1-namespaces-in-kubernetes>1. Namespaces in Kubernetes</h2><p>Most of our customers will make use of some kind of private or public cloud service to run Kubernetes. They often choose to have only a few large Kubernetes clusters as it is easier to manage centrally.</p><p>Namespaces are a way to organize these large Kubernetes clusters into virtual sub-clusters. This can be helpful when different teams or projects share a Kubernetes cluster as this will give them the easy ability to just see and work with their resources.</p><p>Any number of namespaces are supported within a cluster, each logically separated from others but with the ability to communicate with each other. Components are only <strong>visible</strong> when selecting a namespace or when adding the <code>--all-namespaces</code> flag to <code>kubectl</code> instead of allowing you to view just the components relevant to your project by selecting your namespace.</p><p>Most customers will want to install the applications into a separate namespace. This workshop will follow that best practice.</p><h2 id=2--dns-and-services-in-kubernetes>2. DNS and Services in Kubernetes</h2><p>The Domain Name System (DNS) is a mechanism for linking various sorts of information with easy-to-remember names, such as IP addresses. Using a DNS system to translate request names into IP addresses makes it easy for end-users to reach their target domain name effortlessly.</p><p>Most Kubernetes clusters include an internal DNS service configured by default to offer a lightweight approach for service discovery. Even when Pods and Services are created, deleted, or shifted between nodes, built-in service discovery simplifies applications to identify and communicate with services on the Kubernetes clusters.</p><p>In short, the DNS system for Kubernetes will create a DNS entry for each Pod and Service. In general, a Pod has the following DNS resolution:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>pod-name.my-namespace.pod.cluster-domain.example</span></span></code></pre></div><p>For example, if a Pod in the <code>default</code> namespace has the Pod name <code>my_pod</code>, and the domain name for your cluster is <code>cluster.local</code>, then the Pod has a DNS name:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>my_pod.default.pod.cluster.local</span></span></code></pre></div><p>Any Pods exposed by a Service have the following DNS resolution available:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>my_pod.service-name.my-namespace.svc.cluster-domain.example</span></span></code></pre></div><p>More information can be found here: <a href=https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/ rel=external target=_blank><strong>DNS for Service and Pods</strong></a></p><h2 id=3-review-otel-receiver-for-phpapache>3. Review OTel receiver for PHP/Apache</h2><p>Inspect the YAML file <code>~/workshop/k3s/otel-apache.yaml</code> and validate the contents using the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/workshop/k3s/otel-apache.yaml</span></span></code></pre></div><p>This file contains the configuration for the OpenTelemetry agent to monitor the PHP/Apache deployment.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>agent</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receiver_creator</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>smartagent/apache</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>rule</span><span class=p>:</span><span class=w> </span><span class=l>type == &#34;port&#34; &amp;&amp; pod.name matches &#34;apache&#34; &amp;&amp; port == 80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>collectd/apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>http://php-apache-svc.apache.svc.cluster.local/server-status?auto</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>extraDimensions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>service.name</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span></span></span></code></pre></div><h2 id=4--observation-rules-in-the-opentelemetry-config>4. Observation Rules in the OpenTelemetry config</h2><p>The above file contains an observation rule for Apache using the OTel <code>receiver_creator</code>. This receiver can instantiate other receivers at runtime based on whether observed endpoints match a configured rule.</p><p>The configured rules will be evaluated for each endpoint discovered. If the rule evaluates to true, then the receiver for that rule will be started as configured against the matched endpoint.</p><p>In the file above we tell the OpenTelemetry agent to look for Pods that match the name <code>apache</code> and have port <code>80</code> open. Once found, the agent will configure an Apache receiver to read Apache metrics from the configured URL. Note, the K8s DNS-based URL in the above YAML for the service.</p><p>To use the Apache configuration, you can upgrade the existing Splunk OpenTelemetry Collector Helm chart to use the <code>otel-apache.yaml</code> file with the following command:</p><div class=tab-panel data-tab-group=22def2c27cab4b0cef29ce6b1edce782><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=helm-upgrade class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("22def2c27cab4b0cef29ce6b1edce782","helm-upgrade")'>
<span class=tab-nav-text>Helm Upgrade</span></button></div><div class=tab-content-container><div data-tab-item=helm-upgrade class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm upgrade splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.realm=</span><span class=nv>$REALM</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.accessToken=</span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;clusterName=</span><span class=nv>$INSTANCE</span><span class=s2>-k3s-cluster&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;logsEngine=otel&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkPlatform.endpoint=</span><span class=nv>$HEC_URL</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkPlatform.token=</span><span class=nv>$HEC_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkPlatform.index=splunk4rookies-workshop&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>splunk-otel-collector-chart/splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-f ~/workshop/k3s/otel-collector.yaml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-f ~/workshop/k3s/otel-apache.yaml</span></span></code></pre></div></div></div></div></div><details open class="box cstyle notices info"><summary class=box-label><i class="fa-fw fas fa-info-circle"></i>
NOTE</summary><div class=box-content><p>The <strong>REVISION</strong> number of the deployment has changed, which is a helpful way to keep track of your changes.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Release &#34;splunk-otel-collector&#34; has been upgraded. Happy Helming!
</span></span><span class=line><span class=cl>NAME: splunk-otel-collector
</span></span><span class=line><span class=cl>LAST DEPLOYED: Mon Nov  4 14:56:25 2024
</span></span><span class=line><span class=cl>NAMESPACE: default
</span></span><span class=line><span class=cl>STATUS: deployed
</span></span><span class=line><span class=cl>REVISION: 2
</span></span><span class=line><span class=cl>TEST SUITE: None
</span></span><span class=line><span class=cl>NOTES:
</span></span><span class=line><span class=cl>Splunk OpenTelemetry Collector is installed and configured to send data to Splunk Platform endpoint &#34;https://http-inputs-workshop.splunkcloud.com:443/services/collector/event&#34;.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Splunk OpenTelemetry Collector is installed and configured to send data to Splunk Observability realm eu0.</span></span></code></pre></div></div></details><h2 id=5-kubernetes-configmaps>5. Kubernetes ConfigMaps</h2><p>A ConfigMap is an object in Kubernetes consisting of key-value pairs that can be injected into your application. With a ConfigMap, you can separate configuration from your Pods.</p><p>Using ConfigMap, you can prevent hardcoding configuration data. ConfigMaps are useful for storing and sharing non-sensitive, unencrypted configuration information.</p><p>The OpenTelemetry collector/agent uses ConfigMaps to store the configuration of the agent and the K8s Cluster receiver. You can/will always verify the current configuration of an agent after a change by running the following commands:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get cm</span></span></code></pre></div><details open class="box cstyle notices tip"><summary class=box-label><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><p>How many ConfigMaps are used by the collector?</p></div></details><p>When you have a list of ConfigMaps from the namespace, select the one for the <code>otel-agent</code> and view it with the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get cm splunk-otel-collector-otel-agent -o yaml</span></span></code></pre></div><details open class="box cstyle notices info"><summary class=box-label><i class="fa-fw fas fa-info-circle"></i>
NOTE</summary><div class=box-content><p>The option <code>-o yaml</code> will output the content of the ConfigMap in a readable YAML format.</p></div></details><details open class="box cstyle notices tip"><summary class=box-label><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><p>Is the configuration from <code>otel-apache.yaml</code> visible in the ConfigMap for the collector agent?</p></div></details><h2 id=6-review-phpapache-deployment-yaml>6. Review PHP/Apache deployment YAML</h2><p>Inspect the YAML file <code>~/workshop/k3s/php-apache.yaml</code> and validate the contents using the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/workshop/k3s/php-apache.yaml</span></span></code></pre></div><p>This file contains the configuration for the PHP/Apache deployment and will create a new StatefulSet with a single replica of the PHP/Apache image.</p><p>A stateless application does not care which network it is using, and it does not need permanent storage. Examples of stateless apps may include web servers such as Apache, Nginx, or Tomcat.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StatefulSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>updateStrategy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>RollingUpdate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;php-apache-svc&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ghcr.io/splunk/php-apache:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;8&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;8Mi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;6&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;4Mi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>php-apache-svc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span></span></span></code></pre></div><h2 id=7-deploy-phpapache>7. Deploy PHP/Apache</h2><p>Create an <code>apache</code> namespace then deploy the PHP/Apache application to the cluster.</p><p>Create the <code>apache</code> namespace:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create namespace apache</span></span></code></pre></div><p>Deploy the PHP/Apache application:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f ~/workshop/k3s/php-apache.yaml -n apache</span></span></code></pre></div><p>Ensure the deployment has been created:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get statefulset -n apache</span></span></code></pre></div><details open class="box cstyle notices tip"><summary class=box-label><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><p>What metrics for your Apache instance are being reported in the Apache Navigator?</p><p><strong>Tip:</strong> Use the Navigator Sidebar and click on the service name.</p></div></details><details open class="box cstyle notices tip"><summary class=box-label><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><p>Using Log Observer what is the issue with the PHP/Apache deployment?</p><p><strong>Tip:</strong> Adjust your filters to use: <code>object = php-apache-svc</code> and <code>k8s.cluster.name = &lt;your_cluster></code>.</p></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Nov 4, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=fix-phpapache-issue>Fix PHP/Apache Issue</h1><h2 id=1-kubernetes-resources>1. Kubernetes Resources</h2><p>Especially in Production Kubernetes Clusters, CPU and Memory are considered precious resources. Cluster Operators will normally require you to specify the amount of CPU and Memory your Pod or Service will require in the deployment, so they can have the Cluster automatically manage on which Node(s) your solution will be placed.</p><p>You do this by placing a Resource section in the deployment of your application/Pod</p><p><strong>Example:</strong></p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>limits</span><span class=p>:</span><span class=w>         </span><span class=c># Maximum amount of CPU &amp; memory for peek use</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;8&#34;</span><span class=w>      </span><span class=c># Maximum of 8 cores of CPU allowed at for peek use</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;8Mi&#34;</span><span class=w> </span><span class=c># Maximum allowed 8Mb of memory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>requests</span><span class=p>:</span><span class=w>       </span><span class=c># Request are the expected amount of CPU &amp; memory for normal use</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;6&#34;</span><span class=w>      </span><span class=c># Requesting 4 cores of a CPU</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;4Mi&#34;</span><span class=w> </span><span class=c># Requesting 4Mb of memory</span></span></span></code></pre></div><p>More information can be found here: <a href=https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/ rel=external target=_blank><strong>Resource Management for Pods and Containers</strong></a></p><p>If your application or Pod will go over the limits set in your deployment, Kubernetes will kill and restart your Pod to protect the other applications on the Cluster.</p><p>Another scenario that you will run into is when there is not enough Memory or CPU on a Node. In that case, the Cluster will try to reschedule your Pod(s) on a different Node with more space.</p><p>If that fails, or if there is not enough space when you deploy your application, the Cluster will put your workload/deployment in schedule mode until there is enough room on any of the available Nodes to deploy the Pods according to their limits.</p><h2 id=2-fix-phpapache-deployment>2. Fix PHP/Apache Deployment</h2><details open class="box cstyle notices tip"><summary class=box-label><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><p>Before we start, let&rsquo;s check the current status of the PHP/Apache deployment. Under <strong>Alerts & Detectors</strong> which detector has fired? Where else can you find this information?</p></div></details><p>To fix the PHP/Apache StatefulSet, edit <code>~/workshop/k3s/php-apache.yaml</code> using the following commands to reduce the CPU resources:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vim ~/workshop/k3s/php-apache.yaml</span></span></code></pre></div><p>Find the resources section and reduce the CPU limits to <strong>1</strong> and the CPU requests to <strong>0.5</strong>:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;8Mi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0.5&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;4Mi&#34;</span></span></span></code></pre></div><p>Save the changes you have made. (Hint: Use <code>Esc</code> followed by <code>:wq!</code> to save your changes).</p><p>Now, we must delete the existing StatefulSet and re-create it. StatefulSets are immutable, so we must delete the existing one and re-create it with the new changes.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl delete statefulset php-apache -n apache</span></span></code></pre></div><p>Now, deploy your changes:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f ~/workshop/k3s/php-apache.yaml -n apache</span></span></code></pre></div><h2 id=3-validate-the-changes>3. Validate the changes</h2><p>You can validate the changes have been applied by running the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe statefulset php-apache -n apache</span></span></code></pre></div><p>Validate the Pod is now running in Splunk Observability Cloud.</p><details open class="box cstyle notices tip"><summary class=box-label><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><p>Is the <strong>Apache Web Servers</strong> dashboard showing any data now?</p><p><strong>Tip:</strong> Don&rsquo;t forget to use filters and time frames to narrow down your data.</p></div></details><p>Monitor the Apache web servers Navigator dashboard for a few minutes.</p><details open class="box cstyle notices tip"><summary class=box-label><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><p>What is happening with the # Hosts reporting chart?</p></div></details><h2 id=4-fix-the-memory-issue>4. Fix the memory issue</h2><p>If you navigate back to the Apache dashboard, you will notice that metrics are no longer coming in. We have another resource issue and this time we are Out of Memory. Let&rsquo;s edit the stateful set and increase the memory to what is shown in the image below:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl edit statefulset php-apache -n apache</span></span></code></pre></div><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>16Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>500m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>12Mi</span></span></span></code></pre></div><p>Save the changes you have made.</p><details open class="box cstyle notices info"><summary class=box-label><i class="fa-fw fas fa-exclamation"></i>
Hint</summary><div class=box-content><p><code>kubectl edit</code> will open the contents in the <code>vi</code> editor, use <code>Esc</code> followed by <code>:wq!</code> to save your changes.</p></div></details><p>Because StatefulSets are immutable, we must delete the existing Pod and let the StatefulSet re-create it with the new changes.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl delete pod php-apache-0 -n apache</span></span></code></pre></div><p>Validate the changes have been applied by running the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe statefulset php-apache -n apache</span></span></code></pre></div><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=deploy-load-generator>Deploy Load Generator</h1><p>Now let&rsquo;s apply some load against the <code>php-apache</code> pod. To do this, you will need to start a different Pod to act as a client. The container within the client Pod runs in an infinite loop, sending HTTP GETs to the <code>php-apache</code> service.</p><h2 id=1-review-loadgen-yaml>1. Review loadgen YAML</h2><p>Inspect the YAML file <code>~/workshop/k3s/loadgen.yaml</code> and validate the contents using the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/workshop/k3s/loadgen.yaml</span></span></code></pre></div><p>This file contains the configuration for the load generator and will create a new ReplicaSet with two replicas of the load generator image.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ReplicaSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>loadgen</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>loadgen</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>loadgen</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>loadgen</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>loadgen</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>infinite-calls</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>/bin/sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;while true; do wget -q -O- http://php-apache-svc.apache.svc.cluster.local; done&#34;</span></span></span></code></pre></div><h2 id=2-create-a-new-namespace>2. Create a new namespace</h2><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>kubectl create namespace loadgen</span></span></code></pre></div><h2 id=3-deploy-the-loadgen-yaml>3. Deploy the loadgen YAML</h2><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>kubectl apply -f ~/workshop/k3s/loadgen.yaml --namespace loadgen</span></span></code></pre></div><p>Once you have deployed the load generator, you can see the Pods running in the <code>loadgen</code> namespace. Use previous similar commands to check the status of the Pods from the command line.</p><details open class="box cstyle notices tip"><summary class=box-label><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><p>Which metrics in the Apache Navigator have now significantly increased?</p></div></details><h2 id=4-scale-the-load-generator>4. Scale the load generator</h2><p>A ReplicaSet is a process that runs multiple instances of a Pod and keeps the specified number of Pods constant. Its purpose is to maintain the specified number of Pod instances running in a cluster at any given time to prevent users from losing access to their application when a Pod fails or is inaccessible.</p><p>ReplicaSet helps bring up a new instance of a Pod when the existing one fails, scale it up when the running instances are not up to the specified number, and scale down or delete Pods if another instance with the same label is created. A ReplicaSet ensures that a specified number of Pod replicas are running continuously and helps with load-balancing in case of an increase in resource usage.</p><p>Let&rsquo;s scale our ReplicaSet to 4 replicas using the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>kubectl scale replicaset/loadgen --replicas 4 -n loadgen</span></span></code></pre></div><p>Validate the replicas are running from both the command line and Splunk Observability Cloud:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>kubectl get replicaset loadgen -n loadgen</span></span></code></pre></div><p><a href=#R-image-17e8d673b00cb6bc4d1124e5011c430f class=lightbox-link><img alt=ReplicaSet class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/k8s-workload-replicaset.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-17e8d673b00cb6bc4d1124e5011c430f><img alt=ReplicaSet class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/k8s-workload-replicaset.png></a></p><details open class="box cstyle notices tip"><summary class=box-label><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><p>What impact can you see in the Apache Navigator?</p></div></details><p>Let the load generator run for around 2-3 minutes and keep observing the metrics in the Kubernetes Navigator and the Apache Navigator.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=setup-horizontal-pod-autoscaling-hpa>Setup Horizontal Pod Autoscaling (HPA)</h1><p>In Kubernetes, a HorizontalPodAutoscaler automatically updates a workload resource (such as a Deployment or StatefulSet), to automatically scale the workload to match demand.</p><p>Horizontal scaling means that the response to increased load is to deploy more Pods. This is different from vertical scaling, which for Kubernetes would mean assigning more resources (for example: memory or CPU) to the Pods that are already running for the workload.</p><p>If the load decreases, and the number of Pods is above the configured minimum, the HorizontalPodAutoscaler instructs the workload resource (the Deployment, StatefulSet, or other similar resource) to scale back down.</p><h2 id=1-setup-hpa>1. Setup HPA</h2><p>Inspect the <code>~/workshop/k3s/hpa.yaml</code> file and validate the contents using the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/workshop/k3s/hpa.yaml</span></span></code></pre></div><p>This file contains the configuration for the Horizontal Pod Autoscaler and will create a new HPA for the <code>php-apache</code> deployment.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>autoscaling/v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>HorizontalPodAutoscaler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>maxReplicas</span><span class=p>:</span><span class=w> </span><span class=m>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cpu</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>target</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>averageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>50</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Utilization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>memory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>target</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>averageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>75</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Utilization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>minReplicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scaleTargetRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StatefulSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span></span></span></code></pre></div><p>Once deployed, <code>php-apache</code> will autoscale when either the average CPU usage goes above 50% or the average memory usage for the deployment goes above 75%, with a minimum of 1 pod and a maximum of 4 pods.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>kubectl apply -f ~/workshop/k3s/hpa.yaml</span></span></code></pre></div><h2 id=2-validate-hpa>2. Validate HPA</h2><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>kubectl get hpa -n apache</span></span></code></pre></div><p>Go to the <strong>Workloads</strong> or <strong>Node Detail</strong> tab in Kubernetes and check the HPA deployment.</p><details open class="box cstyle notices tip"><summary class=box-label><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><p>How many additional <code>php-apache-x</code> pods have been created?</p></div></details><details open class="box cstyle notices tip"><summary class=box-label><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><p>Which metrics in the Apache Navigator have significantly increased again?</p></div></details><h2 id=3-increase-the-hpa-replica-count>3. Increase the HPA replica count</h2><p>Increase the <code>maxReplicas</code> to 8</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl edit hpa php-apache -n apache</span></span></code></pre></div><p>Save the changes you have made. (Hint: Use <code>Esc</code> followed by <code>:wq!</code> to save your changes).</p><details open class="box cstyle notices tip"><summary class=box-label><i class="fa-fw fas fa-question"></i>
Workshop Questions</summary><div class=box-content><ol><li><p>How many pods are now running?</p></li><li><p>How many are pending?</p></li><li><p>Why are they pending?</p></li></ol></div></details><p><strong>Congratulations!</strong> You have completed the workshop.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=opentelemetry-collector-workshops>OpenTelemetry Collector Workshops</h1><ul class="children children-li children-sort-"><li><a href=/observability-workshop/v5.90/en/ninja-workshops/3-opentelemetry-collector-workshops/1-opentelemetry-collector/index.html>OpenTelemetry Collector Concepts</a><p>Learn the concepts of the OpenTelemetry Collector and how to use it to send data to Splunk Observability Cloud.</p></li><li><a href=/observability-workshop/v5.90/en/ninja-workshops/3-opentelemetry-collector-workshops/2-advanced-collector/index.html>Advanced Collector Configuration</a><p>Practice setting up the OpenTelemetry Collector configuration from scratch and go though several advanced configuration scenarios's.</p></li></ul><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of OpenTelemetry Collector Workshops</h1><article class=default><header class=headline></header><h1 id=making-your-observability-cloud-native-with-opentelemetry>Making Your Observability Cloud Native With OpenTelemetry</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>1 hour</span>
</span>&nbsp;
<span class="badge cstyle blue badge-with-title"><span class=badge-title class=text-muted>Author
</span><span class=badge-content>Robert Castley</span></span><h2 id=abstract>Abstract</h2><p>Organizations getting started with OpenTelemetry may begin by sending data directly to an observability backend. While this works well for initial testing, using the OpenTelemetry collector as part of your observability architecture provides numerous benefits and is recommended for any production deployment.</p><p>In this workshop, we will be focusing on using the OpenTelemetry collector and starting with the fundamentals of configuring the receivers, processors, and exporters ready to use with Splunk Observability Cloud. The journey will take attendees from novices to being able to start adding custom components to help solve for their business observability needs for their distributed platform.</p><h3 id=ninja-sections>Ninja Sections</h3><p>Throughout the workshop there will be expandable <span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-user-ninja"></i></span><span class=badge-content><strong>Ninja</strong> Sections</span></span>, these will be more hands on and go into further technical detail that you can explore within the workshop or in your own time.</p><p>Please note that the content in these sections may go out of date due to the frequent development being made to the OpenTelemetry project. Links will be provided in the event details are out of sync, please let us know if you spot something that needs updating.</p><hr><details class="box cstyle notices transparent expand"><summary class=box-label><i class="expander-icon fa-fw fas fa-chevron-right"></i>
<span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-user-ninja"></i></span><span class=badge-content><strong>Ninja:</strong> Test Me!</span></span></summary><div class=box-content><p><strong>By completing this workshop you will officially be an OpenTelemetry Collector Ninja!</strong></p></div></details><hr><h2 id=target-audience>Target Audience</h2><p>This interactive workshop is for developers and system administrators who are interested in learning more about architecture and deployment of the OpenTelemetry Collector.</p><h2 id=prerequisites>Prerequisites</h2><ul><li>Attendees should have a basic understanding of data collection</li><li>Command line and vim/vi experience.</li><li>A instance/host/VM running Ubuntu 20.04 LTS or 22.04 LTS.<ul><li>Minimum requirements are an AWS/EC2 t2.micro (1 CPU, 1GB RAM, 8GB Storage)</li></ul></li></ul><h2 id=learning-objectives>Learning Objectives</h2><p>By the end of this talk, attendees will be able to:</p><ul><li>Understand the components of OpenTelemetry</li><li>Use receivers, processors, and exporters to collect and analyze data</li><li>Identify the benefits of using OpenTelemetry</li><li>Build a custom component to solve their business needs</li></ul><h2 id=opentelemetry-architecture>OpenTelemetry Architecture</h2><pre class="mermaid align-center">
%%{
  init:{
    &#34;theme&#34;:&#34;base&#34;,
    &#34;themeVariables&#34;: {
      &#34;primaryColor&#34;: &#34;#ffffff&#34;,
      &#34;clusterBkg&#34;: &#34;#eff2fb&#34;,
      &#34;defaultLinkColor&#34;: &#34;#333333&#34;
    }
  }
}%%

flowchart LR;
    subgraph Collector
    A[OTLP] --&gt; M(Receivers)
    B[JAEGER] --&gt; M(Receivers)
    C[Prometheus] --&gt; M(Receivers)
    end
    subgraph Processors
    M(Receivers) --&gt; H(Filters, Attributes, etc)
    E(Extensions)
    end
    subgraph Exporters
    H(Filters, Attributes, etc) --&gt; S(OTLP)
    H(Filters, Attributes, etc) --&gt; T(JAEGER)
    H(Filters, Attributes, etc) --&gt; U(Prometheus)
    end
</pre><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of OpenTelemetry Collector Concepts</h1><article class=default><header class=headline></header><h1 id=installing-opentelemetry-collector-contrib>Installing OpenTelemetry Collector Contrib</h1><h2 id=download-the-opentelemetry-collector-contrib-distribution>Download the OpenTelemetry Collector Contrib distribution</h2><p>The first step in installing the Open Telemetry Collector is downloading it. For our lab, we will use the <code>wget</code> command to download the <code>.deb</code> package from the OpenTelemetry Github repository.</p><p>Obtain the <code>.deb</code> package for your platform from the <a href=https://github.com/open-telemetry/opentelemetry-collector-releases/releases rel=external target=_blank><strong>OpenTelemetry Collector Contrib releases page</strong></a></p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget https://github.com/open-telemetry/opentelemetry-collector-releases/releases/download/v0.111.0/otelcol-contrib_0.111.0_linux_amd64.deb</span></span></code></pre></div><h2 id=install-the-opentelemetry-collector-contrib-distribution>Install the OpenTelemetry Collector Contrib distribution</h2><p>Install the <code>.deb</code> package using <code>dpkg</code>. Take a look at the <strong>dpkg Output</strong> tab below to see what the example output of a successful install will look like:</p><div class=tab-panel data-tab-group=f1cc8aa7087c80b4f0407698432bdd34><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=install class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f1cc8aa7087c80b4f0407698432bdd34","install")'>
<span class=tab-nav-text>Install</span>
</button>
<button data-tab-item=dpkg-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("f1cc8aa7087c80b4f0407698432bdd34","dpkg-output")'>
<span class=tab-nav-text>dpkg Output</span></button></div><div class=tab-content-container><div data-tab-item=install class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo dpkg -i otelcol-contrib_0.111.0_linux_amd64.deb</span></span></code></pre></div></div></div><div data-tab-item=dpkg-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Selecting previously unselected package otelcol-contrib.
</span></span><span class=line><span class=cl>(Reading database ... 89232 files and directories currently installed.)
</span></span><span class=line><span class=cl>Preparing to unpack otelcol-contrib_0.111.0_linux_amd64.deb ...
</span></span><span class=line><span class=cl>Unpacking otelcol-contrib (0.111.0) ...
</span></span><span class=line><span class=cl>Setting up otelcol-contrib (0.111.0) ...
</span></span><span class=line><span class=cl>Created symlink /etc/systemd/system/multi-user.target.wants/otelcol-contrib.service â†’ /lib/systemd/system/otelcol-contrib.service.</span></span></code></pre></div></div></div></div></div><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 1. Installation</h1><article class=default><header class=headline></header><h1 id=installing-opentelemetry-collector-contrib>Installing OpenTelemetry Collector Contrib</h1><h2 id=confirm-the-collector-is-running>Confirm the Collector is running</h2><p>The collector should now be running. We will verify this as root using <code>systemctl</code> command. To exit the status just press <code>q</code>.</p><div class=tab-panel data-tab-group=b511e30ecae57e8f289698fc3f1690b1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=command class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b511e30ecae57e8f289698fc3f1690b1","command")'>
<span class=tab-nav-text>Command</span>
</button>
<button data-tab-item=status-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("b511e30ecae57e8f289698fc3f1690b1","status-output")'>
<span class=tab-nav-text>Status Output</span></button></div><div class=tab-content-container><div data-tab-item=command class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl status otelcol-contrib</span></span></code></pre></div></div></div><div data-tab-item=status-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>â— otelcol-contrib.service - OpenTelemetry Collector Contrib
</span></span><span class=line><span class=cl>     Loaded: loaded (/lib/systemd/system/otelcol-contrib.service; enabled; vendor preset: enabled)
</span></span><span class=line><span class=cl>     Active: active (running) since Mon 2024-10-07 10:27:49 BST; 52s ago
</span></span><span class=line><span class=cl>   Main PID: 17113 (otelcol-contrib)
</span></span><span class=line><span class=cl>      Tasks: 13 (limit: 19238)
</span></span><span class=line><span class=cl>     Memory: 34.8M
</span></span><span class=line><span class=cl>        CPU: 155ms
</span></span><span class=line><span class=cl>     CGroup: /system.slice/otelcol-contrib.service
</span></span><span class=line><span class=cl>             â””â”€17113 /usr/bin/otelcol-contrib --config=/etc/otelcol-contrib/config.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Oct 07 10:28:36 petclinic-rum-testing otelcol-contrib[17113]: Descriptor:
</span></span><span class=line><span class=cl>Oct 07 10:28:36 petclinic-rum-testing otelcol-contrib[17113]:      -&gt; Name: up
</span></span><span class=line><span class=cl>Oct 07 10:28:36 petclinic-rum-testing otelcol-contrib[17113]:      -&gt; Description: The scraping was successful
</span></span><span class=line><span class=cl>Oct 07 10:28:36 petclinic-rum-testing otelcol-contrib[17113]:      -&gt; Unit:
</span></span><span class=line><span class=cl>Oct 07 10:28:36 petclinic-rum-testing otelcol-contrib[17113]:      -&gt; DataType: Gauge
</span></span><span class=line><span class=cl>Oct 07 10:28:36 petclinic-rum-testing otelcol-contrib[17113]: NumberDataPoints #0
</span></span><span class=line><span class=cl>Oct 07 10:28:36 petclinic-rum-testing otelcol-contrib[17113]: StartTimestamp: 1970-01-01 00:00:00 +0000 UTC
</span></span><span class=line><span class=cl>Oct 07 10:28:36 petclinic-rum-testing otelcol-contrib[17113]: Timestamp: 2024-10-07 09:28:36.942 +0000 UTC
</span></span><span class=line><span class=cl>Oct 07 10:28:36 petclinic-rum-testing otelcol-contrib[17113]: Value: 1.000000
</span></span><span class=line><span class=cl>Oct 07 10:28:36 petclinic-rum-testing otelcol-contrib[17113]:         {&#34;kind&#34;: &#34;exporter&#34;, &#34;data_type&#34;: &#34;metrics&#34;, &#34;name&#34;: &#34;debug&#34;}</span></span></code></pre></div></div></div></div></div><p>Because we will be making multiple configuration file changes, setting environment variables and restarting the collector, we need to stop the collector service and disable it from starting on boot.</p><div class=tab-panel data-tab-group=1d12316e52cd4f96e9cf0d4d366cf5cc><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=command class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1d12316e52cd4f96e9cf0d4d366cf5cc","command")'>
<span class=tab-nav-text>Command</span></button></div><div class=tab-content-container><div data-tab-item=command class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl stop otelcol-contrib <span class=o>&amp;&amp;</span> sudo systemctl disable otelcol-contrib</span></span></code></pre></div></div></div></div></div><hr><details class="box cstyle notices transparent expand"><summary class=box-label><i class="expander-icon fa-fw fas fa-chevron-right"></i>
<span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-user-ninja"></i></span><span class=badge-content><strong>Ninja:</strong> Build your own collector using Open Telemetry Collector Builder (ocb)</span></span></summary><div class=box-content><p>For this part we will require the following installed on your system:</p><ul><li><p>Golang (latest version)</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /tmp
</span></span><span class=line><span class=cl>wget https://golang.org/dl/go1.20.linux-amd64.tar.gz
</span></span><span class=line><span class=cl>sudo tar -C /usr/local -xzf go1.20.linux-amd64.tar.gz</span></span></code></pre></div><p>Edit <code>.profile</code> and add the following environment variables:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>GOROOT</span><span class=o>=</span>/usr/local/go
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>GOPATH</span><span class=o>=</span><span class=nv>$HOME</span>/go
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>PATH</span><span class=o>=</span><span class=nv>$GOPATH</span>/bin:<span class=nv>$GOROOT</span>/bin:<span class=nv>$PATH</span></span></span></code></pre></div><p>Renew your shell session:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>source</span> ~/.profile</span></span></code></pre></div><p>Check Go version:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go version</span></span></code></pre></div></li><li><p>ocb installed</p><ul><li><p>Download the ocb binary from the <a href=https://github.com/open-telemetry/opentelemetry-collector/releases/tag/cmd%2Fbuilder%2Fv0.80.0 rel=external target=_blank>project releases</a>
and run the following commands:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mv ocb_0.80.0_darwin_arm64 /usr/bin/ocb
</span></span><span class=line><span class=cl>chmod <span class=m>755</span> /usr/bin/ocb</span></span></code></pre></div><p>An alternative approach would be to use the golang tool chain to build the binary locally by doing:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go install go.opentelemetry.io/collector/cmd/builder@v0.80.0
</span></span><span class=line><span class=cl>mv <span class=k>$(</span>go env GOPATH<span class=k>)</span>/bin/builder /usr/bin/ocb</span></span></code></pre></div></li></ul></li><li><p>(Optional) Docker</p></li></ul><h2 id=why-build-your-own-collector>Why build your own collector?</h2><p>The default distribution of the collector (core and contrib) either contains too much or too little in what they have to offer.</p><p>It is also not advised to run the contrib collector in your production environments due to the amount of components installed which more than likely are not needed by your deployment.</p><h2 id=benefits-of-building-your-own-collector>Benefits of building your own collector?</h2><p>When creating your own collector binaries, (commonly referred to as distribution), means you build what you need.</p><p>The benefits of this are:</p><ol><li>Smaller sized binaries</li><li>Can use existing go scanners for vulnerabilities</li><li>Include internal components that can tie in with your organization</li></ol><h2 id=considerations-for-building-your-collector>Considerations for building your collector?</h2><p>Now, this would not be a ðŸ¥· Ninja zone if it didn&rsquo;t come with some drawbacks:</p><ol><li>Go experience is recommended if not required</li><li><strong>No</strong> Splunk support</li><li>Responsibility for distribution and lifecycle management</li></ol><p>It is important to note that the project is working towards stability but it does not mean changes made will not break your workflow. The team at Splunk provides increased support and a higher level of stability so they can provide a curated experience helping you with your deployment needs.</p><h2 id=the-ninja-zone>The Ninja Zone</h2><p>Once you have all the required tools installed to get started, you will need to create a new file named <code>otelcol-builder.yaml</code> and we will follow this directory structure:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>â””â”€â”€ otelcol-builder.yaml</span></span></code></pre></div><p>Once we have the file created, we need to add a list of components for it to install with some additional metadata.</p><p>For this example, we are going to create a builder manifest that will install only the components we need for the introduction config:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>dist</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>otelcol-ninja</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=l>A custom build of the Open Telemetry Collector</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>output_path</span><span class=p>:</span><span class=w> </span><span class=l>./dist</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>gomod</span><span class=p>:</span><span class=w> </span><span class=l>go.opentelemetry.io/collector/extension/ballastextension v0.80.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>gomod</span><span class=p>:</span><span class=w> </span><span class=l>go.opentelemetry.io/collector/extension/zpagesextension  v0.80.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>gomod</span><span class=p>:</span><span class=w> </span><span class=l>github.com/open-telemetry/opentelemetry-collector-contrib/extension/httpforwarder v0.80.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>gomod</span><span class=p>:</span><span class=w> </span><span class=l>github.com/open-telemetry/opentelemetry-collector-contrib/extension/healthcheckextension v0.80.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>gomod</span><span class=p>:</span><span class=w> </span><span class=l>go.opentelemetry.io/collector/exporter/loggingexporter v0.80.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>gomod</span><span class=p>:</span><span class=w> </span><span class=l>go.opentelemetry.io/collector/exporter/otlpexporter v0.80.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>gomod</span><span class=p>:</span><span class=w> </span><span class=l>github.com/open-telemetry/opentelemetry-collector-contrib/exporter/splunkhecexporter v0.80.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>gomod</span><span class=p>:</span><span class=w> </span><span class=l>github.com/open-telemetry/opentelemetry-collector-contrib/exporter/signalfxexporter v0.80.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>gomod</span><span class=p>:</span><span class=w> </span><span class=l>go.opentelemetry.io/collector/processor/batchprocessor v0.80.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>gomod</span><span class=p>:</span><span class=w> </span><span class=l>go.opentelemetry.io/collector/processor/memorylimiterprocessor v0.80.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>gomod</span><span class=p>:</span><span class=w> </span><span class=l>go.opentelemetry.io/collector/receiver/otlpreceiver v0.80.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>gomod</span><span class=p>:</span><span class=w> </span><span class=l>github.com/open-telemetry/opentelemetry-collector-contrib/receiver/hostmetricsreceiver v0.80.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>gomod</span><span class=p>:</span><span class=w> </span><span class=l>github.com/open-telemetry/opentelemetry-collector-contrib/receiver/jaegerreceiver v0.80.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>gomod</span><span class=p>:</span><span class=w> </span><span class=l>github.com/open-telemetry/opentelemetry-collector-contrib/receiver/prometheusreceiver v0.80.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>gomod</span><span class=p>:</span><span class=w> </span><span class=l>github.com/open-telemetry/opentelemetry-collector-contrib/receiver/zipkinreceiver v0.80.0</span></span></span></code></pre></div><p>Once the yaml file has been updated for the <em>ocb</em>, then run the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ocb --config<span class=o>=</span>otelcol-builder.yaml</span></span></code></pre></div><p>Which leave you with the following directory structure:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>â”œâ”€â”€ dist
</span></span><span class=line><span class=cl>â”‚Â Â  â”œâ”€â”€ components.go
</span></span><span class=line><span class=cl>â”‚Â Â  â”œâ”€â”€ components_test.go
</span></span><span class=line><span class=cl>â”‚Â Â  â”œâ”€â”€ go.mod
</span></span><span class=line><span class=cl>â”‚Â Â  â”œâ”€â”€ go.sum
</span></span><span class=line><span class=cl>â”‚Â Â  â”œâ”€â”€ main.go
</span></span><span class=line><span class=cl>â”‚Â Â  â”œâ”€â”€ main_others.go
</span></span><span class=line><span class=cl>â”‚Â Â  â”œâ”€â”€ main_windows.go
</span></span><span class=line><span class=cl>â”‚Â Â  â””â”€â”€ otelcol-ninja
</span></span><span class=line><span class=cl>â””â”€â”€ otelcol-builder.yaml</span></span></code></pre></div><h3 id=references>References</h3><ol><li><a href=https://opentelemetry.io/docs/collector/custom-collector/ rel=external target=_blank>https://opentelemetry.io/docs/collector/custom-collector/</a></li></ol></div></details><hr><h2 id=default-configuration>Default configuration</h2><p>OpenTelemetry is configured through YAML files. These files have default configurations that we can modify to meet our needs. Let&rsquo;s look at the default configuration that is supplied:</p><div class=tab-panel data-tab-group=5d29d88553d9c2af26b58c6a7c1cf272><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=command class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5d29d88553d9c2af26b58c6a7c1cf272","command")'>
<span class=tab-nav-text>Command</span>
</button>
<button data-tab-item=configyaml class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("5d29d88553d9c2af26b58c6a7c1cf272","configyaml")'>
<span class=tab-nav-text>config.yaml</span></button></div><div class=tab-content-container><div data-tab-item=command class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat /etc/otelcol-contrib/config.yaml</span></span></code></pre></div></div></div><div data-tab-item=configyaml class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" linenos=table><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># To limit exposure to denial of service attacks, change the host in endpoints below from 0.0.0.0 to a specific network interface.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># See https://github.com/open-telemetry/opentelemetry-collector/blob/main/docs/security-best-practices.md#safeguards-against-denial-of-service-attacks</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>health_check</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pprof</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>1777</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>zpages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>55679</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>otlp</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocols</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>grpc</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>4317</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>4318</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>opencensus</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>55678</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Collect own metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prometheus</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>scrape_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;otel-collector&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>targets</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;0.0.0.0:8888&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jaeger</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocols</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>grpc</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>14250</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>thrift_binary</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>6832</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>thrift_compact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>6831</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>thrift_http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>14268</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>zipkin</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>9411</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>batch</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbosity</span><span class=p>:</span><span class=w> </span><span class=l>detailed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlp, opencensus, jaeger, zipkin]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlp, opencensus, prometheus]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlp]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>health_check, pprof, zpages]</span></span></span></code></pre></td></tr></table></div></div></div></div></div></div><p>Congratulations! You have successfully downloaded and installed the OpenTelemetry Collector. You are well on your way to becoming an OTel Ninja. But first let&rsquo;s walk through configuration files and different distributions of the OpenTelemetry Collector.</p><details open class="box cstyle notices note"><summary class=box-label><i class="fa-fw fas fa-exclamation-circle"></i>
Note</summary><div class=box-content><p>Splunk does provide its own, fully supported, distribution of the OpenTelemetry Collector. This distribution is available to install from the <a href=https://github.com/signalfx/splunk-otel-collector rel=external target=_blank><strong>Splunk GitHub Repository</strong></a> or via a wizard in Splunk Observability Cloud that will build out a simple installation script to copy and paste. This distribution includes many additional features and enhancements that are not available in the OpenTelemetry Collector Contrib distribution.</p><ul><li>The Splunk Distribution of the OpenTelemetry Collector is production-tested; it is in use by the majority of customers in their production environments.</li><li>Customers that use our distribution can receive direct help from official Splunk support within SLAs.</li><li>Customers can use or migrate to the Splunk Distribution of the OpenTelemetry Collector without worrying about future breaking changes to its core configuration experience for metrics and traces collection (OpenTelemetry logs collection configuration is in beta). There may be breaking changes to the Collector&rsquo;s metrics.</li></ul></div></details><p>We will now walk through each section of the configuration file and modify it to send host metrics to Splunk Observability Cloud.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=opentelemetry-collector-extensions>OpenTelemetry Collector Extensions</h1><p>Now that we have the OpenTelemetry Collector installed, let&rsquo;s take a look at extensions for the OpenTelemetry Collector. Extensions are optional and available primarily for tasks that do not involve processing telemetry data. Examples of extensions include health monitoring, service discovery, and data forwarding.</p><pre class="mermaid align-center">
%%{
  init:{
    &#34;theme&#34;: &#34;base&#34;,
    &#34;themeVariables&#34;: {
      &#34;primaryColor&#34;: &#34;#ffffff&#34;,
      &#34;clusterBkg&#34;: &#34;#eff2fb&#34;,
      &#34;defaultLinkColor&#34;: &#34;#333333&#34;
    }
  }
}%%

flowchart LR;
    style E fill:#e20082,stroke:#333,stroke-width:4px,color:#fff
    subgraph Collector
    A[OTLP] --&gt; M(Receivers)
    B[JAEGER] --&gt; M(Receivers)
    C[Prometheus] --&gt; M(Receivers)
    end
    subgraph Processors
    M(Receivers) --&gt; H(Filters, Attributes, etc)
    E(Extensions)
    end
    subgraph Exporters
    H(Filters, Attributes, etc) --&gt; S(OTLP)
    H(Filters, Attributes, etc) --&gt; T(JAEGER)
    H(Filters, Attributes, etc) --&gt; U(Prometheus)
    end
</pre><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 2. Extensions</h1><article class=default><header class=headline></header><h1 id=opentelemetry-collector-extensions>OpenTelemetry Collector Extensions</h1><h2 id=health-check>Health Check</h2><p>Extensions are configured in the same <code>config.yaml</code> file that we referenced in the installation step. Let&rsquo;s edit the <code>config.yaml</code> file and configure the extensions. Note that the <strong>pprof</strong> and <strong>zpages</strong> extensions are already configured in the default <code>config.yaml</code> file. For the purpose of this workshop, we will only be updating the <strong>health_check</strong> extension to expose the port on all network interfaces on which we can access the health of the collector.</p><div class=tab-panel data-tab-group=e95b9c3739bf3d20f13c56ec74fc5f8c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=command class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e95b9c3739bf3d20f13c56ec74fc5f8c","command")'>
<span class=tab-nav-text>Command</span></button></div><div class=tab-content-container><div data-tab-item=command class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo vi /etc/otelcol-contrib/config.yaml</span></span></code></pre></div></div></div></div></div><div class=tab-panel data-tab-group=d76a0ad1aa67c0e8ee24e6fc378add1d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=extensions-configuration class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d76a0ad1aa67c0e8ee24e6fc378add1d","extensions-configuration")'>
<span class=tab-nav-text>Extensions Configuration</span></button></div><div class=tab-content-container><div data-tab-item=extensions-configuration class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" hl_lines=3><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>health_check</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>13133</span></span></span></code></pre></div></div></div></div></div><p>Start the collector:</p><div class=tab-panel data-tab-group=8ee7df7860e5dd2384b9f93817ff4b6a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=command class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8ee7df7860e5dd2384b9f93817ff4b6a","command")'>
<span class=tab-nav-text>Command</span></button></div><div class=tab-content-container><div data-tab-item=command class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>otelcol-contrib --config<span class=o>=</span>file:/etc/otelcol-contrib/config.yaml</span></span></code></pre></div></div></div></div></div><p>This extension enables an HTTP URL that can be probed to check the status of the OpenTelemetry Collector. This extension can be used as a liveness and/or readiness probe on Kubernetes. To learn more about the <code>curl</code> command, check out the <a href=https://curl.se/docs/manpage.html rel=external target=_blank>curl man page</a>.</p><p>Open a new terminal session and SSH into your instance to run the following command:</p><div class=tab-panel data-tab-group=b7ad35041c86616033124b832bc63a1f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=curl-command class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b7ad35041c86616033124b832bc63a1f","curl-command")'>
<span class=tab-nav-text>curl Command</span>
</button>
<button data-tab-item=curl-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("b7ad35041c86616033124b832bc63a1f","curl-output")'>
<span class=tab-nav-text>curl Output</span></button></div><div class=tab-content-container><div data-tab-item=curl-command class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://localhost:13133</span></span></code></pre></div></div></div><div data-tab-item=curl-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>{&#34;status&#34;:&#34;Server available&#34;,&#34;upSince&#34;:&#34;2024-10-07T11:00:08.004685295+01:00&#34;,&#34;uptime&#34;:&#34;12.56420005s&#34;}</span></span></code></pre></div></div></div></div></div><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=opentelemetry-collector-extensions>OpenTelemetry Collector Extensions</h1><h2 id=performance-profiler>Performance Profiler</h2><p><a href=https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/extension/pprofextension/README.md rel=external target=_blank><strong>Performance Profiler</strong></a> extension enables the golang net/http/pprof endpoint. This is typically used by developers to collect performance profiles and investigate issues with the service. <strong>We will not be covering this in this workshop</strong>.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=opentelemetry-collector-extensions>OpenTelemetry Collector Extensions</h1><h2 id=zpages>zPages</h2><p><a href=https://github.com/open-telemetry/opentelemetry-collector/blob/main/extension/zpagesextension/README.md rel=external target=_blank><strong>zPages</strong></a> are an in-process alternative to external exporters. When included, they collect and aggregate tracing and metrics information in the background; this data is served on web pages when requested. zPages are an extremely useful diagnostic feature to ensure the collector is running as expected.</p><div class=tab-panel data-tab-group=e2a4ae734b0cce35afff58e34fae3af4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=servicez class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e2a4ae734b0cce35afff58e34fae3af4","servicez")'>
<span class=tab-nav-text>ServiceZ</span>
</button>
<button data-tab-item=pipelinez class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("e2a4ae734b0cce35afff58e34fae3af4","pipelinez")'>
<span class=tab-nav-text>PipelineZ</span>
</button>
<button data-tab-item=extensionz class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("e2a4ae734b0cce35afff58e34fae3af4","extensionz")'>
<span class=tab-nav-text>ExtensionZ</span></button></div><div class=tab-content-container><div data-tab-item=servicez class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><p><strong>ServiceZ</strong> gives an overview of the collector services and quick access to the pipelinez, extensionz, and featurez zPages. The page also provides build and runtime information.</p><p>Example URL: <a href=http://localhost:55679/debug/servicez rel=external target=_blank><strong>http://localhost:55679/debug/servicez</strong></a> (change <code>localhost</code> to reflect your own environment).</p><p><a href=#R-image-2f6473713ea06c475f47da2fe4a85621 class=lightbox-link><img alt=ServiceZ class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/servicez.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-2f6473713ea06c475f47da2fe4a85621><img alt=ServiceZ class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/servicez.png></a></p></div></div><div data-tab-item=pipelinez class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><p><strong>PipelineZ</strong> provides insights on the running pipelines running in the collector. You can find information on type, if data is mutated, and you can also see information on the receivers, processors and exporters that are used for each pipeline.</p><p>Example URL: <a href=http://localhost:55679/debug/pipelinez rel=external target=_blank><strong>http://localhost:55679/debug/pipelinez</strong></a> (change <code>localhost</code> to reflect your own environment).</p><p><a href=#R-image-713e57cf3fbc27c0496928cfb567b038 class=lightbox-link><img alt=PipelineZ class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/pipelinez.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-713e57cf3fbc27c0496928cfb567b038><img alt=PipelineZ class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/pipelinez.png></a></p></div></div><div data-tab-item=extensionz class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><p><strong>ExtensionZ</strong> shows the extensions that are active in the collector.</p><p>Example URL: <a href=http://localhost:55679/debug/extensionz rel=external target=_blank><strong>http://localhost:55679/debug/extensionz</strong></a> (change <code>localhost</code> to reflect your own environment).</p><p><a href=#R-image-f592c12031f2c141fffb2dda0b9516dd class=lightbox-link><img alt=ExtensionZ class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/extensionz.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-f592c12031f2c141fffb2dda0b9516dd><img alt=ExtensionZ class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/extensionz.png></a></p></div></div></div></div><hr><details class="box cstyle notices transparent expand"><summary class=box-label><i class="expander-icon fa-fw fas fa-chevron-right"></i>
<span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-user-ninja"></i></span><span class=badge-content><strong>Ninja:</strong> Improve data durability with storage extension</span></span></summary><div class=box-content><p>For this, we will need to validate that our distribution has the <code>file_storage</code> extension installed. This can be done by running the command <code>otelcol-contrib components</code> which should show results like:</p><div class=tab-panel data-tab-group=56ec638df97d430cef0fd7400376d5f4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=truncated-output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("56ec638df97d430cef0fd7400376d5f4","truncated-output")'>
<span class=tab-nav-text>Truncated Output</span>
</button>
<button data-tab-item=full-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("56ec638df97d430cef0fd7400376d5f4","full-output")'>
<span class=tab-nav-text>Full Output</span></button></div><div class=tab-content-container><div data-tab-item=truncated-output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># ... truncated for clarity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>file_storage</span></span></span></code></pre></div></div></div><div data-tab-item=full-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>buildinfo</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>otelcol-contrib</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=l>OpenTelemetry Collector Contrib</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>0.80.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>prometheus_simple</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>influxdb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>purefa</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>purefb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>receiver_creator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>mongodbatlas</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>vcenter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>snmp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>expvar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>jmx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>kafka</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>skywalking</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>udplog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>carbon</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>kafkametrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>memcached</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>windowseventlog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>zookeeper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>otlp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>awsecscontainermetrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>iis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>nsxt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>aerospike</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>elasticsearch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>httpcheck</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>k8sobjects</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>mongodb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>hostmetrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>signalfx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>statsd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>awsxray</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>cloudfoundry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>collectd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>couchdb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>kubeletstats</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>jaeger</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>journald</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>riak</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>splunk_hec</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>active_directory_ds</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>awscloudwatch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>sqlquery</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>windowsperfcounters</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>flinkmetrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>googlecloudpubsub</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>podman_stats</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>wavefront</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>k8s_events</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>postgresql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>rabbitmq</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>sapm</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>sqlserver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>redis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>solace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>tcplog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>awscontainerinsightreceiver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>awsfirehose</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>bigip</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>filelog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>googlecloudspanner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>cloudflare</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker_stats</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>k8s_cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>pulsar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>zipkin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>opencensus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>azureeventhub</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>datadog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>fluentforward</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>otlpjsonfile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>syslog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>cumulativetodelta</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>groupbyattrs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>groupbytrace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>k8sattributes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>experimental_metricsgeneration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>metricstransform</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>routing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>attributes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>datadog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>deltatorate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>spanmetrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>span</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>redaction</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>servicegraph</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>transform</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>filter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>probabilistic_sampler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>tail_sampling</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>otlp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>carbon</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>datadog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>f5cloud</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>kafka</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>mezmo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>skywalking</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>awsxray</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>dynatrace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>loki</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>azuredataexplorer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>azuremonitor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>instana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>jaeger</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>loadbalancing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>sentry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>splunk_hec</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>tanzuobservability</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>zipkin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>alibabacloud_logservice</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>clickhouse</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>googlecloud</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>prometheusremotewrite</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>awscloudwatchlogs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>googlecloudpubsub</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>jaeger_thrift</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>logzio</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>sapm</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>sumologic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>otlphttp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>googlemanagedprometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>opencensus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>awskinesis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>coralogix</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>influxdb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>logicmonitor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>signalfx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>tencentcloud_logservice</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>awsemf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>elasticsearch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>pulsar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>zpages</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>bearertokenauth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>oidc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>host_observer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>sigv4auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>file_storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>memory_ballast</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>health_check</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>oauth2client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>awsproxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>http_forwarder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>jaegerremotesampling</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>k8s_observer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>pprof</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>asapclient</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>basicauth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>headers_setter</span></span></span></code></pre></div></div></div></div></div><p>This extension provides exporters the ability to queue data to disk in the event that exporter is unable to send data to the configured endpoint.</p><p>In order to configure the extension, you will need to update your config to include the information below. First, be sure to create a /tmp/otel-data directory and give it read/write permissions:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>file_storage</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>directory</span><span class=p>:</span><span class=w> </span><span class=l>/tmp/otel-data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>compaction</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>directory</span><span class=p>:</span><span class=w> </span><span class=l>/tmp/otel-data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>on_start</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>on_rebound</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>rebound_needed_threshold_mib</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>rebound_trigger_threshold_mib</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ... truncated for clarity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>health_check, pprof, zpages, file_storage]</span></span></span></code></pre></div><h2 id=why-queue-data-to-disk>Why queue data to disk?</h2><p>This allows the collector to weather network interruptions (and even collector restarts) to ensure data is sent to the upstream provider.</p><h2 id=considerations-for-queuing-data-to-disk>Considerations for queuing data to disk?</h2><p>There is a potential that this could impact data throughput performance due to disk performance.</p><h3 id=references>References</h3><ol><li><a href=https://community.splunk.com/t5/Community-Blog/Data-Persistence-in-the-OpenTelemetry-Collector/ba-p/624583 rel=external target=_blank>https://community.splunk.com/t5/Community-Blog/Data-Persistence-in-the-OpenTelemetry-Collector/ba-p/624583</a></li><li><a href=https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/extension/storage/filestorage rel=external target=_blank>https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/extension/storage/filestorage</a></li></ol></div></details><hr><h2 id=configuration-check-in>Configuration Check-in</h2><p>Now that we&rsquo;ve covered extensions, let&rsquo;s check our configuration changes.</p><hr><details class="box cstyle notices transparent expand"><summary class=box-label><i class="expander-icon fa-fw fas fa-chevron-right"></i>
<span class="badge cstyle default badge-with-title"><span class=badge-title><i class="fa-fw fas fa-check"></i> <strong>Check-in</strong></span><span class=badge-content style=background-color:green>Review your configuration</span></span></summary><div class=box-content><div class=tab-panel data-tab-group=d658c5037b63fd58d206a2d4a7d4b377><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configyaml class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d658c5037b63fd58d206a2d4a7d4b377","configyaml")'>
<span class=tab-nav-text>config.yaml</span></button></div><div class=tab-content-container><div data-tab-item=configyaml class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" hl_lines=5 linenos=table><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=hl><span class=lnt> 5
</span></span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># See https://github.com/open-telemetry/opentelemetry-collector/blob/main/docs/security-best-practices.md#safeguards-against-denial-of-service-attacks</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>health_check</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>13133</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pprof</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>1777</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>zpages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>55679</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>otlp</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocols</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>grpc</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>4317</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>4318</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>opencensus</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>55678</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Collect own metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prometheus</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>scrape_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;otel-collector&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>targets</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;0.0.0.0:8888&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jaeger</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocols</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>grpc</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>14250</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>thrift_binary</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>6832</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>thrift_compact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>6831</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>thrift_http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>14268</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>zipkin</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>9411</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>batch</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbosity</span><span class=p>:</span><span class=w> </span><span class=l>detailed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlp, opencensus, jaeger, zipkin]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlp, opencensus, prometheus]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlp]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>health_check, pprof, zpages]</span></span></span></code></pre></td></tr></table></div></div></div></div></div></div></div></details><hr><p>Now that we have reviewed extensions, let&rsquo;s dive into the data pipeline portion of the workshop. A pipeline defines a path the data follows in the Collector starting from reception, moving to further processing or modification, and finally exiting the Collector via exporters.</p><p>The data pipeline in the OpenTelemetry Collector is made up of <strong>receivers</strong>, <strong>processors</strong>, and <strong>exporters</strong>. We will first start with receivers.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=opentelemetry-collector-receivers>OpenTelemetry Collector Receivers</h1><p>Welcome to the receiver portion of the workshop! This is the starting point of the data pipeline of the OpenTelemetry Collector. Let&rsquo;s dive in.</p><p>A receiver, which can be push or pull based, is how data gets into the Collector. Receivers may support one or more data sources. Generally, a receiver accepts data in a specified format, translates it into the internal format and passes it to processors and exporters defined in the applicable pipelines.</p><pre class="mermaid align-center">
%%{
  init:{
    &#34;theme&#34;:&#34;base&#34;,
    &#34;themeVariables&#34;: {
      &#34;primaryColor&#34;: &#34;#ffffff&#34;,
      &#34;clusterBkg&#34;: &#34;#eff2fb&#34;,
      &#34;defaultLinkColor&#34;: &#34;#333333&#34;
    }
  }
}%%

flowchart LR;
    style M fill:#e20082,stroke:#333,stroke-width:4px,color:#fff
    subgraph Collector
    A[OTLP] --&gt; M(Receivers)
    B[JAEGER] --&gt; M(Receivers)
    C[Prometheus] --&gt; M(Receivers)
    end
    subgraph Processors
    M(Receivers) --&gt; H(Filters, Attributes, etc)
    E(Extensions)
    end
    subgraph Exporters
    H(Filters, Attributes, etc) --&gt; S(OTLP)
    H(Filters, Attributes, etc) --&gt; T(JAEGER)
    H(Filters, Attributes, etc) --&gt; U(Prometheus)
    end
</pre><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 3. Receivers</h1><article class=default><header class=headline></header><h1 id=opentelemetry-collector-receivers>OpenTelemetry Collector Receivers</h1><h2 id=host-metrics-receiver>Host Metrics Receiver</h2><p><a href=https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/receiver/hostmetricsreceiver/README.md rel=external target=_blank><strong>The Host Metrics Receiver</strong></a> generates metrics about the host system scraped from various sources. This is intended to be used when the collector is deployed as an agent which is what we will be doing in this workshop.</p><p>Let&rsquo;s update the <code>/etc/otel-contrib/config.yaml</code> file and configure the <strong>hostmetrics</strong> receiver. Insert the following YAML under the <strong>receivers</strong> section, taking care to indent by two spaces.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo vi /etc/otelcol-contrib/config.yaml</span></span></code></pre></div><div class=tab-panel data-tab-group=72ad1856914ca34ee20257b62b956f39><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=host-metrics-receiver-configuration class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("72ad1856914ca34ee20257b62b956f39","host-metrics-receiver-configuration")'>
<span class=tab-nav-text>Host Metrics Receiver Configuration</span></button></div><div class=tab-content-container><div data-tab-item=host-metrics-receiver-configuration class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" hl_lines=2-22><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>  </span><span class=nt>hostmetrics</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>collection_interval</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>scrapers</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=c># CPU utilization metrics</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>cpu</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=c># Disk I/O metrics</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>disk</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=c># File System utilization metrics</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>filesystem</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=c># Memory utilization metrics</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=c># Network interface I/O metrics &amp; TCP connection metrics</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>network</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=c># CPU load metrics</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>load</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=c># Paging/Swap space utilization and I/O metrics</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>paging</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=c># Process count metrics</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>processes</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=c># Per process CPU, Memory and Disk I/O metrics. Disabled by default.</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=c># process:</span></span></span></code></pre></div></div></div></div></div><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=opentelemetry-collector-receivers>OpenTelemetry Collector Receivers</h1><h2 id=prometheus-receiver>Prometheus Receiver</h2><p>You will also notice another receiver called <strong>prometheus</strong>. <a href=https://prometheus.io/docs/introduction/overview/ rel=external target=_blank><strong>Prometheus</strong></a> is an open-source toolkit used by the OpenTelemetry Collector. This receiver is used to scrape metrics from the OpenTelemetry Collector itself. These metrics can then be used to monitor the health of the collector.</p><p>Let&rsquo;s modify the <code>prometheus</code> receiver to clearly show that it is for collecting metrics from the collector itself. By changing the name of the receiver from <code>prometheus</code> to <code>prometheus/internal</code>, it is now much clearer as to what that receiver is doing. Update the configuration file to look like this:</p><div class=tab-panel data-tab-group=3c0e8bca4800e412ee8186a10e68923d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=prometheus-receiver-configuration class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3c0e8bca4800e412ee8186a10e68923d","prometheus-receiver-configuration")'>
<span class=tab-nav-text>Prometheus Receiver Configuration</span></button></div><div class=tab-content-container><div data-tab-item=prometheus-receiver-configuration class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" hl_lines=1><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class="line hl"><span class=cl><span class=nt>prometheus/internal</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>scrape_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;otel-collector&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>targets</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;0.0.0.0:8888&#39;</span><span class=p>]</span></span></span></code></pre></div></div></div></div></div><h2 id=example-dashboard---prometheus-metrics>Example Dashboard - Prometheus metrics</h2><p>The following screenshot shows an example dashboard of some of the metrics the Prometheus internal receiver collects from the OpenTelemetry Collector. Here, we can see accepted and sent spans, metrics and log records.</p><details open class="box cstyle notices note"><summary class=box-label><i class="fa-fw fas fa-exclamation-circle"></i>
Note</summary><div class=box-content><p>The following screenshot is an out-of-the-box (OOTB) dashboard from Splunk Observability Cloud that allows you to easily monitor your Splunk OpenTelemetry Collector install base.</p></div></details><p><a href=#R-image-5f7a27270abea50c5627588f63d5ef52 class=lightbox-link><img alt=otel-charts class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/otel-charts.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5f7a27270abea50c5627588f63d5ef52><img alt=otel-charts class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/otel-charts.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=opentelemetry-collector-receivers>OpenTelemetry Collector Receivers</h1><h2 id=other-receivers>Other Receivers</h2><p>You will notice in the default configuration there are other receivers: <strong>otlp</strong>, <strong>opencensus</strong>, <strong>jaeger</strong> and <strong>zipkin</strong>. These are used to receive telemetry data from other sources. We will not be covering these receivers in this workshop and they can be left as they are.</p><hr><details class="box cstyle notices transparent expand"><summary class=box-label><i class="expander-icon fa-fw fas fa-chevron-right"></i>
<span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-user-ninja"></i></span><span class=badge-content><strong>Ninja:</strong> Create receivers dynamically</span></span></summary><div class=box-content><p>To help observe short lived tasks like docker containers, kubernetes pods, or ssh sessions, we can use the <a href=https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/receivercreator rel=external target=_blank>receiver creator</a> with <a href=https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/extension/observer rel=external target=_blank>observer extensions</a> to create a new receiver as these services start up.</p><h2 id=what-do-we-need>What do we need?</h2><p>In order to start using the receiver creator and its associated observer extensions, they will need to be part of your collector build manifest.</p><p>See <a href=/observability-workshop/v5.90/en/ninja-workshops/3-opentelemetry-collector-workshops/1-opentelemetry-collector/1-installation/index.html>installation</a> for the details.</p><h2 id=things-to-consider>Things to consider?</h2><p>Some short lived tasks may require additional configuration such as <em>username</em>, and <em>password</em>.
These values can be referenced via <a href=https://opentelemetry.io/docs/collector/configuration/#configuration-environment-variables rel=external target=_blank>environment variables</a>,
or use a scheme expand syntax such as <code>${file:./path/to/database/password}</code>.
Please adhere to your organisation&rsquo;s secret practices when taking this route.</p><h2 id=the-ninja-zone>The Ninja Zone</h2><p>There are only two things needed for this ninja zone:</p><ol><li>Make sure you have added receiver creater and observer extensions to the builder manifest.</li><li>Create the config that can be used to match against discovered endpoints.</li></ol><p>To create the templated configurations, you can do the following:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>receiver_creator</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>watch_observers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>host_observer]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>redis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>rule</span><span class=p>:</span><span class=w> </span><span class=l>type == &#34;port&#34; &amp;&amp; port == 6379</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>${env:HOST_REDIS_PASSWORD}</span></span></span></code></pre></div><p>For more examples, refer to these <a href=https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/receivercreator#examples rel=external target=_blank>receiver creator&rsquo;s examples</a>.</p></div></details><hr><h2 id=configuration-check-in>Configuration Check-in</h2><p>We&rsquo;ve now covered receivers, so let&rsquo;s now check our configuration changes.</p><hr><details class="box cstyle notices transparent expand"><summary class=box-label><i class="expander-icon fa-fw fas fa-chevron-right"></i>
<span class="badge cstyle default badge-with-title"><span class=badge-title><i class="fa-fw fas fa-check"></i> <strong>Check-in</strong></span><span class=badge-content style=background-color:green>Review your configuration</span></span></summary><div class=box-content><div class=tab-panel data-tab-group=ce66c47b31e9390044ebee69a7df0f24><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configyaml class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ce66c47b31e9390044ebee69a7df0f24","configyaml")'>
<span class=tab-nav-text>config.yaml</span></button></div><div class=tab-content-container><div data-tab-item=configyaml class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" hl_lines="13-33 45" linenos=table><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=hl><span class=lnt>13
</span></span><span class=hl><span class=lnt>14
</span></span><span class=hl><span class=lnt>15
</span></span><span class=hl><span class=lnt>16
</span></span><span class=hl><span class=lnt>17
</span></span><span class=hl><span class=lnt>18
</span></span><span class=hl><span class=lnt>19
</span></span><span class=hl><span class=lnt>20
</span></span><span class=hl><span class=lnt>21
</span></span><span class=hl><span class=lnt>22
</span></span><span class=hl><span class=lnt>23
</span></span><span class=hl><span class=lnt>24
</span></span><span class=hl><span class=lnt>25
</span></span><span class=hl><span class=lnt>26
</span></span><span class=hl><span class=lnt>27
</span></span><span class=hl><span class=lnt>28
</span></span><span class=hl><span class=lnt>29
</span></span><span class=hl><span class=lnt>30
</span></span><span class=hl><span class=lnt>31
</span></span><span class=hl><span class=lnt>32
</span></span><span class=hl><span class=lnt>33
</span></span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=hl><span class=lnt>45
</span></span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># To limit exposure to denial of service attacks, change the host in endpoints below from 0.0.0.0 to a specific network interface.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># See https://github.com/open-telemetry/opentelemetry-collector/blob/main/docs/security-best-practices.md#safeguards-against-denial-of-service-attacks</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>health_check</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>13133</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pprof</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>1777</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>zpages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>55679</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>  </span><span class=nt>hostmetrics</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>collection_interval</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>scrapers</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=c># CPU utilization metrics</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>cpu</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=c># Disk I/O metrics</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>disk</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=c># File System utilization metrics</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>filesystem</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=c># Memory utilization metrics</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=c># Network interface I/O metrics &amp; TCP connection metrics</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>network</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=c># CPU load metrics</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>load</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=c># Paging/Swap space utilization and I/O metrics</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>paging</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=c># Process count metrics</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>processes</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=c># Per process CPU, Memory and Disk I/O metrics. Disabled by default.</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=c># process:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>otlp</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocols</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>grpc</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>4317</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>4318</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>opencensus</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>55678</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Collect own metrics</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>  </span><span class=nt>prometheus/internal</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>scrape_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;otel-collector&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>targets</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;0.0.0.0:8888&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jaeger</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocols</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>grpc</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>14250</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>thrift_binary</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>6832</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>thrift_compact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>6831</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>thrift_http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>14268</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>zipkin</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>9411</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>batch</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbosity</span><span class=p>:</span><span class=w> </span><span class=l>detailed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlp, opencensus, jaeger, zipkin]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlp, opencensus, prometheus]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlp]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>health_check, pprof, zpages]</span></span></span></code></pre></td></tr></table></div></div></div></div></div></div></div></details><hr><p>Now that we have reviewed how data gets into the OpenTelemetry Collector through receivers, let&rsquo;s now take a look at how the Collector processes the received data.</p><details open class="box cstyle notices warning"><summary class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i>
Warning</summary><div class=box-content><p>As the <code>/etc/otelcol-contrib/config.yaml</code> is not complete, please <strong>do not</strong> attempt to restart the collector at this point.</p></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=opentelemetry-collector-processors>OpenTelemetry Collector Processors</h1><p><a href=https://github.com/open-telemetry/opentelemetry-collector/blob/main/processor/README.md rel=external target=_blank><strong>Processors</strong></a> are run on data between being received and being exported. Processors are optional though some are recommended. There are <a href=https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor rel=external target=_blank><strong>a large number of processors</strong></a> included in the OpenTelemetry contrib Collector.</p><pre class="mermaid align-center">
%%{
  init:{
    &#34;theme&#34;:&#34;base&#34;,
    &#34;themeVariables&#34;: {
      &#34;primaryColor&#34;: &#34;#ffffff&#34;,
      &#34;clusterBkg&#34;: &#34;#eff2fb&#34;,
      &#34;defaultLinkColor&#34;: &#34;#333333&#34;
    }
  }
}%%

flowchart LR;
    style Processors fill:#e20082,stroke:#333,stroke-width:4px,color:#fff
    subgraph Collector
    A[OTLP] --&gt; M(Receivers)
    B[JAEGER] --&gt; M(Receivers)
    C[Prometheus] --&gt; M(Receivers)
    end
    subgraph Processors
    M(Receivers) --&gt; H(Filters, Attributes, etc)
    E(Extensions)
    end
    subgraph Exporters
    H(Filters, Attributes, etc) --&gt; S(OTLP)
    H(Filters, Attributes, etc) --&gt; T(JAEGER)
    H(Filters, Attributes, etc) --&gt; U(Prometheus)
    end
</pre><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 4. Processors</h1><article class=default><header class=headline></header><h1 id=opentelemetry-collector-processors>OpenTelemetry Collector Processors</h1><h2 id=batch-processor>Batch Processor</h2><p>By default, only the <strong>batch</strong> processor is enabled. This processor is used to batch up data before it is exported. This is useful for reducing the number of network calls made to exporters. For this workshop, we will inherit the following defaults which are hard-coded into the Collector:</p><ul><li><code>send_batch_size</code> (default = 8192): Number of spans, metric data points, or log records after which a batch will be sent regardless of the timeout. send_batch_size acts as a trigger and does not affect the size of the batch. If you need to enforce batch size limits sent to the next component in the pipeline see send_batch_max_size.</li><li><code>timeout</code> (default = 200ms): Time duration after which a batch will be sent regardless of size. If set to zero, send_batch_size is ignored as data will be sent immediately, subject to only send_batch_max_size.</li><li><code>send_batch_max_size</code> (default = 0): The upper limit of the batch size. 0 means no upper limit on the batch size. This property ensures that larger batches are split into smaller units. It must be greater than or equal to send_batch_size.</li></ul><p>For more information on the Batch processor, see the <a href=https://github.com/open-telemetry/opentelemetry-collector/blob/main/processor/batchprocessor/README.md rel=external target=_blank><strong>Batch Processor documentation</strong></a>.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=opentelemetry-collector-processors>OpenTelemetry Collector Processors</h1><h2 id=resource-detection-processor>Resource Detection Processor</h2><p>The <strong>resourcedetection</strong> processor can be used to detect resource information from the host and append or override the resource value in telemetry data with this information.</p><p>By default, the hostname is set to the FQDN if possible, otherwise, the hostname provided by the OS is used as a fallback. This logic can be changed from using using the <code>hostname_sources</code> configuration option. To avoid getting the FQDN and use the hostname provided by the OS, we will set the <code>hostname_sources</code> to <code>os</code>.</p><div class=tab-panel data-tab-group=678475f818fd7117cb604fa57af51de3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=system-resource-detection-processor-configuration class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("678475f818fd7117cb604fa57af51de3","system-resource-detection-processor-configuration")'>
<span class=tab-nav-text>System Resource Detection Processor Configuration</span></button></div><div class=tab-content-container><div data-tab-item=system-resource-detection-processor-configuration class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" hl_lines=3-7><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>batch</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>  </span><span class=nt>resourcedetection/system</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>detectors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>system]</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>system</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>hostname_sources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>os]</span></span></span></code></pre></div></div></div></div></div><p>If the workshop instance is running on an AWS/EC2 instance we can gather the following tags from the EC2 metadata API (this is not available on other platforms).</p><ul><li><code>cloud.provider ("aws")</code></li><li><code>cloud.platform ("aws_ec2")</code></li><li><code>cloud.account.id</code></li><li><code>cloud.region</code></li><li><code>cloud.availability_zone</code></li><li><code>host.id</code></li><li><code>host.image.id</code></li><li><code>host.name</code></li><li><code>host.type</code></li></ul><p>We will create another processor to append these tags to our metrics.</p><div class=tab-panel data-tab-group=aae435b5c30c603afbf09a9529f59d5d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=ec2-resource-detection-processor-configuration class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("aae435b5c30c603afbf09a9529f59d5d","ec2-resource-detection-processor-configuration")'>
<span class=tab-nav-text>EC2 Resource Detection Processor Configuration</span></button></div><div class=tab-content-container><div data-tab-item=ec2-resource-detection-processor-configuration class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" hl_lines=7-8><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>batch</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourcedetection/system</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>detectors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>system]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>system</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hostname_sources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>os]</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>  </span><span class=nt>resourcedetection/ec2</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>detectors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>ec2]</span></span></span></code></pre></div></div></div></div></div><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=opentelemetry-collector-processors>OpenTelemetry Collector Processors</h1><h2 id=attributes-processor>Attributes Processor</h2><p>The attributes processor modifies attributes of a span, log, or metric. This processor also supports the ability to filter and match input data to determine if they should be included or excluded for specified actions.</p><p>It takes a list of actions that are performed in the order specified in the config. The supported actions are:</p><ul><li><code>insert</code>: Inserts a new attribute in input data where the key does not already exist.</li><li><code>update</code>: Updates an attribute in input data where the key does exist.</li><li><code>upsert</code>: Performs insert or update. Inserts a new attribute in input data where the key does not already exist and updates an attribute in input data where the key does exist.</li><li><code>delete</code>: Deletes an attribute from the input data.</li><li><code>hash</code>: Hashes (SHA1) an existing attribute value.</li><li><code>extract</code>: Extracts values using a regular expression rule from the input key to target keys specified in the rule. If a target key already exists, it will be overridden.</li></ul><p>We are going to create an attributes processor to <code>insert</code> a new attribute to all our host metrics called <code>participant.name</code> with a value of your name e.g. <code>marge_simpson</code>.</p><details open class="box cstyle notices warning"><summary class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i>
Warning</summary><div class=box-content><p>Ensure you replace <code>INSERT_YOUR_NAME_HERE</code> with your name and also ensure you <strong>do not</strong> use spaces in your name.</p></div></details><p>Later on in the workshop, we will use this attribute to filter our metrics in Splunk Observability Cloud.</p><div class=tab-panel data-tab-group=b7df082e90d3409dac1867a3170977b9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=attributes-processor-configuration class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b7df082e90d3409dac1867a3170977b9","attributes-processor-configuration")'>
<span class=tab-nav-text>Attributes Processor Configuration</span></button></div><div class=tab-content-container><div data-tab-item=attributes-processor-configuration class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" hl_lines=9-13><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>batch</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourcedetection/system</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>detectors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>system]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>system</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hostname_sources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>os]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourcedetection/ec2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>detectors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>ec2]</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>  </span><span class=nt>attributes/conf</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>actions</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>participant.name</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>        </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>insert</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>        </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;INSERT_YOUR_NAME_HERE&#34;</span></span></span></code></pre></div></div></div></div></div><hr><details class="box cstyle notices transparent expand"><summary class=box-label><i class="expander-icon fa-fw fas fa-chevron-right"></i>
<span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-user-ninja"></i></span><span class=badge-content><strong>Ninja:</strong> Using connectors to gain internal insights</span></span></summary><div class=box-content><p>One of the most recent additions to the collector was the notion of a <a href=https://opentelemetry.io/docs/collector/configuration/#connectors rel=external target=_blank><strong>connector</strong></a>, which allows you to join the output of one pipeline to the input of another pipeline.</p><p>An example of how this is beneficial is that some services emit metrics based on the amount of datapoints being exported, the number of logs containing an error status,
or the amount of data being sent from one deployment environment. The count connector helps address this for you out of the box.</p><h2 id=why-a-connector-instead-of-a-processor>Why a connector instead of a processor?</h2><p>A processor is limited in what additional data it can produce considering it has to pass on the data it has processed making it hard to expose additional information. Connectors do not have to emit the data they receive which means they provide an opportunity to create the insights we are after.</p><p>For example, a connector could be made to count the number of logs, metrics, and traces that do not have the deployment environment attribute.</p><p>A very simple example with the output of being able to break down data usage by deployment environment.</p><h2 id=considerations-with-connectors>Considerations with connectors</h2><p>A connector only accepts data exported from one pipeline and receiver by another pipeline, this means you may have to consider how you construct your collector config to take advantage of it.</p><h2 id=references>References</h2><ol><li><a href=https://opentelemetry.io/docs/collector/configuration/#connectors rel=external target=_blank><strong>https://opentelemetry.io/docs/collector/configuration/#connectors</strong></a></li><li><a href=https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/connector/countconnector rel=external target=_blank><strong>https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/connector/countconnector</strong></a></li></ol></div></details><hr><h2 id=configuration-check-in>Configuration Check-in</h2><p>That&rsquo;s processors covered, let&rsquo;s check our configuration changes.</p><hr><details class="box cstyle notices transparent expand"><summary class=box-label><i class="expander-icon fa-fw fas fa-chevron-right"></i>
<span class="badge cstyle default badge-with-title"><span class=badge-title><i class="fa-fw fas fa-check"></i> <strong>Check-in</strong></span><span class=badge-content style=background-color:green>Review your configuration</span></span></summary><div class=box-content><div class=tab-panel data-tab-group=e47b20635a1f648f7aecf0849fdb3ec3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configyaml class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e47b20635a1f648f7aecf0849fdb3ec3","configyaml")'>
<span class=tab-nav-text>config.yaml</span></button></div><div class=tab-content-container><div data-tab-item=configyaml class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" hl_lines=69-79 linenos=table><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=hl><span class=lnt> 69
</span></span><span class=hl><span class=lnt> 70
</span></span><span class=hl><span class=lnt> 71
</span></span><span class=hl><span class=lnt> 72
</span></span><span class=hl><span class=lnt> 73
</span></span><span class=hl><span class=lnt> 74
</span></span><span class=hl><span class=lnt> 75
</span></span><span class=hl><span class=lnt> 76
</span></span><span class=hl><span class=lnt> 77
</span></span><span class=hl><span class=lnt> 78
</span></span><span class=hl><span class=lnt> 79
</span></span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># To limit exposure to denial of service attacks, change the host in endpoints below from 0.0.0.0 to a specific network interface.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># See https://github.com/open-telemetry/opentelemetry-collector/blob/main/docs/security-best-practices.md#safeguards-against-denial-of-service-attacks</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>health_check</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>13133</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pprof</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>1777</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>zpages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>55679</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hostmetrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>collection_interval</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>scrapers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># CPU utilization metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cpu</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Disk I/O metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>disk</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># File System utilization metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>filesystem</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Memory utilization metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Network interface I/O metrics &amp; TCP connection metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>network</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># CPU load metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>load</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Paging/Swap space utilization and I/O metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>paging</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Process count metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Per process CPU, Memory and Disk I/O metrics. Disabled by default.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># process:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>otlp</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocols</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>grpc</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>4317</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>4318</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>opencensus</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>55678</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Collect own metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prometheus/internal</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>scrape_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;otel-collector&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>targets</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;0.0.0.0:8888&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jaeger</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocols</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>grpc</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>14250</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>thrift_binary</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>6832</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>thrift_compact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>6831</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>thrift_http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>14268</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>zipkin</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>9411</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>batch</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>  </span><span class=nt>resourcedetection/system</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>detectors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>system]</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>system</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>hostname_sources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>os]</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>  </span><span class=nt>resourcedetection/ec2</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>detectors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>ec2]</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>  </span><span class=nt>attributes/conf</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>actions</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>participant.name</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>        </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>insert</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>        </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;INSERT_YOUR_NAME_HERE&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbosity</span><span class=p>:</span><span class=w> </span><span class=l>detailed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlp, opencensus, jaeger, zipkin]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlp, opencensus, prometheus]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlp]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>health_check, pprof, zpages]</span></span></span></code></pre></td></tr></table></div></div></div></div></div></div></div></details><hr><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=opentelemetry-collector-exporters>OpenTelemetry Collector Exporters</h1><p>An exporter, which can be push or pull-based, is how you send data to one or more backends/destinations. Exporters may support one or more data sources.</p><p>For this workshop, we will be using the <a href=https://opentelemetry.io/docs/specs/otel/protocol/exporter/ rel=external target=_blank><strong>otlphttp</strong></a> exporter. The OpenTelemetry Protocol (OTLP) is a vendor-neutral, standardised protocol for transmitting telemetry data. The OTLP exporter sends data to a server that implements the OTLP protocol. The OTLP exporter supports both <a href=https://grpc.io/ rel=external target=_blank><strong>gRPC</strong></a> and <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Overview rel=external target=_blank><strong>HTTP</strong></a>/<a href=https://www.json.org/json-en.html rel=external target=_blank><strong>JSON</strong></a> protocols.</p><pre class="mermaid align-center">
%%{
  init:{
    &#34;theme&#34;:&#34;base&#34;,
    &#34;themeVariables&#34;: {
      &#34;primaryColor&#34;: &#34;#ffffff&#34;,
      &#34;clusterBkg&#34;: &#34;#eff2fb&#34;,
      &#34;defaultLinkColor&#34;: &#34;#333333&#34;
    }
  }
}%%

flowchart LR;
    style Exporters fill:#e20082,stroke:#333,stroke-width:4px,color:#fff
    subgraph Collector
    A[OTLP] --&gt; M(Receivers)
    B[JAEGER] --&gt; M(Receivers)
    C[Prometheus] --&gt; M(Receivers)
    end
    subgraph Processors
    M(Receivers) --&gt; H(Filters, Attributes, etc)
    E(Extensions)
    end
    subgraph Exporters
    H(Filters, Attributes, etc) --&gt; S(OTLP)
    H(Filters, Attributes, etc) --&gt; T(JAEGER)
    H(Filters, Attributes, etc) --&gt; U(Prometheus)
    end
</pre><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 5. Exporters</h1><article class=default><header class=headline></header><h1 id=opentelemetry-collector-exporters>OpenTelemetry Collector Exporters</h1><h2 id=otlp-http-exporter>OTLP HTTP Exporter</h2><p>To send metrics over HTTP to Splunk Observability Cloud, we will need to configure the <strong>otlphttp</strong> exporter.</p><p>Let&rsquo;s edit our <code>/etc/otelcol-contrib/config.yaml</code> file and configure the <strong>otlphttp</strong> exporter. Insert the following YAML under the <strong>exporters</strong> section, taking care to indent by two spaces e.g.</p><p>We will also change the verbosity of the logging exporter to prevent the disk from filling up. The default of <code>detailed</code> is very noisy.</p><div class="highlight wrap-code" hl_lines=3-4><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>logging</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>verbosity</span><span class=p>:</span><span class=w> </span><span class=l>normal</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>  </span><span class=l>otlphttp/splunk:</span></span></span></code></pre></div><p>Next, we need to define the <code>metrics_endpoint</code> and configure the target URL.</p><details open class="box cstyle notices note"><summary class=box-label><i class="fa-fw fas fa-exclamation-circle"></i>
Note</summary><div class=box-content><p>If you are an attendee at a Splunk-hosted workshop, the instance you are using has already been configured with a Realm environment variable. We will reference that environment variable in our configuration file. Otherwise, you will need to create a new environment variable and set the Realm e.g.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>REALM</span><span class=o>=</span><span class=s2>&#34;us1&#34;</span></span></span></code></pre></div></div></details><p>The URL to use is <code>https://ingest.${env:REALM}.signalfx.com/v2/datapoint/otlp</code>. (Splunk has Realms in key geographical locations around the world for data residency).</p><p>The <strong>otlphttp</strong> exporter can also be configured to send traces and logs by defining a target URL for <code>traces_endpoint</code> and <code>logs_endpoint</code> respectively. Configuring these is outside the scope of this workshop.</p><div class="highlight wrap-code" hl_lines=5><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>logging</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbosity</span><span class=p>:</span><span class=w> </span><span class=l>normal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>otlphttp/splunk</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>metrics_endpoint</span><span class=p>:</span><span class=w> </span><span class=l>https://ingest.${env:REALM}.signalfx.com/v2/datapoint/otlp</span></span></span></code></pre></div><p>By default, <code>gzip</code> compression is enabled for all endpoints. This can be disabled by setting <code>compression: none</code> in the exporter configuration. We will leave compression enabled for this workshop and accept the default as this is the most efficient way to send data.</p><p>To send metrics to Splunk Observability Cloud, we need to use an Access Token. This can be done by creating a new token in the Splunk Observability Cloud UI. For more information on how to create a token, see <a href=https://docs.splunk.com/Observability/admin/authentication-tokens/org-tokens.html rel=external target=_blank>Create a token</a>. The token needs to be of type <strong>INGEST</strong>.</p><details open class="box cstyle notices note"><summary class=box-label><i class="fa-fw fas fa-exclamation-circle"></i>
Note</summary><div class=box-content><p>If you are an attendee at a Splunk-hosted workshop, the instance you are using has already been configured with an Access Token (which has been set as an environment variable). We will reference that environment variable in our configuration file. Otherwise, you will need to create a new token and set it as an environment variable e.g.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>ACCESS_TOKEN</span><span class=o>=</span>&lt;replace-with-your-token&gt;</span></span></code></pre></div></div></details><p>The token is defined in the configuration file by inserting <code>X-SF-TOKEN: ${env:ACCESS_TOKEN}</code> under a <code>headers:</code> section:</p><div class="highlight wrap-code" hl_lines=6-8><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>logging</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbosity</span><span class=p>:</span><span class=w> </span><span class=l>normal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>otlphttp/splunk</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics_endpoint</span><span class=p>:</span><span class=w> </span><span class=l>https://ingest.${env:REALM}.signalfx.com/v2/datapoint/otlp</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>headers</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>X-SF-TOKEN</span><span class=p>:</span><span class=w> </span><span class=l>${env:ACCESS_TOKEN}</span></span></span></code></pre></div><h2 id=configuration-check-in>Configuration Check-in</h2><p>Now that we&rsquo;ve covered exporters, let&rsquo;s check our configuration changes:</p><hr><details class="box cstyle notices transparent expand"><summary class=box-label><i class="expander-icon fa-fw fas fa-chevron-right"></i>
<span class="badge cstyle default badge-with-title"><span class=badge-title><i class="fa-fw fas fa-check"></i> <strong>Check-in</strong></span><span class=badge-content style=background-color:green>Review your configuration</span></span></summary><div class=box-content><div class=tab-panel data-tab-group=93925cdb25bc3aa38fc285263ff83001><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configyaml class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("93925cdb25bc3aa38fc285263ff83001","configyaml")'>
<span class=tab-nav-text>config.yaml</span></button></div><div class=tab-content-container><div data-tab-item=configyaml class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" hl_lines=83-87 linenos=table><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=hl><span class=lnt> 83
</span></span><span class=hl><span class=lnt> 84
</span></span><span class=hl><span class=lnt> 85
</span></span><span class=hl><span class=lnt> 86
</span></span><span class=hl><span class=lnt> 87
</span></span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># To limit exposure to denial of service attacks, change the host in endpoints below from 0.0.0.0 to a specific network interface.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># See https://github.com/open-telemetry/opentelemetry-collector/blob/main/docs/security-best-practices.md#safeguards-against-denial-of-service-attacks</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>health_check</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>13133</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pprof</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>1777</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>zpages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>55679</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hostmetrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>collection_interval</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>scrapers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># CPU utilization metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cpu</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Disk I/O metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>disk</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># File System utilization metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>filesystem</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Memory utilization metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Network interface I/O metrics &amp; TCP connection metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>network</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># CPU load metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>load</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Paging/Swap space utilization and I/O metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>paging</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Process count metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Per process CPU, Memory and Disk I/O metrics. Disabled by default.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># process:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>otlp</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocols</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>grpc</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>4317</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>4318</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>opencensus</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>55678</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Collect own metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prometheus/internal</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>scrape_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;otel-collector&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>targets</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;0.0.0.0:8888&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jaeger</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocols</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>grpc</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>14250</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>thrift_binary</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>6832</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>thrift_compact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>6831</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>thrift_http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>14268</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>zipkin</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>9411</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>batch</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourcedetection/system</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>detectors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>system]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>system</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hostname_sources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>os]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourcedetection/ec2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>detectors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>ec2]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>attributes/conf</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>actions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>participant.name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>insert</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;INSERT_YOUR_NAME_HERE&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>verbosity</span><span class=p>:</span><span class=w> </span><span class=l>normal</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>  </span><span class=nt>otlphttp/splunk</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>metrics_endpoint</span><span class=p>:</span><span class=w> </span><span class=l>https://ingest.${env:REALM}.signalfx.com/v2/datapoint/otlp</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>headers</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>X-SF-Token</span><span class=p>:</span><span class=w> </span><span class=l>${env:ACCESS_TOKEN}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlp, opencensus, jaeger, zipkin]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlp, opencensus, prometheus]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlp]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>health_check, pprof, zpages]</span></span></span></code></pre></td></tr></table></div></div></div></div></div></div></div></details><hr><p>Of course, you can easily configure the <code>metrics_endpoint</code> to point to any other solution that supports the <strong>OTLP</strong> protocol.</p><p>Next, we need to enable the receivers, processors and exporters we have just configured in the service section of the <code>config.yaml</code>.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=opentelemetry-collector-service>OpenTelemetry Collector Service</h1><p>The <strong>Service</strong> section is used to configure what components are enabled in the Collector based on the configuration found in the receivers, processors, exporters, and extensions sections.</p><details open class="box cstyle notices info"><summary class=box-label><i class="fa-fw fas fa-info-circle"></i>
Info</summary><div class=box-content><p>If a component is configured, but not defined within the <strong>Service</strong> section then it is <strong>not</strong> enabled.</p></div></details><p>The service section consists of three sub-sections:</p><ul><li>extensions</li><li>pipelines</li><li>telemetry</li></ul><p>In the default configuration, the extension section has been configured to enable <code>health_check</code>, <code>pprof</code> and <code>zpages</code>, which we configured in the Extensions module earlier.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>health_check, pprof, zpages]</span></span></span></code></pre></div><p>So lets configure our Metric Pipeline!</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 6. Service</h1><article class=default><header class=headline></header><h1 id=opentelemetry-collector-service>OpenTelemetry Collector Service</h1><h2 id=hostmetrics-receiver>Hostmetrics Receiver</h2><p>If you recall from the Receivers portion of the workshop, we defined the <a href=/observability-workshop/v5.90/en/ninja-workshops/3-opentelemetry-collector-workshops/1-opentelemetry-collector/3-receivers/index.html#host-metrics-receiver><strong>Host Metrics Receiver</strong></a> to generate metrics about the host system, which are scraped from various sources. To enable the receiver, we must include the <code>hostmetrics</code> receiver in the metrics pipeline.</p><p>In the <code>metrics</code> pipeline, add <code>hostmetrics</code> to the metrics <code>receivers</code> section.</p><div class="highlight wrap-code" hl_lines=11><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlp, opencensus, jaeger, zipkin]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>hostmetrics, otlp, opencensus, prometheus]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug]</span></span></span></code></pre></div><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=opentelemetry-collector-service>OpenTelemetry Collector Service</h1><h2 id=prometheus-internal-receiver>Prometheus Internal Receiver</h2><p>Earlier in the workshop, we also renamed the <code>prometheus</code> receiver to reflect that is was collecting metrics internal to the collector, renaming it to <code>prometheus/internal</code>.</p><p>We now need to enable the <code>prometheus/internal</code> receiver under the metrics pipeline. Update the <code>receivers</code> section to include <code>prometheus/internal</code> under the <code>metrics</code> pipeline:</p><div class="highlight wrap-code" hl_lines=11><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlp, opencensus, jaeger, zipkin]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>hostmetrics, otlp, opencensus, prometheus/internal]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug]</span></span></span></code></pre></div><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=opentelemetry-collector-service>OpenTelemetry Collector Service</h1><h2 id=resource-detection-processor>Resource Detection Processor</h2><p>We also added <code>resourcedetection/system</code> and <code>resourcedetection/ec2</code> processors so that the collector can capture the instance hostname and AWS/EC2 metadata. We now need to enable these two processors under the metrics pipeline.</p><p>Update the <code>processors</code> section to include <code>resourcedetection/system</code> and <code>resourcedetection/ec2</code> under the <code>metrics</code> pipeline:</p><div class="highlight wrap-code" hl_lines=12><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlp, opencensus, jaeger, zipkin]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>hostmetrics, otlp, opencensus, prometheus/internal]</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch, resourcedetection/system, resourcedetection/ec2]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug]</span></span></span></code></pre></div><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=opentelemetry-collector-service>OpenTelemetry Collector Service</h1><h2 id=attributes-processor>Attributes Processor</h2><p>Also in the Processors section of this workshop, we added the <code>attributes/conf</code> processor so that the collector will insert a new attribute called <code>participant.name</code> to all the metrics. We now need to enable this under the metrics pipeline.</p><p>Update the <code>processors</code> section to include <code>attributes/conf</code> under the <code>metrics</code> pipeline:</p><div class="highlight wrap-code" hl_lines=12><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlp, opencensus, jaeger, zipkin]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>hostmetrics, otlp, opencensus, prometheus/internal]</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch, resourcedetection/system, resourcedetection/ec2, attributes/conf]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug]</span></span></span></code></pre></div><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=opentelemetry-collector-service>OpenTelemetry Collector Service</h1><h2 id=otlp-http-exporter>OTLP HTTP Exporter</h2><p>In the Exporters section of the workshop, we configured the <code>otlphttp</code> exporter to send metrics to Splunk Observability Cloud. We now need to enable this under the metrics pipeline.</p><p>Update the <code>exporters</code> section to include <code>otlphttp/splunk</code> under the <code>metrics</code> pipeline:</p><div class="highlight wrap-code" hl_lines=13><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlp, opencensus, jaeger, zipkin]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>hostmetrics, otlp, opencensus, prometheus/internal]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch, resourcedetection/system, resourcedetection/ec2, attributes/conf]</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug, otlphttp/splunk]</span></span></span></code></pre></div><hr><details class="box cstyle notices transparent expand"><summary class=box-label><i class="expander-icon fa-fw fas fa-chevron-right"></i>
<span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-user-ninja"></i></span><span class=badge-content><strong>Ninja:</strong> Observing the collector internals</span></span></summary><div class=box-content><p>The collector captures internal signals about its behavior this also includes additional signals from running components.
The reason for this is that components that make decisions about the flow of data need a way to surface that information
as metrics or traces.</p><h2 id=why-monitor-the-collector>Why monitor the collector?</h2><p>This is somewhat of a chicken and egg problem of, &ldquo;Who is watching the watcher?&rdquo;, but it is important that we can surface this information. Another interesting part of the collector&rsquo;s history is that it existed before the Go metrics&rsquo; SDK was considered stable so the collector exposes a Prometheus endpoint to provide this functionality for the time being.</p><h2 id=considerations>Considerations</h2><p>Monitoring the internal usage of each running collector in your organization can contribute a significant amount of new Metric Time Series (MTS). The Splunk distribution has curated these metrics for you and would be able to help forecast the expected increases.</p><h2 id=the-ninja-zone>The Ninja Zone</h2><p>To expose the internal observability of the collector, some additional settings can be adjusted:</p><div class=tab-panel data-tab-group=551a2c55e102ed4aed00067b9fa6fd39><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=telemetry-schema class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("551a2c55e102ed4aed00067b9fa6fd39","telemetry-schema")'>
<span class=tab-nav-text>telemetry schema</span>
</button>
<button data-tab-item=example-configyml class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("551a2c55e102ed4aed00067b9fa6fd39","example-configyml")'>
<span class=tab-nav-text>example-config.yml</span></button></div><div class=tab-content-container><div data-tab-item=telemetry-schema class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>telemetry</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=l>&lt;info|warn|error&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>development</span><span class=p>:</span><span class=w> </span><span class=l>&lt;true|false&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>encoding</span><span class=p>:</span><span class=w> </span><span class=l>&lt;console|json&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>disable_caller</span><span class=p>:</span><span class=w> </span><span class=l>&lt;true|false&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>disable_stacktrace</span><span class=p>:</span><span class=w> </span><span class=l>&lt;true|false&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>output_paths</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>&lt;stdout|stderr&gt;, paths...]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>error_output_paths</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>&lt;stdout|stderr&gt;, paths...]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>initial_fields</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=l>&lt;none|basic|normal|detailed&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Address binds the promethues endpoint to scrape</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>address</span><span class=p>:</span><span class=w> </span><span class=l>&lt;hostname:port&gt;</span></span></span></code></pre></div></div></div><div data-tab-item=example-configyml class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>telemetry</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>logs</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=l>info</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>encoding</span><span class=p>:</span><span class=w> </span><span class=l>json</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>disable_stacktrace</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>initial_fields</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>instance.name</span><span class=p>:</span><span class=w> </span><span class=l>${env:INSTANCE}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>address</span><span class=p>:</span><span class=w> </span><span class=l>localhost:8888 </span></span></span></code></pre></div></div></div></div></div><h2 id=references>References</h2><ol><li><a href=https://opentelemetry.io/docs/collector/configuration/#service rel=external target=_blank>https://opentelemetry.io/docs/collector/configuration/#service</a></li></ol></div></details><hr><h2 id=final-configuration>Final configuration</h2><hr><details class="box cstyle notices transparent expand"><summary class=box-label><i class="expander-icon fa-fw fas fa-chevron-right"></i>
<span class="badge cstyle default badge-with-title"><span class=badge-title><i class="fa-fw fas fa-check"></i> <strong>Check-in</strong></span><span class=badge-content style=background-color:green>Review your final configuration</span></span></summary><div class=box-content><div class=tab-panel data-tab-group=b0ecac5d91c990dea985ea7dd8a2b68f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configyaml class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b0ecac5d91c990dea985ea7dd8a2b68f","configyaml")'>
<span class=tab-nav-text>config.yaml</span></button></div><div class=tab-content-container><div data-tab-item=configyaml class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" linenos=table><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># To limit exposure to denial of service attacks, change the host in endpoints below from 0.0.0.0 to a specific network interface.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># See https://github.com/open-telemetry/opentelemetry-collector/blob/main/docs/security-best-practices.md#safeguards-against-denial-of-service-attacks</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>health_check</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>13133</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pprof</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>1777</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>zpages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>55679</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hostmetrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>collection_interval</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>scrapers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># CPU utilization metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cpu</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Disk I/O metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>disk</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># File System utilization metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>filesystem</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Memory utilization metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Network interface I/O metrics &amp; TCP connection metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>network</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># CPU load metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>load</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Paging/Swap space utilization and I/O metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>paging</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Process count metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Per process CPU, Memory and Disk I/O metrics. Disabled by default.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># process:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>otlp</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocols</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>grpc</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>4317</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>4318</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>opencensus</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>55678</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Collect own metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prometheus/internal</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>scrape_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;otel-collector&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>targets</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;0.0.0.0:8888&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jaeger</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocols</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>grpc</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>14250</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>thrift_binary</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>6832</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>thrift_compact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>6831</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>thrift_http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>14268</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>zipkin</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>9411</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>batch</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourcedetection/system</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>detectors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>system]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>system</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hostname_sources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>os]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourcedetection/ec2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>detectors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>ec2]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>attributes/conf</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>actions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>participant.name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>insert</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;INSERT_YOUR_NAME_HERE&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbosity</span><span class=p>:</span><span class=w> </span><span class=l>normal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>otlphttp/splunk</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics_endpoint</span><span class=p>:</span><span class=w> </span><span class=l>https://ingest.${env:REALM}.signalfx.com/v2/datapoint/otlp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>headers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>X-SF-Token</span><span class=p>:</span><span class=w> </span><span class=l>${env:ACCESS_TOKEN}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlp, opencensus, jaeger, zipkin]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>hostmetrics, otlp, opencensus, prometheus/internal]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch, resourcedetection/system, resourcedetection/ec2, attributes/conf]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug, otlphttp/splunk]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlp]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>batch]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>debug]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>health_check, pprof, zpages]</span></span></span></code></pre></td></tr></table></div></div></div></div></div></div></div></details><hr><details open class="box cstyle notices tip"><summary class=box-label><i class="fa-fw fas fa-lightbulb"></i>
Tip</summary><div class=box-content><p>It is recommended that you validate your configuration file before restarting the collector. You can do this by pasting the contents of your <code>config.yaml</code> file into <strong><a href=https://www.otelbin.io/ rel=external target=_blank>otelbin.io</a></strong>.</p><details class="box cstyle notices transparent expand"><summary class=box-label><i class="expander-icon fa-fw fas fa-chevron-right"></i>
<span class="badge cstyle default badge-with-title"><span class=badge-title><strong>Screenshot</strong></span><span class=badge-content style=background-color:green>OTelBin</span></span></summary><div class=box-content><p><a href=#R-image-b996421eecacb09a036d9b2a379457ad class=lightbox-link><img alt=otelbin-validator class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/otelbin.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b996421eecacb09a036d9b2a379457ad><img alt=otelbin-validator class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/otelbin.png></a></p></div></details></div></details><p>Now that we have a working configuration, let&rsquo;s start the collector and then check to see what <a href=/observability-workshop/v5.90/en/ninja-workshops/3-opentelemetry-collector-workshops/1-opentelemetry-collector/2-extensions/index.html#zpages>zPages</a> is reporting.</p><div class=tab-panel data-tab-group=506247f7dc031ec6c226bd721b0fc347><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=command class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("506247f7dc031ec6c226bd721b0fc347","command")'>
<span class=tab-nav-text>Command</span></button></div><div class=tab-content-container><div data-tab-item=command class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>otelcol-contrib --config<span class=o>=</span>file:/etc/otelcol-contrib/config.yaml</span></span></code></pre></div></div></div></div></div><p>Open up zPages in your browser: <a href=http://localhost:55679/debug/pipelinez rel=external target=_blank><strong>http://localhost:55679/debug/pipelinez</strong></a> (change <code>localhost</code> to reflect your own environment).
<a href=#R-image-9a17d67090fe8d8ce8be92924685ecca class=lightbox-link><img alt=pipelinez-full-config class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/pipelinez-full-config.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-9a17d67090fe8d8ce8be92924685ecca><img alt=pipelinez-full-config class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/pipelinez-full-config.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=data-visualisations>Data Visualisations</h1><h2 id=splunk-observability-cloud>Splunk Observability Cloud</h2><p>Now that we have configured the OpenTelemetry Collector to send metrics to Splunk Observability Cloud, let&rsquo;s take a look at the data in Splunk Observability Cloud. If you have not received an invite to Splunk Observability Cloud, your instructor will provide you with login credentials.</p><p>Before that, let&rsquo;s make things a little more interesting and run a stress test on the instance. This in turn will light up the dashboards.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt install stress
</span></span><span class=line><span class=cl><span class=k>while</span> true<span class=p>;</span> <span class=k>do</span> stress -c <span class=m>2</span> -t 40<span class=p>;</span> stress -d <span class=m>5</span> -t 40<span class=p>;</span> stress -m <span class=m>20</span> -t 40<span class=p>;</span> <span class=k>done</span></span></span></code></pre></div><p>Once you are logged into Splunk Observability Cloud, using the left-hand navigation, navigate to <strong>Dashboards</strong> from the main menu. This will take you to the Teams view. At the top of this view click on <strong>All Dashboards</strong> :</p><p><a href=#R-image-5f7ba38fd281466b757d3d41e9296384 class=lightbox-link><img alt=menu-dashboards class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/menu-dashboards.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5f7ba38fd281466b757d3d41e9296384><img alt=menu-dashboards class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/menu-dashboards.png></a></p><p>In the search box, search for <strong>OTel Contrib</strong>:</p><p><a href=#R-image-cb60ecbcf2bb7f3f6dc87f563d7ee81b class=lightbox-link><img alt=search-dashboards class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/search-dashboards.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-cb60ecbcf2bb7f3f6dc87f563d7ee81b><img alt=search-dashboards class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/search-dashboards.png></a></p><details open class="box cstyle notices info"><summary class=box-label><i class="fa-fw fas fa-info-circle"></i>
Info</summary><div class=box-content><p>If the dashboard does not exist, then your instructor will be able to quickly add it. If you are not attending a Splunk hosted version of this workshop then the Dashboard Group to import can be found at the bottom of this page.</p></div></details><p>Click on the <strong>OTel Contrib Dashboard</strong> dashboard to open it, next click in the <strong>Participant Name</strong> box, at the top of the dashboard, and select the name you configured for <code>participant.name</code> in the <code>config.yaml</code> in the drop-down list or start typing the name to search for it:</p><p><a href=#R-image-1aac35bb4ee8d73bf69b08ad16dae1ae class=lightbox-link><img alt=select-conf-attendee-name class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/select-participant-name.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-1aac35bb4ee8d73bf69b08ad16dae1ae><img alt=select-conf-attendee-name class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/select-participant-name.png></a></p><p>You can now see the host metrics for the host upon which you configured the OpenTelemetry Collector.</p><p><a href=#R-image-9adab1f683ef55f09c3b219a1f2b561c class=lightbox-link><img alt=participant-dashboard class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/participant-dashboard.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-9adab1f683ef55f09c3b219a1f2b561c><img alt=participant-dashboard class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/participant-dashboard.png></a></p><details open class="box cstyle attachments info"><summary class=box-label><i class="fa-fw fas fa-info-circle"></i>
Download Dashboard Group JSON for importing</summary><ul class="attachments-files box-content"><li><a href=/observability-workshop/v5.90/en/ninja-workshops/3-opentelemetry-collector-workshops/1-opentelemetry-collector/7-visualisation/OpenTelemetry-Contrib-Dashboard-Group.json>OpenTelemetry-Contrib-Dashboard-Group.json</a> (40 KB)</li></ul></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=opentelemetry-collector-development>OpenTelemetry Collector Development</h1><h2 id=developing-a-custom-component>Developing a custom component</h2><p>Building a component for the Open Telemetry Collector requires three key parts:</p><ol><li>The Configuration - <em>What values are exposed to the user to configure</em></li><li>The Factory - <em>Make the component using the provided values</em></li><li>The Business Logic - <em>What the component needs to do</em></li></ol><p>For this, we will use the example of building a component that works with Jenkins so that we can track important DevOps metrics of our project(s).</p><p>The metrics we are looking to measure are:</p><ol><li>Lead time for changes - <em>&ldquo;How long it takes for a commit to get into production&rdquo;</em></li><li>Change failure rate - <em>&ldquo;The percentage of deployments causing a failure in production&rdquo;</em></li><li>Deployment frequency - <em>&ldquo;How often a [team] successfully releases to production&rdquo;</em></li><li>Mean time to recover - <em>&ldquo;How long does it take for a [team] to recover from a failure in production&rdquo;</em></li></ol><p>These indicators were identified Google&rsquo;s DevOps Research and Assesment (DORA)[^1] team to help
show performance of a software development team. The reason for choosing <em>Jenkins CI</em> is that we remain in the same Open Source Software ecosystem which we can serve as the example for the vendor managed CI tools to adopt in future.</p><h2 id=instrument-vs-component>Instrument Vs Component</h2><p>There is something to consider when improving level of Observability within your organisation
since there are some trade offs that get made.</p><table><thead><tr><th></th><th>Pros</th><th>Cons</th></tr></thead><tbody><tr><td><strong>(Auto) Instrumented</strong></td><td>Does not require an external API to be monitored in order to observe the system.</td><td>Changing instrumentation requires changes to the project.</td></tr><tr><td></td><td>Gives system owners/developers to make changes in their observability.</td><td>Requires additional runtime dependancies.</td></tr><tr><td></td><td>Understands system context and can corrolate captured data with <em>Exemplars</em>.</td><td>Can impact performance of the system.</td></tr><tr><td><strong>Component</strong></td><td>- Changes to data names or semantics can be rolled out independently of the system&rsquo;s release cycle.</td><td>Breaking API changes require a coordinated release between system and collector.</td></tr><tr><td></td><td>Updating/extending data collected is a seemless user facing change.</td><td>Captured data semantics can unexpectedly break that does not align with a new system release.</td></tr><tr><td></td><td>Does not require the supporting teams to have a deep understanding of observability practice.</td><td>Strictly external / exposed information can be surfaced from the system.</td></tr></tbody></table><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 8. Develop</h1><article class=default><header class=headline></header><h1 id=opentelemetry-collector-development>OpenTelemetry Collector Development</h1><h2 id=project-setup-hahahugoshortcode91s0hbhb>Project Setup <span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-user-ninja"></i></span><span class=badge-content><strong>Ninja</strong></span></span></h2><details open class="box cstyle notices note"><summary class=box-label><i class="fa-fw fas fa-exclamation-circle"></i>
Note</summary><div class=box-content><p>The time to finish this section of the workshop can vary depending on experience.</p><p>A complete solution can be found <a href=https://github.com/splunk/collector-workshop-example rel=external target=_blank><strong>here</strong></a> in case you&rsquo;re stuck or want to follow
along with the instructor.</p></div></details><p>To get started developing the new <em>Jenkins CI</em> receiver, we first need to set up a Golang project.
The steps to create your new Golang project is:</p><ol><li>Create a new directory named <code>${HOME}/go/src/jenkinscireceiver</code> and change into it<ol><li>The actual directory name or location is not strict, you can choose your own development directory to make it in.</li></ol></li><li>Initialize the golang module by going <code>go mod init splunk.conf/workshop/example/jenkinscireceiver</code><ol><li>This will create a file named <code>go.mod</code> which is used to track our direct and indirect dependencies</li><li>Eventually, there will be a <code>go.sum</code> which is the checksum value of the dependencies being imported.</li></ol></li></ol><details class="box cstyle notices transparent expand"><summary class=box-label><i class="expander-icon fa-fw fas fa-chevron-right"></i>
<span class="badge cstyle default badge-with-title"><span class=badge-title><i class="fa-fw fas fa-check"></i> <strong>Check-in</strong></span><span class=badge-content style=background-color:green>Review your go.mod</span></span></summary><div class=box-content><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>module splunk.conf/workshop/example/jenkinscireceiver
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>go 1.20</span></span></code></pre></div></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=opentelemetry-collector-development>OpenTelemetry Collector Development</h1><h2 id=building-the-configuration>Building The Configuration</h2><p>The configuration portion of the component is how the user is able to have their inputs over the component,
so the values that is used for the configuration need to be:</p><ol><li>Intuitive for users to understand what that field controls</li><li>Be explicit in what is required and what is optional</li><li>Reuse common names and fields</li><li>Keep the options simple</li></ol><div class=tab-panel data-tab-group=4a261fb22b180f0f6265f0640b921acb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=bad-config class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4a261fb22b180f0f6265f0640b921acb","bad-config")'>
<span class=tab-nav-text>bad config</span>
</button>
<button data-tab-item=good-config class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("4a261fb22b180f0f6265f0640b921acb","good-config")'>
<span class=tab-nav-text>good config</span></button></div><div class=tab-content-container><div data-tab-item=bad-config class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>jenkins_server_addr</span><span class=p>:</span><span class=w> </span><span class=l>hostname</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>jenkins_server_api_port</span><span class=p>:</span><span class=w> </span><span class=m>8089</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=l>10m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>filter_builds_by</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-awesome-build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=l>amber</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>track</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>example.metric.1</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>example.metric.2</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>example.metric.3</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>example.metric.4</span><span class=p>:</span><span class=w> </span><span class=kc>no</span></span></span></code></pre></div></div></div><div data-tab-item=good-config class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Required Values</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=l>http://my-jenkins-server:8089</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>auth</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>authenticator</span><span class=p>:</span><span class=w> </span><span class=l>basicauth/jenkins</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Optional Values</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>collection_interval</span><span class=p>:</span><span class=w> </span><span class=l>10m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>example.metric.1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>example.metric.2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>example.metric.3</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>example.metric.4</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span></span></span></code></pre></div></div></div></div></div><p>The bad configuration highlights how doing the opposite of the recommendations of configuration practices impacts the usability
of the component. It doesn&rsquo;t make it clear what field values should be, it includes features that can be pushed to existing processors,
and the field naming is not consistent with other components that exist in the collector.</p><p>The good configuration keeps the required values simple, reuses field names from other components, and ensures the component focuses on
just the interaction between Jenkins and the collector.</p><p>The code tab shows how much is required to be added by us and what is already provided for us by shared libraries within the collector.
These will be explained in more detail once we get to the business logic. The configuration should start off small and will change
once the business logic has started to include additional features that is needed.</p><h2 id=write-the-code>Write the code</h2><p>In order to implement the code needed for the configuration, we are going to create a new file named <code>config.go</code> with the following content:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>jenkinscireceiver</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;go.opentelemetry.io/collector/config/confighttp&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;go.opentelemetry.io/collector/receiver/scraperhelper&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;splunk.conf/workshop/example/jenkinscireceiver/internal/metadata&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Config</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// HTTPClientSettings contains all the values</span>
</span></span><span class=line><span class=cl>    <span class=c1>// that are commonly shared across all HTTP interactions</span>
</span></span><span class=line><span class=cl>    <span class=c1>// performed by the collector.</span>
</span></span><span class=line><span class=cl>    <span class=nx>confighttp</span><span class=p>.</span><span class=nx>HTTPClientSettings</span> <span class=s>`mapstructure:&#34;,squash&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ScraperControllerSettings will allow us to schedule </span>
</span></span><span class=line><span class=cl>    <span class=c1>// how often to check for updates to builds.</span>
</span></span><span class=line><span class=cl>    <span class=nx>scraperhelper</span><span class=p>.</span><span class=nx>ScraperControllerSettings</span> <span class=s>`mapstructure:&#34;,squash&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=c1>// MetricsBuilderConfig contains all the metrics</span>
</span></span><span class=line><span class=cl>    <span class=c1>// that can be configured.</span>
</span></span><span class=line><span class=cl>    <span class=nx>metadata</span><span class=p>.</span><span class=nx>MetricsBuilderConfig</span> <span class=s>`mapstructure:&#34;,squash&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=opentelemetry-collector-development>OpenTelemetry Collector Development</h1><h2 id=component-review>Component Review</h2><p>To recap the type of component we will need to capture metrics from Jenkins:</p><div class=tab-panel data-tab-group=fb389b91bad42a60bdfc6156f5a473be><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=extension class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fb389b91bad42a60bdfc6156f5a473be","extension")'>
<span class=tab-nav-text>Extension</span>
</button>
<button data-tab-item=receiver class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("fb389b91bad42a60bdfc6156f5a473be","receiver")'>
<span class=tab-nav-text>Receiver</span>
</button>
<button data-tab-item=processor class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("fb389b91bad42a60bdfc6156f5a473be","processor")'>
<span class=tab-nav-text>Processor</span>
</button>
<button data-tab-item=exporter class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("fb389b91bad42a60bdfc6156f5a473be","exporter")'>
<span class=tab-nav-text>Exporter</span>
</button>
<button data-tab-item=ninja-connectors class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("fb389b91bad42a60bdfc6156f5a473be","ninja-connectors")'>
<span class=tab-nav-text><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-user-ninja"></i></span><span class=badge-content><strong>Ninja:</strong> Connectors</span></span></span></button></div><div class=tab-content-container><div data-tab-item=extension class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><p>The business use case an extension helps solves for are:</p><ol><li>Having shared functionality that requires runtime configuration</li><li>Indirectly helps with observing the runtime of the collector</li></ol><p>See <a href=/observability-workshop/v5.90/en/ninja-workshops/3-opentelemetry-collector-workshops/1-opentelemetry-collector/2-extensions/index.html><strong>Extensions Overview</strong></a> for more details.</p></div></div><div data-tab-item=receiver class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><p>The business use case a receiver solves for:</p><ul><li>Fetching data from a remote source</li><li>Receiving data from remote source(s)</li></ul><p>This is commonly referred to <em>pull</em> vs <em>push</em> based data collection, and you read more about the details in the <a href=/observability-workshop/v5.90/en/ninja-workshops/3-opentelemetry-collector-workshops/1-opentelemetry-collector/3-receivers/index.html>Receiver Overview</a>.</p></div></div><div data-tab-item=processor class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><p>The business use case a processor solves for is:</p><ul><li>Adding or removing data, fields, or values</li><li>Observing and making decisions on the data</li><li>Buffering, queueing, and reordering</li></ul><p>The thing to keep in mind is the data type flowing through a processor needs to forward
the same data type to its downstream components. Read through <a href=/observability-workshop/v5.90/en/ninja-workshops/3-opentelemetry-collector-workshops/1-opentelemetry-collector/4-processors/index.html>Processor Overview</a> for the details.</p></div></div><div data-tab-item=exporter class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><p>The business use case an exporter solves for:</p><ul><li>Send the data to a tool, service, or storage</li></ul><p>The OpenTelemetry collector does not want to be &ldquo;backend&rdquo;, an all-in-one observability suite, but rather
keep to the principles that founded OpenTelemetry to begin with; A vendor agnostic Observability for all.
To help revisit the details, please read through <a href=/observability-workshop/v5.90/en/ninja-workshops/3-opentelemetry-collector-workshops/1-opentelemetry-collector/5-exporters/index.html><strong>Exporter Overview</strong></a>.</p></div></div><div data-tab-item=ninja-connectors class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><p>This is a component type that was missed in the workshop since it is a relatively new addition to the collector, but the best way to think about a connector is that it is like a processor that allows it to be used across different telemetry types and pipelines. Meaning that a connector can accept data as logs, and output metrics, or accept metrics from one pipeline and provide metrics on the data it has observed.</p><p>The business case that a connector solves for:</p><ul><li>Converting from different telemetry types<ul><li>logs to metrics</li><li>traces to metrics</li><li>metrics to logs</li></ul></li><li>Observing incoming data and producing its own data<ul><li>Accepting metrics and generating analytical metrics of the data.</li></ul></li></ul><p>There was a brief overview within the <strong>Ninja</strong> section as part of the <a href=/observability-workshop/v5.90/en/ninja-workshops/3-opentelemetry-collector-workshops/1-opentelemetry-collector/4-processors/index.html>Processor Overview</a>,
and be sure what the project for updates for new connector components.</p></div></div></div></div><p>From the component overviews, it is clear that developing a pull-based receiver for Jenkins.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=opentelemetry-collector-development>OpenTelemetry Collector Development</h1><h3 id=designing-the-metrics>Designing The Metrics</h3><p>To help define and export the metrics captured by our receiver, we will be using, <a href=https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/cmd/mdatagen rel=external target=_blank><strong>mdatagen</strong></a>, a tool developed for the collector that turns YAML defined metrics into code.</p><div class=tab-panel data-tab-group=fad5b21ac366ec9cb30c9954bb8cc1c2><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=metadatayaml class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fad5b21ac366ec9cb30c9954bb8cc1c2","metadatayaml")'>
<span class=tab-nav-text>metadata.yaml</span>
</button>
<button data-tab-item=gengo class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("fad5b21ac366ec9cb30c9954bb8cc1c2","gengo")'>
<span class=tab-nav-text>gen.go</span></button></div><div class=tab-content-container><div data-tab-item=metadatayaml class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Type defines the name to reference the component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># in the configuration file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>jenkins</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Status defines the component type and the stability level</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>class</span><span class=p>:</span><span class=w> </span><span class=l>receiver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stability</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>development</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>metrics]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Attributes are the expected fields reported</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># with the exported values.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>attributes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>job.name</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=l>The name of the associated Jenkins job</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>job.status</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=l>Shows if the job had passed, or failed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>enum</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>failed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>success</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>unknown</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Metrics defines all the pontentially exported values from this receiver. </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jenkins.jobs.count</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=l>Provides a count of the total number of configured jobs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>unit</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{Count}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>gauge</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value_type</span><span class=p>:</span><span class=w> </span><span class=l>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jenkins.job.duration</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=l>Show the duration of the job</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>unit</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;s&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>gauge</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value_type</span><span class=p>:</span><span class=w> </span><span class=l>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>attributes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>job.name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>job.status</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jenkins.job.commit_delta</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=l>The calculation difference of the time job was finished minus commit timestamp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>unit</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;s&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>gauge</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value_type</span><span class=p>:</span><span class=w> </span><span class=l>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>attributes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>job.name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>job.status</span></span></span></code></pre></div></div></div><div data-tab-item=gengo class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// To generate the additional code needed to capture metrics, </span>
</span></span><span class=line><span class=cl><span class=c1>// the following command to be run from the shell:</span>
</span></span><span class=line><span class=cl><span class=c1>//  go generate -x ./...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//go:generate go run github.com/open-telemetry/opentelemetry-collector-contrib/cmd/mdatagen@v0.80.0 metadata.yaml</span>
</span></span><span class=line><span class=cl><span class=kn>package</span> <span class=nx>jenkinscireceiver</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// There is no code defined within this file.</span></span></span></code></pre></div></div></div></div></div><p>Create these files within the project folder before continuing onto the next section.</p><h2 id=building-the-factory>Building The Factory</h2><p>The Factory is a software design pattern that effectively allows for an object, in this case a <code>jenkinscireceiver</code>, to be created dynamically with the provided configuration. To use a more real-world example, it would be going to a phone store, asking for a phone
that matches your exact description, and then providing it to you.</p><p>Run the following command <code>go generate -x ./...</code> , it will create a new folder, <code>jenkinscireceiver/internal/metadata</code>, that contains all code required to export the defined metrics. The required code is:</p><div class=tab-panel data-tab-group=c4c3605aed9c5ba55bd7e9df823dfd71><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=factorygo class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c4c3605aed9c5ba55bd7e9df823dfd71","factorygo")'>
<span class=tab-nav-text>factory.go</span>
</button>
<button data-tab-item=configgo class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("c4c3605aed9c5ba55bd7e9df823dfd71","configgo")'>
<span class=tab-nav-text>config.go</span>
</button>
<button data-tab-item=scrapergo class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("c4c3605aed9c5ba55bd7e9df823dfd71","scrapergo")'>
<span class=tab-nav-text>scraper.go</span>
</button>
<button data-tab-item=build-configyaml class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("c4c3605aed9c5ba55bd7e9df823dfd71","build-configyaml")'>
<span class=tab-nav-text>build-config.yaml</span>
</button>
<button data-tab-item=project-layout class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("c4c3605aed9c5ba55bd7e9df823dfd71","project-layout")'>
<span class=tab-nav-text>project layout</span></button></div><div class=tab-content-container><div data-tab-item=factorygo class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>jenkinscireceiver</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;errors&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;go.opentelemetry.io/collector/component&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;go.opentelemetry.io/collector/config/confighttp&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;go.opentelemetry.io/collector/receiver&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;go.opentelemetry.io/collector/receiver/scraperhelper&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;splunk.conf/workshop/example/jenkinscireceiver/internal/metadata&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewFactory</span><span class=p>()</span> <span class=nx>receiver</span><span class=p>.</span><span class=nx>Factory</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>receiver</span><span class=p>.</span><span class=nf>NewFactory</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>metadata</span><span class=p>.</span><span class=nx>Type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>newDefaultConfig</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>receiver</span><span class=p>.</span><span class=nf>WithMetrics</span><span class=p>(</span><span class=nx>newMetricsReceiver</span><span class=p>,</span> <span class=nx>metadata</span><span class=p>.</span><span class=nx>MetricsStability</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>newMetricsReceiver</span><span class=p>(</span><span class=nx>_</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>set</span> <span class=nx>receiver</span><span class=p>.</span><span class=nx>CreateSettings</span><span class=p>,</span> <span class=nx>cfg</span> <span class=nx>component</span><span class=p>.</span><span class=nx>Config</span><span class=p>,</span> <span class=nx>consumer</span> <span class=nx>consumer</span><span class=p>.</span><span class=nx>Metrics</span><span class=p>)</span> <span class=p>(</span><span class=nx>receiver</span><span class=p>.</span><span class=nx>Metrics</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Convert the configuration into the expected type</span>
</span></span><span class=line><span class=cl>    <span class=nx>conf</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>cfg</span><span class=p>.(</span><span class=o>*</span><span class=nx>Config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;can not convert config&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>sc</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>newScraper</span><span class=p>(</span><span class=nx>conf</span><span class=p>,</span> <span class=nx>set</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>scraperhelper</span><span class=p>.</span><span class=nf>NewScraperControllerReceiver</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=o>&amp;</span><span class=nx>conf</span><span class=p>.</span><span class=nx>ScraperControllerSettings</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>set</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>consumer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>scraperhelper</span><span class=p>.</span><span class=nf>AddScraper</span><span class=p>(</span><span class=nx>sc</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div><div data-tab-item=configgo class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>jenkinscireceiver</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;go.opentelemetry.io/collector/config/confighttp&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;go.opentelemetry.io/collector/receiver/scraperhelper&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;splunk.conf/workshop/example/jenkinscireceiver/internal/metadata&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Config</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// HTTPClientSettings contains all the values</span>
</span></span><span class=line><span class=cl>    <span class=c1>// that are commonly shared across all HTTP interactions</span>
</span></span><span class=line><span class=cl>    <span class=c1>// performed by the collector.</span>
</span></span><span class=line><span class=cl>    <span class=nx>confighttp</span><span class=p>.</span><span class=nx>HTTPClientSettings</span> <span class=s>`mapstructure:&#34;,squash&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ScraperControllerSettings will allow us to schedule </span>
</span></span><span class=line><span class=cl>    <span class=c1>// how often to check for updates to builds.</span>
</span></span><span class=line><span class=cl>    <span class=nx>scraperhelper</span><span class=p>.</span><span class=nx>ScraperControllerSettings</span> <span class=s>`mapstructure:&#34;,squash&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=c1>// MetricsBuilderConfig contains all the metrics</span>
</span></span><span class=line><span class=cl>    <span class=c1>// that can be configured.</span>
</span></span><span class=line><span class=cl>    <span class=nx>metadata</span><span class=p>.</span><span class=nx>MetricsBuilderConfig</span> <span class=s>`mapstructure:&#34;,squash&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>newDefaultConfig</span><span class=p>()</span> <span class=nx>component</span><span class=p>.</span><span class=nx>Config</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>Config</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>ScraperControllerSettings</span><span class=p>:</span> <span class=nx>scraperhelper</span><span class=p>.</span><span class=nf>NewDefaultScraperControllerSettings</span><span class=p>(</span><span class=nx>metadata</span><span class=p>.</span><span class=nx>Type</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=nx>HTTPClientSettings</span><span class=p>:</span>        <span class=nx>confighttp</span><span class=p>.</span><span class=nf>NewDefaultHTTPClientSettings</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nx>MetricsBuilderConfig</span><span class=p>:</span>      <span class=nx>metadata</span><span class=p>.</span><span class=nf>DefaultMetricsBuilderConfig</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div><div data-tab-item=scrapergo class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>jenkinscireceiver</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>scraper</span> <span class=kd>struct</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>newScraper</span><span class=p>(</span><span class=nx>cfg</span> <span class=o>*</span><span class=nx>Config</span><span class=p>,</span> <span class=nx>set</span> <span class=nx>receiver</span><span class=p>.</span><span class=nx>CreateSettings</span><span class=p>)</span> <span class=p>(</span><span class=nx>scraperhelper</span><span class=p>.</span><span class=nx>Scraper</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Create a our scraper with our values </span>
</span></span><span class=line><span class=cl>    <span class=nx>s</span> <span class=o>:=</span> <span class=nx>scraper</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// To be filled in later</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>scraperhelper</span><span class=p>.</span><span class=nf>NewScraper</span><span class=p>(</span><span class=nx>metadata</span><span class=p>.</span><span class=nx>Type</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>scrape</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>scraper</span><span class=p>)</span> <span class=nf>scrape</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>(</span><span class=nx>pmetric</span><span class=p>.</span><span class=nx>Metrics</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// To be filled in</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>pmetrics</span><span class=p>.</span><span class=nf>NewMetrics</span><span class=p>(),</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div><div data-tab-item=build-configyaml class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>dist</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>otelcol</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Conf workshop collector&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>output_path</span><span class=p>:</span><span class=w> </span><span class=l>./dist</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v0.0.0-experimental</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>gomod</span><span class=p>:</span><span class=w> </span><span class=l>github.com/open-telemetry/opentelemetry-collector-contrib/extension/basicauthextension v0.80.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>gomod</span><span class=p>:</span><span class=w> </span><span class=l>github.com/open-telemetry/opentelemetry-collector-contrib/extension/healthcheckextension v0.80.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>gomod</span><span class=p>:</span><span class=w> </span><span class=l>go.opentelemetry.io/collector/receiver/otlpreceiver v0.80.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>gomod</span><span class=p>:</span><span class=w> </span><span class=l>github.com/open-telemetry/opentelemetry-collector-contrib/receiver/jaegerreceiver v0.80.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>gomod</span><span class=p>:</span><span class=w> </span><span class=l>github.com/open-telemetry/opentelemetry-collector-contrib/receiver/prometheusreceiver v0.80.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>gomod</span><span class=p>:</span><span class=w> </span><span class=l>splunk.conf/workshop/example/jenkinscireceiver v0.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>./jenkinscireceiver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>gomod</span><span class=p>:</span><span class=w> </span><span class=l>go.opentelemetry.io/collector/processor/batchprocessor v0.80.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>gomod</span><span class=p>:</span><span class=w> </span><span class=l>go.opentelemetry.io/collector/exporter/loggingexporter v0.80.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>gomod</span><span class=p>:</span><span class=w> </span><span class=l>go.opentelemetry.io/collector/exporter/otlpexporter v0.80.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>gomod</span><span class=p>:</span><span class=w> </span><span class=l>go.opentelemetry.io/collector/exporter/otlphttpexporter v0.80.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># This replace is a go directive that allows for redefine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># where to fetch the code to use since the default would be from a remote project.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>replaces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>splunk.conf/workshop/example/jenkinscireceiver =&gt; ./jenkinscireceiver</span></span></span></code></pre></div></div></div><div data-tab-item=project-layout class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>â”œâ”€â”€ build-config.yaml
</span></span><span class=line><span class=cl>â””â”€â”€ jenkinscireceiver
</span></span><span class=line><span class=cl>    â”œâ”€â”€ go.mod
</span></span><span class=line><span class=cl>    â”œâ”€â”€ config.go
</span></span><span class=line><span class=cl>    â”œâ”€â”€ factory.go
</span></span><span class=line><span class=cl>    â”œâ”€â”€ scraper.go
</span></span><span class=line><span class=cl>    â””â”€â”€ internal
</span></span><span class=line><span class=cl>      â””â”€â”€ metadata</span></span></code></pre></div></div></div></div></div><p>Once you have written these files into the project with the expected contents run, <code>go mod tidy</code>, which will fetch all the remote dependencies and update <code>go.mod</code> and generate the <code>go.sum</code> files.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=opentelemetry-collector-development>OpenTelemetry Collector Development</h1><h2 id=building-the-business-logic>Building The Business Logic</h2><p>At this point, we have a custom component that currently does nothing so we need to add in the required
logic to capture this data from Jenkins.</p><p>From this point, the steps that we need to take are:</p><ol><li>Create a client that connect to Jenkins</li><li>Capture all the configured jobs</li><li>Report the status of the last build for the configured job</li><li>Calculate the time difference between commit timestamp and job completion.</li></ol><p>The changes will be made to <code>scraper.go</code>.</p><div class=tab-panel data-tab-group=0c31616e0d14fb7735ae8b937cd89711><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=add-jenkins-client class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0c31616e0d14fb7735ae8b937cd89711","add-jenkins-client")'>
<span class=tab-nav-text><ol><li>Add Jenkins client</li></ol></span></button>
<button data-tab-item=capture-all-configured-jobs class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("0c31616e0d14fb7735ae8b937cd89711","capture-all-configured-jobs")'>
<span class=tab-nav-text><ol start=2><li>Capture all configured jobs</li></ol></span></button>
<button data-tab-item=report-the-status-of-each-job class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("0c31616e0d14fb7735ae8b937cd89711","report-the-status-of-each-job")'>
<span class=tab-nav-text><ol start=3><li>Report the status of each job</li></ol></span></button>
<button data-tab-item=report-the-delta class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("0c31616e0d14fb7735ae8b937cd89711","report-the-delta")'>
<span class=tab-nav-text><ol start=4><li>Report the delta</li></ol></span></button></div><div class=tab-content-container><div data-tab-item=add-jenkins-client class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><p>To be able to connect to the Jenkins server, we will be using the package,
<a href=https://pkg.go.dev/github.com/yosida95/golang-jenkins rel=external target=_blank>&ldquo;github.com/yosida95/golang-jenkins&rdquo;</a>,
which provides the functionality required to read data from the jenkins server.</p><p>Then we are going to utilise some of the helper functions from the,
<a href=https://pkg.go.dev/go.opentelemetry.io/collector/receiver/scraperhelper rel=external target=_blank>&ldquo;go.opentelemetry.io/collector/receiver/scraperhelper&rdquo;</a> ,
library to create a start function so that we can connect to the Jenkins server once component has finished starting.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>jenkinscireceiver</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>jenkins</span> <span class=s>&#34;github.com/yosida95/golang-jenkins&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;go.opentelemetry.io/collector/component&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;go.opentelemetry.io/collector/pdata/pmetric&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;go.opentelemetry.io/collector/receiver&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;go.opentelemetry.io/collector/receiver/scraperhelper&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;splunk.conf/workshop/example/jenkinscireceiver/internal/metadata&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>scraper</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>mb</span>     <span class=o>*</span><span class=nx>metadata</span><span class=p>.</span><span class=nx>MetricsBuilder</span>
</span></span><span class=line><span class=cl>    <span class=nx>client</span> <span class=o>*</span><span class=nx>jenkins</span><span class=p>.</span><span class=nx>Jenkins</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>newScraper</span><span class=p>(</span><span class=nx>cfg</span> <span class=o>*</span><span class=nx>Config</span><span class=p>,</span> <span class=nx>set</span> <span class=nx>receiver</span><span class=p>.</span><span class=nx>CreateSettings</span><span class=p>)</span> <span class=p>(</span><span class=nx>scraperhelper</span><span class=p>.</span><span class=nx>Scraper</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>s</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>scraper</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>mb</span> <span class=p>:</span> <span class=nx>metadata</span><span class=p>.</span><span class=nf>NewMetricsBuilder</span><span class=p>(</span><span class=nx>cfg</span><span class=p>.</span><span class=nx>MetricsBuilderConfig</span><span class=p>,</span> <span class=nx>set</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>scraperhelper</span><span class=p>.</span><span class=nf>NewScraper</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>metadata</span><span class=p>.</span><span class=nx>Type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>s</span><span class=p>.</span><span class=nx>scrape</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>scraperhelper</span><span class=p>.</span><span class=nf>WithStart</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>h</span> <span class=nx>component</span><span class=p>.</span><span class=nx>Host</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>client</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>cfg</span><span class=p>.</span><span class=nf>ToClient</span><span class=p>(</span><span class=nx>h</span><span class=p>,</span> <span class=nx>set</span><span class=p>.</span><span class=nx>TelemetrySettings</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=c1>// The collector provides a means of injecting authentication</span>
</span></span><span class=line><span class=cl>            <span class=c1>// on our behalf, so this will ignore the libraries approach</span>
</span></span><span class=line><span class=cl>            <span class=c1>// and use the configured http client with authentication.</span>
</span></span><span class=line><span class=cl>            <span class=nx>s</span><span class=p>.</span><span class=nx>client</span> <span class=p>=</span> <span class=nx>jenkins</span><span class=p>.</span><span class=nf>NewJenkins</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=nx>cfg</span><span class=p>.</span><span class=nx>Endpoint</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>s</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nf>SetHTTPClient</span><span class=p>(</span><span class=nx>client</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>        <span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=nx>scraper</span><span class=p>)</span> <span class=nf>scrape</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>(</span><span class=nx>pmetric</span><span class=p>.</span><span class=nx>Metrics</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// To be filled in</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>pmetric</span><span class=p>.</span><span class=nf>NewMetrics</span><span class=p>(),</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>This finishes all the setup code that is required in order to initialise a Jenkins receiver.</p></div></div><div data-tab-item=capture-all-configured-jobs class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><p>From this point on, we will be focuses on the <code>scrape</code> method that has been waiting to be filled in.
This method will be run on each interval that is configured within the configuration (by default, every minute).</p><p>The reason we want to capture the number of jobs configured so we can see the growth of our Jenkins server,
and measure of many projects have onboarded. To do this we will call the jenkins client to list all jobs,
and if it reports an error, return that with no metrics, otherwise, emit the data from the metric builder.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=nx>scraper</span><span class=p>)</span> <span class=nf>scrape</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>(</span><span class=nx>pmetric</span><span class=p>.</span><span class=nx>Metrics</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>jobs</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nf>GetJobs</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>pmetric</span><span class=p>.</span><span class=nx>Metrics</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Recording the timestamp to ensure</span>
</span></span><span class=line><span class=cl>    <span class=c1>// all captured data points within this scrape have the same value. </span>
</span></span><span class=line><span class=cl>    <span class=nx>now</span> <span class=o>:=</span> <span class=nx>pcommon</span><span class=p>.</span><span class=nf>NewTimestampFromTime</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Casting to an int64 to match the expected type</span>
</span></span><span class=line><span class=cl>    <span class=nx>s</span><span class=p>.</span><span class=nx>mb</span><span class=p>.</span><span class=nf>RecordJenkinsJobsCountDataPoint</span><span class=p>(</span><span class=nx>now</span><span class=p>,</span> <span class=nb>int64</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>jobs</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// To be filled in</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>s</span><span class=p>.</span><span class=nx>mb</span><span class=p>.</span><span class=nf>Emit</span><span class=p>(),</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div><div data-tab-item=report-the-status-of-each-job class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><p>In the last step, we were able to capture all jobs ands report the number of jobs
there was. Within this step, we are going to examine each job and use the report values
to capture metrics.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=nx>scraper</span><span class=p>)</span> <span class=nf>scrape</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>(</span><span class=nx>pmetric</span><span class=p>.</span><span class=nx>Metrics</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>jobs</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nf>GetJobs</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>pmetric</span><span class=p>.</span><span class=nx>Metrics</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Recording the timestamp to ensure</span>
</span></span><span class=line><span class=cl>    <span class=c1>// all captured data points within this scrape have the same value. </span>
</span></span><span class=line><span class=cl>    <span class=nx>now</span> <span class=o>:=</span> <span class=nx>pcommon</span><span class=p>.</span><span class=nf>NewTimestampFromTime</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Casting to an int64 to match the expected type</span>
</span></span><span class=line><span class=cl>    <span class=nx>s</span><span class=p>.</span><span class=nx>mb</span><span class=p>.</span><span class=nf>RecordJenkinsJobsCountDataPoint</span><span class=p>(</span><span class=nx>now</span><span class=p>,</span> <span class=nb>int64</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>jobs</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>job</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>jobs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Ensure we have valid results to start off with</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nx>build</span>  <span class=p>=</span> <span class=nx>job</span><span class=p>.</span><span class=nx>LastCompletedBuild</span>
</span></span><span class=line><span class=cl>            <span class=nx>status</span> <span class=p>=</span> <span class=nx>metadata</span><span class=p>.</span><span class=nx>AttributeJobStatusUnknown</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// This will check the result of the job, however,</span>
</span></span><span class=line><span class=cl>        <span class=c1>// since the only defined attributes are </span>
</span></span><span class=line><span class=cl>        <span class=c1>// `success`, `failure`, and `unknown`. </span>
</span></span><span class=line><span class=cl>        <span class=c1>// it is assume that anything did not finish </span>
</span></span><span class=line><span class=cl>        <span class=c1>// with a success or failure to be an unknown status.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>switch</span> <span class=nx>build</span><span class=p>.</span><span class=nx>Result</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=s>&#34;aborted&#34;</span><span class=p>,</span> <span class=s>&#34;not_built&#34;</span><span class=p>,</span> <span class=s>&#34;unstable&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nx>status</span> <span class=p>=</span> <span class=nx>metadata</span><span class=p>.</span><span class=nx>AttributeJobStatusUnknown</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=s>&#34;success&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nx>status</span> <span class=p>=</span> <span class=nx>metadata</span><span class=p>.</span><span class=nx>AttributeJobStatusSuccess</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=s>&#34;failure&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nx>status</span> <span class=p>=</span> <span class=nx>metadata</span><span class=p>.</span><span class=nx>AttributeJobStatusFailed</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>s</span><span class=p>.</span><span class=nx>mb</span><span class=p>.</span><span class=nf>RecordJenkinsJobDurationDataPoint</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nb>int64</span><span class=p>(</span><span class=nx>job</span><span class=p>.</span><span class=nx>LastCompletedBuild</span><span class=p>.</span><span class=nx>Duration</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=nx>job</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>status</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>s</span><span class=p>.</span><span class=nx>mb</span><span class=p>.</span><span class=nf>Emit</span><span class=p>(),</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div><div data-tab-item=report-the-delta class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><p>The final step is to calculate how long it took from
commit to job completion to help infer our DORA metrics.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=nx>scraper</span><span class=p>)</span> <span class=nf>scrape</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>(</span><span class=nx>pmetric</span><span class=p>.</span><span class=nx>Metrics</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>jobs</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nf>GetJobs</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>pmetric</span><span class=p>.</span><span class=nx>Metrics</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Recording the timestamp to ensure</span>
</span></span><span class=line><span class=cl>    <span class=c1>// all captured data points within this scrape have the same value. </span>
</span></span><span class=line><span class=cl>    <span class=nx>now</span> <span class=o>:=</span> <span class=nx>pcommon</span><span class=p>.</span><span class=nf>NewTimestampFromTime</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Casting to an int64 to match the expected type</span>
</span></span><span class=line><span class=cl>    <span class=nx>s</span><span class=p>.</span><span class=nx>mb</span><span class=p>.</span><span class=nf>RecordJenkinsJobsCountDataPoint</span><span class=p>(</span><span class=nx>now</span><span class=p>,</span> <span class=nb>int64</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>jobs</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>job</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>jobs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Ensure we have valid results to start off with</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nx>build</span>  <span class=p>=</span> <span class=nx>job</span><span class=p>.</span><span class=nx>LastCompletedBuild</span>
</span></span><span class=line><span class=cl>            <span class=nx>status</span> <span class=p>=</span> <span class=nx>metadata</span><span class=p>.</span><span class=nx>AttributeJobStatusUnknown</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Previous step here</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Ensure that the `ChangeSet` has values</span>
</span></span><span class=line><span class=cl>        <span class=c1>// set so there is a valid value for us to reference</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>build</span><span class=p>.</span><span class=nx>ChangeSet</span><span class=p>.</span><span class=nx>Items</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Making the assumption that the first changeset</span>
</span></span><span class=line><span class=cl>        <span class=c1>// item is the most recent change.</span>
</span></span><span class=line><span class=cl>        <span class=nx>change</span> <span class=o>:=</span> <span class=nx>build</span><span class=p>.</span><span class=nx>ChangeSet</span><span class=p>.</span><span class=nx>Items</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Record the difference from the build time</span>
</span></span><span class=line><span class=cl>        <span class=c1>// compared against the change timestamp.</span>
</span></span><span class=line><span class=cl>        <span class=nx>s</span><span class=p>.</span><span class=nx>mb</span><span class=p>.</span><span class=nf>RecordJenkinsJobCommitDeltaDataPoint</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nb>int64</span><span class=p>(</span><span class=nx>build</span><span class=p>.</span><span class=nx>Timestamp</span><span class=o>-</span><span class=nx>change</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=nx>job</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>status</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>s</span><span class=p>.</span><span class=nx>mb</span><span class=p>.</span><span class=nf>Emit</span><span class=p>(),</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Once all of these steps have been completed, you now have built a custom Jenkins CI receiver!</p><h2 id=whats-next>Whats next?</h2><p>There are more than likely features that would be desired from component that you can think of, like:</p><ul><li>Can I include the branch name that the job used?</li><li>Can I include the project name for the job?</li><li>How I calculate the collective job durations for project?</li><li>How do I validate the changes work?</li></ul><p>Please take this time to play around, break it, change things around, or even try to capture logs from the builds.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article></section></section><article class=default><header class=headline></header><h1 id=advanced-collector-configuration>Advanced Collector Configuration</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>90 minutes</span>
</span>&nbsp;
<span class="badge cstyle blue badge-with-title"><span class=badge-title class=text-muted>Authors
</span><span class=badge-content>Robert Castley,
Charity Anderson,
Pieter Hagen
&
Geoff Higginbottom</span></span><p>The goal of this workshop is to help you gain confidence in creating and modifying OpenTelemetry Collector configuration files. Youâ€™ll start with a minimal <code>agent.yaml</code> file and progressively build it out to handle several advanced, real-world scenarios.</p><p>A key focus of this workshop is learning how to configure the OpenTelemetry Collector to store telemetry data locally, rather than sending it to a third-party vendor backend. This approach not only simplifies debugging and troubleshooting but is also ideal for testing and development environments where you want to avoid sending data to production systems.</p><p>To make the most of this workshop, you should have:</p><ul><li>A basic understanding of the OpenTelemetry Collector and its configuration file structure.</li><li>Proficiency in editing YAML files.</li></ul><p>Everything in this workshop is designed to run locally, ensuring a hands-on and accessible learning experience. Letâ€™s dive in and start building!</p><h3 id=workshop-overview>Workshop Overview</h3><p>During this workshop, we will cover the following topics:</p><ul><li><strong>Setting up the agent locally</strong>: Add metadata, and introduce the debug and file exporters.</li><li><strong>Configuring a gateway</strong>: Route traffic from the agent to the gateway.</li><li><strong>Configuring the FileLog receiver</strong>: Collect log data from various log files.</li><li><strong>Enhancing agent resilience</strong>: Basic configurations for fault tolerance.</li><li><strong>Configuring processors</strong>:<ul><li>Filter out noise by dropping specific spans (e.g., health checks).</li><li>Remove unnecessary tags, and handle sensitive data.</li><li>Transform data using OTTL (OpenTelemetry Transformation Language) in the pipeline before exporting.</li></ul></li><li><strong>Configuring Connectors</strong>:<ul><li>Route data to different endpoints based on the values received.</li><li>Convert log and span data to metrics.</li></ul></li></ul><p>By the end of this workshop, you&rsquo;ll be familiar with configuring the OpenTelemetry Collector for a variety of real-world use cases.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 17, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of Advanced Collector Configuration</h1><article class=default><header class=headline></header><h1 id=pre-requisites>Pre-requisites</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>90 minutes</span>
</span>&nbsp;<h3 id=prerequisites>Prerequisites</h3><ul><li>Proficiency in editing YAML files using <code>vi</code>, <code>vim</code>, <code>nano</code>, or your preferred text editor.</li><li>Supported Environments:<ul><li>Splunk Workshop Instance (preferred)</li><li>Apple Mac (Apple Silicon). Installation of <code>jq</code> is required - <a href=https://jqlang.org/download/ rel=external target=_blank><strong>https://jqlang.org/download/</strong></a></li></ul></li></ul><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p><strong>Create a workshop directory</strong>: In your environment create a new directory (e.g., <code>advanced-otel-workshop</code>). We will refer to this directory as <code>[WORKSHOP]</code> for the remainder of the workshop.</p><p><strong>Download workshop binaries</strong>: Change into your <code>[WORKSHOP]</code> directory and download the OpenTelemetry Collector and Load Generator binaries:</p><div class=tab-panel data-tab-group=ea6165a2fd3625cb199575ea8f10352d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=splunk-workshop-instance class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ea6165a2fd3625cb199575ea8f10352d","splunk-workshop-instance")'>
<span class=tab-nav-text>Splunk Workshop Instance</span>
</button>
<button data-tab-item=apple-silicon class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("ea6165a2fd3625cb199575ea8f10352d","apple-silicon")'>
<span class=tab-nav-text>Apple Silicon</span></button></div><div class=tab-content-container><div data-tab-item=splunk-workshop-instance class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -L https://github.com/signalfx/splunk-otel-collector/releases/download/v0.120.0/otelcol_linux_amd64 -o otelcol <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>curl -L https://github.com/splunk/observability-workshop/raw/refs/heads/main/workshop/ninja/advanced-otel/loadgen/build/loadgen-linux-amd64 -o loadgen</span></span></code></pre></div><p><strong>Update file permissions</strong>: Once downloaded, update the file permissions to make both executable:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>chmod +x otelcol loadgen <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>./otelcol -v <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>./loadgen --help</span></span></code></pre></div></div></div><div data-tab-item=apple-silicon class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -L https://github.com/signalfx/splunk-otel-collector/releases/download/v0.120.0/otelcol_darwin_arm64 -o otelcol <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>curl -L https://github.com/splunk/observability-workshop/raw/refs/heads/main/workshop/ninja/advanced-otel/loadgen/build/loadgen-darwin-arm64 -o loadgen</span></span></code></pre></div><details open class="box cstyle notices warning"><summary class=box-label><i class="fa-fw fas fa-desktop"></i>
macOS Users</summary><div class=box-content><p>Before running the binaries on macOS, you need to remove the quarantine attribute that macOS applies to downloaded files. This step ensures they can execute without restrictions.</p><p>Run the following command in your terminal:</p><div class=tab-panel data-tab-group=73ba7bbf63a8077cf9d218369ee50234><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=remove-quarantine-attribute class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("73ba7bbf63a8077cf9d218369ee50234","remove-quarantine-attribute")'>
<span class=tab-nav-text>Remove Quarantine Attribute</span></button></div><div class=tab-content-container><div data-tab-item=remove-quarantine-attribute class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>xattr -dr com.apple.quarantine otelcol <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>xattr -dr com.apple.quarantine loadgen</span></span></code></pre></div></div></div></div></div><p><strong>Update file permissions</strong>: Once downloaded, update the file permissions to make both executable:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>chmod +x otelcol loadgen <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>./otelcol -v <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>./loadgen --help</span></span></code></pre></div></div></details></div></div></div></div><div class=tab-panel data-tab-group=1a3ceb3b5f9e52149007fcb951ea4b2a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=initial-directory-structure class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1a3ceb3b5f9e52149007fcb951ea4b2a","initial-directory-structure")'>
<span class=tab-nav-text>Initial Directory Structure</span></button></div><div class=tab-content-container><div data-tab-item=initial-directory-structure class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>[WORKSHOP]
</span></span><span class=line><span class=cl>â”œâ”€â”€ otelcol      # OpenTelemetry Collector binary
</span></span><span class=line><span class=cl>â””â”€â”€ loadgen      # Load Generator binary</span></span></code></pre></div></div></div></div></div></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 17, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=1-agent-configuration>1. Agent Configuration</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<details open class="box cstyle notices primary"><summary class=box-label><i class="fa-fw fas fa-lightbulb"></i>
Tip</summary><div class=box-content><p>During this workshop, you will be using up to five terminal windows simultaneously. To stay organized, consider customizing each terminal or shell with unique names and colors. This will help you quickly identify and switch between them as needed.</p><p>We will refer to these terminals as: <strong>Agent</strong>, <strong>Gateway</strong>, <strong>Spans</strong>, <strong>Logs</strong> and <strong>Tests</strong>.</p></div></details><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><ol><li><p>In the <strong>Agent terminal</strong> window, change into the <code>[WORKSHOP]</code> directory and create a new subdirectory named <code>1-agent</code>.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir 1-agent <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=nb>cd</span> 1-agent</span></span></code></pre></div></li><li><p>Create a file named <code>agent.yaml</code>. This file will define the basic structure of an OpenTelemetry Collector configuration.</p></li><li><p>Copy and paste the following initial configuration into <code>agent.yaml</code>:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># Extensions</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>health_check</span><span class=p>:</span><span class=w>                        </span><span class=c># Health Check Extension</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>13133</span><span class=w>            </span><span class=c># Health Check Endpoint</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Receivers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hostmetrics</span><span class=p>:</span><span class=w>                         </span><span class=c># Host Metrics Receiver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>collection_interval</span><span class=p>:</span><span class=w> </span><span class=l>3600s        </span><span class=w> </span><span class=c># Collection Interval (1hr)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>scrapers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cpu</span><span class=p>:</span><span class=w>                             </span><span class=c># CPU Scraper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>otlp</span><span class=p>:</span><span class=w>                                </span><span class=c># OTLP Receiver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocols</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>http</span><span class=p>:</span><span class=w>                            </span><span class=c># Configure HTTP protocol</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0.0.0.0:4318&#34;</span><span class=w>       </span><span class=c># Endpoint to bind to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Exporters</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>debug</span><span class=p>:</span><span class=w>                               </span><span class=c># Debug Exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbosity</span><span class=p>:</span><span class=w> </span><span class=l>detailed               </span><span class=w> </span><span class=c># Detailed verbosity level</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Processors</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>memory_limiter</span><span class=p>:</span><span class=w>                      </span><span class=c># Limits memory usage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>check_interval</span><span class=p>:</span><span class=w> </span><span class=l>2s                </span><span class=w> </span><span class=c># Check interval</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>limit_mib</span><span class=p>:</span><span class=w> </span><span class=m>512</span><span class=w>                     </span><span class=c># Memory limit in MiB</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourcedetection</span><span class=p>:</span><span class=w>                   </span><span class=c># Resource Detection Processor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>detectors</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>system]               </span><span class=w> </span><span class=c># Detect system resources</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>override</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>                     </span><span class=c># Overwrites existing attributes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resource/add_mode</span><span class=p>:</span><span class=w>                   </span><span class=c># Resource Processor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>attributes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>insert                  </span><span class=w> </span><span class=c># Action to perform</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>otelcol.service.mode       </span><span class=w> </span><span class=c># Key name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;agent&#34;</span><span class=w>                   </span><span class=c># Key value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Connectors</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#connectors:                           # leave this commented out; we will uncomment in an upcoming exercise</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Service Section - Enabled Pipelines</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>health_check                      </span><span class=w> </span><span class=c># Health Check Extension</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp                          </span><span class=w> </span><span class=c># OTLP Receiver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter                </span><span class=w> </span><span class=c># Memory Limiter processor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resourcedetection             </span><span class=w> </span><span class=c># Add system attributes to the data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_mode             </span><span class=w> </span><span class=c># Add collector mode metadata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug                         </span><span class=w> </span><span class=c># Debug Exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug</span></span></span></code></pre></div></li><li><p>Your directory structure should now look like this:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>â””â”€â”€ agent.yaml  # OpenTelemetry Collector configuration file</span></span></code></pre></div></li></ol></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 27, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 1. Agent Setup</h1><article class=default><header class=headline></header><h1 id=11-validation--load-generation>1.1 Validation & Load Generation</h1><p>In this workshop, weâ€™ll use <a href=https://otelbin.io/ rel=external target=_blank><strong>https://otelbin.io</strong></a> to quickly validate YAML syntax and ensure your OpenTelemetry configurations are accurate. This step helps avoid errors before running tests during the session.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p>Hereâ€™s how to validate your configuration:</p><ol><li><p>Open <a href=https://otelbin.io/ rel=external target=_blank><strong>https://otelbin.io</strong></a> and replace the existing configuration by pasting your YAML into the left pane.</p><details open class="box cstyle notices info"><summary class=box-label><i class="fa-fw fas fa-info-circle"></i>
Info</summary><div class=box-content><p>If are on a Mac and <strong>not</strong> using a Splunk Workshop instance, you can quickly copy the contents of the <code>agent.yaml</code> file to your clipboard by running the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat agent.yaml <span class=p>|</span> pbcopy</span></span></code></pre></div></div></details></li><li><p>At the top of the page, make sure <strong>Splunk OpenTelemetry Collector</strong> is selected as the validation target. If you <strong>don&rsquo;t</strong> select this option, then you will see warnings in the UI stating <code>Receiver "hostmetrics" is unused. (Line 8)</code>.</p></li><li><p>Once validated, refer to the image representation below to confirm your pipelines are set up correctly.</p></li></ol><p>In most cases, weâ€™ll display only the <strong>key pipeline</strong>. However, if all three pipelines (Traces, Metrics, and Logs) share the same structure, weâ€™ll note this instead of showing each one individually.</p><pre class="mermaid align-center">%%{init:{&#34;fontFamily&#34;:&#34;monospace&#34;}}%%
graph LR
    %% Nodes
      REC1(&amp;nbsp;&amp;nbsp;otlp&amp;nbsp;&amp;nbsp;&lt;br&gt;fa:fa-download):::receiver
      PRO1(memory_limiter&lt;br&gt;fa:fa-microchip):::processor
      PRO2(resourcedetection&lt;br&gt;fa:fa-microchip):::processor
      PRO3(resource&lt;br&gt;fa:fa-microchip&lt;br&gt;add_mode):::processor
      EXP1(&amp;ensp;debug&amp;ensp;&lt;br&gt;fa:fa-upload):::exporter
    %% Links
    subID1:::sub-traces
    subgraph &#34; &#34;
      subgraph subID1[**Traces/Metrics/Logs**]
      direction LR
      REC1 --&gt; PRO1
      PRO1 --&gt; PRO2
      PRO2 --&gt; PRO3
      PRO3 --&gt; EXP1
      end
    end
classDef receiver,exporter fill:#8b5cf6,stroke:#333,stroke-width:1px,color:#fff;
classDef processor fill:#6366f1,stroke:#333,stroke-width:1px,color:#fff;
classDef con-receive,con-export fill:#45c175,stroke:#333,stroke-width:1px,color:#fff;
classDef sub-traces stroke:#fff,stroke-width:1px, color:#fff,stroke-dasharray: 3 3;</pre></div></details><hr><h2 id=load-generation-tool>Load Generation Tool</h2><p>For this workshop we have specifically developed a <code>loadgen</code> tool. <code>loadgen</code> is a flexible load generator for simulating traces and logging activities. It supports base, health, and security traces by default, along with optional logging of random quotes to a file, either in plain text or JSON format.</p><p>The output generated by <code>loadgen</code> mimic those produced by an OpenTelemetry instrumentation library, allowing us to test the Collectorâ€™s processing logic and offers a simple yet powerful way to mimic real-world scenarios.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 27, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=12-test-agent-configuration>1.2 Test Agent Configuration</h1><p>Youâ€™re ready to start the OpenTelemetry Collector with the newly created <code>agent.yaml</code>. This exercise sets the foundation for understanding how data flows through the OpenTelemetry Collector.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p><strong>Start the Agent</strong>: In the <strong>Agent terminal</strong> window run the following command:</p><div class=tab-panel data-tab-group=90ab2428112c39a963f732838f6df2a7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=start-collector class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("90ab2428112c39a963f732838f6df2a7","start-collector")'>
<span class=tab-nav-text>Start Collector</span></button></div><div class=tab-content-container><div data-tab-item=start-collector class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../otelcol --config<span class=o>=</span>agent.yaml</span></span></code></pre></div></div></div></div></div><p><strong>Verify debug output</strong>: If everything is configured correctly, the first and last lines of the output will look like:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>2025/01/13T12:43:51 settings.go:478: Set config to [agent.yaml]
</span></span><span class=line><span class=cl>&lt;snip to the end&gt;
</span></span><span class=line><span class=cl>2025-01-13T12:43:51.747+0100 info service@v0.120.0/service.go:261 Everything is ready. Begin running and processing data.</span></span></code></pre></div><p><strong>Send Test Span</strong>: Instead of instrumenting an application, weâ€™ll simulate sending trace data to the OpenTelemetry Collector using the <code>loadgen</code> tool.</p><p>In the <strong>Spans terminal</strong> window, change into the <code>1-agent</code> directory and run the following command to send a single span:</p><div class=tab-panel data-tab-group=ae4591ee6f1604bc081d87ef6153ced3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=start-load-generator class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ae4591ee6f1604bc081d87ef6153ced3","start-load-generator")'>
<span class=tab-nav-text>Start Load Generator</span>
</button>
<button data-tab-item=load-generator-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("ae4591ee6f1604bc081d87ef6153ced3","load-generator-output")'>
<span class=tab-nav-text>Load Generator Output</span></button></div><div class=tab-content-container><div data-tab-item=start-load-generator class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../loadgen -count <span class=m>1</span></span></span></code></pre></div></div></div><div data-tab-item=load-generator-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Sending traces. Use Ctrl-C to stop.
</span></span><span class=line><span class=cl>Response: {&#34;partialSuccess&#34;:{}}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Base trace sent with traceId: 1aacb1db8a6d510f10e52f154a7fdb90 and spanId: 7837a3a2d3635d9f</span></span></code></pre></div><p><code>{"partialSuccess":{}}</code>: Indicates 100% success, as the <code>partialSuccess</code> field is empty. In case of a partial failure, this field will include details about any failed parts.</p></div></div></div></div><p><strong>Verify Debug Output</strong>:</p><p>In the <strong>Agent terminal</strong> window check the collector&rsquo;s debug output:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>2025-03-06T10:11:35.174Z        info    Traces  {&#34;otelcol.component.id&#34;: &#34;debug&#34;, &#34;otelcol.component.kind&#34;: &#34;Exporter&#34;, &#34;otelcol.signal&#34;: &#34;traces&#34;, &#34;resource spans&#34;: 1, &#34;spans&#34;: 1}
</span></span><span class=line><span class=cl>2025-03-06T10:11:35.174Z        info    ResourceSpans #0
</span></span><span class=line><span class=cl>Resource SchemaURL: https://opentelemetry.io/schemas/1.6.1
</span></span><span class=line><span class=cl>Resource attributes:
</span></span><span class=line><span class=cl>     -&gt; service.name: Str(cinema-service)
</span></span><span class=line><span class=cl>     -&gt; deployment.environment: Str(production)
</span></span><span class=line><span class=cl>     -&gt; host.name: Str(workshop-instance)
</span></span><span class=line><span class=cl>     -&gt; os.type: Str(linux)
</span></span><span class=line><span class=cl>     -&gt; otelcol.service.mode: Str(agent)
</span></span><span class=line><span class=cl>ScopeSpans #0
</span></span><span class=line><span class=cl>ScopeSpans SchemaURL:
</span></span><span class=line><span class=cl>InstrumentationScope cinema.library 1.0.0
</span></span><span class=line><span class=cl>InstrumentationScope attributes:
</span></span><span class=line><span class=cl>     -&gt; fintest.scope.attribute: Str(Starwars, LOTR)
</span></span><span class=line><span class=cl>Span #0
</span></span><span class=line><span class=cl>    Trace ID       : 0ef4daa44a259a7199a948231bc383c0
</span></span><span class=line><span class=cl>    Parent ID      :
</span></span><span class=line><span class=cl>    ID             : e8fdd442c36cbfb1
</span></span><span class=line><span class=cl>    Name           : /movie-validator
</span></span><span class=line><span class=cl>    Kind           : Server
</span></span><span class=line><span class=cl>    Start time     : 2025-03-06 10:11:35.163557 +0000 UTC
</span></span><span class=line><span class=cl>    End time       : 2025-03-06 10:11:36.163557 +0000 UTC
</span></span><span class=line><span class=cl>    Status code    : Ok
</span></span><span class=line><span class=cl>    Status message : Success
</span></span><span class=line><span class=cl>Attributes:
</span></span><span class=line><span class=cl>     -&gt; user.name: Str(George Lucas)
</span></span><span class=line><span class=cl>     -&gt; user.phone_number: Str(+1555-867-5309)
</span></span><span class=line><span class=cl>     -&gt; user.email: Str(george@deathstar.email)
</span></span><span class=line><span class=cl>     -&gt; user.password: Str(LOTR&gt;StarWars1-2-3)
</span></span><span class=line><span class=cl>     -&gt; user.visa: Str(4111 1111 1111 1111)
</span></span><span class=line><span class=cl>     -&gt; user.amex: Str(3782 822463 10005)
</span></span><span class=line><span class=cl>     -&gt; user.mastercard: Str(5555 5555 5555 4444)
</span></span><span class=line><span class=cl>     -&gt; payment.amount: Double(86.48)
</span></span><span class=line><span class=cl>        {&#34;otelcol.component.id&#34;: &#34;debug&#34;, &#34;otelcol.component.kind&#34;: &#34;Exporter&#34;, &#34;otelcol.signal&#34;: &#34;traces&#34;}</span></span></code></pre></div><details open class="box cstyle notices important"><summary class=box-label><i class="fa-fw fas fa-bolt"></i>
Important</summary><div class=box-content><p>Stop the <code>agent</code> in the <strong>Agent terminal</strong> window using <code>Ctrl-C</code>.</p></div></details></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 12, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=13-file-exporter>1.3 File Exporter</h1><p>To capture more than just debug output on the screen, we also want to generate output during the export phase of the pipeline. For this, we&rsquo;ll add a <strong>File Exporter</strong> to write OTLP data to files for comparison.</p><p>The difference between the OpenTelemetry <strong>debug exporter</strong> and the <strong>file exporter</strong> lies in their purpose and output destination:</p><table><thead><tr><th>Feature</th><th>Debug Exporter</th><th>File Exporter</th></tr></thead><tbody><tr><td><strong>Output Location</strong></td><td>Console/Log</td><td>File on disk</td></tr><tr><td><strong>Purpose</strong></td><td>Real-time debugging</td><td>Persistent offline analysis</td></tr><tr><td><strong>Best for</strong></td><td>Quick inspection during testing</td><td>Temporary storage and sharing</td></tr><tr><td><strong>Production Use</strong></td><td>No</td><td>Rare, but possible</td></tr><tr><td><strong>Persistence</strong></td><td>No</td><td>Yes</td></tr></tbody></table><p>In summary, the <strong>Debug Exporter</strong> is great for real-time, in-development troubleshooting, while the <strong>File Exporter</strong> is better suited for storing telemetry data locally for later use.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p>In the <strong>Agent terminal</strong> window ensure the collector is not running then edit the <code>agent.yaml</code> and configure the <strong>File Exporter</strong>:</p><ol><li><p><strong>Configuring a <code>file</code> exporter</strong>: The <a href=https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/exporter/fileexporter/README.md rel=external target=_blank><strong>File Exporter</strong></a> writes telemetry data to files on disk.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>file</span><span class=p>:</span><span class=w>                                </span><span class=c># File Exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;./agent.out&#34;</span><span class=w>                </span><span class=c># Save path (OTLP/JSON)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>append</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>                      </span><span class=c># Overwrite the file each time</span></span></span></code></pre></div></li><li><p><strong>Update the Pipelines Section</strong>: Add the <code>file</code> exporter to the <code>traces</code> pipeline only:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp                          </span><span class=w> </span><span class=c># OTLP Receiver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter                </span><span class=w> </span><span class=c># Memory Limiter processor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resourcedetection             </span><span class=w> </span><span class=c># Add system attributes to the data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_mode             </span><span class=w> </span><span class=c># Add collector mode metadata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug                         </span><span class=w> </span><span class=c># Debug Exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>file                          </span><span class=w> </span><span class=c># File Exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug</span></span></span></code></pre></div></li></ol></div></details><p>Validate the agent configuration using <a href=https://otelbin.io/ rel=external target=_blank><strong>https://otelbin.io</strong></a>:</p><pre class="mermaid align-center">%%{init:{&#34;fontFamily&#34;:&#34;monospace&#34;}}%%
graph LR
    %% Nodes
      REC1(&amp;nbsp;&amp;nbsp;otlp&amp;nbsp;&amp;nbsp;&lt;br&gt;fa:fa-download):::receiver
      PRO1(memory_limiter&lt;br&gt;fa:fa-microchip):::processor
      PRO2(resourcedetection&lt;br&gt;fa:fa-microchip):::processor
      PRO3(resource&lt;br&gt;fa:fa-microchip&lt;br&gt;add_mode):::processor
      EXP1(&amp;ensp;debug&amp;ensp;&lt;br&gt;fa:fa-upload):::exporter
      EXP2(&amp;ensp;file&amp;ensp;&lt;br&gt;fa:fa-upload):::exporter
    %% Links
    subID1:::sub-traces
    subgraph &#34; &#34;
      subgraph subID1[**Traces**]
      direction LR
      REC1 --&gt; PRO1
      PRO1 --&gt; PRO2
      PRO2 --&gt; PRO3
      PRO3 --&gt; EXP1
      PRO3 --&gt; EXP2
      end
    end
classDef receiver,exporter fill:#8b5cf6,stroke:#333,stroke-width:1px,color:#fff;
classDef processor fill:#6366f1,stroke:#333,stroke-width:1px,color:#fff;
classDef con-receive,con-export fill:#45c175,stroke:#333,stroke-width:1px,color:#fff;
classDef sub-traces stroke:#fbbf24,stroke-width:1px, color:#fbbf24,stroke-dasharray: 3 3;</pre><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 27, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 1.3 File Exporter</h1><article class=default><header class=headline></header><h1 id=131-test-file-exporter>1.3.1 Test File Exporter</h1><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p><strong>Restart your agent</strong>: Find your <strong>Agent terminal</strong> window, and (re)start the <code>agent</code> using the modified configuration:</p><div class=tab-panel data-tab-group=8a3434b1340bd4025c7fb635eef9e8d9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=start-the-agent class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8a3434b1340bd4025c7fb635eef9e8d9","start-the-agent")'>
<span class=tab-nav-text>Start the Agent</span>
</button>
<button data-tab-item=agent-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("8a3434b1340bd4025c7fb635eef9e8d9","agent-output")'>
<span class=tab-nav-text>Agent Output</span></button></div><div class=tab-content-container><div data-tab-item=start-the-agent class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../otelcol --config<span class=o>=</span>agent.yaml</span></span></code></pre></div></div></div><div data-tab-item=agent-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>2025-01-13T12:43:51.747+0100 info service@v0.120.0/service.go:261 Everything is ready. Begin running and processing data.</span></span></code></pre></div></div></div></div></div><p><strong>Send a Trace</strong>: From the <strong>Spans terminal</strong> window, send another span and verify you get the same output on the console as we saw previously:</p><div class=tab-panel data-tab-group=c0c46481b834563736059ce9ea8c508f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=start-load-generator class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c0c46481b834563736059ce9ea8c508f","start-load-generator")'>
<span class=tab-nav-text>Start Load Generator</span></button></div><div class=tab-content-container><div data-tab-item=start-load-generator class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../loadgen -count <span class=m>1</span></span></span></code></pre></div></div></div></div></div><p>We can now stop the <code>agent</code> in the <strong>Agent terminal</strong> window using <code>Ctrl-C</code> so that we can verify the <code>agent.out</code> file was written.</p><p><strong>Verify that the <code>agent.out</code> file is written</strong>: Check that a file named <code>agent.out</code> is written in the current directory.</p><div class=tab-panel data-tab-group=4e7968864447de0f58a632311ec88cb4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=updated-directory-structure class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4e7968864447de0f58a632311ec88cb4","updated-directory-structure")'>
<span class=tab-nav-text>Updated Directory Structure</span></button></div><div class=tab-content-container><div data-tab-item=updated-directory-structure class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>â”œâ”€â”€ agent.out    # OTLP/Json output created by the File Exporter
</span></span><span class=line><span class=cl>â””â”€â”€ agent.yaml</span></span></code></pre></div></div></div></div></div><p><strong>Verify the span format</strong>:</p><ol><li>Verify the format used by the File Exporter to write the span to <code>agent.out</code>.</li><li>The output will be a single line in <strong>OTLP/JSON</strong> format.</li><li>To view the contents of <code>agent.out</code>, you can use the <code>cat ./agent.out</code> command. For a more readable formatted view, pipe the output to <code>jq</code> like this: <code>cat ./agent.out | jq</code>:</li></ol><div class=tab-panel data-tab-group=e3c39c23affc0a34350d3713c859bb65><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=cat-agentout class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e3c39c23affc0a34350d3713c859bb65","cat-agentout")'>
<span class=tab-nav-text>cat ./agent.out</span>
</button>
<button data-tab-item=cat-agentout--jq class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("e3c39c23affc0a34350d3713c859bb65","cat-agentout--jq")'>
<span class=tab-nav-text>cat ./agent.out | jq</span></button></div><div class=tab-content-container><div data-tab-item=cat-agentout class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;resourceSpans&#34;</span><span class=p>:[{</span><span class=nt>&#34;resource&#34;</span><span class=p>:{</span><span class=nt>&#34;attributes&#34;</span><span class=p>:[{</span><span class=nt>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;service.name&#34;</span><span class=p>,</span><span class=nt>&#34;value&#34;</span><span class=p>:{</span><span class=nt>&#34;stringValue&#34;</span><span class=p>:</span><span class=s2>&#34;cinema-service&#34;</span><span class=p>}},{</span><span class=nt>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;deployment.environment&#34;</span><span class=p>,</span><span class=nt>&#34;value&#34;</span><span class=p>:{</span><span class=nt>&#34;stringValue&#34;</span><span class=p>:</span><span class=s2>&#34;production&#34;</span><span class=p>}},{</span><span class=nt>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;host.name&#34;</span><span class=p>,</span><span class=nt>&#34;value&#34;</span><span class=p>:{</span><span class=nt>&#34;stringValue&#34;</span><span class=p>:</span><span class=s2>&#34;workshop-instance&#34;</span><span class=p>}},{</span><span class=nt>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;os.type&#34;</span><span class=p>,</span><span class=nt>&#34;value&#34;</span><span class=p>:{</span><span class=nt>&#34;stringValue&#34;</span><span class=p>:</span><span class=s2>&#34;linux&#34;</span><span class=p>}},{</span><span class=nt>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;otelcol.service.mode&#34;</span><span class=p>,</span><span class=nt>&#34;value&#34;</span><span class=p>:{</span><span class=nt>&#34;stringValue&#34;</span><span class=p>:</span><span class=s2>&#34;agent&#34;</span><span class=p>}}]},</span><span class=nt>&#34;scopeSpans&#34;</span><span class=p>:[{</span><span class=nt>&#34;scope&#34;</span><span class=p>:{</span><span class=nt>&#34;name&#34;</span><span class=p>:</span><span class=s2>&#34;cinema.library&#34;</span><span class=p>,</span><span class=nt>&#34;version&#34;</span><span class=p>:</span><span class=s2>&#34;1.0.0&#34;</span><span class=p>,</span><span class=nt>&#34;attributes&#34;</span><span class=p>:[{</span><span class=nt>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;fintest.scope.attribute&#34;</span><span class=p>,</span><span class=nt>&#34;value&#34;</span><span class=p>:{</span><span class=nt>&#34;stringValue&#34;</span><span class=p>:</span><span class=s2>&#34;Starwars, LOTR&#34;</span><span class=p>}}]},</span><span class=nt>&#34;spans&#34;</span><span class=p>:[{</span><span class=nt>&#34;traceId&#34;</span><span class=p>:</span><span class=s2>&#34;d824a28db5aa5f5a3011f19c452e5af0&#34;</span><span class=p>,</span><span class=nt>&#34;spanId&#34;</span><span class=p>:</span><span class=s2>&#34;ab4cde146f77eacf&#34;</span><span class=p>,</span><span class=nt>&#34;parentSpanId&#34;</span><span class=p>:</span><span class=s2>&#34;&#34;</span><span class=p>,</span><span class=nt>&#34;name&#34;</span><span class=p>:</span><span class=s2>&#34;/movie-validator&#34;</span><span class=p>,</span><span class=nt>&#34;kind&#34;</span><span class=p>:</span><span class=mi>2</span><span class=p>,</span><span class=nt>&#34;startTimeUnixNano&#34;</span><span class=p>:</span><span class=s2>&#34;1741256991405300000&#34;</span><span class=p>,</span><span class=nt>&#34;endTimeUnixNano&#34;</span><span class=p>:</span><span class=s2>&#34;1741256992405300000&#34;</span><span class=p>,</span><span class=nt>&#34;attributes&#34;</span><span class=p>:[{</span><span class=nt>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;user.name&#34;</span><span class=p>,</span><span class=nt>&#34;value&#34;</span><span class=p>:{</span><span class=nt>&#34;stringValue&#34;</span><span class=p>:</span><span class=s2>&#34;George Lucas&#34;</span><span class=p>}},{</span><span class=nt>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;user.phone_number&#34;</span><span class=p>,</span><span class=nt>&#34;value&#34;</span><span class=p>:{</span><span class=nt>&#34;stringValue&#34;</span><span class=p>:</span><span class=s2>&#34;+1555-867-5309&#34;</span><span class=p>}},{</span><span class=nt>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;user.email&#34;</span><span class=p>,</span><span class=nt>&#34;value&#34;</span><span class=p>:{</span><span class=nt>&#34;stringValue&#34;</span><span class=p>:</span><span class=s2>&#34;george@deathstar.email&#34;</span><span class=p>}},{</span><span class=nt>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;user.password&#34;</span><span class=p>,</span><span class=nt>&#34;value&#34;</span><span class=p>:{</span><span class=nt>&#34;stringValue&#34;</span><span class=p>:</span><span class=s2>&#34;LOTR\u003eStarWars1-2-3&#34;</span><span class=p>}},{</span><span class=nt>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;user.visa&#34;</span><span class=p>,</span><span class=nt>&#34;value&#34;</span><span class=p>:{</span><span class=nt>&#34;stringValue&#34;</span><span class=p>:</span><span class=s2>&#34;4111 1111 1111 1111&#34;</span><span class=p>}},{</span><span class=nt>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;user.amex&#34;</span><span class=p>,</span><span class=nt>&#34;value&#34;</span><span class=p>:{</span><span class=nt>&#34;stringValue&#34;</span><span class=p>:</span><span class=s2>&#34;3782 822463 10005&#34;</span><span class=p>}},{</span><span class=nt>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;user.mastercard&#34;</span><span class=p>,</span><span class=nt>&#34;value&#34;</span><span class=p>:{</span><span class=nt>&#34;stringValue&#34;</span><span class=p>:</span><span class=s2>&#34;5555 5555 5555 4444&#34;</span><span class=p>}},{</span><span class=nt>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;payment.amount&#34;</span><span class=p>,</span><span class=nt>&#34;value&#34;</span><span class=p>:{</span><span class=nt>&#34;doubleValue&#34;</span><span class=p>:</span><span class=mf>56.24</span><span class=p>}}],</span><span class=nt>&#34;status&#34;</span><span class=p>:{</span><span class=nt>&#34;message&#34;</span><span class=p>:</span><span class=s2>&#34;Success&#34;</span><span class=p>,</span><span class=nt>&#34;code&#34;</span><span class=p>:</span><span class=mi>1</span><span class=p>}}]}],</span><span class=nt>&#34;schemaUrl&#34;</span><span class=p>:</span><span class=s2>&#34;https://opentelemetry.io/schemas/1.6.1&#34;</span><span class=p>}]}</span></span></span></code></pre></div></div></div><div data-tab-item=cat-agentout--jq class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;resourceSpans&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;resource&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;attributes&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;service.name&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;stringValue&#34;</span><span class=p>:</span> <span class=s2>&#34;cinema-service&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;deployment.environment&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;stringValue&#34;</span><span class=p>:</span> <span class=s2>&#34;production&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;host.name&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;stringValue&#34;</span><span class=p>:</span> <span class=s2>&#34;RCASTLEY-M-YQRY.local&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;os.type&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;stringValue&#34;</span><span class=p>:</span> <span class=s2>&#34;darwin&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;otelcol.service.mode&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;stringValue&#34;</span><span class=p>:</span> <span class=s2>&#34;agent&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;scopeSpans&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;scope&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;cinema.library&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;1.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;attributes&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>              <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;fintest.scope.attribute&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;stringValue&#34;</span><span class=p>:</span> <span class=s2>&#34;Starwars, LOTR&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>              <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;spans&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;traceId&#34;</span><span class=p>:</span> <span class=s2>&#34;d824a28db5aa5f5a3011f19c452e5af0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;spanId&#34;</span><span class=p>:</span> <span class=s2>&#34;ab4cde146f77eacf&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;parentSpanId&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;/movie-validator&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;kind&#34;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;startTimeUnixNano&#34;</span><span class=p>:</span> <span class=s2>&#34;1741256991405300000&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;endTimeUnixNano&#34;</span><span class=p>:</span> <span class=s2>&#34;1741256992405300000&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;attributes&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;user.name&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;stringValue&#34;</span><span class=p>:</span> <span class=s2>&#34;George Lucas&#34;</span>
</span></span><span class=line><span class=cl>                  <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;user.phone_number&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;stringValue&#34;</span><span class=p>:</span> <span class=s2>&#34;+1555-867-5309&#34;</span>
</span></span><span class=line><span class=cl>                  <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;user.email&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;stringValue&#34;</span><span class=p>:</span> <span class=s2>&#34;george@deathstar.email&#34;</span>
</span></span><span class=line><span class=cl>                  <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;user.password&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;stringValue&#34;</span><span class=p>:</span> <span class=s2>&#34;LOTR&gt;StarWars1-2-3&#34;</span>
</span></span><span class=line><span class=cl>                  <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;user.visa&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;stringValue&#34;</span><span class=p>:</span> <span class=s2>&#34;4111 1111 1111 1111&#34;</span>
</span></span><span class=line><span class=cl>                  <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;user.amex&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;stringValue&#34;</span><span class=p>:</span> <span class=s2>&#34;3782 822463 10005&#34;</span>
</span></span><span class=line><span class=cl>                  <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;user.mastercard&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;stringValue&#34;</span><span class=p>:</span> <span class=s2>&#34;5555 5555 5555 4444&#34;</span>
</span></span><span class=line><span class=cl>                  <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;payment.amount&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;doubleValue&#34;</span><span class=p>:</span> <span class=mf>56.24</span>
</span></span><span class=line><span class=cl>                  <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>              <span class=p>],</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Success&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;code&#34;</span><span class=p>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>              <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;schemaUrl&#34;</span><span class=p>:</span> <span class=s2>&#34;https://opentelemetry.io/schemas/1.6.1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 27, 2025</span></span></footer></article></section></section><article class=default><header class=headline></header><h1 id=2-gateway-configuration>2. Gateway Configuration</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<p>The OpenTelemetry Gateway is designed to receive, process, and export telemetry data. It acts as an intermediary between telemetry sources (e.g. applications, services) and backends (e.g., observability platforms like Prometheus, Jaeger, or Splunk Observability Cloud).</p><p>The gateway is useful because it centralizes telemetry data collection, enabling features like data filtering, transformation, and routing to multiple destinations. It also reduces the load on individual services by offloading telemetry processing and ensures consistent data formats across distributed systems. This makes it easier to manage, scale, and analyze telemetry data in complex environments.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><ul><li>In the <strong>Gateway terminal</strong> window, change into the <code>[WORKSHOP]</code> directory and create a new subdirectory named <code>2-gateway</code>.</li></ul><details open class="box cstyle notices important"><summary class=box-label><i class="fa-fw fas fa-bolt"></i>
Important</summary><div class=box-content><p><strong>Change <em>ALL</em> terminal windows to the <code>[WORKSHOP]/2-gateway</code> directory.</strong></p></div></details><ul><li>Back in the <strong>Gateway terminal</strong> window, copy <code>agent.yaml</code> from the <code>1-agent</code> directory into <code>2-gateway</code>.</li><li>Create a file called <code>gateway.yaml</code> and add the following initial configuration:</li></ul><div class=tab-panel data-tab-group=566c21e12cf6ac13ad15c33aafe8a754><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=gatewayyaml class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("566c21e12cf6ac13ad15c33aafe8a754","gatewayyaml")'>
<span class=tab-nav-text>gateway.yaml</span></button></div><div class=tab-content-container><div data-tab-item=gatewayyaml class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>###########################         This section holds all the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## Configuration section ##         configurations that can be </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>###########################         used in this OpenTelemetry Collector</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>extensions</span><span class=p>:</span><span class=w>                       </span><span class=c># List of extensions</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>health_check</span><span class=p>:</span><span class=w>                   </span><span class=c># Health check extension</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>14133</span><span class=w>       </span><span class=c># Custom port to avoid conflicts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>otlp</span><span class=p>:</span><span class=w>                           </span><span class=c># OTLP receiver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocols</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>http</span><span class=p>:</span><span class=w>                       </span><span class=c># HTTP protocol</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0.0.0.0:5318&#34;</span><span class=w>  </span><span class=c># Custom port to avoid conflicts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>include_metadata</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>    </span><span class=c># Required for token pass-through</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>exporters</span><span class=p>:</span><span class=w>                        </span><span class=c># List of exporters</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>debug</span><span class=p>:</span><span class=w>                          </span><span class=c># Debug exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbosity</span><span class=p>:</span><span class=w> </span><span class=l>detailed          </span><span class=w> </span><span class=c># Enable detailed debug output</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>file/traces</span><span class=p>:</span><span class=w>                    </span><span class=c># Exporter Type/Name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;./gateway-traces.out&#34;</span><span class=w>  </span><span class=c># Path for OTLP JSON output</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>append</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>                 </span><span class=c># Overwrite the file each time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>file/metrics</span><span class=p>:</span><span class=w>                   </span><span class=c># Exporter Type/Name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;./gateway-metrics.out&#34;</span><span class=w> </span><span class=c># Path for OTLP JSON output</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>append</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>                 </span><span class=c># Overwrite the file each time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>file/logs</span><span class=p>:</span><span class=w>                      </span><span class=c># Exporter Type/Name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;./gateway-logs.out&#34;</span><span class=w>    </span><span class=c># Path for OTLP JSON output</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>append</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>                 </span><span class=c># Overwrite the file each time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>processors</span><span class=p>:</span><span class=w>                       </span><span class=c># List of processors</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>memory_limiter</span><span class=p>:</span><span class=w>                 </span><span class=c># Limits memory usage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>check_interval</span><span class=p>:</span><span class=w> </span><span class=l>2s           </span><span class=w> </span><span class=c># Memory check interval</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>limit_mib</span><span class=p>:</span><span class=w> </span><span class=m>512</span><span class=w>                </span><span class=c># Memory limit in MiB</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>batch</span><span class=p>:</span><span class=w>                          </span><span class=c># Batches data before exporting</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata_keys</span><span class=p>:</span><span class=w>                </span><span class=c># Groups data by token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>X-SF-Token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resource/add_mode</span><span class=p>:</span><span class=w>              </span><span class=c># Adds metadata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>attributes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>upsert             </span><span class=w> </span><span class=c># Inserts or updates a key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>otelcol.service.mode  </span><span class=w> </span><span class=c># Key name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;gateway&#34;</span><span class=w>            </span><span class=c># Key value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Connectors</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#connectors:                      # leave this commented out; we will uncomment in an upcoming exercise</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>###########################</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>### Activation Section  ###</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>###########################</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>service</span><span class=p>:</span><span class=w>                          </span><span class=c># Service configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>telemetry</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=l>none                </span><span class=w> </span><span class=c># Disable metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>health_check]     </span><span class=w> </span><span class=c># Enabled extensions</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>                      </span><span class=c># Configured pipelines</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>                       </span><span class=c># Traces pipeline</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp                     </span><span class=w> </span><span class=c># OTLP receiver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>                 </span><span class=c># Processors for traces</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug                    </span><span class=w> </span><span class=c># Debug exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>file/traces</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics</span><span class=p>:</span><span class=w>                      </span><span class=c># Metrics pipeline</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp                     </span><span class=w> </span><span class=c># OTLP receiver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>                 </span><span class=c># Processors for metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug                    </span><span class=w> </span><span class=c># Debug exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>file/metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>logs</span><span class=p>:</span><span class=w>                         </span><span class=c># Logs pipeline</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp                     </span><span class=w> </span><span class=c># OTLP receiver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>                 </span><span class=c># Processors for logs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug                    </span><span class=w> </span><span class=c># Debug exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>file/logs</span></span></span></code></pre></div></div></div></div></div><details open class="box cstyle notices note"><summary class=box-label><i class="fa-fw fas fa-exclamation-circle"></i>
Note</summary><div class=box-content><p>When the <code>gateway</code> is started it will generate three files: <code>gateway-traces.out</code>, <code>gateway-metrics.out</code>, and <code>gateway-logs.out</code>. These files will eventually contain the telemetry data received by the gateway.</p></div></details><div class=tab-panel data-tab-group=9231bcce182e687553ecb0f88ff5df32><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=updated-directory-structure class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9231bcce182e687553ecb0f88ff5df32","updated-directory-structure")'>
<span class=tab-nav-text>Updated Directory Structure</span></button></div><div class=tab-content-container><div data-tab-item=updated-directory-structure class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>â”œâ”€â”€ agent.yaml
</span></span><span class=line><span class=cl>â””â”€â”€ gateway.yaml</span></span></code></pre></div></div></div></div></div></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 27, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 2. Gateway Setup</h1><article class=default><header class=headline></header><h1 id=21-start-gateway>2.1 Start Gateway</h1><p>The configuration for the <code>gateway</code> does not need any additional configuration changes to function. This has been done to save time and focus on the core concepts of the <strong>Gateway</strong>.</p><p>Validate the <code>gateway</code> configuration using <strong><a href=https://www.otelbin.io/ rel=external target=_blank>otelbin.io</a></strong>. For reference, the <code>logs:</code> section of your pipelines will look similar to this:</p><pre class="mermaid align-center">%%{init:{&#34;fontFamily&#34;:&#34;monospace&#34;}}%%
graph LR
    %% Nodes
      REC1(&amp;nbsp;&amp;nbsp;otlp&amp;nbsp;&amp;nbsp;&lt;br&gt;fa:fa-download):::receiver
      PRO1(memory_limiter&lt;br&gt;fa:fa-microchip):::processor
      PRO2(resource&lt;br&gt;fa:fa-microchip&lt;br&gt;add_mode):::processor
      PRO3(batch&lt;br&gt;fa:fa-microchip):::processor
      EXP1(&amp;ensp;file&amp;ensp;&lt;br&gt;fa:fa-upload&lt;br&gt;logs):::exporter
      EXP2(&amp;ensp;debug&amp;ensp;&lt;br&gt;fa:fa-upload):::exporter
    %% Links
    subID1:::sub-logs
    subgraph &#34; &#34;
      subgraph subID1[**Logs**]
      direction LR
      REC1 --&gt; PRO1
      PRO1 --&gt; PRO2
      PRO2 --&gt; PRO3
      PRO3 --&gt; EXP2
      PRO3 --&gt; EXP1
      end
    end
classDef receiver,exporter fill:#8b5cf6,stroke:#333,stroke-width:1px,color:#fff;
classDef processor fill:#6366f1,stroke:#333,stroke-width:1px,color:#fff;
classDef con-receive,con-export fill:#45c175,stroke:#333,stroke-width:1px,color:#fff;
classDef sub-logs stroke:#34d399,stroke-width:1px, color:#34d399,stroke-dasharray: 3 3;</pre><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p><strong>Start the Gateway</strong>: In the <strong>Gateway terminal</strong> window, run the following command to start the <code>gateway</code>:</p><div class=tab-panel data-tab-group=a4fbe2b0b5cf022ef507b47584a5c267><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=start-the-gateway class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a4fbe2b0b5cf022ef507b47584a5c267","start-the-gateway")'>
<span class=tab-nav-text>Start the Gateway</span></button></div><div class=tab-content-container><div data-tab-item=start-the-gateway class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../otelcol --config<span class=o>=</span>gateway.yaml</span></span></code></pre></div></div></div></div></div><p>If everything is configured correctly, the first and last lines of the output should look like:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>2025/01/15 15:33:53 settings.go:478: Set config to [gateway.yaml]
</span></span><span class=line><span class=cl>&lt;snip to the end&gt;
</span></span><span class=line><span class=cl>2025-01-13T12:43:51.747+0100 info service@v0.120.0/service.go:261 Everything is ready. Begin running and processing data.</span></span></code></pre></div></div></details><p>Next, we will configure the <code>agent</code> to send data to the newly created <code>gateway</code>.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 7, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=22-configure-agent>2.2 Configure Agent</h1><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p><strong>Add the <code>otlphttp</code> exporter</strong>: The <a href=https://docs.splunk.com/observability/en/gdi/opentelemetry/components/otlphttp-exporter.html rel=external target=_blank><strong>OTLP/HTTP Exporter</strong></a> is used to send data from the agent to the gateway using the <strong>OTLP/HTTP</strong> protocol.</p><ol><li>Switch to your <strong>Agent terminal</strong> window.</li><li>Validate that the newly generated <code>gateway-logs.out</code>, <code>gateway-metrics.out</code>, and <code>gateway-traces.out</code> are present in the directory.</li><li>Open the <code>agent.yaml</code> file in your editor.</li><li>Add the <code>otlphttp</code> exporter configuration to the <code>exporters:</code> section:</li></ol><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>otlphttp</span><span class=p>:</span><span class=w>                            </span><span class=c># Exporter Type</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;http://localhost:5318&#34;</span><span class=w>  </span><span class=c># Gateway OTLP endpoint</span></span></span></code></pre></div><p><strong>Add a Batch Processor configuration</strong>: The <a href=https://github.com/open-telemetry/opentelemetry-collector/blob/main/processor/batchprocessor/README.md rel=external target=_blank><strong>Batch Processor</strong></a> will accept spans, metrics, or logs and place them into batches. Batching helps better compress the data and reduce the number of outgoing connections required to transmit the data. It is highly recommended configuring the batch processor on every collector.</p><ol><li>Add the <code>batch</code> processor configuration to the <code>processors:</code> section:</li></ol><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>batch</span><span class=p>:</span><span class=w>                               </span><span class=c># Processor Type</span></span></span></code></pre></div><p><strong>Update the pipelines</strong>:</p><ol><li><strong>Enable Hostmetrics Receiver</strong>:<ul><li>Add <code>hostmetrics</code> to the <code>metrics</code> pipeline. The <a href=https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/hostmetricsreceiver#readme rel=external target=_blank><strong>HostMetrics Receiver</strong></a> will generate host CPU metrics once per hour with the current configuration.</li></ul></li><li><strong>Enable Batch Processor</strong>:<ul><li>Add the <code>batch</code> processor (after the <code>resource/add_mode</code> processor) to the <code>traces</code>, <code>metrics</code>, and <code>logs</code> pipelines.</li></ul></li><li><strong>Enable OTLPHTTP Exporter</strong>:<ul><li>Add the <code>otlphttp</code> exporter to the <code>traces</code>, <code>metrics</code>, and <code>logs</code> pipelines.</li></ul></li></ol><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp                          </span><span class=w> </span><span class=c># OTLP Receiver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter                </span><span class=w> </span><span class=c># Memory Limiter processor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resourcedetection             </span><span class=w> </span><span class=c># Add system attributes to the data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_mode             </span><span class=w> </span><span class=c># Add collector mode metadata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>batch                         </span><span class=w> </span><span class=c># Batch processor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug                         </span><span class=w> </span><span class=c># Debug Exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>file                          </span><span class=w> </span><span class=c># File Exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlphttp                      </span><span class=w> </span><span class=c># OTLP/HTTP Exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>hostmetrics                   </span><span class=w> </span><span class=c># Host Metrics Receiver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlphttp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlphttp</span></span></span></code></pre></div></div></details><p>Validate the agent configuration using <strong><a href=https://www.otelbin.io/ rel=external target=_blank>otelbin.io</a></strong>. For reference, the <code>metrics:</code> section of your pipelines will look similar to this:</p><pre class="mermaid align-center">%%{init:{&#34;fontFamily&#34;:&#34;monospace&#34;}}%%
graph LR
    %% Nodes
      REC1(&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;otlp&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;br&gt;fa:fa-download):::receiver
      REC2(hostmetrics&lt;br&gt;fa:fa-download):::receiver
      PRO1(memory_limiter&lt;br&gt;fa:fa-microchip):::processor
      PRO2(resourcedetection&lt;br&gt;fa:fa-microchip):::processor
      PRO3(resource&lt;br&gt;fa:fa-microchip&lt;br&gt;add_mode):::processor
      PRO4(batch&lt;br&gt;fa:fa-microchip):::processor
      EXP1(otlphttp&lt;br&gt;fa:fa-upload):::exporter
      EXP2(&amp;ensp;debug&amp;ensp;&lt;br&gt;fa:fa-upload):::exporter
    %% Links
    subID1:::sub-metrics
    subgraph &#34; &#34;
      subgraph subID1[**Metrics**]
      direction LR
      REC1 --&gt; PRO1
      REC2 --&gt; PRO1
      PRO1 --&gt; PRO2
      PRO2 --&gt; PRO3
      PRO3 --&gt; PRO4
      PRO4 --&gt; EXP2
      PRO4 --&gt; EXP1
      end
    end
classDef receiver,exporter fill:#8b5cf6,stroke:#333,stroke-width:1px,color:#fff;
classDef processor fill:#6366f1,stroke:#333,stroke-width:1px,color:#fff;
classDef con-receive,con-export fill:#45c175,stroke:#333,stroke-width:1px,color:#fff;
classDef sub-metrics stroke:#38bdf8,stroke-width:1px, color:#38bdf8,stroke-dasharray: 3 3;</pre><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 12, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=23-send-metrics-from-the-agent-to-the-gateway>2.3 Send metrics from the Agent to the Gateway</h1><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p><strong>Start the Agent</strong>: In the <strong>Agent terminal</strong> window start the agent with the updated configuration:</p><div class=tab-panel data-tab-group=184e2d876b27cfe20cf49e6a49715838><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=start-the-agent class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("184e2d876b27cfe20cf49e6a49715838","start-the-agent")'>
<span class=tab-nav-text>Start the Agent</span></button></div><div class=tab-content-container><div data-tab-item=start-the-agent class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../otelcol --config<span class=o>=</span>agent.yaml</span></span></code></pre></div></div></div></div></div><p><strong>Verify CPU Metrics</strong>:</p><ol><li>Check that when the <code>agent</code> starts, it immediately starts sending <strong>CPU</strong> metrics.</li><li>Both the <code>agent</code> and the <code>gateway</code> will display this activity in their debug output. The output should resemble the following snippet:</li></ol><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>&lt;snip&gt;
</span></span><span class=line><span class=cl>NumberDataPoints #37
</span></span><span class=line><span class=cl>Data point attributes:
</span></span><span class=line><span class=cl>    -&gt; cpu: Str(cpu0)
</span></span><span class=line><span class=cl>    -&gt; state: Str(system)
</span></span><span class=line><span class=cl>StartTimestamp: 2024-12-09 14:18:28 +0000 UTC
</span></span><span class=line><span class=cl>Timestamp: 2025-01-15 15:27:51.319526 +0000 UTC
</span></span><span class=line><span class=cl>Value: 9637.660000</span></span></code></pre></div><p>At this stage, the <code>agent</code> continues to collect <strong>CPU</strong> metrics once per hour or upon each restart and sends them to the gateway.</p><p>The <code>gateway</code> processes these metrics and exports them to a file named <code>./gateway-metrics.out</code>. This file stores the exported metrics as part of the pipeline service.</p><p><strong>Verify Data arrived at Gateway</strong>: To confirm that CPU metrics, specifically for <code>cpu0</code>, have successfully reached the gateway, weâ€™ll inspect the <code>gateway-metrics.out</code> file using the <code>jq</code> command.</p><p>The following command filters and extracts the <code>system.cpu.time</code> metric, focusing on <code>cpu0</code>. It displays the metricâ€™s state (e.g., <code>user</code>, <code>system</code>, <code>idle</code>, <code>interrupt</code>) along with the corresponding values.</p><p>Run the command below in the <strong>Tests terminal</strong> to check the <code>system.cpu.time</code> metric:</p><div class=tab-panel data-tab-group=6860384175b5bf5d2e8529373a0030ca><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=check-cpu-metrics class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6860384175b5bf5d2e8529373a0030ca","check-cpu-metrics")'>
<span class=tab-nav-text>Check CPU Metrics</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("6860384175b5bf5d2e8529373a0030ca","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=check-cpu-metrics class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>jq <span class=s1>&#39;.resourceMetrics[].scopeMetrics[].metrics[] | select(.name == &#34;system.cpu.time&#34;) | .sum.dataPoints[] | select(.attributes[0].value.stringValue == &#34;cpu0&#34;) | {cpu: .attributes[0].value.stringValue, state: .attributes[1].value.stringValue, value: .asDouble}&#39;</span> gateway-metrics.out</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;cpu&#34;</span><span class=p>:</span> <span class=s2>&#34;cpu0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;state&#34;</span><span class=p>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=mf>123407.02</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;cpu&#34;</span><span class=p>:</span> <span class=s2>&#34;cpu0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;state&#34;</span><span class=p>:</span> <span class=s2>&#34;system&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=mf>64866.6</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;cpu&#34;</span><span class=p>:</span> <span class=s2>&#34;cpu0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;state&#34;</span><span class=p>:</span> <span class=s2>&#34;idle&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=mf>216427.87</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;cpu&#34;</span><span class=p>:</span> <span class=s2>&#34;cpu0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;state&#34;</span><span class=p>:</span> <span class=s2>&#34;interrupt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 11, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=24-send-traces-from-the-agent-to-the-gateway>2.4 Send traces from the Agent to the Gateway</h1><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p><strong>Send a Test Trace</strong>:</p><ol><li>Validate <code>agent</code> and <code>gateway</code> are still running.</li><li>In the <strong>Spans terminal</strong> window, run the following command to send 5 spans and validate the output of the <code>agent</code> and <code>gateway</code> debug logs:</li></ol><div class=tab-panel data-tab-group=585aa82e506c263a7fcc09acf7e5079d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=start-the-load-generator class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("585aa82e506c263a7fcc09acf7e5079d","start-the-load-generator")'>
<span class=tab-nav-text>Start the Load Generator</span>
</button>
<button data-tab-item=agentgateway-debug-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("585aa82e506c263a7fcc09acf7e5079d","agentgateway-debug-output")'>
<span class=tab-nav-text>Agent/Gateway Debug Output</span></button></div><div class=tab-content-container><div data-tab-item=start-the-load-generator class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../loadgen -count <span class=m>5</span></span></span></code></pre></div></div></div><div data-tab-item=agentgateway-debug-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>2025-03-06T11:49:00.456Z        info    Traces  {&#34;otelcol.component.id&#34;: &#34;debug&#34;, &#34;otelcol.component.kind&#34;: &#34;Exporter&#34;, &#34;otelcol.signal&#34;: &#34;traces&#34;, &#34;resource spans&#34;: 1, &#34;spans&#34;: 1}
</span></span><span class=line><span class=cl>2025-03-06T11:49:00.456Z        info    ResourceSpans #0
</span></span><span class=line><span class=cl>Resource SchemaURL: https://opentelemetry.io/schemas/1.6.1
</span></span><span class=line><span class=cl>Resource attributes:
</span></span><span class=line><span class=cl>     -&gt; service.name: Str(cinema-service)
</span></span><span class=line><span class=cl>     -&gt; deployment.environment: Str(production)
</span></span><span class=line><span class=cl>     -&gt; host.name: Str(workshop-instance)
</span></span><span class=line><span class=cl>     -&gt; os.type: Str(linux)
</span></span><span class=line><span class=cl>     -&gt; otelcol.service.mode: Str(agent)
</span></span><span class=line><span class=cl>ScopeSpans #0
</span></span><span class=line><span class=cl>ScopeSpans SchemaURL:
</span></span><span class=line><span class=cl>InstrumentationScope cinema.library 1.0.0
</span></span><span class=line><span class=cl>InstrumentationScope attributes:
</span></span><span class=line><span class=cl>     -&gt; fintest.scope.attribute: Str(Starwars, LOTR)
</span></span><span class=line><span class=cl>Span #0
</span></span><span class=line><span class=cl>    Trace ID       : 97fb4e5b13400b5689e3306da7cff077
</span></span><span class=line><span class=cl>    Parent ID      :
</span></span><span class=line><span class=cl>    ID             : 413358465e5b4f15
</span></span><span class=line><span class=cl>    Name           : /movie-validator
</span></span><span class=line><span class=cl>    Kind           : Server
</span></span><span class=line><span class=cl>    Start time     : 2025-03-06 11:49:00.431915 +0000 UTC
</span></span><span class=line><span class=cl>    End time       : 2025-03-06 11:49:01.431915 +0000 UTC
</span></span><span class=line><span class=cl>    Status code    : Ok
</span></span><span class=line><span class=cl>    Status message : Success
</span></span><span class=line><span class=cl>Attributes:
</span></span><span class=line><span class=cl>     -&gt; user.name: Str(George Lucas)
</span></span><span class=line><span class=cl>     -&gt; user.phone_number: Str(+1555-867-5309)
</span></span><span class=line><span class=cl>     -&gt; user.email: Str(george@deathstar.email)
</span></span><span class=line><span class=cl>     -&gt; user.password: Str(LOTR&gt;StarWars1-2-3)
</span></span><span class=line><span class=cl>     -&gt; user.visa: Str(4111 1111 1111 1111)
</span></span><span class=line><span class=cl>     -&gt; user.amex: Str(3782 822463 10005)
</span></span><span class=line><span class=cl>     -&gt; user.mastercard: Str(5555 5555 5555 4444)
</span></span><span class=line><span class=cl>     -&gt; payment.amount: Double(87.01)
</span></span><span class=line><span class=cl>        {&#34;otelcol.component.id&#34;: &#34;debug&#34;, &#34;otelcol.component.kind&#34;: &#34;Exporter&#34;, &#34;otelcol.signal&#34;: &#34;traces&#34;}</span></span></code></pre></div></div></div></div></div><p><strong>Verify the Gateway has handled the spans</strong>: Once the gateway processes incoming spans, it writes the trace data to a file named <code>gateway-traces.out</code>. To confirm that the spans have been successfully handled, you can inspect this file.</p><p>In your <strong>Tests terminal</strong>, use the <code>jq</code> command to extract and display key details about each span, such as its <code>spanId</code> and its position in the file. Also, we can extract the attributes that the <strong>Hostmetrics Receiver</strong> added to the spans.</p><div class=tab-panel data-tab-group=025c7c89a183a4f0c24477435a1056e1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=inspect-the-gateway-trace-file class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("025c7c89a183a4f0c24477435a1056e1","inspect-the-gateway-trace-file")'>
<span class=tab-nav-text>Inspect the Gateway Trace File</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("025c7c89a183a4f0c24477435a1056e1","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=inspect-the-gateway-trace-file class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>jq -c <span class=s1>&#39;.resourceSpans[] as $resource | $resource.scopeSpans[].spans[] | &#34;Span \(input_line_number) found with spanId \(.spanId), hostname \($resource.resource.attributes[] | select(.key == &#34;host.name&#34;) | .value.stringValue), os \($resource.resource.attributes[] | select(.key == &#34;os.type&#34;) | .value.stringValue)&#34;&#39;</span> ./gateway-traces.out</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>&#34;Span 1 found with spanId d71fe6316276f97d, hostname workshop-instance, os linux&#34;
</span></span><span class=line><span class=cl>&#34;Span 2 found with spanId e8d19489232f8c2a, hostname workshop-instance, os linux&#34;
</span></span><span class=line><span class=cl>&#34;Span 3 found with spanId 9dfaf22857a6bd05, hostname workshop-instance, os linux&#34;
</span></span><span class=line><span class=cl>&#34;Span 4 found with spanId c7f544a4b5fef5fc, hostname workshop-instance, os linux&#34;
</span></span><span class=line><span class=cl>&#34;Span 5 found with spanId 30bb49261315969d, hostname workshop-instance, os linux&#34;</span></span></code></pre></div></div></div></div></div><details open class="box cstyle notices important"><summary class=box-label><i class="fa-fw fas fa-bolt"></i>
Important</summary><div class=box-content><p>Stop the <code>agent</code> and the <code>gateway</code> processes by pressing <code>Ctrl-C</code> in their respective terminals.</p></div></details></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 27, 2025</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=3-filelog-setup>3. FileLog Setup</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<p>The <a href=https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/receiver/filelogreceiver/README.md rel=external target=_blank><strong>FileLog Receiver</strong></a> in the OpenTelemetry Collector is used to ingest logs from files.</p><p>It monitors specified files for new log entries and streams those logs into the Collector for further processing or exporting. It is also useful for testing and development purposes.</p><p>For this part of the workshop, the <code>loadgen</code> will generate logs using random quotes:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=nx>lotrQuotes</span> <span class=o>:=</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;One does not simply walk into Mordor.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;Even the smallest person can change the course of the future.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;All we have to decide is what to do with the time that is given us.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;There is some good in this world, and it&#39;s worth fighting for.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>starWarsQuotes</span> <span class=o>:=</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;Do or do not, there is no try.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;The Force will be with you. Always.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;I find your lack of faith disturbing.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;In my experience, there is no such thing as luck.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>The <strong>FileLog receiver</strong> in the <code>agent</code> collector will read these log lines and send them to the <code>gateway</code>.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><ul><li>In the <strong>Logs terminal</strong> window, change into the <code>[WORKSHOP]</code> directory and create a new subdirectory named <code>3-filelog</code>.</li><li>Next, copy <code>*.yaml</code> from <code>2-gateway</code> into <code>3-filelog</code>.</li></ul><details open class="box cstyle notices important"><summary class=box-label><i class="fa-fw fas fa-bolt"></i>
Important</summary><div class=box-content><p><strong>Change <em>ALL</em> terminal windows to the <code>[WORKSHOP]/3-filelog</code> directory.</strong></p></div></details><p>Start the <code>loadgen</code> and this will begin writing lines to a file named <code>quotes.log</code>:</p><div class=tab-panel data-tab-group=590471485b36e753b79664770b4d2210><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=log-load-generator class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("590471485b36e753b79664770b4d2210","log-load-generator")'>
<span class=tab-nav-text>Log Load Generator</span>
</button>
<button data-tab-item=log-load-generator-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("590471485b36e753b79664770b4d2210","log-load-generator-output")'>
<span class=tab-nav-text>Log Load Generator Output</span></button></div><div class=tab-content-container><div data-tab-item=log-load-generator class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../loadgen -logs</span></span></code></pre></div></div></div><div data-tab-item=log-load-generator-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Writing logs to quotes.log. Press Ctrl+C to stop.</span></span></code></pre></div></div></div></div></div><div class=tab-panel data-tab-group=d031a015e23c3660c89552beb908f72c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=updated-directory-structure class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d031a015e23c3660c89552beb908f72c","updated-directory-structure")'>
<span class=tab-nav-text>Updated Directory Structure</span></button></div><div class=tab-content-container><div data-tab-item=updated-directory-structure class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>â”œâ”€â”€ agent.yaml
</span></span><span class=line><span class=cl>â”œâ”€â”€ gateway.yaml
</span></span><span class=line><span class=cl>â””â”€â”€ quotes.yaml</span></span></code></pre></div></div></div></div></div></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 27, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 3. FileLog Setup</h1><article class=default><header class=headline></header><h1 id=31-configuration>3.1 Configuration</h1><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p>In the <strong>Agent terminal</strong> window edit the <code>agent.yaml</code> and configure the FileLog receiver.</p><ol><li><p><strong>Configure FileLog Receiver</strong>: The <code>filelog</code> receiver reads log data from a file and includes custom resource attributes in the log data:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>filelog/quotes</span><span class=p>:</span><span class=w>                      </span><span class=c># Receiver Type/Name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>include</span><span class=p>:</span><span class=w> </span><span class=l>./quotes.log             </span><span class=w> </span><span class=c># The file to read log data from</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>include_file_path</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>            </span><span class=c># Include file path in the log data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>include_file_name</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>           </span><span class=c># Exclude file name from the log data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resource</span><span class=p>:</span><span class=w>                          </span><span class=c># Add custom resource attributes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>com.splunk.source</span><span class=p>:</span><span class=w> </span><span class=l>./quotes.log </span><span class=w> </span><span class=c># Source of the log data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>com.splunk.sourcetype</span><span class=p>:</span><span class=w> </span><span class=l>quotes   </span><span class=w> </span><span class=c># Source type of the log data</span></span></span></code></pre></div></li><li><p><strong>Update <code>logs</code> pipeline</strong>: Add the<code>filelog/quotes</code> receiver to the <code>logs</code> pipeline only:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>    </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>filelog/quotes                </span><span class=w> </span><span class=c># Filelog Receiver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlphttp</span></span></span></code></pre></div></li><li><p><strong>Validate Configuration</strong>: Paste the updated <code>agent.yaml</code> into <strong><a href=https://www.otelbin.io/ rel=external target=_blank>otelbin.io</a></strong>. For reference, the <code>logs:</code> section of your pipelines will look similar to this:</p><pre class="mermaid align-center">%%{init:{&#34;fontFamily&#34;:&#34;monospace&#34;}}%%
graph LR
    %% Nodes
      REC1(&amp;nbsp;&amp;nbsp;otlp&amp;nbsp;&amp;nbsp;&lt;br&gt;fa:fa-download):::receiver
      REC2(filelog&lt;br&gt;fa:fa-download&lt;br&gt;quotes):::receiver
      PRO1(memory_limiter&lt;br&gt;fa:fa-microchip):::processor
      PRO2(resourcedetection&lt;br&gt;fa:fa-microchip):::processor
      PRO3(resource&lt;br&gt;fa:fa-microchip&lt;br&gt;add_mode):::processor
      PRO4(batch&lt;br&gt;fa:fa-microchip):::processor
      EXP1(&amp;ensp;debug&amp;ensp;&lt;br&gt;fa:fa-upload):::exporter
      EXP2(otlphttp&lt;br&gt;fa:fa-upload):::exporter
    %% Links
    subID1:::sub-logs
    subgraph &#34; &#34;
      subgraph subID1[**Logs**]
      direction LR
      REC1 --&gt; PRO1
      REC2 --&gt; PRO1
      PRO1 --&gt; PRO2
      PRO2 --&gt; PRO3
      PRO3 --&gt; PRO4
      PRO4 --&gt; EXP1
      PRO4 --&gt; EXP2
      end
    end
classDef receiver,exporter fill:#8b5cf6,stroke:#333,stroke-width:1px,color:#fff;
classDef processor fill:#6366f1,stroke:#333,stroke-width:1px,color:#fff;
classDef con-receive,con-export fill:#45c175,stroke:#333,stroke-width:1px,color:#fff;
classDef sub-logs stroke:#34d399,stroke-width:1px, color:#34d399,stroke-dasharray: 3 3;</pre></li></ol></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 11, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=32-test-filelog-receiver>3.2 Test FileLog Receiver</h1><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p><strong>Start the Gateway</strong>: In your <strong>Gateway terminal</strong> window start the <code>gateway</code>.</p><p><strong>Start the Agent</strong>: In your <strong>Agent terminal</strong> window start the <code>agent</code>.</p><p>A continuous stream of log data from the <code>quotes.log</code> will be in the <code>agent</code> and <code>gateway</code> debug logs:</p><div class=tab-panel data-tab-group=fa279f12523b8265d20d53d40470f375><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=agentgateway-debug-output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fa279f12523b8265d20d53d40470f375","agentgateway-debug-output")'>
<span class=tab-nav-text>Agent/Gateway Debug Output</span></button></div><div class=tab-content-container><div data-tab-item=agentgateway-debug-output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Timestamp: 1970-01-01 00:00:00 +0000 UTC
</span></span><span class=line><span class=cl>SeverityText:
</span></span><span class=line><span class=cl>SeverityNumber: Unspecified(0)
</span></span><span class=line><span class=cl>Body: Str(2025-03-06 15:18:32 [ERROR] - There is some good in this world, and it&#39;s worth fighting for. LOTR)
</span></span><span class=line><span class=cl>Attributes:
</span></span><span class=line><span class=cl>     -&gt; log.file.path: Str(quotes.log)
</span></span><span class=line><span class=cl>Trace ID:
</span></span><span class=line><span class=cl>Span ID:
</span></span><span class=line><span class=cl>Flags: 0
</span></span><span class=line><span class=cl>LogRecord #1</span></span></code></pre></div></div></div></div></div><p><strong>Stop the <code>loadgen</code></strong>: In the <strong>Logs terminal</strong> window, stop the <code>loadgen</code> using <code>Ctrl-C</code>.</p><p><strong>Verify the gateway</strong>: Check if the <code>gateway</code> has written a <code>./gateway-logs.out</code> file.</p><p>At this point, your directory structure will appear as follows:</p><div class=tab-panel data-tab-group=f295f58bdb34323bdefd277406cf3c2d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=updated-directory-structure class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f295f58bdb34323bdefd277406cf3c2d","updated-directory-structure")'>
<span class=tab-nav-text>Updated Directory Structure</span></button></div><div class=tab-content-container><div data-tab-item=updated-directory-structure class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>â”œâ”€â”€ agent.out
</span></span><span class=line><span class=cl>â”œâ”€â”€ agent.yaml
</span></span><span class=line><span class=cl>â”œâ”€â”€ gateway-logs.out     # Output from the logs pipeline
</span></span><span class=line><span class=cl>â”œâ”€â”€ gateway-metrics.out  # Output from the metrics pipeline
</span></span><span class=line><span class=cl>â”œâ”€â”€ gateway-traces.out   # Output from the traces pipeline
</span></span><span class=line><span class=cl>â”œâ”€â”€ gateway.yaml
</span></span><span class=line><span class=cl>â””â”€â”€ quotes.log           # File containing Random log lines</span></span></code></pre></div></div></div></div></div><p><strong>Examine a log line</strong>: In <code>gateway-logs.out</code> compare a log line with the snippet below. Verify that the log entry includes the same attributes as we have seen in metrics and traces data previously:</p><div class=tab-panel data-tab-group=0b53a9bbaa18024b32c6203863c9397c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=cat-gateway-logsout class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0b53a9bbaa18024b32c6203863c9397c","cat-gateway-logsout")'>
<span class=tab-nav-text>cat /gateway-logs.out</span>
</button>
<button data-tab-item=cat-gateway-logsout--jq class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("0b53a9bbaa18024b32c6203863c9397c","cat-gateway-logsout--jq")'>
<span class=tab-nav-text>cat ./gateway-logs.out | jq</span></button></div><div class=tab-content-container><div data-tab-item=cat-gateway-logsout class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;resourceLogs&#34;</span><span class=p>:[{</span><span class=nt>&#34;resource&#34;</span><span class=p>:{</span><span class=nt>&#34;attributes&#34;</span><span class=p>:[{</span><span class=nt>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;com.splunk.source&#34;</span><span class=p>,</span><span class=nt>&#34;value&#34;</span><span class=p>:{</span><span class=nt>&#34;stringValue&#34;</span><span class=p>:</span><span class=s2>&#34;./quotes.log&#34;</span><span class=p>}},{</span><span class=nt>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;com.splunk.sourcetype&#34;</span><span class=p>,</span><span class=nt>&#34;value&#34;</span><span class=p>:{</span><span class=nt>&#34;stringValue&#34;</span><span class=p>:</span><span class=s2>&#34;quotes&#34;</span><span class=p>}},{</span><span class=nt>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;host.name&#34;</span><span class=p>,</span><span class=nt>&#34;value&#34;</span><span class=p>:{</span><span class=nt>&#34;stringValue&#34;</span><span class=p>:</span><span class=s2>&#34;workshop-instance&#34;</span><span class=p>}},{</span><span class=nt>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;os.type&#34;</span><span class=p>,</span><span class=nt>&#34;value&#34;</span><span class=p>:{</span><span class=nt>&#34;stringValue&#34;</span><span class=p>:</span><span class=s2>&#34;linux&#34;</span><span class=p>}},{</span><span class=nt>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;otelcol.service.mode&#34;</span><span class=p>,</span><span class=nt>&#34;value&#34;</span><span class=p>:{</span><span class=nt>&#34;stringValue&#34;</span><span class=p>:</span><span class=s2>&#34;gateway&#34;</span><span class=p>}}]},</span><span class=nt>&#34;scopeLogs&#34;</span><span class=p>:[{</span><span class=nt>&#34;scope&#34;</span><span class=p>:{},</span><span class=nt>&#34;logRecords&#34;</span><span class=p>:[{</span><span class=nt>&#34;observedTimeUnixNano&#34;</span><span class=p>:</span><span class=s2>&#34;1741274312475540000&#34;</span><span class=p>,</span><span class=nt>&#34;body&#34;</span><span class=p>:{</span><span class=nt>&#34;stringValue&#34;</span><span class=p>:</span><span class=s2>&#34;2025-03-06 15:18:32 [DEBUG] - All we have to decide is what to do with the time that is given us. LOTR&#34;</span><span class=p>},</span><span class=nt>&#34;attributes&#34;</span><span class=p>:[{</span><span class=nt>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;log.file.path&#34;</span><span class=p>,</span><span class=nt>&#34;value&#34;</span><span class=p>:{</span><span class=nt>&#34;stringValue&#34;</span><span class=p>:</span><span class=s2>&#34;quotes.log&#34;</span><span class=p>}}],</span><span class=nt>&#34;traceId&#34;</span><span class=p>:</span><span class=s2>&#34;&#34;</span><span class=p>,</span><span class=nt>&#34;spanId&#34;</span><span class=p>:</span><span class=s2>&#34;&#34;</span><span class=p>},{</span><span class=nt>&#34;observedTimeUnixNano&#34;</span><span class=p>:</span><span class=s2>&#34;1741274312475560000&#34;</span><span class=p>,</span><span class=nt>&#34;body&#34;</span><span class=p>:{</span><span class=nt>&#34;stringValue&#34;</span><span class=p>:</span><span class=s2>&#34;2025-03-06 15:18:32 [DEBUG] - Your focus determines your reality. SW&#34;</span><span class=p>},</span><span class=nt>&#34;attributes&#34;</span><span class=p>:[{</span><span class=nt>&#34;key&#34;</span><span class=p>:</span><span class=s2>&#34;log.file.path&#34;</span><span class=p>,</span><span class=nt>&#34;value&#34;</span><span class=p>:{</span><span class=nt>&#34;stringValue&#34;</span><span class=p>:</span><span class=s2>&#34;quotes.log&#34;</span><span class=p>}}],</span><span class=nt>&#34;traceId&#34;</span><span class=p>:</span><span class=s2>&#34;&#34;</span><span class=p>,</span><span class=nt>&#34;spanId&#34;</span><span class=p>:</span><span class=s2>&#34;&#34;</span><span class=p>}]}],</span><span class=nt>&#34;schemaUrl&#34;</span><span class=p>:</span><span class=s2>&#34;https://opentelemetry.io/schemas/1.6.1&#34;</span><span class=p>}]}</span></span></span></code></pre></div></div></div><div data-tab-item=cat-gateway-logsout--jq class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;resourceLogs&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;resource&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;attributes&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;com.splunk.source&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;stringValue&#34;</span><span class=p>:</span> <span class=s2>&#34;./quotes.log&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;com.splunk.sourcetype&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;stringValue&#34;</span><span class=p>:</span> <span class=s2>&#34;quotes&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;host.name&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;stringValue&#34;</span><span class=p>:</span> <span class=s2>&#34;workshop-instance&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;os.type&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;stringValue&#34;</span><span class=p>:</span> <span class=s2>&#34;linux&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;otelcol.service.mode&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;stringValue&#34;</span><span class=p>:</span> <span class=s2>&#34;gateway&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;scopeLogs&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;scope&#34;</span><span class=p>:</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;logRecords&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;observedTimeUnixNano&#34;</span><span class=p>:</span> <span class=s2>&#34;1741274312475540000&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;body&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;stringValue&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-03-06 15:18:32 [DEBUG] - All we have to decide is what to do with the time that is given us. LOTR&#34;</span>
</span></span><span class=line><span class=cl>              <span class=p>},</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;attributes&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;log.file.path&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;stringValue&#34;</span><span class=p>:</span> <span class=s2>&#34;quotes.log&#34;</span>
</span></span><span class=line><span class=cl>                  <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>              <span class=p>],</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;traceId&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;spanId&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;observedTimeUnixNano&#34;</span><span class=p>:</span> <span class=s2>&#34;1741274312475560000&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;body&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;stringValue&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-03-06 15:18:32 [DEBUG] - Your focus determines your reality. SW&#34;</span>
</span></span><span class=line><span class=cl>              <span class=p>},</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;attributes&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;log.file.path&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;stringValue&#34;</span><span class=p>:</span> <span class=s2>&#34;quotes.log&#34;</span>
</span></span><span class=line><span class=cl>                  <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>              <span class=p>],</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;traceId&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;spanId&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;schemaUrl&#34;</span><span class=p>:</span> <span class=s2>&#34;https://opentelemetry.io/schemas/1.6.1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>You may also have noticed that every log line contains empty placeholders for <code>"traceId":""</code> and <code>"spanId":""</code>.
The FileLog receiver will populate these fields only if they are not already present in the log line.
For example, if the log line is generated by an application instrumented with an OpenTelemetry instrumentation library, these fields will already be included and will not be overwritten.</p><details open class="box cstyle notices important"><summary class=box-label><i class="fa-fw fas fa-bolt"></i>
Important</summary><div class=box-content><p>Stop the <code>agent</code> and the <code>gateway</code> processes by pressing <code>Ctrl-C</code> in their respective terminals.</p></div></details></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 12, 2025</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=4-building-in-resilience>4. Building In Resilience</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<p>The OpenTelemetry Collectorâ€™s <a href=https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/19bc7d6ee854c0c1b5c97d8d348e5b9d1199e8aa/extension/storage/filestorage/README.md rel=external target=_blank><strong>FileStorage Extension</strong></a> enhances the resilience of your telemetry pipeline by providing reliable checkpointing, managing retries, and handling temporary failures effectively.</p><p>With this extension enabled, the OpenTelemetry Collector can store intermediate states on disk, preventing data loss during network disruptions and allowing it to resume operations seamlessly.</p><details open class="box cstyle notices note"><summary class=box-label><i class="fa-fw fas fa-exclamation-circle"></i>
Note</summary><div class=box-content><p>This solution will work for metrics as long as the connection downtime is briefâ€”up to 15 minutes. If the downtime exceeds this, Splunk Observability Cloud will drop data due to datapoints being out of order.</p><p>For logs, there are plans to implement a more enterprise-ready solution in one of the upcoming Splunk OpenTelemetry Collector releases.</p></div></details><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><ul><li>Inside the <code>[WORKSHOP]</code> directory, create a new subdirectory named <code>4-resilience</code>.</li><li>Next, copy <code>*.yaml</code> from the <code>3-filelog</code> directory into <code>4-resilience</code>.</li></ul><details open class="box cstyle notices important"><summary class=box-label><i class="fa-fw fas fa-bolt"></i>
Important</summary><div class=box-content><p><strong>Change <em>ALL</em> terminal windows to the <code>[WORKSHOP]/4-resilience</code> directory.</strong></p></div></details><p>Your updated directory structure will now look like this:</p><div class=tab-panel data-tab-group=41fd92bc260fd553c9e9ecf023456060><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=updated-directory-structure class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("41fd92bc260fd553c9e9ecf023456060","updated-directory-structure")'>
<span class=tab-nav-text>Updated Directory Structure</span></button></div><div class=tab-content-container><div data-tab-item=updated-directory-structure class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>â”œâ”€â”€ agent.yaml
</span></span><span class=line><span class=cl>â””â”€â”€ gateway.yaml</span></span></code></pre></div></div></div></div></div></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 12, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 4. Building Resilience</h1><article class=default><header class=headline></header><h1 id=41-file-storage-configuration>4.1 File Storage Configuration</h1><p>In this exercise, we will update the <code>extensions:</code> section of the <code>agent.yaml</code> file. This section is part of the OpenTelemetry configuration YAML and defines optional components that enhance or modify the OpenTelemetry Collectorâ€™s behavior.</p><p>While these components do not process telemetry data directly, they provide valuable capabilities and services to improve the Collectorâ€™s functionality.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p><strong>Update the <code>agent.yaml</code></strong>: In the <strong>Agent terminal</strong> window, add the <code>file_storage</code> extension and name it <code>checkpoint</code>:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>file_storage/checkpoint</span><span class=p>:</span><span class=w>             </span><span class=c># Extension Type/Name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>directory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;./checkpoint-dir&#34;</span><span class=w>      </span><span class=c># Define directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>create_directory</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>             </span><span class=c># Create directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=l>1s                       </span><span class=w> </span><span class=c># Timeout for file operations</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>compaction</span><span class=p>:</span><span class=w>                        </span><span class=c># Compaction settings</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>on_start</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>                   </span><span class=c># Start compaction at Collector startup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Define compaction directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>directory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;./checkpoint-dir/tmp&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>max_transaction_size</span><span class=p>:</span><span class=w> </span><span class=m>65536</span><span class=w>      </span><span class=c># Max. size limit before compaction occurs</span></span></span></code></pre></div><p><strong>Add <code>file_storage</code> to existing <code>otlphttp</code> exporter</strong>: Modify the <code>otlphttp:</code> exporter to configure retry and queuing mechanisms, ensuring data is retained and resent if failures occur:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>otlphttp</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;http://localhost:5318&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>retry_on_failure</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>                    </span><span class=c># Enable retry on failure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>sending_queue</span><span class=p>:</span><span class=w>                     </span><span class=c># </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>                    </span><span class=c># Enable sending queue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>num_consumers</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>                </span><span class=c># No. of consumers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>queue_size</span><span class=p>:</span><span class=w> </span><span class=m>10000</span><span class=w>                </span><span class=c># Max. queue size</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>file_storage/checkpoint</span><span class=w> </span><span class=c># File storage extension</span></span></span></code></pre></div><p><strong>Update the <code>services</code> section</strong>: Add the <code>file_storage/checkpoint</code> extension to the existing <code>extensions:</code> section. This will cause the extension to be enabled:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>health_check</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>file_storage/checkpoint           </span><span class=w> </span><span class=c># Enabled extensions for this collector</span></span></span></code></pre></div><p><strong>Update the <code>metrics</code> pipeline</strong>: For this exercise we are going to remove the <code>hostmetrics</code> receiver from the Metric pipeline to reduce debug and log noise:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># - hostmetrics                  # Hostmetrics Receiver</span></span></span></code></pre></div></div></details><p>Validate the <code>agent</code> configuration using <strong><a href=https://www.otelbin.io/ rel=external target=_blank>otelbin.io</a></strong>. For reference, the <code>metrics:</code> section of your pipelines will look similar to this:</p><pre class="mermaid align-center">%%{init:{&#34;fontFamily&#34;:&#34;monospace&#34;}}%%
graph LR
    %% Nodes
      REC1(&amp;nbsp;&amp;nbsp;otlp&amp;nbsp;&amp;nbsp;&lt;br&gt;fa:fa-download):::receiver
      PRO1(memory_limiter&lt;br&gt;fa:fa-microchip):::processor
      PRO2(resourcedetection&lt;br&gt;fa:fa-microchip):::processor
      PRO3(resource&lt;br&gt;fa:fa-microchip&lt;br&gt;add_mode):::processor
      PRO4(batch&lt;br&gt;fa:fa-microchip):::processor
      EXP1(&amp;ensp;debug&amp;ensp;&lt;br&gt;fa:fa-upload):::exporter
      EXP2(otlphttp&lt;br&gt;fa:fa-upload):::exporter
    %% Links
    subID1:::sub-metrics
    subgraph &#34; &#34;
      subgraph subID1[**Metrics**]
      direction LR
      REC1 --&gt; PRO1
      PRO1 --&gt; PRO2
      PRO2 --&gt; PRO3
      PRO3 --&gt; PRO4
      PRO4 --&gt; EXP1
      PRO4 --&gt; EXP2
      end
    end
classDef receiver,exporter fill:#8b5cf6,stroke:#333,stroke-width:1px,color:#fff;
classDef processor fill:#6366f1,stroke:#333,stroke-width:1px,color:#fff;
classDef con-receive,con-export fill:#45c175,stroke:#333,stroke-width:1px,color:#fff;
classDef sub-metrics stroke:#38bdf8,stroke-width:1px, color:#38bdf8,stroke-dasharray: 3 3;</pre><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 7, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=42-setup-environment-for-resilience-testing>4.2 Setup environment for Resilience Testing</h1><p>Next, we will configure our environment to be ready for testing the <strong>File Storage</strong> configuration.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p><strong>Start the Gateway</strong>: In the <strong>Gateway terminal</strong> window navigate to the <code>[WORKSHOP]/4-resilience</code> directory and run:</p><div class=tab-panel data-tab-group=01aa67f3e9b0a5ce54798bae24f7e03c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=start-the-gateway class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("01aa67f3e9b0a5ce54798bae24f7e03c","start-the-gateway")'>
<span class=tab-nav-text>Start the Gateway</span></button></div><div class=tab-content-container><div data-tab-item=start-the-gateway class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../otelcol --config<span class=o>=</span>gateway.yaml</span></span></code></pre></div></div></div></div></div><p><strong>Start the Agent</strong>: In the <strong>Agent terminal</strong> window navigate to the <code>[WORKSHOP]/4-resilience</code> directory and run:</p><div class=tab-panel data-tab-group=4f05733dc42ce7a6d4842653523a962a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=start-the-agent class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4f05733dc42ce7a6d4842653523a962a","start-the-agent")'>
<span class=tab-nav-text>Start the Agent</span></button></div><div class=tab-content-container><div data-tab-item=start-the-agent class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../otelcol --config<span class=o>=</span>agent.yaml</span></span></code></pre></div></div></div></div></div><p><strong>Send five test spans</strong>: In the <strong>Spans terminal</strong> window navigate to the <code>[WORKSHOP]/4-resilience</code> directory and run:</p><div class=tab-panel data-tab-group=adbd68054f1522911d1ae52c77870e84><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=start-load-generator class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("adbd68054f1522911d1ae52c77870e84","start-load-generator")'>
<span class=tab-nav-text>Start Load Generator</span></button></div><div class=tab-content-container><div data-tab-item=start-load-generator class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../loadgen -count <span class=m>5</span></span></span></code></pre></div></div></div></div></div><p>Both the <code>agent</code> and <code>gateway</code> should display debug logs, and the <code>gateway</code> should create a <code>./gateway-traces.out</code> file.</p></div></details><p>If everything functions correctly, we can proceed with testing system resilience.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 6, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=43-simulate-failure>4.3 Simulate Failure</h1><p>To assess the <strong>Agent&rsquo;s</strong> resilience, we&rsquo;ll simulate a temporary <code>gateway</code> outage and observe how the <code>agent</code> handles it:</p><p><strong>Summary</strong>:</p><ol><li><strong>Send Traces to the Agent</strong> â€“ Generate traffic by sending traces to the <code>agent</code>.</li><li><strong>Stop the Gateway</strong> â€“ This will trigger the <code>agent</code> to enter retry mode.</li><li><strong>Restart the Gateway</strong> â€“ The <code>agent</code> will recover traces from its persistent queue and forward them successfully. Without the persistent queue, these traces would have been lost permanently.</li></ol><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p><strong>Simulate a network failure</strong>: In the <strong>Gateway terminal</strong> stop the <code>gateway</code> with <code>Ctrl-C</code> and wait until the gateway console shows that it has stopped:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>2025-01-28T13:24:32.785+0100  info  service@v0.120.0/service.go:309  Shutdown complete.</span></span></code></pre></div><p><strong>Send traces</strong>: In the <strong>Spans terminal</strong> window send five more traces using the <code>loadgen</code>.</p><p>Notice that the agentâ€™s retry mechanism is activated as it continuously attempts to resend the data. In the agentâ€™s console output, you will see repeated messages similar to the following:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>2025-01-28T14:22:47.020+0100  info  internal/retry_sender.go:126  Exporting failed. Will retry the request after interval.  {&#34;kind&#34;: &#34;exporter&#34;, &#34;data_type&#34;: &#34;traces&#34;, &#34;name&#34;: &#34;otlphttp&#34;, &#34;error&#34;: &#34;failed to make an HTTP request: Post \&#34;http://localhost:5318/v1/traces\&#34;: dial tcp 127.0.0.1:5318: connect: connection refused&#34;, &#34;interval&#34;: &#34;9.471474933s&#34;}</span></span></code></pre></div><p><strong>Stop the Agent</strong>: In the <strong>Agent terminal</strong> window, use <code>Ctrl-C</code> to stop the agent. Wait until the agentâ€™s console confirms it has stopped:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>2025-01-28T14:40:28.702+0100  info  extensions/extensions.go:66  Stopping extensions...
</span></span><span class=line><span class=cl>2025-01-28T14:40:28.702+0100  info  service@v0.120.0/service.go:309  Shutdown complete.</span></span></code></pre></div></div></details><details open class="box cstyle notices primary"><summary class=box-label><i class="fa-fw fas fa-lightbulb"></i>
Tip</summary><div class=box-content><p>Stopping the agent will halt its retry attempts and prevent any future retry activity.</p><p>If the agent runs for too long without successfully delivering data, it may begin dropping traces, depending on the retry configuration, to conserve memory. By stopping the agent, any metrics, traces, or logs currently stored in memory are lost before being dropped, ensuring they remain available for recovery.</p><p>This step is essential for clearly observing the recovery process when the agent is restarted.</p></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 7, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=44-recovery>4.4 Recovery</h1><p>In this exercise, weâ€™ll test how the <strong>OpenTelemetry Collector</strong> recovers from a network outage by restarting the <strong>Gateway</strong> collector. When the <code>gateway</code> becomes available again, the <code>agent</code> will resume sending data from its last checkpointed state, ensuring no data loss.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p><strong>Restart the Gateway</strong>: In the <strong>Gateway terminal</strong> window run:</p><div class=tab-panel data-tab-group=30f81ede701b7395800a560cd17f53bd><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=gateway class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("30f81ede701b7395800a560cd17f53bd","gateway")'>
<span class=tab-nav-text>Gateway</span></button></div><div class=tab-content-container><div data-tab-item=gateway class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../otelcol --config<span class=o>=</span>gateway.yaml</span></span></code></pre></div></div></div></div></div><p><strong>Restart the Agent</strong>: In the <strong>Agent terminal</strong> window run:</p><div class=tab-panel data-tab-group=4eae85d3cc0db4692343fbd45fff1c17><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=start-the-agent class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4eae85d3cc0db4692343fbd45fff1c17","start-the-agent")'>
<span class=tab-nav-text>Start the Agent</span></button></div><div class=tab-content-container><div data-tab-item=start-the-agent class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../otelcol --config<span class=o>=</span>agent.yaml</span></span></code></pre></div></div></div></div></div></div></details><p>After the <code>agent</code> is up and running, the <strong>File_Storage</strong> extension will detect buffered data in the checkpoint folder.<br>It will start to dequeue the stored spans from the last checkpoint folder, ensuring no data is lost.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p><strong>Verify the Agent Debug output</strong><br>Note that the Agent Debug Screen does <strong>NOT</strong> change and still shows the following line indicating no new data is being exported.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>2025-02-07T13:40:12.195+0100    info    service@v0.120.0/service.go:253 Everything is ready. Begin running and processing data.</span></span></code></pre></div><p><strong>Watch the Gateway Debug output</strong><br>You should see from the <code>gateway</code> debug screen, it has started receiving the previously missed traces without requiring any additional action on your part.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>2025-02-07T12:44:32.651+0100    info    service@v0.120.0/service.go:253 Everything is ready. Begin running and processing data.
</span></span><span class=line><span class=cl>2025-02-07T12:47:46.721+0100    info    Traces  {&#34;kind&#34;: &#34;exporter&#34;, &#34;data_type&#34;: &#34;traces&#34;, &#34;name&#34;: &#34;debug&#34;, &#34;resource spans&#34;: 4, &#34;spans&#34;: 4}
</span></span><span class=line><span class=cl>2025-02-07T12:47:46.721+0100    info    ResourceSpans #0
</span></span><span class=line><span class=cl>Resource SchemaURL: https://opentelemetry.io/schemas/1.6.1
</span></span><span class=line><span class=cl>Resource attributes:</span></span></code></pre></div><p><strong>Check the <code>gateway-traces.out</code> file</strong><br>Using <code>jq</code>, count the number of traces in the recreated <code>gateway-traces.out</code>. It should match the number you send when the <code>gateway</code> was down.</p><div class=tab-panel data-tab-group=67794f06c7c81eda3a245fe375b1218f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=check-gateway-traces-out-file class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("67794f06c7c81eda3a245fe375b1218f","check-gateway-traces-out-file")'>
<span class=tab-nav-text>Check Gateway Traces Out File</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("67794f06c7c81eda3a245fe375b1218f","example-output")'>
<span class=tab-nav-text>Example output</span></button></div><div class=tab-content-container><div data-tab-item=check-gateway-traces-out-file class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>jq <span class=s1>&#39;.resourceSpans | length | &#34;\(.) resourceSpans found&#34;&#39;</span> gateway-traces.out</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>&#34;5 resourceSpans found&#34;</span></span></code></pre></div></div></div></div></div><details open class="box cstyle notices important"><summary class=box-label><i class="fa-fw fas fa-bolt"></i>
Important</summary><div class=box-content><p>Stop the <code>agent</code> and the <code>gateway</code> processes by pressing <code>Ctrl-C</code> in their respective terminals.</p></div></details></div></details><h3 id=conclusion>Conclusion</h3><p>This exercise demonstrated how to enhance the resilience of the OpenTelemetry Collector by configuring the <code>file_storage</code> extension, enabling retry mechanisms for the <code>otlp</code> exporter, and using a file-backed queue for temporary data storage.</p><p>By implementing file-based checkpointing and queue persistence, you ensure the telemetry pipeline can gracefully recover from temporary interruptions, making it a more robust and reliable for production environments.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 27, 2025</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=5-dropping-spans>5. Dropping Spans</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<p>In this section, we will explore how to use the <a href=https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/processor/filterprocessor/README.md rel=external target=_blank><strong>Filter Processor</strong></a> to selectively drop spans based on certain conditions.</p><p>Specifically, we will drop traces based on the span name, which is commonly used to filter out unwanted spans such as health checks or internal communication traces. In this case, we will be filtering out spans whose name is <code>"/_healthz"</code>, typically associated with health check requests and usually are quite &ldquo;<strong>noisy</strong>&rdquo;.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><ul><li>Inside the <code>[WORKSHOP]</code> directory, create a new subdirectory named <code>5-dropping-spans</code>.</li><li>Next, copy <code>*.yaml</code> from the <code>4-resilience</code> directory into <code>5-dropping-spans</code>.</li></ul><details open class="box cstyle notices important"><summary class=box-label><i class="fa-fw fas fa-bolt"></i>
Important</summary><div class=box-content><p><strong>Change <em>ALL</em> terminal windows to the <code>[WORKSHOP]/5-dropping-spans</code> directory.</strong></p></div></details><p>Your updated directory structure will now look like this:</p><div class=tab-panel data-tab-group=a73072a6a7627a909c81f9be53d901c4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=updated-directory-structure class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a73072a6a7627a909c81f9be53d901c4","updated-directory-structure")'>
<span class=tab-nav-text>Updated Directory Structure</span></button></div><div class=tab-content-container><div data-tab-item=updated-directory-structure class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>â”œâ”€â”€ agent.yaml
</span></span><span class=line><span class=cl>â””â”€â”€ gateway.yaml</span></span></code></pre></div></div></div></div></div></div></details><p>Next, we will configure the <strong>filter processor</strong> and the respective pipelines.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 12, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 5. Dropping Spans</h1><article class=default><header class=headline></header><h1 id=51-configuration>5.1 Configuration</h1><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p>Switch to your <strong>Gateway terminal</strong> window and open the <code>gateway.yaml</code> file. Update the <code>processors</code> section with the following configuration:</p><ol><li><p><strong>Add a <code>filter</code> processor</strong>:<br>Configure the gateway to exclude spans with the name <code>/_healthz</code>. The <code>error_mode: ignore</code> directive ensures that any errors encountered during filtering are ignored, allowing the pipeline to continue running smoothly. The <code>traces</code> section defines the filtering rules, specifically targeting spans named <code>/_healthz</code> for exclusion.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>filter/health</span><span class=p>:</span><span class=w>                       </span><span class=c># Defines a filter processor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>error_mode</span><span class=p>:</span><span class=w> </span><span class=l>ignore                </span><span class=w> </span><span class=c># Ignore errors</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>traces</span><span class=p>:</span><span class=w>                            </span><span class=c># Filtering rules for traces</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>span</span><span class=p>:</span><span class=w>                            </span><span class=c># Exclude spans named &#34;/_healthz&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;name == &#34;/_healthz&#34;&#39;</span></span></span></code></pre></div></li><li><p><strong>Add the <code>filter</code> processor to the <code>traces</code> pipeline</strong>:<br>Include the <code>filter/health</code> processor in the <code>traces</code> pipeline. For optimal performance, place the filter as early as possibleâ€”right after the <code>memory_limiter</code> and before the <code>batch</code> processor. Hereâ€™s how the configuration should look:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>otlp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>filter/health            </span><span class=w> </span><span class=c># Filters data based on rules</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>resource/add_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>file/traces</span></span></span></code></pre></div></li></ol><p>This setup ensures that health check-related spans (<code>/_healthz</code>) are filtered out early in the pipeline, reducing unnecessary noise in your telemetry data.</p></div></details><p>Validate the agent configuration using <strong><a href=https://www.otelbin.io/ rel=external target=_blank>otelbin.io</a></strong>. For reference, the <code>traces:</code> section of your pipelines will look similar to this:</p><pre class="mermaid align-center">%%{init:{&#34;fontFamily&#34;:&#34;monospace&#34;}}%%
graph LR
    %% Nodes
      REC1(&amp;nbsp;&amp;nbsp;otlp&amp;nbsp;&amp;nbsp;&lt;br&gt;fa:fa-download):::receiver
      PRO1(memory_limiter&lt;br&gt;fa:fa-microchip):::processor
      PRO3(resource&lt;br&gt;fa:fa-microchip&lt;br&gt;add_mode):::processor
      PRO4(filter&lt;br&gt;fa:fa-microchip&lt;br&gt;health):::processor
      PRO5(batch&lt;br&gt;fa:fa-microchip):::processor
      EXP1(&amp;ensp;debug&amp;ensp;&lt;br&gt;fa:fa-upload):::exporter
      EXP2(&amp;ensp;&amp;ensp;file&amp;ensp;&amp;ensp;&lt;br&gt;fa:fa-upload&lt;br&gt;traces):::exporter
    %% Links
    subID1:::sub-traces
    subgraph &#34; &#34;
      subgraph subID1[**Traces**]
      direction LR
      REC1 --&gt; PRO1
      PRO1 --&gt; PRO4
      PRO4 --&gt; PRO3
      PRO3 --&gt; PRO5
      PRO5 --&gt; EXP1
      PRO5 --&gt; EXP2
      end
    end
classDef receiver,exporter fill:#8b5cf6,stroke:#333,stroke-width:1px,color:#fff;
classDef processor fill:#6366f1,stroke:#333,stroke-width:1px,color:#fff;
classDef con-receive,con-export fill:#45c175,stroke:#333,stroke-width:1px,color:#fff;
classDef sub-traces stroke:#fbbf24,stroke-width:1px, color:#fbbf24,stroke-dasharray: 3 3;</pre><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 17, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=52-test-filter-processor>5.2 Test Filter Processor</h1><p>To test your configuration, you&rsquo;ll need to generate some trace data that includes a span named <code>"/_healthz"</code>.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p><strong>Start the Gateway</strong>: In your <strong>Gateway terminal</strong> window start the <code>gateway</code>.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../otelcol --config ./gateway.yaml</span></span></code></pre></div><p><strong>Start the Agent</strong>: In your <strong>Agent terminal</strong> window start the <code>agent</code>.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../otelcol --config ./agent.yaml</span></span></code></pre></div><p><strong>Start the Loadgen</strong>: In the <strong>Spans terminal</strong> window run the <code>loadgen</code> with the flag to also send <code>healthz</code> spans along with base spans:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../loadgen -health -count <span class=m>5</span></span></span></code></pre></div><p><strong>Verify <code>agent.out</code></strong>: Using <code>jq</code> confirm the name of the spans received by the <code>agent</code>:</p><div class=tab-panel data-tab-group=038390c3997ddcaccdf4fbce21245552><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=check-spans-in-agentout class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("038390c3997ddcaccdf4fbce21245552","check-spans-in-agentout")'>
<span class=tab-nav-text>Check spans in agent.out</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("038390c3997ddcaccdf4fbce21245552","example-output")'>
<span class=tab-nav-text>Example output</span></button></div><div class=tab-content-container><div data-tab-item=check-spans-in-agentout class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>jq -c <span class=s1>&#39;.resourceSpans[].scopeSpans[].spans[] | &#34;Span \(input_line_number) found with name \(.name)&#34;&#39;</span> ./agent.out</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>&#34;Span 1 found with name /movie-validator&#34;
</span></span><span class=line><span class=cl>&#34;Span 2 found with name /_healthz&#34;
</span></span><span class=line><span class=cl>&#34;Span 3 found with name /movie-validator&#34;
</span></span><span class=line><span class=cl>&#34;Span 4 found with name /_healthz&#34;
</span></span><span class=line><span class=cl>&#34;Span 5 found with name /movie-validator&#34;
</span></span><span class=line><span class=cl>&#34;Span 6 found with name /_healthz&#34;
</span></span><span class=line><span class=cl>&#34;Span 7 found with name /movie-validator&#34;
</span></span><span class=line><span class=cl>&#34;Span 8 found with name /_healthz&#34;
</span></span><span class=line><span class=cl>&#34;Span 9 found with name /movie-validator&#34;
</span></span><span class=line><span class=cl>&#34;Span 10 found with name /_healthz&#34;</span></span></code></pre></div></div></div></div></div><p><strong>Check the Gateway Debug output</strong>: Using <code>jq</code> confirm the name of the spans received by the <code>gateway</code>:</p><div class=tab-panel data-tab-group=0e79b8613954b9e85d3026098eba4811><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=check-spans-in-gateway-tracesout class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0e79b8613954b9e85d3026098eba4811","check-spans-in-gateway-tracesout")'>
<span class=tab-nav-text>Check spans in gateway-traces.out</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("0e79b8613954b9e85d3026098eba4811","example-output")'>
<span class=tab-nav-text>Example output</span></button></div><div class=tab-content-container><div data-tab-item=check-spans-in-gateway-tracesout class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=tab-panel data-tab-group=317ebf7a48390fa0d9212640d50bd482><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=check-spans-in-gateway-tracesout class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("317ebf7a48390fa0d9212640d50bd482","check-spans-in-gateway-tracesout")'>
<span class=tab-nav-text>Check spans in gateway-traces.out</span></button></div><div class=tab-content-container><div data-tab-item=check-spans-in-gateway-tracesout class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>jq -c <span class=s1>&#39;.resourceSpans[].scopeSpans[].spans[] | &#34;Span \(input_line_number) found with name \(.name)&#34;&#39;</span> ./gateway-traces.out</span></span></code></pre></div></div></div></div></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><p>The <code>gateway-metrics.out</code> file will not contain any spans named <code>/_healthz</code>.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>&#34;Span 1 found with name /movie-validator&#34;
</span></span><span class=line><span class=cl>&#34;Span 2 found with name /movie-validator&#34;
</span></span><span class=line><span class=cl>&#34;Span 3 found with name /movie-validator&#34;
</span></span><span class=line><span class=cl>&#34;Span 4 found with name /movie-validator&#34;
</span></span><span class=line><span class=cl>&#34;Span 5 found with name /movie-validator&#34;</span></span></code></pre></div></div></div></div></div></div></details><details open class="box cstyle notices primary"><summary class=box-label><i class="fa-fw fas fa-lightbulb"></i>
Tip</summary><div class=box-content><p>When using the <code>Filter</code> processor, make sure you understand the look of your incoming data and test the configuration thoroughly. In general, use <strong>as specific a configuration as possible</strong> to lower the risk of the wrong data being dropped.</p><p>You can further extend this configuration to filter out spans based on different attributes, tags, or other criteria, making the OpenTelemetry Collector more customizable and efficient for your observability needs.</p><details open class="box cstyle notices important"><summary class=box-label><i class="fa-fw fas fa-bolt"></i>
Important</summary><div class=box-content><p>Stop the <code>agent</code> and the <code>gateway</code> processes by pressing <code>Ctrl-C</code> in their respective terminals.</p></div></details></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 27, 2025</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=6-redacting-sensitive-data>6. Redacting Sensitive Data</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<p>In this section, you&rsquo;ll learn how to configure the OpenTelemetry Collector to remove specific tags and redact sensitive data from telemetry spans. This is crucial for protecting sensitive information such as credit card numbers, personal data, or other security-related details that must be anonymized before being processed or exported.</p><p>We&rsquo;ll walk through configuring key processors in the OpenTelemetry Collector, including:</p><ul><li><strong><a href=https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/processor/attributesprocessor/README.md rel=external target=_blank>Attributes Processor</a></strong>: Modifies or removes specific span attributes.</li><li><a href=https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/processor/redactionprocessor/README.md rel=external target=_blank><strong>Redaction Processor</strong></a>: Ensures sensitive data is sanitized before being stored or transmitted.</li></ul><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><ul><li>Inside the <code>[WORKSHOP]</code> directory, create a new subdirectory named <code>6-sensitive-data</code>.</li><li>Next, copy <code>*.yaml</code> from the <code>5-dropping-spans</code> directory into <code>6-sensitive-data</code>.</li></ul><details open class="box cstyle notices important"><summary class=box-label><i class="fa-fw fas fa-bolt"></i>
Important</summary><div class=box-content><p><strong>Change <em>ALL</em> terminal windows to the <code>[WORKSHOP]/6-sensitive-data</code> directory.</strong></p></div></details><p>Your updated directory structure will now look like this:</p><div class=tab-panel data-tab-group=224e333faf1f775a12a4010666d7e0e7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=updated-directory-structure class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("224e333faf1f775a12a4010666d7e0e7","updated-directory-structure")'>
<span class=tab-nav-text>Updated Directory Structure</span></button></div><div class=tab-content-container><div data-tab-item=updated-directory-structure class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>â”œâ”€â”€ agent.yaml
</span></span><span class=line><span class=cl>â””â”€â”€ gateway.yaml</span></span></code></pre></div></div></div></div></div></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 12, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 6. Sensitive Data</h1><article class=default><header class=headline></header><h1 id=61-configuration>6.1 Configuration</h1><p>In this step, we&rsquo;ll modify <code>agent.yaml</code> to include the <code>attributes</code> and <code>redaction</code> processors. These processors will help ensure that sensitive data within span attributes is properly handled before being logged or exported.</p><p>Previously, you may have noticed that some span attributes displayed in the console contained personal and sensitive data. We&rsquo;ll now configure the necessary processors to filter out and redact this information effectively.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>&lt;snip&gt;
</span></span><span class=line><span class=cl>Attributes:
</span></span><span class=line><span class=cl>     -&gt; user.name: Str(George Lucas)
</span></span><span class=line><span class=cl>     -&gt; user.phone_number: Str(+1555-867-5309)
</span></span><span class=line><span class=cl>     -&gt; user.email: Str(george@deathstar.email)
</span></span><span class=line><span class=cl>     -&gt; user.account_password: Str(LOTR&gt;StarWars1-2-3)
</span></span><span class=line><span class=cl>     -&gt; user.visa: Str(4111 1111 1111 1111)
</span></span><span class=line><span class=cl>     -&gt; user.amex: Str(3782 822463 10005)
</span></span><span class=line><span class=cl>     -&gt; user.mastercard: Str(5555 5555 5555 4444)
</span></span><span class=line><span class=cl>  {&#34;kind&#34;: &#34;exporter&#34;, &#34;data_type&#34;: &#34;traces&#34;, &#34;name&#34;: &#34;debug&#34;}</span></span></code></pre></div><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p>Switch to your <strong>Agent terminal</strong> window and open the <code>agent.yaml</code> file in your editor. Weâ€™ll add two processors to enhance the security and privacy of your telemetry data: the Attributes Processor and the Redaction Processor.</p><p><strong>Add an <code>attributes</code> Processor</strong>: The <a href=https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/attributesprocessor rel=external target=_blank><strong>Attributes Processor</strong></a> allows you to modify span attributes (tags) by updating, deleting, or hashing their values. This is particularly useful for obfuscating sensitive information before it is exported.</p><p>In this step, weâ€™ll:</p><ol><li><strong>Update</strong> the <code>user.phone_number</code> attribute to a static value <code>("UNKNOWN NUMBER")</code>.</li><li><strong>Hash</strong> the <code>user.email</code> attribute to ensure the original email is not exposed.</li><li><strong>Delete</strong> the <code>user.password</code> attribute to remove it entirely from the span.</li></ol><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>attributes/update</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>actions</span><span class=p>:</span><span class=w>                           </span><span class=c># Actions</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>user.phone_number        </span><span class=w> </span><span class=c># Target key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>update                </span><span class=w> </span><span class=c># Update action</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;UNKNOWN NUMBER&#34;</span><span class=w>        </span><span class=c># New value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>user.email               </span><span class=w> </span><span class=c># Target key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>hash                  </span><span class=w> </span><span class=c># Hash the email value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>user.password            </span><span class=w> </span><span class=c># Target key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>delete                </span><span class=w> </span><span class=c># Delete the password</span></span></span></code></pre></div><p><strong>Add a <code>redaction</code> Processor</strong>: The <a href=https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/redactionprocessor rel=external target=_blank><strong>The Redaction Processor</strong></a> detects and redacts sensitive data in span attributes based on predefined patterns, such as credit card numbers or other personally identifiable information (PII).</p><p>In this step:</p><ul><li><p>We set <code>allow_all_keys: true</code> to ensure all attributes are processed (if set to <code>false</code>, only explicitly allowed keys are retained).</p></li><li><p>We define <code>blocked_values</code> with regular expressions to detect and redact <strong>Visa</strong> and <strong>MasterCard</strong> credit card numbers.</p></li><li><p>The <code>summary: debug</code> option logs detailed information about the redaction process for debugging purposes.</p></li></ul><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>redaction/redact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>allow_all_keys</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>               </span><span class=c># If false, only allowed keys will be retained</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>blocked_values</span><span class=p>:</span><span class=w>                    </span><span class=c># List of regex patterns to block</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;\b4[0-9]{3}[\s-]?[0-9]{4}[\s-]?[0-9]{4}[\s-]?[0-9]{4}\b&#39;</span><span class=w>       </span><span class=c># Visa</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;\b5[1-5][0-9]{2}[\s-]?[0-9]{4}[\s-]?[0-9]{4}[\s-]?[0-9]{4}\b&#39;</span><span class=w>  </span><span class=c># MasterCard</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>summary</span><span class=p>:</span><span class=w> </span><span class=l>debug                    </span><span class=w> </span><span class=c># Show debug details about redaction</span></span></span></code></pre></div><p><strong>Update the <code>traces</code> Pipeline</strong>: Integrate both processors into the <code>traces</code> pipeline. Make sure that you comment out the redaction processor at first (we will enable it later in a separate exercise):</p><details open class="box cstyle notices note"><summary class=box-label><i class="fa-fw fas fa-exclamation-circle"></i>
Note</summary><div class=box-content><p>Leave the <code>redaction/redact</code> processor commented out in this exercise. We will enable it in an upcoming exercise.</p></div></details><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>attributes/update             </span><span class=w> </span><span class=c># Update, hash, and remove attributes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#- redaction/redact               # Redact sensitive fields using regex</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlphttp</span></span></span></code></pre></div></div></details><p>Validate the agent configuration using <strong><a href=https://www.otelbin.io/ rel=external target=_blank>otelbin.io</a></strong>. For reference, the <code>traces:</code> section of your pipelines will look similar to this:</p><pre class="mermaid align-center">%%{init:{&#34;fontFamily&#34;:&#34;monospace&#34;}}%%
graph LR
    %% Nodes
      REC1(&amp;nbsp;&amp;nbsp;otlp&amp;nbsp;&amp;nbsp;&lt;br&gt;fa:fa-download):::receiver
      PRML(memory_limiter&lt;br&gt;fa:fa-microchip):::processor
      PRRD(resourcedetection&lt;br&gt;fa:fa-microchip):::processor
      PRRS(resource&lt;br&gt;fa:fa-microchip&lt;br&gt;add_mode):::processor
      PRBA(batch&lt;br&gt;fa:fa-microchip):::processor
      PRUP(attributes&lt;br&gt;fa:fa-microchip&lt;br&gt;update):::processor
      EXP1(otlphttp&lt;br&gt;fa:fa-upload):::exporter
      EXP2(&amp;ensp;&amp;ensp;debug&amp;ensp;&amp;ensp;&lt;br&gt;fa:fa-upload):::exporter
      EXP3(file&lt;br&gt;fa:fa-upload):::exporter

    %% Links
    subID1:::sub-traces
    subgraph &#34; &#34;
      subgraph subID1[**Traces**]
      direction LR
      REC1 --&gt; PRML
      PRML --&gt; PRUP
      PRUP --&gt; PRRD
      PRRD --&gt; PRRS
      PRRS --&gt; PRBA
      PRBA --&gt; EXP2
      PRBA --&gt; EXP3
      PRBA --&gt; EXP1
      end
    end
classDef receiver,exporter fill:#8b5cf6,stroke:#333,stroke-width:1px,color:#fff;
classDef processor fill:#6366f1,stroke:#333,stroke-width:1px,color:#fff;
classDef con-receive,con-export fill:#45c175,stroke:#333,stroke-width:1px,color:#fff;
classDef sub-traces stroke:#fbbf24,stroke-width:1px, color:#fbbf24,stroke-dasharray: 3 3;</pre><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 27, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=62-test-attribute-processor>6.2 Test Attribute Processor</h1><p>In this exercise, we will <strong>delete</strong> the <code>user.account_password</code>, <strong>update</strong> the <code>user.phone_number</code> <strong>attribute</strong> and <strong>hash</strong> the <code>user.email</code> in the span data before it is exported by the <code>agent</code>.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p><strong>Start the Gateway</strong>: In your <strong>Gateway terminal</strong> window start the <code>gateway</code>.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../otelcol --config<span class=o>=</span>gateway.yaml</span></span></code></pre></div><p><strong>Start the Agent</strong>: In your <strong>Agent terminal</strong> window start the <code>agent</code>.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../otelcol --config<span class=o>=</span>agent.yaml</span></span></code></pre></div><p><strong>Start the Load Generator</strong>: In the <strong>Spans terminal</strong> window start the <code>loadgen</code>:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../loadgen -count <span class=m>1</span></span></span></code></pre></div><p><strong>Check the debug output</strong>: For both the <code>agent</code> and <code>gateway</code> debug output, confirm that <code>user.account_password</code> has been removed, and both <code>user.phone_number</code> & <code>user.email</code> have been updated.</p><div class=tab-panel data-tab-group=ca4636fac0f81c6095f3c60a4c84cf49><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=new-debug-output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ca4636fac0f81c6095f3c60a4c84cf49","new-debug-output")'>
<span class=tab-nav-text>New Debug Output</span>
</button>
<button data-tab-item=original-debug-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("ca4636fac0f81c6095f3c60a4c84cf49","original-debug-output")'>
<span class=tab-nav-text>Original Debug Output</span></button></div><div class=tab-content-container><div data-tab-item=new-debug-output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>   -&gt; user.name: Str(George Lucas)
</span></span><span class=line><span class=cl>   -&gt; user.phone_number: Str(UNKNOWN NUMBER)
</span></span><span class=line><span class=cl>   -&gt; user.email: Str(62d5e03d8fd5808e77aee5ebbd90cf7627a470ae0be9ffd10e8025a4ad0e1287)
</span></span><span class=line><span class=cl>   -&gt; payment.amount: Double(51.71)
</span></span><span class=line><span class=cl>   -&gt; user.visa: Str(4111 1111 1111 1111)
</span></span><span class=line><span class=cl>   -&gt; user.amex: Str(3782 822463 10005)
</span></span><span class=line><span class=cl>   -&gt; user.mastercard: Str(5555 5555 5555 4444)</span></span></code></pre></div></div></div><div data-tab-item=original-debug-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>    -&gt; user.name: Str(George Lucas)
</span></span><span class=line><span class=cl>    -&gt; user.phone_number: Str(+1555-867-5309)
</span></span><span class=line><span class=cl>    -&gt; user.email: Str(george@deathstar.email)
</span></span><span class=line><span class=cl>    -&gt; user.password: Str(LOTR&gt;StarWars1-2-3)
</span></span><span class=line><span class=cl>    -&gt; user.visa: Str(4111 1111 1111 1111)
</span></span><span class=line><span class=cl>    -&gt; user.amex: Str(3782 822463 10005)
</span></span><span class=line><span class=cl>    -&gt; user.mastercard: Str(5555 5555 5555 4444)
</span></span><span class=line><span class=cl>    -&gt; payment.amount: Double(95.22)</span></span></code></pre></div></div></div></div></div><p><strong>Check file output</strong>: Using <code>jq</code> validate that <code>user.account_password</code> has been removed, and <code>user.phone_number</code> & <code>user.email</code> have been updated in <code>gateway-taces.out</code>:</p><div class=tab-panel data-tab-group=6f3160e5e10673d653761a5a315934ca><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=validate-attribute-changes class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6f3160e5e10673d653761a5a315934ca","validate-attribute-changes")'>
<span class=tab-nav-text>Validate attribute changes</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("6f3160e5e10673d653761a5a315934ca","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=validate-attribute-changes class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>jq <span class=s1>&#39;.resourceSpans[].scopeSpans[].spans[].attributes[] | select(.key == &#34;user.password&#34; or .key == &#34;user.phone_number&#34; or .key == &#34;user.email&#34;) | {key: .key, value: .value.stringValue}&#39;</span> ./gateway-traces.out</span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><p>Notice that the <code>user.account_password</code> has been removed, and the <code>user.phone_number</code> & <code>user.email</code> have been updated:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;user.phone_number&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;UNKNOWN NUMBER&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;user.email&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;62d5e03d8fd5808e77aee5ebbd90cf7627a470ae0be9ffd10e8025a4ad0e1287&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><details open class="box cstyle notices important"><summary class=box-label><i class="fa-fw fas fa-bolt"></i>
Important</summary><div class=box-content><p>Stop the <code>agent</code> and the <code>gateway</code> processes by pressing <code>Ctrl-C</code> in their respective terminals.</p></div></details></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 12, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=63-test-redaction-processor>6.3 Test Redaction Processor</h1><p>The <code>redaction</code> processor gives precise control over which attributes and values are <strong>permitted</strong> or <strong>removed</strong> from telemetry data.</p><p>In this exercise, we will <strong>redact</strong> the <code>user.visa</code> & <code>user.mastercard</code> <strong>values</strong> in the span data before it is exported by the <code>agent</code>.<details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p><strong>Prepare the terminals</strong>: Delete the <code>*.out</code> files and clear the screen.</p><p><strong>Start the Gateway</strong>: In your <strong>Gateway terminal</strong> window start the <code>gateway</code>.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../otelcol --config<span class=o>=</span>gateway.yaml</span></span></code></pre></div><p><strong>Enable the <code>redaction/redact</code> processor</strong>: In the <strong>Agent terminal</strong> window, edit <code>agent.yaml</code> and remove the <code>#</code> we inserted in the previous exercise.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>attributes/update             </span><span class=w> </span><span class=c># Update, hash, and remove attributes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>redaction/redact              </span><span class=w> </span><span class=c># Redact sensitive fields using regex</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlphttp</span></span></span></code></pre></div><p><strong>Start the Agent</strong>: In your <strong>Agent terminal</strong> window start the <code>agent</code>.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../otelcol --config<span class=o>=</span>agent.yaml</span></span></code></pre></div><p><strong>Start the Load Generator</strong>: In the <strong>Spans terminal</strong> window start the <code>loadgen</code>:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../loadgen -count <span class=m>1</span></span></span></code></pre></div><p><strong>Check the debug output</strong>: For both the <code>agent</code> and <code>gateway</code> confirm the values for <code>user.visa</code> & <code>user.mastercard</code> have been updated. Notice <code>user.amex</code> attribute value was NOT redacted because a matching regex pattern was not added to <code>blocked_values</code></p><div class=tab-panel data-tab-group=700cdd7552c73543a1d7354e0d689a12><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=new-debug-output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("700cdd7552c73543a1d7354e0d689a12","new-debug-output")'>
<span class=tab-nav-text>New Debug Output</span>
</button>
<button data-tab-item=original-debug-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("700cdd7552c73543a1d7354e0d689a12","original-debug-output")'>
<span class=tab-nav-text>Original Debug Output</span></button></div><div class=tab-content-container><div data-tab-item=new-debug-output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>   -&gt; user.name: Str(George Lucas)
</span></span><span class=line><span class=cl>   -&gt; user.phone_number: Str(UNKNOWN NUMBER)
</span></span><span class=line><span class=cl>   -&gt; user.email: Str(62d5e03d8fd5808e77aee5ebbd90cf7627a470ae0be9ffd10e8025a4ad0e1287)
</span></span><span class=line><span class=cl>   -&gt; payment.amount: Double(69.71)
</span></span><span class=line><span class=cl>   -&gt; user.visa: Str(****)
</span></span><span class=line><span class=cl>   -&gt; user.amex: Str(3782 822463 10005)
</span></span><span class=line><span class=cl>   -&gt; user.mastercard: Str(****)
</span></span><span class=line><span class=cl>   -&gt; redaction.masked.keys: Str(user.mastercard,user.visa)
</span></span><span class=line><span class=cl>   -&gt; redaction.masked.count: Int(2)</span></span></code></pre></div></div></div><div data-tab-item=original-debug-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>    -&gt; user.name: Str(George Lucas)
</span></span><span class=line><span class=cl>    -&gt; user.phone_number: Str(+1555-867-5309)
</span></span><span class=line><span class=cl>    -&gt; user.email: Str(george@deathstar.email)
</span></span><span class=line><span class=cl>    -&gt; user.password: Str(LOTR&gt;StarWars1-2-3)
</span></span><span class=line><span class=cl>    -&gt; user.visa: Str(4111 1111 1111 1111)
</span></span><span class=line><span class=cl>    -&gt; user.amex: Str(3782 822463 10005)
</span></span><span class=line><span class=cl>    -&gt; user.mastercard: Str(5555 5555 5555 4444)
</span></span><span class=line><span class=cl>    -&gt; payment.amount: Double(65.54)</span></span></code></pre></div></div></div></div></div><details open class="box cstyle notices note"><summary class=box-label><i class="fa-fw fas fa-exclamation-circle"></i>
Note</summary><div class=box-content><p>By including <code>summary:debug</code> in the redaction processor, the debug output will include summary information about which matching key values were redacted, along with the count of values that were masked.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>     -&gt; redaction.masked.keys: Str(user.mastercard,user.visa)
</span></span><span class=line><span class=cl>     -&gt; redaction.masked.count: Int(2)</span></span></code></pre></div></div></details><p><strong>Check file output</strong>: Using <code>jq</code> verify that <code>user.visa</code> & <code>user.mastercard</code> have been updated in the <code>gateway-traces.out</code>.</p><div class=tab-panel data-tab-group=10f27820cec0e0bab211f42a933bcc07><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=validate-attribute-changes class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("10f27820cec0e0bab211f42a933bcc07","validate-attribute-changes")'>
<span class=tab-nav-text>Validate attribute changes</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("10f27820cec0e0bab211f42a933bcc07","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=validate-attribute-changes class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>jq <span class=s1>&#39;.resourceSpans[].scopeSpans[].spans[].attributes[] | select(.key == &#34;user.visa&#34; or .key == &#34;user.mastercard&#34; or .key == &#34;user.amex&#34;) | {key: .key, value: .value.stringValue}&#39;</span> ./gateway-traces.out</span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><p>Notice that <code>user.amex</code> has not been redacted because a matching regex pattern was not added to <code>blocked_values</code>:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;user.visa&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;****&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;user.amex&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;3782 822463 10005&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;user.mastercard&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;****&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>These are just a few examples of how <code>attributes</code> and <code>redaction</code> processors can be configured to protect sensitive data.</p><details open class="box cstyle notices important"><summary class=box-label><i class="fa-fw fas fa-bolt"></i>
Important</summary><div class=box-content><p>Stop the <code>agent</code> and the <code>gateway</code> processes by pressing <code>Ctrl-C</code> in their respective terminals.</p></div></details></div></details></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 27, 2025</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=7-transform-data>7. Transform Data</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<p>The <a href=https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/processor/transformprocessor/README.md rel=external target=_blank><strong>Transform Processor</strong></a> lets you modify telemetry dataâ€”logs, metrics, and tracesâ€”as it flows through the pipeline. Using the <strong>OpenTelemetry Transformation Language (OTTL)</strong>, you can filter, enrich, and transform data on the fly without touching your application code.</p><p>In this exercise weâ€™ll update <code>agent.yaml</code> to include a <strong>Transform Processor</strong> that will:</p><ul><li><strong>Filter</strong> log resource attributes.</li><li><strong>Parse</strong> JSON structured log data into attributes.</li><li><strong>Set</strong> log severity levels based on the log message body.</li></ul><p>You may have noticed that in previous logs, fields like <code>SeverityText</code> and <code>SeverityNumber</code> were undefined. This is typical of the <code>filelog</code> receiver. However, the severity is embedded within the log body:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>&lt;snip&gt;
</span></span><span class=line><span class=cl>SeverityText: 
</span></span><span class=line><span class=cl>SeverityNumber: Unspecified(0)
</span></span><span class=line><span class=cl>Body: Str(2025-01-31 15:49:29 [WARN] - Do or do not, there is no try.)
</span></span><span class=line><span class=cl>&lt;/snip&gt;</span></span></code></pre></div><p>Logs often contain structured data encoded as JSON within the log body. Extracting these fields into attributes allows for better indexing, filtering, and querying. Instead of manually parsing JSON in downstream systems, OTTL enables automatic transformation at the telemetry pipeline level.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><ul><li>Inside the <code>[WORKSHOP]</code> directory, create a new subdirectory named <code>7-transform-data</code>.</li><li>Next, copy <code>*.yaml</code> from the <code>6-sensitve-data</code> directory into <code>7-transform-data</code>.</li></ul><details open class="box cstyle notices important"><summary class=box-label><i class="fa-fw fas fa-bolt"></i>
Important</summary><div class=box-content><p><strong>Change <em>ALL</em> terminal windows to the <code>[WORKSHOP]/7-transform-data</code> directory.</strong></p></div></details><p>Your updated directory structure will now look like this:</p><div class=tab-panel data-tab-group=16cf02af2e427f6b0ccd8b139f22a487><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=updated-directory-structure class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("16cf02af2e427f6b0ccd8b139f22a487","updated-directory-structure")'>
<span class=tab-nav-text>Updated Directory Structure</span></button></div><div class=tab-content-container><div data-tab-item=updated-directory-structure class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>â”œâ”€â”€ agent.yaml
</span></span><span class=line><span class=cl>â””â”€â”€ gateway.yaml</span></span></code></pre></div></div></div></div></div></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 27, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 7. Transform Data</h1><article class=default><header class=headline></header><h1 id=71-configuration>7.1 Configuration</h1><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p><strong>Add a <code>transform</code> processor</strong>: Switch to your <strong>Agent terminal</strong> window and edit the <code>agent.yaml</code> and add the following <code>transform</code> processor:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>transform/logs</span><span class=p>:</span><span class=w>                      </span><span class=c># Processor Type/Name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>log_statements</span><span class=p>:</span><span class=w>                    </span><span class=c># Log Processing Statements</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>context</span><span class=p>:</span><span class=w> </span><span class=l>resource             </span><span class=w> </span><span class=c># Log Context</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>statements</span><span class=p>:</span><span class=w>                    </span><span class=c># List of attribute keys to keep</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>keep_keys(attributes, [&#34;com.splunk.sourcetype&#34;, &#34;host.name&#34;, &#34;otelcol.service.mode&#34;])</span></span></span></code></pre></div><p>By using the <code>-context: resource</code> key we are targeting the <code>resourceLog</code> attributes of logs.</p><p>This configuration ensures that only the relevant resource attributes (<code>com.splunk.sourcetype</code>, <code>host.name</code>, <code>otelcol.service.mode</code>) are retained, improving log efficiency and reducing unnecessary metadata.</p><p><strong>Adding a Context Block for Log Severity Mapping</strong>: To properly set the <code>severity_text</code> and <code>severity_number</code> fields of a log record, we add a <code>log</code> context block within <code>log_statements</code>. This configuration extracts the <code>level</code> value from the log body, maps it to <code>severity_text</code>, and assigns the corresponding <code>severity_number</code> based on the log level:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>      </span>- <span class=nt>context</span><span class=p>:</span><span class=w> </span><span class=l>log                  </span><span class=w> </span><span class=c># Log Context</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>statements</span><span class=p>:</span><span class=w>                    </span><span class=c># Transform Statements Array</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>set(cache, ParseJSON(body)) where IsMatch(body, &#34;^\\{&#34;) </span><span class=w> </span><span class=c># Parse JSON log body into a cache object</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>flatten(cache, &#34;&#34;)                                       </span><span class=w> </span><span class=c># Flatten nested JSON structure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>merge_maps(attributes, cache, &#34;upsert&#34;)                  </span><span class=w> </span><span class=c># Merge cache into attributes, updating existing keys</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>set(severity_text, attributes[&#34;level&#34;])                  </span><span class=w> </span><span class=c># Set severity_text from the &#34;level&#34; attribute</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>set(severity_number, 1) where severity_text == &#34;TRACE&#34;   </span><span class=w> </span><span class=c># Map severity_text to severity_number</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>set(severity_number, 5) where severity_text == &#34;DEBUG&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>set(severity_number, 9) where severity_text == &#34;INFO&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>set(severity_number, 13) where severity_text == &#34;WARN&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>set(severity_number, 17) where severity_text == &#34;ERROR&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>set(severity_number, 21) where severity_text == &#34;FATAL&#34;</span></span></span></code></pre></div><p>The <code>merge_maps</code> function is used to combine two maps (dictionaries) into one. In this case, it merges the <code>cache</code> object (containing parsed JSON data from the log body) into the <code>attributes</code> map.</p><ul><li><strong>Parameters</strong>:<ul><li><code>attributes</code>: The target map where the data will be merged.</li><li><code>cache</code>: The source map containing the parsed JSON data.</li><li><code>"upsert"</code>: This mode ensures that if a key already exists in the <code>attributes</code> map, its value will be updated with the value from <code>cache</code>. If the key does not exist, it will be inserted.</li></ul></li></ul><p>This step is crucial because it ensures that all relevant fields from the log body (e.g., <code>level</code>, <code>message</code>, etc.) are added to the <code>attributes</code> map, making them available for further processing or exporting.</p><p><strong>Summary of Key Transformations</strong>:</p><ul><li><strong>Parse JSON</strong>: Extracts structured data from the log body.</li><li><strong>Flatten JSON</strong>: Converts nested JSON objects into a flat structure.</li><li><strong>Merge Attributes</strong>: Integrates extracted data into log attributes.</li><li><strong>Map Severity Text</strong>: Assigns severity_text from the logâ€™s level attribute.</li><li><strong>Assign Severity Numbers</strong>: Converts severity levels into standardized numerical values.</li></ul><p>You should have a <strong>single</strong> <code>transform</code> processor containing two context blocks: one whose context is for <code>resource</code> and one whose context is for <code>log</code>.</p><p>This configuration ensures that log severity is correctly extracted, standardized, and structured for efficient processing.</p><details open class="box cstyle notices primary"><summary class=box-label><i class="fa-fw fas fa-lightbulb"></i>
Tip</summary><div class=box-content><p>This method of mapping all JSON fields to top-level attributes should only be used for <strong>testing and debugging OTTL</strong>. It will result in high cardinality in a production scenario.</p></div></details><p><strong>Update the <code>logs</code> pipeline</strong>: Add the <code>transform/logs:</code> processor into the <code>logs:</code> pipeline:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>    </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>filelog/quotes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>transform/logs                </span><span class=w> </span><span class=c># Transform logs processor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlphttp</span></span></span></code></pre></div></div></details><p>Validate the agent configuration using <a href=https://otelbin.io/ rel=external target=_blank><strong>https://otelbin.io</strong></a>. For reference, the <code>logs:</code> section of your pipelines will look similar to this:</p><pre class="mermaid align-center">%%{init:{&#34;fontFamily&#34;:&#34;monospace&#34;}}%%
graph LR
    %% Nodes
      REC1(&amp;nbsp;&amp;nbsp;otlp&amp;nbsp;&amp;nbsp;&lt;br&gt;fa:fa-download):::receiver
      REC2(filelog&lt;br&gt;fa:fa-download&lt;br&gt;quotes):::receiver
      PRO1(memory_limiter&lt;br&gt;fa:fa-microchip):::processor
      PRO2(resourcedetection&lt;br&gt;fa:fa-microchip):::processor
      PRO3(resource&lt;br&gt;fa:fa-microchip&lt;br&gt;add_mode):::processor
      PRO4(transform&lt;br&gt;fa:fa-microchip&lt;br&gt;logs):::processor
      PRO5(batch&lt;br&gt;fa:fa-microchip):::processor
      EXP1(otlphttp&lt;br&gt;fa:fa-upload):::exporter
      EXP2(&amp;ensp;&amp;ensp;debug&amp;ensp;&amp;ensp;&lt;br&gt;fa:fa-upload):::exporter
    %% Links
    subID1:::sub-logs
    subgraph &#34; &#34;
      subgraph subID1[**Logs**]
      direction LR
      REC1 --&gt; PRO1
      REC2 --&gt; PRO1
      PRO1 --&gt; PRO2
      PRO2 --&gt; PRO3
      PRO3 --&gt; PRO4
      PRO4 --&gt; PRO5
      PRO5 --&gt; EXP2
      PRO5 --&gt; EXP1
      end
    end
classDef receiver,exporter fill:#8b5cf6,stroke:#333,stroke-width:1px,color:#fff;
classDef processor fill:#6366f1,stroke:#333,stroke-width:1px,color:#fff;
classDef con-receive,con-export fill:#45c175,stroke:#333,stroke-width:1px,color:#fff;
classDef sub-logs stroke:#34d399,stroke-width:1px, color:#34d399,stroke-dasharray: 3 3;</pre><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 27, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=72-setup-environment>7.2 Setup Environment</h1><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p><strong>Start the Gateway</strong>: In the <strong>Gateway terminal</strong> run:</p><div class=tab-panel data-tab-group=5a1875b55320cba499731272c8d9b767><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=start-the-gateway class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5a1875b55320cba499731272c8d9b767","start-the-gateway")'>
<span class=tab-nav-text>Start the Gateway</span></button></div><div class=tab-content-container><div data-tab-item=start-the-gateway class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../otelcol --config<span class=o>=</span>gateway.yaml</span></span></code></pre></div></div></div></div></div><p><strong>Start the Agent</strong>: In the <strong>Agent terminal</strong> run:</p><div class=tab-panel data-tab-group=8195b66e3a09debdb359bfa9684ef1bb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=start-the-agent class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8195b66e3a09debdb359bfa9684ef1bb","start-the-agent")'>
<span class=tab-nav-text>Start the Agent</span></button></div><div class=tab-content-container><div data-tab-item=start-the-agent class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../otelcol --config<span class=o>=</span>agent.yaml</span></span></code></pre></div></div></div></div></div><p><strong>Start the Load Generator</strong>: Open the <strong>Logs terminal</strong> window and run the <code>loadgen</code>.</p><details open class="box cstyle notices important"><summary class=box-label><i class="fa-fw fas fa-bolt"></i>
Important</summary><div class=box-content><p>To ensure the logs are structured in JSON format, include the <code>-json</code> flag when starting the script.</p></div></details><div class=tab-panel data-tab-group=ad64d26b480e005efda8086b35b33360><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=log-generator class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ad64d26b480e005efda8086b35b33360","log-generator")'>
<span class=tab-nav-text>Log Generator</span></button></div><div class=tab-content-container><div data-tab-item=log-generator class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../loadgen -logs -json -count <span class=m>5</span></span></span></code></pre></div></div></div></div></div><p>The <code>loadgen</code> will write 5 log lines to <code>./quotes.log</code> in JSON format.</p></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 7, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=73-test-transform-processor>7.3 Test Transform Processor</h1><p>This test verifies that the <code>com.splunk/source</code> and <code>os.type</code> metadata have been <strong>removed</strong> from the log resource attributes before being exported by the <code>agent</code>. Additionally, the test ensures that:</p><ol><li>The log body is parsed to extract severity information.<ul><li><code>SeverityText</code> and <code>SeverityNumber</code> are set on the <code>LogRecord</code>.</li></ul></li><li>JSON fields from the log body are promoted to log <code>attributes</code>.</li></ol><p>This ensures proper metadata filtering, severity mapping, and structured log enrichment before export.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p><strong>Check the debug output</strong>: For both the <code>agent</code> and <code>gateway</code> confirm that <code>com.splunk/source</code> and <code>os.type</code> have been removed:</p><div class=tab-panel data-tab-group=539adc5c2678fbb6ffbe71aaffe5010b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=new-debug-output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("539adc5c2678fbb6ffbe71aaffe5010b","new-debug-output")'>
<span class=tab-nav-text>New Debug Output</span>
</button>
<button data-tab-item=original-debug-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("539adc5c2678fbb6ffbe71aaffe5010b","original-debug-output")'>
<span class=tab-nav-text>Original Debug Output</span></button></div><div class=tab-content-container><div data-tab-item=new-debug-output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Resource attributes:
</span></span><span class=line><span class=cl>   -&gt; com.splunk.sourcetype: Str(quotes)
</span></span><span class=line><span class=cl>   -&gt; host.name: Str(workshop-instance)
</span></span><span class=line><span class=cl>   -&gt; otelcol.service.mode: Str(agent)</span></span></code></pre></div></div></div><div data-tab-item=original-debug-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Resource attributes:
</span></span><span class=line><span class=cl>   -&gt; com.splunk.source: Str(./quotes.log)
</span></span><span class=line><span class=cl>   -&gt; com.splunk.sourcetype: Str(quotes)
</span></span><span class=line><span class=cl>   -&gt; host.name: Str(workshop-instance)
</span></span><span class=line><span class=cl>   -&gt; os.type: Str(linux)
</span></span><span class=line><span class=cl>   -&gt; otelcol.service.mode: Str(agent)</span></span></code></pre></div></div></div></div></div><p>For both the <code>agent</code> and <code>gateway</code> confirm that <code>SeverityText</code> and <code>SeverityNumber</code> in the <code>LogRecord</code> is now defined with the severity <code>level</code> from the log body. Confirm that the JSON fields from the body can be accessed as top-level log <code>Attributes</code>:</p><div class=tab-panel data-tab-group=6cfe7687e78ee7f26b3fb31b4d9b3274><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=new-debug-output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6cfe7687e78ee7f26b3fb31b4d9b3274","new-debug-output")'>
<span class=tab-nav-text>New Debug Output</span>
</button>
<button data-tab-item=original-debug-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("6cfe7687e78ee7f26b3fb31b4d9b3274","original-debug-output")'>
<span class=tab-nav-text>Original Debug Output</span></button></div><div class=tab-content-container><div data-tab-item=new-debug-output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>&lt;snip&gt;
</span></span><span class=line><span class=cl>SeverityText: WARN
</span></span><span class=line><span class=cl>SeverityNumber: Warn(13)
</span></span><span class=line><span class=cl>Body: Str({&#34;level&#34;:&#34;WARN&#34;,&#34;message&#34;:&#34;Your focus determines your reality.&#34;,&#34;movie&#34;:&#34;SW&#34;,&#34;timestamp&#34;:&#34;2025-03-07 11:17:26&#34;})
</span></span><span class=line><span class=cl>Attributes:
</span></span><span class=line><span class=cl>     -&gt; log.file.path: Str(quotes.log)
</span></span><span class=line><span class=cl>     -&gt; level: Str(WARN)
</span></span><span class=line><span class=cl>     -&gt; message: Str(Your focus determines your reality.)
</span></span><span class=line><span class=cl>     -&gt; movie: Str(SW)
</span></span><span class=line><span class=cl>     -&gt; timestamp: Str(2025-03-07 11:17:26)
</span></span><span class=line><span class=cl>&lt;/snip&gt;</span></span></code></pre></div></div></div><div data-tab-item=original-debug-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>&lt;snip&gt;
</span></span><span class=line><span class=cl>SeverityText:
</span></span><span class=line><span class=cl>SeverityNumber: Unspecified(0)
</span></span><span class=line><span class=cl>Body: Str({&#34;level&#34;:&#34;WARN&#34;,&#34;message&#34;:&#34;Your focus determines your reality.&#34;,&#34;movie&#34;:&#34;SW&#34;,&#34;timestamp&#34;:&#34;2025-03-07 11:17:26&#34;})
</span></span><span class=line><span class=cl>Attributes:
</span></span><span class=line><span class=cl>     -&gt; log.file.path: Str(quotes.log)
</span></span><span class=line><span class=cl>&lt;/snip&gt;</span></span></code></pre></div></div></div></div></div><p><strong>Check file output</strong>: In the new <code>gateway-logs.out</code> file verify the data has been transformed:</p><div class=tab-panel data-tab-group=5a5fe0a394815c8530fd785eb9db3ce3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=jq-query class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5a5fe0a394815c8530fd785eb9db3ce3","jq-query")'>
<span class=tab-nav-text>jq Query</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("5a5fe0a394815c8530fd785eb9db3ce3","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=jq-query class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>jq <span class=s1>&#39;[.resourceLogs[].scopeLogs[].logRecords[] | {severityText, severityNumber, body: .body.stringValue}]&#39;</span> gateway-logs.out</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;severityText&#34;</span><span class=p>:</span> <span class=s2>&#34;DEBUG&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;severityNumber&#34;</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;body&#34;</span><span class=p>:</span> <span class=s2>&#34;{\&#34;level\&#34;:\&#34;DEBUG\&#34;,\&#34;message\&#34;:\&#34;All we have to decide is what to do with the time that is given us.\&#34;,\&#34;movie\&#34;:\&#34;LOTR\&#34;,\&#34;timestamp\&#34;:\&#34;2025-03-07 11:56:29\&#34;}&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;severityText&#34;</span><span class=p>:</span> <span class=s2>&#34;WARN&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;severityNumber&#34;</span><span class=p>:</span> <span class=mi>13</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;body&#34;</span><span class=p>:</span> <span class=s2>&#34;{\&#34;level\&#34;:\&#34;WARN\&#34;,\&#34;message\&#34;:\&#34;The Force will be with you. Always.\&#34;,\&#34;movie\&#34;:\&#34;SW\&#34;,\&#34;timestamp\&#34;:\&#34;2025-03-07 11:56:29\&#34;}&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;severityText&#34;</span><span class=p>:</span> <span class=s2>&#34;ERROR&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;severityNumber&#34;</span><span class=p>:</span> <span class=mi>17</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;body&#34;</span><span class=p>:</span> <span class=s2>&#34;{\&#34;level\&#34;:\&#34;ERROR\&#34;,\&#34;message\&#34;:\&#34;One does not simply walk into Mordor.\&#34;,\&#34;movie\&#34;:\&#34;LOTR\&#34;,\&#34;timestamp\&#34;:\&#34;2025-03-07 11:56:29\&#34;}&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;severityText&#34;</span><span class=p>:</span> <span class=s2>&#34;DEBUG&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;severityNumber&#34;</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;body&#34;</span><span class=p>:</span> <span class=s2>&#34;{\&#34;level\&#34;:\&#34;DEBUG\&#34;,\&#34;message\&#34;:\&#34;Do or do not, there is no try.\&#34;,\&#34;movie\&#34;:\&#34;SW\&#34;,\&#34;timestamp\&#34;:\&#34;2025-03-07 11:56:29\&#34;}&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;severityText&#34;</span><span class=p>:</span> <span class=s2>&#34;ERROR&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;severityNumber&#34;</span><span class=p>:</span> <span class=mi>17</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;body&#34;</span><span class=p>:</span> <span class=s2>&#34;{\&#34;level\&#34;:\&#34;ERROR\&#34;,\&#34;message\&#34;:\&#34;There is some good in this world, and it&#39;s worth fighting for.\&#34;,\&#34;movie\&#34;:\&#34;LOTR\&#34;,\&#34;timestamp\&#34;:\&#34;2025-03-07 11:56:29\&#34;}&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span></span></span></code></pre></div></div></div></div></div><details open class="box cstyle notices important"><summary class=box-label><i class="fa-fw fas fa-bolt"></i>
Important</summary><div class=box-content><p>Stop the <code>agent</code> and the <code>gateway</code> processes by pressing <code>Ctrl-C</code> in their respective terminals.</p></div></details></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 12, 2025</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=8-routing-data>8. Routing Data</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<p>The <a href=https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/connector/routingconnector rel=external target=_blank><strong>Routing Connector</strong></a> in OpenTelemetry is a powerful feature that allows you to direct data (<code>traces</code>, <code>metrics</code>, or <code>logs</code>) to different pipelines based on specific criteria. This is especially useful in scenarios where you want to apply different processing or exporting logic to subsets of your telemetry data.</p><p>For example, you might want to send <em>production</em> data to one exporter while directing <em>test</em> or <em>development</em> data to another. Similarly, you could route certain spans based on their attributes, such as service name, environment, or span name, to apply custom processing or storage logic.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><ul><li>Inside the <code>[WORKSHOP]</code> directory, create a new subdirectory named <code>8-routing-data</code>.</li><li>Next, copy <code>*.yaml</code> from the <code>7-transform-data</code> directory into <code>8-routing-data</code>.</li><li>Change <strong>all</strong> terminal windows to the <code>[WORKSHOP]/8-routing-data</code> directory.</li></ul><p>Your updated directory structure will now look like this:</p><div class=tab-panel data-tab-group=3804a09cdbad8f3bdfc1ec775260742e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=updated-directory-structure class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3804a09cdbad8f3bdfc1ec775260742e","updated-directory-structure")'>
<span class=tab-nav-text>Updated Directory Structure</span></button></div><div class=tab-content-container><div data-tab-item=updated-directory-structure class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>â”œâ”€â”€ agent.yaml
</span></span><span class=line><span class=cl>â””â”€â”€ gateway.yaml</span></span></code></pre></div></div></div></div></div></div></details><p>Next, we will configure the routing connector and the respective pipelines.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 12, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 8. Routing Data</h1><article class=default><header class=headline></header><h1 id=81-configure-the-routing-connector>8.1 Configure the Routing Connector</h1><p>In this exercise, you will configure the <strong>Routing Connector</strong> in the <code>gateway.yaml</code> file. This setup enables the <code>gateway</code> to route traces based on the <code>deployment.environment</code> attribute in the spans you send. By implementing this, you can process and handle traces differently depending on their attributes.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p>In OpenTelemetry configuration files, <code>connectors</code> have their own dedicated section, similar to receivers and processors.</p><p><strong>Add the <code>routing</code> connector</strong>:
In the <strong>Gateway terminal</strong> window, edit <code>gateway.yaml</code> and uncomment the <code>#connectors:</code> section. Then, add the following below the <code>connectors:</code> section:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>connectors</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>routing</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>default_pipelines</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>traces/standard]</span><span class=w> </span><span class=c># Default pipeline if no rule matches</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>error_mode</span><span class=p>:</span><span class=w> </span><span class=l>ignore                  </span><span class=w> </span><span class=c># Ignore errors in routing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>table</span><span class=p>:</span><span class=w>                               </span><span class=c># Define routing rules</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Routes spans to a target pipeline if the resourceSpan attribute matches the rule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>statement</span><span class=p>:</span><span class=w> </span><span class=l>route() where attributes[&#34;deployment.environment&#34;] == &#34;security-applications&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>pipelines</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>traces/security]    </span><span class=w> </span><span class=c># Target pipeline </span></span></span></code></pre></div><p>The rules above apply to traces, but this approach also applies to <code>metrics</code> and <code>logs</code>, allowing them to be routed based on attributes in <code>resourceMetrics</code> or <code>resourceLogs</code>.</p><p><strong>Configure <code>file:</code> exporters</strong>: The <code>routing</code> connector requires separate targets for routing. In the <code>exporters:</code> section, add two file exporters, <code>file/traces/security</code> and <code>file/traces/standard</code>, to ensure data is directed correctly.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>file/traces/standard</span><span class=p>:</span><span class=w>                    </span><span class=c># Exporter for regular traces</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;./gateway-traces-standard.out&#34;</span><span class=w>  </span><span class=c># Path for saving trace data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>append</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>                          </span><span class=c># Overwrite the file each time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>file/traces/security</span><span class=p>:</span><span class=w>                    </span><span class=c># Exporter for security traces</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;./gateway-traces-security.out&#34;</span><span class=w>  </span><span class=c># Path for saving trace data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>append</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>                          </span><span class=c># Overwrite the file each time </span></span></span></code></pre></div></div></details><p>With the <code>routing</code> configuration complete, the next step is to configure the <code>pipelines</code> to apply these routing rules.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 27, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=82-configuring-the-pipelines>8.2 Configuring the Pipelines</h1><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p><strong>Update the <code>traces</code> pipeline to use routing</strong>:</p><ol><li><p>To enable <code>routing</code>, update the original <code>traces:</code> pipeline by using <code>routing</code> as the only exporter. This ensures all span data is sent through the routing connector for evaluation.</p></li><li><p>Remove all processors and replace it with an empty array (<code>[]</code>). These are now defined in the <code>traces/standard</code> and <code>traces/security</code> pipelines.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>                           </span><span class=c># Original traces pipeline</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp                         </span><span class=w> </span><span class=c># OTLP Receiver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>routing                      </span><span class=w> </span><span class=c># Routing Connector</span></span></span></code></pre></div></li></ol><p><strong>Add both the <code>standard</code> and <code>security</code> traces pipelines</strong>:</p><ol><li><p><strong>Configure the Security pipeline</strong>: This pipeline will handle all spans that match the routing rule for <code>security</code>.
This uses <code>routing</code> as its receiver. Place it below the existing <code>traces:</code> pipeline:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>    </span><span class=nt>traces/security</span><span class=p>:</span><span class=w>              </span><span class=c># New Security Traces/Spans Pipeline</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>routing                  </span><span class=w> </span><span class=c># Receive data from the routing connector</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter           </span><span class=w> </span><span class=c># Memory Limiter Processor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_mode        </span><span class=w> </span><span class=c># Adds collector mode metadata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug                    </span><span class=w> </span><span class=c># Debug Exporter </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>file/traces/security     </span><span class=w> </span><span class=c># File Exporter for spans matching rule</span></span></span></code></pre></div></li><li><p><strong>Add the Standard pipeline</strong>: This pipeline processes all spans that do not match the routing rule.
This pipeline is also using <code>routing</code> as its receiver. Add this below the <code>traces/security</code> one:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>    </span><span class=nt>traces/standard</span><span class=p>:</span><span class=w>              </span><span class=c># Default pipeline for unmatched spans</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>routing                  </span><span class=w> </span><span class=c># Receive data from the routing connector</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter           </span><span class=w> </span><span class=c># Memory Limiter Processor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_mode        </span><span class=w> </span><span class=c># Adds collector mode metadata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug                    </span><span class=w> </span><span class=c># Debug exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>file/traces/standard     </span><span class=w> </span><span class=c># File exporter for unmatched spans</span></span></span></code></pre></div></li></ol></div></details><p>Validate the agent configuration using <strong><a href=https://www.otelbin.io/ rel=external target=_blank>otelbin.io</a></strong>. For reference, the <code>traces:</code> section of your pipelines will look similar to this:</p><pre class="mermaid align-center">%%{init:{&#34;fontFamily&#34;:&#34;monospace&#34;}}%%
graph LR
    %% Nodes
      REC1(&amp;nbsp;&amp;nbsp;&amp;nbsp;otlp&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;br&gt;fa:fa-download):::receiver
      PRO1(memory_limiter&lt;br&gt;fa:fa-microchip):::processor
      PRO2(memory_limiter&lt;br&gt;fa:fa-microchip):::processor
      PRO3(resource&lt;br&gt;fa:fa-microchip&lt;br&gt;add_mode):::processor
      PRO4(resource&lt;br&gt;fa:fa-microchip&lt;br&gt;add_mode):::processor
      PRO5(batch&lt;br&gt;fa:fa-microchip):::processor
      PRO6(batch&lt;br&gt;fa:fa-microchip):::processor
      EXP1(&amp;nbsp;&amp;ensp;debug&amp;nbsp;&amp;ensp;&lt;br&gt;fa:fa-upload):::exporter
      EXP2(&amp;emsp;&amp;emsp;file&amp;emsp;&amp;emsp;&lt;br&gt;fa:fa-upload&lt;br&gt;traces):::exporter
      EXP3(&amp;nbsp;&amp;ensp;debug&amp;nbsp;&amp;ensp;&lt;br&gt;fa:fa-upload):::exporter
      EXP4(&amp;emsp;&amp;emsp;file&amp;emsp;&amp;emsp;&lt;br&gt;fa:fa-upload&lt;br&gt;traces):::exporter
      ROUTE1(&amp;nbsp;routing&amp;nbsp;&lt;br&gt;fa:fa-route):::con-export
      ROUTE2(&amp;nbsp;routing&amp;nbsp;&lt;br&gt;fa:fa-route):::con-receive
      ROUTE3(&amp;nbsp;routing&amp;nbsp;&lt;br&gt;fa:fa-route):::con-receive
    %% Links
    subID1:::sub-traces
    subID2:::sub-traces
    subID3:::sub-traces
    subgraph &#34; &#34;
    direction LR
      subgraph subID1[**Traces**]
      REC1 --&gt; ROUTE1
      end
      subgraph subID2[**Traces/standard**]
      ROUTE1 --&gt; ROUTE2
      ROUTE2 --&gt; PRO1
      PRO1 --&gt; PRO3
      PRO3 --&gt; PRO5
      PRO5 --&gt; EXP1
      PRO5 --&gt; EXP2
      end
      subgraph subID3[**Traces/security**]
      ROUTE1 --&gt; ROUTE3
      ROUTE3 --&gt; PRO2
      PRO2 --&gt; PRO4
      PRO4 --&gt; PRO6
      PRO6 --&gt; EXP3
      PRO6 --&gt; EXP4
      end
    end
classDef receiver,exporter fill:#8b5cf6,stroke:#333,stroke-width:1px,color:#fff;
classDef processor fill:#6366f1,stroke:#333,stroke-width:1px,color:#fff;
classDef con-receive,con-export fill:#45c175,stroke:#333,stroke-width:1px,color:#fff;
classDef sub-traces stroke:#fbbf24,stroke-width:1px, color:#fbbf24,stroke-dasharray: 3 3;</pre><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 12, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=83-test-routing-connector>8.3 Test Routing Connector</h1><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p>In this section, we will test the <code>routing</code> rule configured for the <strong>Gateway</strong>. The expected result is that the<code>span</code> generated by the <code>loadgen</code> will be sent to the <code>gateway-traces-security.out</code> file.</p><p><strong>Start the Gateway</strong>: In your <strong>Gateway terminal</strong> window start the <code>gateway</code>.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../otelcol --config gateway.yaml</span></span></code></pre></div><p><strong>Start the Agent</strong>: In your <strong>Agent terminal</strong> window start the <code>agent</code>.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../otelcol --config agent.yaml</span></span></code></pre></div><p><strong>Send a Regular Span</strong>: In the <strong>Spans terminal</strong> window send a regular span using the <code>loadgen</code>:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../loadgen -count <span class=m>1</span></span></span></code></pre></div><p>Both the <code>agent</code> and <code>gateway</code> will display debug information. The gateway will also generate a new <code>gateway-traces-standard.out</code> file, as this is now the designated destination for regular spans.</p><details open class="box cstyle notices primary"><summary class=box-label><i class="fa-fw fas fa-lightbulb"></i>
Tip</summary><div class=box-content><p>If you check <code>gateway-traces-standard.out</code>, it will contain the <code>span</code> sent by <code>loadgen</code>. You will also see an empty <code>gateway-traces-security.out</code> file, as the routing configuration creates output files immediately, even if no matching spans have been processed yet.</p></div></details><p><strong>Send a Security Span</strong>: In the <strong>Spans terminal</strong> window send a security span using the <code>security</code> flag:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../loadgen -security -count <span class=m>1</span></span></span></code></pre></div><p>Again, both the <code>agent</code> and <code>gateway</code> should display debug information, including the span you just sent. This time, the <code>gateway</code> will write a line to the <code>gateway-traces-security.out</code> file, which is designated for spans where the <code>deployment.environment</code> resource attribute matches <code>"security-applications"</code>.
The <code>gateway-traces-standard.out</code> should be unchanged.</p><div class=tab-panel data-tab-group=7c39e38b7f89ce39b87eebadf513a106><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=validate-resource-attribute-matches class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7c39e38b7f89ce39b87eebadf513a106","validate-resource-attribute-matches")'>
<span class=tab-nav-text>Validate resource attribute matches</span>
</button>
<button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("7c39e38b7f89ce39b87eebadf513a106","output")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div data-tab-item=validate-resource-attribute-matches class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>jq -c <span class=s1>&#39;.resourceSpans[] as $resource | $resource.scopeSpans[].spans[] | {spanId: .spanId, deploymentEnvironment: ($resource.resource.attributes[] | select(.key == &#34;deployment.environment&#34;) | .value.stringValue)}&#39;</span> gateway-traces-security.out</span></span></code></pre></div></div></div><div data-tab-item=output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;spanId&#34;</span><span class=p>:</span><span class=s2>&#34;cb799e92e26d5782&#34;</span><span class=p>,</span><span class=nt>&#34;deploymentEnvironment&#34;</span><span class=p>:</span><span class=s2>&#34;security-applications&#34;</span><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>You can repeat this scenario multiple times, and each trace will be written to its corresponding output file.</p><details open class="box cstyle notices important"><summary class=box-label><i class="fa-fw fas fa-bolt"></i>
Important</summary><div class=box-content><p>Stop the <code>agent</code> and the <code>gateway</code> processes by pressing <code>Ctrl-C</code> in their respective terminals.</p></div></details></div></details><h2 id=conclusion>Conclusion</h2><p>In this section, we successfully tested the routing connector in the gateway by sending different spans and verifying their destinations.</p><ul><li><p><strong>Regular spans</strong> were correctly routed to <code>gateway-traces-standard.out</code>, confirming that spans without a matching <code>deployment.environment</code> attribute follow the default pipeline.</p></li><li><p><strong>Security-related spans</strong> were routed to <code>gateway-traces-security.out</code>, demonstrating that the routing rule based on <code>"deployment.environment": "security-applications"</code> works as expected.</p></li></ul><p>By inspecting the output files, we confirmed that the OpenTelemetry Collector <em>correctly evaluates span attributes and routes them to the appropriate destinations</em>. This validates that routing rules can effectively separate and direct telemetry data for different use cases.</p><p>You can now extend this approach by defining additional routing rules to further categorize spans, metrics, and logs based on different attributes.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 17, 2025</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=create-metrics-with-count-connector>Create metrics with Count Connector</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<p>In this section, we&rsquo;ll explore how to use the <a href=https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/connector/countconnector rel=external target=_blank><strong>Count Connector</strong></a> to extract attribute values from logs and convert them into meaningful metrics.</p><p>Specifically, we&rsquo;ll use the Count Connector to track the number of &ldquo;Star Wars&rdquo; and &ldquo;Lord of the Rings&rdquo; quotes appearing in our logs, turning them into measurable data points.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><ul><li>Inside the <code>[WORKSHOP]</code> directory, create a new subdirectory named <code>9-sum-count</code>.</li><li>Next, copy <code>*.yaml</code> from the <code>8-routing-data</code> directory into <code>9-sum-count</code>.</li><li>Change <strong>all</strong> terminal windows to the <code>[WORKSHOP]/9-sum-count</code> directory.</li></ul><div class=tab-panel data-tab-group=74f7d7ff3066e10629edba18e7b62128><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=updated-directory-structure class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("74f7d7ff3066e10629edba18e7b62128","updated-directory-structure")'>
<span class=tab-nav-text>Updated Directory Structure</span></button></div><div class=tab-content-container><div data-tab-item=updated-directory-structure class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>â”œâ”€â”€ agent.yaml
</span></span><span class=line><span class=cl>â””â”€â”€ gateway.yaml</span></span></code></pre></div></div></div></div></div><ul><li><strong>Update the agent.yaml</strong> to change the frequency that we read logs.
Find the <code>filelog/quotes</code> receiver in the <code>agent.yaml</code> and add a <code>poll_interval</code> attribute:</li></ul><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>filelog/quotes</span><span class=p>:</span><span class=w>                      </span><span class=c># Receiver Type/Name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>poll_interval</span><span class=p>:</span><span class=w> </span><span class=l>10s                </span><span class=w> </span><span class=c># Only read every ten seconds </span></span></span></code></pre></div></div></details><p>The reason for the delay is that the Count Connector in the OpenTelemetry Collector counts logs only within each processing interval. This means that every time the data is read, the count resets to zero for the next interval. With the default <code>Filelog reciever</code> interval of 200ms, it reads every line the loadgen writes, giving us counts of 1. With this interval we make sure we have multiple entries to count.</p><p>The Collector can maintain a running count for each read interval by omitting conditions, as shown below. However, itâ€™s best practice to let your backend handle running counts since it can track them over a longer time period.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><ul><li><strong>Add the Count Connector</strong></li></ul><p>Include the Count Connector in the connector&rsquo;s section of your configuration and define the metrics counters we want to use:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>connectors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>count</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>logs.full.count</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Running count of all logs read in interval&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>logs.sw.count</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;StarWarsCount&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>conditions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>attributes[&#34;movie&#34;] == &#34;SW&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>logs.lotr.count</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;LOTRCount&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>conditions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>attributes[&#34;movie&#34;] == &#34;LOTR&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>logs.error.count</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;ErrorCount&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>conditions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>attributes[&#34;level&#34;] == &#34;ERROR&#34;</span></span></span></code></pre></div><ul><li><p><strong>Explanation of the Metrics Counters</strong></p><ul><li><code>logs.full.count</code>: Tracks the total number of logs processed during each read interval.<br>Since this metric has no filtering conditions, every log that passes through the system is included in the count.</li><li><code>logs.sw.count</code> Counts logs that contain a quote from a Star Wars movie.</li><li><code>logs.lotr.count</code>: Counts logs that contain a quote from a Lord of the Rings movie.</li><li><code>logs.error.count</code>: Represents a real-world scenario by counting logs with a severity level of ERROR for the read interval.</li></ul></li><li><p><strong>Configure the Count Connector in the pipelines</strong><br>In the pipeline configuration below, the connector exporter is added to the <code>logs</code> section, while the connector receiver is added to the <code>metrics</code> section.</p></li></ul><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>attributes/update             </span><span class=w> </span><span class=c># Update, hash, and remove attributes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>redaction/redact              </span><span class=w> </span><span class=c># Redact sensitive fields using regex</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlphttp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>count                          </span><span class=w> </span><span class=c># Count Connector that receives count metric from logs count exporter in logs pipeline. </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#- hostmetrics                    # Host Metrics Receiver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlphttp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>filelog/quotes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>transform/logs                </span><span class=w> </span><span class=c># Transform logs processor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>count                         </span><span class=w> </span><span class=c># Count Connector that exports count as a metric to metrics pipeline.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlphttp</span></span></span></code></pre></div></div></details><p>We count logs based on their attributes. If your log data is stored in the log body instead of attributes, youâ€™ll need to use a <code>Transform</code> processor in your pipeline to extract key/value pairs and add them as attributes.</p><p>In this workshop, weâ€™ve already added <code>merge_maps(attributes, cache, "upsert")</code> in the <code>07-transform</code> section. This ensures that all relevant data is included in the log attributes for processing.</p><p>When selecting fields to create attributes from, be mindfulâ€”adding all fields indiscriminately is generally not ideal for production environments. Instead, choose only the fields that are truly necessary to avoid unnecessary data clutter.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><ul><li><strong>Validate</strong> the agent configuration using <strong><a href=https://www.otelbin.io/ rel=external target=_blank>otelbin.io</a></strong>. For reference, the <code>logs</code> and <code>metrics:</code> sections of your pipelines will look like this:</li></ul><pre class="mermaid align-center">%%{init:{&#34;fontFamily&#34;:&#34;monospace&#34;}}%%
graph LR
    %% Nodes
    REC1(otlp&lt;br&gt;fa:fa-download):::receiver
    REC2(filelog&lt;br&gt;fa:fa-download&lt;br&gt;quotes):::receiver
    REC3(otlp&lt;br&gt;fa:fa-download):::receiver
    PRO1(memory_limiter&lt;br&gt;fa:fa-microchip):::processor
    PRO2(memory_limiter&lt;br&gt;fa:fa-microchip):::processor
    PRO3(resource&lt;br&gt;fa:fa-microchip&lt;br&gt;add_mode):::processor
    PRO4(resource&lt;br&gt;fa:fa-microchip&lt;br&gt;add_mode):::processor
    PRO5(batch&lt;br&gt;fa:fa-microchip):::processor
    PRO6(batch&lt;br&gt;fa:fa-microchip):::processor
    PRO7(resourcedetection&lt;br&gt;fa:fa-microchip):::processor
    PRO8(resourcedetection&lt;br&gt;fa:fa-microchip):::processor
    PRO9(transfrom&lt;br&gt;fa:fa-microchip&lt;br&gt;logs):::processor
    EXP1(&amp;nbsp;&amp;ensp;debug&amp;nbsp;&amp;ensp;&lt;br&gt;fa:fa-upload):::exporter
    EXP2(&amp;emsp;&amp;emsp;otlphttp&amp;emsp;&amp;emsp;&lt;br&gt;fa:fa-upload):::exporter
    EXP3(&amp;nbsp;&amp;ensp;debug&amp;nbsp;&amp;ensp;&lt;br&gt;fa:fa-upload):::exporter
    EXP4(&amp;emsp;&amp;emsp;otlphttp&amp;emsp;&amp;emsp;&lt;br&gt;fa:fa-upload):::exporter
    ROUTE1(&amp;nbsp;count&amp;nbsp;&lt;br&gt;fa:fa-route):::con-export
    ROUTE2(&amp;nbsp;count&amp;nbsp;&lt;br&gt;fa:fa-route):::con-receive

    %% Links
    subID1:::sub-logs
    subID2:::sub-metrics
    subgraph &#34; &#34; 
      direction LR
      subgraph subID1[**Logs**]
      direction LR
      REC1 --&gt; PRO1
      REC2 --&gt; PRO1
      PRO1 --&gt; PRO7
      PRO7 --&gt; PRO3
      PRO3 --&gt; PRO9
      PRO9 --&gt; PRO5
      PRO5 --&gt; ROUTE1
      PRO5 --&gt; EXP1
      PRO5 --&gt; EXP2
      end
      
      subgraph subID2[**Metrics**]
      direction LR
      ROUTE1 --&gt; ROUTE2       
      ROUTE2 --&gt; PRO2
      REC3 --&gt; PRO2
      PRO2 --&gt; PRO8
      PRO8 --&gt; PRO4
      PRO4 --&gt; PRO6
      PRO6 --&gt; EXP3
      PRO6 --&gt; EXP4
      end
    end
classDef receiver,exporter fill:#8b5cf6,stroke:#333,stroke-width:1px,color:#fff;
classDef processor fill:#6366f1,stroke:#333,stroke-width:1px,color:#fff;
classDef con-receive,con-export fill:#45c175,stroke:#333,stroke-width:1px,color:#fff;
classDef sub-logs stroke:#34d399,stroke-width:1px, color:#34d399,stroke-dasharray: 3 3;
classDef sub-metrics stroke:#38bdf8,stroke-width:1px, color:#38bdf8,stroke-dasharray: 3 3;</pre></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 31, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 9. Count & Sum Connector</h1><article class=default><header class=headline></header><h1 id=91-testing-the-count-connector>9.1 Testing the Count Connector</h1><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p><strong>Start the Gateway</strong>:<br>In the <strong>Gateway terminal</strong> window navigate to the <code>[WORKSHOP]/9-sum-count</code> directory and run:</p><div class=tab-panel data-tab-group=18a2b0e80bc331172186c7e56f8e950e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=start-the-gateway class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("18a2b0e80bc331172186c7e56f8e950e","start-the-gateway")'>
<span class=tab-nav-text>Start the Gateway</span></button></div><div class=tab-content-container><div data-tab-item=start-the-gateway class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../otelcol --config<span class=o>=</span>gateway.yaml</span></span></code></pre></div></div></div></div></div><p><strong>Start the Agent</strong>:<br>In the <strong>Agent terminal</strong> window navigate to the <code>[WORKSHOP]/9-sum-count</code> directory and run:</p><div class=tab-panel data-tab-group=b04636af4900164922064dddafacee61><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=start-the-agent class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b04636af4900164922064dddafacee61","start-the-agent")'>
<span class=tab-nav-text>Start the Agent</span></button></div><div class=tab-content-container><div data-tab-item=start-the-agent class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../otelcol --config<span class=o>=</span>agent.yaml</span></span></code></pre></div></div></div></div></div><p><strong>Send 12 Logs lines with the Loadgen</strong>:<br>In the <strong>Spans terminal</strong> window navigate to the <code>[WORKSHOP]/9-sum-count</code> directory.<br>Send 12 log lines, they should be read in two intervals. Do this with the following <code>loadgen</code> command:</p><div class=tab-panel data-tab-group=1162666e230f15d22205bedff167fe33><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=loadgen class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1162666e230f15d22205bedff167fe33","loadgen")'>
<span class=tab-nav-text>Loadgen</span></button></div><div class=tab-content-container><div data-tab-item=loadgen class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../loadgen -logs -json -count <span class=m>12</span></span></span></code></pre></div></div></div></div></div><p>Both the <code>agent</code> and <code>gateway</code> will display debug information, showing they are processing data. Wait until the loadgen completes.</p><p><strong>Verify metrics have been generated</strong><br>As the logs are processed, the <strong>Agent</strong> generates metrics and forwards them to the <strong>Gateway</strong>, which then writes them to <code>gateway-metrics.out</code>.</p><p>To check if the metrics <code>logs.full.count</code>, <code>logs.sw.count</code>, <code>logs.lotr.count</code>, and <code>logs.error.count</code> are present in the output, run the following <strong>jq</strong> query:</p><div class=tab-panel data-tab-group=e785ea7ad5d25836eb3b5c49b7d63c89><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=jq-query-command class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e785ea7ad5d25836eb3b5c49b7d63c89","jq-query-command")'>
<span class=tab-nav-text>jq query command</span>
</button>
<button data-tab-item=jq-example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("e785ea7ad5d25836eb3b5c49b7d63c89","jq-example-output")'>
<span class=tab-nav-text>jq example output</span></button></div><div class=tab-content-container><div data-tab-item=jq-query-command class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>jq <span class=s1>&#39;.resourceMetrics[].scopeMetrics[].metrics[]
</span></span></span><span class=line><span class=cl><span class=s1>    | select(.name == &#34;logs.full.count&#34; or .name == &#34;logs.sw.count&#34; or .name == &#34;logs.lotr.count&#34; or .name == &#34;logs.error.count&#34;)
</span></span></span><span class=line><span class=cl><span class=s1>    | {name: .name, value: (.sum.dataPoints[0].asInt // &#34;-&#34;)}&#39;</span> gateway-metrics.out</span></span></code></pre></div></div></div><div data-tab-item=jq-example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;logs.sw.count&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;2&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;logs.lotr.count&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;2&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;logs.full.count&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;4&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;logs.error.count&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;2&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;logs.error.count&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;1&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;logs.sw.count&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;2&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;logs.lotr.count&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;6&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;logs.full.count&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;8&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><details open class="box cstyle notices primary"><summary class=box-label><i class="fa-fw fas fa-lightbulb"></i>
Tip</summary><div class=box-content><p>Note: the <code>logs.full.count</code> normally is equal to <code>logs.sw.count</code> + <code>logs.lotr.count</code>, while the <code>logs.error.count</code> will be a random number.</p></div></details><details open class="box cstyle notices important"><summary class=box-label><i class="fa-fw fas fa-bolt"></i>
Important</summary><div class=box-content><p>Stop the <code>agent</code> and the <code>gateway</code> processes by pressing <code>Ctrl-C</code> in their respective terminals.</p></div></details></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 13, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=create-metrics-with-sum-connector>Create metrics with Sum Connector</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<p>In this section, weâ€™ll explore how the <a href=https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/connector/sumconnector rel=external target=_blank><strong>Sum Connector</strong></a> can extract values from spans and convert them into metrics.</p><p>Weâ€™ll specifically use the credit card charges from our base spans and leverage the Sum Connector to retrieve the total charges as a metric.</p><p>The connector can be used to collect (<strong>sum</strong>) attribute values from spans, span events, metrics, data points, and log records. It captures each individual value, transforms it into a metric, and passes it along. However, itâ€™s the <strong>backendâ€™s</strong> job to use these metrics and their attributes for calculations and further processing.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p>Switch to your <strong>Agent terminal</strong> window and open the <code>agent.yaml</code> file in your editor.</p><ul><li><strong>Add the Sum Connector</strong><br>Include the Sum Connector in the connectors section of your configuration and define the metrics counters:</li></ul><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>sum</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spans</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nt>user.card-charge</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>source_attribute</span><span class=p>:</span><span class=w> </span><span class=l>payment.amount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>conditions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>attributes[&#34;payment.amount&#34;] != &#34;NULL&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>attributes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>user.name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span></span></span></code></pre></div></div></details><p>In the example above, we check for the <code>payment.amount</code> attribute in spans. If it has a valid value, the <strong>Sum</strong> connector generates a metric called <code>user.card-charge</code> and includes the <code>user.name</code> as an attribute. This enables the backend to track and display a userâ€™s total charges over an extended period, such as a billing cycle.</p><p>In the pipeline configuration below, the connector exporter is added to the traces section, while the connector receiver is added to the metrics section.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><ul><li><strong>Configure the Count Connector in the pipelines</strong></li></ul><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>attributes/update             </span><span class=w> </span><span class=c># Update, hash, and remove attributes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>redaction/redact              </span><span class=w> </span><span class=c># Redact sensitive fields using regex</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlphttp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>sum                           </span><span class=w> </span><span class=c># Sum connector which aggregates payment.amount from spans and sends to metrics pipeline</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>sum                           </span><span class=w> </span><span class=c># Receives metrics from the sum exporter in the traces pipeline</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>count                         </span><span class=w> </span><span class=c># Receives count metric from logs count exporter in logs pipeline. </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#- hostmetrics                   # Host Metrics Receiver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlphttp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>filelog/quotes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>transform/logs                </span><span class=w> </span><span class=c># Transform logs processor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>count                         </span><span class=w> </span><span class=c># Count Connector that exports count as a metric to metrics pipeline.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlphttp</span></span></span></code></pre></div><ul><li><strong>Validate</strong> the agent configuration using <strong><a href=https://www.otelbin.io/ rel=external target=_blank>otelbin.io</a></strong>. For reference, the <code>traces</code> and <code>metrics:</code> sections of your pipelines will look like this:</li></ul><pre class="mermaid align-center">%%{init:{&#34;fontFamily&#34;:&#34;monospace&#34;}}%%
graph LR
    %% Nodes
    REC1(otlp&lt;br&gt;fa:fa-download&lt;br&gt; ):::receiver
    REC3(otlp&lt;br&gt;fa:fa-download&lt;br&gt; ):::receiver
    PRO1(memory_limiter&lt;br&gt;fa:fa-microchip&lt;br&gt; ):::processor
    PRO2(memory_limiter&lt;br&gt;fa:fa-microchip&lt;br&gt; ):::processor
    PRO3(resource&lt;br&gt;fa:fa-microchip&lt;br&gt;add_mode):::processor
    PRO4(resource&lt;br&gt;fa:fa-microchip&lt;br&gt;add_mode):::processor
    PRO5(batch&lt;br&gt;fa:fa-microchip&lt;br&gt; ):::processor
    PRO6(batch&lt;br&gt;fa:fa-microchip&lt;br&gt; ):::processor
    PRO7(resourcedetection&lt;br&gt;fa:fa-microchip&lt;br&gt; ):::processor
    PRO8(resourcedetection&lt;br&gt;fa:fa-microchip&lt;br&gt;):::processor

    PROA(attributes&lt;br&gt;fa:fa-microchip&lt;br&gt;redact):::processor
    PROB(redaction&lt;br&gt;fa:fa-microchip&lt;br&gt;update):::processor
    EXP1(&amp;nbsp;&amp;ensp;debug&amp;nbsp;&amp;ensp;&lt;br&gt;fa:fa-upload&lt;br&gt; ):::exporter
    EXP2(&amp;emsp;&amp;emsp;file&amp;emsp;&amp;emsp;&lt;br&gt;fa:fa-upload&lt;br&gt; ):::exporter
    EXP3(&amp;nbsp;&amp;ensp;debug&amp;nbsp;&amp;ensp;&lt;br&gt;fa:fa-upload&lt;br&gt; ):::exporter
    EXP4(&amp;emsp;&amp;emsp;otlphttp&amp;emsp;&amp;emsp;&lt;br&gt;fa:fa-upload&lt;br&gt; ):::exporter
    EXP5(&amp;emsp;&amp;emsp;otlphttp&amp;emsp;&amp;emsp;&lt;br&gt;fa:fa-upload&lt;br&gt; ):::exporter
    ROUTE1(&amp;nbsp;sum&amp;nbsp;&lt;br&gt;fa:fa-route&lt;br&gt; ):::con-export
    ROUTE2(&amp;nbsp;count&amp;nbsp;&lt;br&gt;fa:fa-route&lt;br&gt; ):::con-receive
    ROUTE3(&amp;nbsp;sum&amp;nbsp;&lt;br&gt;fa:fa-route&lt;br&gt; ):::con-receive

    %% Links
    subID1:::sub-traces
    subID2:::sub-metrics
    subgraph &#34; &#34; 
      direction LR
      subgraph subID1[**Traces**]
      direction LR
      REC1 --&gt; PRO1
      PRO1 --&gt; PROA
      PROA --&gt; PROB
      PROB --&gt; PRO7
      PRO7 --&gt; PRO3
      PRO3 --&gt; PRO5 
      PRO5 --&gt; EXP1
      PRO5 --&gt; EXP2
      PRO5 --&gt; EXP5
      PRO5 --&gt; ROUTE1
      end
      
      subgraph subID2[**Metrics**]
      direction LR
      ROUTE1 --&gt; ROUTE3
      ROUTE3 --&gt; PRO2       
      ROUTE2 --&gt; PRO2
      REC3 --&gt; PRO2
      PRO2 --&gt; PRO8
      PRO8 --&gt; PRO4
      PRO4 --&gt; PRO6
      PRO6 --&gt; EXP3
      PRO6 --&gt; EXP4
      end
    end
classDef receiver,exporter fill:#8b5cf6,stroke:#333,stroke-width:1px,color:#fff;
classDef processor fill:#6366f1,stroke:#333,stroke-width:1px,color:#fff;
classDef con-receive,con-export fill:#45c175,stroke:#333,stroke-width:1px,color:#fff;
classDef sub-logs stroke:#34d399,stroke-width:1px, color:#34d399,stroke-dasharray: 3 3;
classDef sub-traces stroke:#fbbf24,stroke-width:1px, color:#fbbf24,stroke-dasharray: 3 3;
classDef sub-metrics stroke:#38bdf8,stroke-width:1px, color:#38bdf8,stroke-dasharray: 3 3;</pre></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 31, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=93-testing-the-count-connector>9.3 Testing the Count Connector</h1><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p><strong>Start the Gateway</strong>:<br>In the <strong>Gateway terminal</strong> window navigate to the <code>[WORKSHOP]/9-sum-count</code> directory and run:</p><div class=tab-panel data-tab-group=de63bbfc0158d4fba373733debcfefbb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=start-the-gateway class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("de63bbfc0158d4fba373733debcfefbb","start-the-gateway")'>
<span class=tab-nav-text>Start the Gateway</span></button></div><div class=tab-content-container><div data-tab-item=start-the-gateway class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../otelcol --config<span class=o>=</span>gateway.yaml</span></span></code></pre></div></div></div></div></div><p><strong>Start the Agent</strong>:<br>In the <strong>Agent terminal</strong> window navigate to the <code>[WORKSHOP]/9-sum-count</code> directory and run:</p><div class=tab-panel data-tab-group=072b718b617b3163e05ae316aab10def><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=start-the-agent class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("072b718b617b3163e05ae316aab10def","start-the-agent")'>
<span class=tab-nav-text>Start the Agent</span></button></div><div class=tab-content-container><div data-tab-item=start-the-agent class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../otelcol --config<span class=o>=</span>agent.yaml</span></span></code></pre></div></div></div></div></div><p><strong>Start the Loadgen</strong>:<br>In the <strong>Spans terminal</strong> window navigate to the <code>[WORKSHOP]/9-sum-count</code> directory. Send 8 spans with the following <code>loadgen</code> command:</p><div class=tab-panel data-tab-group=767d80eb48d71b24a1ae8535b4184573><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=loadgen class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("767d80eb48d71b24a1ae8535b4184573","loadgen")'>
<span class=tab-nav-text>Loadgen</span></button></div><div class=tab-content-container><div data-tab-item=loadgen class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../loadgen -count <span class=m>8</span></span></span></code></pre></div></div></div></div></div><p>Both the <code>agent</code> and <code>gateway</code> will display debug information, showing they are processing data. Wait until the loadgen completes.</p><p><strong>Verify that metrics</strong><br>While processing the span, the <strong>Agent</strong>, has generated metrics and passed them on to the <strong>Gateway</strong>. The <strong>Gateway</strong> has written them into <code>gateway-metrics.out</code>.</p><p>To confirm the presence of <code>user.card-charge</code>and verify each one has an attribute <code>user.name</code> in the metrics output, run the following jq query:</p><div class=tab-panel data-tab-group=76d234bc4fc1886e8384a60f5a6bc321><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=jq-query-command class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("76d234bc4fc1886e8384a60f5a6bc321","jq-query-command")'>
<span class=tab-nav-text>jq query command</span>
</button>
<button data-tab-item=jq-example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("76d234bc4fc1886e8384a60f5a6bc321","jq-example-output")'>
<span class=tab-nav-text>jq example output</span></button></div><div class=tab-content-container><div data-tab-item=jq-query-command class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>jq -r <span class=s1>&#39;.resourceMetrics[].scopeMetrics[].metrics[] | select(.name == &#34;user.card-charge&#34;) | .sum.dataPoints[] | &#34;\(.attributes[] | select(.key == &#34;user.name&#34;).value.stringValue)\t\(.asDouble)&#34;&#39;</span> gateway-metrics.out <span class=p>|</span> <span class=k>while</span> <span class=nv>IFS</span><span class=o>=</span><span class=s1>$&#39;\t&#39;</span> <span class=nb>read</span> -r name charge<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=nb>printf</span> <span class=s2>&#34;%-20s %s\n&#34;</span> <span class=s2>&#34;</span><span class=nv>$name</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$charge</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>done</span>    </span></span></code></pre></div></div></div><div data-tab-item=jq-example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>George Lucas         67.49
</span></span><span class=line><span class=cl>Frodo Baggins        87.14
</span></span><span class=line><span class=cl>Thorin Oakenshield   90.98
</span></span><span class=line><span class=cl>Luke Skywalker       51.37
</span></span><span class=line><span class=cl>Luke Skywalker       65.56
</span></span><span class=line><span class=cl>Thorin Oakenshield   67.5
</span></span><span class=line><span class=cl>Thorin Oakenshield   66.66
</span></span><span class=line><span class=cl>Peter Jackson        94.39</span></span></code></pre></div></div></div></div></div><details open class="box cstyle notices important"><summary class=box-label><i class="fa-fw fas fa-bolt"></i>
Important</summary><div class=box-content><p>Stop the <code>agent</code> and the <code>gateway</code> processes by pressing <code>Ctrl-C</code> in their respective terminals.</p></div></details></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 14, 2025</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=wrap-up>Wrap-up</h1><p><a href=#R-image-7128ec3af37ce2d807715af07dff7aec class=lightbox-link><img alt="Well done" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/welldone.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-7128ec3af37ce2d807715af07dff7aec><img alt="Well done" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/welldone.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 12, 2025</span></span></footer></article></section></section><article class=default><header class=headline></header><h1 id=splunk-synthetic-scripting>Splunk Synthetic Scripting</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>45 minutes</span>
</span>&nbsp;
<span class="badge cstyle blue badge-with-title"><span class=badge-title class=text-muted>Author
</span><span class=badge-content>Robert Castley</span></span><p>Proactively monitor the performance of your web app before problems affect your users. With <strong>Splunk Synthetic Monitoring</strong>, technical and business teams create detailed tests to proactively monitor the speed and reliability of websites, web apps, and resources over time, at any stage in the development cycle.</p><p><strong>Splunk Synthetic Monitoring</strong> offers the most comprehensive and in-depth capabilities for uptime and web performance optimization as part of the only complete observability suite, Splunk Observability Cloud.</p><p>Easily set up monitoring for APIs, service endpoints and end-user experience. With <strong>Splunk Synthetic Monitoring</strong>, go beyond basic uptime and performance monitoring and focus on proactively finding and fixing issues, optimizing web performance, and ensuring customers get the best user experience.</p><p>With <strong>Splunk Synthetic Monitoring</strong> you can:</p><ul><li>Detect and resolve issues fast across critical user flows, business transactions and API endpoints</li><li>Prevent web performance issues from affecting customers with an intelligent web optimization engine</li><li>And improve the performance of all page resources and third-party dependencies</li></ul><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><section><h1 class=a11y-only>Subsections of Splunk Synthetic Scripting</h1><article class=default><header class=headline></header><h1 id=1-real-browser-test>1. Real Browser Test</h1><h2 id=introduction>Introduction</h2><p>This workshop walks you through using the <a href=https://developer.chrome.com/docs/devtools/recorder/ rel=external target=_blank>Chrome DevTools Recorder</a> to create a synthetic transaction against a Splunk demonstration instance.</p><p>The exported JSON from the Chrome DevTools Recorder will then be used to create a Splunk Synthetic Monitoring Real Browser Test.</p><p>In addition, you will also get to learn other Splunk Synthetic Monitoring checks like <a href=https://docs.splunk.com/Observability/synthetics/api-test/api-test.html rel=external target=_blank>API Test</a> and <a href=https://docs.splunk.com/Observability/synthetics/uptime-test/uptime-test.html rel=external target=_blank>Uptime Test</a>.</p><h2 id=pre-requisites>Pre-requisites</h2><ul><li>Google Chrome Browser installed</li><li>Access to Splunk Observability Cloud</li></ul><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><section><h1 class=a11y-only>Subsections of 1. Real Browser Test</h1><article class=default><header class=headline></header><h1 id=11-recording-a-test>1.1 Recording a test</h1><h2 id=open-the-starting-url>Open the starting URL</h2><p>Open the starting URL for the workshop in Chrome. Click on the appropriate link below to open the site in a new tab.</p><details open class="box cstyle notices note"><summary class=box-label><i class="fa-fw fas fa-exclamation-circle"></i>
Note</summary><div class=box-content><p>The starting URL for the workshop is different for <strong>EMEA</strong> and <strong>AMER/APAC</strong>. Please use the correct URL for your region.</p><div class=tab-panel data-tab-group=11e1a4584d32f026e207b7d47bd8531c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=emea-workshop-url class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("11e1a4584d32f026e207b7d47bd8531c","emea-workshop-url")'>
<span class=tab-nav-text>EMEA Workshop URL</span>
</button>
<button data-tab-item=amerapac-workshop-url class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("11e1a4584d32f026e207b7d47bd8531c","amerapac-workshop-url")'>
<span class=tab-nav-text>AMER/APAC Workshop URL</span></button></div><div class=tab-content-container><div data-tab-item=emea-workshop-url class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><p><a href=https://online-boutique-eu.splunko11y.com/ rel=external target=_blank>https://online-boutique-eu.splunko11y.com/</a></p></div></div><div data-tab-item=amerapac-workshop-url class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><p><a href=https://online-boutique-us.splunko11y.com/ rel=external target=_blank>https://online-boutique-us.splunko11y.com/</a></p></div></div></div></div></div></details><h2 id=open-the-chrome-devtools-recorder>Open the Chrome DevTools Recorder</h2><p>Next, open the Developer Tools (in the new tab that was opened above) by pressing <code>Ctrl + Shift + I</code> on Windows or <code>Cmd + Option + I</code> on a Mac, then select <strong>Recorder</strong> from the top-level menu or the <strong>More tools</strong> flyout menu.</p><p><a href=#R-image-a7add119e689f728b643d0bcc86b988e class=lightbox-link><img alt="Open Recorder" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../img/open-recorder.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-a7add119e689f728b643d0bcc86b988e><img alt="Open Recorder" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../img/open-recorder.png></a></p><details open class="box cstyle notices info"><summary class=box-label><i class="fa-fw fas fa-info-circle"></i>
Note</summary><div class=box-content><p>Site elements might change depending on viewport width. Before recording, set your browser window to the correct width for the test you want to create (Desktop, Tablet, or Mobile). Change the DevTools &ldquo;dock side&rdquo; to pop out as a separate window if it helps.</p></div></details><h2 id=create-a-new-recording>Create a new recording</h2><p>With the Recorder panel open in the DevTools window. Click on the <span class="btn cstyle blue"><span><span class=title>Create a new recording</span></span></span> button to start.</p><p><a href=#R-image-1148a2f2d441ffe3d5abdda51f79715d class=lightbox-link><img alt=Recorder class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../img/recorder.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-1148a2f2d441ffe3d5abdda51f79715d><img alt=Recorder class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../img/recorder.png></a></p><p>For the <strong>Recording Name</strong> use your initials to prefix the name of the recording e.g. <strong><code>&lt;your initials></code> - Online Boutique</strong>. Click on <strong>Start Recording</strong> to start recording your actions.</p><p><a href=#R-image-e09bdfcfb3eb5588a91c1ad2800483e3 class=lightbox-link><img alt="Recording Name" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../img/recording-name.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e09bdfcfb3eb5588a91c1ad2800483e3><img alt="Recording Name" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../img/recording-name.png></a></p><p>Now that we are recording, complete the following actions on the site:</p><ul><li>Click on <strong>Vintage Camera Lens</strong></li><li>Click on <strong>Add to Cart</strong></li><li>Click on <strong>Place Order</strong></li><li>Click on <strong>End recording</strong> in the Recorder panel.</li></ul><p><a href=#R-image-8401b273959746cd2cb2493f181dab87 class=lightbox-link><img alt="End Recording" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../img/end-recording.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8401b273959746cd2cb2493f181dab87><img alt="End Recording" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../img/end-recording.png></a></p><h2 id=exporting-the-recording>Exporting the recording</h2><p>Click on the <strong>Export</strong> button:</p><p><a href=#R-image-593421615a3a1ad61c995128ad28af8e class=lightbox-link><img alt="Export button" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../img/export-button.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-593421615a3a1ad61c995128ad28af8e><img alt="Export button" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../img/export-button.png></a></p><p>Select <strong>JSON</strong> as the format, then click on <strong>Save</strong></p><p><a href=#R-image-e583f50498d9a90eaa8520a7da04775c class=lightbox-link><img alt="Export JSON" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../img/export-json.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e583f50498d9a90eaa8520a7da04775c><img alt="Export JSON" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../img/export-json.png></a></p><p><a href=#R-image-900d88d48dc1529ad6629a77c15560c1 class=lightbox-link><img alt="Save JSON" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../img/save-json.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-900d88d48dc1529ad6629a77c15560c1><img alt="Save JSON" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../img/save-json.png></a></p><p><strong>Congratulations!</strong> You have successfully created a recording using the Chrome DevTools Recorder. Next, we will use this recording to create a Real Browser Test in Splunk Synthetic Monitoring.</p><hr><details class="box cstyle notices transparent expand"><summary class=box-label><i class="expander-icon fa-fw fas fa-chevron-right"></i>
Click here to view the JSON file</summary><div class=box-content><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;title&#34;</span><span class=p>:</span> <span class=s2>&#34;RWC - Online Boutique&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;steps&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;setViewport&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;width&#34;</span><span class=p>:</span> <span class=mi>1430</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;height&#34;</span><span class=p>:</span> <span class=mi>1016</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;deviceScaleFactor&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;isMobile&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;hasTouch&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;isLandscape&#34;</span><span class=p>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;navigate&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;url&#34;</span><span class=p>:</span> <span class=s2>&#34;https://online-boutique-eu.splunko11y.com/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;assertedEvents&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;navigation&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;url&#34;</span><span class=p>:</span> <span class=s2>&#34;https://online-boutique-eu.splunko11y.com/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;title&#34;</span><span class=p>:</span> <span class=s2>&#34;Online Boutique&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;click&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;target&#34;</span><span class=p>:</span> <span class=s2>&#34;main&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;selectors&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;div:nth-of-type(2) &gt; div:nth-of-type(2) a &gt; div&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;xpath//html/body/main/div/div/div[2]/div[2]/div/a/div&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;pierce/div:nth-of-type(2) &gt; div:nth-of-type(2) a &gt; div&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;offsetY&#34;</span><span class=p>:</span> <span class=mi>170</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;offsetX&#34;</span><span class=p>:</span> <span class=mi>180</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;assertedEvents&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;navigation&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;url&#34;</span><span class=p>:</span> <span class=s2>&#34;https://online-boutique-eu.splunko11y.com/product/66VCHSJNUP&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;title&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;click&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;target&#34;</span><span class=p>:</span> <span class=s2>&#34;main&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;selectors&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;aria/ADD TO CART&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;button&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;xpath//html/body/main/div[1]/div/div[2]/div/form/div/button&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;pierce/button&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;text/Add to Cart&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;offsetY&#34;</span><span class=p>:</span> <span class=mf>35.0078125</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;offsetX&#34;</span><span class=p>:</span> <span class=mf>46.4140625</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;assertedEvents&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;navigation&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;url&#34;</span><span class=p>:</span> <span class=s2>&#34;https://online-boutique-eu.splunko11y.com/cart&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;title&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;click&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;target&#34;</span><span class=p>:</span> <span class=s2>&#34;main&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;selectors&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;aria/PLACE ORDER&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;div &gt; div &gt; div.py-3 button&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;xpath//html/body/main/div/div/div[4]/div/form/div[4]/button&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;pierce/div &gt; div &gt; div.py-3 button&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;text/Place order&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;offsetY&#34;</span><span class=p>:</span> <span class=mf>29.8125</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;offsetX&#34;</span><span class=p>:</span> <span class=mf>66.8203125</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;assertedEvents&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;navigation&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;url&#34;</span><span class=p>:</span> <span class=s2>&#34;https://online-boutique-eu.splunko11y.com/cart/checkout&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;title&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=12-create-real-browser-test>1.2 Create Real Browser Test</h1><p>In Splunk Observability Cloud, navigate to <strong>Synthetics</strong> and click on <span class="btn cstyle blue"><span><span class=title>Add new test</span></span></span>.</p><p>From the dropdown select <strong>Browser test</strong>.</p><p><a href=#R-image-6c33d49d3641380d5f915b006a83b11a class=lightbox-link><img alt="Add new test" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../img/add-new-test.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-6c33d49d3641380d5f915b006a83b11a><img alt="Add new test" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../img/add-new-test.png></a></p><p>You will then be presented with the <strong>Browser test content</strong> configuration page.</p><p><a href=#R-image-3d95dbe3e6dcad697a0f7cea7d4198f6 class=lightbox-link><img alt="New Test" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../img/new-test.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-3d95dbe3e6dcad697a0f7cea7d4198f6><img alt="New Test" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../img/new-test.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=13-import-json>1.3 Import JSON</h1><p>To begin configuring our test, we need to import the JSON that we exported from the Chrome DevTools Recorder. To enable the <span class="btn cstyle transparent"><span><span class=title><strong>Import</strong></span></span></span> button, we must first give our test a name e.g. <strong><code>&lt;your initials></code> - Online Boutique</strong>.</p><p><a href=#R-image-c00cd3c7693b99ec5e6110ca1ff29bd1 class=lightbox-link><img alt=Import class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../img/import.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c00cd3c7693b99ec5e6110ca1ff29bd1><img alt=Import class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../img/import.png></a></p><p>Once the <span class="btn cstyle transparent"><span><span class=title><strong>Import</strong></span></span></span> button is enabled, click on it and either drop the JSON file that you exported from the Chrome DevTools Recorder or upload the file.</p><p><a href=#R-image-30e2642b16123c15baf61b054d8c66af class=lightbox-link><img alt="Import JSON" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../img/import-json.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-30e2642b16123c15baf61b054d8c66af><img alt="Import JSON" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../img/import-json.png></a></p><p>Once the JSON file has been uploaded, click on <span class="btn cstyle blue"><span><span class=title>Continue to edit steps</span></span></span></p><p><a href=#R-image-0189e8dbb56d543dc7d2020d8c9e35dc class=lightbox-link><img alt="Import Complete" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../img/import-complete.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-0189e8dbb56d543dc7d2020d8c9e35dc><img alt="Import Complete" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../img/import-complete.png></a></p><p><a href=#R-image-096bcfefa21020dc5cc759acc6b982e3 class=lightbox-link><img alt="Edit Steps" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../img/edit-steps.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-096bcfefa21020dc5cc759acc6b982e3><img alt="Edit Steps" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../img/edit-steps.png></a></p><p>Before we make any edits to the test, let&rsquo;s first configure the settings, click on <span class="btn cstyle blue"><span><span class=title>&lt; Return to test</span></span></span></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=14-settings>1.4 Settings</h1><p>The simple settings allow you to configure the basics of the test:</p><ul><li><strong>Name</strong>: The name of the test (e.g. RWC - Online Boutique).</li><li><strong>Details</strong>:<ul><li><strong>Locations</strong>: The locations where the test will run from.</li><li><strong>Device</strong>: Emulate different devices and connection speeds. Also, the viewport will be adjusted to match the chosen device.</li><li><strong>Frequency</strong>: How often the test will run.</li><li><strong>Round-robin</strong>: If multiple locations are selected, the test will run from one location at a time, rather than all locations at once.</li><li><strong>Active</strong>: Set the test to active or inactive.</li></ul></li></ul><p>![Return to Test]For this workshop, we will configure the locations that we wish to monitor from. Click in the <strong>Locations</strong> field and you will be presented with a list of global locations (over 50 in total).</p><p><a href=#R-image-30b0b665ddbca6825b6b6e8fca29e568 class=lightbox-link><img alt="Global Locations" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../img/global-locations.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-30b0b665ddbca6825b6b6e8fca29e568><img alt="Global Locations" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../img/global-locations.png></a></p><p>Select the following locations:</p><ul><li><strong>AWS - N. Virginia</strong></li><li><strong>AWS - London</strong></li><li><strong>AWS - Melbourne</strong></li></ul><p>Once complete, scroll down and click on Click on <span class="btn cstyle blue"><span><span class=title>Submit</span></span></span> to save the test.</p><p>The test will now be scheduled to run every 5 minutes from the 3 locations that we have selected. This does take a few minutes for the schedule to be created.</p><p>So whilst we wait for the test to be scheduled, click on <span class="btn cstyle transparent"><span><span class=title>Edit test</span></span></span> so we can go through the Advanced settings.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=15-advanced-settings>1.5 Advanced Settings</h1><p>Click on <strong>Advanced</strong>, these settings are optional and can be used to further configure the test.</p><details open class="box cstyle notices note"><summary class=box-label><i class="fa-fw fas fa-exclamation-circle"></i>
Note</summary><div class=box-content><p>In the case of this workshop, we will <strong>not</strong> be using any of these settings as this is for informational purposes only.</p></div></details><p><a href=#R-image-04884db4f9342a8b7d8c088bb47e794f class=lightbox-link><img alt="Advanced Settings" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../img/advanced-settings.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-04884db4f9342a8b7d8c088bb47e794f><img alt="Advanced Settings" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../img/advanced-settings.png></a></p><ul><li><strong>Security</strong>:<ul><li><strong>TLS/SSL validation</strong>: When activated, this feature is used to enforce the validation of expired, invalid hostname, or untrusted issuer on SSL/TLS certificates.</li><li><strong>Authentication</strong>: Add credentials to authenticate with sites that require additional security protocols, for example from within a corporate network. By using <a href=https://docs.splunk.com/Observability/synthetics/test-config/global-variables.html rel=external target=_blank>concealed global variables</a> in the Authentication field, you create an additional layer of security for your credentials and simplify the ability to share credentials across checks.</li></ul></li><li><strong>Custom Content</strong>:<ul><li><strong>Custom headers</strong>: Specify custom headers to send with each request. For example, you can add a header in your request to filter out requests from analytics on the back end by sending a specific header in the requests. You can also use custom headers to set cookies.</li><li><strong>Cookies</strong>: Set cookies in the browser before the test starts. For example, to prevent a popup modal from randomly appearing and interfering with your test, you can set cookies. Any cookies that are set will apply to the domain of the starting URL of the check. Splunk Synthetics Monitoring uses the public suffix list to determine the domain.</li><li><strong>Host overrides</strong>: Add host override rules to reroute requests from one host to another. For example, you can create a host override to test an existing production site against page resources loaded from a development site or a specific CDN edge node.</li></ul></li></ul><p>Next, we will edit the test steps to provide more meaningful names for each step.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=16-edit-test-steps>1.6 Edit test steps</h1><p>To edit the steps click on the <span class="btn cstyle transparent"><span><span class=title>+ Edit steps or synthetic transactions</span></span></span> button. From here, we are going to give meaningful names to each step.</p><p><a href=#R-image-f754fc334b7bd3544ebc800c78f5a3b5 class=lightbox-link><img alt="Edit steps" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../img/edit-steps.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-f754fc334b7bd3544ebc800c78f5a3b5><img alt="Edit steps" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../img/edit-steps.png></a></p><p>For each of the four steps, we are going to give them a meaningful name.</p><ul><li><strong>Step 1</strong> replace the text <strong>Go to URL</strong> with <strong>HomePage - Online Boutique</strong></li><li><strong>Step 2</strong> enter the text <strong>Select Vintage Camera Lens</strong>.</li><li><strong>Step 3</strong> enter <strong>Add to Cart</strong>.</li><li><strong>Step 4</strong> enter <strong>Place Order</strong>.</li></ul><p><a href=#R-image-be9b793c49ffccc8f84c7edbb21b8011 class=lightbox-link><img alt="Step names" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../img/step-names.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-be9b793c49ffccc8f84c7edbb21b8011><img alt="Step names" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../img/step-names.png></a></p><p>Click <span class="btn cstyle blue"><span><span class=title>&lt; Return to test</span></span></span> to return to the test configuration page and click <span class="btn cstyle blue"><span><span class=title>Save</span></span></span> to save the test.</p><p>You will be returned to the test dashboard where you will see test results start to appear.</p><p><a href=#R-image-9197cd4ad83379e42f76cee820c498a8 class=lightbox-link><img alt=Scatterplot class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../img/scatterplot.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-9197cd4ad83379e42f76cee820c498a8><img alt=Scatterplot class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../img/scatterplot.png></a></p><p><strong>Congratulations!</strong> You have successfully created a Real Browser Test in Splunk Synthetic Monitoring. Next, we will look into a test result in more detail.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=17-view-test-results>1.7 View test results</h1><p>In the Scatterplot from the previous step, click on one of the dots to drill into the test run data. Preferably, select the most recent test run (farthest to the right).</p><p><a href=#R-image-065f17d696373eaade0f9e4c3d1ad376 class=lightbox-link><img alt=Drilldown class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../img/drilldown.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-065f17d696373eaade0f9e4c3d1ad376><img alt=Drilldown class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../img/drilldown.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=api-test>API Test</h1><p>The API Test provides a flexible way to check the functionality and performance of API endpoints. The shift toward API-first development has magnified the necessity to monitor the back-end services that provide your core front-end functionality.</p><p>Whether you&rsquo;re interested in testing the multi-step API interactions or you want to gain visibility into the performance of your endpoints, the API Test can help you accomplish your goals.</p><p><a href=#R-image-1fe92f6d00e011488ec7fcf1ae720a19 class=lightbox-link><img alt="API test result" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../img/api-test-result.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-1fe92f6d00e011488ec7fcf1ae720a19><img alt="API test result" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../img/api-test-result.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><section><h1 class=a11y-only>Subsections of 2. API Test</h1><article class=default><header class=headline></header><h1 id=global-variables>Global Variables</h1><h2 id=global-variables>Global Variables</h2><p>View the global variable that we&rsquo;ll use to perform our API test. Click on <strong>Global Variables</strong> under the cog. The global variable named <code>env.encoded_auth</code> will be the one that we&rsquo;ll use to build the spotify API transaction.</p><p><a href=#R-image-907e523e34e2b0555a919651e486444a class=lightbox-link><img alt=placeholder class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../img/global-variables.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-907e523e34e2b0555a919651e486444a><img alt=placeholder class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../img/global-variables.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=create-new-api-test>Create new API test</h1><h2 id=create-a-new-api-test>Create a new API test</h2><p>Create a new API test by clicking on the <span class="btn cstyle blue"><span><span class=title>Add new test</span></span></span> button and select <strong>API test</strong> from the dropdown. Name the test using <strong>your initials</strong> followed by <strong>Spotify API</strong> e.g. <strong>RWC - Spotify API</strong></p><p><a href=#R-image-19f410130930391c880fbb66c2fd00b5 class=lightbox-link><img alt=placeholder class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../img/new-api-check.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-19f410130930391c880fbb66c2fd00b5><img alt=placeholder class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../img/new-api-check.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=authentication-request>Authentication Request</h1><h2 id=add-authentication-request>Add Authentication Request</h2><p>Click on <span class="btn cstyle transparent"><span><span class=title>+ Add requests</span></span></span> and enter the request step name e.g. <strong>Authenticate with Spotify API</strong>.</p><p><a href=#R-image-4bd7f0d52b8a1d39d1b92db77da32b9d class=lightbox-link><img alt=placeholder class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../img/add-request.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-4bd7f0d52b8a1d39d1b92db77da32b9d><img alt=placeholder class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../img/add-request.png></a></p><p>Expand the Request section, from the drop-down change the request method to <strong>POST</strong> and enter the following URL:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>https://accounts.spotify.com/api/token</span></span></code></pre></div><p>In the <strong>Payload body</strong> section enter the following:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>grant_type=client_credentials</span></span></code></pre></div><p>Next, add two request headers with the following key/value pairings:</p><ul><li><strong>CONTENT-TYPE: application/x-www-form-urlencoded</strong></li><li><strong>AUTHORIZATION: Basic {{env.encoded_auth}}</strong></li></ul><p>Expand the <strong>Validation</strong> section and add the following extraction:</p><ul><li><strong>Extract</strong> from <strong>Response body</strong> <strong>JSON</strong> <strong>$.access_token</strong> <strong>as</strong> <strong>access_token</strong>.</li></ul><p>This will parse the JSON payload that is received from the Spotify API, extract the access token and store it as a custom variable.</p><p><a href=#R-image-1f3895451874de8d51fea5080ca6cfa4 class=lightbox-link><img alt="Add payload token" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../img/add-payload-token.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-1f3895451874de8d51fea5080ca6cfa4><img alt="Add payload token" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../img/add-payload-token.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=search-request>Search Request</h1><h2 id=add-search-request>Add Search Request</h2><p>Click on <span class="btn cstyle transparent"><span><span class=title>+ Add Request</span></span></span> to add the next step. Name the step <strong>Search for Tracks named &ldquo;Up around the bend&rdquo;</strong>.</p><p>Expand the <strong>Request</strong> section and change the request method to <strong>GET</strong> and enter the following URL:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>https://api.spotify.com/v1/search?q=Up%20around%20the%20bend&amp;type=track&amp;offset=0&amp;limit=5</span></span></code></pre></div><p>Next, add two request headers with the following key/value pairings:</p><ul><li><strong>CONTENT-TYPE: application/json</strong></li><li><strong>AUTHORIZATION: Bearer {{custom.access_token}}</strong></li></ul><p><a href=#R-image-5bbfc6c67a82f6d4c6b9ce96497c1c8f class=lightbox-link><img alt="Add search request" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../img/add-search-request.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5bbfc6c67a82f6d4c6b9ce96497c1c8f><img alt="Add search request" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../img/add-search-request.png></a></p><p>Expand the <strong>Validation</strong> section and add the following extraction:</p><ul><li><strong>Extract</strong> from <strong>Response body</strong> <strong>JSON</strong> <strong>$.tracks.items[0].id</strong> <strong>as</strong> <strong>track.id</strong>.</li></ul><p><a href=#R-image-01c2a6393695edb8f59ba409b009c204 class=lightbox-link><img alt="Add search payload" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../img/add-search-payload.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-01c2a6393695edb8f59ba409b009c204><img alt="Add search payload" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../img/add-search-payload.png></a></p><p>Click on <span class="btn cstyle blue"><span><span class=title>< Return to test</span></span></span> to return to the test configuration page. And then click <span class="btn cstyle blue"><span><span class=title>Save</span></span></span> to save the API test.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=view-results>View results</h1><h2 id=view-results>View results</h2><p>Wait for a few minutes for the test to provision and run. Once you see the test has run successfully, click on the run to view the test results:</p><p><a href=#R-image-a617d5ab3d16b0cdcd6995c1ae832f45 class=lightbox-link><img alt="API test result" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../img/api-test-result.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-a617d5ab3d16b0cdcd6995c1ae832f45><img alt="API test result" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../img/api-test-result.png></a></p><h2 id=6-resources>6. Resources</h2><ul><li><p><a href=https://docs.splunk.com/Observability/synthetics/api-test/set-up-api-test.html rel=external target=_blank>How to Create an API Test</a></p></li><li><p><a href=https://docs.splunk.com/Observability/synthetics/api-test/api-test.html rel=external target=_blank>API Test Overview</a></p></li></ul><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article></section></section><article class=default><header class=headline></header><h1 id=distributed-tracing-for-aws-lambda-functions>Distributed Tracing for AWS Lambda Functions</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>45 minutes</span>
</span>&nbsp;
<span class="badge cstyle blue badge-with-title"><span class=badge-title class=text-muted>Author
</span><span class=badge-content>Guy-Francis Kono</span></span><p>This workshop will equip you to build a distributed trace for a small serverless application that runs on AWS Lambda, producing and consuming a message via AWS Kinesis.</p><p>First, we will see how OpenTelemetry&rsquo;s auto-instrumentation captures traces and exports them to your target of choice.</p><p>Then, we will see how we can enable context propagation with manual instrumentation.</p><p>For this workshop Splunk has prepared an Ubuntu Linux instance in AWS/EC2 all pre-configured for you. To get access to that instance, please visit the URL provided by the workshop leader.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Oct 16, 2024</span></span></footer></article><section><h1 class=a11y-only>Subsections of Lambda Tracing</h1><article class=default><header class=headline></header><h1 id=setup>Setup</h1><p><a href=#R-image-e376e7079dc0b20705dda71386eff8ea class=lightbox-link><img alt="Lambda application, not yet manually instrumented" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/01-Architecture.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e376e7079dc0b20705dda71386eff8ea><img alt="Lambda application, not yet manually instrumented" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/01-Architecture.png></a></p><h2 id=prerequisites>Prerequisites</h2><h3 id=observability-workshop-instance>Observability Workshop Instance</h3><p>The Observability Workshop is most often completed on a Splunk-issued and preconfigured EC2 instance running Ubuntu.</p><p>Your workshop instructor will provide you with the credentials to your assigned workshop instance.</p><p>Your instance should have the following environment variables already set:</p><ul><li><strong>ACCESS_TOKEN</strong></li><li><strong>REALM</strong><ul><li><em>These are the Splunk Observability Cloud <strong>Access Token</strong> and <strong>Realm</strong> for your workshop.</em></li><li><em>They will be used by the OpenTelemetry Collector to forward your data to the correct Splunk Observability Cloud organization.</em></li></ul></li></ul><details open class="box cstyle notices note"><summary class=box-label><i class="fa-fw fas fa-exclamation-circle"></i>
Note</summary><div class=box-content><p><em>Alternatively, you can deploy a local observability workshop instance using Multipass.</em></p></div></details><h3 id=aws-command-line-interface-awscli>AWS Command Line Interface (awscli)</h3><p>The AWS Command Line Interface, or <code>awscli</code>, is an API used to interact with AWS resources. In this workshop, it is used by certain scripts to interact with the resource you&rsquo;ll deploy.</p><p>Your Splunk-issued workshop instance should already have the <strong>awscli</strong> installed.</p><ul><li><p>Check if the <strong>aws</strong> command is installed on your instance with the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>which aws</span></span></code></pre></div><ul><li><em>The expected output would be <strong>/usr/local/bin/aws</strong></em></li></ul></li><li><p>If the <strong>aws</strong> command is not installed on your instance, run the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt install awscli</span></span></code></pre></div></li></ul><h3 id=terraform>Terraform</h3><p>Terraform is an Infrastructure as Code (IaC) platform, used to deploy, manage and destroy resource by defining them in configuration files. Terraform employs HCL to define those resources, and supports multiple providers for various platforms and technologies.</p><p>We will be using Terraform at the command line in this workshop to deploy the following resources:</p><ol><li>AWS API Gateway</li><li>Lambda Functions</li><li>Kinesis Stream</li><li>CloudWatch Log Groups</li><li>S3 Bucket<ul><li><em>and other supporting resources</em></li></ul></li></ol><p>Your Splunk-issued workshop instance should already have <strong>terraform</strong> installed.</p><ul><li><p>Check if the <strong>terraform</strong> command is installed on your instance:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>which terraform</span></span></code></pre></div><ul><li><em>The expected output would be <strong>/usr/local/bin/terraform</strong></em></li></ul></li><li><p>If the <strong>terraform</strong> command is not installed on your instance, follow Terraform&rsquo;s recommended installation commands listed below:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget -O- https://apt.releases.hashicorp.com/gpg <span class=p>|</span> sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com </span><span class=k>$(</span>lsb_release -cs<span class=k>)</span><span class=s2> main&#34;</span> <span class=p>|</span> sudo tee /etc/apt/sources.list.d/hashicorp.list
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sudo apt update <span class=o>&amp;&amp;</span> sudo apt install terraform</span></span></code></pre></div></li></ul><h3 id=workshop-directory-o11y-lambda-workshop>Workshop Directory (o11y-lambda-workshop)</h3><p>The Workshop Directory <code>o11y-lambda-workshop</code> is a repository that contains all the configuration files and scripts to complete both the auto-instrumentation and manual instrumentation of the example Lambda-based application we will be using today.</p><ul><li><p>Confirm you have the workshop directory in your home directory:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> <span class=o>&amp;&amp;</span> ls</span></span></code></pre></div><ul><li><em>The expected output would include <strong>o11y-lambda-workshop</strong></em></li></ul></li><li><p>If the <strong>o11y-lambda-workshop</strong> directory is not in your home directory, clone it with the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone https://github.com/gkono-splunk/o11y-lambda-workshop.git</span></span></code></pre></div></li></ul><h3 id=aws--terraform-variables>AWS & Terraform Variables</h3><h4 id=aws>AWS</h4><p>The AWS CLI requires that you have credentials to be able to access and manage resources deployed by their services. Both Terraform and the Python scripts in this workshop require these variables to perform their tasks.</p><ul><li><p>Configure the <strong>awscli</strong> with the <em><strong>access key ID</strong></em>, <em><strong>secret access key</strong></em> and <em><strong>region</strong></em> for this workshop:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws configure</span></span></code></pre></div><ul><li><em>This command should provide a prompt similar to the one below:</em><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>AWS Access Key ID <span class=o>[</span>None<span class=o>]</span>: XXXXXXXXXXXXXXXX
</span></span><span class=line><span class=cl>AWS Secret Acces Key <span class=o>[</span>None<span class=o>]</span>: XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
</span></span><span class=line><span class=cl>Default region name <span class=o>[</span>None<span class=o>]</span>: us-east-1
</span></span><span class=line><span class=cl>Default outoput format <span class=o>[</span>None<span class=o>]</span>:</span></span></code></pre></div></li></ul></li><li><p>If the <strong>awscli</strong> is not configured on your instance, run the following command and provide the values your instructor would provide you with.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws configure</span></span></code></pre></div></li></ul><h4 id=terraform-1>Terraform</h4><p>Terraform supports the passing of variables to ensure sensitive or dynamic data is not hard-coded in your .tf configuration files, as well as to make those values reusable throughout your resource definitions.</p><p>In our workshop, Terraform requires variables necessary for deploying the Lambda functions with the right values for the OpenTelemetry Lambda layer; For the ingest values for Splunk Observability Cloud; And to make your environment and resources unique and immediatley recognizable.</p><p>Terraform variables are defined in the following manner:</p><ul><li>Define the variables in your <em><strong>main.tf</strong></em> file or a <em><strong>variables.tf</strong></em></li><li>Set the values for those variables in either of the following ways:<ul><li>setting environment variables at the host level, with the same variable names as in their definition, and with <em><strong>TF_VAR</strong></em>_ as a prefix</li><li>setting the values for your variables in a <em><strong>terraform.tfvars</strong></em> file</li><li>passing the values as arguments when running terraform apply</li></ul></li></ul><p>We will be using a combination of <em><strong>variables.tf</strong></em> and <em><strong>terraform.tfvars</strong></em> files to set our variables in this workshop.</p><ul><li>Using either <strong>vi</strong> or <strong>nano</strong>, open the <em><strong>terraform.tfvars</strong></em> file in either the <strong>auto</strong> or <strong>manual</strong> directory<div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi ~/o11y-lambda-workshop/auto/terraform.tfvars</span></span></code></pre></div></li><li>Set the variables with their values. Replace the <strong>CHANGEME</strong> placeholders with those provided by your instructor.<div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>o11y_access_token</span> <span class=o>=</span> <span class=s2>&#34;CHANGEME&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>o11y_realm</span>        <span class=o>=</span> <span class=s2>&#34;CHANGEME&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>otel_lambda_layer</span> <span class=o>=</span> <span class=o>[</span><span class=s2>&#34;CHANGEME&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>prefix</span>            <span class=o>=</span> <span class=s2>&#34;CHANGEME&#34;</span></span></span></code></pre></div><ul><li><em>Ensure you change only the placeholders, leaving the quotes and brackets intact, where applicable.</em></li><li><em>The <em><strong>prefix</strong></em> is a unique identifier you can choose for yourself, to make your resources distinct from other participants&rsquo; resources. We suggest using a short form of your name, for example.</em></li><li><em>Also, please only lowercase letters for the <strong>prefix</strong>. Certain resouces in AWS, such as S3, would through an error if you use uppercase letters.</em></li></ul></li><li>Save your file and exit the editor.</li><li>Finally, copy the <em><strong>terraform.tfvars</strong></em> file you just edited to the other directory.<div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cp ~/o11y-lambda-workshop/auto/terraform.tfvars ~/o11y-lambda-workshop/manual</span></span></code></pre></div><ul><li><em>We do this as we will be using the same values for both the autoinstrumentation and manual instrumentation protions of the workshop</em></li></ul></li></ul><h3 id=file-permissions>File Permissions</h3><p>While all other files are fine as they are, the <strong>send_message.py</strong> script in both the <code>auto</code> and <code>manual</code> will have to be executed as part of our workshop. As a result, it needs to have the appropriate permissions to run as expected. Follow these instructions to set them.</p><ul><li><p>First, ensure you are in the <code>o11y-lambda-workshop</code> directory:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop</span></span></code></pre></div></li><li><p>Next, run the following command to set executable permissions on the <code>send_message.py</code> script:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo chmod <span class=m>755</span> auto/send_message.py manual/send_message.py</span></span></code></pre></div></li></ul><p>Now that we&rsquo;ve squared off the prerequisites, we can get started with the workshop!</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Oct 29, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=auto-instrumentation>Auto-Instrumentation</h1><p>The first part of our workshop will demonstrate how auto-instrumentation with OpenTelemetry allows the OpenTelemetry Collector to auto-detect what language your function is written in, and start capturing traces for those functions.</p><h3 id=the-auto-instrumentation-workshop-directory--contents>The Auto-Instrumentation Workshop Directory & Contents</h3><p>First, let us take a look at the <code>o11y-lambda-workshop/auto</code> directory, and some of its files. This is where all the content for the auto-instrumentation portion of our workshop resides.</p><h4 id=the-auto-directory>The <code>auto</code> Directory</h4><ul><li><p>Run the following command to get into the <strong>o11y-lambda-workshop/auto</strong> directory:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/auto</span></span></code></pre></div></li><li><p>Inspect the contents of this directory:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ls</span></span></code></pre></div><ul><li><p><em>The output should include the following files and directories:</em></p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>handler             outputs.tf          terraform.tf        variables.tf
</span></span><span class=line><span class=cl>main.tf             send_message.py     terraform.tfvars</span></span></code></pre></div></li><li><p><em>The output should include the following files and directories:</em></p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>get_logs.py    main.tf       send_message.py
</span></span><span class=line><span class=cl>handler        outputs.tf    terraform.tf</span></span></code></pre></div></li></ul></li></ul><h4 id=the-maintf-file>The <code>main.tf</code> file</h4><ul><li>Take a closer look at the <code>main.tf</code> file:<div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat main.tf</span></span></code></pre></div></li></ul><details open class="box cstyle notices tip"><summary class=box-label><i class="fa-fw fas fa-question"></i>
Workshop Questions</summary><div class=box-content><ul><li>Can you identify which AWS resources are being created by this template?</li><li>Can you identify where OpenTelemetry instrumentation is being set up?<ul><li><em>Hint: study the lambda function definitions</em></li></ul></li><li>Can you determine which instrumentation information is being provided by the environment variables we set earlier?</li></ul></div></details><p>You should see a section where the environment variables for each lambda function are being set.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>environment <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>variables</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>SPLUNK_ACCESS_TOKEN</span> <span class=o>=</span> var.o11y_access_token
</span></span><span class=line><span class=cl>    <span class=nv>SPLUNK_REALM</span> <span class=o>=</span> var.o11y_realm
</span></span><span class=line><span class=cl>    <span class=nv>OTEL_SERVICE_NAME</span> <span class=o>=</span> <span class=s2>&#34;producer-lambda&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>OTEL_RESOURCE_ATTRIBUTES</span> <span class=o>=</span> <span class=s2>&#34;deployment.environment=</span><span class=si>${</span><span class=nv>var</span><span class=p>.prefix</span><span class=si>}</span><span class=s2>-lambda-shop&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>AWS_LAMBDA_EXEC_WRAPPER</span> <span class=o>=</span> <span class=s2>&#34;/opt/nodejs-otel-handler&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>KINESIS_STREAM</span> <span class=o>=</span> aws_kinesis_stream.lambda_streamer.name
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div><p>By using these environment variables, we are configuring our auto-instrumentation in a few ways:</p><ul><li><p>We are setting environment variables to inform the OpenTelemetry collector of which Splunk Observability Cloud organization we would like to have our data exported to.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>SPLUNK_ACCESS_TOKEN</span> <span class=o>=</span> var.o11y_access_token
</span></span><span class=line><span class=cl><span class=nv>SPLUNK_ACCESS_TOKEN</span> <span class=o>=</span> var.o11y_realm</span></span></code></pre></div></li><li><p>We are also setting variables that help OpenTelemetry identify our function/service, as well as the environment/application it is a part of.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>OTEL_SERVICE_NAME</span> <span class=o>=</span> <span class=s2>&#34;producer-lambda&#34;</span> <span class=c1># consumer-lambda in the case of the consumer function</span>
</span></span><span class=line><span class=cl><span class=nv>OTEL_RESOURCE_ATTRIBUTES</span> <span class=o>=</span> <span class=s2>&#34;deployment.environment=</span><span class=si>${</span><span class=nv>var</span><span class=p>.prefix</span><span class=si>}</span><span class=s2>-lambda-shop&#34;</span></span></span></code></pre></div></li><li><p>We are setting an environment variable that lets OpenTelemetry know what wrappers it needs to apply to our function&rsquo;s handler so as to capture trace data automatically, based on our code language.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>AWS_LAMBDA_EXEC_WRAPPER - <span class=s2>&#34;/opt/nodejs-otel-handler&#34;</span></span></span></code></pre></div></li><li><p>In the case of the <code>producer-lambda</code> function, we are setting an environment variable to let the function know what Kinesis Stream to put our record to.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KINESIS_STREAM</span> <span class=o>=</span> aws_kinesis_stream.lambda_streamer.name</span></span></code></pre></div></li><li><p>These values are sourced from the environment variables we set in the Prerequisites section, as well as resources that will be deployed as a part of this Terraform configuration file.</p></li></ul><p>You should also see an argument for setting the Splunk OpenTelemetry Lambda layer on each function</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>layers</span> <span class=o>=</span> var.otel_lambda_layer</span></span></code></pre></div><ul><li><p>The OpenTelemetry Lambda layer is a package that contains the libraries and dependencies necessary to collector, process and export telemetry data for Lambda functions at the moment of invocation.</p></li><li><p>While there is a general OTel Lambda layer that has all the libraries and dependencies for all OpenTelemetry-supported languages, there are also language-specific Lambda layers, to help make your function even more lightweight.</p><ul><li><em>You can see the relevant Splunk OpenTelemetry Lambda layer ARNs (Amazon Resource Name) and latest versions for each AWS region <a href=https://github.com/signalfx/lambda-layer-versions/blob/main/splunk-apm/splunk-apm.md rel=external target=_blank>HERE</a></em></li></ul></li></ul><h4 id=the-producermjs-file>The <code>producer.mjs</code> file</h4><p>Next, let&rsquo;s take a look at the <code>producer-lambda</code> function code:</p><ul><li>Run the following command to view the contents of the <code>producer.mjs</code> file:<div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/o11y-lambda-workshop/auto/handler/producer.mjs</span></span></code></pre></div><ul><li>This NodeJS module contains the code for the producer function.</li><li>Essentially, this function receives a message, and puts that message as a record to the targeted Kinesis Stream</li></ul></li></ul><h3 id=deploying-the-lambda-functions--generating-trace-data>Deploying the Lambda Functions & Generating Trace Data</h3><p>Now that we are familiar with the contents of our <code>auto</code> directory, we can deploy the resources for our workshop, and generate some trace data from our Lambda functions.</p><h4 id=initialize-terraform-in-the-auto-directory>Initialize Terraform in the <code>auto</code> directory</h4><p>In order to deploy the resources defined in the <code>main.tf</code> file, you first need to make sure that Terraform is initialized in the same folder as that file.</p><ul><li><p>Ensure you are in the <code>auto</code> directory:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwd</span></span></code></pre></div><ul><li><em>The expected output would be <strong>~/o11y-lambda-workshop/auto</strong></em></li></ul></li><li><p>If you are not in the <code>auto</code> directory, run the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/auto</span></span></code></pre></div></li><li><p>Run the following command to initialize Terraform in this directory</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform init</span></span></code></pre></div><ul><li>This command will create a number of elements in the same folder:<ul><li><code>.terraform.lock.hcl</code> file: to record the providers it will use to provide resources</li><li><code>.terraform</code> directory: to store the provider configurations</li></ul></li><li>In addition to the above files, when terraform is run using the <code>apply</code> subcommand, the <code>terraform.tfstate</code> file will be created to track the state of your deployed resources.</li><li>These enable Terraform to manage the creation, state and destruction of resources, as defined within the <code>main.tf</code> file of the <code>auto</code> directory</li></ul></li></ul><h4 id=deploy-the-lambda-functions-and-other-aws-resources>Deploy the Lambda functions and other AWS resources</h4><p>Once we&rsquo;ve initialized Terraform in this directory, we can go ahead and deploy our resources.</p><ul><li><p>First, run the <strong>terraform plan</strong> command to ensure that Terraform will be able to create your resources without encountering any issues.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform plan</span></span></code></pre></div><ul><li><em>This will result in a plan to deploy resources and output some data, which you can review to ensure everything will work as intended.</em></li><li><em>Do note that a number of the values shown in the plan will be known post-creation, or are masked for security purposes.</em></li></ul></li><li><p>Next, run the <strong>terraform apply</strong> command to deploy the Lambda functions and other supporting resources from the <strong>main.tf</strong> file:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform apply</span></span></code></pre></div><ul><li><p><em>Respond <strong>yes</strong> when you see the <strong>Enter a value:</strong> prompt</em></p></li><li><p>This will result in the following outputs:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Outputs:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>base_url</span> <span class=o>=</span> <span class=s2>&#34;https://______.amazonaws.com/serverless_stage/producer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>consumer_function_name</span> <span class=o>=</span> <span class=s2>&#34;_____-consumer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>consumer_log_group_arn</span> <span class=o>=</span> <span class=s2>&#34;arn:aws:logs:us-east-1:############:log-group:/aws/lambda/______-consumer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>consumer_log_group_name</span> <span class=o>=</span> <span class=s2>&#34;/aws/lambda/______-consumer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>environment</span> <span class=o>=</span> <span class=s2>&#34;______-lambda-shop&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>lambda_bucket_name</span> <span class=o>=</span> <span class=s2>&#34;lambda-shop-______-______&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>producer_function_name</span> <span class=o>=</span> <span class=s2>&#34;______-producer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>producer_log_group_arn</span> <span class=o>=</span> <span class=s2>&#34;arn:aws:logs:us-east-1:############:log-group:/aws/lambda/______-producer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>producer_log_group_name</span> <span class=o>=</span> <span class=s2>&#34;/aws/lambda/______-producer&#34;</span></span></span></code></pre></div><ul><li><em>Terraform outputs are defined in the <strong>outputs.tf</strong> file.</em></li><li><em>These outputs will be used programmatically in other parts of our workshop, as well.</em></li></ul></li></ul></li></ul><h4 id=send-some-traffic-to-the-producer-lambda-url-base_url>Send some traffic to the <code>producer-lambda</code> URL (<code>base_url</code>)</h4><p>To start getting some traces from our deployed Lambda functions, we would need to generate some traffic. We will send a message to our <code>producer-lambda</code> function&rsquo;s endpoint, which should be put as a record into our Kinesis Stream, and then pulled from the Stream by the <code>consumer-lambda</code> function.</p><ul><li><p>Ensure you are in the <code>auto</code> directory:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwd</span></span></code></pre></div><ul><li><em>The expected output would be <strong>~/o11y-lambda-workshop/auto</strong></em></li></ul></li><li><p>If you are not in the <code>auto</code> directory, run the following command</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/auto</span></span></code></pre></div></li></ul><p>The <code>send_message.py</code> script is a Python script that will take input at the command line, add it to a JSON dictionary, and send it to your <code>producer-lambda</code> function&rsquo;s endpoint repeatedly, as part of a while loop.</p><ul><li><p>Run the <code>send_message.py</code> script as a background process</p><ul><li><em>It requires the <code>--name</code> and <code>--superpower</code> arguments</em></li></ul><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nohup ./send_message.py --name CHANGEME --superpower CHANGEME <span class=p>&amp;</span></span></span></code></pre></div><ul><li>You should see an output similar to the following if your message is successful<div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>1<span class=o>]</span> <span class=m>79829</span>
</span></span><span class=line><span class=cl>user@host manual % appending output to nohup.out</span></span></code></pre></div><ul><li><em>The two most import bits of information here are:</em><ul><li><em>The process ID on the first line (<code>79829</code> in the case of my example), and</em></li><li><em>The <code>appending output to nohup.out</code> message</em></li></ul></li><li><em>The <code>nohup</code> command ensures the script will not hang up when sent to the background. It also captures the curl output from our command in a nohup.out file in the same folder as the one you&rsquo;re currently in.</em></li><li><em>The <code>&</code> tells our shell process to run this process in the background, thus freeing our shell to run other commands.</em></li></ul></li></ul></li><li><p>Next, check the contents of the <code>response.logs</code> file, to ensure your output confirms your requests to your <code>producer-lambda</code> endpoint are successful:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat response.logs</span></span></code></pre></div><ul><li>You should see the following output among the lines printed to your screen if your message is successful:</li></ul><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Message placed in the Event Stream: {prefix}-lambda_stream&#34;</span><span class=o>}</span></span></span></code></pre></div><ul><li>If unsuccessful, you will see:</li></ul><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Internal server error&#34;</span><span class=o>}</span></span></span></code></pre></div></li></ul><details open class="box cstyle notices important"><summary class=box-label><i class="fa-fw fas fa-bolt"></i>
Important</summary><div class=box-content><p>If this occurs, ask one of the workshop facilitators for assistance.</p></div></details><h4 id=view-the-lambda-function-logs>View the Lambda Function Logs</h4><p>Next, let&rsquo;s take a look at the logs for our Lambda functions.</p><ul><li><p>To view your <strong>producer-lambda</strong> logs, check the <strong>producer.logs</strong> file:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat producer.logs</span></span></code></pre></div></li><li><p>To view your <strong>consumer-lambda</strong> logs, check the <strong>consumer.logs</strong> file:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat consumer.logs</span></span></code></pre></div></li></ul><p>Examine the logs carefully.</p><details open class="box cstyle notices tip"><summary class=box-label><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><ul><li>Do you see OpenTelemetry being loaded? Look out for the lines with <code>splunk-extension-wrapper</code><ul><li><ul><li><em>Consider running <code>head -n 50 producer.logs</code> or <code>head -n 50 consumer.logs</code> to see the <strong>splunk-extension-wrapper</strong> being loaded.</em></li></ul></li></ul></li></ul></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Oct 29, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=splunk-apm-lambda-functions--traces>Splunk APM, Lambda Functions & Traces</h1><p>The Lambda functions should be generating a sizeable amount of trace data, which we would need to take a look at. Through the combination of environment variables and the OpenTelemetry Lambda layer configured in the resource definition for our Lambda functions, we should now be ready to view our functions and traces in Splunk APM.</p><h4 id=view-your-environment-name-in-the-splunk-apm-overview>View your Environment name in the Splunk APM Overview</h4><p>Let&rsquo;s start by making sure that Splunk APM is aware of our <code>Environment</code> from the trace data it is receiving. This is the <code>deployment.name</code> we set as part of the <code>OTEL_RESOURCE_ATTRIBUTES</code> variable we set on our Lambda function definitions in <code>main.tf</code>. It was also one of the outputs from the <code>terraform apply</code> command we ran earlier.</p><p>In Splunk Observability Cloud:</p><ul><li><p>Click on the <code>APM</code> Button from the Main Menu on the left. This will take you to the Splunk APM Overview.</p></li><li><p>Select your APM Environment from the <code>Environment:</code> dropdown.</p><ul><li><em>Your APM environment should be in the <code>PREFIX-lambda-shop</code> format, where the <code>PREFIX</code> is obtained from the environment variable you set in the Prerequisites section</em></li></ul></li></ul><details open class="box cstyle notices note"><summary class=box-label><i class="fa-fw fas fa-exclamation-circle"></i>
Note</summary><div class=box-content><p>It may take a few minutes for your traces to appear in Splunk APM. Try hitting refresh on your browser until you find your environment name in the list of environments.</p></div></details><p><a href=#R-image-1bb610c2b30916ac3084f1b9141cde36 class=lightbox-link><img alt="Splunk APM, Environment Name" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/02-Auto-APM-EnvironmentName.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-1bb610c2b30916ac3084f1b9141cde36><img alt="Splunk APM, Environment Name" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/02-Auto-APM-EnvironmentName.png></a></p><h4 id=view-your-environments-service-map>View your Environment&rsquo;s Service Map</h4><p>Once you&rsquo;ve selected your Environment name from the Environment drop down, you can take a look at the Service Map for your Lambda functions.</p><ul><li>Click the <code>Service Map</code> Button on the right side of the APM Overview page. This will take you to your Service Map view.</li></ul><p><a href=#R-image-e666a75e234f56d399c775fc2404c560 class=lightbox-link><img alt="Splunk APM, Service Map Button" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/03-Auto-ServiceMapButton.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e666a75e234f56d399c775fc2404c560><img alt="Splunk APM, Service Map Button" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/03-Auto-ServiceMapButton.png></a></p><p>You should be able to see the <code>producer-lambda</code> function and the call it is making to the Kinesis Stream to put your record.</p><p><a href=#R-image-81c2dfbe970b8ab24b11d3955e1b9c42 class=lightbox-link><img alt="Splunk APM, Service Map" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/04-Auto-ServiceMap.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-81c2dfbe970b8ab24b11d3955e1b9c42><img alt="Splunk APM, Service Map" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/04-Auto-ServiceMap.png></a></p><details open class="box cstyle notices tip"><summary class=box-label><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><p>What about your <code>consumer-lambda</code> function?</p></div></details><h4 id=explore-the-traces-from-your-lambda-functions>Explore the Traces from your Lambda Functions</h4><ul><li>Click the <code>Traces</code> button to view the Trace Analyzer.</li></ul><p><a href=#R-image-254113527a1259a0dd27a7f1da5aaecf class=lightbox-link><img alt="Splunk APM, Trace Button" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/05-Auto-TraceButton.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-254113527a1259a0dd27a7f1da5aaecf><img alt="Splunk APM, Trace Button" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/05-Auto-TraceButton.png></a></p><p>On this page, we can see the traces that have been ingested from the OpenTelemetry Lambda layer of your <code>producer-lambda</code> function.</p><p><a href=#R-image-f64ccf8cac60713e9a79f8c191f6e2f4 class=lightbox-link><img alt="Splunk APM, Trace Analyzer" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/06-Auto-TraceAnalyzer.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-f64ccf8cac60713e9a79f8c191f6e2f4><img alt="Splunk APM, Trace Analyzer" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/06-Auto-TraceAnalyzer.png></a></p><ul><li>Select a trace from the list to examine by clicking on its hyperlinked <code>Trace ID</code>.</li></ul><p><a href=#R-image-fc5f2ef4dc22e5fb9930b1d2cddbe1ad class=lightbox-link><img alt="Splunk APM, Trace and Spans" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/07-Auto-TraceNSpans.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-fc5f2ef4dc22e5fb9930b1d2cddbe1ad><img alt="Splunk APM, Trace and Spans" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/07-Auto-TraceNSpans.png></a></p><p>We can see that the <code>producer-lambda</code> function is putting a record into the Kinesis Stream. But the action of the <code>consumer-lambda</code> function is missing!</p><p>This is because the trace context is not being propagated. Trace context propagation is not supported out-of-the-box by Kinesis service at the time of this workshop. Our distributed trace stops at the Kinesis service, and because its context isn&rsquo;t automatically propagated through the stream, we can&rsquo;t see any further.</p><p>Not yet, at least&mldr;</p><p>Let&rsquo;s see how we work around this in the next section of this workshop. But before that, let&rsquo;s clean up after ourselves!</p><h3 id=clean-up>Clean Up</h3><p>The resources we deployed as part of this auto-instrumenation exercise need to be cleaned. Likewise, the script that was generating traffice against our <code>producer-lambda</code> endpoint needs to be stopped, if it&rsquo;s still running. Follow the below steps to clean up.</p><h4 id=kill-the-send_message>Kill the <code>send_message</code></h4><ul><li><p>If the <code>send_message.py</code> script is still running, stop it with the follwing commands:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>fg</span></span></code></pre></div><ul><li>This brings your background process to the foreground.</li><li>Next you can hit <code>[CONTROL-C]</code> to kill the process.</li></ul></li></ul><h4 id=destroy-all-aws-resources>Destroy all AWS resources</h4><p>Terraform is great at managing the state of our resources individually, and as a deployment. It can even update deployed resources with any changes to their definitions. But to start afresh, we will destroy the resources and redeploy them as part of the manual instrumentation portion of this workshop.</p><p>Please follow these steps to destroy your resources:</p><ul><li><p>Ensure you are in the <code>auto</code> directory:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwd</span></span></code></pre></div><ul><li><em>The expected output would be <strong>~/o11y-lambda-workshop/auto</strong></em></li></ul></li><li><p>If you are not in the <code>auto</code> directory, run the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/auto</span></span></code></pre></div></li><li><p>Destroy the Lambda functions and other AWS resources you deployed earlier:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform destroy</span></span></code></pre></div><ul><li>respond <code>yes</code> when you see the <code>Enter a value:</code> prompt</li><li>This will result in the resources being destroyed, leaving you with a clean environment</li></ul></li></ul><p>This process will leave you with the files and directories created as a result of our activity. Do not worry about those.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Oct 29, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=manual-instrumentation>Manual Instrumentation</h1><p>The second part of our workshop will focus on demonstrating how manual instrumentation with OpenTelemetry empowers us to enhance telemetry collection. More specifically, in our case, it will enable us to propagate trace context data from the <code>producer-lambda</code> function to the <code>consumer-lambda</code> function, thus enabling us to see the relationship between the two functions, even across Kinesis Stream, which currently does not support automatic context propagation.</p><h3 id=the-manual-instrumentation-workshop-directory--contents>The Manual Instrumentation Workshop Directory & Contents</h3><p>Once again, we will first start by taking a look at our operating directory, and some of its files. This time, it will be <code>o11y-lambda-workshop/manual</code> directory. This is where all the content for the manual instrumentation portion of our workshop resides.</p><h4 id=the-manual-directory>The <code>manual</code> directory</h4><ul><li><p>Run the following command to get into the <code>o11y-lambda-workshop/manual</code> directory:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/manual</span></span></code></pre></div></li><li><p>Inspect the contents of this directory with the <code>ls</code> command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ls</span></span></code></pre></div><ul><li><p><em>The output should include the following files and directories:</em></p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>handler             outputs.tf          terraform.tf        variables.tf
</span></span><span class=line><span class=cl>main.tf             send_message.py     terraform.tfvars</span></span></code></pre></div></li></ul></li></ul><details open class="box cstyle notices tip"><summary class=box-label><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><p>Do you see any difference between this directory and the auto directory when you first started?</p></div></details><h4 id=compare-auto-and-manual-files>Compare <code>auto</code> and <code>manual</code> files</h4><p>Let&rsquo;s make sure that all these files that LOOK the same, are actually the same.</p><ul><li><p>Compare the <code>main.tf</code> files in the <code>auto</code> and <code>manual</code> directories:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>diff ~/o11y-lambda-workshop/auto/main.tf ~/o11y-lambda-workshop/manual/main.tf</span></span></code></pre></div><ul><li>There is no difference! <em>(Well, there shouldn&rsquo;t be. Ask your workshop facilitator to assist you if there is)</em></li></ul></li><li><p>Now, let&rsquo;s compare the <code>producer.mjs</code> files:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>diff ~/o11y-lambda-workshop/auto/handler/producer.mjs ~/o11y-lambda-workshop/manual/handler/producer.mjs</span></span></code></pre></div><ul><li>There&rsquo;s quite a few differences here!</li></ul></li><li><p>You may wish to view the entire file and examine its content</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/o11y-lambda-workshop/handler/producer.mjs</span></span></code></pre></div><ul><li>Notice how we are now importing some OpenTelemetry objects directly into our function to handle some of the manual instrumentation tasks we require.</li></ul><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>context</span><span class=p>,</span> <span class=nx>propagation</span><span class=p>,</span> <span class=nx>trace</span><span class=p>,</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;@opentelemetry/api&#34;</span><span class=p>;</span></span></span></code></pre></div><ul><li>We are importing the following objects from <a href=https://www.npmjs.com/package/@opentelemetry/api rel=external target=_blank>@opentelemetry/api</a> to propagate our context in our producer function:<ul><li>context</li><li>propagation</li><li>trace</li></ul></li></ul></li><li><p>Finally, compare the <code>consumer.mjs</code> files:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>diff ~/o11y-lambda-workshop/auto/handler/consumer.mjs ~/o11y-lambda-workshop/manual/handler/consumer.mjs</span></span></code></pre></div><ul><li><p>Here also, there are a few differences of note. Let&rsquo;s take a closer look</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat handler/consumer.mjs</span></span></code></pre></div><ul><li>In this file, we are importing the following <a href=https://www.npmjs.com/package/@opentelemetry/api rel=external target=_blank>@opentelemetry/api</a> objects:<ul><li>propagation</li><li>trace</li><li>ROOT_CONTEXT</li></ul></li><li>We use these to extract the trace context that was propagated from the producer function</li><li>Then to add new span attributes based on our <code>name</code> and <code>superpower</code> to the extracted trace context</li></ul></li></ul></li></ul><h4 id=propagating-the-trace-context-from-the-producer-function>Propagating the Trace Context from the Producer Function</h4><p>The below code executes the following steps inside the producer function:</p><ol><li>Get the tracer for this trace</li><li>Initialize a context carrier object</li><li>Inject the context of the active span into the carrier object</li><li>Modify the record we are about to pu on our Kinesis stream to include the carrier that will carry the active span&rsquo;s context to the consumer</li></ol><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>context</span><span class=p>,</span> <span class=nx>propagation</span><span class=p>,</span> <span class=nx>trace</span><span class=p>,</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;@opentelemetry/api&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>tracer</span> <span class=o>=</span> <span class=nx>trace</span><span class=p>.</span><span class=nx>getTracer</span><span class=p>(</span><span class=s1>&#39;lambda-app&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>tracer</span><span class=p>.</span><span class=nx>startActiveSpan</span><span class=p>(</span><span class=s1>&#39;put-record&#39;</span><span class=p>,</span> <span class=kr>async</span><span class=p>(</span><span class=nx>span</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>carrier</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=nx>propagation</span><span class=p>.</span><span class=nx>inject</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>active</span><span class=p>(),</span> <span class=nx>carrier</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>eventBody</span> <span class=o>=</span> <span class=nx>Buffer</span><span class=p>.</span><span class=nx>from</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>body</span><span class=p>,</span> <span class=s1>&#39;base64&#39;</span><span class=p>).</span><span class=nx>toString</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>data</span> <span class=o>=</span> <span class=s2>&#34;{\&#34;tracecontext\&#34;: &#34;</span> <span class=o>+</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>carrier</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34;, \&#34;record\&#34;: &#34;</span> <span class=o>+</span> <span class=nx>eventBody</span> <span class=o>+</span> <span class=s2>&#34;}&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=sb>`Record with Trace Context added:
</span></span></span><span class=line><span class=cl><span class=sb>      </span><span class=si>${</span><span class=nx>data</span><span class=si>}</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>await</span> <span class=nx>kinesis</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=nx>PutRecordCommand</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>StreamName</span><span class=o>:</span> <span class=nx>streamName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>PartitionKey</span><span class=o>:</span> <span class=s2>&#34;1234&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>Data</span><span class=o>:</span> <span class=nx>data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>}),</span>
</span></span><span class=line><span class=cl>        <span class=nx>message</span> <span class=o>=</span> <span class=sb>`Message placed in the Event Stream: </span><span class=si>${</span><span class=nx>streamName</span><span class=si>}</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>span</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span></span></span></code></pre></div><h4 id=extracting-trace-context-in-the-consumer-function>Extracting Trace Context in the Consumer Function</h4><p>The below code executes the following steps inside the consumer function:</p><ol><li>Extract the context that we obtained from <code>producer-lambda</code> into a carrier object.</li><li>Extract the tracer from current context.</li><li>Start a new span with the tracer within the extracted context.</li><li>Bonus: Add extra attributes to your span, including custom ones with the values from your message!</li><li>Once completed, end the span.</li></ol><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>propagation</span><span class=p>,</span> <span class=nx>trace</span><span class=p>,</span> <span class=nx>ROOT_CONTEXT</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;@opentelemetry/api&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>carrier</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span> <span class=nx>message</span> <span class=p>).</span><span class=nx>tracecontext</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>parentContext</span> <span class=o>=</span> <span class=nx>propagation</span><span class=p>.</span><span class=nx>extract</span><span class=p>(</span><span class=nx>ROOT_CONTEXT</span><span class=p>,</span> <span class=nx>carrier</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>tracer</span> <span class=o>=</span> <span class=nx>trace</span><span class=p>.</span><span class=nx>getTracer</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>OTEL_SERVICE_NAME</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>span</span> <span class=o>=</span> <span class=nx>tracer</span><span class=p>.</span><span class=nx>startSpan</span><span class=p>(</span><span class=s2>&#34;Kinesis.getRecord&#34;</span><span class=p>,</span> <span class=kc>undefined</span><span class=p>,</span> <span class=nx>parentContext</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>span</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s2>&#34;span.kind&#34;</span><span class=p>,</span> <span class=s2>&#34;server&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>body</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span> <span class=nx>message</span> <span class=p>).</span><span class=nx>record</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>body</span><span class=p>.</span><span class=nx>name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>span</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s2>&#34;custom.tag.name&#34;</span><span class=p>,</span> <span class=nx>body</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>body</span><span class=p>.</span><span class=nx>superpower</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>span</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s2>&#34;custom.tag.superpower&#34;</span><span class=p>,</span> <span class=nx>body</span><span class=p>.</span><span class=nx>superpower</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>      <span class=nx>span</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span></span></span></code></pre></div><p>Now let&rsquo;s see the different this makes!</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Oct 29, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=deploying-lambda-functions--generating-trace-data>Deploying Lambda Functions & Generating Trace Data</h1><p>Now that we know how to apply manual instrumentation to the functions and services we wish to capture trace data for, let&rsquo;s go about deploying our Lambda functions again, and generating traffic against our <code>producer-lambda</code> endpoint.</p><h4 id=initialize-terraform-in-the-manual-directory>Initialize Terraform in the <code>manual</code> directory</h4><p>Seeing as we&rsquo;re in a new directory, we will need to initialize Terraform here once again.</p><ul><li><p>Ensure you are in the <code>manual</code> directory:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwd</span></span></code></pre></div><ul><li><em>The expected output would be <strong>~/o11y-lambda-workshop/manual</strong></em></li></ul></li><li><p>If you are not in the <code>manual</code> directory, run the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/manual</span></span></code></pre></div></li><li><p>Run the following command to initialize Terraform in this directory</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform init</span></span></code></pre></div></li></ul><h4 id=deploy-the-lambda-functions-and-other-aws-resources>Deploy the Lambda functions and other AWS resources</h4><p>Let&rsquo;s go ahead and deploy those resources again as well!</p><ul><li><p>Run the <strong>terraform plan</strong> command, ensuring there are no issues.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform plan</span></span></code></pre></div></li><li><p>Follow up with the <strong>terraform apply</strong> command to deploy the Lambda functions and other supporting resources from the <strong>main.tf</strong> file:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform apply</span></span></code></pre></div><ul><li><p><em>Respond <strong>yes</strong> when you see the <strong>Enter a value:</strong> prompt</em></p></li><li><p>This will result in the following outputs:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Outputs:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>base_url</span> <span class=o>=</span> <span class=s2>&#34;https://______.amazonaws.com/serverless_stage/producer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>consumer_function_name</span> <span class=o>=</span> <span class=s2>&#34;_____-consumer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>consumer_log_group_arn</span> <span class=o>=</span> <span class=s2>&#34;arn:aws:logs:us-east-1:############:log-group:/aws/lambda/______-consumer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>consumer_log_group_name</span> <span class=o>=</span> <span class=s2>&#34;/aws/lambda/______-consumer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>environment</span> <span class=o>=</span> <span class=s2>&#34;______-lambda-shop&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>lambda_bucket_name</span> <span class=o>=</span> <span class=s2>&#34;lambda-shop-______-______&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>producer_function_name</span> <span class=o>=</span> <span class=s2>&#34;______-producer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>producer_log_group_arn</span> <span class=o>=</span> <span class=s2>&#34;arn:aws:logs:us-east-1:############:log-group:/aws/lambda/______-producer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>producer_log_group_name</span> <span class=o>=</span> <span class=s2>&#34;/aws/lambda/______-producer&#34;</span></span></span></code></pre></div></li></ul></li></ul><p>As you can tell, aside from the first portion of the base_url and the log gropu ARNs, the output should be largely the same as when you ran the auto-instrumentation portion of this workshop up to this same point.</p><h4 id=send-some-traffic-to-the-producer-lambda-endpoint-base_url>Send some traffic to the <code>producer-lambda</code> endpoint (base_url)</h4><p>Once more, we will send our <code>name</code> and <code>superpower</code> as a message to our endpoint. This will then be added to a record in our Kinesis Stream, along with our trace context.</p><ul><li><p>Ensure you are in the <code>manual</code> directory:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwd</span></span></code></pre></div><ul><li><em>The expected output would be <strong>~/o11y-lambda-workshop/manual</strong></em></li></ul></li><li><p>If you are not in the <code>manual</code> directory, run the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/manual</span></span></code></pre></div></li><li><p>Run the <code>send_message.py</code> script as a background process:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nohup ./send_message.py --name CHANGEME --superpower CHANGEME <span class=p>&amp;</span></span></span></code></pre></div></li><li><p>Next, check the contents of the response.logs file for successful calls to our<strong>producer-lambda</strong> endpoint:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat response.logs</span></span></code></pre></div><ul><li><p>You should see the following output among the lines printed to your screen if your message is successful:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Message placed in the Event Stream: hostname-eventStream&#34;</span><span class=o>}</span></span></span></code></pre></div></li><li><p>If unsuccessful, you will see:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Internal server error&#34;</span><span class=o>}</span></span></span></code></pre></div></li></ul></li></ul><details open class="box cstyle notices important"><summary class=box-label><i class="fa-fw fas fa-bolt"></i>
Important</summary><div class=box-content><p>If this occurs, ask one of the workshop facilitators for assistance.</p></div></details><h4 id=view-the-lambda-function-logs>View the Lambda Function Logs</h4><p>Let&rsquo;s see what our logs look like now.</p><ul><li><p>Check the <strong>producer.logs</strong> file:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat producer.logs</span></span></code></pre></div></li><li><p>And the <strong>consumer.logs</strong> file:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat consumer.logs</span></span></code></pre></div></li></ul><p>Examine the logs carefully.</p><h5 id=workshop-question><em>Workshop Question</em></h5><blockquote><p>Do you notice the difference?</p></blockquote><h4 id=copy-the-trace-id-from-the-consumer-lambda-logs>Copy the Trace ID from the <code>consumer-lambda</code> logs</h4><p>This time around, we can see that the consumer-lambda log group is logging our message as a <code>record</code> together with the <code>tracecontext</code> that we propagated.</p><p>To copy the Trace ID:</p><ul><li>Take a look at one of the <code>Kinesis Message</code> logs. Within it, there is a <code>data</code> dictionary</li><li>Take a closer look at <code>data</code> to see the nested <code>tracecontext</code> dictionary</li><li>Within the <code>tracecontext</code> dictionary, there is a <code>traceparent</code> key-value pair</li><li>The <code>traceparent</code> key-value pair holds the Trace ID we seek<ul><li>There are 4 groups of values, separated by <code>-</code>. The Trace ID is the 2nd group of characters</li></ul></li><li><strong>Copy the Trace ID, and save it.</strong> We will need it for a later step in this workshop</li></ul><p><a href=#R-image-c794ce0488499bf0c9b0105e3b9157bd class=lightbox-link><img alt="Lambda Consumer Logs, Manual Instruamentation" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/08-Manual-ConsumerLogs.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c794ce0488499bf0c9b0105e3b9157bd><img alt="Lambda Consumer Logs, Manual Instruamentation" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/08-Manual-ConsumerLogs.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Oct 29, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=splunk-apm-lambda-functions-and-traces-again>Splunk APM, Lambda Functions and Traces, Again!</h1><p>In order to see the result of our context propagation outside of the logs, we&rsquo;ll once again consult the <a href=https://app.us1.signalfx.com/#/apm rel=external target=_blank>Splunk APM UI</a>.</p><h4 id=view-your-lambda-functions-in-the-splunk-apm-service-map>View your Lambda Functions in the Splunk APM Service Map</h4><p>Let&rsquo;s take a look at the Service Map for our environment in APM once again.</p><p>In Splunk Observability Cloud:</p><ul><li><p>Click on the <code>APM</code> Button in the Main Menu.</p></li><li><p>Select your APM Environment from the <code>Environment:</code> dropdown.</p></li><li><p>Click the <code>Service Map</code> Button on the right side of the APM Overview page. This will take you to your Service Map view.</p></li></ul><details open class="box cstyle notices note"><summary class=box-label><i class="fa-fw fas fa-exclamation-circle"></i>
Note</summary><div class=box-content><p><em>Reminder: It may take a few minutes for your traces to appear in Splunk APM. Try hitting refresh on your browser until you find your environment name in the list of environments.</em></p></div></details><details open class="box cstyle notices tip"><summary class=box-label><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><p>Notice the difference?</p></div></details><ul><li>You should be able to see the <code>producer-lambda</code> and <code>consumer-lambda</code> functions linked by the propagated context this time!</li></ul><p><a href=#R-image-c3213e1fd265601f9d7821b19f0b73d8 class=lightbox-link><img alt="Splunk APM, Service Map" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/09-Manual-ServiceMap.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c3213e1fd265601f9d7821b19f0b73d8><img alt="Splunk APM, Service Map" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/09-Manual-ServiceMap.png></a></p><h4 id=explore-a-lambda-trace-by-trace-id>Explore a Lambda Trace by Trace ID</h4><p>Next, we will take another look at a trace related to our Environment.</p><ul><li>Paste the Trace ID you copied from the consumer function&rsquo;s logs into the <code>View Trace ID</code> search box under Traces and click <code>Go</code></li></ul><p><a href=#R-image-cb7f78aa0c98807deadfa87bc38ed30d class=lightbox-link><img alt="Splunk APM, Trace Button" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/10-Manual-TraceButton.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-cb7f78aa0c98807deadfa87bc38ed30d><img alt="Splunk APM, Trace Button" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/10-Manual-TraceButton.png></a></p><details open class="box cstyle notices note"><summary class=box-label><i class="fa-fw fas fa-exclamation-circle"></i>
Note</summary><div class=box-content><p>The Trace ID was a part of the trace context that we propagated.</p></div></details><p>You can read up on two of the most common propagation standards:</p><ol><li><a href=https:///www.w3.org/TR/trace-context/#traceparent-header rel=external target=_blank>W3C</a></li><li><a href=https://github.com/openzipkin/b3-propagation#overall-process rel=external target=_blank>B3</a></li></ol><details open class="box cstyle notices tip"><summary class=box-label><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><p>Which one are we using?</p><ul><li><em>The Splunk Distribution of Opentelemetry JS, which supports our NodeJS functions, <a href=https://docs.splunk.com/observability/en/gdi/get-data-in/application/nodejs/splunk-nodejs-otel-distribution.html#defaults-of-the-splunk-distribution-of-opentelemetry-js rel=external target=_blank>defaults</a> to the <code>W3C</code> standard</em></li></ul></div></details><details open class="box cstyle notices tip"><summary class=box-label><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><p>Bonus Question: What happens if we mix and match the W3C and B3 headers?</p></div></details><p><a href=#R-image-97b831f1ff4476947b6212cd9558613f class=lightbox-link><img alt="Splunk APM, Trace by ID" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/11-Manual-TraceByID.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-97b831f1ff4476947b6212cd9558613f><img alt="Splunk APM, Trace by ID" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/11-Manual-TraceByID.png></a></p><p>Click on the <code>consumer-lambda</code> span.</p><details open class="box cstyle notices tip"><summary class=box-label><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><p>Can you find the attributes from your message?</p></div></details><p><a href=#R-image-fe3d56592e2f9600679260c8fd7fa007 class=lightbox-link><img alt="Splunk APM, Span Tags" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/12-Manual-SpanTags.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-fe3d56592e2f9600679260c8fd7fa007><img alt="Splunk APM, Span Tags" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/12-Manual-SpanTags.png></a></p><h3 id=clean-up>Clean Up</h3><p>We are finally at the end of our workshop. Kindly clean up after yourself!</p><h4 id=kill-the-send_message>Kill the <code>send_message</code></h4><ul><li><p>If the <code>send_message.py</code> script is still running, stop it with the follwing commands:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>fg</span></span></code></pre></div><ul><li>This brings your background process to the foreground.</li><li>Next you can hit <code>[CONTROL-C]</code> to kill the process.</li></ul></li></ul><h4 id=destroy-all-aws-resources>Destroy all AWS resources</h4><p>Terraform is great at managing the state of our resources individually, and as a deployment. It can even update deployed resources with any changes to their definitions. But to start afresh, we will destroy the resources and redeploy them as part of the manual instrumentation portion of this workshop.</p><p>Please follow these steps to destroy your resources:</p><ul><li><p>Ensure you are in the <code>manual</code> directory:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwd</span></span></code></pre></div><ul><li><em>The expected output would be <strong>~/o11y-lambda-workshop/manual</strong></em></li></ul></li><li><p>If you are not in the <code>manual</code> directory, run the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/manual</span></span></code></pre></div></li><li><p>Destroy the Lambda functions and other AWS resources you deployed earlier:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform destroy</span></span></code></pre></div><ul><li>respond <code>yes</code> when you see the <code>Enter a value:</code> prompt</li><li>This will result in the resources being destroyed, leaving you with a clean environment</li></ul></li></ul><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Oct 17, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=conclusion>Conclusion</h1><p>Congratulations on finishing the Lambda Tracing Workshop! You have seen how we can complement auto-instrumentation with manual steps to have the <code>producer-lambda</code> function&rsquo;s context be sent to the <code>consumer-lambda</code> function via a record in a Kinesis stream. This allowed us to build the expected Distributed Trace, and to contextualize the relationship between both functions in Splunk APM.</p><p><a href=#R-image-316410dec535411f1af69ea7cb9aa843 class=lightbox-link><img alt="Lambda application, fully instrumented" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/13-Architecture_Instrumented.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-316410dec535411f1af69ea7cb9aa843><img alt="Lambda application, fully instrumented" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/13-Architecture_Instrumented.png></a></p><p>You can now build out a trace manually by linking two different functions together. This comes in handy when your auto-instrumentation, or 3rd-party systems, do not support context propagation out of the box, or when you wish to add custom attributes to a trace for more relevant trace analaysis.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Oct 16, 2024</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=hands-on-opentelemetry-docker-and-k8s>Hands-On OpenTelemetry, Docker, and K8s</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>2 minutes</span>
</span>&nbsp;
<span class="badge cstyle blue badge-with-title"><span class=badge-title class=text-muted>Author
</span><span class=badge-content>Derek Mitchell</span></span><p>In this workshop, you&rsquo;ll get hands-on experience with the following:</p><ul><li>Practice deploying the collector and instrumenting a .NET application with the Splunk distribution of OpenTelemetry .NET in Linux and Kubernetes environments.</li><li>Practice â€œdockerizingâ€ a .NET application, running it in Docker, and then adding Splunk OpenTelemetry instrumentation.</li><li>Practice deploying the Splunk distro of the collector in a K8s environment using Helm. Then customize the collector config and troubleshoot an issue.</li></ul><p>The workshop uses a simple .NET application to illustrate these concepts. Let&rsquo;s get started!</p><details open class="box cstyle notices primary"><summary class=box-label><i class="fa-fw fas fa-lightbulb"></i>
Tip</summary><div class=box-content><p>The easiest way to navigate through this workshop is by using:</p><ul><li>the left/right arrows (<strong>&lt;</strong> | <strong>></strong>) on the top right of this page</li><li>the left (â—€ï¸) and right (â–¶ï¸) cursor keys on your keyboard</li></ul></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Feb 3, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of Hands-On OpenTelemetry, Docker, and K8s</h1><article class=default><header class=headline></header><h1 id=connect-to-ec2-instance>Connect to EC2 Instance</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>5 minutes</span>
</span>&nbsp;<h2 id=connect-to-your-ec2-instance>Connect to your EC2 Instance</h2><p>Weâ€™ve prepared an Ubuntu Linux instance in AWS/EC2 for each attendee.</p><p>Using the IP address and password provided by your instructor, connect to your EC2 instance
using one of the methods below:</p><ul><li>Mac OS / Linux<ul><li>ssh splunk@IP address</li></ul></li><li>Windows 10+<ul><li>Use the OpenSSH client</li></ul></li><li>Earlier versions of Windows<ul><li>Use Putty</li></ul></li></ul><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Dec 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=deploy-the-opentelemetry-collector>Deploy the OpenTelemetry Collector</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<h2 id=uninstall-the-opentelemetry-collector>Uninstall the OpenTelemetry Collector</h2><p>Our EC2 instance may already have an older version the Splunk Distribution of the OpenTelemetry Collector
installed. Before proceeding further, let&rsquo;s uninstall it using the following command:</p><div class=tab-panel data-tab-group=13567c93b9795a624716d79348e38415><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("13567c93b9795a624716d79348e38415","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("13567c93b9795a624716d79348e38415","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -sSL https://dl.signalfx.com/splunk-otel-collector.sh &gt; /tmp/splunk-otel-collector.sh<span class=p>;</span>
</span></span><span class=line><span class=cl>sudo sh /tmp/splunk-otel-collector.sh --uninstall</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Reading package lists... Done
</span></span><span class=line><span class=cl>Building dependency tree... Done
</span></span><span class=line><span class=cl>Reading state information... Done
</span></span><span class=line><span class=cl>The following packages will be REMOVED:
</span></span><span class=line><span class=cl>  splunk-otel-collector*
</span></span><span class=line><span class=cl><span class=m>0</span> upgraded, <span class=m>0</span> newly installed, <span class=m>1</span> to remove and <span class=m>167</span> not upgraded.
</span></span><span class=line><span class=cl>After this operation, <span class=m>766</span> MB disk space will be freed.
</span></span><span class=line><span class=cl><span class=o>(</span>Reading database ... <span class=m>157441</span> files and directories currently installed.<span class=o>)</span>
</span></span><span class=line><span class=cl>Removing splunk-otel-collector <span class=o>(</span>0.92.0<span class=o>)</span> ...
</span></span><span class=line><span class=cl><span class=o>(</span>Reading database ... <span class=m>147373</span> files and directories currently installed.<span class=o>)</span>
</span></span><span class=line><span class=cl>Purging configuration files <span class=k>for</span> splunk-otel-collector <span class=o>(</span>0.92.0<span class=o>)</span> ...
</span></span><span class=line><span class=cl>Scanning processes...                                                                                                                                                                                              
</span></span><span class=line><span class=cl>Scanning candidates...                                                                                                                                                                                             
</span></span><span class=line><span class=cl>Scanning linux images...                                                                                                                                                                                           
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Running kernel seems to be up-to-date.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Restarting services...
</span></span><span class=line><span class=cl> systemctl restart fail2ban.service falcon-sensor.service
</span></span><span class=line><span class=cl>Service restarts being deferred:
</span></span><span class=line><span class=cl> systemctl restart networkd-dispatcher.service
</span></span><span class=line><span class=cl> systemctl restart unattended-upgrades.service
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>No containers need to be restarted.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>No user sessions are running outdated binaries.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>No VM guests are running outdated hypervisor <span class=o>(</span>qemu<span class=o>)</span> binaries on this host.
</span></span><span class=line><span class=cl>Successfully removed the splunk-otel-collector package</span></span></code></pre></div></div></div></div></div><h2 id=deploy-the-opentelemetry-collector>Deploy the OpenTelemetry Collector</h2><p>Letâ€™s deploy the latest version of the Splunk Distribution of the OpenTelemetry Collector on our Linux EC2 instance.</p><p>We can do this by downloading the collector binary using <code>curl</code>, and then running it<br>with specific arguments that tell the collector which realm to report data into, which access
token to use, and which deployment environment to report into.</p><blockquote><p>A deployment environment in Splunk Observability Cloud is a distinct deployment of your system
or application that allows you to set up configurations that donâ€™t overlap with configurations
in other deployments of the same application.</p></blockquote><div class=tab-panel data-tab-group=2072f3da6a473278f75492a8b4d2d294><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2072f3da6a473278f75492a8b4d2d294","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("2072f3da6a473278f75492a8b4d2d294","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -sSL https://dl.signalfx.com/splunk-otel-collector.sh &gt; /tmp/splunk-otel-collector.sh<span class=p>;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>sudo sh /tmp/splunk-otel-collector.sh <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--realm <span class=nv>$REALM</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--mode agent <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--without-instrumentation <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--deployment-environment otel-<span class=nv>$INSTANCE</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-- <span class=nv>$ACCESS_TOKEN</span></span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Splunk OpenTelemetry Collector Version: latest
</span></span><span class=line><span class=cl>Memory Size in MIB: <span class=m>512</span>
</span></span><span class=line><span class=cl>Realm: us1
</span></span><span class=line><span class=cl>Ingest Endpoint: https://ingest.us1.signalfx.com
</span></span><span class=line><span class=cl>API Endpoint: https://api.us1.signalfx.com
</span></span><span class=line><span class=cl>HEC Endpoint: https://ingest.us1.signalfx.com/v1/log
</span></span><span class=line><span class=cl>etc. </span></span></code></pre></div></div></div></div></div><p>Refer to <a href=https://docs.splunk.com/observability/en/gdi/opentelemetry/collector-linux/install-linux.html#otel-install-linux rel=external target=_blank>Install the Collector for Linux with the installer script</a>
for further details on how to install the collector.</p><h2 id=confirm-the-collector-is-running>Confirm the Collector is Running</h2><p>Let&rsquo;s confirm that the collector is running successfully on our instance.</p><blockquote><p>Press Ctrl + C to exit out of the status command.</p></blockquote><div class=tab-panel data-tab-group=2f90718e0cb3dae8fe9fb5532d0b8ef9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2f90718e0cb3dae8fe9fb5532d0b8ef9","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("2f90718e0cb3dae8fe9fb5532d0b8ef9","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl status splunk-otel-collector</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>â— splunk-otel-collector.service - Splunk OpenTelemetry Collector
</span></span><span class=line><span class=cl>     Loaded: loaded <span class=o>(</span>/lib/systemd/system/splunk-otel-collector.service<span class=p>;</span> enabled<span class=p>;</span> vendor preset: enabled<span class=o>)</span>
</span></span><span class=line><span class=cl>    Drop-In: /etc/systemd/system/splunk-otel-collector.service.d
</span></span><span class=line><span class=cl>             â””â”€service-owner.conf
</span></span><span class=line><span class=cl>     Active: active <span class=o>(</span>running<span class=o>)</span> since Fri 2024-12-20 00:13:14 UTC<span class=p>;</span> 45s ago
</span></span><span class=line><span class=cl>   Main PID: <span class=m>14465</span> <span class=o>(</span>otelcol<span class=o>)</span>
</span></span><span class=line><span class=cl>      Tasks: <span class=m>9</span> <span class=o>(</span>limit: 19170<span class=o>)</span>
</span></span><span class=line><span class=cl>     Memory: 117.4M
</span></span><span class=line><span class=cl>        CPU: 681ms
</span></span><span class=line><span class=cl>     CGroup: /system.slice/splunk-otel-collector.service
</span></span><span class=line><span class=cl>             â””â”€14465 /usr/bin/otelcol</span></span></code></pre></div></div></div></div></div><h2 id=how-do-we-view-the-collector-logs>How do we view the collector logs?</h2><p>We can view the collector logs using <code>journalctl</code>:</p><blockquote><p>Press Ctrl + C to exit out of tailing the log.</p></blockquote><div class=tab-panel data-tab-group=ac822a2dcf501f0e178ca2a5dd2717e0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ac822a2dcf501f0e178ca2a5dd2717e0","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("ac822a2dcf501f0e178ca2a5dd2717e0","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo journalctl -u splunk-otel-collector -f -n <span class=m>100</span></span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Dec <span class=m>20</span> 00:13:14 derek-1 systemd<span class=o>[</span>1<span class=o>]</span>: Started Splunk OpenTelemetry Collector.
</span></span><span class=line><span class=cl>Dec <span class=m>20</span> 00:13:14 derek-1 otelcol<span class=o>[</span>14465<span class=o>]</span>: 2024/12/20 00:13:14 settings.go:483: Set config to /etc/otel/collector/agent_config.yaml
</span></span><span class=line><span class=cl>Dec <span class=m>20</span> 00:13:14 derek-1 otelcol<span class=o>[</span>14465<span class=o>]</span>: 2024/12/20 00:13:14 settings.go:539: Set memory limit to <span class=m>460</span> MiB
</span></span><span class=line><span class=cl>Dec <span class=m>20</span> 00:13:14 derek-1 otelcol<span class=o>[</span>14465<span class=o>]</span>: 2024/12/20 00:13:14 settings.go:524: Set soft memory limit <span class=nb>set</span> to <span class=m>460</span> MiB
</span></span><span class=line><span class=cl>Dec <span class=m>20</span> 00:13:14 derek-1 otelcol<span class=o>[</span>14465<span class=o>]</span>: 2024/12/20 00:13:14 settings.go:373: Set garbage collection target percentage <span class=o>(</span>GOGC<span class=o>)</span> to <span class=m>400</span>
</span></span><span class=line><span class=cl>Dec <span class=m>20</span> 00:13:14 derek-1 otelcol<span class=o>[</span>14465<span class=o>]</span>: 2024/12/20 00:13:14 settings.go:414: <span class=nb>set</span> <span class=s2>&#34;SPLUNK_LISTEN_INTERFACE&#34;</span> to <span class=s2>&#34;127.0.0.1&#34;</span>
</span></span><span class=line><span class=cl>etc. </span></span></code></pre></div></div></div></div></div><h2 id=collector-configuration>Collector Configuration</h2><p>Where do we find the configuration that is used by this collector?</p><p>It&rsquo;s available in the <code>/etc/otel/collector</code> directory. Since we installed the
collector in <code>agent</code> mode, the collector configuration can be found in the
<code>agent_config.yaml</code> file.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Jan 17, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=deploy-a-net-application>Deploy a .NET Application</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<h2 id=prerequisites>Prerequisites</h2><p>Before deploying the application, we&rsquo;ll need to install the .NET 8 SDK on our instance.</p><div class=tab-panel data-tab-group=011c721a4f7343a1802d899db539eb4e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("011c721a4f7343a1802d899db539eb4e","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("011c721a4f7343a1802d899db539eb4e","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt-get update <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  sudo apt-get install -y dotnet-sdk-8.0</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Hit:1 http://us-west-1.ec2.archive.ubuntu.com/ubuntu jammy InRelease
</span></span><span class=line><span class=cl>Hit:2 http://us-west-1.ec2.archive.ubuntu.com/ubuntu jammy-updates InRelease                                               
</span></span><span class=line><span class=cl>Hit:3 http://us-west-1.ec2.archive.ubuntu.com/ubuntu jammy-backports InRelease                                             
</span></span><span class=line><span class=cl>Hit:4 http://security.ubuntu.com/ubuntu jammy-security InRelease                                                           
</span></span><span class=line><span class=cl>Ign:5 https://splunk.jfrog.io/splunk/otel-collector-deb release InRelease
</span></span><span class=line><span class=cl>Hit:6 https://splunk.jfrog.io/splunk/otel-collector-deb release Release
</span></span><span class=line><span class=cl>Reading package lists... Done
</span></span><span class=line><span class=cl>Reading package lists... Done
</span></span><span class=line><span class=cl>Building dependency tree... Done
</span></span><span class=line><span class=cl>Reading state information... Done
</span></span><span class=line><span class=cl>The following additional packages will be installed:
</span></span><span class=line><span class=cl>  aspnetcore-runtime-8.0 aspnetcore-targeting-pack-8.0 dotnet-apphost-pack-8.0 dotnet-host-8.0 dotnet-hostfxr-8.0 dotnet-runtime-8.0 dotnet-targeting-pack-8.0 dotnet-templates-8.0 liblttng-ust-common1
</span></span><span class=line><span class=cl>  liblttng-ust-ctl5 liblttng-ust1 netstandard-targeting-pack-2.1-8.0
</span></span><span class=line><span class=cl>The following NEW packages will be installed:
</span></span><span class=line><span class=cl>  aspnetcore-runtime-8.0 aspnetcore-targeting-pack-8.0 dotnet-apphost-pack-8.0 dotnet-host-8.0 dotnet-hostfxr-8.0 dotnet-runtime-8.0 dotnet-sdk-8.0 dotnet-targeting-pack-8.0 dotnet-templates-8.0
</span></span><span class=line><span class=cl>  liblttng-ust-common1 liblttng-ust-ctl5 liblttng-ust1 netstandard-targeting-pack-2.1-8.0
</span></span><span class=line><span class=cl><span class=m>0</span> upgraded, <span class=m>13</span> newly installed, <span class=m>0</span> to remove and <span class=m>0</span> not upgraded.
</span></span><span class=line><span class=cl>Need to get <span class=m>138</span> MB of archives.
</span></span><span class=line><span class=cl>After this operation, <span class=m>495</span> MB of additional disk space will be used.
</span></span><span class=line><span class=cl>etc. </span></span></code></pre></div></div></div></div></div><p>Refer to <a href="https://learn.microsoft.com/en-us/dotnet/core/install/linux-ubuntu-install?tabs=dotnet8&pivots=os-linux-ubuntu-2404" rel=external target=_blank>Install .NET SDK or .NET Runtime on Ubuntu</a>
for further details.</p><h2 id=review-the-net-application>Review the .NET Application</h2><p>In the terminal, navigate to the application directory:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/workshop/docker-k8s-otel/helloworld</span></span></code></pre></div><p>We&rsquo;ll use a simple &ldquo;Hello World&rdquo; .NET application for this workshop. The main logic is found
in the HelloWorldController.cs file:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kd>public</span> <span class=k>class</span> <span class=nc>HelloWorldController</span> <span class=p>:</span> <span class=n>ControllerBase</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>ILogger</span><span class=p>&lt;</span><span class=n>HelloWorldController</span><span class=p>&gt;</span> <span class=n>logger</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>HelloWorldController</span><span class=p>(</span><span class=n>ILogger</span><span class=p>&lt;</span><span class=n>HelloWorldController</span><span class=p>&gt;</span> <span class=n>logger</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=n>logger</span> <span class=p>=</span> <span class=n>logger</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>    [HttpGet(&#34;/hello/{name?}&#34;)]</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>string</span> <span class=n>Hello</span><span class=p>(</span><span class=kt>string</span> <span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>IsNullOrEmpty</span><span class=p>(</span><span class=n>name</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>           <span class=n>logger</span><span class=p>.</span><span class=n>LogInformation</span><span class=p>(</span><span class=s>&#34;/hello endpoint invoked anonymously&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>           <span class=k>return</span> <span class=s>&#34;Hello, World!&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=p>.</span><span class=n>LogInformation</span><span class=p>(</span><span class=s>&#34;/hello endpoint invoked by {name}&#34;</span><span class=p>,</span> <span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>String</span><span class=p>.</span><span class=n>Format</span><span class=p>(</span><span class=s>&#34;Hello, {0}!&#34;</span><span class=p>,</span> <span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h2 id=build-and-run-the-net-application>Build and Run the .NET Application</h2><p>We can build the application using the following command:</p><div class=tab-panel data-tab-group=8546a29f7969d3676e01f5e566679f97><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8546a29f7969d3676e01f5e566679f97","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("8546a29f7969d3676e01f5e566679f97","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dotnet build</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>MSBuild version 17.8.5+b5265ef37 <span class=k>for</span> .NET
</span></span><span class=line><span class=cl>  Determining projects to restore...
</span></span><span class=line><span class=cl>  All projects are up-to-date <span class=k>for</span> restore.
</span></span><span class=line><span class=cl>  helloworld -&gt; /home/splunk/workshop/docker-k8s-otel/helloworld/bin/Debug/net8.0/helloworld.dll
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Build succeeded.
</span></span><span class=line><span class=cl>    <span class=m>0</span> Warning<span class=o>(</span>s<span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=m>0</span> Error<span class=o>(</span>s<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Time Elapsed 00:00:02.04</span></span></code></pre></div></div></div></div></div><p>If that&rsquo;s successful, we can run it as follows:</p><div class=tab-panel data-tab-group=598e0bd9391a5e08ef87fe23f65aa54f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("598e0bd9391a5e08ef87fe23f65aa54f","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("598e0bd9391a5e08ef87fe23f65aa54f","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dotnet run</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Building...
</span></span><span class=line><span class=cl>info: Microsoft.Hosting.Lifetime<span class=o>[</span>14<span class=o>]</span>
</span></span><span class=line><span class=cl>      Now listening on: http://localhost:8080
</span></span><span class=line><span class=cl>info: Microsoft.Hosting.Lifetime<span class=o>[</span>0<span class=o>]</span>
</span></span><span class=line><span class=cl>      Application started. Press Ctrl+C to shut down.
</span></span><span class=line><span class=cl>info: Microsoft.Hosting.Lifetime<span class=o>[</span>0<span class=o>]</span>
</span></span><span class=line><span class=cl>      Hosting environment: Development
</span></span><span class=line><span class=cl>info: Microsoft.Hosting.Lifetime<span class=o>[</span>0<span class=o>]</span>
</span></span><span class=line><span class=cl>      Content root path: /home/splunk/workshop/docker-k8s-otel/helloworld</span></span></code></pre></div></div></div></div></div><p>Once it&rsquo;s running, open a second SSH terminal to your Ubuntu instance and access the application using curl:</p><div class=tab-panel data-tab-group=b4203b07c1b55a157abf26ac22aedf22><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b4203b07c1b55a157abf26ac22aedf22","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("b4203b07c1b55a157abf26ac22aedf22","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://localhost:8080/hello</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Hello, World! </span></span></code></pre></div></div></div></div></div><p>You can also pass in your name:</p><div class=tab-panel data-tab-group=4d7e982134cc674876f36e63eb16ee5a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4d7e982134cc674876f36e63eb16ee5a","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("4d7e982134cc674876f36e63eb16ee5a","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://localhost:8080/hello/Tom</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Hello, Tom! </span></span></code></pre></div></div></div></div></div><blockquote><p>Press Ctrl + C to quit your Helloworld app before moving to the next step.</p></blockquote><h2 id=next-steps>Next Steps</h2><p>What are the three methods that we can use to instrument our application with OpenTelemetry?</p><p><a href=#R-image-7b3e38de6d1e37a24a81edc7a38f801f class=lightbox-link><img alt=Traces class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/NetInstrumentation.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-7b3e38de6d1e37a24a81edc7a38f801f><img alt=Traces class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/NetInstrumentation.png></a></p><p>See: <a href=https://docs.splunk.com/observability/en/gdi/get-data-in/application/otel-dotnet/instrumentation/instrument-dotnet-application.html rel=external target=_blank>Instrument your .NET application for Splunk Observability Cloud</a>
for a discussion of the options.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Feb 4, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=instrument-a-net-application-with-opentelemetry>Instrument a .NET Application with OpenTelemetry</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>20 minutes</span>
</span>&nbsp;<h2 id=download-the-splunk-distribution-of-opentelemetry>Download the Splunk Distribution of OpenTelemetry</h2><p>For this workshop, we&rsquo;ll install the Splunk Distribution of OpenTelemetry manually rather than
using the NuGet packages.</p><p>We&rsquo;ll start by downloading the latest <code>splunk-otel-dotnet-install.sh</code> file,
which we&rsquo;ll use to instrument our .NET application:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/workshop/docker-k8s-otel/helloworld
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>curl -sSfL https://github.com/signalfx/splunk-otel-dotnet/releases/latest/download/splunk-otel-dotnet-install.sh -O</span></span></code></pre></div><p>Refer to <a href=https://docs.splunk.com/observability/en/gdi/get-data-in/application/otel-dotnet/instrumentation/instrument-dotnet-application.html#install-the-splunk-distribution-of-opentelemetry-net-manually rel=external target=_blank>Install the Splunk Distribution of OpenTelemetry .NET manually</a>
for further details on the installation process.</p><h2 id=install-the-distribution>Install the Distribution</h2><p>In the terminal, install the distribution as follows</p><div class=tab-panel data-tab-group=6c225131c31c28857eb04e043876f836><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6c225131c31c28857eb04e043876f836","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("6c225131c31c28857eb04e043876f836","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sh ./splunk-otel-dotnet-install.sh</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Downloading v1.8.0 <span class=k>for</span> linux-glibc <span class=o>(</span>/tmp/tmp.m3tSdtbmge/splunk-opentelemetry-dotnet-linux-glibc-x64.zip<span class=o>)</span>...</span></span></code></pre></div></div></div></div></div><blockquote><p>Note: we may need to include the ARCHITECTURE environment when running the command above:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>ARCHITECTURE</span><span class=o>=</span>x64 sh ./splunk-otel-dotnet-install.sh</span></span></code></pre></div></blockquote><h2 id=activate-the-instrumentation>Activate the Instrumentation</h2><p>Next, we can activate the OpenTelemetry instrumentation:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. <span class=nv>$HOME</span>/.splunk-otel-dotnet/instrument.sh</span></span></code></pre></div><h2 id=set-the-deployment-environment>Set the Deployment Environment</h2><p>Let&rsquo;s set the deployment environment, to ensure our data flows into its own
environment within Splunk Observability Cloud:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>OTEL_RESOURCE_ATTRIBUTES</span><span class=o>=</span>deployment.environment<span class=o>=</span>otel-<span class=nv>$INSTANCE</span></span></span></code></pre></div><h2 id=run-the-application-with-instrumentation>Run the Application with Instrumentation</h2><p>We can run the application as follows:</p><div class="highlight wrap-code"><pre tabindex=0><code>dotnet run</code></pre></div><h2 id=a-challenge-for-you>A Challenge For You</h2><p>How can we see what traces are being exported by the .NET application from our Linux instance?</p><details><summary><b>Click here to see the answer</b></summary><p>There are two ways we can do this:</p><ol><li>We could add <code>OTEL_TRACES_EXPORTER=otlp,console</code> at the start of the <code>dotnet run</code> command, which ensures that traces are both written to collector via OTLP as well as the console.</li></ol><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>OTEL_TRACES_EXPORTER</span><span class=o>=</span>otlp,console dotnet run </span></span></code></pre></div><ol start=2><li>Alternatively, we could add the debug exporter to the collector configuration, and add it to the traces pipeline, which ensures the traces are written to the collector logs.</li></ol><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbosity</span><span class=p>:</span><span class=w> </span><span class=l>detailed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>jaeger, otlp, zipkin]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlphttp, signalfx, debug]</span></span></span></code></pre></div></details><h2 id=access-the-application>Access the Application</h2><p>Once the application is running, use a second SSH terminal and access it using curl:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://localhost:8080/hello</span></span></code></pre></div><p>As before, it should return <code>Hello, World!</code>.</p><p>If you enabled trace logging, you should see a trace written the console or collector logs such as the following:</p><div class="highlight wrap-code"><pre tabindex=0><code>info: Program[0]
      /hello endpoint invoked anonymously
Activity.TraceId:            c7bbf57314e4856447508cd8addd49b0
Activity.SpanId:             1c92ac653c3ece27
Activity.TraceFlags:         Recorded
Activity.ActivitySourceName: Microsoft.AspNetCore
Activity.DisplayName:        GET /hello/{name?}
Activity.Kind:               Server
Activity.StartTime:          2024-12-20T00:45:25.6551267Z
Activity.Duration:           00:00:00.0006464
Activity.Tags:
    server.address: localhost
    server.port: 8080
    http.request.method: GET
    url.scheme: http
    url.path: /hello
    network.protocol.version: 1.1
    user_agent.original: curl/7.81.0
    http.route: /hello/{name?}
    http.response.status_code: 200
Resource associated with Activity:
    splunk.distro.version: 1.8.0
    telemetry.distro.name: splunk-otel-dotnet
    telemetry.distro.version: 1.8.0
    service.name: helloworld
    os.type: linux
    os.description: Ubuntu 22.04.5 LTS
    os.build_id: 6.8.0-1021-aws
    os.name: Ubuntu
    os.version: 22.04
    host.name: derek-1
    host.id: 20cf15fcc7054b468647b73b8f87c556
    process.owner: splunk
    process.pid: 16997
    process.runtime.description: .NET 8.0.11
    process.runtime.name: .NET
    process.runtime.version: 8.0.11
    container.id: 2
    telemetry.sdk.name: opentelemetry
    telemetry.sdk.language: dotnet
    telemetry.sdk.version: 1.9.0
    deployment.environment: otel-derek-1</code></pre></div><h2 id=view-your-application-in-splunk-observability-cloud>View your application in Splunk Observability Cloud</h2><p>Now that the setup is complete, let&rsquo;s confirm that traces are sent to <strong>Splunk Observability Cloud</strong>. Note that when the application is deployed for the first time, it may take a few minutes for the data to appear.</p><p>Navigate to APM, then use the Environment dropdown to select your environment (i.e. <code>otel-instancename</code>).</p><p>If everything was deployed correctly, you should see <code>helloworld</code> displayed in the list of services:</p><p><a href=#R-image-8cc52c29043683a3b1dcb81c5d0d1899 class=lightbox-link><img alt="APM Overview" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/apm_overview.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8cc52c29043683a3b1dcb81c5d0d1899><img alt="APM Overview" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/apm_overview.png></a></p><p>Click on <strong>Service Map</strong> on the right-hand side to view the service map.</p><p><a href=#R-image-ca369df3b1854dcd636faf4a3492e424 class=lightbox-link><img alt="Service Map" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/service_map.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ca369df3b1854dcd636faf4a3492e424><img alt="Service Map" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/service_map.png></a></p><p>Next, click on <strong>Traces</strong> on the right-hand side to see the traces captured for this application.</p><p><a href=#R-image-df4b09fe803283cbb2b9f818fd489b50 class=lightbox-link><img alt=Traces class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/traces.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-df4b09fe803283cbb2b9f818fd489b50><img alt=Traces class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/traces.png></a></p><p>An individual trace should look like the following:</p><p><a href=#R-image-1f597aebc41e9461250d70f09bd01bbf class=lightbox-link><img alt=Traces class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/trace.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-1f597aebc41e9461250d70f09bd01bbf><img alt=Traces class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/trace.png></a></p><blockquote><p>Press Ctrl + C to quit your Helloworld app before moving to the next step.</p></blockquote><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Jan 17, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=dockerize-the-application>Dockerize the Application</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>15 minutes</span>
</span>&nbsp;<p>Later on in this workshop, we&rsquo;re going to deploy our .NET application into a Kubernetes cluster.</p><p>But how do we do that?</p><p>The first step is to create a Docker image for our application. This is known as
&ldquo;dockerizing&rdquo; and application, and the process begins with the creation of a <code>Dockerfile</code>.</p><p>But first, let&rsquo;s define some key terms.</p><h2 id=key-terms>Key Terms</h2><h3 id=what-is-docker>What is Docker?</h3><p><em>&ldquo;Docker provides the ability to package and run an application in a loosely isolated environment
called a container. The isolation and security lets you run many containers simultaneously on
a given host. Containers are lightweight and contain everything needed to run the application,
so you don&rsquo;t need to rely on what&rsquo;s installed on the host.&rdquo;</em></p><p>Source: <a href=https://docs.docker.com/get-started/docker-overview/ rel=external target=_blank>https://docs.docker.com/get-started/docker-overview/</a></p><h3 id=what-is-a-container>What is a container?</h3><p><em>&ldquo;Containers are isolated processes for each of your app&rsquo;s components. Each component
&mldr;runs in its own isolated environment,
completely isolated from everything else on your machine.&rdquo;</em></p><p>Source: <a href=https://docs.docker.com/get-started/docker-concepts/the-basics/what-is-a-container/ rel=external target=_blank>https://docs.docker.com/get-started/docker-concepts/the-basics/what-is-a-container/</a></p><h3 id=what-is-a-container-image>What is a container image?</h3><p><em>&ldquo;A container image is a standardized package that includes all of the files, binaries,
libraries, and configurations to run a container.&rdquo;</em></p><h3 id=dockerfile>Dockerfile</h3><p><em>&ldquo;A Dockerfile is a text-based document that&rsquo;s used to create a container image. It provides
instructions to the image builder on the commands to run, files to copy, startup command, and more.&rdquo;</em></p><h2 id=create-a-dockerfile>Create a Dockerfile</h2><p>Let&rsquo;s create a file named <code>Dockerfile</code> in the <code>/home/splunk/workshop/docker-k8s-otel/helloworld</code> directory.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /home/splunk/workshop/docker-k8s-otel/helloworld</span></span></code></pre></div><p>You can use vi or nano to create the file. We will show an example using vi:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi Dockerfile</span></span></code></pre></div><p>Copy and paste the following content into the newly opened file:</p><blockquote><p>Press &lsquo;i&rsquo; to enter into insert mode in vi before pasting the text below.</p></blockquote><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> mcr.microsoft.com/dotnet/aspnet:8.0 AS base</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>USER</span><span class=s> app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>EXPOSE</span><span class=s> 8080</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> mcr.microsoft.com/dotnet/sdk:8.0 AS build</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>BUILD_CONFIGURATION</span><span class=o>=</span>Release
</span></span><span class=line><span class=cl><span class=k>WORKDIR</span><span class=s> /src</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> <span class=o>[</span><span class=s2>&#34;helloworld.csproj&#34;</span>, <span class=s2>&#34;helloworld/&#34;</span><span class=o>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet restore <span class=s2>&#34;./helloworld/./helloworld.csproj&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> &#34;/src/helloworld&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet build <span class=s2>&#34;./helloworld.csproj&#34;</span> -c <span class=nv>$BUILD_CONFIGURATION</span> -o /app/build<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> build AS publish</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>BUILD_CONFIGURATION</span><span class=o>=</span>Release
</span></span><span class=line><span class=cl><span class=k>RUN</span> dotnet publish <span class=s2>&#34;./helloworld.csproj&#34;</span> -c <span class=nv>$BUILD_CONFIGURATION</span> -o /app/publish /p:UseAppHost<span class=o>=</span>false<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> base AS final</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>publish /app/publish .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;dotnet&#34;</span><span class=p>,</span> <span class=s2>&#34;helloworld.dll&#34;</span><span class=p>]</span></span></span></code></pre></div><blockquote><p>To save your changes in vi, press the <code>esc</code> key to enter command mode, then type <code>:wq!</code> followed by pressing the <code>enter/return</code> key.</p></blockquote><p>What does all this mean? Let&rsquo;s break it down.</p><h2 id=walking-through-the-dockerfile>Walking through the Dockerfile</h2><p>We&rsquo;ve used a multi-stage Dockerfile for this example, which separates the Docker image creation process into the following stages:</p><ul><li>Base</li><li>Build</li><li>Publish</li><li>Final</li></ul><p>While a multi-stage approach is more complex, it allows us to create a
lighter-weight runtime image for deployment. We&rsquo;ll explain the purpose of
each of these stages below.</p><h3 id=the-base-stage>The Base Stage</h3><p>The base stage defines the user that will
be running the app, the working directory, and exposes
the port that will be used to access the app.
It&rsquo;s based off of Microsoft&rsquo;s <code>mcr.microsoft.com/dotnet/aspnet:8.0</code> image:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> mcr.microsoft.com/dotnet/aspnet:8.0 AS base</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>USER</span><span class=s> app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>EXPOSE</span><span class=s> 8080</span></span></span></code></pre></div><p>Note that the <code>mcr.microsoft.com/dotnet/aspnet:8.0</code> image includes the .NET runtime only,
rather than the SDK, so is relatively lightweight. It&rsquo;s based off of the Debian 12 Linux
distribution. You can find more information about the ASP.NET Core Runtime Docker images
in <a href=https://github.com/dotnet/dotnet-docker/blob/main/README.aspnet.md rel=external target=_blank>GitHub</a>.</p><h3 id=the-build-stage>The Build Stage</h3><p>The next stage of the Dockerfile is the build stage. For this stage, the
<code>mcr.microsoft.com/dotnet/sdk:8.0</code> image is used, which is also based off of
Debian 12 but includes the full <a href=https://github.com/dotnet/dotnet-docker/blob/main/README.sdk.md rel=external target=_blank>.NET SDK</a> rather than just the runtime.</p><p>This stage copies the <code>.csproj</code> file to the build image, and then uses <code>dotnet restore</code> to
download any dependencies used by the application.</p><p>It then copies the application code to the build image and
uses <code>dotnet build</code> to build the project and its dependencies into a
set of <code>.dll</code> binaries:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> mcr.microsoft.com/dotnet/sdk:8.0 AS build</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>BUILD_CONFIGURATION</span><span class=o>=</span>Release
</span></span><span class=line><span class=cl><span class=k>WORKDIR</span><span class=s> /src</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> <span class=o>[</span><span class=s2>&#34;helloworld.csproj&#34;</span>, <span class=s2>&#34;helloworld/&#34;</span><span class=o>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet restore <span class=s2>&#34;./helloworld/./helloworld.csproj&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> &#34;/src/helloworld&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet build <span class=s2>&#34;./helloworld.csproj&#34;</span> -c <span class=nv>$BUILD_CONFIGURATION</span> -o /app/build</span></span></code></pre></div><h3 id=the-publish-stage>The Publish Stage</h3><p>The third stage is publish, which is based on build stage image rather than a Microsoft image. In this stage, <code>dotnet publish</code> is used to
package the application and its dependencies for deployment:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> build AS publish</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>BUILD_CONFIGURATION</span><span class=o>=</span>Release
</span></span><span class=line><span class=cl><span class=k>RUN</span> dotnet publish <span class=s2>&#34;./helloworld.csproj&#34;</span> -c <span class=nv>$BUILD_CONFIGURATION</span> -o /app/publish /p:UseAppHost<span class=o>=</span>false</span></span></code></pre></div><h3 id=the-final-stage>The Final Stage</h3><p>The fourth stage is our final stage, which is based on the base
stage image (which is lighter-weight than the build and publish stages). It copies the output from the publish stage image and
defines the entry point for our application:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> base AS final</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>publish /app/publish .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;dotnet&#34;</span><span class=p>,</span> <span class=s2>&#34;helloworld.dll&#34;</span><span class=p>]</span></span></span></code></pre></div><h2 id=build-a-docker-image>Build a Docker Image</h2><p>Now that we have the <code>Dockerfile</code>, we can use it to build a Docker image containing
our application:</p><div class=tab-panel data-tab-group=2aefdcf9377d7388ae3a3b488c50d6bb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2aefdcf9377d7388ae3a3b488c50d6bb","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("2aefdcf9377d7388ae3a3b488c50d6bb","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker build -t helloworld:1.0 .</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>DEPRECATED: The legacy builder is deprecated and will be removed in a future release.
</span></span><span class=line><span class=cl>            Install the buildx component to build images with BuildKit:
</span></span><span class=line><span class=cl>            https://docs.docker.com/go/buildx/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Sending build context to Docker daemon  281.1kB
</span></span><span class=line><span class=cl>Step 1/19 : FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS base
</span></span><span class=line><span class=cl>8.0: Pulling from dotnet/aspnet
</span></span><span class=line><span class=cl>af302e5c37e9: Pull <span class=nb>complete</span> 
</span></span><span class=line><span class=cl>91ab5e0aabf0: Pull <span class=nb>complete</span> 
</span></span><span class=line><span class=cl>1c1e4530721e: Pull <span class=nb>complete</span> 
</span></span><span class=line><span class=cl>1f39ca6dcc3a: Pull <span class=nb>complete</span> 
</span></span><span class=line><span class=cl>ea20083aa801: Pull <span class=nb>complete</span> 
</span></span><span class=line><span class=cl>64c242a4f561: Pull <span class=nb>complete</span> 
</span></span><span class=line><span class=cl>Digest: sha256:587c1dd115e4d6707ff656d30ace5da9f49cec48e627a40bbe5d5b249adc3549
</span></span><span class=line><span class=cl>Status: Downloaded newer image <span class=k>for</span> mcr.microsoft.com/dotnet/aspnet:8.0
</span></span><span class=line><span class=cl> ---&gt; 0ee5d7ddbc3b
</span></span><span class=line><span class=cl>Step 2/19 : USER app
</span></span><span class=line><span class=cl>etc,</span></span></code></pre></div></div></div></div></div><p>This tells Docker to build an image using a tag of <code>helloworld:1.0</code> using the <code>Dockerfile</code> in the current directory.</p><p>We can confirm it was created successfully with the following command:</p><div class=tab-panel data-tab-group=f3246bfab64e8c644e93053f6620c8a9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f3246bfab64e8c644e93053f6620c8a9","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("f3246bfab64e8c644e93053f6620c8a9","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker images</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>REPOSITORY   TAG       IMAGE ID       CREATED          SIZE
</span></span><span class=line><span class=cl>helloworld   1.0       db19077b9445   <span class=m>20</span> seconds ago   217MB</span></span></code></pre></div></div></div></div></div><h2 id=test-the-docker-image>Test the Docker Image</h2><blockquote><p>Before proceeding, ensure the application we started before is no longer running on your instance.</p></blockquote><p>We can run our application using the Docker image as follows:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run --name helloworld <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--detach <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--expose <span class=m>8080</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--network<span class=o>=</span>host <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>helloworld:1.0</span></span></code></pre></div><blockquote><p>Note: we&rsquo;ve included the <code>--network=host</code> parameter to ensure our Docker container
is able to access resources on our instance, which is important later on when we need
our application to send data to the collector running on localhost.</p></blockquote><p>Let&rsquo;s ensure that our Docker container is running:</p><div class=tab-panel data-tab-group=33efda840359e650119a05cad9eff8cd><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("33efda840359e650119a05cad9eff8cd","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("33efda840359e650119a05cad9eff8cd","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker ps</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ docker ps
</span></span><span class=line><span class=cl>CONTAINER ID   IMAGE            COMMAND                  CREATED       STATUS       PORTS     NAMES
</span></span><span class=line><span class=cl>5f5b9cd56ac5   helloworld:1.0   <span class=s2>&#34;dotnet helloworld.dâ€¦&#34;</span>   <span class=m>2</span> mins ago    Up <span class=m>2</span> mins              helloworld</span></span></code></pre></div></div></div></div></div><p>We can access our application as before:</p><div class=tab-panel data-tab-group=69aee0b4da57161bd860bc207f94c0c7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("69aee0b4da57161bd860bc207f94c0c7","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("69aee0b4da57161bd860bc207f94c0c7","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://localhost:8080/hello/Docker</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Hello, Docker! </span></span></code></pre></div></div></div></div></div><p>Congratulations, if you&rsquo;ve made it this far, you&rsquo;ve successfully Dockerized a .NET application.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Feb 3, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=add-instrumentation-to-dockerfile>Add Instrumentation to Dockerfile</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<p>Now that we&rsquo;ve successfully Dockerized our application, let&rsquo;s add in OpenTelemetry instrumentation.</p><p>This is similar to the steps we took when instrumenting the application running on Linux, but there
are some key differences to be aware of.</p><h2 id=update-the-dockerfile>Update the Dockerfile</h2><p>Let&rsquo;s update the <code>Dockerfile</code> in the <code>/home/splunk/workshop/docker-k8s-otel/helloworld</code> directory.</p><p>After the .NET application is built in the Dockerfile, we want to:</p><ul><li>Add dependencies needed to download and execute <code>splunk-otel-dotnet-install.sh</code></li><li>Download the Splunk OTel .NET installer</li><li>Install the distribution</li></ul><p>We can add the following to the build stage of the Dockerfile. Let&rsquo;s open the Dockerfile in vi:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi /home/splunk/workshop/docker-k8s-otel/helloworld/Dockerfile</span></span></code></pre></div><blockquote><p>Press the i key to enter edit mode in vi</p></blockquote><blockquote><p>Paste the lines marked with &lsquo;NEW CODE&rsquo; into your Dockerfile in the build stage section:</p></blockquote><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=c># CODE ALREADY IN YOUR DOCKERFILE:</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> mcr.microsoft.com/dotnet/sdk:8.0 AS build</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>BUILD_CONFIGURATION</span><span class=o>=</span>Release
</span></span><span class=line><span class=cl><span class=k>WORKDIR</span><span class=s> /src</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> <span class=o>[</span><span class=s2>&#34;helloworld.csproj&#34;</span>, <span class=s2>&#34;helloworld/&#34;</span><span class=o>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet restore <span class=s2>&#34;./helloworld/./helloworld.csproj&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> &#34;/src/helloworld&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet build <span class=s2>&#34;./helloworld.csproj&#34;</span> -c <span class=nv>$BUILD_CONFIGURATION</span> -o /app/build<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: add dependencies for splunk-otel-dotnet-install.sh</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apt-get update <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	apt-get install -y unzip<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: download Splunk OTel .NET installer</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> curl -sSfL https://github.com/signalfx/splunk-otel-dotnet/releases/latest/download/splunk-otel-dotnet-install.sh -O<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: install the distribution</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> sh ./splunk-otel-dotnet-install.sh</span></span></code></pre></div><p>Next, we&rsquo;ll update the final stage of the Dockerfile with the following changes:</p><ul><li>Copy the /root/.splunk-otel-dotnet/ from the build image to the final image</li><li>Copy the entrypoint.sh file as well</li><li>Set the <code>OTEL_SERVICE_NAME</code> and <code>OTEL_RESOURCE_ATTRIBUTES</code> environment variables</li><li>Set the <code>ENTRYPOINT</code> to <code>entrypoint.sh</code></li></ul><p>It&rsquo;s easiest to simply replace the entire final stage with the following:</p><blockquote><p><strong>IMPORTANT</strong> replace <code>$INSTANCE</code> in your Dockerfile with your instance name,
which can be determined by running <code>echo $INSTANCE</code>.</p></blockquote><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=c># CODE ALREADY IN YOUR DOCKERFILE</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> base AS final</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: Copy instrumentation file tree</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> &#34;//home/app/.splunk-otel-dotnet&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>build /root/.splunk-otel-dotnet/ .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># CODE ALREADY IN YOUR DOCKERFILE</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>publish /app/publish .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: copy the entrypoint.sh script</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> entrypoint.sh .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: set OpenTelemetry environment variables</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> <span class=nv>OTEL_SERVICE_NAME</span><span class=o>=</span>helloworld
</span></span><span class=line><span class=cl><span class=k>ENV</span> <span class=nv>OTEL_RESOURCE_ATTRIBUTES</span><span class=o>=</span><span class=s1>&#39;deployment.environment=otel-$INSTANCE&#39;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: replace the prior ENTRYPOINT command with the following two lines </span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;sh&#34;</span><span class=p>,</span> <span class=s2>&#34;entrypoint.sh&#34;</span><span class=p>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;dotnet&#34;</span><span class=p>,</span> <span class=s2>&#34;helloworld.dll&#34;</span><span class=p>]</span></span></span></code></pre></div><blockquote><p>To save your changes in vi, press the <code>esc</code> key to enter command mode, then type <code>:wq!</code> followed by pressing the <code>enter/return</code> key.</p></blockquote><p>After all of these changes, the Dockerfile should look like the following:</p><blockquote><p><strong>IMPORTANT</strong> if you&rsquo;re going to copy and paste this content into your own Dockerfile,
replace <code>$INSTANCE</code> in your Dockerfile with your instance name,
which can be determined by running <code>echo $INSTANCE</code>.</p></blockquote><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> mcr.microsoft.com/dotnet/aspnet:8.0 AS base</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>USER</span><span class=s> app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>EXPOSE</span><span class=s> 8080</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> mcr.microsoft.com/dotnet/sdk:8.0 AS build</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>BUILD_CONFIGURATION</span><span class=o>=</span>Release
</span></span><span class=line><span class=cl><span class=k>WORKDIR</span><span class=s> /src</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> <span class=o>[</span><span class=s2>&#34;helloworld.csproj&#34;</span>, <span class=s2>&#34;helloworld/&#34;</span><span class=o>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet restore <span class=s2>&#34;./helloworld/./helloworld.csproj&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> &#34;/src/helloworld&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet build <span class=s2>&#34;./helloworld.csproj&#34;</span> -c <span class=nv>$BUILD_CONFIGURATION</span> -o /app/build<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: add dependencies for splunk-otel-dotnet-install.sh</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apt-get update <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	apt-get install -y unzip<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: download Splunk OTel .NET installer</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> curl -sSfL https://github.com/signalfx/splunk-otel-dotnet/releases/latest/download/splunk-otel-dotnet-install.sh -O<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: install the distribution</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> sh ./splunk-otel-dotnet-install.sh<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> build AS publish</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>BUILD_CONFIGURATION</span><span class=o>=</span>Release
</span></span><span class=line><span class=cl><span class=k>RUN</span> dotnet publish <span class=s2>&#34;./helloworld.csproj&#34;</span> -c <span class=nv>$BUILD_CONFIGURATION</span> -o /app/publish /p:UseAppHost<span class=o>=</span>false<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> base AS final</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: Copy instrumentation file tree</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> &#34;//home/app/.splunk-otel-dotnet&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>build /root/.splunk-otel-dotnet/ .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>publish /app/publish .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: copy the entrypoint.sh script</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> entrypoint.sh .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: set OpenTelemetry environment variables</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> <span class=nv>OTEL_SERVICE_NAME</span><span class=o>=</span>helloworld
</span></span><span class=line><span class=cl><span class=k>ENV</span> <span class=nv>OTEL_RESOURCE_ATTRIBUTES</span><span class=o>=</span><span class=s1>&#39;deployment.environment=otel-$INSTANCE&#39;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: replace the prior ENTRYPOINT command with the following two lines </span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;sh&#34;</span><span class=p>,</span> <span class=s2>&#34;entrypoint.sh&#34;</span><span class=p>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;dotnet&#34;</span><span class=p>,</span> <span class=s2>&#34;helloworld.dll&#34;</span><span class=p>]</span></span></span></code></pre></div><h2 id=create-the-entrypointsh-file>Create the entrypoint.sh file</h2><p>We also need to create a file named <code>entrypoint.sh</code> in the <code>/home/splunk/workshop/docker-k8s-otel/helloworld</code> folder
with the following content:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi /home/splunk/workshop/docker-k8s-otel/helloworld/entrypoint.sh</span></span></code></pre></div><p>Then paste the following code into the newly created file:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># Read in the file of environment settings</span>
</span></span><span class=line><span class=cl>. /<span class=nv>$HOME</span>/.splunk-otel-dotnet/instrument.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Then run the CMD</span>
</span></span><span class=line><span class=cl><span class=nb>exec</span> <span class=s2>&#34;</span><span class=nv>$@</span><span class=s2>&#34;</span></span></span></code></pre></div><blockquote><p>To save your changes in vi, press the <code>esc</code> key to enter command mode, then type <code>:wq!</code> followed by pressing the <code>enter/return</code> key.</p></blockquote><p>The <code>entrypoint.sh</code> script is required for sourcing environment variables from the instrument.sh script,
which is included with the instrumentation. This ensures the correct setup of environment variables
for each platform.</p><blockquote><p>You may be wondering, why can&rsquo;t we just include the following command in the Dockerfile to do this,
like we did when activating OpenTelemetry .NET instrumentation on our Linux host?</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>RUN</span> . <span class=nv>$HOME</span>/.splunk-otel-dotnet/instrument.sh</span></span></code></pre></div><p>The problem with this approach is that each Dockerfile RUN step runs a new container and a new shell.
If you try to set an environment variable in one shell, it will not be visible later on.
This problem is resolved by using an entry point script, as we&rsquo;ve done here.
Refer to this <a href=https://stackoverflow.com/questions/55921914/how-to-source-a-script-with-environment-variables-in-a-docker-build-process rel=external target=_blank>Stack Overflow post</a>
for further details on this issue.</p></blockquote><h2 id=build-the-docker-image>Build the Docker Image</h2><p>Let&rsquo;s build a new Docker image that includes the OpenTelemetry .NET instrumentation:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker build -t helloworld:1.1 .</span></span></code></pre></div><blockquote><p>Note: we&rsquo;ve used a different version (1.1) to distinguish the image from our earlier version.
To clean up the older versions, run the following command to get the container id:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker ps -a</span></span></code></pre></div><p>Then run the following command to delete the container:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker rm &lt;old container id&gt; --force</span></span></code></pre></div><p>Now we can get the container image id:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker images <span class=p>|</span> grep 1.0</span></span></code></pre></div><p>Finally, we can run the following command to delete the old image:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker image rm &lt;old image id&gt;</span></span></code></pre></div></blockquote><h2 id=run-the-application>Run the Application</h2><p>Let&rsquo;s run the new Docker image:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run --name helloworld <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--detach <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--expose <span class=m>8080</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--network<span class=o>=</span>host <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>helloworld:1.1</span></span></code></pre></div><p>We can access the application using:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://localhost:8080/hello</span></span></code></pre></div><p>Execute the above command a few times to generate some traffic.</p><p>After a minute or so, confirm that you see new traces in Splunk Observability Cloud.</p><blockquote><p>Remember to look for traces in your particular Environment.</p></blockquote><h2 id=troubleshooting>Troubleshooting</h2><p>If you don&rsquo;t see traces appear in Splunk Observability Cloud, here&rsquo;s how you can troubleshoot.</p><p>First, open the collector config file for editing:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi /etc/otel/collector/agent_config.yaml</span></span></code></pre></div><p>Next, add the debug exporter to the traces pipeline, which ensures the traces are written to the collector logs:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>health_check, http_forwarder, zpages, smartagent]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>jaeger, otlp, zipkin]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#- resource/add_environment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># NEW CODE: add the debug exporter here</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlphttp, signalfx, debug]</span></span></span></code></pre></div><p>Then, restart the collector to apply the configuration changes:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl restart splunk-otel-collector</span></span></code></pre></div><p>We can then view the collector logs using <code>journalctl</code>:</p><blockquote><p>Press Ctrl + C to exit out of tailing the log.</p></blockquote><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo journalctl -u splunk-otel-collector -f -n <span class=m>100</span></span></span></code></pre></div><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Feb 5, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=install-the-opentelemetry-collector-in-k8s>Install the OpenTelemetry Collector in K8s</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>15 minutes</span>
</span>&nbsp;<h2 id=recap-of-part-1-of-the-workshop>Recap of Part 1 of the Workshop</h2><p>At this point in the workshop, we&rsquo;ve successfully:</p><ul><li>Deployed the Splunk distribution of the OpenTelemetry Collector on our Linux Host</li><li>Configured it to send traces and metrics to Splunk Observability Cloud</li><li>Deployed a .NET application and instrumented it with OpenTelemetry</li><li>Dockerized the .NET application and ensured traces are flowing to o11y cloud</li></ul><p>If you <strong>haven&rsquo;t</strong> completed the steps listed above, please execute the following commands before proceeding with
the remainder of the workshop:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cp /home/splunk/workshop/docker-k8s-otel/docker/Dockerfile /home/splunk/workshop/docker-k8s-otel/helloworld/
</span></span><span class=line><span class=cl>cp /home/splunk/workshop/docker-k8s-otel/docker/entrypoint.sh /home/splunk/workshop/docker-k8s-otel/helloworld/</span></span></code></pre></div><blockquote><p><strong>IMPORTANT</strong> once these files are copied, open <code>/home/splunk/workshop/docker-k8s-otel/helloworld/Dockerfile</code><br>with an editor and replace <code>$INSTANCE</code> in your Dockerfile with your instance name,
which can be determined by running <code>echo $INSTANCE</code>.</p></blockquote><h2 id=introduction-to-part-2-of-the-workshop>Introduction to Part 2 of the Workshop</h2><p>In the next part of the workshop, we want to run the application in Kubernetes,
so we&rsquo;ll need to deploy the Splunk distribution of the OpenTelemetry Collector
in our Kubernetes cluster.</p><p>Let&rsquo;s define some key terms first.</p><h3 id=key-terms>Key Terms</h3><h4 id=what-is-kubernetes>What is Kubernetes?</h4><p><em>&ldquo;Kubernetes is a portable, extensible, open source platform for managing containerized
workloads and services, that facilitates both declarative configuration and automation.&rdquo;</em></p><p>Source: <a href=https://kubernetes.io/docs/concepts/overview/ rel=external target=_blank>https://kubernetes.io/docs/concepts/overview/</a></p><p>We&rsquo;ll deploy the Docker image we built earlier for our application into our Kubernetes cluster, after making
a small modification to the Dockerfile.</p><h4 id=what-is-helm>What is Helm?</h4><p>Helm is a package manager for Kubernetes.</p><p><em>â€œIt helps you define, install, and upgrade even the most complex Kubernetes application.â€</em></p><p>Source: <a href=https://helm.sh/ rel=external target=_blank>https://helm.sh/</a></p><p>We&rsquo;ll use Helm to deploy the OpenTelemetry collector in our K8s cluster.</p><h4 id=benefits-of-helm>Benefits of Helm</h4><ul><li>Manage Complexity<ul><li>deal with a single values.yaml file rather than dozens of manifest files</li></ul></li><li>Easy Updates<ul><li>in-place upgrades</li></ul></li><li>Rollback support<ul><li>Just use helm rollback to roll back to an older version of a release</li></ul></li></ul><h2 id=uninstall-the-host-collector>Uninstall the Host Collector</h2><p>Before moving forward, letâ€™s remove the collector we installed earlier on the Linux host:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -sSL https://dl.signalfx.com/splunk-otel-collector.sh &gt; /tmp/splunk-otel-collector.sh<span class=p>;</span>
</span></span><span class=line><span class=cl>sudo sh /tmp/splunk-otel-collector.sh --uninstall</span></span></code></pre></div><h2 id=install-the-collector-using-helm>Install the Collector using Helm</h2><p>Letâ€™s use the command line rather than the in-product wizard to create our own
<code>helm</code> command to install the collector.</p><p>We first need to add the helm repo:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm repo add splunk-otel-collector-chart https://signalfx.github.io/splunk-otel-collector-chart</span></span></code></pre></div><p>And ensure the repo is up-to-date:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm repo update</span></span></code></pre></div><p>To configure the helm chart deployment, let&rsquo;s create a new file named <code>values.yaml</code> in
the <code>/home/splunk</code> directory:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># swith to the /home/splunk dir</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> /home/splunk
</span></span><span class=line><span class=cl><span class=c1># create a values.yaml file in vi</span>
</span></span><span class=line><span class=cl>vi values.yaml</span></span></code></pre></div><blockquote><p>Press â€˜iâ€™ to enter into insert mode in vi before pasting the text below.</p></blockquote><p>Then paste the following contents:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>logsEngine</span><span class=p>:</span><span class=w> </span><span class=l>otel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>agent</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hostmetrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>collection_interval</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>root_path</span><span class=p>:</span><span class=w> </span><span class=l>/hostfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>scrapers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>disk</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>filesystem</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>exclude_mount_points</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>match_type</span><span class=p>:</span><span class=w> </span><span class=l>regexp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>mount_points</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=l>/var/*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=l>/snap/*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=l>/boot/*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=l>/boot</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=l>/opt/orbstack/*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=l>/mnt/machines/*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=l>/Users/*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>load</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>network</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>paging</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>processes</span><span class=p>:</span><span class=w> </span><span class=kc>null</span></span></span></code></pre></div><blockquote><p>To save your changes in vi, press the <code>esc</code> key to enter command mode, then type <code>:wq!</code> followed by pressing the <code>enter/return</code> key.</p></blockquote><p>Now we can use the following command to install the collector:</p><div class=tab-panel data-tab-group=d8ec218347515db9d0efb1ea7fbc3bd5><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d8ec218347515db9d0efb1ea7fbc3bd5","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("d8ec218347515db9d0efb1ea7fbc3bd5","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>  helm install splunk-otel-collector --version 0.111.0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkObservability.realm=</span><span class=nv>$REALM</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkObservability.accessToken=</span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;clusterName=</span><span class=nv>$INSTANCE</span><span class=s2>-cluster&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;environment=otel-</span><span class=nv>$INSTANCE</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.token=</span><span class=nv>$HEC_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.endpoint=</span><span class=nv>$HEC_URL</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.index=splunk4rookies-workshop&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -f values.yaml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  splunk-otel-collector-chart/splunk-otel-collector </span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>NAME: splunk-otel-collector
</span></span><span class=line><span class=cl>LAST DEPLOYED: Fri Dec <span class=m>20</span> 01:01:43 <span class=m>2024</span>
</span></span><span class=line><span class=cl>NAMESPACE: default
</span></span><span class=line><span class=cl>STATUS: deployed
</span></span><span class=line><span class=cl>REVISION: <span class=m>1</span>
</span></span><span class=line><span class=cl>TEST SUITE: None
</span></span><span class=line><span class=cl>NOTES:
</span></span><span class=line><span class=cl>Splunk OpenTelemetry Collector is installed and configured to send data to Splunk Observability realm us1.</span></span></code></pre></div></div></div></div></div><h2 id=confirm-the-collector-is-running>Confirm the Collector is Running</h2><p>We can confirm whether the collector is running with the following command:</p><div class=tab-panel data-tab-group=41c3b5b55abe01628456a2c6864e7570><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("41c3b5b55abe01628456a2c6864e7570","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("41c3b5b55abe01628456a2c6864e7570","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pods</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>NAME                                                         READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>splunk-otel-collector-agent-8xvk8                            1/1     Running   <span class=m>0</span>          49s
</span></span><span class=line><span class=cl>splunk-otel-collector-k8s-cluster-receiver-d54857c89-tx7qr   1/1     Running   <span class=m>0</span>          49s</span></span></code></pre></div></div></div></div></div><h2 id=confirm-your-k8s-cluster-is-in-o11y-cloud>Confirm your K8s Cluster is in O11y Cloud</h2><p>In Splunk Observability Cloud, navigate to <strong>Infrastructure</strong> -> <strong>Kubernetes</strong> -> <strong>Kubernetes Clusters</strong>,
and then search for your cluster name (which is <code>$INSTANCE-cluster</code>):</p><p><a href=#R-image-23582660a23c5d08160a148e673e1359 class=lightbox-link><img alt="Kubernetes node" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/k8snode.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-23582660a23c5d08160a148e673e1359><img alt="Kubernetes node" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/k8snode.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Feb 5, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=deploy-application-to-k8s>Deploy Application to K8s</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>15 minutes</span>
</span>&nbsp;<h2 id=update-the-dockerfile>Update the Dockerfile</h2><p>With Kubernetes, environment variables are typically managed in the <code>.yaml</code> manifest files rather
than baking them into the Docker image. So let&rsquo;s remove the following two environment variables from the Dockerfile:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi /home/splunk/workshop/docker-k8s-otel/helloworld/Dockerfile</span></span></code></pre></div><p>Then remove the following two environment variables:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>ENV</span> <span class=nv>OTEL_SERVICE_NAME</span><span class=o>=</span>helloworld
</span></span><span class=line><span class=cl><span class=k>ENV</span> <span class=nv>OTEL_RESOURCE_ATTRIBUTES</span><span class=o>=</span><span class=s1>&#39;deployment.environment=otel-$INSTANCE&#39;</span></span></span></code></pre></div><blockquote><p>To save your changes in vi, press the <code>esc</code> key to enter command mode, then type <code>:wq!</code> followed by pressing the <code>enter/return</code> key.</p></blockquote><h2 id=build-a-new-docker-image>Build a new Docker Image</h2><p>Let&rsquo;s build a new Docker image that excludes the environment variables:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /home/splunk/workshop/docker-k8s-otel/helloworld 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>docker build -t helloworld:1.2 .</span></span></code></pre></div><blockquote><p>Note: we&rsquo;ve used a different version (1.2) to distinguish the image from our earlier version.
To clean up the older versions, run the following command to get the container id:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker ps -a</span></span></code></pre></div><p>Then run the following command to delete the container:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker rm &lt;old container id&gt; --force</span></span></code></pre></div><p>Now we can get the container image id:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker images <span class=p>|</span> grep 1.1</span></span></code></pre></div><p>Finally, we can run the following command to delete the old image:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker image rm &lt;old image id&gt;</span></span></code></pre></div></blockquote><h2 id=import-the-docker-image-to-kubernetes>Import the Docker Image to Kubernetes</h2><p>Normally weâ€™d push our Docker image to a repository such as Docker Hub.
But for this session, weâ€™ll use a workaround to import it to k3s directly.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /home/splunk
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Export the image from docker</span>
</span></span><span class=line><span class=cl>docker save --output helloworld.tar helloworld:1.2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Import the image into k3s</span>
</span></span><span class=line><span class=cl>sudo k3s ctr images import helloworld.tar</span></span></code></pre></div><h2 id=deploy-the-net-application>Deploy the .NET Application</h2><blockquote><p>Hint: To enter edit mode in vi, press the &lsquo;i&rsquo; key. To save changes, press the <code>esc</code> key to enter command mode, then type <code>:wq!</code> followed by pressing the <code>enter/return</code> key.</p></blockquote><p>To deploy our .NET application to K8s, let&rsquo;s create a file named <code>deployment.yaml</code> in <code>/home/splunk</code>:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi /home/splunk/deployment.yaml</span></span></code></pre></div><p>And paste in the following:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/library/helloworld:1.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>PORT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;8080&#34;</span></span></span></code></pre></div><details class="box cstyle notices tip expand"><summary class=box-label><i class="expander-icon fa-fw fas fa-chevron-right"></i>
<i class="fa-fw fas fa-lightbulb"></i>
What is a Deployment in Kubernetes?</summary><div class=box-content><p>The deployment.yaml file is a kubernetes config file that is used to define a deployment resource. This file is the cornerstone of managing applications in Kubernetes! The deployment config defines the deploymentâ€™s <em><strong>desired state</strong></em> and Kubernetes then ensures the <em><strong>actual</strong></em> state matches it. This allows application pods to self-heal and also allows for easy updates or roll backs to applications.</p></div></details><p>Then, create a second file in the same directory named <code>service.yaml</code>:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi /home/splunk/service.yaml</span></span></code></pre></div><p>And paste in the following:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span></span></span></code></pre></div><details class="box cstyle notices tip expand"><summary class=box-label><i class="expander-icon fa-fw fas fa-chevron-right"></i>
<i class="fa-fw fas fa-lightbulb"></i>
What is a Service in Kubernetes?</summary><div class=box-content><p>A Service in Kubernetes is an abstraction layer, working like a middleman, giving you a fixed IP address or DNS name to access your Pods, which stays the same, even if Pods are added, removed, or replaced over time.</p></div></details><p>We can then use these manifest files to deploy our application:</p><div class=tab-panel data-tab-group=bc34c437b08bdeb283db995065fc4350><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("bc34c437b08bdeb283db995065fc4350","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("bc34c437b08bdeb283db995065fc4350","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># create the deployment</span>
</span></span><span class=line><span class=cl>kubectl apply -f deployment.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># create the service</span>
</span></span><span class=line><span class=cl>kubectl apply -f service.yaml</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>deployment.apps/helloworld created
</span></span><span class=line><span class=cl>service/helloworld created</span></span></code></pre></div></div></div></div></div><h2 id=test-the-application>Test the Application</h2><p>To access our application, we need to first get the IP address:</p><div class=tab-panel data-tab-group=15bd40b2d7445db23ba69754bfdab41b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("15bd40b2d7445db23ba69754bfdab41b","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("15bd40b2d7445db23ba69754bfdab41b","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe svc helloworld <span class=p>|</span> grep IP:</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>IP:                10.43.102.103</span></span></code></pre></div></div></div></div></div><p>Then we can access the application by using the Cluster IP that was returned
from the previous command. For example:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://10.43.102.103:8080/hello/Kubernetes</span></span></code></pre></div><h2 id=configure-opentelemetry>Configure OpenTelemetry</h2><p>The .NET OpenTelemetry instrumentation was already baked into the Docker image. But we need to set a few
environment variables to tell it where to send the data.</p><p>Add the following to <code>deployment.yaml</code> file you created earlier:</p><blockquote><p><strong>IMPORTANT</strong> replace <code>$INSTANCE</code> in the YAML below with your instance name,
which can be determined by running <code>echo $INSTANCE</code>.</p></blockquote><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>          </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>PORT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;8080&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>NODE_IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>status.hostIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_EXPORTER_OTLP_ENDPOINT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;http://$(NODE_IP):4318&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_SERVICE_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;helloworld&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_RESOURCE_ATTRIBUTES </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;deployment.environment=otel-$INSTANCE&#34;</span><span class=w> </span></span></span></code></pre></div><p>The complete <code>deployment.yaml</code> file should be as follows (with <strong>your</strong> instance name rather than <code>$INSTANCE</code>):</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/library/helloworld:1.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>PORT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;8080&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>NODE_IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>status.hostIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_EXPORTER_OTLP_ENDPOINT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;http://$(NODE_IP):4318&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_SERVICE_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;helloworld&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_RESOURCE_ATTRIBUTES </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;deployment.environment=otel-$INSTANCE&#34;</span><span class=w> </span></span></span></code></pre></div><p>Apply the changes with:</p><div class=tab-panel data-tab-group=3146bb04f853bf5d38a58970f5b7901d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3146bb04f853bf5d38a58970f5b7901d","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("3146bb04f853bf5d38a58970f5b7901d","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f deployment.yaml</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>deployment.apps/helloworld configured</span></span></code></pre></div></div></div></div></div><p>Then use <code>curl</code> to generate some traffic.</p><p>After a minute or so, you should see traces flowing in the o11y cloud. But, if you want to see your trace sooner, we have &mldr;</p><h2 id=a-challenge-for-you>A Challenge For You</h2><p>If you are a developer and just want to quickly grab the trace id or see console feedback, what environment variable could you add to the deployment.yaml file?</p><details><summary><b>Click here to see the answer</b></summary><p>If you recall in our challenge from Section 4, <em>Instrument a .NET Application with OpenTelemetry</em>, we showed you a trick to write traces to the console using the <code>OTEL_TRACES_EXPORTER</code> environment variable. We can add this variable to our deployment.yaml, redeploy our application, and tail the logs from our helloworld app so that we can grab the trace id to then find the trace in Splunk Observability Cloud. (In the next section of our workshop, we will also walk through using the debug exporter, which is how you would typically debug your application in a K8s environment.)</p><p>First, open the deployment.yaml file in vi:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi deployment.yaml</span></span></code></pre></div><p>Then, add the <code>OTEL_TRACES_EXPORTER</code> environment variable:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>          </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>PORT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;8080&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>NODE_IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>status.hostIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_EXPORTER_OTLP_ENDPOINT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;http://$(NODE_IP):4318&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_SERVICE_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;helloworld&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_RESOURCE_ATTRIBUTES </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;deployment.environment=YOURINSTANCE&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c># NEW VALUE HERE:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_TRACES_EXPORTER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;otlp,console&#34;</span><span class=w> </span></span></span></code></pre></div><p>Save your changes then redeploy the application:</p><div class=tab-panel data-tab-group=a622d9ece57e2c823703baeca197c197><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a622d9ece57e2c823703baeca197c197","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("a622d9ece57e2c823703baeca197c197","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f deployment.yaml</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>deployment.apps/helloworld configured</span></span></code></pre></div></div></div></div></div><p>Tail the helloworld logs:</p><div class=tab-panel data-tab-group=705b2fa4a74594aed15ab1d8a5610354><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("705b2fa4a74594aed15ab1d8a5610354","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("705b2fa4a74594aed15ab1d8a5610354","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl logs -l <span class=nv>app</span><span class=o>=</span>helloworld -f</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>info: HelloWorldController<span class=o>[</span>0<span class=o>]</span>
</span></span><span class=line><span class=cl>      /hello endpoint invoked by K8s9
</span></span><span class=line><span class=cl>Activity.TraceId:            5bceb747cc7b79a77cfbde285f0f09cb
</span></span><span class=line><span class=cl>Activity.SpanId:             ac67afe500e7ad12
</span></span><span class=line><span class=cl>Activity.TraceFlags:         Recorded
</span></span><span class=line><span class=cl>Activity.ActivitySourceName: Microsoft.AspNetCore
</span></span><span class=line><span class=cl>Activity.DisplayName:        GET hello/<span class=o>{</span>name?<span class=o>}</span>
</span></span><span class=line><span class=cl>Activity.Kind:               Server
</span></span><span class=line><span class=cl>Activity.StartTime:          2025-02-04T15:22:48.2381736Z
</span></span><span class=line><span class=cl>Activity.Duration:           00:00:00.0027334
</span></span><span class=line><span class=cl>Activity.Tags:
</span></span><span class=line><span class=cl>    server.address: 10.43.226.224
</span></span><span class=line><span class=cl>    server.port: <span class=m>8080</span>
</span></span><span class=line><span class=cl>    http.request.method: GET
</span></span><span class=line><span class=cl>    url.scheme: http
</span></span><span class=line><span class=cl>    url.path: /hello/K8s9
</span></span><span class=line><span class=cl>    network.protocol.version: 1.1
</span></span><span class=line><span class=cl>    user_agent.original: curl/7.81.0
</span></span><span class=line><span class=cl>    http.route: hello/<span class=o>{</span>name?<span class=o>}</span>
</span></span><span class=line><span class=cl>    http.response.status_code: <span class=m>200</span>
</span></span><span class=line><span class=cl>Resource associated with Activity:
</span></span><span class=line><span class=cl>    splunk.distro.version: 1.8.0
</span></span><span class=line><span class=cl>    telemetry.distro.name: splunk-otel-dotnet
</span></span><span class=line><span class=cl>    telemetry.distro.version: 1.8.0
</span></span><span class=line><span class=cl>    os.type: linux
</span></span><span class=line><span class=cl>    os.description: Debian GNU/Linux <span class=m>12</span> <span class=o>(</span>bookworm<span class=o>)</span>
</span></span><span class=line><span class=cl>    os.build_id: 6.2.0-1018-aws
</span></span><span class=line><span class=cl>    os.name: Debian GNU/Linux
</span></span><span class=line><span class=cl>    os.version: <span class=m>12</span>
</span></span><span class=line><span class=cl>    host.name: helloworld-69f5c7988b-dxkwh
</span></span><span class=line><span class=cl>    process.owner: app
</span></span><span class=line><span class=cl>    process.pid: <span class=m>1</span>
</span></span><span class=line><span class=cl>    process.runtime.description: .NET 8.0.12
</span></span><span class=line><span class=cl>    process.runtime.name: .NET
</span></span><span class=line><span class=cl>    process.runtime.version: 8.0.12
</span></span><span class=line><span class=cl>    container.id: 39c2061d7605d8c390b4fe5f8054719f2fe91391a5c32df5684605202ca39ae9
</span></span><span class=line><span class=cl>    telemetry.sdk.name: opentelemetry
</span></span><span class=line><span class=cl>    telemetry.sdk.language: dotnet
</span></span><span class=line><span class=cl>    telemetry.sdk.version: 1.9.0
</span></span><span class=line><span class=cl>    service.name: helloworld
</span></span><span class=line><span class=cl>    deployment.environment: otel-jen-tko-1b75</span></span></code></pre></div></div></div></div></div><p>Then, in your other terminal window, generate a trace with your curl command. You will see the trace id in the console in which you are tailing the logs. Copy the <code>Activity.TraceId:</code> value and paste it into the Trace search field in APM.</p></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Feb 5, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=customize-the-opentelemetry-collector-configuration>Customize the OpenTelemetry Collector Configuration</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>20 minutes</span>
</span>&nbsp;<p>We deployed the Splunk Distribution of the OpenTelemetry Collector in our K8s cluster
using the default configuration. In this section, we&rsquo;ll walk through several examples
showing how to customize the collector config.</p><h2 id=get-the-collector-configuration>Get the Collector Configuration</h2><p>Before we customize the collector config, how do we determine what the current configuration
looks like?</p><p>In a Kubernetes environment, the collector configuration is stored using a Config Map.</p><p>We can see which config maps exist in our cluster with the following command:</p><div class=tab-panel data-tab-group=fddf7245a0378142874023e3c055a2ac><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fddf7245a0378142874023e3c055a2ac","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("fddf7245a0378142874023e3c055a2ac","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get cm -l <span class=nv>app</span><span class=o>=</span>splunk-otel-collector</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>NAME                                                 DATA   AGE
</span></span><span class=line><span class=cl>splunk-otel-collector-otel-k8s-cluster-receiver   <span class=m>1</span>      3h37m
</span></span><span class=line><span class=cl>splunk-otel-collector-otel-agent                  <span class=m>1</span>      3h37m</span></span></code></pre></div></div></div></div></div><blockquote><p>Why are there two config maps?</p></blockquote><p>We can then view the config map of the collector agent as follows:</p><div class=tab-panel data-tab-group=ad94ef398239a828d5a5197ec45d6b70><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ad94ef398239a828d5a5197ec45d6b70","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("ad94ef398239a828d5a5197ec45d6b70","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe cm splunk-otel-collector-otel-agent</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Name:         splunk-otel-collector-otel-agent
</span></span><span class=line><span class=cl>Namespace:    default
</span></span><span class=line><span class=cl>Labels:       <span class=nv>app</span><span class=o>=</span>splunk-otel-collector
</span></span><span class=line><span class=cl>              app.kubernetes.io/instance<span class=o>=</span>splunk-otel-collector
</span></span><span class=line><span class=cl>              app.kubernetes.io/managed-by<span class=o>=</span>Helm
</span></span><span class=line><span class=cl>              app.kubernetes.io/name<span class=o>=</span>splunk-otel-collector
</span></span><span class=line><span class=cl>              app.kubernetes.io/version<span class=o>=</span>0.113.0
</span></span><span class=line><span class=cl>              <span class=nv>chart</span><span class=o>=</span>splunk-otel-collector-0.113.0
</span></span><span class=line><span class=cl>              helm.sh/chart<span class=o>=</span>splunk-otel-collector-0.113.0
</span></span><span class=line><span class=cl>              <span class=nv>heritage</span><span class=o>=</span>Helm
</span></span><span class=line><span class=cl>              <span class=nv>release</span><span class=o>=</span>splunk-otel-collector
</span></span><span class=line><span class=cl>Annotations:  meta.helm.sh/release-name: splunk-otel-collector
</span></span><span class=line><span class=cl>              meta.helm.sh/release-namespace: default
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>Data</span>
</span></span><span class=line><span class=cl><span class=o>====</span>
</span></span><span class=line><span class=cl>relay:
</span></span><span class=line><span class=cl>----
</span></span><span class=line><span class=cl>exporters:
</span></span><span class=line><span class=cl>  otlphttp:
</span></span><span class=line><span class=cl>    headers:
</span></span><span class=line><span class=cl>      X-SF-Token: <span class=si>${</span><span class=nv>SPLUNK_OBSERVABILITY_ACCESS_TOKEN</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    metrics_endpoint: https://ingest.us1.signalfx.com/v2/datapoint/otlp
</span></span><span class=line><span class=cl>    traces_endpoint: https://ingest.us1.signalfx.com/v2/trace/otlp
</span></span><span class=line><span class=cl>    <span class=o>(</span>followed by the rest of the collector config in yaml format<span class=o>)</span> </span></span></code></pre></div></div></div></div></div><h2 id=how-to-update-the-collector-configuration-in-k8s>How to Update the Collector Configuration in K8s</h2><p>In our earlier example running the collector on a Linux instance,
the collector configuration was available in the <code>/etc/otel/collector/agent_config.yaml</code> file. If we
needed to make changes to the collector config in that case, we&rsquo;d simply edit this file,
save the changes, and then restart the collector.</p><p>In K8s, things work a bit differently. Instead of modifying the <code>agent_config.yaml</code> directly, we&rsquo;ll
instead customize the collector configuration by making changes to the <code>values.yaml</code> file used to deploy
the helm chart.</p><p>The values.yaml file in <a href=https://github.com/signalfx/splunk-otel-collector-chart/blob/main/helm-charts/splunk-otel-collector/values.yaml rel=external target=_blank>GitHub</a>
describes the customization options that are available to us.</p><p>Let&rsquo;s look at an example.</p><h2 id=add-infrastructure-events-monitoring>Add Infrastructure Events Monitoring</h2><p>For our first example, let&rsquo;s enable infrastructure events monitoring for our K8s cluster.</p><blockquote><p>This will allow us to see Kubernetes events as part of the Events Feed section in charts.
The cluster receiver will be configured with a Smart Agent receiver using the kubernetes-events
monitor to send custom events. See <a href=https://docs.splunk.com/observability/en/gdi/opentelemetry/collector-kubernetes/kubernetes-config-logs.html#collect-kubernetes-events rel=external target=_blank>Collect Kubernetes events</a>
for further details.</p></blockquote><p>This is done by adding the following line to the <code>values.yaml</code> file:</p><blockquote><p>Hint: steps to open and save in vi are in previous steps.</p></blockquote><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>logsEngine</span><span class=p>:</span><span class=w> </span><span class=l>otel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>splunkObservability</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>infrastructureMonitoringEventsEnabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>agent</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span></span></span></code></pre></div><p>Once the file is saved, we can apply the changes with:</p><div class=tab-panel data-tab-group=69aa9192f296f9a721225f409dc9a094><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("69aa9192f296f9a721225f409dc9a094","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("69aa9192f296f9a721225f409dc9a094","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm upgrade splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkObservability.realm=</span><span class=nv>$REALM</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkObservability.accessToken=</span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;clusterName=</span><span class=nv>$INSTANCE</span><span class=s2>-cluster&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;environment=otel-</span><span class=nv>$INSTANCE</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.token=</span><span class=nv>$HEC_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.endpoint=</span><span class=nv>$HEC_URL</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.index=splunk4rookies-workshop&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -f values.yaml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>splunk-otel-collector-chart/splunk-otel-collector</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Release <span class=s2>&#34;splunk-otel-collector&#34;</span> has been upgraded. Happy Helming!
</span></span><span class=line><span class=cl>NAME: splunk-otel-collector
</span></span><span class=line><span class=cl>LAST DEPLOYED: Fri Dec <span class=m>20</span> 01:17:03 <span class=m>2024</span>
</span></span><span class=line><span class=cl>NAMESPACE: default
</span></span><span class=line><span class=cl>STATUS: deployed
</span></span><span class=line><span class=cl>REVISION: <span class=m>2</span>
</span></span><span class=line><span class=cl>TEST SUITE: None
</span></span><span class=line><span class=cl>NOTES:
</span></span><span class=line><span class=cl>Splunk OpenTelemetry Collector is installed and configured to send data to Splunk Observability realm us1.</span></span></code></pre></div></div></div></div></div><p>We can then view the config map and ensure the changes were applied:</p><div class=tab-panel data-tab-group=b84638f783bc2f97e12189a387c265fe><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b84638f783bc2f97e12189a387c265fe","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("b84638f783bc2f97e12189a387c265fe","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe cm splunk-otel-collector-otel-k8s-cluster-receiver</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><p>Ensure <code>smartagent/kubernetes-events</code> is included in the agent config now:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>  smartagent/kubernetes-events:
</span></span><span class=line><span class=cl>    alwaysClusterReporter: <span class=nb>true</span>
</span></span><span class=line><span class=cl>    type: kubernetes-events
</span></span><span class=line><span class=cl>    whitelistedEvents:
</span></span><span class=line><span class=cl>    - involvedObjectKind: Pod
</span></span><span class=line><span class=cl>      reason: Created
</span></span><span class=line><span class=cl>    - involvedObjectKind: Pod
</span></span><span class=line><span class=cl>      reason: Unhealthy
</span></span><span class=line><span class=cl>    - involvedObjectKind: Pod
</span></span><span class=line><span class=cl>      reason: Failed
</span></span><span class=line><span class=cl>    - involvedObjectKind: Job
</span></span><span class=line><span class=cl>      reason: FailedCreate</span></span></code></pre></div></div></div></div></div><blockquote><p>Note that we specified the cluster receiver config map since that&rsquo;s
where these particular changes get applied.</p></blockquote><h2 id=add-the-debug-exporter>Add the Debug Exporter</h2><p>Suppose we want to see the traces and logs that are sent to the collector, so we can
inspect them before sending them to Splunk. We can use the debug exporter for this purpose, which
can be helpful for troubleshooting OpenTelemetry-related issues.</p><p>Let&rsquo;s add the debug exporter to the bottom of the values.yaml file as follows:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>logsEngine</span><span class=p>:</span><span class=w> </span><span class=l>otel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>splunkObservability</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>infrastructureMonitoringEventsEnabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>agent</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>verbosity</span><span class=p>:</span><span class=w> </span><span class=l>detailed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>debug</span></span></span></code></pre></div><p>Once the file is saved, we can apply the changes with:</p><div class=tab-panel data-tab-group=2b43be4fc536d0586dd6bf84102338b8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2b43be4fc536d0586dd6bf84102338b8","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("2b43be4fc536d0586dd6bf84102338b8","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm upgrade splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkObservability.realm=</span><span class=nv>$REALM</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkObservability.accessToken=</span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;clusterName=</span><span class=nv>$INSTANCE</span><span class=s2>-cluster&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;environment=otel-</span><span class=nv>$INSTANCE</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.token=</span><span class=nv>$HEC_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.endpoint=</span><span class=nv>$HEC_URL</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.index=splunk4rookies-workshop&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -f values.yaml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>splunk-otel-collector-chart/splunk-otel-collector</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Release <span class=s2>&#34;splunk-otel-collector&#34;</span> has been upgraded. Happy Helming!
</span></span><span class=line><span class=cl>NAME: splunk-otel-collector
</span></span><span class=line><span class=cl>LAST DEPLOYED: Fri Dec <span class=m>20</span> 01:32:03 <span class=m>2024</span>
</span></span><span class=line><span class=cl>NAMESPACE: default
</span></span><span class=line><span class=cl>STATUS: deployed
</span></span><span class=line><span class=cl>REVISION: <span class=m>3</span>
</span></span><span class=line><span class=cl>TEST SUITE: None
</span></span><span class=line><span class=cl>NOTES:
</span></span><span class=line><span class=cl>Splunk OpenTelemetry Collector is installed and configured to send data to Splunk Observability realm us1.</span></span></code></pre></div></div></div></div></div><p>Exercise the application a few times using curl, then tail the agent collector logs with the
following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl logs -l <span class=nv>component</span><span class=o>=</span>otel-collector-agent -f</span></span></code></pre></div><p>You should see traces written to the agent collector logs such as the following:</p><div class="highlight wrap-code"><pre tabindex=0><code>2024-12-20T01:43:52.929Z	info	Traces	{&#34;kind&#34;: &#34;exporter&#34;, &#34;data_type&#34;: &#34;traces&#34;, &#34;name&#34;: &#34;debug&#34;, &#34;resource spans&#34;: 1, &#34;spans&#34;: 2}
2024-12-20T01:43:52.929Z	info	ResourceSpans #0
Resource SchemaURL: https://opentelemetry.io/schemas/1.6.1
Resource attributes:
     -&gt; splunk.distro.version: Str(1.8.0)
     -&gt; telemetry.distro.name: Str(splunk-otel-dotnet)
     -&gt; telemetry.distro.version: Str(1.8.0)
     -&gt; os.type: Str(linux)
     -&gt; os.description: Str(Debian GNU/Linux 12 (bookworm))
     -&gt; os.build_id: Str(6.8.0-1021-aws)
     -&gt; os.name: Str(Debian GNU/Linux)
     -&gt; os.version: Str(12)
     -&gt; host.name: Str(derek-1)
     -&gt; process.owner: Str(app)
     -&gt; process.pid: Int(1)
     -&gt; process.runtime.description: Str(.NET 8.0.11)
     -&gt; process.runtime.name: Str(.NET)
     -&gt; process.runtime.version: Str(8.0.11)
     -&gt; container.id: Str(78b452a43bbaa3354a3cb474010efd6ae2367165a1356f4b4000be031b10c5aa)
     -&gt; telemetry.sdk.name: Str(opentelemetry)
     -&gt; telemetry.sdk.language: Str(dotnet)
     -&gt; telemetry.sdk.version: Str(1.9.0)
     -&gt; service.name: Str(helloworld)
     -&gt; deployment.environment: Str(otel-derek-1)
     -&gt; k8s.pod.ip: Str(10.42.0.15)
     -&gt; k8s.pod.labels.app: Str(helloworld)
     -&gt; k8s.pod.name: Str(helloworld-84865965d9-nkqsx)
     -&gt; k8s.namespace.name: Str(default)
     -&gt; k8s.pod.uid: Str(38d39bc6-1309-4022-a569-8acceef50942)
     -&gt; k8s.node.name: Str(derek-1)
     -&gt; k8s.cluster.name: Str(derek-1-cluster)</code></pre></div><p>And log entries such as:</p><div class="highlight wrap-code"><pre tabindex=0><code>2024-12-20T01:43:53.215Z	info	Logs	{&#34;kind&#34;: &#34;exporter&#34;, &#34;data_type&#34;: &#34;logs&#34;, &#34;name&#34;: &#34;debug&#34;, &#34;resource logs&#34;: 1, &#34;log records&#34;: 2}
2024-12-20T01:43:53.215Z	info	ResourceLog #0
Resource SchemaURL: https://opentelemetry.io/schemas/1.6.1
Resource attributes:
     -&gt; splunk.distro.version: Str(1.8.0)
     -&gt; telemetry.distro.name: Str(splunk-otel-dotnet)
     -&gt; telemetry.distro.version: Str(1.8.0)
     -&gt; os.type: Str(linux)
     -&gt; os.description: Str(Debian GNU/Linux 12 (bookworm))
     -&gt; os.build_id: Str(6.8.0-1021-aws)
     -&gt; os.name: Str(Debian GNU/Linux)
     -&gt; os.version: Str(12)
     -&gt; host.name: Str(derek-1)
     -&gt; process.owner: Str(app)
     -&gt; process.pid: Int(1)
     -&gt; process.runtime.description: Str(.NET 8.0.11)
     -&gt; process.runtime.name: Str(.NET)
     -&gt; process.runtime.version: Str(8.0.11)
     -&gt; container.id: Str(78b452a43bbaa3354a3cb474010efd6ae2367165a1356f4b4000be031b10c5aa)
     -&gt; telemetry.sdk.name: Str(opentelemetry)
     -&gt; telemetry.sdk.language: Str(dotnet)
     -&gt; telemetry.sdk.version: Str(1.9.0)
     -&gt; service.name: Str(helloworld)
     -&gt; deployment.environment: Str(otel-derek-1)
     -&gt; k8s.node.name: Str(derek-1)
     -&gt; k8s.cluster.name: Str(derek-1-cluster)</code></pre></div><p>If you return to Splunk Observability Cloud though, you&rsquo;ll notice that traces and logs are
no longer being sent there by the application.</p><p>Why do you think that is? We&rsquo;ll explore it in the next section.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Jan 23, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=troubleshoot-opentelemetry-collector-issues>Troubleshoot OpenTelemetry Collector Issues</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>20 minutes</span>
</span>&nbsp;<p>In the previous section, we added the debug exporter to the collector configuration,
and made it part of the pipeline for traces and logs. We see the debug output
written to the agent collector logs as expected.</p><p>However, traces are no longer sent to o11y cloud. Let&rsquo;s figure out why and fix it.</p><h2 id=review-the-collector-config>Review the Collector Config</h2><p>Whenever a change to the collector config is made via a <code>values.yaml</code> file, it&rsquo;s helpful
to review the actual configuration applied to the collector by looking at the config map:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe cm splunk-otel-collector-otel-agent</span></span></code></pre></div><p>Let&rsquo;s review the pipelines for logs and traces in the agent collector config. They should look
like this:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>k8sattributes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>filter/logs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/logs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_environment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>filelog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>fluentforward</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>k8sattributes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_environment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>jaeger</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>smartagent/signalfx-forwarder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>zipkin</span></span></span></code></pre></div><p>Do you see the problem? Only the debug exporter is included in the traces and logs pipelines.
The <code>otlphttp</code> and <code>signalfx</code> exporters that were present in the traces pipeline configuration previously are gone.
This is why we no longer see traces in o11y cloud. And for the logs pipeline, the <code>splunk_hec/platform_logs</code>
exporter has been removed.</p><blockquote><p>How did we know what specific exporters were included before? To find out,
we could have reverted our earlier customizations and then checked the config
map to see what was in the traces pipeline originally. Alternatively, we can refer
to the examples in the <a href=https://github.com/signalfx/splunk-otel-collector-chart/blob/main/examples/default/rendered_manifests/configmap-agent.yaml rel=external target=_blank>GitHub repo for splunk-otel-collector-chart</a>
which shows us what default agent config is used by the Helm chart.</p></blockquote><h2 id=how-did-these-exporters-get-removed>How did these exporters get removed?</h2><p>Let&rsquo;s review the customizations we added to the <code>values.yaml</code> file:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>logsEngine</span><span class=p>:</span><span class=w> </span><span class=l>otel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>splunkObservability</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>infrastructureMonitoringEventsEnabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>agent</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>verbosity</span><span class=p>:</span><span class=w> </span><span class=l>detailed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>debug</span></span></span></code></pre></div><p>When we applied the <code>values.yaml</code> file to the collector using <code>helm upgrade</code>, the
custom configuration got merged with the previous collector configuration.
When this happens, the sections of the <code>yaml</code> configuration that contain lists,
such as the list of exporters in the pipeline section, get replaced with what we
included in the <code>values.yaml</code> file (which was only the debug exporter).</p><h2 id=lets-fix-the-issue>Let&rsquo;s Fix the Issue</h2><p>So when customizing an existing pipeline, we need to fully redefine that part of the configuration.
Our <code>values.yaml</code> file should thus be updated as follows:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>logsEngine</span><span class=p>:</span><span class=w> </span><span class=l>otel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>splunkObservability</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>infrastructureMonitoringEventsEnabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>agent</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>verbosity</span><span class=p>:</span><span class=w> </span><span class=l>detailed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>otlphttp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>signalfx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>splunk_hec/platform_logs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>debug</span></span></span></code></pre></div><p>Let&rsquo;s apply the changes:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm upgrade splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkObservability.realm=</span><span class=nv>$REALM</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkObservability.accessToken=</span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;clusterName=</span><span class=nv>$INSTANCE</span><span class=s2>-cluster&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;environment=otel-</span><span class=nv>$INSTANCE</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.token=</span><span class=nv>$HEC_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.endpoint=</span><span class=nv>$HEC_URL</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.index=splunk4rookies-workshop&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -f values.yaml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>splunk-otel-collector-chart/splunk-otel-collector</span></span></code></pre></div><p>And then check the agent config map:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe cm splunk-otel-collector-otel-agent</span></span></code></pre></div><p>This time, we should see a fully defined exporters pipeline for both logs and traces:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>  pipelines:
</span></span><span class=line><span class=cl>    logs:
</span></span><span class=line><span class=cl>      exporters:
</span></span><span class=line><span class=cl>      - splunk_hec/platform_logs
</span></span><span class=line><span class=cl>      - debug
</span></span><span class=line><span class=cl>      processors:
</span></span><span class=line><span class=cl>      ...
</span></span><span class=line><span class=cl>    traces:
</span></span><span class=line><span class=cl>      exporters:
</span></span><span class=line><span class=cl>      - otlphttp
</span></span><span class=line><span class=cl>      - signalfx
</span></span><span class=line><span class=cl>      - debug
</span></span><span class=line><span class=cl>      processors:
</span></span><span class=line><span class=cl>      ...</span></span></code></pre></div><h2 id=reviewing-the-log-output>Reviewing the Log Output</h2><p>The <strong>Splunk Distribution of OpenTelemetry .NET</strong> automatically exports logs enriched with tracing context
from applications that use <code>Microsoft.Extensions.Logging</code> for logging (which our sample app does).</p><p>Application logs are enriched with tracing metadata and then exported to a local instance of
the OpenTelemetry Collector in OTLP format.</p><p>Let&rsquo;s take a closer look at the logs that were captured by the debug exporter to see if that&rsquo;s happening.<br>To tail the collector logs, we can use the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl logs -l <span class=nv>component</span><span class=o>=</span>otel-collector-agent -f</span></span></code></pre></div><p>Once we&rsquo;re tailing the logs, we can use curl to generate some more traffic. Then we should see
something like the following:</p><div class="highlight wrap-code"><pre tabindex=0><code>2024-12-20T21:56:30.858Z	info	Logs	{&#34;kind&#34;: &#34;exporter&#34;, &#34;data_type&#34;: &#34;logs&#34;, &#34;name&#34;: &#34;debug&#34;, &#34;resource logs&#34;: 1, &#34;log records&#34;: 1}
2024-12-20T21:56:30.858Z	info	ResourceLog #0
Resource SchemaURL: https://opentelemetry.io/schemas/1.6.1
Resource attributes:
     -&gt; splunk.distro.version: Str(1.8.0)
     -&gt; telemetry.distro.name: Str(splunk-otel-dotnet)
     -&gt; telemetry.distro.version: Str(1.8.0)
     -&gt; os.type: Str(linux)
     -&gt; os.description: Str(Debian GNU/Linux 12 (bookworm))
     -&gt; os.build_id: Str(6.8.0-1021-aws)
     -&gt; os.name: Str(Debian GNU/Linux)
     -&gt; os.version: Str(12)
     -&gt; host.name: Str(derek-1)
     -&gt; process.owner: Str(app)
     -&gt; process.pid: Int(1)
     -&gt; process.runtime.description: Str(.NET 8.0.11)
     -&gt; process.runtime.name: Str(.NET)
     -&gt; process.runtime.version: Str(8.0.11)
     -&gt; container.id: Str(5bee5b8f56f4b29f230ffdd183d0367c050872fefd9049822c1ab2aa662ba242)
     -&gt; telemetry.sdk.name: Str(opentelemetry)
     -&gt; telemetry.sdk.language: Str(dotnet)
     -&gt; telemetry.sdk.version: Str(1.9.0)
     -&gt; service.name: Str(helloworld)
     -&gt; deployment.environment: Str(otel-derek-1)
     -&gt; k8s.node.name: Str(derek-1)
     -&gt; k8s.cluster.name: Str(derek-1-cluster)
ScopeLogs #0
ScopeLogs SchemaURL: 
InstrumentationScope HelloWorldController 
LogRecord #0
ObservedTimestamp: 2024-12-20 21:56:28.486804 +0000 UTC
Timestamp: 2024-12-20 21:56:28.486804 +0000 UTC
SeverityText: Information
SeverityNumber: Info(9)
Body: Str(/hello endpoint invoked by {name})
Attributes:
     -&gt; name: Str(Kubernetes)
Trace ID: 78db97a12b942c0252d7438d6b045447
Span ID: 5e9158aa42f96db3
Flags: 1
	{&#34;kind&#34;: &#34;exporter&#34;, &#34;data_type&#34;: &#34;logs&#34;, &#34;name&#34;: &#34;debug&#34;}</code></pre></div><p>In this example, we can see that the Trace ID and Span ID were automatically written to the log output
by the OpenTelemetry .NET instrumentation. This allows us to correlate logs with traces in
Splunk Observability Cloud.</p><p>You might remember though that if we deploy the OpenTelemetry collector in a K8s cluster using Helm,
and we include the log collection option, then the OpenTelemetry collector will use the File Log receiver
to automatically capture any container logs.</p><p>This would result in duplicate logs being captured for our application. For example, in the following screenshot we
can see two log entries for each request made to our service:</p><p><a href=#R-image-651a961d92f0133b65d91207bc9f827b class=lightbox-link><img alt="Duplicate Log Entries" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/duplicate_logs.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-651a961d92f0133b65d91207bc9f827b><img alt="Duplicate Log Entries" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/duplicate_logs.png></a></p><p>How do we avoid this?</p><h2 id=avoiding-duplicate-logs-in-k8s>Avoiding Duplicate Logs in K8s</h2><p>To avoid capturing duplicate logs, we can set the <code>OTEL_LOGS_EXPORTER</code> environment variable to <code>none</code>,
to tell the Splunk Distribution of OpenTelemetry .NET to avoid exporting logs to the collector using OTLP.
We can do this by adding the <code>OTEL_LOGS_EXPORTER</code> environment variabl to the <code>deployment.yaml</code> file:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>          </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>PORT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;8080&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>NODE_IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>status.hostIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_EXPORTER_OTLP_ENDPOINT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;http://$(NODE_IP):4318&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_SERVICE_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;helloworld&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_RESOURCE_ATTRIBUTES </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;deployment.environment=otel-$INSTANCE&#34;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_LOGS_EXPORTER </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;none&#34;</span><span class=w> </span></span></span></code></pre></div><p>And then running:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># update the deployment</span>
</span></span><span class=line><span class=cl>kubectl apply -f deployment.yaml</span></span></code></pre></div><p>Setting the <code>OTEL_LOGS_EXPORTER</code> environment variable to <code>none</code> is straightforward. However, the Trace ID
and Span ID are not written to the stdout logs generated by the application,
which would prevent us from correlating logs with traces.</p><p>To resolve this, we will need to define a custom logger, such as the example defined in<br><code>/home/splunk/workshop/docker-k8s-otel/helloworld/SplunkTelemetryConfigurator.cs</code>.</p><p>We could include this in our application by updating the <code>Program.cs</code> file as follows:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>using</span> <span class=nn>SplunkTelemetry</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>Microsoft.Extensions.Logging.Console</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>builder</span> <span class=p>=</span> <span class=n>WebApplication</span><span class=p>.</span><span class=n>CreateBuilder</span><span class=p>(</span><span class=n>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>builder</span><span class=p>.</span><span class=n>Services</span><span class=p>.</span><span class=n>AddControllers</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>SplunkTelemetryConfigurator</span><span class=p>.</span><span class=n>ConfigureLogger</span><span class=p>(</span><span class=n>builder</span><span class=p>.</span><span class=n>Logging</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>app</span> <span class=p>=</span> <span class=n>builder</span><span class=p>.</span><span class=n>Build</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=p>.</span><span class=n>MapControllers</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=p>.</span><span class=n>Run</span><span class=p>();</span></span></span></code></pre></div><p>Then we&rsquo;ll build a new Docker image that includes the custom logging configuration:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /home/splunk/workshop/docker-k8s-otel/helloworld 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>docker build -t helloworld:1.3 .</span></span></code></pre></div><p>And then we&rsquo;ll import the updated image into Kubernetes:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /home/splunk
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Export the image from docker</span>
</span></span><span class=line><span class=cl>docker save --output helloworld.tar helloworld:1.3
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Import the image into k3s</span>
</span></span><span class=line><span class=cl>sudo k3s ctr images import helloworld.tar</span></span></code></pre></div><p>Finally, we&rsquo;ll need to update the `deployment.yaml&rsquo; file to use the 1.3 version
of the container image:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/library/helloworld:1.3</span></span></span></code></pre></div><p>And then apply the changes:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># update the deployment</span>
</span></span><span class=line><span class=cl>kubectl apply -f deployment.yaml</span></span></code></pre></div><p>Now we can see that the duplicate log entries have been eliminated. And the
remaining log entries have been formatted as JSON, and include the span and trace IDs:</p><p><a href=#R-image-4a08a2629fa9034ea9faa0f87713d07c class=lightbox-link><img alt="JSON Format Logs" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/logs_json_format.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-4a08a2629fa9034ea9faa0f87713d07c><img alt="JSON Format Logs" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/logs_json_format.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Feb 28, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=summary>Summary</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>2 minutes</span>
</span>&nbsp;<p>This workshop provided hands-on experience with the following concepts:</p><ul><li>How to deploy the <strong>Splunk Distribution of the OpenTelemetry Collector</strong> on a Linux host.</li><li>How to instrument a .NET application with the <strong>Splunk Distribution of OpenTelemetry .NET</strong>.</li><li>How to &ldquo;dockerize&rdquo; a .NET application and instrument it with the <strong>Splunk Distribution of OpenTelemetry .NET</strong>.</li><li>How to deploy the <strong>Splunk Distribution of the OpenTelemetry Collector</strong> in a Kubernetes cluster using Helm.</li><li>How to customize the collector configuration and troubleshoot an issue.</li></ul><p>To see how other languages and environments are instrumented with OpenTelemetry,
explore the <a href=https://github.com/signalfx/splunk-opentelemetry-examples rel=external target=_blank>Splunk OpenTelemetry Examples GitHub repository</a>.</p><p>To run this workshop on your own in the future, refer back to these instructions and use the <strong>Splunk4Rookies - Observability</strong>
workshop template in Splunk Show to provision an EC2 instance.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Jan 10, 2025</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=solving-problems-with-o11y-cloud>Solving Problems with O11y Cloud</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>2 minutes</span>
</span>&nbsp;
<span class="badge cstyle blue badge-with-title"><span class=badge-title class=text-muted>Author
</span><span class=badge-content>Derek Mitchell</span></span><p>In this workshop, you&rsquo;ll get hands-on experience with the following:</p><ul><li>Deploy the <strong>OpenTelemetry Collector</strong> and customize the collector config</li><li>Deploy an application and instrument it with <strong>OpenTelemetry</strong></li><li>See how tags are captured using an <strong>OpenTelemetry SDK</strong></li><li>Create a <strong>Troubleshooting MetricSet</strong></li><li>Troubleshoot a problem and determine root cause using <strong>Tag Spotlight</strong></li></ul><p>Let&rsquo;s get started!</p><details open class="box cstyle notices primary"><summary class=box-label><i class="fa-fw fas fa-lightbulb"></i>
Tip</summary><div class=box-content><p>The easiest way to navigate through this workshop is by using:</p><ul><li>the left/right arrows (<strong>&lt;</strong> | <strong>></strong>) on the top right of this page</li><li>the left (â—€ï¸) and right (â–¶ï¸) cursor keys on your keyboard</li></ul></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Feb 3, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of Solving Problems with O11y Cloud</h1><article class=default><header class=headline></header><h1 id=connect-to-ec2-instance>Connect to EC2 Instance</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>5 minutes</span>
</span>&nbsp;<h2 id=connect-to-your-ec2-instance>Connect to your EC2 Instance</h2><p>Weâ€™ve prepared an Ubuntu Linux instance in AWS/EC2 for each attendee. Using the IP address and password provided by your instructor, connect to your EC2 instance using one of the methods below:</p><ul><li>macOS / Linux<ul><li><code>ssh splunk@IP address</code></li></ul></li><li>Windows 10+<ul><li>Use the OpenSSH client</li></ul></li><li>Earlier versions of Windows<ul><li>Use Putty</li></ul></li></ul><h2 id=editing-files>Editing Files</h2><p>We&rsquo;ll use <code>vi</code> to edit files during the workshop. Here&rsquo;s a quick primer.</p><p>To open a file for editing:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi &lt;filename&gt; </span></span></code></pre></div><ul><li>To edit the file, click <code>i</code> to switch to <strong>Insert mode</strong> and begin entering text as normal. Use <code>Esc</code> to return to <strong>Command mode</strong>.</li><li>To save your changes without exiting the editor, enter <code>Esc</code> to return to command mode then enter <code>:w</code>.</li><li>To exit the editor without saving changes, enter <code>Esc</code> to return to command mode then enter <code>:q!</code>.</li><li>To save your changes and exist the editor, enter <code>Esc</code> to return to command mode then enter <code>:wq</code>.</li></ul><p>See <a href=https://www.redhat.com/en/blog/introduction-vi-editor rel=external target=_blank><strong>An introduction to the vi editor</strong></a> for a comprehensive introduction to <code>vi</code>.</p><p>If you&rsquo;d prefer using another editor, you can use <code>nano</code> instead:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nano &lt;filename&gt; </span></span></code></pre></div><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Feb 21, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=deploy-the-opentelemetry-collector-and-customize-config>Deploy the OpenTelemetry Collector and Customize Config</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>15 minutes</span>
</span>&nbsp;<p>The first step to &ldquo;getting data in&rdquo; is to deploy an OpenTelemetry collector, which receives and processes telemetry data in our environment before exporting it to Splunk Observability Cloud.</p><p>We&rsquo;ll be using Kubernetes for this workshop, and will deploy the collector in our K8s cluster using Helm.</p><h2 id=what-is-helm>What is Helm?</h2><p>Helm is a package manager for Kubernetes which provides the following benefits:</p><ul><li>Manage Complexity<ul><li>deal with a single values.yaml file rather than dozens of manifest files</li></ul></li><li>Easy Updates<ul><li>in-place upgrades</li></ul></li><li>Rollback support<ul><li>Just use helm rollback to roll back to an older version of a release</li></ul></li></ul><h2 id=install-the-collector-using-helm>Install the Collector using Helm</h2><p>Let&rsquo;s change into the correct directory and run a script to install the collector:</p><div class=tab-panel data-tab-group=90a2696f23b150be8a4e310bf239097b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("90a2696f23b150be8a4e310bf239097b","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("90a2696f23b150be8a4e310bf239097b","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /home/splunk/workshop/tagging
</span></span><span class=line><span class=cl>./1-deploy-otel-collector.sh</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=s2>&#34;splunk-otel-collector-chart&#34;</span> has been added to your repositories
</span></span><span class=line><span class=cl>Hang tight <span class=k>while</span> we grab the latest from your chart repositories...
</span></span><span class=line><span class=cl>...Successfully got an update from the <span class=s2>&#34;splunk-otel-collector-chart&#34;</span> chart repository
</span></span><span class=line><span class=cl>Update Complete. âŽˆHappy Helming!âŽˆ
</span></span><span class=line><span class=cl>NAME: splunk-otel-collector
</span></span><span class=line><span class=cl>LAST DEPLOYED: Mon Dec <span class=m>23</span> 18:47:38 <span class=m>2024</span>
</span></span><span class=line><span class=cl>NAMESPACE: default
</span></span><span class=line><span class=cl>STATUS: deployed
</span></span><span class=line><span class=cl>REVISION: <span class=m>1</span>
</span></span><span class=line><span class=cl>NOTES:
</span></span><span class=line><span class=cl>Splunk OpenTelemetry Collector is installed and configured to send data to Splunk Observability realm us1.</span></span></code></pre></div></div></div></div></div><blockquote><p>Note that the script may take a minute or so to run.</p></blockquote><p>How did this script install the collector? It first ensured that the environment variables set in the <code>~./profile</code> file are read:</p><blockquote><p>Important: There is no need to run the following commands, as they were already run
by the <code>1-deploy-otel-collector.sh</code> script.</p></blockquote><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>source</span> ~/.profile</span></span></code></pre></div><p>It then installed the <code>splunk-otel-collector-chart</code> Helm chart and ensured it&rsquo;s up-to-date:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>  helm repo add splunk-otel-collector-chart https://signalfx.github.io/splunk-otel-collector-chart
</span></span><span class=line><span class=cl>  helm repo update</span></span></code></pre></div><p>And finally, it used <code>helm install</code> to install the collector:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>  helm install splunk-otel-collector --version 0.111.0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkObservability.realm=</span><span class=nv>$REALM</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkObservability.accessToken=</span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;clusterName=</span><span class=nv>$INSTANCE</span><span class=s2>-k3s-cluster&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;environment=tagging-workshop-</span><span class=nv>$INSTANCE</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  splunk-otel-collector-chart/splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -f otel/values.yaml</span></span></code></pre></div><blockquote><p>Note that the <code>helm install</code> command references a <code>values.yaml</code> file, which is used
to customize the collector configuration. We&rsquo;ll explore this is more detail below.</p></blockquote><h2 id=confirm-the-collector-is-running>Confirm the Collector is Running</h2><p>We can confirm whether the collector is running with the following command:</p><div class=tab-panel data-tab-group=1494bf7929e28b6401f0f56a02b401b4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1494bf7929e28b6401f0f56a02b401b4","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("1494bf7929e28b6401f0f56a02b401b4","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pods</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>NAME                                                            READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>splunk-otel-collector-agent-kfvjb                               1/1     Running   <span class=m>0</span>          2m33s
</span></span><span class=line><span class=cl>splunk-otel-collector-certmanager-7d89558bc9-2fqnx              1/1     Running   <span class=m>0</span>          2m33s
</span></span><span class=line><span class=cl>splunk-otel-collector-certmanager-cainjector-796cc6bd76-hz4sp   1/1     Running   <span class=m>0</span>          2m33s
</span></span><span class=line><span class=cl>splunk-otel-collector-certmanager-webhook-6959cd5f8-qd5b6       1/1     Running   <span class=m>0</span>          2m33s
</span></span><span class=line><span class=cl>splunk-otel-collector-k8s-cluster-receiver-57569b58c8-8ghds     1/1     Running   <span class=m>0</span>          2m33s
</span></span><span class=line><span class=cl>splunk-otel-collector-operator-6fd9f9d569-wd5mn                 2/2     Running   <span class=m>0</span>          2m33s</span></span></code></pre></div></div></div></div></div><h2 id=confirm-your-k8s-cluster-is-in-o11y-cloud>Confirm your K8s Cluster is in O11y Cloud</h2><p>In Splunk Observability Cloud, navigate to <strong>Infrastructure</strong> â†’ <strong>Kubernetes</strong> â†’ <strong>Kubernetes Clusters</strong>,
and then search for your Cluster Name (which is <code>$INSTANCE-k3s-cluster</code>):</p><p><a href=#R-image-fde8d9a4570c88147cb97bc7a8b9b2ff class=lightbox-link><img alt="Kubernetes node" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/k8snode.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-fde8d9a4570c88147cb97bc7a8b9b2ff><img alt="Kubernetes node" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/k8snode.png></a></p><h2 id=get-the-collector-configuration>Get the Collector Configuration</h2><p>Before we customize the collector config, how do we determine what the current configuration
looks like?</p><p>In a Kubernetes environment, the collector configuration is stored using a Config Map.</p><p>We can see which config maps exist in our cluster with the following command:</p><div class=tab-panel data-tab-group=1fad5424bff255cf5e85537b1091d59a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1fad5424bff255cf5e85537b1091d59a","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("1fad5424bff255cf5e85537b1091d59a","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get cm -l <span class=nv>app</span><span class=o>=</span>splunk-otel-collector</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>NAME                                                 DATA   AGE
</span></span><span class=line><span class=cl>splunk-otel-collector-otel-k8s-cluster-receiver   <span class=m>1</span>      3h37m
</span></span><span class=line><span class=cl>splunk-otel-collector-otel-agent                  <span class=m>1</span>      3h37m</span></span></code></pre></div></div></div></div></div><p>We can then view the config map of the collector agent as follows:</p><div class=tab-panel data-tab-group=3e45e827e6d75ef0214fc5155b79f66f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3e45e827e6d75ef0214fc5155b79f66f","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("3e45e827e6d75ef0214fc5155b79f66f","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe cm splunk-otel-collector-otel-agent</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Name:         splunk-otel-collector-otel-agent
</span></span><span class=line><span class=cl>Namespace:    default
</span></span><span class=line><span class=cl>Labels:       <span class=nv>app</span><span class=o>=</span>splunk-otel-collector
</span></span><span class=line><span class=cl>              app.kubernetes.io/instance<span class=o>=</span>splunk-otel-collector
</span></span><span class=line><span class=cl>              app.kubernetes.io/managed-by<span class=o>=</span>Helm
</span></span><span class=line><span class=cl>              app.kubernetes.io/name<span class=o>=</span>splunk-otel-collector
</span></span><span class=line><span class=cl>              app.kubernetes.io/version<span class=o>=</span>0.113.0
</span></span><span class=line><span class=cl>              <span class=nv>chart</span><span class=o>=</span>splunk-otel-collector-0.113.0
</span></span><span class=line><span class=cl>              helm.sh/chart<span class=o>=</span>splunk-otel-collector-0.113.0
</span></span><span class=line><span class=cl>              <span class=nv>heritage</span><span class=o>=</span>Helm
</span></span><span class=line><span class=cl>              <span class=nv>release</span><span class=o>=</span>splunk-otel-collector
</span></span><span class=line><span class=cl>Annotations:  meta.helm.sh/release-name: splunk-otel-collector
</span></span><span class=line><span class=cl>              meta.helm.sh/release-namespace: default
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>Data</span>
</span></span><span class=line><span class=cl><span class=o>====</span>
</span></span><span class=line><span class=cl>relay:
</span></span><span class=line><span class=cl>----
</span></span><span class=line><span class=cl>exporters:
</span></span><span class=line><span class=cl>  otlphttp:
</span></span><span class=line><span class=cl>    headers:
</span></span><span class=line><span class=cl>      X-SF-Token: <span class=si>${</span><span class=nv>SPLUNK_OBSERVABILITY_ACCESS_TOKEN</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    metrics_endpoint: https://ingest.us1.signalfx.com/v2/datapoint/otlp
</span></span><span class=line><span class=cl>    traces_endpoint: https://ingest.us1.signalfx.com/v2/trace/otlp
</span></span><span class=line><span class=cl>    <span class=o>(</span>followed by the rest of the collector config in yaml format<span class=o>)</span> </span></span></code></pre></div></div></div></div></div><h2 id=how-to-update-the-collector-configuration-in-k8s>How to Update the Collector Configuration in K8s</h2><p>We can customize the collector configuration in K8s using the <code>values.yaml</code> file.</p><blockquote><p>See <a href=https://github.com/signalfx/splunk-otel-collector-chart/blob/main/helm-charts/splunk-otel-collector/values.yaml rel=external target=_blank>this file</a>
for a comprehensive list of customization options that are available in the <code>values.yaml</code> file.</p></blockquote><p>Let&rsquo;s look at an example.</p><h3 id=add-the-debug-exporter>Add the Debug Exporter</h3><p>Suppose we want to see the traces that are sent to the collector. We can use the debug exporter for this purpose, which can be helpful for troubleshooting OpenTelemetry related issues.</p><p>You can use <code>vi</code> or <code>nano</code> to edit the <code>values.yaml</code> file. We will show an example using vi:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi /home/splunk/workshop/tagging/otel/values.yaml</span></span></code></pre></div><p>Add the debug exporter by copying and pasting the following text to the bottom of the <code>values.yaml</code> file:</p><blockquote><p>Press &lsquo;i&rsquo; to enter into insert mode in vi before adding the text below.</p></blockquote><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>    </span><span class=c># NEW CONTENT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>verbosity</span><span class=p>:</span><span class=w> </span><span class=l>detailed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>sapm</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>signalfx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>debug</span></span></span></code></pre></div><p>After these changes, the <code>values.yaml</code> file should include the following contents:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>splunkObservability</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>logsEnabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>profilingEnabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>infrastructureMonitoringEventsEnabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>certmanager</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>operator</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>agent</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>kubeletstats</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>insecure_skip_verify</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>auth_type</span><span class=p>:</span><span class=w> </span><span class=l>serviceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=l>${K8S_NODE_IP}:10250</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>metric_groups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>k8s_api_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>auth_type</span><span class=p>:</span><span class=w> </span><span class=l>serviceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>extra_metadata_labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>container.id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>k8s.volume.type</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>zpages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>55679</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># NEW CONTENT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>verbosity</span><span class=p>:</span><span class=w> </span><span class=l>detailed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>sapm</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>signalfx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>debug</span></span></span></code></pre></div><blockquote><p>To save your changes in vi, press the <code>esc</code> key to enter command mode, then type <code>:wq!</code> followed by pressing the
<code>enter/return</code> key.</p></blockquote><p>Once the file is saved, we can apply the changes with:</p><div class=tab-panel data-tab-group=0d7693427841ad228ad64aa84d5bd17b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0d7693427841ad228ad64aa84d5bd17b","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("0d7693427841ad228ad64aa84d5bd17b","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /home/splunk/workshop/tagging
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>helm upgrade splunk-otel-collector --version 0.111.0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.realm=</span><span class=nv>$REALM</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.accessToken=</span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;clusterName=</span><span class=nv>$INSTANCE</span><span class=s2>-k3s-cluster&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;environment=tagging-workshop-</span><span class=nv>$INSTANCE</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>splunk-otel-collector-chart/splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-f otel/values.yaml</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Release <span class=s2>&#34;splunk-otel-collector&#34;</span> has been upgraded. Happy Helming!
</span></span><span class=line><span class=cl>NAME: splunk-otel-collector
</span></span><span class=line><span class=cl>LAST DEPLOYED: Mon Dec <span class=m>23</span> 19:08:08 <span class=m>2024</span>
</span></span><span class=line><span class=cl>NAMESPACE: default
</span></span><span class=line><span class=cl>STATUS: deployed
</span></span><span class=line><span class=cl>REVISION: <span class=m>2</span>
</span></span><span class=line><span class=cl>NOTES:
</span></span><span class=line><span class=cl>Splunk OpenTelemetry Collector is installed and configured to send data to Splunk Observability realm us1.</span></span></code></pre></div></div></div></div></div><p>Whenever a change to the collector config is made via a <code>values.yaml</code> file, it&rsquo;s helpful
to review the actual configuration applied to the collector by looking at the config map:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe cm splunk-otel-collector-otel-agent</span></span></code></pre></div><p>We can see that the debug exporter was added to the traces pipeline, as desired:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>sapm</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>signalfx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>debug</span></span></span></code></pre></div><p>We&rsquo;ll explore the output of the debug exporter once we deploy an application
in our cluster and start capturing traces.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Feb 21, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=deploy-the-sample-application-and-instrument-with-opentelemetry>Deploy the Sample Application and Instrument with OpenTelemetry</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>15 minutes</span>
</span>&nbsp;<p>At this point, we&rsquo;ve deployed an OpenTelemetry collector in our K8s cluster, and it&rsquo;s
successfully collecting infrastructure metrics.</p><p>The next step is to deploy a sample application and instrument
with OpenTelemetry to capture traces.</p><p>We&rsquo;ll use a microservices-based application written in Python. To keep the workshop simple,
we&rsquo;ll focus on two services: a credit check service and a credit processor service.</p><h2 id=deploy-the-application>Deploy the Application</h2><p>To save time, we&rsquo;ve built Docker images for both of these services already which are available in Docker Hub.
We can deploy the credit check service in our K8s cluster with the following command:</p><div class=tab-panel data-tab-group=693a78ba6638e1c5a343c7d6d304b40e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("693a78ba6638e1c5a343c7d6d304b40e","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("693a78ba6638e1c5a343c7d6d304b40e","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f /home/splunk/workshop/tagging/creditcheckservice-py-with-tags/creditcheckservice-dockerhub.yaml</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>deployment.apps/creditcheckservice created
</span></span><span class=line><span class=cl>service/creditcheckservice created</span></span></code></pre></div></div></div></div></div><p>Next, let&rsquo;s deploy the credit processor service:</p><div class=tab-panel data-tab-group=1f3a9b7dd0af8b6482cc67e01e209ff5><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1f3a9b7dd0af8b6482cc67e01e209ff5","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("1f3a9b7dd0af8b6482cc67e01e209ff5","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f /home/splunk/workshop/tagging/creditprocessorservice/creditprocessorservice-dockerhub.yaml</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>deployment.apps/creditprocessorservice created
</span></span><span class=line><span class=cl>service/creditprocessorservice created</span></span></code></pre></div></div></div></div></div><p>Finally, let&rsquo;s deploy a load generator to generate traffic:</p><div class=tab-panel data-tab-group=a180fe0853c4df09384dce6600855d73><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=script class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a180fe0853c4df09384dce6600855d73","script")'>
<span class=tab-nav-text>Script</span>
</button>
<button data-tab-item=example-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("a180fe0853c4df09384dce6600855d73","example-output")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div data-tab-item=script class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f /home/splunk/workshop/tagging/loadgenerator/loadgenerator-dockerhub.yaml</span></span></code></pre></div></div></div><div data-tab-item=example-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>deployment.apps/loadgenerator created</span></span></code></pre></div></div></div></div></div><h2 id=explore-the-application>Explore the Application</h2><p>We&rsquo;ll provide an overview of the application in this section. If you&rsquo;d like to see the complete source
code for the application, refer to the <a href=https://github.com/splunk/observability-workshop/tree/main/workshop/tagging rel=external target=_blank>Observability Workshop repository in GitHub</a></p><h3 id=opentelemetry-instrumentation>OpenTelemetry Instrumentation</h3><p>If we look at the Dockerfile&rsquo;s used to build the credit check and credit processor services, we
can see that they&rsquo;ve already been instrumented with OpenTelemetry. For example, let&rsquo;s look at
<code>/home/splunk/workshop/tagging/creditcheckservice-py-with-tags/Dockerfile</code>:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> python:3.11-slim</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Set working directory</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Copy requirements over</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> requirements.txt .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apt-get update <span class=o>&amp;&amp;</span> apt-get install --yes gcc python3-dev<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> <span class=nv>PIP_ROOT_USER_ACTION</span><span class=o>=</span>ignore
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Install Python dependencies</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> pip install --no-cache-dir -r requirements.txt<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Copy main app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> main.py .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Bootstrap OTel</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> splunk-py-trace-bootstrap<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Set the entrypoint command to run the application</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;splunk-py-trace&#34;</span><span class=p>,</span> <span class=s2>&#34;python3&#34;</span><span class=p>,</span> <span class=s2>&#34;main.py&#34;</span><span class=p>]</span></span></span></code></pre></div><p>We can see that <code>splunk-py-trace-bootstrap</code> was included, which installs OpenTelemetry instrumentation
for supported packages used by our applications. We can also see that <code>splunk-py-trace</code> is used as part
of the command to start the application.</p><p>And if we review the <code>/home/splunk/workshop/tagging/creditcheckservice-py-with-tags/requirements.txt</code> file,
we can see that <code>splunk-opentelemetry[all]</code> was included in the list of packages.</p><p>Finally, if we review the Kubernetes manifest that we used to deploy this service (<code>/home/splunk/workshop/tagging/creditcheckservice-py-with-tags/creditcheckservice-dockerhub.yaml</code>),
we can see that environment variables were set in the container to tell OpenTelemetry
where to export OTLP data to:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>PORT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;8888&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>NODE_IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>status.hostIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_EXPORTER_OTLP_ENDPOINT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;http://$(NODE_IP):4317&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_SERVICE_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;creditcheckservice&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_PROPAGATORS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;tracecontext,baggage&#34;</span></span></span></code></pre></div><p>This is all that&rsquo;s needed to instrument the service with OpenTelemetry!</p><h3 id=explore-the-application-1>Explore the Application</h3><p>We&rsquo;ve captured several custom tags with our application, which we&rsquo;ll explore shortly. Before we do that, let&rsquo;s
introduce the concept of tags and why they&rsquo;re important.</p><h3 id=what-are-tags>What are tags?</h3><p>Tags are key-value pairs that provide additional metadata about spans in a trace, allowing you to enrich the context of the spans you send to <strong>Splunk APM</strong>.</p><p>For example, a payment processing application would find it helpful to track:</p><ul><li>The payment type used (i.e. credit card, gift card, etc.)</li><li>The ID of the customer that requested the payment</li></ul><p>This way, if errors or performance issues occur while processing the payment, we have the context we need for troubleshooting.</p><p>While some tags can be added with the OpenTelemetry collector, the ones weâ€™ll be working with in this workshop are more granular, and are added by application developers using the OpenTelemetry SDK.</p><h3 id=why-are-tags-so-important>Why are tags so important?</h3><p>Tags are essential for an application to be truly observable. They add the context to the traces to help us
understand why some users get a great experience and others don&rsquo;t. And powerful features in
<strong>Splunk Observability Cloud</strong> utilize tags to help you jump quickly to root cause.</p><blockquote><p>A note about terminology before we proceed. While we discuss <strong>tags</strong> in this workshop,
and this is the terminology we use in <strong>Splunk Observability Cloud</strong>, OpenTelemetry
uses the term <strong>attributes</strong> instead. So when you see tags mentioned throughout this
workshop, you can treat them as synonymous with attributes.</p></blockquote><h3 id=how-are-tags-captured>How are tags captured?</h3><p>To capture tags in a Python application, we start by importing the trace module by adding an
import statement to the top of the <code>/home/splunk/workshop/tagging/creditcheckservice-py-with-tags/main.py</code> file:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>Flask</span><span class=p>,</span> <span class=n>request</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>waitress</span> <span class=kn>import</span> <span class=n>serve</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>opentelemetry</span> <span class=kn>import</span> <span class=n>trace</span>  <span class=c1># &lt;--- ADDED BY WORKSHOP</span>
</span></span><span class=line><span class=cl><span class=o>...</span></span></span></code></pre></div><p>Next, we need to get a reference to the current span so we can add an attribute (aka tag) to it:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>credit_check</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>current_span</span> <span class=o>=</span> <span class=n>trace</span><span class=o>.</span><span class=n>get_current_span</span><span class=p>()</span>  <span class=c1># &lt;--- ADDED BY WORKSHOP</span>
</span></span><span class=line><span class=cl>    <span class=n>customerNum</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>args</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;customernum&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>current_span</span><span class=o>.</span><span class=n>set_attribute</span><span class=p>(</span><span class=s2>&#34;customer.num&#34;</span><span class=p>,</span> <span class=n>customerNum</span><span class=p>)</span>  <span class=c1># &lt;--- ADDED BY WORKSHOP</span>
</span></span><span class=line><span class=cl><span class=o>...</span></span></span></code></pre></div><p>That was pretty easy, right? We&rsquo;ve captured a total of four tags in the credit check service, with the final result looking like this:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>credit_check</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>current_span</span> <span class=o>=</span> <span class=n>trace</span><span class=o>.</span><span class=n>get_current_span</span><span class=p>()</span>  <span class=c1># &lt;--- ADDED BY WORKSHOP</span>
</span></span><span class=line><span class=cl>    <span class=n>customerNum</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>args</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;customernum&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>current_span</span><span class=o>.</span><span class=n>set_attribute</span><span class=p>(</span><span class=s2>&#34;customer.num&#34;</span><span class=p>,</span> <span class=n>customerNum</span><span class=p>)</span>  <span class=c1># &lt;--- ADDED BY WORKSHOP</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Get Credit Score</span>
</span></span><span class=line><span class=cl>    <span class=n>creditScoreReq</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;http://creditprocessorservice:8899/getScore?customernum=&#34;</span> <span class=o>+</span> <span class=n>customerNum</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>creditScoreReq</span><span class=o>.</span><span class=n>raise_for_status</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>creditScore</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>creditScoreReq</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>current_span</span><span class=o>.</span><span class=n>set_attribute</span><span class=p>(</span><span class=s2>&#34;credit.score&#34;</span><span class=p>,</span> <span class=n>creditScore</span><span class=p>)</span>  <span class=c1># &lt;--- ADDED BY WORKSHOP</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>creditScoreCategory</span> <span class=o>=</span> <span class=n>getCreditCategoryFromScore</span><span class=p>(</span><span class=n>creditScore</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>current_span</span><span class=o>.</span><span class=n>set_attribute</span><span class=p>(</span><span class=s2>&#34;credit.score.category&#34;</span><span class=p>,</span> <span class=n>creditScoreCategory</span><span class=p>)</span>  <span class=c1># &lt;--- ADDED BY WORKSHOP</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Run Credit Check</span>
</span></span><span class=line><span class=cl>    <span class=n>creditCheckReq</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;http://creditprocessorservice:8899/runCreditCheck?customernum=&#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>customerNum</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34;&amp;score=&#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>creditScore</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>creditCheckReq</span><span class=o>.</span><span class=n>raise_for_status</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>checkResult</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>creditCheckReq</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>current_span</span><span class=o>.</span><span class=n>set_attribute</span><span class=p>(</span><span class=s2>&#34;credit.check.result&#34;</span><span class=p>,</span> <span class=n>checkResult</span><span class=p>)</span>  <span class=c1># &lt;--- ADDED BY WORKSHOP</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>checkResult</span></span></span></code></pre></div><h2 id=review-trace-data>Review Trace Data</h2><p>Before looking at the trace data in Splunk Observability Cloud,
let&rsquo;s review what the debug exporter has captured by tailing the agent collector logs with the following command:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl logs -l <span class=nv>component</span><span class=o>=</span>otel-collector-agent -f</span></span></code></pre></div><p>Hint: use <code>CTRL+C</code> to stop tailing the logs.</p><p>You should see traces written to the agent collector logs such as the following:</p><div class="highlight wrap-code"><pre tabindex=0><code>InstrumentationScope opentelemetry.instrumentation.flask 0.44b0
Span #0
    Trace ID       : 9f9fc109903f25ba57bea9b075aa4833
    Parent ID      : 
    ID             : 6d71519f454f6059
    Name           : /check
    Kind           : Server
    Start time     : 2024-12-23 19:55:25.815891965 +0000 UTC
    End time       : 2024-12-23 19:55:27.824664949 +0000 UTC
    Status code    : Unset
    Status message : 
Attributes:
     -&gt; http.method: Str(GET)
     -&gt; http.server_name: Str(waitress.invalid)
     -&gt; http.scheme: Str(http)
     -&gt; net.host.port: Int(8888)
     -&gt; http.host: Str(creditcheckservice:8888)
     -&gt; http.target: Str(/check?customernum=30134241)
     -&gt; net.peer.ip: Str(10.42.0.19)
     -&gt; http.user_agent: Str(python-requests/2.31.0)
     -&gt; net.peer.port: Str(47248)
     -&gt; http.flavor: Str(1.1)
     -&gt; http.route: Str(/check)
     -&gt; customer.num: Str(30134241)
     -&gt; credit.score: Int(443)
     -&gt; credit.score.category: Str(poor)
     -&gt; credit.check.result: Str(OK)
     -&gt; http.status_code: Int(200)</code></pre></div><p>Notice how the trace includes the tags (aka attributes) that we captured in the code, such as
<code>credit.score</code> and <code>credit.score.category</code>. We&rsquo;ll use these in the next section, when
we analyze the traces in Splunk Observability Cloud to find the root cause of a performance issue.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Jan 16, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=create-a-troubleshooting-metricset>Create a Troubleshooting MetricSet</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>5 minutes</span>
</span>&nbsp;<h2 id=index-tags>Index Tags</h2><p>To use advanced features in <strong>Splunk Observability Cloud</strong> such as <strong>Tag Spotlight</strong>, we&rsquo;ll need to first index one or more tags.</p><p>To do this, navigate to <strong>Settings</strong> -> <strong>MetricSets</strong> and ensure the <strong>APM</strong> tab is selected. Then click the <strong>+ Add Custom MetricSet</strong> button.</p><p>Let&rsquo;s index the <code>credit.score.category</code> tag by entering the following details (<strong>note</strong>: since everyone in the workshop is using the same organization, the instructor will do this step on your behalf):</p><p><a href=#R-image-17aca301f171b93d068b2700f15b31df class=lightbox-link><img alt="Create Troubleshooting MetricSet" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/create_troubleshooting_metric_set.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-17aca301f171b93d068b2700f15b31df><img alt="Create Troubleshooting MetricSet" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/create_troubleshooting_metric_set.png></a></p><p>Click <strong>Start Analysis</strong> to proceed.</p><p>The tag will appear in the list of <strong>Pending MetricSets</strong> while analysis is performed.</p><p><a href=#R-image-370ce9aafd56157c762731c03d9c680c class=lightbox-link><img alt="Pending MetricSets" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/pending_metric_set.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-370ce9aafd56157c762731c03d9c680c><img alt="Pending MetricSets" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/pending_metric_set.png></a></p><p>Once analysis is complete, click on the checkmark in the <strong>Actions</strong> column.</p><h2 id=troubleshooting-vs-monitoring-metricsets>Troubleshooting vs. Monitoring MetricSets</h2><p>You may have noticed that, to index this tag, we created something called a <strong>Troubleshooting MetricSet</strong>. It&rsquo;s named this way because a Troubleshooting MetricSet, or TMS, allows us to troubleshoot issues with this tag using features such as <strong>Tag Spotlight</strong>.</p><p>You may have also noticed that there&rsquo;s another option which we didn&rsquo;t choose called a <strong>Monitoring MetricSet</strong> (or MMS). Monitoring MetricSets go beyond troubleshooting and allow us to use tags for alerting and dashboards. While we won&rsquo;t be
exploring this capability as part of this workshop, it&rsquo;s a powerful feature that I encourage you to explore on your own.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Jan 10, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=troubleshoot-a-problem-using-tag-spotlight>Troubleshoot a Problem Using Tag Spotlight</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>15 minutes</span>
</span>&nbsp;<h2 id=explore-apm-data>Explore APM Data</h2><p>Let&rsquo;s explore some of the APM data we&rsquo;ve captured to see how our application is performing.</p><p>Navigate to <strong>APM</strong>, then use the <strong>Environment</strong> dropdown to select your environment (i.e. <code>tagging-workshop-instancename</code>).</p><p>You should see <code>creditprocessorservice</code> and <code>creditcheckservice</code> displayed in the list of services:</p><p><a href=#R-image-5e80adbfb62b973236d802e8987a6285 class=lightbox-link><img alt="APM Overview" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/apm_overview.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5e80adbfb62b973236d802e8987a6285><img alt="APM Overview" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/apm_overview.png></a></p><p>Click on <strong>Service Map</strong> on the right-hand side to view the service map. We can see that the <code>creditcheckservice</code> makes calls to the <code>creditprocessorservice</code>, with an average response time of at least 3 seconds:</p><p><a href=#R-image-35e59ff4b1a31acb909850aafd0e12f4 class=lightbox-link><img alt="Service Map" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/service_map.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-35e59ff4b1a31acb909850aafd0e12f4><img alt="Service Map" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/service_map.png></a></p><p>Next, click on <strong>Traces</strong> on the right-hand side to see the traces captured for this application. You&rsquo;ll see that some traces run relatively fast (i.e. just a few milliseconds), whereas others take a few seconds.</p><p><a href=#R-image-cb5b9274af5111609863ae607c9f0482 class=lightbox-link><img alt=Traces class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/traces.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-cb5b9274af5111609863ae607c9f0482><img alt=Traces class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/traces.png></a></p><p>Click on one of the longer running traces. In this example, the trace took five seconds, and we can see that most of the time was spent calling the <code>/runCreditCheck</code> operation, which is part of the <code>creditprocessorservice</code>:</p><p><a href=#R-image-4593fb5cbf069dff364d2829bc758102 class=lightbox-link><img alt="Long Running Trace" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/long_running_trace.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-4593fb5cbf069dff364d2829bc758102><img alt="Long Running Trace" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/long_running_trace.png></a></p><p>But why are some traces slow, and others are relatively quick?</p><p>Close the trace and return to the Trace Analyzer. If you toggle <strong>Errors only</strong> to <code>on</code>, you&rsquo;ll also notice that some traces have errors:</p><p><a href=#R-image-582cedf206f59e1293f01110247dd315 class=lightbox-link><img alt=Traces class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/traces_with_errors.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-582cedf206f59e1293f01110247dd315><img alt=Traces class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/traces_with_errors.png></a></p><p>If we look at one of the error traces, we can see that the error occurs when the <code>creditprocessorservice</code> attempts to call another service named <code>otherservice</code>. But why do some requests result in a call to <code>otherservice</code>, and others don&rsquo;t?</p><p><a href=#R-image-77ab0fdb0a6549d2cd8a6d1d904417d4 class=lightbox-link><img alt="Trace with Errors" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/error_trace.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-77ab0fdb0a6549d2cd8a6d1d904417d4><img alt="Trace with Errors" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/error_trace.png></a></p><p>To determine why some requests perform slowly, and why some requests result in errors, we could look through the
traces one by one and try to find a pattern behind the issues.</p><p><strong>Splunk Observability Cloud</strong> provides a better way to find the root cause of an issue. We&rsquo;ll explore this next.</p><h2 id=using-tag-spotlight>Using Tag Spotlight</h2><p>Since we indexed the <code>credit.score.category</code> tag, we can use it with <strong>Tag Spotlight</strong> to troubleshoot our application.</p><p>Navigate to <strong>APM</strong> then click on <strong>Tag Spotlight</strong> on the right-hand side. Ensure the <code>creditcheckservice</code> service is selected from the <strong>Service</strong> drop-down (if not already selected).</p><p>With <strong>Tag Spotlight</strong>, we can see 100% of credit score requests that result in a score of <code>impossible</code> have an error, yet requests for all other credit score types have no errors at all!</p><p><strong><a href=#R-image-bd6fc342f436fed9ba068d54285fab49 class=lightbox-link><img alt="Tag Spotlight with Errors" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/tag_spotlight_errors.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-bd6fc342f436fed9ba068d54285fab49><img alt="Tag Spotlight with Errors" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/tag_spotlight_errors.png></a></strong></p><p>This illustrates the power of <strong>Tag Spotlight</strong>! Finding this pattern would be time-consuming without it, as we&rsquo;d have to manually look through hundreds of traces to identify the pattern (and even then, there&rsquo;s no guarantee we&rsquo;d find it).</p><p>We&rsquo;ve looked at errors, but what about latency? Let&rsquo;s click on the <strong>Requests & errors distribution</strong> dropdown and change it to <strong>Latency distribution</strong>.</p><blockquote><p>IMPORTANT: Click on the settings icon beside <strong>Cards display</strong> to add the P50 and P99 metrics.</p></blockquote><p>Here, we can see that the requests with a <code>poor</code> credit score request are running slowly, with P50, P90, and P99 times of around 3 seconds, which is too long for our users to wait, and much slower than other requests.</p><p>We can also see that some requests with an <code>exceptional</code> credit score request are running slowly, with P99 times of around 5 seconds, though the P50 response time is relatively quick.</p><p><strong><a href=#R-image-b310298cfdcc02e5bfc2162c182b1836 class=lightbox-link><img alt="Tag Spotlight with Latency" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/tag_spotlight_latency.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b310298cfdcc02e5bfc2162c182b1836><img alt="Tag Spotlight with Latency" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/tag_spotlight_latency.png></a></strong></p><h2 id=using-dynamic-service-maps>Using Dynamic Service Maps</h2><p>Now that we know the credit score category associated with the request can impact performance and error rates, let&rsquo;s explore another feature that utilizes indexed tags: <strong>Dynamic Service Maps</strong>.</p><p>With Dynamic Service Maps, we can breakdown a particular service by a tag. For example, let&rsquo;s click on <strong>APM</strong>, then click <strong>Service Map</strong> to view the service map.</p><p>Click on <code>creditcheckservice</code>. Then, on the right-hand menu, click on the drop-down that says <strong>Breakdown</strong>, and select the <code>credit.score.category</code> tag.</p><p>At this point, the service map is updated dynamically, and we can see the performance of requests hitting <code>creditcheckservice</code> broken down by the credit score category:</p><p><strong><a href=#R-image-55fa2c2b680e99d02cbb15e036110337 class=lightbox-link><img alt="Service Map Breakdown" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/service_map_breakdown.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-55fa2c2b680e99d02cbb15e036110337><img alt="Service Map Breakdown" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/service_map_breakdown.png></a></strong></p><p>This view makes it clear that performance for <code>good</code> and <code>fair</code> credit scores is excellent, while <code>poor</code> and <code>exceptional</code> scores are much slower, and <code>impossible</code> scores result in errors.</p><h2 id=our-findings>Our Findings</h2><p><strong>Tag Spotlight</strong> has uncovered several interesting patterns for the engineers that own this service to explore further:</p><ul><li>Why are all the <code>impossible</code> credit score requests resulting in error?</li><li>Why are all the <code>poor</code> credit score requests running slowly?</li><li>Why do some of the <code>exceptional</code> requests run slowly?</li></ul><p>As an SRE, passing this context to the engineering team would be extremely helpful for their investigation, as it would allow them to track down the issue much more quickly than if we simply told them that the service was &ldquo;sometimes slow&rdquo;.</p><p>If you&rsquo;re curious, have a look at the source code for the <code>creditprocessorservice</code>. You&rsquo;ll see that requests with impossible, poor, and exceptional credit scores are handled differently, thus resulting in the differences in error rates and latency that we uncovered.</p><p>The behavior we saw with our application is typical for modern cloud-native applications, where different inputs passed to a service lead to different code paths, some of which result in slower performance or errors. For example, in a real credit check service, requests resulting in low credit scores may be sent to another downstream service to further evaluate risk, and may perform more slowly than requests resulting in higher scores, or encounter higher error rates.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Feb 5, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=summary>Summary</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>2 minutes</span>
</span>&nbsp;<p>This workshop provided hands-on experience with the following concepts:</p><ul><li>How to deploy the <strong>Splunk Distribution of the OpenTelemetry Collector</strong> using Helm.</li><li>How instrument an application with <a href=https://opentelemetry.io rel=external target=_blank><strong>OpenTelemetry</strong></a>.</li><li>How to capture tags of interest from your application using an OpenTelemetry SDK.</li><li>How to index tags in <strong>Splunk Observability Cloud</strong> using <strong>Troubleshooting MetricSets</strong>.</li><li>How to utilize tags in <strong>Splunk Observability Cloud</strong> to find â€œunknown unknownsâ€ using the <strong>Tag Spotlight</strong> and <strong>Dynamic Service Map</strong> features.</li></ul><p>Collecting tags aligned with the best practices shared in this workshop will let you get even more value from the data youâ€™re sending to <strong>Splunk Observability Cloud</strong>. Now that youâ€™ve completed this workshop, you have the knowledge you need to start collecting tags from your own applications!</p><p>To get started with capturing tags today, check out <a href=https://docs.splunk.com/observability/en/apm/span-tags/add-context-trace-span.html#instrument-your-application-code-to-add-tags-to-spans rel=external target=_blank>how to add tags in various supported languages</a>, and then <a href=https://docs.splunk.com/observability/en/apm/span-tags/index-span-tags.html#apm-index-span-tags rel=external target=_blank>how to use them to create Troubleshooting MetricSets</a> so they can be analyzed in Tag Spotlight. For more help, feel free to <a href=https://www.splunk.com/en_us/about-splunk/contact-us.html rel=external target=_blank>ask a Splunk Expert</a>.</p><p>And to see how other languages and environments are instrumented with OpenTelemetry,
explore the <a href=https://github.com/signalfx/splunk-opentelemetry-examples rel=external target=_blank>Splunk OpenTelemetry Examples GitHub repository</a>.</p><details open class="box cstyle notices primary"><summary class=box-label><i class="fa-fw fas fa-lightbulb"></i>
Tip for Workshop Facilitator(s)</summary><div class=box-content><p>Once the workshop is complete, remember to delete the APM MetricSet you created earlier for the <code>credit.score.category</code> tag.</p></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Dec 23, 2024</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=ingest-processor-for-observability-cloud>Ingest Processor for Observability Cloud</h1><span class="badge cstyle blue badge-with-title"><span class=badge-title class=text-muted>Author
</span><span class=badge-content>Tim Hard</span></span><p>As infrastructure and application environments become exceedingly complex, the volume of data they generate continues to grow significantly. This increase in data volume and variety makes it challenging to gain actionable insights and can impact problem identification and troubleshooting efficiencies. Additionally, the cost of storing and accessing this data can skyrocket. Many data sources, particularly logs and events, provide critical visibility into system operations. However, in most cases, only a few details from these extensive logs are actually needed for effective monitoring and alerting.</p><p><strong>Common Challenges:</strong></p><ul><li>Increasing complexity of infrastructure and application environments.</li><li>Significant growth in data volume generated by these environments.</li><li>Challenges in gaining actionable insights from large volumes of data.</li><li>High costs associated with storing and accessing extensive data.</li><li>Logs and events provide critical visibility but often contain only a few essential details.</li></ul><p>To address these challenges, Splunk Ingest Processor provides a powerful new feature: the ability to convert log events into metrics. Metrics are more efficient to store and process, allowing for faster identification of issues, thereby reducing Mean Time to Detection (MTTD). When retaining the original log or event is necessary, they can be stored in cheaper storage solutions such as S3, reducing the overall cost of data ingestion and computation required for searching them.</p><p><strong>Solution:</strong></p><ul><li>Convert log events into metrics where possible.</li><li>Retain original logs or events in cheaper storage solutions if needed.</li><li>Utilize federated search for accessing and analyzing retained logs.</li></ul><p><strong>Outcomes:</strong></p><ul><li>Metrics are more efficient to store and process.</li><li>Faster identification of problems, reducing Mean Time to Detection (MTTD).</li><li>Lower overall data ingestion and computation costs.</li><li>Enhanced monitoring efficiency and resource optimization.</li><li>Maintain high visibility into system operations with reduced operational costs.</li></ul><p>In this workshop you&rsquo;ll have the opportunity to get hands on with Ingest Processor and Splunk Observability Cloud to see how it can be used to address the challenges outlined above.</p><details open class="box cstyle notices primary"><summary class=box-label><i class="fa-fw fas fa-lightbulb"></i>
Tip</summary><div class=box-content><p>The easiest way to navigate through this workshop is by using:</p><ul><li>the left/right arrows (<strong>&lt;</strong> | <strong>></strong>) on the top right of this page</li><li>the left (â—€ï¸) and right (â–¶ï¸) cursor keys on your keyboard</li></ul></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of Ingest Processor for Observability Cloud</h1><article class=default><header class=headline></header><h1 id=getting-started>Getting Started</h1><p>During this <em><strong>technical</strong></em> Ingest Processor<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> for Splunk Observability Cloud workshop you will have the opportunity to get hands-on with Ingest Processor in Splunk Enterprise Cloud.</p><p>To simplify the workshop modules, a pre-configured Splunk Enterprise Cloud instance is provided.</p><p>The instance is pre-configured with all the requirements for creating an Ingest Processor pipeline.</p><p>This workshop will introduce you to the benefits of using Ingest Processor to convert robust logs to metrics and send those metrics to Splunk Observability Cloud. By the end of these technical workshops, you will have a good understanding of some key features and capabilities of Ingest Processor in Splunk Enterprise Cloud and the value of using Splunk Observability Cloud as a destination within an Ingest Processor pipeline.</p><p>Here are the instructions on how to access your pre-configured <a href=/observability-workshop/v5.90/en/ninja-workshops/11-ingest_processor_for_observability_cloud/1-getting-started/1-access-cloud-instances/index.html>Splunk Enterprise Cloud</a> instance.</p><p><a href=#R-image-fbe6bc588dfbb1e620c0f928c1c0ea9f class=lightbox-link><img alt="Splunk Ingest Processor Architecture" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/IngestProcessor-architecture-diagram_release_updated2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-fbe6bc588dfbb1e620c0f928c1c0ea9f><img alt="Splunk Ingest Processor Architecture" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/IngestProcessor-architecture-diagram_release_updated2.png></a></p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://docs.splunk.com/Documentation/SplunkCloud/9.3.2408/IngestProcessor/AboutIngestProcessorSolution rel=external target=_blank><strong>Ingest Processor</strong></a> is a data processing capability that works within your Splunk Cloud Platform deployment. Use the Ingest Processor to configure data flows, control data format, apply transformation rules prior to indexing, and route to destinations.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 1. Getting Started</h1><article class=default><header class=headline></header><h1 id=how-to-connect-to-your-workshop-environment>How to connect to your workshop environment</h1><ol><li>How to retrieve the URL for your Splunk Enterprise Cloud instances.</li><li>How to access the Splunk Observability Cloud workshop organization.</li></ol><hr><h2 id=1-splunk-cloud-instances>1. Splunk Cloud Instances</h2><p>There are three instances that will be used throughout this workshop which have already been provisioned for you:</p><ol><li>Splunk Enterprise Cloud</li><li>Splunk Ingest Processor (SCS Tenant)</li><li>Splunk Observability Cloud</li></ol><p>The Splunk Enterprise Cloud and Ingest Processor instances are hosted in <a href=https://show.splunk.com rel=external target=_blank>Splunk Show</a>. If you were invited to the workshop, you should have received an email with an invite to the event in <a href=https://show.splunk.com rel=external target=_blank>Splunk Show</a> or a link to the event will have been provided at the beginning of the workshop.</p><p>Login to Splunk Show using your <a href=https://login.splunk.com/ rel=external target=_blank>splunk.com</a> credentials. You should see the event for this workshop. Open the event to see the instance details for your Splunk Cloud and Ingest Processor instances.</p><details open class="box cstyle notices primary"><summary class=box-label><i class="fa-fw fas fa-lightbulb"></i>
Note</summary><div class=box-content><p>Take note of the <code>User Id</code> provided in your Splunk Show event details. This number will be included in the <code>sourcetype</code> that you will use for searching and filtering the Kubernetes data. Because this is a shared environment only use the participant number provided so that other participants data is not effected.</p></div></details><p><a href=#R-image-bcc6fb45e6b4c8423f8903fc669c788d class=lightbox-link><img alt="Splunk Show Instance Information" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/show_instance_information.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-bcc6fb45e6b4c8423f8903fc669c788d><img alt="Splunk Show Instance Information" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/show_instance_information.png></a></p><h2 id=2-splunk-observability-cloud-instances>2. Splunk Observability Cloud Instances</h2><p>You should have also received an email to access the Splunk Observability Cloud workshop organization (You may need to check your spam folder). If you have not received an email, let your workshop instructor know. To access the environment click the <strong>Join Now</strong> button.</p><p><a href=#R-image-fbb6f52f22788c3c7fd353b5df806ed9 class=lightbox-link><img alt="Splunk Observability Cloud Invitation" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/workshop_invitation.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-fbb6f52f22788c3c7fd353b5df806ed9><img alt="Splunk Observability Cloud Invitation" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/workshop_invitation.png></a></p><details open class="box cstyle notices info"><summary class=box-label><i class="fa-fw fas fa-info-circle"></i>
Important</summary><div class=box-content><p>If you access the event before the workshop start time, your instances may not be available yet. Don&rsquo;t worry, they will be provided once the workshop begins.</p></div></details><p>Additionally, you have been invited to a Splunk Observability Cloud workshop organization. The invitation includes a link to the environment. If you don&rsquo;t have a Splunk Observability Cloud account already, you will be asked to create one. If you already have one, you can log in to the instance and, you will see the workshop organization in your available organizations.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=how-ingest-processor-works>How Ingest Processor Works</h1><h6 id=system-architecture>System architecture</h6><p>The primary components of the Ingest Processor service include the Ingest Processor service and SPL2 pipelines that support data processing. The following diagram provides an overview of how the components of the Ingest Processor solution work together:</p><p><a href=#R-image-f9fa0da3179b9a3422a08c884a69d5fe class=lightbox-link><img alt="Splunk Ingest Processor Architecture" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/IngestProcessor-architecture-diagram_release_updated2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-f9fa0da3179b9a3422a08c884a69d5fe><img alt="Splunk Ingest Processor Architecture" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/IngestProcessor-architecture-diagram_release_updated2.png></a></p><h6 id=ingest-processor-service>Ingest Processor service</h6><p>The Ingest Processor service is a cloud service hosted by Splunk. It is part of the data management experience, which is a set of services that fulfill a variety of data ingest and processing use cases.</p><p>You can use the Ingest Processor service to do the following:</p><ul><li>Create and apply SPL2 pipelines that determine how each Ingest Processor processes and routes the data that it receives.</li><li>Define source types to identify the kind of data that you want to process and determine how the Ingest Processor breaks and merges that data into distinct events.</li><li>Create connections to the destinations that you want your Ingest Processor to send processed data to.</li></ul><h6 id=pipelines>Pipelines</h6><p>A pipeline is a set of data processing instructions written in SPL2. When you create a pipeline, you write a specialized SPL2 statement that specifies which data to process, how to process it, and where to send the results. When you apply a pipeline, the Ingest Processor uses those instructions to process all the data that it receives from data sources such as Splunk forwarders, HTTP clients, and logging agents.</p><p>Each pipeline selects and works with a subset of all the data that the Ingest Processor receives. For example, you can create a pipeline that selects events with the source type <code>cisco_syslog</code> from the incoming data, and then sends them to a specified index in Splunk Cloud Platform. This subset of selected data is called a partition. For more information, see <a href=http://docs.splunk.com/Documentation/SplunkCloud/latest/IngestProcessor/Architecture#Partitions rel=external target=_blank>Partitions</a>.</p><p>The Ingest Processor solution supports only the commands and functions that are part of the <code>IngestProcessor</code> profile. For information about the specific SPL2 commands and functions that you can use to write pipelines for Ingest Processor, see <a href=http://docs.splunk.com/Documentation/SplunkCloud/latest/IngestProcessor/PipelinesOverview rel=external target=_blank>Ingest Processor pipeline syntax</a>. For a summary of how the <code>IngestProcessor</code> profile supports different commands and functions compared to other SPL2 profiles, see the following pages in the <em>SPL2 Search Reference</em>:</p><ul><li><a href=http://docs.splunk.com/Documentation/SCS/current/SearchReference/CompatibilityQuickReferenceforSPL2commands rel=external target=_blank>Compatibility Quick Reference for SPL2 commands</a></li><li><a href=http://docs.splunk.com/Documentation/SCS/current/SearchReference/CompatibilityQuickReferenceforSPL2evaluationfunctions rel=external target=_blank>Compatibility Quick Reference for SPL2 evaluation functions</a></li></ul><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=create-an-ingest-pipeline>Create an Ingest Pipeline</h1><h2 id=scenario-overview>Scenario Overview</h2><p>In this scenario you will be playing the role of a Splunk Admin responsible for managing your organizations Splunk Enterprise Cloud environment. You recently worked with an internal application team on instrumenting their Kubernetes environment with Splunk APM and Infrastructure monitoring using OpenTelemetry to monitor their critical microservice applications.</p><p>The logs from the Kubernetes environment are also being collected and sent to Splunk Enter Prize Cloud. These logs include:</p><ul><li>Pod logs (application logs)</li><li>Kubernetes Events</li><li>Kubernetes Cluster Logs<ul><li>Control Plane Node logs</li><li>Worker Node logs</li><li>Audit Logs</li></ul></li></ul><p>As a Splunk Admin you want to ensure that the data you are collecting is optimized, so it can be analyzed in the most efficient way possible. Taking this approach accelerates troubleshooting and ensures efficient license utilization.</p><p>One way to accomplish this is by using Ingest Processor to convert robust logs to metrics and use Splunk Observability Cloud as the destination for those metrics. Not only does this make collecting the logs more efficient, you have the added ability of using the newly created metrics in Splunk Observability which can then be correlated with Splunk APM data (traces) and Splunk Infrastructure Monitoring data providing additional troubleshooting context. Because Splunk Observability Cloud uses a streaming metrics pipeline, the metrics can be alerted on in real-time speeding up problem identification. Additionally, you can use the Metrics Pipeline Management functionality to further optimize the data by aggregating, dropping unnecessary fields, and archiving less important or unneeded metrics.</p><p>In the next step you&rsquo;ll create an Ingest Processor Pipeline which will convert Kubernetes Audit Logs to metrics that will be sent to Observability Cloud.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 3. Create an Ingest Pipeline</h1><article class=default><header class=headline></header><h1 id=login-to-splunk-cloud>Login to Splunk Cloud</h1><p>In this section you will create an Ingest Pipeline which will convert Kubernetes Audit Logs to metrics which are sent to the Splunk Observability Cloud workshop organization. Before getting started you will need to access the Splunk Cloud and Ingest Processor SCS Tenant environments provided in the Splunk Show event details.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Pre-requisite: Login to Splunk Enterprise Cloud</summary><div class=box-content><p><strong>1.</strong> Open the <strong>Ingest Processor Cloud Stack</strong> URL provided in the Splunk Show event details.</p><p><a href=#R-image-0e34162057670197a52720e0b5d17d3f class=lightbox-link><img alt="Splunk Cloud Instance Details" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/show_instances_sec.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-0e34162057670197a52720e0b5d17d3f><img alt="Splunk Cloud Instance Details" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/show_instances_sec.png></a></p><p><strong>2.</strong> In the Connection info click on the <strong>Stack URL</strong> link to open your Splunk Cloud stack.</p><p><a href=#R-image-0e826f89c76132c380a39c0d5947b523 class=lightbox-link><img alt="Splunk Cloud Connection Details" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/sec_connection_details.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-0e826f89c76132c380a39c0d5947b523><img alt="Splunk Cloud Connection Details" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/sec_connection_details.png></a></p><p><strong>3.</strong> Use the <code>admin</code> username and password to login to Splunk Cloud.</p><p><a href=#R-image-28a51d423eaf2dcb5fd287a5a2b2e2ae class=lightbox-link><img alt="Splunk Cloud Login" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/sec_login.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-28a51d423eaf2dcb5fd287a5a2b2e2ae><img alt="Splunk Cloud Login" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/sec_login.png></a></p><p><strong>4.</strong> After logging in, if prompted, accept the Terms of Service and click <strong>OK</strong></p><p><a href=#R-image-42a563fea4eb2c170eacc598d24d584b class=lightbox-link><img alt="Splunk Cloud Login" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/sec_terms.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-42a563fea4eb2c170eacc598d24d584b><img alt="Splunk Cloud Login" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/sec_terms.png></a></p><p><strong>5.</strong> Navigate back to the Splunk Show event details and select the Ingest Processor SCS Tenant</p><p><a href=#R-image-13c7f1a080ea6ddea8cec8ccb697af49 class=lightbox-link><img alt="Ingest Processor Connection Details" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/show_instances_scs.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-13c7f1a080ea6ddea8cec8ccb697af49><img alt="Ingest Processor Connection Details" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/show_instances_scs.png></a></p><p><strong>6.</strong> Click on the <strong>Console URL</strong> to access the <strong>Ingest Processor SCS Tenant</strong></p><details open class="box cstyle notices primary"><summary class=box-label><i class="fa-fw fas fa-lightbulb"></i>
Note</summary><div class=box-content><p><strong>Single Sign-On (SSO)</strong>
Single Sign-on (SSO) is configured between the Splunk Data Management service (â€˜SCS Tenantâ€™) and Splunk Cloud environments, so if you already logged in to your Splunk Cloud stack you should automatically be logged in to Splunk Data Management service. If you are prompted for credentials, use the credentials provided in the Splunk Cloud Stack on Splunk Show event (listed under the â€˜Splunk Cloud Stackâ€™ section.)</p></div></details></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=review-kubernetes-audit-logs>Review Kubernetes Audit Logs</h1><p>In this section you will review the Kubernetes Audit Logs that are being collected. You can see that the events are quite robust, which can make charting them inefficient. To address this, you will create an Ingest Pipeline in Ingest Processor that will convert these events to metrics that will be sent to Splunk Observability Cloud. This will allow you to chart the events much more efficiently and take advantage of the real-time streaming metrics in Splunk Observability Cloud.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise: Create Ingest Pipeline</summary><div class=box-content><p><strong>1.</strong> Open your <strong>Ingest Processor Cloud Stack</strong> instance using the URL provided in the Splunk Show workshop details.</p><p><strong>2.</strong> Navigate to <strong>Apps</strong> â†’ <strong>Search and Reporting</strong></p><p><a href=#R-image-59a2b71f4b8a7ea26f994043cfe9a94f class=lightbox-link><img alt="Search and Reporting" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../../images/search_and_reporting.png?width=20vw" style=height:auto;width:20vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-59a2b71f4b8a7ea26f994043cfe9a94f><img alt="Search and Reporting" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/search_and_reporting.png?width=20vw"></a></p><p><strong>3.</strong> In the search bar, enter the following SPL search string.</p><details open class="box cstyle notices primary"><summary class=box-label><i class="fa-fw fas fa-lightbulb"></i>
Note</summary><div class=box-content><p>Make sure to replace <code>USER_ID</code> with the User ID provided in your Splunk Show instance information.</p></div></details><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1>### Replace USER_ID with the User ID provided in your Splunk Show instance information</span>
</span></span><span class=line><span class=cl><span class=nv>index</span><span class=o>=</span>main <span class=nv>sourcetype</span><span class=o>=</span><span class=s2>&#34;kube:apiserver:audit:USER_ID&#34;</span></span></span></code></pre></div><p><strong>4.</strong> Press <strong>Enter</strong> or click the green magnifying glass to run the search.</p><p><a href=#R-image-d666b7ba85a18d956a05a9d866f6de6c class=lightbox-link><img alt="Kubernetes Audit Log" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/k8s_audit_log.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d666b7ba85a18d956a05a9d866f6de6c><img alt="Kubernetes Audit Log" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/k8s_audit_log.png></a></p><details open class="box cstyle notices info"><summary class=box-label><i class="fa-fw fas fa-info-circle"></i>
Note</summary><div class=box-content><p>You should now see the Kubernetes Audit Logs for your environment. Notice that the events are fairly robust. Explore the available fields and start to think about what information would be good candidates for metrics and dimensions. Ask yourself: What fields would I like to chart, and how would I like to be able to filter, group, or split those fields?</p></div></details></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=create-an-ingest-pipeline>Create an Ingest Pipeline</h1><p>In this section you will create an Ingest Pipeline which will convert Kubernetes Audit Logs to metrics which are sent to the Splunk Observability Cloud workshop organization.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise: Create Ingest Pipeline</summary><div class=box-content><p><strong>1.</strong> Open the <strong>Ingest Processor SCS Tenant</strong> using the connection details provided in the Splunk Show event.</p><p><a href=#R-image-3eb323c7f4b84835a00255548bd4a05a class=lightbox-link><img alt="Launch Splunk Cloud Platform" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../../images/data_management_home.png?width=40vw" style=height:auto;width:40vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-3eb323c7f4b84835a00255548bd4a05a><img alt="Launch Splunk Cloud Platform" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/data_management_home.png?width=40vw"></a></p><details open class="box cstyle notices primary"><summary class=box-label><i class="fa-fw fas fa-lightbulb"></i>
Note</summary><div class=box-content><p>When you open the <strong>Ingest Processor SCS Tenant</strong>, if you are taken to a welcome page, click on <strong>Launch</strong> under <strong>Splunk Cloud Platform</strong> to be taken to the Data Management page where you will configure the Ingest Pipeline.</p><p><a href=#R-image-f56d9d2e85201c405159c8d2d6b21d11 class=lightbox-link><img alt="Launch Splunk Cloud Platform" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/launch_scp.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-f56d9d2e85201c405159c8d2d6b21d11><img alt="Launch Splunk Cloud Platform" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/launch_scp.png></a></p></div></details><p><strong>2.</strong> From the Splunk Data Management console select <strong>Pipelines</strong> â†’ <strong>New pipeline</strong> â†’ <strong>Ingest Processor pipeline</strong>.</p><p><a href=#R-image-c15a8eb10aba9413e46c1aadcb291a8b class=lightbox-link><img alt="New Ingest Processor Pipeline" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../../images/new_pipeline.png?width=40vw" style=height:auto;width:40vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c15a8eb10aba9413e46c1aadcb291a8b><img alt="New Ingest Processor Pipeline" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/new_pipeline.png?width=40vw"></a></p><p><strong>3.</strong> In the <strong>Get started</strong> step of the Ingest Processor configuration page select <strong>Blank Pipeline</strong> and click <strong>Next</strong>.</p><p><a href=#R-image-7e066f3ba4907f7c4eeca574645cdd6d class=lightbox-link><img alt="Blank Ingest Processor Pipeline" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../../images/blank_pipeline.png?width=40vw" style=height:auto;width:40vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-7e066f3ba4907f7c4eeca574645cdd6d><img alt="Blank Ingest Processor Pipeline" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/blank_pipeline.png?width=40vw"></a></p><p><strong>4.</strong> In the <strong>Define your pipelineâ€™s partition</strong> step of the Ingest Processor configuration page select <strong>Partition by sourcetype</strong>. Select the <strong>= equals</strong> Operator and enter <code>kube:apiserver:audit:USER_ID</code> (Be sure to replace USER_ID with the User ID you were assigned) for the value. Click <strong>Apply</strong>.</p><p><a href=#R-image-7d2bbddc0891d09427ed1b5fb48d89e3 class=lightbox-link><img alt="Add Partition" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../../images/add_partition.png?width=40vw" style=height:auto;width:40vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-7d2bbddc0891d09427ed1b5fb48d89e3><img alt="Add Partition" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/add_partition.png?width=40vw"></a></p><p><strong>5.</strong> Click <strong>Next</strong></p><p><strong>6.</strong> In the <strong>Add sample data</strong> step of the Ingest Processor configuration page select <strong>Capture new snapshot</strong>. Enter <code>k8s_audit_USER_ID</code> (Be sure to replace USER_ID with the User ID you were assigned) for the Snapshot name and click <strong>Capture</strong>.</p><p><a href=#R-image-b20069ffa4544abc6c70092ac8c02009 class=lightbox-link><img alt="Capture Snapshot" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../../images/capture_snapshot.png?width=40vw" style=height:auto;width:40vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b20069ffa4544abc6c70092ac8c02009><img alt="Capture Snapshot" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/capture_snapshot.png?width=40vw"></a></p><p><strong>7.</strong> Make sure your newly created snapshot (<code>k8s_audit_USER_ID</code>) is selected and then click <strong>Next</strong>.</p><p><a href=#R-image-f76f18873f2a882793fa74f45f49c69b class=lightbox-link><img alt="Configure Snapshot Sourcetype" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../../images/capture_snapshot_sourcetype.png?width=20vw" style=height:auto;width:20vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-f76f18873f2a882793fa74f45f49c69b><img alt="Configure Snapshot Sourcetype" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/capture_snapshot_sourcetype.png?width=20vw"></a></p><p><strong>8.</strong> In the <strong>Select a metrics destination</strong> step of the Ingest Processor configuration page select <strong>show_o11y_org</strong>. Click <strong>Next</strong>.</p><p><a href=#R-image-579bddd759717bf561caac4c26a0d6c4 class=lightbox-link><img alt="Metrics Destination" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../../images/metrics_destination.png?width=20vw" style=height:auto;width:20vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-579bddd759717bf561caac4c26a0d6c4><img alt="Metrics Destination" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/metrics_destination.png?width=20vw"></a></p><p><strong>9.</strong> In the <strong>Select a data destination</strong> step of the Ingest Processor configuration page select <strong>splunk_indexer</strong>. Under <strong>Specify how you want your events to be routed to an index</strong> select <strong>Default</strong>. Click <strong>Done</strong>.</p><p><a href=#R-image-b3dab97f66c1f2b8b0f69882363f4f97 class=lightbox-link><img alt="Event Routing" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../../images/event_routing.png?width=20vw" style=height:auto;width:20vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b3dab97f66c1f2b8b0f69882363f4f97><img alt="Event Routing" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/event_routing.png?width=20vw"></a></p><p><strong>10.</strong> In the <strong>Pipeline search field</strong> replace the default search with the following.</p><details open class="box cstyle notices primary"><summary class=box-label><i class="fa-fw fas fa-lightbulb"></i>
Note</summary><div class=box-content><p><strong>Replace <code>UNIQUE_FIELD</code> in the metric name with a unique value (such as your initials) which will be used to identify your metric in Observability Cloud.</strong></p></div></details><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>/*A valid SPL2 statement for a pipeline must start with &#34;$pipeline&#34;, and include &#34;from $source&#34; and &#34;into $destination&#34;.*/
</span></span><span class=line><span class=cl>/* Import logs_to_metrics */
</span></span><span class=line><span class=cl>import logs_to_metrics from /splunk/ingest/commands
</span></span><span class=line><span class=cl>$pipeline =
</span></span><span class=line><span class=cl>| from $source
</span></span><span class=line><span class=cl>| thru [
</span></span><span class=line><span class=cl>        //define the metric name, type, and value for the Kubernetes Events
</span></span><span class=line><span class=cl>        //
</span></span><span class=line><span class=cl>        // REPLACE UNIQUE_FIELD WITH YOUR INITIALS
</span></span><span class=line><span class=cl>        //
</span></span><span class=line><span class=cl>        | logs_to_metrics name=&#34;k8s_audit_UNIQUE_FIELD&#34; metrictype=&#34;counter&#34; value=1 time=_time
</span></span><span class=line><span class=cl>        | into $metrics_destination
</span></span><span class=line><span class=cl>    ]
</span></span><span class=line><span class=cl>| eval index = &#34;kube_logs&#34;
</span></span><span class=line><span class=cl>| into $destination;</span></span></code></pre></div><details open class="box cstyle notices info"><summary class=box-label><i class="fa-fw fas fa-lightbulb"></i>
New to SPL2?</summary><div class=box-content><p>Here is a breakdown of what the SPL2 query is doing:</p><ul><li>First, you are importing the built-in <code>logs_to_metrics</code> command which will be used to convert the kubernetes events to metrics.</li><li>You&rsquo;re using the source data, which you can see on the right is any event from the <code>kube:apiserver:audit</code> sourcetype.</li><li>Now, you use the <code>thru</code> command which writes the source dataset to the following command, in this case <code>logs_to_metrics</code>.</li><li>You can see that the metric name (<code>k8s_audit</code>), metric type (<code>counter</code>), value, and timestamp are all provided for the metric. Youâ€™re using a value of 1 for this metric because we want to count the number of times the event occurs.</li><li>Next, you choose the destination for the metric using the into <code>$metrics_destintation</code> command, which is our Splunk Observability Cloud organization</li><li>Finally, you can send the raw log events to another destination, in this case another index, so they are retained if we ever need to access them.</li></ul></div></details><p><strong>11.</strong> In the upper-right corner click the <strong>Preview</strong> button <a href=#R-image-8832a7d64d87f7c18eab783a522ae6ab class=lightbox-link><img alt="Preview Button" class="noborder inline lazy lightbox noshadow figure-image" loading=lazy src="../../images/preview.png?height=20px&classes=inline" style=height:20px;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8832a7d64d87f7c18eab783a522ae6ab><img alt="Preview Button" class="noborder inline lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/preview.png?height=20px&classes=inline"></a> or press CTRL+Enter (CMD+Enter on Mac). From the <strong>Previewing $pipeline</strong> dropdown select <strong>$metrics_destination</strong>. Confirm you are seeing a preview of the metrics that will be sent to Splunk Observability Cloud.</p><p><a href=#R-image-0acd8e1c9ce3c490be94c606dcbe1a4f class=lightbox-link><img alt="Preview Pipeline" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../../images/preview_pipeline.png?width=40vw" style=height:auto;width:40vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-0acd8e1c9ce3c490be94c606dcbe1a4f><img alt="Preview Pipeline" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/preview_pipeline.png?width=40vw"></a></p><p><strong>12.</strong> In the upper-right corner click the <strong>Save pipeline</strong> button <a href=#R-image-60153d8b71c7fb812d375c8506b5fc36 class=lightbox-link><img alt="Save Pipeline Button" class="noborder inline lazy lightbox noshadow figure-image" loading=lazy src="../../images/save_pipeline_btn.png?height=20px&classes=inline" style=height:20px;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-60153d8b71c7fb812d375c8506b5fc36><img alt="Save Pipeline Button" class="noborder inline lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/save_pipeline_btn.png?height=20px&classes=inline"></a>. Enter <code>Kubernetes Audit Logs2Metrics USER_ID</code> for your pipeline name and click <strong>Save</strong>.</p><p><a href=#R-image-0645c3e02e1ec7f31810c4fac490a792 class=lightbox-link><img alt="Save Pipeline Dialog" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../../images/save_pipeline_dialog.png?width=40vw" style=height:auto;width:40vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-0645c3e02e1ec7f31810c4fac490a792><img alt="Save Pipeline Dialog" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/save_pipeline_dialog.png?width=40vw"></a></p><p><strong>13.</strong> After clicking save you will be asked if you would like to apply the newly created pipeline. Click <strong>Yes, apply</strong>.</p><p><a href=#R-image-55ce09bdbf3ac1ecdd4644f8e5c14a8a class=lightbox-link><img alt="Apply Pipeline Dialog" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../../images/apply_pipeline_dialog.png?width=40vw" style=height:auto;width:40vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-55ce09bdbf3ac1ecdd4644f8e5c14a8a><img alt="Apply Pipeline Dialog" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/apply_pipeline_dialog.png?width=40vw"></a></p><details open class="box cstyle notices info"><summary class=box-label><i class="fa-fw fas fa-info-circle"></i>
Note</summary><div class=box-content><p>The Ingest Pipeline should now be sending metrics to Splunk Observability Cloud. Keep this tab open as it will be used it again in the next section.</p><p>In the next step you&rsquo;ll confirm the pipeline is working by viewing the metrics you just created in Splunk Observability Cloud.</p></div></details></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=confirm-metrics-in-observability-cloud>Confirm Metrics in Observability Cloud</h1><p>Now that an Ingest Pipeline has been configured to convert Kubernetes Audit Logs into metrics and send them to Splunk Observability Cloud the metrics should be available. To confirm the metrics are being collected complete the following steps:</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise: Confirm Metrics in Splunk Observability Cloud</summary><div class=box-content><p><strong>1.</strong> Login to the <strong>Splunk Observability Cloud</strong> organization you were invited for the workshop. In the upper-right corner, click the <strong>+</strong> Icon â†’ <strong>Chart</strong> to create a new chart.</p><p><a href=#R-image-9eccbac6ba05b443d3eda684fa8a631d class=lightbox-link><img alt="Create New Chart" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../../images/create_new_chart.png?width=40vw" style=height:auto;width:40vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-9eccbac6ba05b443d3eda684fa8a631d><img alt="Create New Chart" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/create_new_chart.png?width=40vw"></a></p><p><strong>2.</strong> In the <strong>Plot Editor</strong> of the newly created chart enter the metric name you used while configuring the <strong>Ingest Pipeline</strong>.</p><p><a href=#R-image-d9571cc2b9b4a808f0f4e3b82bc8fe9c class=lightbox-link><img alt="Review Metric" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../../images/review_metric.png?width=40vw" style=height:auto;width:40vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d9571cc2b9b4a808f0f4e3b82bc8fe9c><img alt="Review Metric" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/review_metric.png?width=40vw"></a></p><details open class="box cstyle notices info"><summary class=box-label><i class="fa-fw fas fa-info-circle"></i>
Info</summary><div class=box-content><p>You should see the metric you created in the Ingest Pipeline. Keep this tab open as it will be used again in the next section.</p><p>In the next step you will update the ingest pipeline to add dimensions to the metric, so you have additional context for alerting and troubleshooting.</p></div></details></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=update-pipeline-and-visualize-metrics>Update Pipeline and Visualize Metrics</h1><h2 id=context-matters>Context Matters</h2><p>In the previous section, you reviewed the raw Kubernetes audit logs and created an Ingest Processor Pipeline to convert them to metrics and send those metrics to Splunk Observability Cloud.</p><p>Now that this pipeline is defined we are collecting the new metrics in Splunk Observability Cloud. This is a great start; however, you will only see a single metric showing the total number of Kubernetes audit events for a given time period. It would be much more valuable to add dimensions so that you can split the metric by the event type, user, response status, and so on.</p><p>In this section you will update the Ingest Processor Pipeline to include additional dimensions from the Kubernetes audit logs to the metrics that are being collected. This will allow you to further filter, group, visualize, and alert on specific aspects of the audit logs. After updating the metric, you will create a new dashboard showing the status of the different types of actions associated with the logs.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 4. Update Pipeline and Visualize Metrics</h1><article class=default><header class=headline></header><h1 id=update-ingest-pipeline>Update Ingest Pipeline</h1><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise: Update Ingest Pipeline</summary><div class=box-content><p><strong>1.</strong> Navigate back to the configuration page for the Ingest Pipeline you created in the previous step.</p><p><a href=#R-image-c499ce71044dfe8634c7debba01d26dd class=lightbox-link><img alt="Ingest Pipeline" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../../images/ingest_pipeline.png?width=40vw" style=height:auto;width:40vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c499ce71044dfe8634c7debba01d26dd><img alt="Ingest Pipeline" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/ingest_pipeline.png?width=40vw"></a></p><p><strong>2.</strong> To add dimensions to the metric from the raw Kubernetes audit logs update the SPL2 query you created for the pipeline by replacing the <code>logs_to_metrics</code> portion of the query with the following:</p><details open class="box cstyle notices primary"><summary class=box-label><i class="fa-fw fas fa-lightbulb"></i>
Note</summary><div class=box-content><p><strong>Be sure to update the metric name field (<code>name="k8s_audit_UNIQUE_FIELD"</code>) to the name you provided in the original pipeline</strong></p></div></details><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>| logs_to_metrics name=&#34;k8s_audit_UNIQUE_FIELD&#34; metrictype=&#34;counter&#34; value=1 time=_time dimensions={&#34;level&#34;: _raw.level, &#34;response_status&#34;: _raw.responseStatus.code, &#34;namespace&#34;: _raw.objectRef.namespace, &#34;resource&#34;: _raw.objectRef.resource, &#34;user&#34;: _raw.user.username, &#34;action&#34;: _raw.verb}</span></span></code></pre></div><details open class="box cstyle notices info"><summary class=box-label><i class="fa-fw fas fa-info"></i>
Note</summary><div class=box-content><p>Using the <code>dimensions</code> field in the SPL2 query you can add dimensions from the raw events to the metrics that will be sent to Splunk Observability Cloud. In this case you are adding the event response status, namespace, Kubernetes resource, user, and verb (action that was performed). These dimensions can be used to create more granular dashboards and alerts.</p><p>You should consider adding any common tags across your services so that you can take advantage of context propagation and related content in Splunk Observability Cloud.</p></div></details><p>The updated pipeline should now be the following:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>/*A valid SPL2 statement for a pipeline must start with &#34;$pipeline&#34;, and include &#34;from $source&#34; and &#34;into $destination&#34;.*/
</span></span><span class=line><span class=cl>/* Import logs_to_metrics */
</span></span><span class=line><span class=cl>import logs_to_metrics from /splunk/ingest/commands
</span></span><span class=line><span class=cl>$pipeline =
</span></span><span class=line><span class=cl>| from $source
</span></span><span class=line><span class=cl>| thru [
</span></span><span class=line><span class=cl>        //define the metric name, type, and value for the Kubernetes Events
</span></span><span class=line><span class=cl>        //
</span></span><span class=line><span class=cl>        // REPLACE UNIQUE_FIELD WITH YOUR INITIALS
</span></span><span class=line><span class=cl>        //
</span></span><span class=line><span class=cl>        | logs_to_metrics name=&#34;k8s_audit_UNIQUE_FIELD&#34; metrictype=&#34;counter&#34; value=1 time=_time dimensions={&#34;level&#34;: _raw.level, &#34;response_status&#34;: _raw.responseStatus.code, &#34;namespace&#34;: _raw.objectRef.namespace, &#34;resource&#34;: _raw.objectRef.resource, &#34;user&#34;: _raw.user.username, &#34;action&#34;: _raw.verb}
</span></span><span class=line><span class=cl>        | into $metrics_destination
</span></span><span class=line><span class=cl>    ]
</span></span><span class=line><span class=cl>| eval index = &#34;kube_logs&#34;
</span></span><span class=line><span class=cl>| into $destination;</span></span></code></pre></div><p><strong>3.</strong> In the upper-right corner click the <strong>Preview</strong> button <a href=#R-image-417c1b9874ad3ff92f69ab62150ab8b9 class=lightbox-link><img alt="Preview Button" class="noborder inline lazy lightbox noshadow figure-image" loading=lazy src="../../images/preview.png?height=20px&classes=inline" style=height:20px;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-417c1b9874ad3ff92f69ab62150ab8b9><img alt="Preview Button" class="noborder inline lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/preview.png?height=20px&classes=inline"></a> or press CTRL+Enter (CMD+Enter on Mac). From the <strong>Previewing $pipeline</strong> dropdown select <strong>$metrics_destination</strong>. Confirm you are seeing a preview of the metrics that will be sent to Splunk Observability Cloud.</p><p><a href=#R-image-5a8b38cd97aed3386403285126fe2834 class=lightbox-link><img alt="Ingest Pipeline Dimensions" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../../images/ingest_pipeline_dimensions.png?width=40vw" style=height:auto;width:40vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5a8b38cd97aed3386403285126fe2834><img alt="Ingest Pipeline Dimensions" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/ingest_pipeline_dimensions.png?width=40vw"></a></p><p><strong>4.</strong> Confirm you are seeing the dimensions in the dimensions column of the preview table. You can view the entire dimensions object by clicking into the table.</p><p><a href=#R-image-1bcb2e7253cae5753bf00fa61f62b958 class=lightbox-link><img alt="Ingest Pipeline Dimensions Review" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../../images/ingest_pipeline_dimensions_field.png?width=40vw" style=height:auto;width:40vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-1bcb2e7253cae5753bf00fa61f62b958><img alt="Ingest Pipeline Dimensions Review" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/ingest_pipeline_dimensions_field.png?width=40vw"></a></p><p><strong>5.</strong> In the upper-right corner click the <strong>Save pipeline</strong> button <a href=#R-image-c729e03f520b3aae75177c462db93214 class=lightbox-link><img alt="Save Pipeline Button" class="noborder inline lazy lightbox noshadow figure-image" loading=lazy src="../../images/save_pipeline_btn.png?height=20px&classes=inline" style=height:20px;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c729e03f520b3aae75177c462db93214><img alt="Save Pipeline Button" class="noborder inline lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/save_pipeline_btn.png?height=20px&classes=inline"></a>. On the â€œYou are editing an active pipeline modalâ€ click <strong>Save</strong>.</p><p><a href=#R-image-287b5ad36485d91dc51d3cce19bd2329 class=lightbox-link><img alt="Save Updated Pipeline" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../../images/save_updated_pipeline.png?width=30vw" style=height:auto;width:30vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-287b5ad36485d91dc51d3cce19bd2329><img alt="Save Updated Pipeline" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/save_updated_pipeline.png?width=30vw"></a></p><details open class="box cstyle notices info"><summary class=box-label><i class="fa-fw fas fa-info-circle"></i>
Note</summary><div class=box-content><p>Because this pipeline is already active, the changes you made will take effect immediately. Your metric should now be split into multiple metric timeseries using the dimensions you added.</p><p>In the next step you will create a visualization using different dimensions from the Kubernetes audit events.</p></div></details></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=visualize-kubernetes-audit-event-metrics>Visualize Kubernetes Audit Event Metrics</h1><p>Now that your metric has dimensions you will create a chart showing the health of different Kubernetes actions using the <code>verb</code> dimension from the events.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise: Visualize Kubernetes Audit Event Metrics</summary><div class=box-content><p><strong>1.</strong> If you closed the chart you created in the previous section, in the upper-right corner, click the <strong>+</strong> Icon â†’ <strong>Chart</strong> to create a new chart.</p><p><a href=#R-image-03fc41912469d8da2b559326eacc2b10 class=lightbox-link><img alt="Create New Chart" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../../images/create_new_chart.png?width=40vw" style=height:auto;width:40vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-03fc41912469d8da2b559326eacc2b10><img alt="Create New Chart" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/create_new_chart.png?width=40vw"></a></p><p><strong>2.</strong> In the <strong>Plot Editor</strong> of the newly created chart enter <code>k8s_audit*</code> in the metric name field. You will use a wildcard here so that you can see all the metrics that are being ingested.</p><p><a href=#R-image-283855c492d42740925cfd33b89465c4 class=lightbox-link><img alt="Review Metric" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../../images/review_metric.png?width=40vw" style=height:auto;width:40vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-283855c492d42740925cfd33b89465c4><img alt="Review Metric" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/review_metric.png?width=40vw"></a></p><p><strong>3.</strong> Notice the change from one to many metrics, which is when you updated the pipeline to include the dimensions. Now that we have this metric available, let&rsquo;s adjust the chart to show us if any of our actions have errors associated with them.</p><p><a href=#R-image-8a4f56c250bda0d963605136cea0b777 class=lightbox-link><img alt="Metric Timeseries" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../../images/metric_timeseries.png?width=40vw" style=height:auto;width:40vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8a4f56c250bda0d963605136cea0b777><img alt="Metric Timeseries" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/metric_timeseries.png?width=40vw"></a></p><p>First you&rsquo;ll filter the Kubernetes events to only those that were not successful using the HTTP response code which is available in the <strong>response_status</strong> field. We only want events that have a response code of <strong>409</strong>, which indicates that there was a conflict (for example a trying to create a resource that already exists) or <strong>503</strong>, which indicates that the API was unresponsive for the request.</p><p><strong>4.</strong> In the plot editor of your chart click the <strong>Add filter</strong>, use <strong>response_status</strong> for the field and select <strong>409.0</strong> and <strong>503.0</strong> for the values.</p><p>Next, youâ€™ll add a function to the chart which will calculate the total number of events grouped by the <strong>resource</strong>, <strong>action</strong>, and <strong>response status</strong>. This will allow us to see exactly which actions and the associated resources had errors. Now we are only looking at Kubernetes events that were not successful.</p><p><strong>5.</strong> Click <strong>Add analytics</strong> â†’ <strong>Sum</strong> â†’ <strong>Sum:Aggregation</strong> and add <strong>resource</strong>, <strong>action</strong>, and <strong>response_status</strong> in the <strong>Group by</strong> field.</p><p><a href=#R-image-98c482cac4a1f6420b443139e62eaebf class=lightbox-link><img alt="Add Metric Filters" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../../images/add_metric_filters.png?width=40vw" style=height:auto;width:40vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-98c482cac4a1f6420b443139e62eaebf><img alt="Add Metric Filters" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/add_metric_filters.png?width=40vw"></a></p><p><strong>6.</strong> Using the chart type along the top buttons, change the chart to a <strong>heatmap</strong>. Next to the <strong>Plot editor</strong>, click <strong>Chart options</strong>. In the <strong>Group by</strong> section select <strong>response_status</strong> then <strong>action</strong>. Change the <strong>Color threshold</strong> from <strong>Auto</strong> to <strong>Fixed</strong>. Click the blue <strong>+ button</strong> to add another threshold. Change the <strong>Down arrow to Yellow</strong>, the <strong>Middle to orange</strong>. Leave the <strong>Up arrow as red</strong>. Enter <strong>5 for the middle threshold</strong> and <strong>20 for the upper threshold</strong>.</p><p><a href=#R-image-50ce790b7e9bb4dab5f13cbceabb0d25 class=lightbox-link><img alt="Configure Thresholds" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../../images/configure_thresholds.png?width=40vw" style=height:auto;width:40vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-50ce790b7e9bb4dab5f13cbceabb0d25><img alt="Configure Thresholds" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/configure_thresholds.png?width=40vw"></a></p><p><strong>7.</strong> In the upper right corner of the chart click the blue <strong>Save as&mldr;</strong> <a href=#R-image-0a0eee13f4374068c1deddb9d019b80a class=lightbox-link><img alt="Preview Button" class="noborder inline lazy lightbox noshadow figure-image" loading=lazy src="../../images/save_as_btn.png?height=20px&classes=inline" style=height:20px;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-0a0eee13f4374068c1deddb9d019b80a><img alt="Preview Button" class="noborder inline lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/save_as_btn.png?height=20px&classes=inline"></a> button. Enter a name for your chart (For Example: Kubernetes Audit Logs - Conflicts and Failures).</p><p><a href=#R-image-ca26c3207ccbdf1f4d645f480c07dd12 class=lightbox-link><img alt="Chart Name" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/chart_name.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ca26c3207ccbdf1f4d645f480c07dd12><img alt="Chart Name" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/chart_name.png></a></p><p><strong>8.</strong> On the <strong>Choose a dashboard</strong> select <strong>New dashboard</strong>.</p><p><a href=#R-image-4d97e2ad4a49c8c5646aa323def20c83 class=lightbox-link><img alt="New Dashboard" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/new_dashboard.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-4d97e2ad4a49c8c5646aa323def20c83><img alt="New Dashboard" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/new_dashboard.png></a></p><p><strong>9.</strong> Enter a name for your dashboard that includes your initials, so you can easily find it later. Click <strong>Save</strong>.</p><p><a href=#R-image-afc661e5dfcdde1f1cacca0fd7aa63c0 class=lightbox-link><img alt="New Dashboard Name" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/dashboard_name.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-afc661e5dfcdde1f1cacca0fd7aa63c0><img alt="New Dashboard Name" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/dashboard_name.png></a></p><p><strong>10.</strong> Make sure the new dashboard you just created is selected and click <strong>Ok</strong>.</p><p><a href=#R-image-ea983597bf766a5e4c9cf811d5d35f0e class=lightbox-link><img alt="Save New Dashboard" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../../images/save_new_dashboard.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ea983597bf766a5e4c9cf811d5d35f0e><img alt="Save New Dashboard" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../../images/save_new_dashboard.png></a></p><p>You should now be taken to your new Kubernetes Audit Events dashboard with the chart you created. You can add new charts from other metrics in your environment, such as application errors and response times from the applications running in the Kubernetes cluster, or other Kubernetes metrics such as pod phase, pod memory utilization, etc. giving you a correlated view of your Kubernetes environment from cluster events to application health.</p><p><a href=#R-image-228fe4cf796f68bc3083b4d35e7be09f class=lightbox-link><img alt="Audit Dashboard" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../../images/audit_dashboard.png?width=40vw" style=height:auto;width:40vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-228fe4cf796f68bc3083b4d35e7be09f><img alt="Audit Dashboard" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../../images/audit_dashboard.png?width=40vw"></a></p></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Mar 3, 2025</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=conclusion>Conclusion</h1><p>In this workshop, you walked through the entire process of optimizing Kubernetes log management by converting detailed log events into actionable metrics using <strong>Splunk Ingest Pipelines</strong>. You started by defining a pipeline that efficiently converts Kubernetes audit logs into metrics, drastically reducing the data volume while retaining critical information. You then ensured the raw log events were securely stored in S3 for long-term retention and deeper analysis.</p><p><a href=#R-image-875147e1859689a37b0f15615af001fc class=lightbox-link><img alt="Kubernetes Audit Event" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../images/audit_event.png?width=40vw" style=height:auto;width:40vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-875147e1859689a37b0f15615af001fc><img alt="Kubernetes Audit Event" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../images/audit_event.png?width=40vw"></a></p><p>Next, you demonstrated how to enhance these metrics by adding key dimensions from the raw events, enabling us to drill down into specific actions and resources. you created a chart that filtered the metrics to focus on errors, breaking them out by resource and action. This allowed us to pinpoint exactly where issues were occurring in real-time.</p><p><a href=#R-image-fcb3dee4da56d561dbfc5804f688d685 class=lightbox-link><img alt="Ingest Pipeline" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../images/ingest_pipeline_dimensions.png?width=40vw" style=height:auto;width:40vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-fcb3dee4da56d561dbfc5804f688d685><img alt="Ingest Pipeline" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../images/ingest_pipeline_dimensions.png?width=40vw"></a></p><p>The real-time architecture of <strong>Splunk Observability Cloud</strong> means that these metrics can trigger alerts the moment an issue is detected, significantly reducing the Mean Time to Detection (MTTD). Additionally, you showed how this chart can be easily saved to new or existing dashboards, ensuring ongoing visibility and monitoring of critical metrics.</p><p><a href=#R-image-3d1ce42db79a1a14a81a8595872cfe5d class=lightbox-link><img alt="Audit Dashboard" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../images/audit_dashboard.png?width=40vw" style=height:auto;width:40vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-3d1ce42db79a1a14a81a8595872cfe5d><img alt="Audit Dashboard" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../images/audit_dashboard.png?width=40vw"></a></p><p>The value behind this approach is clear: by converting logs to metrics using <strong>Ingest Processor</strong>, you not only streamline data processing and reduce storage costs but also gain the ability to monitor and respond to issues in real-time using <strong>Splunk Observability Cloud</strong>. This results in faster problem resolution, improved system reliability, and more efficient resource utilization, all while maintaining the ability to retain and access the original logs for compliance or deeper analysis.</p><center><h1>Happy Splunking!</h1></center><p><a href=#R-image-74205cf02c07f12f6986c94ad9f7538c class=lightbox-link><img alt="Dancing Buttercup" class="noborder lazy lightbox noshadow figure-image" loading=lazy src="../images/Splunk-dancing-buttercup-GIF-103.gif?width=30vw" style=height:auto;width:30vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-74205cf02c07f12f6986c94ad9f7538c><img alt="Dancing Buttercup" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src="../images/Splunk-dancing-buttercup-GIF-103.gif?width=30vw"></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Jan 29, 2025</span></span></footer></article></section></section></div></main></div><script src=/observability-workshop/v5.90/js/clipboard.min.js?1746614785 defer></script><script src=/observability-workshop/v5.90/js/perfect-scrollbar.min.js?1746614785 defer></script><script src=/observability-workshop/v5.90/js/d3/d3-color.min.js?1746614785 defer></script><script src=/observability-workshop/v5.90/js/d3/d3-dispatch.min.js?1746614785 defer></script><script src=/observability-workshop/v5.90/js/d3/d3-drag.min.js?1746614785 defer></script><script src=/observability-workshop/v5.90/js/d3/d3-ease.min.js?1746614785 defer></script><script src=/observability-workshop/v5.90/js/d3/d3-interpolate.min.js?1746614785 defer></script><script src=/observability-workshop/v5.90/js/d3/d3-selection.min.js?1746614785 defer></script><script src=/observability-workshop/v5.90/js/d3/d3-timer.min.js?1746614785 defer></script><script src=/observability-workshop/v5.90/js/d3/d3-transition.min.js?1746614785 defer></script><script src=/observability-workshop/v5.90/js/d3/d3-zoom.min.js?1746614785 defer></script><script src=/observability-workshop/v5.90/js/js-yaml.min.js?1746614785 defer></script><script src=/observability-workshop/v5.90/js/mermaid.min.js?1746614785 defer></script><script>window.themeUseMermaid=JSON.parse("{}")</script><script src=/observability-workshop/v5.90/js/theme.js?1746614785 defer></script></body></html>