<!doctype html><html lang=en dir=ltr itemscope itemtype=http://schema.org/Article data-r-output-format=print><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.145.0"><meta name=generator content="Relearn 7.6.1+81b6d3c32c77aeecc29c4700d2123bd2fb3401c2"><meta name=description content="This workshop offers a method for automatically adding annotations to your application."><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Improving MTTR with Custom Tags :: Splunk Observability Cloud Workshops"><meta name=twitter:description content="This workshop offers a method for automatically adding annotations to your application."><meta property="og:url" content="https://splunk.github.io/observability-workshop/v6.0/en/unsupported-field-workshops/7-mttr-custom-tags/index.html"><meta property="og:site_name" content="Splunk Observability Cloud Workshops"><meta property="og:title" content="Improving MTTR with Custom Tags :: Splunk Observability Cloud Workshops"><meta property="og:description" content="This workshop offers a method for automatically adding annotations to your application."><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta itemprop=name content="Improving MTTR with Custom Tags :: Splunk Observability Cloud Workshops"><meta itemprop=description content="This workshop offers a method for automatically adding annotations to your application."><meta itemprop=dateModified content="2024-09-19T21:15:15+01:00"><meta itemprop=wordCount content="149"><title>Improving MTTR with Custom Tags :: Splunk Observability Cloud Workshops</title>
<link href=https://splunk.github.io/observability-workshop/v6.0/en/unsupported-field-workshops/7-mttr-custom-tags/index.html rel=canonical type=text/html title="Improving MTTR with Custom Tags :: Splunk Observability Cloud Workshops"><link href=/observability-workshop/v6.0/images/favicon.ico?1753170053 rel=icon type=image/x-icon sizes=any><link href=/observability-workshop/v6.0/css/auto-complete/auto-complete.min.css?1753170053 rel=stylesheet><script src=/observability-workshop/v6.0/js/auto-complete/auto-complete.min.js?1753170053 defer></script><script src=/observability-workshop/v6.0/js/search-lunr.min.js?1753170053 defer></script><script src=/observability-workshop/v6.0/js/search.min.js?1753170053 defer></script><script>window.relearn=window.relearn||{},window.relearn.index_js_url="/observability-workshop/v6.0/searchindex.en.js?1753170053"</script><script src=/observability-workshop/v6.0/js/lunr/lunr.min.js?1753170053 defer></script><script src=/observability-workshop/v6.0/js/lunr/lunr.stemmer.support.min.js?1753170053 defer></script><script src=/observability-workshop/v6.0/js/lunr/lunr.multi.min.js?1753170053 defer></script><script src=/observability-workshop/v6.0/js/lunr/lunr.en.min.js?1753170053 defer></script><script>window.relearn=window.relearn||{},window.relearn.contentLangs=["en"]</script><link href=/observability-workshop/v6.0/fonts/fontawesome/css/fontawesome-all.min.css?1753170053 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v6.0/fonts/fontawesome/css/fontawesome-all.min.css?1753170053 rel=stylesheet></noscript><link href=/observability-workshop/v6.0/css/perfect-scrollbar/perfect-scrollbar.min.css?1753170053 rel=stylesheet><link href=/observability-workshop/v6.0/css/theme.min.css?1753170053 rel=stylesheet><link href=/observability-workshop/v6.0/css/format-print.min.css?1753170053 rel=stylesheet id=R-format-style><script>window.relearn=window.relearn||{},window.relearn.min=`.min`,window.relearn.path="/unsupported-field-workshops/7-mttr-custom-tags/index.html",window.relearn.relBasePath="../../..",window.relearn.relBaseUri="../../../../..",window.relearn.absBaseUri="https://splunk.github.io/observability-workshop/v6.0",window.relearn.disableAnchorCopy=!1,window.relearn.disableAnchorScrolling=!1,window.relearn.disableInlineCopyToClipboard=!0,window.relearn.enableBlockCodeWrap=!0,window.relearn.getItem=(e,t)=>e.getItem(t),window.relearn.setItem=(e,t,n)=>e.setItem(t,n),window.relearn.removeItem=(e,t)=>e.removeItem(t),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`,window.relearn.themevariants=["auto","splunk-light","splunk-dark"],window.relearn.customvariantname="my-custom-variant",window.relearn.changeVariant=function(e){var t=document.documentElement.dataset.rThemeVariant;window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e),document.documentElement.dataset.rThemeVariant=e,t!=e&&(document.dispatchEvent(new CustomEvent("themeVariantLoaded",{detail:{variant:e,oldVariant:t}})),window.relearn.markVariant())},window.relearn.markVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant");document.querySelectorAll(".R-variantswitcher select").forEach(t=>{t.value=e})},window.relearn.initVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant")??"";e==window.relearn.customvariantname||(!e||!window.relearn.themevariants.includes(e))&&(e=window.relearn.themevariants[0],window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e)),document.documentElement.dataset.rThemeVariant=e},window.relearn.initVariant(),window.relearn.markVariant()</script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js crossorigin=anonymous></script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web-session-recorder.js crossorigin=anonymous></script><script>SplunkRum.init({realm:"us1",rumAccessToken:"h7q1NLX6lJz0h_5-OqQJkg",applicationName:"observability-workshop",deploymentEnvironment:"splunk.github.io",version:"1.0"}),SplunkSessionRecorder.init({app:"observability-workshop",realm:"us1",rumAccessToken:"h7q1NLX6lJz0h_5-OqQJkg"})</script></script><style>:root{--MAIN-WIDTH-MAX:130rem;--MENU-WIDTH-L:23rem}p{margin:.75rem 0}.highlight{max-height:500px;overflow-y:auto}pre:not(.mermaid){margin:0}</style></head><body class="mobile-support print" data-url=/observability-workshop/v6.0/en/unsupported-field-workshops/7-mttr-custom-tags/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div><div class="topbar-button topbar-button-toc" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title="Table of Contents (CTRL+ALT+t)"><i class="fa-fw fas fa-list-alt"></i></button><div class=topbar-content><div class=topbar-content-wrapper><nav class=TableOfContents><ul><li><a href=#splunk-observability-cloud>Splunk Observability Cloud</a></li><li><a href=#workshop-story>Workshop Story</a></li></ul></nav></div></div></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v6.0/en/index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v6.0/en/unsupported-field-workshops/index.html><span itemprop=name>Unsupported Field Workshops</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Improving MTTR w/ Custom Tags</span><meta itemprop=position content="3"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-print" data-content-empty=disable data-width-s=area-more data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v6.0/en/unsupported-field-workshops/7-mttr-custom-tags/index.print.html title="Print whole chapter (CTRL+ALT+p)"><i class="fa-fw fas fa-print"></i></a></div><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v6.0/en/unsupported-field-workshops/3-nodejs-kubernetes/6-logs/index.html title="Logs - Payment Service (ðŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v6.0/en/unsupported-field-workshops/7-mttr-custom-tags/1-setup-os/index.html title="Setting up your AWS Instance (ðŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a></div><div class="topbar-button topbar-button-more" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title=More><i class="fa-fw fas fa-ellipsis-v"></i></button><div class=topbar-content><div class=topbar-content-wrapper><div class="topbar-area topbar-area-more" data-area=more></div></div></div></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable unsupported-field-workshops" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=improving-mttr-with-custom-tags>Improving MTTR with Custom Tags</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>45 minutes</span>
</span>&nbsp;<p>This workshop will:</p><p>For this workshop, Splunk has prepared an Ubuntu Linux instance in AWS/EC2 all pre-configured for you.</p><p>To get access to the instance that you will be using in the workshop, please visit the URL provided by the workshop leader.</p><h2 id=splunk-observability-cloud>Splunk Observability Cloud</h2><p>You must have the ability to send traces to Splunk Observability Cloud. If you do not have an account already, please start a trial here: <a href=https://www.splunk.com/en_us/download/apm-free-trial.html rel=external target=_blank>https://www.splunk.com/en_us/download/apm-free-trial.html</a></p><h2 id=workshop-story>Workshop Story</h2><p>Here at Splunk Instruments, our business is expanding!</p><p>We have recently added 3 new locations: Two locations in the USA (Colorado and Chicago) and one international location in Sri Lanka.</p><p>Our technical staff has already on-boarded the data from these new locations and incorporated them into our inventory application and it is our job to review these improvements and send any issues back to our developers for repairs.</p><p>We now have a total of 6 locations!</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><section><h1 class=a11y-only>Subsections of Improving MTTR w/ Custom Tags</h1><article class=default><header class=headline></header><h1 id=setting-up-your-aws-instance>Setting up your AWS Instance</h1><h2 id=environment-setup---mac>Environment Setup - Mac</h2><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info-circle"></i>
Note</summary><div class=box-content><p>If you wish to run this on Mac directly, you can see the instructions <a href=/observability-workshop/v6.0/en/unsupported-field-workshops/7-mttr-custom-tags/appendix-a-setup-mac/index.html>here in the appendix</a> and skip the next section on Linux.</p><p>All installs must continue at <a href=/observability-workshop/v6.0/en/unsupported-field-workshops/7-mttr-custom-tags/2-setup-app/index.html>setting up the app</a>.</p></div></details><h2 id=environment-setup---linux>Environment Setup - Linux</h2><p>You can skip past the EC2 configuration to Linux Software Requirements if you already have an Ec2 that meets the specifications below !!!!</p><ul><li>ubuntu 22.04</li></ul><p><a href=#R-image-faf3e6b0fe1d383235af95a10dfeda10 class=lightbox-link><img alt=1-setup-config-1 class="lazy lightbox figure-image" loading=lazy src=../images/1-setup-config-1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-faf3e6b0fe1d383235af95a10dfeda10><img alt=1-setup-config-1 class="lazy lightbox lightbox-image" loading=lazy src=../images/1-setup-config-1.png></a>
<a href=#R-image-05fde9753062593ea134f7305e1656d2 class=lightbox-link><img alt=1-setup-config-2 class="lazy lightbox figure-image" loading=lazy src=../images/1-setup-config-2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-05fde9753062593ea134f7305e1656d2><img alt=1-setup-config-2 class="lazy lightbox lightbox-image" loading=lazy src=../images/1-setup-config-2.png></a>
<a href=#R-image-118a4b791a326ce06b4c55876d8b466e class=lightbox-link><img alt=1-setup-config-3 class="lazy lightbox figure-image" loading=lazy src=../images/1-setup-config-3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-118a4b791a326ce06b4c55876d8b466e><img alt=1-setup-config-3 class="lazy lightbox lightbox-image" loading=lazy src=../images/1-setup-config-3.png></a></p><ul><li>Security Group Security Settings<ul><li>HTTP inbound open on 8010</li><li>All Traffic open outbound</li></ul></li></ul><p><a href=#R-image-e2143e3d9bb625d6caf008a62e25974b class=lightbox-link><img alt=1-setup-config-4 class="lazy lightbox figure-image" loading=lazy src=../images/1-setup-config-4.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e2143e3d9bb625d6caf008a62e25974b><img alt=1-setup-config-4 class="lazy lightbox lightbox-image" loading=lazy src=../images/1-setup-config-4.png></a></p><ul><li>Linux Software Requirements: docker, docker-compose, git, maven</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt update
</span></span><span class=line><span class=cl>sudo apt upgrade
</span></span><span class=line><span class=cl>sudo apt install docker docker-compose maven</span></span></code></pre></div><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=setting-up-your-application>Setting up your Application</h1><h2 id=environment-setup---application>Environment Setup - Application</h2><ul><li>Clone the workshop repository:</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone -b distributed-tracing-for-development-teams https://github.com/shabuhabs/javashop-otel.git</span></span></code></pre></div><ul><li>Access the workshop directory:</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> javashop-otel</span></span></code></pre></div><ul><li>Set Environment Variables</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nano .env</span></span></code></pre></div><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info-circle"></i>
Note</summary><div class=box-content><ul><li>NO spaces in &lt;your_name></li><li>The shop_user provides us an Environment Tag.</li><li>To get your access token, go to your Splunk O11y UI -> Settings ->Access Tokens.</li><li>It is assumed in this workshop that you can send traces to the org and token you are using.</li></ul></div></details><ul><li>Set the following values:</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>SHOP_USER</span><span class=o>=</span><span class=s>&lt;your_name&gt;</span>
</span></span><span class=line><span class=cl><span class=na>SPLUNK_ACCESS_TOKEN</span><span class=o>=</span><span class=s>&lt;your_token&gt;</span>
</span></span><span class=line><span class=cl><span class=na>SPLUNK_REALM</span><span class=o>=</span><span class=s>&lt;your_realm&gt;</span></span></span></code></pre></div><ul><li>Save in nano with <strong>[CTRL]-o [ENTER]</strong></li><li>Exit nano with <strong>[CTRL]-x</strong></li></ul><h2 id=build-and-deploy-application>Build and Deploy Application</h2><p>Let&rsquo;s get started by building and deploying our Application, the Splunk Instrument Shop. Run the commands below to begin and start reading ahead as your traces are coming up!</p><ul><li>Build the app</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./BuildAndDeploy.sh</span></span></code></pre></div><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=overview-of-the-workshop>Overview of the Workshop</h1><h2 id=users-and-workflows>Users and Workflows</h2><p>As we go through this workshop we will be switching roles from SRE to Developer. First we will start with alert responders or SREs who will identify an issue in Splunk Observability UI. Next, we will jump to a Developer Role to see how a Developer will debug and repair/fix a software problem using trace data provided by our SRE.</p><p>Of course, we are not requiring 2 people for this workshop as each participant will play both roles.</p><h2 id=today-we-will-learn>Today we will learn</h2><p>Today we will learn how Splunk APM with Full Fidelity tracing can accelerate the time to repair for Development teams. We will focus on the full fidelity data ( In the form of traces ) that an SRE or alert responder would send to a developer to then repair/fix software. We will do this with both Auto-Instrumentation data and Custom attributes or Custom Tags, via Manual Instrumentation data.</p><p>While we will be spending time Debugging code, &mldr;. Don&rsquo;t worry, &mldr;there is no programming experience necessary, as our goal here is for every participant to understand how using Custom Attributes/Tags in Splunk APM @ Full Fidelity accelerates Mean Time to Repair Software problems for Development Teams.</p><h2 id=important-definitions>Important Definitions</h2><p>Let&rsquo;s define a few terms for those new to APM / Software Development or Java</p><ul><li>What Are Custom Attributes / Custom Tags in Splunk APM ?</li></ul><p>First, you will hear poeple refer to Custom Attributes in the context of Splunk Enterprise, however in Splunk APM Custom Attributes are called Custom Tags as defined in Opentelemetry and shown in Splunk APM Tag Splotlight.</p><ul><li>What is a Function or a method in Java?</li></ul><p>A Function in most languages, including Java, is a logical chunk of code that &ndash; when executed &ndash; solves a repeatable task. This is basically what development teams spend thier time building and where software issues will most commonly be.</p><ul><li>What is an Exception in Java?</li></ul><p>An exception is an exceptional error condition that indicates abonormal behavior, or an unhandled condition, that interrupts program execution abnormally.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=review-apm-in-the-ui>Review APM in the UI</h1><h2 id=view-service-map>View Service Map</h2><p>Next step is open your Observability UI, accessing the proper org ( where you sent the traces to ) and click APM and Access the Environemnnt that matches the username you put in .env.</p><p><a href=#R-image-3884d01494a9a6232caf650375786ad1 class=lightbox-link><img alt=4-overview-1-filter class="lazy lightbox figure-image" loading=lazy src=../images/4-overview-1-filter.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-3884d01494a9a6232caf650375786ad1><img alt=4-overview-1-filter class="lazy lightbox lightbox-image" loading=lazy src=../images/4-overview-1-filter.png></a></p><p>Please note it may take 4-5 minutes or more for traces to show up and you will see full map &ldquo;form&rdquo; as traces are coming in, so you may have to refresh the page a few times each time we Build and Deploy.</p><p>It is recommended to use a -15m look back during this lab. You may need to change it from time to time (for example to -5m or a custom -10m) to make sure you are only looking at the newer traces after your changes.</p><p>NOTE: You may have to refresh the page several times to see your Environment Tag in the UI. The prefix of the Environment tag should match what you entered for SHOP_USER in the .env file.</p><p><a href=#R-image-1b829355f6f6f4ebc534eb068936aaae class=lightbox-link><img alt=4-overview-2-time-window class="lazy lightbox figure-image" loading=lazy src=../images/4-overview-2-time-window.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-1b829355f6f6f4ebc534eb068936aaae><img alt=4-overview-2-time-window class="lazy lightbox lightbox-image" loading=lazy src=../images/4-overview-2-time-window.png></a></p><p>NOTE: Typically, to identify root cause and route an issue, an SRE or alert responder would check metrics and logs to determine if it is a software or hardware related issue, and thus route to the correct party. In this excercise we are ONLY handling software issues, so we are skipping the metrics and logs parts of normal triage.</p><p>If your instrumentation was successful, the service-map will show latency from the shop service to the products service.</p><p><a href=#R-image-91424c4391d0530f67291bb372a971a4 class=lightbox-link><img alt=4-overview-3-map class="lazy lightbox figure-image" loading=lazy src=../images/4-overview-3-map.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-91424c4391d0530f67291bb372a971a4><img alt=4-overview-3-map class="lazy lightbox lightbox-image" loading=lazy src=../images/4-overview-3-map.png></a></p><p>Ok let&rsquo;s triage this SOFTWARE ISSUE and skip directly to the traces.</p><ul><li>Click on shop service</li><li>Click Traces (on the right side)</li><li>Sort by Duration</li><li>Select the longest duration trace<ul><li>Or one of the obvious much longer ones</li></ul></li></ul><p><a href=#R-image-141038032b7687453be814578c133cd1 class=lightbox-link><img alt=4-overview-4-trace class="lazy lightbox figure-image" loading=lazy src=../images/4-overview-4-trace.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-141038032b7687453be814578c133cd1><img alt=4-overview-4-trace class="lazy lightbox lightbox-image" loading=lazy src=../images/4-overview-4-trace.png></a></p><p>Now we can see the long latency occurred in the products service and if we click on <strong>products: /products</strong> we can see the offending method was <strong>products:ProductResource.getAllProducts</strong></p><p><a href=#R-image-3725a6fb1726b9366f2684fcd011ca11 class=lightbox-link><img alt=4-overview-5-span class="lazy lightbox figure-image" loading=lazy src=../images/4-overview-5-span.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-3725a6fb1726b9366f2684fcd011ca11><img alt=4-overview-5-span class="lazy lightbox lightbox-image" loading=lazy src=../images/4-overview-5-span.png></a></p><p>Our next step here would be to send that trace to a developer by clicking download trace and they will have to debug the function. Since we will be the developer there is no need to download the trace. Just remember that is normal workflow for alert responders to route an issue to the &ldquo;Repairers&rdquo; while providing trace data.</p><p>Before we do that please take note of the Tags available for the developer to leverage to find root cause. We see standard out of the box Otel tags on the span, environmental information, but no indications of data specific to something inside custom code (which is where the problem often is).</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=debugging-101>Debugging 101</h1><h2 id=now-lets-play-the-role-of-the-developer>Now let&rsquo;s play the role of the developer</h2><p>As a developer we must debug the function products:ProductResource.getAllProducts to find the problem.</p><h2 id=debugging-101-the-line-by-line-method>Debugging 101, the Line by Line method</h2><p>Without anything to go on other than &ldquo;BAD FUNCTION&rdquo;, a Developer must then look at code visually line by line to find and fix the problem. To make this worse, <strong>functions call other functions</strong>, and it can get very messy in bad code scenarios.</p><p>We will do the visual inspection mehtod next.</p><ul><li>Using Nano:</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nano products/src/main/java/com/shabushabu/javashop/products/resources/ProductResource.java</span></span></code></pre></div><ul><li>Search in Nano: <strong>[CTRL]-w</strong></li><li>Enter in: <strong>getAllProducts [Enter]</strong></li><li>You will be taken here:</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>  </span><span class=nd>@GET</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Response</span><span class=w> </span><span class=nf>getAllProducts</span><span class=p>(</span><span class=nd>@DefaultValue</span><span class=p>(</span><span class=s>&#34;California&#34;</span><span class=p>)</span><span class=w> </span><span class=nd>@QueryParam</span><span class=p>(</span><span class=s>&#34;location&#34;</span><span class=p>)</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>location</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c1>// STEP X: All we know right now is somewhere in this function, latency was introduced.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>myCoolFunction1</span><span class=p>(</span><span class=n>location</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>myCoolFunction2</span><span class=p>(</span><span class=n>location</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>myCoolFunction10</span><span class=p>(</span><span class=n>location</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>myCoolFunction13</span><span class=p>(</span><span class=n>location</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>myCoolFunction5</span><span class=p>(</span><span class=n>location</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>myCoolFunction6</span><span class=p>(</span><span class=n>location</span><span class=p>);</span></span></span></code></pre></div><p>We can see here in getAllProducts, the first call is to <code>myCoolFunction1()</code>, so as may have guessed our next step is to go look at <code>myCoolFunction1()</code>.</p><ul><li>Search in Nano: <strong>[CTRL]-w</strong></li><li>Enter in: myCoolFunction1 <strong>[Enter]</strong></li><li>Find the next occurrence: <strong>[CTRL]-w [Enter]</strong></li><li>Keep repeating <strong>[CTRL]-w [Enter]</strong> until you get to the actual function definition</li></ul><p>It looks like this:</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>myCoolFunction1</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>location</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c1>// Generate a FAST sleep of 0 time !</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kt>int</span><span class=w> </span><span class=n>sleepy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lookupLocation1</span><span class=p>(</span><span class=n>location</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>sleepy</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span></span></span></code></pre></div><p>Now, <code>myCoolFunction1</code> calls <code>lookupLocation1(location)</code></p><ul><li>Search in Nano: <strong>[CTRL]-w</strong></li><li>Enter in: lookupLocation1 <strong>[Enter]</strong></li></ul><p>I think you get the picture by now, you have no choice but to inspect every line of code and every function called and visually inspect them for problems. This can be a VERY long process and kills our customers Mean Time to Repair. This happens quite often to our customers with our competition beacsue they can&rsquo;t provide all the traces 100% of the time and most can&rsquo;t scale to add more data, via Custom Attributes on top of that!</p><p>Remember, without Full Fidelty, you have to either reproduce errors / latency in another environment or inspect code line by line.</p><p>So they are stuck where we are, quite often.</p><p>OK, enough fun. Let&rsquo;s make this easier for our developer, and show off some Splunk APM Scale!</p><ul><li>Exit your editor:</li><li>Exit nano: <strong>[CTRL]-X</strong></li><li>Optional: If it asks you to save, hit <strong>N</strong></li></ul><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=custom-tags>Custom Tags</h1><h2 id=custom-attribution-custom-tags>Custom Attribution (Custom Tags)</h2><p>To take a deeper look at this issue and make this much easier to debug we will implement Custom Attributes via Opentelemetry Manual Instrumentation.</p><p>To speed up manual instrumentation in Java you can leverage OpenTelemetry Annotations, which automatically create a span around a method without modifying the actual code inside the method. This can be very valuable if you are working with an SRE that may have limited access to source code changes.</p><p>To add even more information to help our developers find the root cause faster, OpenTelemetry Annotations can be used to generate span tags with parameter values for the method in question. This is incredibly important to mean time to Repair, because as a Developer, if I know the parameter values of a function at the time of latency or error, I can debug this without having to reproduce an issue in another environment if I have Full Fidelity Tracing.</p><p>Splunk Full Fidelity APM allows our customers development teams to debug their code as it ran in production, 100% of the time. Add with Custom Attribution, you are providing repeatable Mean Time to Repair reduction&mldr; 100% of the time, only with Full Fidelity tracing.</p><p>To expedite manual instrumentation implementation for this exercise, we have provided a tool which will annotate the entirety of the &ldquo;shop&rdquo; and &ldquo;products&rdquo; services with OpenTelemetry standard annotations for every function call without having to write any code. This &ldquo;annotator&rdquo; tool will also tag every parameter in every function, which adds a span tag with Parameter=Value.</p><ul><li>Run Manual Instrumentation Tool</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./AutomateManualInstrumentation.sh</span></span></code></pre></div><ul><li>Rebuild and Deploy the Application</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./BuildAndDeploy.sh</span></span></code></pre></div><h2 id=visualize-in-splunk-apm>Visualize in Splunk APM</h2><p>Now that we have rebuilt and deployed our application, traffic is being sent once again.</p><p>Go back to the Splunk Observability UI and let&rsquo;s see if these annotations help us narrow down the root cause more quickly.</p><p>Let&rsquo;s try to find our latency root cause again, this time with every function and every parameter spanned and tagged respectively&mldr;. You will see exactly what this means and how it benefits developers in a moment.</p><p><a href=#R-image-d4b98a45441fa610da9ec609871ca0a3 class=lightbox-link><img alt=6-custom-tags-1-apm-map class="lazy lightbox figure-image" loading=lazy src=../images/6-custom-tags-1-apm-map.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d4b98a45441fa610da9ec609871ca0a3><img alt=6-custom-tags-1-apm-map class="lazy lightbox lightbox-image" loading=lazy src=../images/6-custom-tags-1-apm-map.png></a></p><ul><li>Click on shop service</li><li>Click Traces ( on the right side )</li><li>Sort by Duration</li><li>Select the longest duration trace ( or one of the obvious much longer ones )</li></ul><p><a href=#R-image-ccd627f419b1d5fd5c8c0b3764b9f13d class=lightbox-link><img alt=6-custom-tags-2-trace class="lazy lightbox figure-image" loading=lazy src=../images/6-custom-tags-2-trace.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ccd627f419b1d5fd5c8c0b3764b9f13d><img alt=6-custom-tags-2-trace class="lazy lightbox lightbox-image" loading=lazy src=../images/6-custom-tags-2-trace.png></a></p><p>We can see that the actual function call that has the latency was not <code>ProductResource.getAllProducts</code> but the function call <code>ProductResource.myCoolFunction234234234</code>.</p><p>Since we now have the parameter tagged as part of our span metadata the actual root cause is seemingly related to the &ldquo;location&rdquo; <strong>Colorado</strong>. And it appears the one custom attribute that was tagged for function <code>ProductResource.myCoolFunction234234234</code> was <code>myInt</code> with a value of <strong>999</strong>. With this information a developer can debug very quickly.</p><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info-circle"></i>
Note</summary><div class=box-content><p>We added additional span information, which we call <strong>Custom Attributes</strong> here at Splunk. In this case our <strong>Custom Attributes</strong> are <strong>Parameter Values at Time of Latency</strong>.</p></div></details><p>In our exmaple the <code>myInt</code> tag was created due our handy Annotator, that did the OpenTelemetry Annotations for us.</p><ul><li>Using nano:</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nano products/src/main/java/com/shabushabu/javashop/products/resources/ProductResource.java</span></span></code></pre></div><ul><li>Search in Nano: <strong>[CTRL]-w</strong></li><li>Enter in: <strong>999 [Enter]</strong></li></ul><p>We can see here, someone wrote some very bad code in the form of a long Sleep!</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>999</span><span class=o>==</span><span class=n>myInt</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sleepy</span><span class=p>.</span><span class=na>nextInt</span><span class=p>(</span><span class=n>5000</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>3000</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>3000</span><span class=p>);</span></span></span></code></pre></div><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=fixing-code>Fixing Code</h1><h2 id=finding-the-problem>Finding the Problem</h2><p>How did we get here? How did the 999 end up in the trace as a Custom Attribute?</p><p>Take a look at the function signature</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>myCoolFunction234234234</span><span class=p>(</span><span class=nd>@SpanAttribute</span><span class=p>(</span><span class=s>&#34;myInt&#34;</span><span class=p>)</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>myInt</span><span class=p>)</span></span></span></code></pre></div><p><code>@SpanAttribute("myint")</code> is an OpenTelemetry Annotation that was added by our Java Otel Annotator tool.</p><h2 id=fixing-the-code>Fixing the code</h2><ul><li>Change this:</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>myCoolFunction234234234</span><span class=p>(</span><span class=nd>@SpanAttribute</span><span class=p>(</span><span class=s>&#34;myInt&#34;</span><span class=p>)</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>myInt</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Generate a FAST sleep of 0 time !</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Random</span><span class=w> </span><span class=n>sleepy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Random</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>999</span><span class=o>==</span><span class=n>myInt</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>sleepy</span><span class=p>.</span><span class=na>nextInt</span><span class=p>(</span><span class=n>5000</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>3000</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+</span><span class=w> </span><span class=n>3000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>){</span></span></span></code></pre></div><ul><li>to this:</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>myCoolFunction234234234</span><span class=p>(</span><span class=nd>@SpanAttribute</span><span class=p>(</span><span class=s>&#34;myInt&#34;</span><span class=p>)</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>myInt</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Generate a FAST sleep of 0 time !</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Random</span><span class=w> </span><span class=n>sleepy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Random</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// if (999==myInt)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Thread.sleep(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// sleepy.nextInt(5000 - 3000)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// + 3000);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>){</span></span></span></code></pre></div><p>which is basically placing comments (//) before the lines in myCoolFunction234234234 that are causing the slowness:</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// if (999==myInt)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Thread.sleep(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// sleepy.nextInt(5000 - 3000)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>//</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>3000</span><span class=p>);</span></span></span></code></pre></div><ul><li>Save the changes: <strong>[CTRL]-o [Enter]</strong></li><li>Exit: <strong>[CTRL]-x</strong></li></ul><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info-circle"></i>
Note</summary><div class=box-content><p>Until we rebuild and restart our application this change isn&rsquo;t implemented.</p></div></details><h2 id=find-other-issues>Find Other Issues</h2><p>Let&rsquo;s go see if our manual instrumentation uncovered any other issues we did not see before</p><p>So you may be asking yourself: &ldquo;How does manual instrumentation alone show us &ldquo;more problems&rdquo; than before? Latency is latency, isn&rsquo;t it?&rdquo;</p><p>The answer is with auto-instrumentation you are in most situations NOT covering functions our customers&rsquo; development teams wrote, which is of course the bulk of what developers do. They write functions&mldr;. and of course this is where the bulk of software problems occur.</p><p>You may have noticed a new exception in our trace that was not present with Auto-Instrumentation during our latency fix use-case. Since we skipped over this, let&rsquo;s walk you through it.</p><ul><li>Return to the service map</li><li>Click on shop service</li><li>Click Traces (on the right side)</li><li>Click Errors Only</li></ul><p><a href=#R-image-ffb3e673d4326a77e54c8d1a145f885e class=lightbox-link><img alt=7-fixing-code-1-traces class="lazy lightbox figure-image" loading=lazy src=../images/7-fixing-code-1-traces.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ffb3e673d4326a77e54c8d1a145f885e><img alt=7-fixing-code-1-traces class="lazy lightbox lightbox-image" loading=lazy src=../images/7-fixing-code-1-traces.png></a></p><ul><li>Click on a trace with an error present</li></ul><p><a href=#R-image-ffe979c220df7e3d194d9d5ee0a11955 class=lightbox-link><img alt=7-fixing-code-2-span class="lazy lightbox figure-image" loading=lazy src=../images/7-fixing-code-2-span.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ffe979c220df7e3d194d9d5ee0a11955><img alt=7-fixing-code-2-span class="lazy lightbox lightbox-image" loading=lazy src=../images/7-fixing-code-2-span.png></a></p><p>We can see our exception is <code>InvalidLocaleException</code>.</p><p>The real problem must be related to the new data associated with <strong>Sri Lanka</strong> as the Exception says <strong>&ldquo;Non English Characters found in Instrument Data&rdquo;</strong>.</p><p>This exception had not surfaced in previous traces based on ONLY Auto-Instrumentation because the method where it was thrown was NOT covered with Auto-Instrumentation.</p><p>Once we completed the Manual Instrumentation via the Otel Annotator, this method was instrumented and we can now see we had a buried Exception being thrown.</p><h2 id=fixing-more-code>Fixing more code</h2><p>We already know exactly what file to look in and what method to look at as it is called out in the trace.</p><p><a href=#R-image-dcbb5285916a200a7156d5219a2b1d6f class=lightbox-link><img alt=7-fixing-code-3-what-to-fix class="lazy lightbox figure-image" loading=lazy src=../images/7-fixing-code-3-what-to-fix.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-dcbb5285916a200a7156d5219a2b1d6f><img alt=7-fixing-code-3-what-to-fix class="lazy lightbox lightbox-image" loading=lazy src=../images/7-fixing-code-3-what-to-fix.png></a></p><ul><li>Using nano:</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nano shop/src/main/java/com/shabushabu/javashop/shop/model/Instrument.java</span></span></code></pre></div><ul><li>Search in Nano: <strong>[CTRL]-w</strong></li><li>Enter in: <strong>buildForLocale [Enter]</strong></li></ul><p>Look just above the <code>buildForLocale</code> function.</p><p>Notice the Annotation <code>@WithSpan</code>? <code>@WithSpan</code> is an <a href=https://opentelemetry.io/docs/instrumentation/java/automatic/annotations/ rel=external target=_blank>OpenTelemetry Annotation</a> for Java that automatically generates a span around a the function that follows.</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@WithSpan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>Instrument</span><span class=w> </span><span class=nf>buildForLocale</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@SpanAttribute</span><span class=p>(</span><span class=s>&#34;id&#34;</span><span class=p>)</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@SpanAttribute</span><span class=p>(</span><span class=s>&#34;seller_type&#34;</span><span class=p>)</span><span class=w> </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>id</span><span class=o>=</span><span class=w> </span><span class=n>id</span><span class=p>;</span></span></span></code></pre></div><p>Now let&rsquo;s fix this code. We are going to simply comment this out for now and see if it fixes our latency issue.</p><ul><li>Change this:</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isEnglish</span><span class=p>(</span><span class=n>title</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InvalidLocaleException</span><span class=p>(</span><span class=s>&#34;Non English Characters found in Instrument Data&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Characters OK &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div><ul><li>to this (comment out if block):</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// if (!isEnglish(title)) {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//   throw new InvalidLocaleException(&#34;Non English Characters found in Instrument Data&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// } else {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//   System.out.println(&#34;Characters OK &#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>//</span><span class=w> </span><span class=p>}</span></span></span></code></pre></div><ul><li>Save the changes: <strong>[CTRL]-o [Enter]</strong></li><li>Exit: <strong>[CTRL]-x</strong></li></ul><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=rebuild-and-deploy>Rebuild and Deploy</h1><h2 id=rebuild-and-deploy>Rebuild and Deploy</h2><ul><li>Run</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./BuildAndDeploy.sh</span></span></code></pre></div><ul><li>Wait a few minutes . . .</li><li>Return to the service map</li></ul><p>If you do NOT see RED in your service map, you have completed the Latency Repair for the Colorado Location!</p><p>Now let&rsquo;s check for our exception in the traces.</p><ul><li>Click on shop service</li><li>Click Traces (on the right side)</li><li>Click Errors Only</li></ul><p>If you do not have red in your service map and you do not see Errors in traces, you have successfully completed our Inventory application review for Sri Lanka and Colorado locations.</p><p><strong>Well done!</strong></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=dont-forget-chicago>Don't Forget Chicago</h1><h2 id=dont-forget-chicago>Don&rsquo;t forget Chicago</h2><p>We are nearly done, one more location to go&mldr; Chicago.</p><p>Since we have been having so many issues related to &ldquo;location&rdquo; and we have added that custom attribute via Opentelemetry Manual Instrumentation, lets go to the Splunk Observability UI and look at an APM metric set around that tag that I created for us.</p><p><a href=#R-image-2f8d75607b98c4ab6ad400b561d18348 class=lightbox-link><img alt=9-chicago-1-metricset class="lazy lightbox figure-image" loading=lazy src=../images/9-chicago-1-metricset.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-2f8d75607b98c4ab6ad400b561d18348><img alt=9-chicago-1-metricset class="lazy lightbox lightbox-image" loading=lazy src=../images/9-chicago-1-metricset.png></a></p><ul><li>Open a browser and navigate to <a href=http://[EC2-Address]:8010 rel=external target=_blank>http://[EC2-Address]:8010</a><ul><li>Replace [EC2-Address] with the ip address of your host</li></ul></li><li>Select a few locations and hit the Login button.<ul><li>Make sure to also select the Chicago Location and hit the Login button.</li></ul></li></ul><p><a href=#R-image-24680f54693a39e32655e806f4a52242 class=lightbox-link><img alt=9-chicago-2-app class="lazy lightbox figure-image" loading=lazy src=../images/9-chicago-2-app.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-24680f54693a39e32655e806f4a52242><img alt=9-chicago-2-app class="lazy lightbox lightbox-image" loading=lazy src=../images/9-chicago-2-app.png></a></p><p>Uh oh! We received a 500 error, something is wrong there as well.</p><p><a href=#R-image-d2022e5260a0783362b13356b8969e4f class=lightbox-link><img alt=9-chicago-3-map class="lazy lightbox figure-image" loading=lazy src=../images/9-chicago-3-map.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d2022e5260a0783362b13356b8969e4f><img alt=9-chicago-3-map class="lazy lightbox lightbox-image" loading=lazy src=../images/9-chicago-3-map.png></a></p><ul><li>Return to the Splunk Observability UI and lets look once again at our Service Map</li><li>Select the Instruments Service</li><li>Click the Breakdowns dropdown on the right and select location</li></ul><p><a href=#R-image-5c6252240dc95d689740b92c76ea755c class=lightbox-link><img alt=9-chicago-4-map-breakdown class="lazy lightbox figure-image" loading=lazy src=../images/9-chicago-4-map-breakdown.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5c6252240dc95d689740b92c76ea755c><img alt=9-chicago-4-map-breakdown class="lazy lightbox lightbox-image" loading=lazy src=../images/9-chicago-4-map-breakdown.png></a></p><p>We see there was an un-handled exception thrown in the Instruments service, and some latency from our database that is related to the Chicago location!</p><ul><li>Click on Traces on the right</li><li>Click Errors Only</li><li>Click one of the traces</li></ul><p><a href=#R-image-c43473cb3990eabf2469aeb26f599ba2 class=lightbox-link><img alt=9-chicago-5-trace class="lazy lightbox figure-image" loading=lazy src=../images/9-chicago-5-trace.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c43473cb3990eabf2469aeb26f599ba2><img alt=9-chicago-5-trace class="lazy lightbox lightbox-image" loading=lazy src=../images/9-chicago-5-trace.png></a></p><p>We can see the exception was thrown by Hibernate, however it was thrown in our method instruments: <code>InstrumentRepository.findInstruments</code></p><p><a href=#R-image-9d65ede67e5b41fd2430e63a499df11f class=lightbox-link><img alt=9-chicago-6-span class="lazy lightbox figure-image" loading=lazy src=../images/9-chicago-6-span.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-9d65ede67e5b41fd2430e63a499df11f><img alt=9-chicago-6-span class="lazy lightbox lightbox-image" loading=lazy src=../images/9-chicago-6-span.png></a></p><h2 id=lets-play-developer-again>Let&rsquo;s play developer again</h2><ul><li>Edit the file <code>instruments: InstrumentRepository.findInstruments</code> using nano:</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>nano</span><span class=w> </span><span class=n>instruments</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>main</span><span class=o>/</span><span class=n>java</span><span class=o>/</span><span class=n>com</span><span class=o>/</span><span class=n>shabushabu</span><span class=o>/</span><span class=n>javashop</span><span class=o>/</span><span class=n>instruments</span><span class=o>/</span><span class=n>repositories</span><span class=o>/</span><span class=n>FindInstrumentRepositoryImpl</span><span class=p>.</span><span class=na>java</span></span></span></code></pre></div><ul><li>Find the method: <code>findInstruments</code><ul><li>You know how to do this now, right?</li></ul></li></ul><p><a href=#R-image-c7f671c28c916a746c178b7a7ef05b42 class=lightbox-link><img alt=9-chicago-7-code class="lazy lightbox figure-image" loading=lazy src=../images/9-chicago-7-code.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c7f671c28c916a746c178b7a7ef05b42><img alt=9-chicago-7-code class="lazy lightbox lightbox-image" loading=lazy src=../images/9-chicago-7-code.png></a></p><p>We can see the developer accidently added the Instruments database with the Chicago Instruments database!</p><p>Let&rsquo;s change the query and fix this, remove instruments_for_sale from our query.</p><ul><li>Change this:</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>findInstruments</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;findInstruments Called (All)&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>entityManager</span><span class=p>.</span><span class=na>createNativeQuery</span><span class=p>(</span><span class=w> </span><span class=s>&#34;SELECT * FROM instruments_for_sale, instruments_for_sale_chicago&#34;</span><span class=p>).</span><span class=na>getResultList</span><span class=p>();</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>obj</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div><ul><li>to this:</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>findInstruments</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;findInstruments Called (All)&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>entityManager</span><span class=p>.</span><span class=na>createNativeQuery</span><span class=p>(</span><span class=w> </span><span class=s>&#34;SELECT * FROM instruments_for_sale_chicago&#34;</span><span class=p>).</span><span class=na>getResultList</span><span class=p>();</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>obj</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div><ul><li><p>Save the changes: <strong>[CTRL]-o [Enter]</strong></p></li><li><p>Exit: <strong>[CTRL]-x</strong></p></li><li><p>Build and Deploy Application</p></li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./BuildAndDeploy.sh</span></span></code></pre></div><p>Now let&rsquo;s test the Chicago location once again</p><ul><li>Open a browser and navigate to <a href=http://[EC2-Address]:8010 rel=external target=_blank>http://[EC2-Address]:8010</a></li><li>Select the Chicago location and Login</li></ul><p>We now see the 500 error is gone!</p><ul><li>Let&rsquo;s confirm a clean Service Map:</li></ul><p><a href=#R-image-365de66d8eebcabf3dfbb8e5b3f54892 class=lightbox-link><img alt=9-chicago-8-map-clean class="lazy lightbox figure-image" loading=lazy src=../images/9-chicago-8-map-clean.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-365de66d8eebcabf3dfbb8e5b3f54892><img alt=9-chicago-8-map-clean class="lazy lightbox lightbox-image" loading=lazy src=../images/9-chicago-8-map-clean.png></a></p><p>If you see a clean service map, free of errors and Latency you have successfully completed the Java Instrumentation Workshop!</p><p><strong>Congratulations!!!</strong></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=appendix---setting-up-on-mac>Appendix - Setting up on Mac</h1><h2 id=mac-setup>Mac Setup</h2><ul><li>Tested on<ul><li>Macos Ventura 13.2.1</li><li>Mac M1/M2</li></ul></li></ul><p>Intel Macs should be work; however if they are slower you may need to run <code>./BuildAndDeploy</code> multiple times.</p><p>IMPORTANT: Docker must have access to 6-GB RAM.</p><ul><li>Prerequisites<ul><li><a href=https://mac.install.guide/commandlinetools/index.html rel=external target=_blank>XCode Command line tools</a></li></ul></li></ul><h3 id=homebrew-install>Homebrew Install</h3><ul><li><a href=https://docs.brew.sh/Installation rel=external target=_blank>Homebrew full install details</a></li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir homebrew <span class=o>&amp;&amp;</span> curl -L https://github.com/Homebrew/brew/tarball/master <span class=p>|</span> tar xz --strip <span class=m>1</span> -C homebrew
</span></span><span class=line><span class=cl><span class=nb>eval</span> <span class=s2>&#34;</span><span class=k>$(</span>homebrew/bin/brew shellenv<span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>brew update --force --quiet
</span></span><span class=line><span class=cl>chmod -R go-w <span class=s2>&#34;</span><span class=k>$(</span>brew --prefix<span class=k>)</span><span class=s2>/share/zsh&#34;</span></span></span></code></pre></div><h4 id=install-colima>Install Colima</h4><p>Colima - Colima is a docker daemon that does not require Docker Desktop. This is used to avoid any docker license issues with Docker Desktop.</p><ul><li><a href=https://github.com/abiosoft/colima rel=external target=_blank>Colima full install details</a></li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>brew uninstall docker docker-compose colima
</span></span><span class=line><span class=cl>brew install docker docker-compose colima 
</span></span><span class=line><span class=cl>colima stop
</span></span><span class=line><span class=cl>colima start --cpu <span class=m>4</span> --memory <span class=m>6</span></span></span></code></pre></div><ul><li>Java Tools Install</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>brew install git
</span></span><span class=line><span class=cl>brew install maven</span></span></code></pre></div><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article></section></div></main></div><script src=/observability-workshop/v6.0/js/clipboard/clipboard.min.js?1753170053 defer></script><script src=/observability-workshop/v6.0/js/perfect-scrollbar/perfect-scrollbar.min.js?1753170053 defer></script><script src=/observability-workshop/v6.0/js/theme.min.js?1753170053 defer></script></body></html>