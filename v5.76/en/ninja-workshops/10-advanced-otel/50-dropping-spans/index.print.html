<!doctype html><html lang=en dir=ltr itemscope itemtype=http://schema.org/Article data-r-output-format=print><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.134.3"><meta name=generator content="Relearn 7.2.1"><meta name=description content="In this section, we will explore how to use the filter processor in the OpenTelemetry Collector to selectively drop spans based on certain conditions. Specifically, we will drop traces based on the span name, which is commonly used to filter out unwanted spans such as health checks or internal communication traces.
By the end of this workshop, youâ€™ll know how to configure the OpenTelemetry Collector to:
Filter out unwanted spans."><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Using a Filter to Drop Spans in OpenTelemetry Collector :: Splunk Observability Cloud Workshops"><meta name=twitter:description content="In this section, we will explore how to use the filter processor in the OpenTelemetry Collector to selectively drop spans based on certain conditions. Specifically, we will drop traces based on the span name, which is commonly used to filter out unwanted spans such as health checks or internal communication traces.
By the end of this workshop, youâ€™ll know how to configure the OpenTelemetry Collector to:
Filter out unwanted spans."><meta property="og:url" content="https://splunk.github.io/observability-workshop/v5.76/en/ninja-workshops/10-advanced-otel/50-dropping-spans/index.html"><meta property="og:site_name" content="Splunk Observability Cloud Workshops"><meta property="og:title" content="Using a Filter to Drop Spans in OpenTelemetry Collector :: Splunk Observability Cloud Workshops"><meta property="og:description" content="In this section, we will explore how to use the filter processor in the OpenTelemetry Collector to selectively drop spans based on certain conditions. Specifically, we will drop traces based on the span name, which is commonly used to filter out unwanted spans such as health checks or internal communication traces.
By the end of this workshop, youâ€™ll know how to configure the OpenTelemetry Collector to:
Filter out unwanted spans."><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta itemprop=name content="Using a Filter to Drop Spans in OpenTelemetry Collector :: Splunk Observability Cloud Workshops"><meta itemprop=description content="In this section, we will explore how to use the filter processor in the OpenTelemetry Collector to selectively drop spans based on certain conditions. Specifically, we will drop traces based on the span name, which is commonly used to filter out unwanted spans such as health checks or internal communication traces.
By the end of this workshop, youâ€™ll know how to configure the OpenTelemetry Collector to:
Filter out unwanted spans."><meta itemprop=dateModified content="2025-01-20T16:39:01+00:00"><meta itemprop=wordCount content="942"><title>Using a Filter to Drop Spans in OpenTelemetry Collector :: Splunk Observability Cloud Workshops</title>
<link href=https://splunk.github.io/observability-workshop/v5.76/en/ninja-workshops/10-advanced-otel/50-dropping-spans/index.html rel=canonical type=text/html title="Using a Filter to Drop Spans in OpenTelemetry Collector :: Splunk Observability Cloud Workshops"><link href=/observability-workshop/v5.76/images/favicon.ico?1737480558 rel=icon type=image/x-icon sizes=any><link href=/observability-workshop/v5.76/css/fontawesome-all.min.css?1737480558 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v5.76/css/fontawesome-all.min.css?1737480558 rel=stylesheet></noscript><link href=/observability-workshop/v5.76/css/auto-complete.css?1737480558 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v5.76/css/auto-complete.css?1737480558 rel=stylesheet></noscript><link href=/observability-workshop/v5.76/css/perfect-scrollbar.min.css?1737480558 rel=stylesheet><link href=/observability-workshop/v5.76/css/theme.min.css?1737480558 rel=stylesheet><link href=/observability-workshop/v5.76/css/format-print.min.css?1737480558 rel=stylesheet id=R-format-style><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../../../..",window.relearn.relBaseUri="../../../../../..",window.relearn.absBaseUri="https://splunk.github.io/observability-workshop/v5.76",window.relearn.min=`.min`,window.relearn.disableAnchorCopy=!1,window.relearn.disableAnchorScrolling=!1,window.relearn.themevariants=["auto","splunk-light","splunk-dark"],window.relearn.customvariantname="my-custom-variant",window.relearn.changeVariant=function(e){var t=document.documentElement.dataset.rThemeVariant;window.localStorage.setItem(window.relearn.absBaseUri+"/variant",e),document.documentElement.dataset.rThemeVariant=e,t!=e&&document.dispatchEvent(new CustomEvent("themeVariantLoaded",{detail:{variant:e,oldVariant:t}}))},window.relearn.markVariant=function(){var t=window.localStorage.getItem(window.relearn.absBaseUri+"/variant"),e=document.querySelector("#R-select-variant");e&&(e.value=t)},window.relearn.initVariant=function(){var e=window.localStorage.getItem(window.relearn.absBaseUri+"/variant")??"";e==window.relearn.customvariantname||(!e||!window.relearn.themevariants.includes(e))&&(e=window.relearn.themevariants[0],window.localStorage.setItem(window.relearn.absBaseUri+"/variant",e)),document.documentElement.dataset.rThemeVariant=e},window.relearn.initVariant(),window.relearn.markVariant(),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js crossorigin=anonymous></script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web-session-recorder.js crossorigin=anonymous></script><script>SplunkRum.init({realm:"us1",rumAccessToken:"dp3FKraOS_wVhe-l7eCOsA",applicationName:"observability-workshop",deploymentEnvironment:"splunk.github.io",version:"1.0"}),SplunkSessionRecorder.init({app:"observability-workshop",realm:"us1",rumAccessToken:"dp3FKraOS_wVhe-l7eCOsA"})</script></script><style>:root{--MAIN-WIDTH-MAX:130rem;--MENU-WIDTH-L:23rem}</style></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=/observability-workshop/v5.76/en/ninja-workshops/10-advanced-otel/50-dropping-spans/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div><div class="topbar-button topbar-button-toc" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title="Table of Contents (CTRL+ALT+t)"><i class="fa-fw fas fa-list-alt"></i></button><div class=topbar-content><div class=topbar-content-wrapper><nav class=TableOfContents><ul><li><ul><li><a href=#step-1-review-the-yaml-configuration>Step 1: Review the YAML Configuration</a></li><li><a href=#step-2-apply-the-configuration>Step 2: Apply the Configuration</a></li><li><a href=#step-3-simulate-trace-data>Step 3: Simulate Trace Data</a></li><li><a href=#step-4-monitor-and-debug-the-filter-processor>Step 4: Monitor and Debug the Filter Processor</a></li><li><a href=#step-5-customize-the-filter>Step 5: Customize the Filter</a></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#next-steps>Next Steps</a></li></ul></li></ul></nav></div></div></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v5.76/en/index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v5.76/en/ninja-workshops/index.html><span itemprop=name>Ninja Workshops</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v5.76/en/ninja-workshops/10-advanced-otel/index.html><span itemprop=name>Advanced OpenTelemetry</span></a><meta itemprop=position content="3">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>5. Dropping Spans</span><meta itemprop=position content="4"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-print" data-content-empty=disable data-width-s=area-more data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v5.76/en/ninja-workshops/10-advanced-otel/50-dropping-spans/index.print.html title="Print whole chapter (CTRL+ALT+p)"><i class="fa-fw fas fa-print"></i></a></div><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v5.76/en/ninja-workshops/10-advanced-otel/40-resillience/1-test-resilience/index.html title="Test your Resilience Setup (ðŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v5.76/en/ninja-workshops/10-advanced-otel/60-sensitive-data/index.html title="Removing Tags and Redacting Sensitive Data in OpenTelemetry Collector (ðŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a></div><div class="topbar-button topbar-button-more" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title=More><i class="fa-fw fas fa-ellipsis-v"></i></button><div class=topbar-content><div class=topbar-content-wrapper><div class="topbar-area topbar-area-more" data-area=more></div></div></div></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable ninja-workshops" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=using-a-filter-to-drop-spans-in-opentelemetry-collector>Using a Filter to Drop Spans in OpenTelemetry Collector</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<p>In this section, we will explore how to use the filter processor in the OpenTelemetry Collector to selectively drop spans based on certain conditions. Specifically, we will drop traces based on the span name, which is commonly used to filter out unwanted spans such as health checks or internal communication traces.</p><p>By the end of this workshop, you&rsquo;ll know how to configure the OpenTelemetry Collector to:</p><p>Filter out unwanted spans.</p><ul><li>Use the filter processor to drop spans based on span names.</li><li>Understand and customize error handling in the filter processor.</li></ul><p>Overview of the Configuration
The main processor we&rsquo;ll be working with in this workshop is the filter processor. The filter processor allows you to filter out telemetry data (traces, metrics, logs) based on conditions like span names, attributes, or other criteria. This is useful in scenarios where you want to remove noise (such as health check requests) or prevent processing of unimportant traces.</p><p>Key Configuration Overview:
Hereâ€™s the key section of the YAML configuration that defines the filter processor:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>batch</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata_keys</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>X-SF-Token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>memory_limiter</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>check_interval</span><span class=p>:</span><span class=w> </span><span class=l>2s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>limit_mib</span><span class=p>:</span><span class=w> </span><span class=m>512</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resource/add_mode</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>attributes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>upsert</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;gateway&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>otelcol.service.mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>filter</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>error_mode</span><span class=p>:</span><span class=w> </span><span class=l>ignore</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>span</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s1>&#39;name == &#34;/_healthz&#34;&#39;</span></span></span></code></pre></div><p>Filter Processor: The filter processor is the core of this workshop. It is configured to drop spans based on a specific condition. In this case, we are filtering out spans whose name is &ldquo;/_healthz&rdquo;, typically associated with health check requests.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>filter</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>error_mode</span><span class=p>:</span><span class=w> </span><span class=l>ignore</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>span</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;name == &#34;/_healthz&#34;&#39;</span></span></span></code></pre></div><ul><li>error_mode: ignore: When the filter processor encounters an error in its configuration or processing, it will ignore it and continue processing other traces.</li><li>traces: This section defines the conditions for filtering traces.</li><li>span: We specify that we want to drop spans with the name &ldquo;/_healthz&rdquo;, which is common for health check requests in microservices.</li></ul><h3 id=step-1-review-the-yaml-configuration>Step 1: Review the YAML Configuration</h3><p>First, weâ€™ll take a closer look at the YAML configuration used in the OpenTelemetry Collector. This configuration defines how we process and filter telemetry data:</p><p>yaml
Copy
processors:
batch:
metadata_keys:
- X-SF-Token</p><p>memory_limiter:
check_interval: 2s
limit_mib: 512</p><p>resource/add_mode:
attributes:
- action: upsert
value: &ldquo;gateway&rdquo;
key: otelcol.service.mode</p><p>filter:
error_mode: ignore
traces:
span:
- &rsquo;name == &ldquo;/_healthz&rdquo;'</p><h3 id=step-2-apply-the-configuration>Step 2: Apply the Configuration</h3><h4 id=21-save-the-configuration>2.1 Save the Configuration</h4><p>Save the above YAML configuration to a file called otel-collector-config.yaml.</p><h4 id=22-run-the-opentelemetry-collector>2.2 Run the OpenTelemetry Collector</h4><p>Now, start the OpenTelemetry Collector with your configuration:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>otelcol --config<span class=o>=</span>otel-collector-config.yaml</span></span></code></pre></div><p>This will launch the OpenTelemetry Collector and apply your filter configuration to incoming telemetry data.</p><h3 id=step-3-simulate-trace-data>Step 3: Simulate Trace Data</h3><h4 id=31-send-sample-data-to-the-collector>3.1 Send Sample Data to the Collector</h4><p>To test your configuration, you&rsquo;ll need to generate some trace data that includes a span named &ldquo;/_healthz&rdquo;. This is typically seen in health check requests that many services send to verify their status.</p><p>You can use an instrumented application to generate trace data with the span name &ldquo;/_healthz&rdquo;.
Alternatively, you can simulate trace data manually if you&rsquo;re using a test environment.
Ensure that you send some traces with the span name &ldquo;/_healthz&rdquo; to confirm that they are filtered out.</p><h4 id=32-observe-the-filter-in-action>3.2 Observe the Filter in Action</h4><p>Once the data is sent, the OpenTelemetry Collector should process it and drop any spans with the name &ldquo;/_healthz&rdquo;. You can confirm this by checking the trace data in the destination where it is exported (e.g., Jaeger, Zipkin, or any other trace backend).</p><p>Expected Outcome:</p><ul><li>Traces with the span name &ldquo;/_healthz&rdquo; should not appear in the exported trace data.</li><li>Other spans should be processed normally and appear in the backend.</li></ul><h3 id=step-4-monitor-and-debug-the-filter-processor>Step 4: Monitor and Debug the Filter Processor</h3><h4 id=41-error-mode-handling>4.1 Error Mode Handling</h4><p>If the filter processor encounters any issues, the error_mode: ignore setting will ensure that the processing continues even if there&rsquo;s an error. However, itâ€™s useful to set up logging and monitoring to ensure that the filter configuration is working as expected.</p><p>For example, check the logs of the OpenTelemetry Collector for messages related to trace filtering.</p><h4 id=42-debugging-your-filter-configuration>4.2 Debugging Your Filter Configuration</h4><p>If the filter isnâ€™t working as expected, ensure that:</p><p>The span names are correctly matched.
The filter condition is correctly specified in the YAML file.
You can also adjust the log verbosity of the OpenTelemetry Collector to get more insight into its operations.</p><h3 id=step-5-customize-the-filter>Step 5: Customize the Filter</h3><h4 id=51-modify-the-filter-condition>5.1 Modify the Filter Condition</h4><p>You can customize the filter condition to drop spans based on other criteria. For example, you might want to drop spans that have a specific tag or attribute.</p><p>Example of dropping spans based on an attribute:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>filter</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>error_mode</span><span class=p>:</span><span class=w> </span><span class=l>ignore</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>span</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;attributes[&#34;deployment.environment&#34;] == &#34;testing&#34;&#39;</span></span></span></code></pre></div><p>This filter would drop spans where the deployment.environment attribute is set to &ldquo;testing&rdquo;.</p><h4 id=52-filter-multiple-spans>5.2 Filter Multiple Spans</h4><p>You can filter out multiple span names by extending the span list:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>filter</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>error_mode</span><span class=p>:</span><span class=w> </span><span class=l>ignore</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>span</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;name == &#34;/_healthz&#34;&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;name == &#34;/internal/metrics&#34;&#39;</span></span></span></code></pre></div><p>This will drop spans with the names &ldquo;/_healthz&rdquo; and &ldquo;/internal/metrics&rdquo;.</p><h3 id=conclusion>Conclusion</h3><p>Congratulations! You have successfully configured the OpenTelemetry Collector to filter and drop unwanted spans. This configuration allows you to ignore internal or irrelevant traces, such as health check requests, which can help reduce noise in your telemetry data.</p><p>You can further extend this configuration to filter out spans based on different attributes, tags, or other criteria, making the OpenTelemetry Collector more customizable and efficient for your observability needs.</p><p>Feel free to experiment with different filter conditions and explore the other processor types available in OpenTelemetry to enhance your observability pipeline.</p><h3 id=next-steps>Next Steps</h3><ul><li><strong>Extend Filtering</strong>: Add more filtering conditions based on span attributes or other metadata.</li><li><strong>Explore More Processors</strong>: Learn about other processors like attributes, batch, or memory_limiter for more advanced use cases.</li><li><strong>Integrate with Backends</strong>: Try integrating this filtered data with a backend like Jaeger, Prometheus, or any other observability platform.</li></ul><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Jan 20, 2025</span></span></footer></article></div></main></div><script src=/observability-workshop/v5.76/js/clipboard.min.js?1737480558 defer></script><script src=/observability-workshop/v5.76/js/perfect-scrollbar.min.js?1737480558 defer></script><script src=/observability-workshop/v5.76/js/theme.js?1737480558 defer></script></body></html>