#cloud-config
ssh_pwauth: yes
%{ if pub_key != "" ~}
ssh_authorized_keys:
  - ${pub_key}
%{ endif ~}
password: ${instance_password}
chpasswd:
  expire: false

package_update: true

hostname: ${instance_name}

users:
  - default

packages:
  - ansible
  - docker
  - docker-compose
  - gnupg2
  - jq
  - lynx
  - maven
  - net-tools
  - openjdk-17-jdk
  - python3-flask
  - python3-pip
  - python3-venv
  - shellinabox
  - unzip
  - zsh

groups:
  - docker

system_info:
  default_user:
    groups: [docker]

write_files:
  - path: /etc/ssh/sshd_config
    content: |
         Port 2222
         Protocol 2
         HostKey /etc/ssh/ssh_host_rsa_key
         HostKey /etc/ssh/ssh_host_dsa_key
         HostKey /etc/ssh/ssh_host_ecdsa_key
         HostKey /etc/ssh/ssh_host_ed25519_key
         UsePrivilegeSeparation yes
         KeyRegenerationInterval 3600
         ServerKeyBits 1024
         SyslogFacility AUTH
         LogLevel INFO
         LoginGraceTime 120
         PermitRootLogin no
         StrictModes yes
         RSAAuthentication yes
         PubkeyAuthentication yes
         IgnoreRhosts yes
         RhostsRSAAuthentication no
         HostbasedAuthentication no
         PermitEmptyPasswords no
         ChallengeResponseAuthentication no
         X11Forwarding yes
         X11DisplayOffset 10
         PrintMotd no
         PrintLastLog yes
         TCPKeepAlive yes
         AcceptEnv LANG LC_*
         Subsystem sftp /usr/lib/openssh/sftp-server
         UsePAM yes
         AllowUsers ubuntu

  - path: /etc/skel/.profile
    append: true
    content: |

      export REALM=${realm}
      export ACCESS_TOKEN=${access_token}
      export API_TOKEN=${api_token}
      export RUM_TOKEN=${rum_token}
      export HEC_TOKEN=${hec_token}
      export HEC_URL=${hec_url}

      helm() {
        echo >&2 "Using ACCESS_TOKEN=${access_token}"
        echo >&2 "Using REALM=${realm}"
        command helm "$@"}

      terraform() {
        echo >&2 "Using API_TOKEN=${api_token}"
        echo >&2 "Using REALM=${realm}"
        command terraform "$@"}

      echo "Waiting for cloud-init status..."
      if ! /usr/bin/timeout 180 grep -q 'Cloud-init .*finished at' <(sudo tail -f /var/log/cloud-init-output.log); then
        echo "Instance setup did not complete after 3 minutes. Please try again.";
      else
        echo "Your instance is ready!";
      fi

      INSTANCE=$(cat /etc/hostname)
      CLUSTER_NAME="$INSTANCE-cluster"

      export INSTANCE CLUSTER_NAME

      export KUBECONFIG=/home/ubuntu/.kube/config
      alias kc='kubectl'
      alias dc='docker-compose'

  - path: /etc/rancher/k3s/registries.yaml
    permissions: '0600'
    owner: root:root
    content: |
      mirrors:
        docker.registry:
          endpoint:
            - "http://docker.registry:9999"

  - path: /etc/containers/registries.conf.d/docker.registry.conf
    permissions: '0644'
    owner: root:root
    content: |
      [[registry]]
      location="docker.registry:9999"
      insecure=true

  - path: /etc/docker/daemon.json
    content: |
      {
        "insecure-registries" : ["docker.registry:9999"]
      }

  - path: /usr/local/bin/setup-docker-registry.sh
    permissions: '0744'
    content: |
      #!/usr/bin/env bash
      REGISTRY_NAME=docker.registry
      REGISTRY_PORT=9999
      NODE_IP=$(ip -o -4 addr | awk '$2 != "lo" { print $4}' | sed -e 's,/[[:digit:]]\+$,,')
      echo "$NODE_IP $REGISTRY_NAME" | tee -a /etc/hosts
      echo "$NODE_IP $REGISTRY_NAME" | tee -a /etc/cloud/templates/hosts.debian.tmpl
      systemctl restart docker

  - path: /tmp/workshop-secret.yaml
    permissions: '0755'
    content: |
      apiVersion: v1
      kind: Secret
      metadata:
        name: workshop-secret
        namespace: default
      type: Opaque
      stringData:
        app: ${instance_name}-store
        env: ${instance_name}-workshop
        deployment: "deployment.environment=${instance_name}-workshop"
        access_token: ${access_token}
        api_token: ${api_token}
        realm: ${realm}
        rum_token: ${rum_token}
        hec_token: ${hec_token}
        hec_url: ${hec_url}

  - path: /tmp/create-browser-test.sh
    permissions: '0755'
    content: |
      INSTANCE=$(cat /etc/hostname)
      export INSTANCE
      export REALM=${realm}
      export API_TOKEN=${api_token}
      export EXTERNALIP="$(curl -s http://ifconfig.me)"
      envsubst < /home/ubuntu/workshop/synthetics/browser_test.json > /tmp/modified_test.json
      curl -X POST "https://api.$REALM.signalfx.com/v2/synthetics/tests/browser" \
      -H "Content-Type: application/json" \
      -H "X-SF-TOKEN: $API_TOKEN" \
      --data @/tmp/modified_test.json

  - path: /tmp/diab-setup.sh
    permissions: '0755'
    content: |
      export RUM_TOKEN=${rum_token}
      export REALM=${realm}
      export ACCESS_TOKEN=${access_token}
      export HEC_TOKEN=${hec_token}
      export HEC_URL=${hec_url}
      export INSTANCE="${instance_name}"
      ansible-playbook /home/ubuntu/playbook.yml

  - path: /tmp/pre-setup.sh
    permissions: '0755'
    content: |
      export RUM_TOKEN=${rum_token}
      export REALM=${realm}
      export ACCESS_TOKEN=${access_token}
      export API_TOKEN=${api_token}
      export HEC_TOKEN=${hec_token}
      export HEC_URL=${hec_url}
      export INSTANCE="${instance_name}"
      if [ ! -f /home/ubuntu/.helmok ]; then
        helm repo add splunk-otel-collector-chart https://signalfx.github.io/splunk-otel-collector-chart
        helm repo update
        helm install splunk-otel-collector \
        --set="splunkObservability.realm=${realm}" \
        --set="splunkObservability.accessToken=${access_token}" \
        --set="clusterName=${instance_name}-k3s-cluster" \
        --set="splunkObservability.logsEnabled=false" \
        --set="logsEngine=otel" \
        --set="splunkObservability.profilingEnabled=true" \
        --set="splunkObservability.infrastructureMonitoringEventsEnabled=true" \
        --set="environment=${instance_name}-workshop" \
        --set="splunkPlatform.endpoint=${hec_url}" \
        --set="splunkPlatform.token=${hec_token}" \
        --set="splunkPlatform.index=splunk4rookies-workshop" \
        splunk-otel-collector-chart/splunk-otel-collector \
        -f /home/ubuntu/workshop/k3s/otel-collector.yaml

        # use IDMSv2
        TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
        RUM_FRONTEND_IP=$(curl -sSH "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/local-ipv4)
        export RUM_FRONTEND_IP

        cd /home/ubuntu/workshop/apm/
        sudo kubectl apply -f deployment.yaml
        echo ${instance_name} > /home/ubuntu/.helmok
      fi

  - path: /tmp/otel-demo-setup.sh
    permissions: '0755'
    content: |
      export RUM_TOKEN=${rum_token}
      export REALM=${realm}
      export ACCESS_TOKEN=${access_token}
      export API_TOKEN=${api_token}
      export HEC_TOKEN=${hec_token}
      export HEC_URL=${hec_url}
      export INSTANCE="${instance_name}"
      if [ ! -f /home/ubuntu/.helmok ]; then
        helm repo add splunk-otel-collector-chart https://signalfx.github.io/splunk-otel-collector-chart
        helm repo update
        envsubst '$REALM' < /home/ubuntu/workshop/oteldemo/otel-demo-collector.yaml | helm install splunk-otel-collector \
        --set="splunkObservability.realm=${realm}" \
        --set="splunkObservability.accessToken=${access_token}" \
        --set="clusterName=${instance_name}-k3s-cluster" \
        --set="splunkObservability.logsEnabled=true" \
        --set="logsEngine=otel" \
        --set="splunkObservability.profilingEnabled=true" \
        --set="splunkObservability.infrastructureMonitoringEventsEnabled=true" \
        --set="environment=${instance_name}-workshop" \
        --set="splunkPlatform.endpoint=${hec_url}" \
        --set="splunkPlatform.token=${hec_token}" \
        --set="splunkPlatform.index=splunk4rookies-workshop" \
        splunk-otel-collector-chart/splunk-otel-collector -f -
        helm repo add open-telemetry https://open-telemetry.github.io/opentelemetry-helm-charts
        helm install my-otel-demo open-telemetry/opentelemetry-demo --values /home/ubuntu/workshop/oteldemo/otel-demo.yaml
        echo ${instance_name} > /home/ubuntu/.helmok
      fi

runcmd:
  - chsh -s $(which zsh) ubuntu
  - su ubuntu -c 'sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"'
  - echo "source /etc/skel/.profile" >> /home/ubuntu/.zshrc
  # Install Helm
  - curl -s https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash
  # Install K9s (Kubernetes UI)
  - curl -S -OL https://github.com/derailed/k9s/releases/download/v0.27.0/k9s_Linux_amd64.tar.gz
  - tar xfz k9s_Linux_amd64.tar.gz -C /usr/local/bin/ k9s
  # Download Workshop
  - export WSVERSION=${wsversion}
  - 'export WSARCHIVE=$([ "$WSVERSION" = "main" ] && echo "main" || echo "v$WSVERSION")'
  - curl -s -OL https://github.com/splunk/observability-workshop/archive/$WSARCHIVE.zip
  - unzip -qq $WSARCHIVE.zip -d /home/ubuntu/
  - mkdir /home/ubuntu/workshop
  - mv /home/ubuntu/observability-workshop-$WSVERSION/workshop/* /home/ubuntu/workshop
  - mv /home/ubuntu/workshop/ansible/playbook.yml /home/ubuntu
  - rm -rf /home/ubuntu/observability-workshop-$WSVERSION
  - rm -rf /home/ubuntu/workshop/aws /home/ubuntu/workshop/cloud-init /home/ubuntu/workshop/ansible
  # Download Splunk Observability Content Contrib Repo
  - curl -s -L https://github.com/splunk/observability-content-contrib/archive/main.zip -o content-contrib.zip
  - unzip -qq content-contrib.zip -d /home/ubuntu/
  - mv /home/ubuntu/observability-content-contrib-main /home/ubuntu/observability-content-contrib
  # Configure motd
  - curl -s https://raw.githubusercontent.com/splunk/observability-workshop/main/workshop/cloud-init/motd -o /etc/motd
  - chmod -x /etc/update-motd.d/*
  # Install Terraform
  - curl -S -OL https://releases.hashicorp.com/terraform/1.3.7/terraform_1.3.7_linux_amd64.zip
  - unzip -qq terraform_1.3.7_linux_amd64.zip -d /usr/local/bin
  - bash /usr/local/bin/setup-docker-registry.sh
  # Install K3s
  - curl -sfL https://get.k3s.io | sh -
  # Create kube config and set correct permissions on ubuntu user home directory
  - mkdir /home/ubuntu/.kube && kubectl config view --raw > /home/ubuntu/.kube/config
  - chmod 400 /home/ubuntu/.kube/config
  - chown -R ubuntu:ubuntu /home/ubuntu
  # Deploy private registry
  - /usr/local/bin/kubectl apply -f /home/ubuntu/workshop/k3s/registry/registry.yaml
  - /usr/local/bin/kubectl apply -f /tmp/workshop-secret.yaml
  # Configure shellinabox port and disable ssl then restart
  - sed -i 's/SHELLINABOX_PORT=4200/SHELLINABOX_PORT=6501/' /etc/default/shellinabox
  - sed -i "s/\"--no-beep\"/\"--no-beep --disable-ssl\"/" /etc/default/shellinabox
  - sudo service shellinabox restart
  - sed -i 's/_THEME=\"robbyrussell\"/_THEME=\"gentoo\"/g' home/ubuntu/.zshrc
%{ if diab == true ~}
  - su ubuntu -c 'bash /tmp/diab-setup.sh'
%{ endif ~}
%{ if presetup == true ~}
  - su ubuntu -c 'bash /tmp/pre-setup.sh'
  - su ubuntu -c 'bash /tmp/create-browser-test.sh'
%{ endif ~}
%{ if otel_demo == true ~}
  - su ubuntu -c 'bash /tmp/otel-demo-setup.sh'
%{ endif ~}
