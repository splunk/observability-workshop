<!doctype html><html lang=en dir=ltr itemscope itemtype=http://schema.org/Article data-r-output-format=print><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.134.3"><meta name=generator content="Relearn 7.2.1"><meta name=description content="The OpenTelemetry Collectorâ€™s FileStorage Extension enhances the resilience of your telemetry pipeline by providing reliable checkpointing, managing retries, and handling temporary failures effectively.
With this extension enabled, the OpenTelemetry Collector can store intermediate states on disk, preventing data loss during network disruptions and allowing it to resume operations seamlessly.
Note This solution will work for metrics as long as the connection downtime is briefâ€”up to 15 minutes. If the downtime exceeds this, Splunk Observability Cloud will drop data due to datapoints being out of order."><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="4. Building In Resilience :: Splunk Observability Cloud Workshops"><meta name=twitter:description content="The OpenTelemetry Collectorâ€™s FileStorage Extension enhances the resilience of your telemetry pipeline by providing reliable checkpointing, managing retries, and handling temporary failures effectively.
With this extension enabled, the OpenTelemetry Collector can store intermediate states on disk, preventing data loss during network disruptions and allowing it to resume operations seamlessly.
Note This solution will work for metrics as long as the connection downtime is briefâ€”up to 15 minutes. If the downtime exceeds this, Splunk Observability Cloud will drop data due to datapoints being out of order."><meta property="og:url" content="https://splunk.github.io/observability-workshop/v5.82/en/ninja-workshops/10-advanced-otel/4-building-resilience/index.html"><meta property="og:site_name" content="Splunk Observability Cloud Workshops"><meta property="og:title" content="4. Building In Resilience :: Splunk Observability Cloud Workshops"><meta property="og:description" content="The OpenTelemetry Collectorâ€™s FileStorage Extension enhances the resilience of your telemetry pipeline by providing reliable checkpointing, managing retries, and handling temporary failures effectively.
With this extension enabled, the OpenTelemetry Collector can store intermediate states on disk, preventing data loss during network disruptions and allowing it to resume operations seamlessly.
Note This solution will work for metrics as long as the connection downtime is briefâ€”up to 15 minutes. If the downtime exceeds this, Splunk Observability Cloud will drop data due to datapoints being out of order."><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta itemprop=name content="4. Building In Resilience :: Splunk Observability Cloud Workshops"><meta itemprop=description content="The OpenTelemetry Collectorâ€™s FileStorage Extension enhances the resilience of your telemetry pipeline by providing reliable checkpointing, managing retries, and handling temporary failures effectively.
With this extension enabled, the OpenTelemetry Collector can store intermediate states on disk, preventing data loss during network disruptions and allowing it to resume operations seamlessly.
Note This solution will work for metrics as long as the connection downtime is briefâ€”up to 15 minutes. If the downtime exceeds this, Splunk Observability Cloud will drop data due to datapoints being out of order."><meta itemprop=dateModified content="2025-02-07T17:39:40+00:00"><meta itemprop=wordCount content="180"><title>4. Building In Resilience :: Splunk Observability Cloud Workshops</title>
<link href=https://splunk.github.io/observability-workshop/v5.82/en/ninja-workshops/10-advanced-otel/4-building-resilience/index.html rel=canonical type=text/html title="4. Building In Resilience :: Splunk Observability Cloud Workshops"><link href=/observability-workshop/v5.82/images/favicon.ico?1740086388 rel=icon type=image/x-icon sizes=any><link href=/observability-workshop/v5.82/css/fontawesome-all.min.css?1740086388 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v5.82/css/fontawesome-all.min.css?1740086388 rel=stylesheet></noscript><link href=/observability-workshop/v5.82/css/auto-complete.css?1740086388 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v5.82/css/auto-complete.css?1740086388 rel=stylesheet></noscript><link href=/observability-workshop/v5.82/css/perfect-scrollbar.min.css?1740086388 rel=stylesheet><link href=/observability-workshop/v5.82/css/theme.min.css?1740086388 rel=stylesheet><link href=/observability-workshop/v5.82/css/format-print.min.css?1740086388 rel=stylesheet id=R-format-style><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../../../..",window.relearn.relBaseUri="../../../../../..",window.relearn.absBaseUri="https://splunk.github.io/observability-workshop/v5.82",window.relearn.min=`.min`,window.relearn.disableAnchorCopy=!1,window.relearn.disableAnchorScrolling=!1,window.relearn.themevariants=["auto","splunk-light","splunk-dark"],window.relearn.customvariantname="my-custom-variant",window.relearn.changeVariant=function(e){var t=document.documentElement.dataset.rThemeVariant;window.localStorage.setItem(window.relearn.absBaseUri+"/variant",e),document.documentElement.dataset.rThemeVariant=e,t!=e&&document.dispatchEvent(new CustomEvent("themeVariantLoaded",{detail:{variant:e,oldVariant:t}}))},window.relearn.markVariant=function(){var t=window.localStorage.getItem(window.relearn.absBaseUri+"/variant"),e=document.querySelector("#R-select-variant");e&&(e.value=t)},window.relearn.initVariant=function(){var e=window.localStorage.getItem(window.relearn.absBaseUri+"/variant")??"";e==window.relearn.customvariantname||(!e||!window.relearn.themevariants.includes(e))&&(e=window.relearn.themevariants[0],window.localStorage.setItem(window.relearn.absBaseUri+"/variant",e)),document.documentElement.dataset.rThemeVariant=e},window.relearn.initVariant(),window.relearn.markVariant(),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js crossorigin=anonymous></script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web-session-recorder.js crossorigin=anonymous></script><script>SplunkRum.init({realm:"us1",rumAccessToken:"dp3FKraOS_wVhe-l7eCOsA",applicationName:"observability-workshop",deploymentEnvironment:"splunk.github.io",version:"1.0"}),SplunkSessionRecorder.init({app:"observability-workshop",realm:"us1",rumAccessToken:"dp3FKraOS_wVhe-l7eCOsA"})</script></script><style>:root{--MAIN-WIDTH-MAX:130rem;--MENU-WIDTH-L:23rem}</style></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=/observability-workshop/v5.82/en/ninja-workshops/10-advanced-otel/4-building-resilience/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div><div class="topbar-button topbar-button-toc" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title="Table of Contents (CTRL+ALT+t)"><i class="fa-fw fas fa-list-alt"></i></button><div class=topbar-content><div class=topbar-content-wrapper></div></div></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v5.82/en/index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v5.82/en/ninja-workshops/index.html><span itemprop=name>Ninja Workshops</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v5.82/en/ninja-workshops/10-advanced-otel/index.html><span itemprop=name>Advanced OpenTelemetry</span></a><meta itemprop=position content="3">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>4. Building Resilience</span><meta itemprop=position content="4"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-print" data-content-empty=disable data-width-s=area-more data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v5.82/en/ninja-workshops/10-advanced-otel/4-building-resilience/index.print.html title="Print whole chapter (CTRL+ALT+p)"><i class="fa-fw fas fa-print"></i></a></div><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v5.82/en/ninja-workshops/10-advanced-otel/3-filelog/3-4-test-filelog/index.html title="3.4 Test Filelog Receiver (ðŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v5.82/en/ninja-workshops/10-advanced-otel/4-building-resilience/4-1-configuration/index.html title="4.1 File Storage Configuration (ðŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a></div><div class="topbar-button topbar-button-more" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title=More><i class="fa-fw fas fa-ellipsis-v"></i></button><div class=topbar-content><div class=topbar-content-wrapper><div class="topbar-area topbar-area-more" data-area=more></div></div></div></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable ninja-workshops" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=4-building-in-resilience>4. Building In Resilience</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<p>The OpenTelemetry Collectorâ€™s <a href=https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/19bc7d6ee854c0c1b5c97d8d348e5b9d1199e8aa/extension/storage/filestorage/README.md rel=external target=_blank><strong>FileStorage Extension</strong></a> enhances the resilience of your telemetry pipeline by providing reliable checkpointing, managing retries, and handling temporary failures effectively.</p><p>With this extension enabled, the OpenTelemetry Collector can store intermediate states on disk, preventing data loss during network disruptions and allowing it to resume operations seamlessly.</p><details open class="box cstyle notices note"><summary class=box-label><i class="fa-fw fas fa-exclamation-circle"></i>
Note</summary><div class=box-content><p>This solution will work for metrics as long as the connection downtime is briefâ€”up to 15 minutes. If the downtime exceeds this, Splunk Observability Cloud will drop data due to datapoints being out of order.</p><p>For logs, there are plans to implement a more enterprise-ready solution in one of the upcoming Splunk OpenTelemetry Collector releases.</p></div></details><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><ul><li>Inside the <code>[WORKSHOP]</code> directory, create a new subdirectory named <code>4-resilience</code>.</li><li>Next, copy all contents from the <code>3-filelog</code> directory into <code>4-resilience</code>.</li><li>After copying, remove any <code>*.out</code> and <code>*.log</code> files.</li><li>Change <strong>all</strong> terminal windows to the <code>[WORKSHOP]/4-reslilience</code> directory.</li></ul><p>Your updated directory structure will now look like this:</p><div class=tab-panel data-tab-group=96e01aab564173f0becd25b801b143cd><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=updated-directory-structure class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("96e01aab564173f0becd25b801b143cd","updated-directory-structure")'>
<span class=tab-nav-text>Updated Directory Structure</span></button></div><div class=tab-content-container><div data-tab-item=updated-directory-structure class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>WORKSHOP
</span></span><span class=line><span class=cl>â”œâ”€â”€ 1-agent
</span></span><span class=line><span class=cl>â”œâ”€â”€ 2-gateway
</span></span><span class=line><span class=cl>â”œâ”€â”€ 3-filelog
</span></span><span class=line><span class=cl>â”œâ”€â”€ 4-resilience
</span></span><span class=line><span class=cl>â”‚Â Â  â”œâ”€â”€ agent.yaml
</span></span><span class=line><span class=cl>â”‚Â Â  â”œâ”€â”€ gateway.yaml
</span></span><span class=line><span class=cl>â”‚Â Â  â”œâ”€â”€ log-gen.sh (or .ps1)
</span></span><span class=line><span class=cl>â”‚Â Â  â””â”€â”€ trace.json
</span></span><span class=line><span class=cl>â””â”€â”€ otelcol</span></span></code></pre></div></div></div></div></div></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Feb 7, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 4. Building Resilience</h1><article class=default><header class=headline></header><h1 id=41-file-storage-configuration>4.1 File Storage Configuration</h1><p>In this exercise, we will update the <code>extensions:</code> section of the <code>agent.yaml</code> file. This section is part of the OpenTelemetry configuration YAML and defines optional components that enhance or modify the OpenTelemetry Collectorâ€™s behavior.</p><p>While these components do not process telemetry data directly, they provide valuable capabilities and services to improve the Collectorâ€™s functionality.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p><strong>Update the <code>agent.yaml</code></strong>: Add the <code>file_storage</code> extension and name it <code>checkpoint</code>:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>file_storage/checkpoint</span><span class=p>:</span><span class=w>         </span><span class=c># Extension Type/Name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>directory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;./checkpoint-dir&#34;</span><span class=w>  </span><span class=c># Define directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>create_directory</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>         </span><span class=c># Create directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=l>1s                   </span><span class=w> </span><span class=c># Timeout for file operations</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>compaction</span><span class=p>:</span><span class=w>                    </span><span class=c># Compaction settings</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>on_start</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>               </span><span class=c># Start compaction at Collector startup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Define compaction directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>directory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;./checkpoint-dir/tmp&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Max. size limit before compaction occurs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>max_transaction_size</span><span class=p>:</span><span class=w> </span><span class=m>65536</span></span></span></code></pre></div><p><strong>Add <code>file_storage</code> to existing <code>otlphttp</code> exporter</strong>: Modify the <code>otlphttp:</code> exporter to configure retry and queuing mechanisms, ensuring data is retained and resent if failures occur:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>otlphttp</span><span class=p>:</span><span class=w>                       </span><span class=c># Exporter Type</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;http://localhost:5318&#34;</span><span class=w> </span><span class=c># Gateway OTLP endpoint</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>headers</span><span class=p>:</span><span class=w>                      </span><span class=c># Headers to add to the HTTPcall </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>X-SF-Token</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;ACCESS_TOKEN&#34;</span><span class=w>  </span><span class=c># Splunk ACCESS_TOKEN header</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>retry_on_failure</span><span class=p>:</span><span class=w>             </span><span class=c># Retry on failure settings</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>               </span><span class=c># Enables retrying</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>sending_queue</span><span class=p>:</span><span class=w>                </span><span class=c># Sending queue settings</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>               </span><span class=c># Enables Sending queue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>num_consumers</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>           </span><span class=c># Number of consumers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>queue_size</span><span class=p>:</span><span class=w> </span><span class=m>10000</span><span class=w>           </span><span class=c># Maximum queue size</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># File storage extension</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>file_storage/checkpoint</span></span></span></code></pre></div><p><strong>Update the <code>services</code> section</strong>: Add the <code>file_storage/checkpoint</code> extension to the existing <code>extensions:</code> section. This will cause the extension to be enabled:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>health_check</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>file_storage/checkpoint      </span><span class=w> </span><span class=c># Enabled extensions for this collector</span></span></span></code></pre></div><p><strong>Update the <code>metrics</code> pipeline</strong>: For this exercise we are going to remove the <code>hostmetrics</code> receiver from the Metric pipeline to reduce debug and log noise:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>receivers</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>otlp                       </span><span class=w> </span><span class=c># OTLP Receiver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># - hostmetrics               # Hostmetrics Receiver</span></span></span></code></pre></div></div></details><p>Validate the agent configuration using <strong><a href=https://www.otelbin.io/ rel=external target=_blank>otelbin.io</a></strong>. For reference, the <code>logs:</code> section of your pipelines will look similar to this:</p><pre class="mermaid align-center">%%{init:{&#34;fontFamily&#34;:&#34;monospace&#34;}}%%
graph LR
    %% Nodes
      REC1(&amp;nbsp;&amp;nbsp;otlp&amp;nbsp;&amp;nbsp;&lt;br&gt;fa:fa-download):::receiver
      PRO1(memory_limiter&lt;br&gt;fa:fa-microchip):::processor
      PRO2(resourcedetection&lt;br&gt;fa:fa-microchip):::processor
      PRO3(resource&lt;br&gt;fa:fa-microchip):::processor
      PRO4(batch&lt;br&gt;fa:fa-microchip):::processor
      EXP1(&amp;ensp;debug&amp;ensp;&lt;br&gt;fa:fa-upload):::exporter
      EXP2(otlphttp&lt;br&gt;fa:fa-upload):::exporter
    %% Links
    subID1:::sub-logs
    subgraph &#34; &#34;
      subgraph subID1[**Logs**]
      direction LR
      REC1 --&gt; PRO1
      PRO1 --&gt; PRO2
      PRO2 --&gt; PRO3
      PRO3 --&gt; PRO4
      PRO4 --&gt; EXP1
      PRO4 --&gt; EXP2
      end
    end
classDef receiver,exporter fill:#8b5cf6,stroke:#333,stroke-width:1px,color:#fff;
classDef processor fill:#6366f1,stroke:#333,stroke-width:1px,color:#fff;
classDef con-receive,con-export fill:#45c175,stroke:#333,stroke-width:1px,color:#fff;
classDef sub-logs stroke:#34d399,stroke-width:1px, color:#34d399,stroke-dasharray: 3 3;</pre><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Feb 7, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=42-setup-environment-for-resilience-testing>4.2 Setup environment for Resilience Testing</h1><p>Next, we will configure our environment to be ready for testing the <strong>File Storage</strong> configuration.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p><strong>Start the Gateway</strong>: In the <strong>Gateway</strong> terminal window navigate to the <code>[WORKSHOP]/4-resilience</code> directory and run:</p><div class=tab-panel data-tab-group=d54a53e7b7eff30db1e30aae9e46e061><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=gateway class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d54a53e7b7eff30db1e30aae9e46e061","gateway")'>
<span class=tab-nav-text>Gateway</span></button></div><div class=tab-content-container><div data-tab-item=gateway class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>../otelcol --config<span class=o>=</span>gateway.yaml</span></span></code></pre></div></div></div></div></div><p><strong>Start the Agent</strong>: In the <strong>Agent</strong> terminal window navigate to the <code>[WORKSHOP]/4-resilience</code> directory and run:</p><div class=tab-panel data-tab-group=311fc8fd3228982beb380889db6e1f22><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=agent class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("311fc8fd3228982beb380889db6e1f22","agent")'>
<span class=tab-nav-text>Agent</span></button></div><div class=tab-content-container><div data-tab-item=agent class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>../otelcol --config<span class=o>=</span>agent.yaml</span></span></code></pre></div></div></div></div></div><p><strong>Send a test trace</strong>: In the <strong>Test</strong> terminal window navigate to the <code>[WORKSHOP]/4-resilience</code> directory and run:</p><div class=tab-panel data-tab-group=007dd8f1789cbf71ede453a744a0e5ec><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=curl-command class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("007dd8f1789cbf71ede453a744a0e5ec","curl-command")'>
<span class=tab-nav-text>cURL command</span></button></div><div class=tab-content-container><div data-tab-item=curl-command class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>curl -X POST -i http://localhost:4318/v1/traces -H <span class=s2>&#34;Content-Type: application/json&#34;</span> -d <span class=s2>&#34;@trace.json&#34;</span></span></span></code></pre></div></div></div></div></div><p>Both the <strong>Agent</strong> and <strong>Gateway</strong> should display debug logs, and the <strong>Gateway</strong> should create a <code>./gateway-traces.out</code> file.</p></div></details><p>If everything functions correctly, we can proceed with testing system resilience.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Feb 7, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=43-simulate-failure>4.3 Simulate Failure</h1><p>To assess the <strong>Agent&rsquo;s</strong> resilience, we&rsquo;ll simulate a temporary <strong>Gateway</strong> outage and observe how the <strong>Agent</strong> handles it:</p><p><strong>Summary</strong>:</p><ol><li><strong>Send Traces to the Agent</strong> â€“ Generate traffic by sending traces to the <strong>Agent</strong>.</li><li><strong>Stop the Gateway</strong> â€“ This will trigger the <strong>Agent</strong> to enter retry mode.</li><li><strong>Restart the Gateway</strong> â€“ The <strong>Agent</strong> will recover traces from its persistent queue and forward them successfully. Without the persistent queue, these traces would have been lost permanently.</li></ol><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p><strong>Simulate a network failure</strong>: In the <strong>Gateway</strong> terminal stop the <strong>Gateway</strong> with <code>Ctrl-C</code> and wait until the gateway console shows that it has stopped:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>2025-01-28T13:24:32.785+0100  info  service@v0.116.0/service.go:309  Shutdown complete.</span></span></code></pre></div><p><strong>Send traces</strong>: In the <strong>Test</strong> terminal window send two traces using the <code>curl</code> command we used earlier.</p><p>Notice that the agentâ€™s retry mechanism is activated as it continuously attempts to resend the data. In the agentâ€™s console output, you will see repeated messages similar to the following:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>2025-01-28T14:22:47.020+0100  info  internal/retry_sender.go:126  Exporting failed. Will retry the request after interval.  {&#34;kind&#34;: &#34;exporter&#34;, &#34;data_type&#34;: &#34;traces&#34;, &#34;name&#34;: &#34;otlphttp&#34;, &#34;error&#34;: &#34;failed to make an HTTP request: Post \&#34;http://localhost:5318/v1/traces\&#34;: dial tcp 127.0.0.1:5318: connect: connection refused&#34;, &#34;interval&#34;: &#34;9.471474933s&#34;}</span></span></code></pre></div><p><strong>Stop the Agent</strong>: Use <code>Ctrl-C</code> to stop the agent. Wait until the agentâ€™s console confirms it has stopped:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>2025-01-28T14:40:28.702+0100  info  extensions/extensions.go:66  Stopping extensions...
</span></span><span class=line><span class=cl>2025-01-28T14:40:28.702+0100  info  service@v0.116.0/service.go:309  Shutdown complete.</span></span></code></pre></div></div></details><details open class="box cstyle notices primary"><summary class=box-label><i class="fa-fw fas fa-lightbulb"></i>
Tip</summary><div class=box-content><p>Stopping the agent will halt its retry attempts and prevent any future retry activity.</p><p>If the agent runs for too long without successfully delivering data, it may begin dropping traces, depending on the retry configuration, to conserve memory. By stopping the agent, any metrics, traces, or logs currently stored in memory are lost before being dropped, ensuring they remain available for recovery.</p><p>This step is essential for clearly observing the recovery process when the agent is restarted.</p></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Feb 7, 2025</span></span></footer></article><article class=default><header class=headline></header><h1 id=44-simulate-recovery>4.4 Simulate Recovery</h1><p>In this exercise, weâ€™ll test how the <strong>OpenTelemetry Collector</strong> recovers from a network outage by restarting the <strong>Gateway</strong>. When the <strong>Gateway</strong> becomes available again, the <strong>Agent</strong> will resume sending data from its last checkpointed state, ensuring no data loss.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p><strong>Restart the Gateway</strong>: In the <strong>Gateway</strong> terminal window run:</p><div class=tab-panel data-tab-group=75f9a5650cec65ad040b870d64f363fc><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=gateway class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("75f9a5650cec65ad040b870d64f363fc","gateway")'>
<span class=tab-nav-text>Gateway</span></button></div><div class=tab-content-container><div data-tab-item=gateway class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>../otelcol --config<span class=o>=</span>gateway.yaml</span></span></code></pre></div></div></div></div></div><p><strong>Restart the Agent</strong>: In the <strong>Agent</strong> terminal window run:</p><div class=tab-panel data-tab-group=b3ae5d714fb7273e670993ac2d5127fc><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=agent class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b3ae5d714fb7273e670993ac2d5127fc","agent")'>
<span class=tab-nav-text>Agent</span></button></div><div class=tab-content-container><div data-tab-item=agent class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>../otelcol --config<span class=o>=</span>agent.yaml</span></span></code></pre></div></div></div></div></div></div></details><p>After the <strong>Agent</strong> is up and running, the <strong>File_Storage</strong> extension will detect buffered data in the checkpoint folder.<br>It will start to dequeue the stored spans from the last checkpoint folder, ensuring no data is lost.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p><strong>Verify the Agent Debug output</strong><br>Note that the Agent Debug Screen does <strong>NOT</strong> change and still shows the following line indicating no new data is being exported.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>2025-02-07T13:40:12.195+0100    info    service@v0.117.0/service.go:253 Everything is ready. Begin running and processing data.</span></span></code></pre></div><p><strong>Watch the Gateway Debug output</strong><br>You should see from the <strong>Gateway</strong> debug screen, it has started receiving the previously missed traces without requiring any additional action on your part.</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>2025-02-07T12:44:32.651+0100    info    service@v0.117.0/service.go:253 Everything is ready. Begin running and processing data.
</span></span><span class=line><span class=cl>2025-02-07T12:47:46.721+0100    info    Traces  {&#34;kind&#34;: &#34;exporter&#34;, &#34;data_type&#34;: &#34;traces&#34;, &#34;name&#34;: &#34;debug&#34;, &#34;resource spans&#34;: 4, &#34;spans&#34;: 4}
</span></span><span class=line><span class=cl>2025-02-07T12:47:46.721+0100    info    ResourceSpans #0
</span></span><span class=line><span class=cl>Resource SchemaURL: https://opentelemetry.io/schemas/1.6.1
</span></span><span class=line><span class=cl>Resource attributes:</span></span></code></pre></div><p><strong>Check the <code>gateway-traces.out</code> file</strong><br>Count the number of traces in the recreated <code>./gateway-traces.out</code>. It should match the number you send when the <strong>Gateway</strong> was down</p></div></details><h3 id=conclusion>Conclusion</h3><p>This exercise demonstrated how to enhance the resilience of the OpenTelemetry Collector by configuring the <code>file_storage</code> extension, enabling retry mechanisms for the <code>otlp</code> exporter, and using a file-backed queue for temporary data storage.</p><p>By implementing file-based checkpointing and queue persistence, you ensure the telemetry pipeline can gracefully recover from temporary interruptions, making it a more robust and reliable for production environments.</p><p>Stop the <strong>Agent</strong> and <strong>Gateway</strong> using <code>Ctrl-C</code>.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Feb 8, 2025</span></span></footer></article></section></div></main></div><script src=/observability-workshop/v5.82/js/clipboard.min.js?1740086388 defer></script><script src=/observability-workshop/v5.82/js/perfect-scrollbar.min.js?1740086388 defer></script><script src=/observability-workshop/v5.82/js/d3/d3-color.min.js?1740086388 defer></script><script src=/observability-workshop/v5.82/js/d3/d3-dispatch.min.js?1740086388 defer></script><script src=/observability-workshop/v5.82/js/d3/d3-drag.min.js?1740086388 defer></script><script src=/observability-workshop/v5.82/js/d3/d3-ease.min.js?1740086388 defer></script><script src=/observability-workshop/v5.82/js/d3/d3-interpolate.min.js?1740086388 defer></script><script src=/observability-workshop/v5.82/js/d3/d3-selection.min.js?1740086388 defer></script><script src=/observability-workshop/v5.82/js/d3/d3-timer.min.js?1740086388 defer></script><script src=/observability-workshop/v5.82/js/d3/d3-transition.min.js?1740086388 defer></script><script src=/observability-workshop/v5.82/js/d3/d3-zoom.min.js?1740086388 defer></script><script src=/observability-workshop/v5.82/js/js-yaml.min.js?1740086388 defer></script><script src=/observability-workshop/v5.82/js/mermaid.min.js?1740086388 defer></script><script>window.themeUseMermaid=JSON.parse("{}")</script><script src=/observability-workshop/v5.82/js/theme.js?1740086388 defer></script></body></html>