<!doctype html><html lang=ja dir=ltr itemscope itemtype=http://schema.org/Article data-r-output-format=print><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.145.0"><meta name=generator content="Relearn 8.0.0+97777ec5111409397e83f44eca496eea97697836"><meta name=description content="このワークショップでは、AWS Lambdaで実行される小規模なサーバーレスアプリケーションの分散トレースを構築し、AWS Kinesisを介してメッセージをproduceおよびconsumeする方法を学びます"><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="AWS Lambda関数の分散トレーシング :: Splunk Observability Cloud Workshops"><meta name=twitter:description content="このワークショップでは、AWS Lambdaで実行される小規模なサーバーレスアプリケーションの分散トレースを構築し、AWS Kinesisを介してメッセージをproduceおよびconsumeする方法を学びます"><meta property="og:url" content="https://splunk.github.io/observability-workshop/v6.8/ja/ninja-workshops/6-lambda-kinesis/index.html"><meta property="og:site_name" content="Splunk Observability Cloud Workshops"><meta property="og:title" content="AWS Lambda関数の分散トレーシング :: Splunk Observability Cloud Workshops"><meta property="og:description" content="このワークショップでは、AWS Lambdaで実行される小規模なサーバーレスアプリケーションの分散トレースを構築し、AWS Kinesisを介してメッセージをproduceおよびconsumeする方法を学びます"><meta property="og:locale" content="ja"><meta property="og:type" content="website"><meta itemprop=name content="AWS Lambda関数の分散トレーシング :: Splunk Observability Cloud Workshops"><meta itemprop=description content="このワークショップでは、AWS Lambdaで実行される小規模なサーバーレスアプリケーションの分散トレースを構築し、AWS Kinesisを介してメッセージをproduceおよびconsumeする方法を学びます"><meta itemprop=dateModified content="2025-05-29T14:36:03+09:00"><meta itemprop=wordCount content="21"><title>AWS Lambda関数の分散トレーシング :: Splunk Observability Cloud Workshops</title>
<link href=https://splunk.github.io/observability-workshop/v6.8/en/ninja-workshops/6-lambda-kinesis/index.html rel=alternate hreflang=x-default><link href=https://splunk.github.io/observability-workshop/v6.8/en/ninja-workshops/6-lambda-kinesis/index.html rel=alternate hreflang=en><link href=https://splunk.github.io/observability-workshop/v6.8/ja/ninja-workshops/6-lambda-kinesis/index.html rel=alternate hreflang=ja><link href=https://splunk.github.io/observability-workshop/v6.8/ja/ninja-workshops/6-lambda-kinesis/index.html rel=canonical type=text/html title="AWS Lambda関数の分散トレーシング :: Splunk Observability Cloud Workshops"><link href=/observability-workshop/v6.8/images/favicon.ico?1759784486 rel=icon type=image/x-icon sizes=any><link href=/observability-workshop/v6.8/css/auto-complete/auto-complete.min.css?1759784486 rel=stylesheet><script src=/observability-workshop/v6.8/js/auto-complete/auto-complete.min.js?1759784486 defer></script><script src=/observability-workshop/v6.8/js/search-lunr.min.js?1759784486 defer></script><script src=/observability-workshop/v6.8/js/search.min.js?1759784486 defer></script><script>window.relearn=window.relearn||{},window.relearn.index_js_url="/observability-workshop/v6.8/searchindex.ja.js?1759784486"</script><script src=/observability-workshop/v6.8/js/lunr/lunr.min.js?1759784486 defer></script><script src=/observability-workshop/v6.8/js/lunr/lunr.stemmer.support.min.js?1759784486 defer></script><script src=/observability-workshop/v6.8/js/lunr/lunr.multi.min.js?1759784486 defer></script><script src=/observability-workshop/v6.8/js/lunr/tinyseg.js?1759784486 defer></script><script src=/observability-workshop/v6.8/js/lunr/lunr.ja.min.js?1759784486 defer></script><script>window.relearn=window.relearn||{},window.relearn.contentLangs=["ja"]</script><link href=/observability-workshop/v6.8/fonts/fontawesome/css/fontawesome-all.min.css?1759784486 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v6.8/fonts/fontawesome/css/fontawesome-all.min.css?1759784486 rel=stylesheet></noscript><link href=/observability-workshop/v6.8/css/perfect-scrollbar/perfect-scrollbar.min.css?1759784486 rel=stylesheet><link href=/observability-workshop/v6.8/css/theme.min.css?1759784486 rel=stylesheet><link href=/observability-workshop/v6.8/css/format-print.min.css?1759784486 rel=stylesheet id=R-format-style><script>window.relearn=window.relearn||{},window.relearn.min=`.min`,window.relearn.path="/ninja-workshops/6-lambda-kinesis/index.html",window.relearn.relBasePath="../../..",window.relearn.relBaseUri="../../../../..",window.relearn.absBaseUri="https://splunk.github.io/observability-workshop/v6.8",window.relearn.disableAnchorCopy=!1,window.relearn.disableAnchorScrolling=!1,window.relearn.disableInlineCopyToClipboard=!0,window.relearn.enableBlockCodeWrap=!0,window.relearn.getItem=(e,t)=>e.getItem(t),window.relearn.setItem=(e,t,n)=>e.setItem(t,n),window.relearn.removeItem=(e,t)=>e.removeItem(t),window.T_Copy_to_clipboard=`クリップボードにコピー`,window.T_Copied_to_clipboard=`クリップボードにコピー!`,window.T_Copy_link_to_clipboard=`リンクをクリップボードにコピー`,window.T_Link_copied_to_clipboard=`リンクをクリップボードにコピーしました!`,window.T_Reset_view=`ビューのリセット`,window.T_View_reset=`リセットを見る`,window.T_No_results_found=`"{0}" の結果が見つかりません`,window.T_N_results_found=`"{0}" で {1} 件の結果が見つかりました`,window.relearn.themevariants=["auto","splunk-light","splunk-dark"],window.relearn.customvariantname="my-custom-variant",window.relearn.changeVariant=function(e){var t=document.documentElement.dataset.rThemeVariant;window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e),document.documentElement.dataset.rThemeVariant=e,t!=e&&(document.dispatchEvent(new CustomEvent("themeVariantLoaded",{detail:{variant:e,oldVariant:t}})),window.relearn.markVariant())},window.relearn.markVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant");document.querySelectorAll(".R-variantswitcher select").forEach(t=>{t.value=e})},window.relearn.initVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant")??"";e==window.relearn.customvariantname||(!e||!window.relearn.themevariants.includes(e))&&(e=window.relearn.themevariants[0],window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e)),document.documentElement.dataset.rThemeVariant=e},window.relearn.initVariant(),window.relearn.markVariant()</script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js crossorigin=anonymous></script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web-session-recorder.js crossorigin=anonymous></script><script>SplunkRum.init({realm:"us1",rumAccessToken:"h7q1NLX6lJz0h_5-OqQJkg",applicationName:"observability-workshop",deploymentEnvironment:"splunk.github.io",version:"1.0"}),SplunkSessionRecorder.init({appplicationName:"observability-workshop",realm:"us1",rumAccessToken:"h7q1NLX6lJz0h_5-OqQJkg",recorder:"splunk",features:{video:!0}})</script></script><style>:root{--MAIN-WIDTH-MAX:130rem;--MENU-WIDTH-L:23rem}p{margin:.75rem 0}.highlight{max-height:500px;overflow-y:auto}pre:not(.mermaid){margin:0}</style></head><body class="mobile-support print" data-url=/observability-workshop/v6.8/ja/ninja-workshops/6-lambda-kinesis/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="メニュー (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div><div class="topbar-button topbar-button-toc" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title="目次 (CTRL+ALT+t)"><i class="fa-fw fas fa-list-alt"></i></button><div class=topbar-content><div class=topbar-content-wrapper></div></div></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v6.8/ja/index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v6.8/ja/ninja-workshops/index.html><span itemprop=name>Splunk4Ninjas Workshops</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Lambdaトレーシング</span><meta itemprop=position content="3"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-print" data-content-empty=disable data-width-s=area-more data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v6.8/ja/ninja-workshops/6-lambda-kinesis/index.print.html title="章全体を印刷する (CTRL+ALT+p)"><i class="fa-fw fas fa-print"></i></a></div><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v6.8/ja/ninja-workshops/index.html title="Splunk4Ninjas Workshops (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v6.8/ja/ninja-workshops/6-lambda-kinesis/1-setup/index.html title="セットアップ (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a></div><div class="topbar-button topbar-button-more" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title=更に><i class="fa-fw fas fa-ellipsis-v"></i></button><div class=topbar-content><div class=topbar-content-wrapper><div class="topbar-area topbar-area-more" data-area=more></div></div></div></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable ninja-workshops" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=aws-lambda関数の分散トレーシング>AWS Lambda関数の分散トレーシング</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>45 minutes</span>
</span>&nbsp;
<span class="badge cstyle blue badge-with-title"><span class=badge-title class=text-muted>Author
</span><span class=badge-content>Guy-Francis Kono</span></span><p>このワークショップでは、AWS Lambda で実行される小規模なサーバーレスアプリケーションの分散トレースを構築し、AWS Kinesis を介してメッセージを produce および consume する方法を学びます。</p><p>まず、OpenTelemetry の自動計装がどのようにトレースをキャプチャし、選択した宛先にエクスポートするかを確認します。</p><p>次に、手動計装によってコンテキスト伝播を有効にする方法を見ていきます。</p><p>このワークショップのために、Splunk は AWS/EC2 上の Ubuntu Linux インスタンスを事前に構成しています。このインスタンスにアクセスするには、ワークショップインストラクターが提供する URL にアクセスしてください。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/05/29</span></span></footer></article><section><h1 class=a11y-only>Lambdaトレーシングのサブセクション</h1><article class=default><header class=headline></header><h1 id=セットアップ>セットアップ</h1><p><a href=#R-image-30dbe9816e2d912d0a2fd5b62fe95687 class=lightbox-link><img alt=手動計装されていないLambdaアプリケーション class="lazy lightbox figure-image" loading=lazy src=../images/01-Architecture.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-30dbe9816e2d912d0a2fd5b62fe95687><img alt=手動計装されていないLambdaアプリケーション class="lazy lightbox lightbox-image" loading=lazy src=../images/01-Architecture.png></a></p><h2 id=前提条件>前提条件</h2><h3 id=observability-ワークショップインスタンス>Observability ワークショップインスタンス</h3><p>Observability ワークショップは、多くの場合、Splunk が提供する事前設定済みの Ubuntu EC2 インスタンス上で実施されます。</p><p>ワークショップのインストラクターから、割り当てられたワークショップインスタンスの認証情報が提供されます。</p><p>インスタンスには以下の環境変数が既に設定されているはずです：</p><ul><li><strong>ACCESS_TOKEN</strong></li><li><strong>REALM</strong><ul><li><em>これらはワークショップ用の Splunk Observability Cloud の <strong>Access Token</strong> と <strong>Realm</strong> です。</em></li><li><em>これらは OpenTelemetry Collector によって、データを正しい Splunk Observability Cloud 組織に転送するために使用されます。</em></li></ul></li></ul><details open class="box cstyle notices note"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-exclamation-circle"></i><br></summary><div class=box-content><p><em>また、Multipass を使用してローカルの Observability ワークショップインスタンスをデプロイすることもできます。</em></p></div></details><h3 id=aws-command-line-interface-awscli>AWS Command Line Interface (awscli)</h3><p>AWS Command Line Interface、または<code>awscli</code>は、AWS リソースと対話するために使用される API です。このワークショップでは、特定のスクリプトがデプロイするリソースと対話するために使用されます。</p><p>Splunk が提供するワークショップインスタンスには、既に <strong>awscli</strong> がインストールされているはずです。</p><ul><li><p>インスタンスに <strong>aws</strong> コマンドがインストールされているか、次のコマンドで確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>which aws</span></span></code></pre></div><ul><li><em>予想される出力は <strong>/usr/local/bin/aws</strong> です</em></li></ul></li><li><p>インスタンスに <strong>aws</strong> コマンドがインストールされていない場合は、次のコマンドを実行します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt install awscli</span></span></code></pre></div></li></ul><h3 id=terraform>Terraform</h3><p>Terraform は、リソースを構成ファイルで定義することで、デプロイ、管理、破棄するための Infrastructure as Code（IaC）プラットフォームです。Terraform は HCL を使用してこれらのリソースを定義し、さまざまなプラットフォームやテクノロジのための複数のプロバイダーをサポートしています。</p><p>このワークショップでは、コマンドラインで Terraform を使用して、以下のリソースをデプロイします：</p><ol><li>AWS API Gateway</li><li>Lambda 関数</li><li>Kinesis Stream</li><li>CloudWatch ロググループ</li><li>S3 バケット<ul><li><em>およびその他のサポートリソース</em></li></ul></li></ol><p>Splunk が提供するワークショップインスタンスには、既に <strong>terraform</strong> がインストールされているはずです。</p><ul><li><p>インスタンスに <strong>terraform</strong> コマンドがインストールされているか確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>which terraform</span></span></code></pre></div><ul><li><em>予想される出力は <strong>/usr/local/bin/terraform</strong> です</em></li></ul></li><li><p>インスタンスに <strong>terraform</strong> コマンドがインストールされていない場合は、以下の Terraform が推奨するインストールコマンドを実行してください：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget -O- https://apt.releases.hashicorp.com/gpg <span class=p>|</span> sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com </span><span class=k>$(</span>lsb_release -cs<span class=k>)</span><span class=s2> main&#34;</span> <span class=p>|</span> sudo tee /etc/apt/sources.list.d/hashicorp.list
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sudo apt update <span class=o>&amp;&amp;</span> sudo apt install terraform</span></span></code></pre></div></li></ul><h3 id=ワークショップディレクトリ-o11y-lambda-workshop>ワークショップディレクトリ (o11y-lambda-workshop)</h3><p>ワークショップディレクトリ <code>o11y-lambda-workshop</code> は、今日使用する例の Lambda ベースのアプリケーションの自動計装と手動計装の両方を完了するための、すべての設定ファイルとスクリプトを含むリポジトリです。</p><ul><li><p>ホームディレクトリにワークショップディレクトリがあることを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> <span class=o>&amp;&amp;</span> ls</span></span></code></pre></div><ul><li><em>予想される出力には <strong>o11y-lambda-workshop</strong> が含まれるはずです</em></li></ul></li><li><p><strong>o11y-lambda-workshop</strong> ディレクトリがホームディレクトリにない場合は、次のコマンドでクローンします：</p></li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone https://github.com/gkono-splunk/o11y-lambda-workshop.git</span></span></code></pre></div><h3 id=aws--terraform-変数>AWS & Terraform 変数</h3><h4 id=aws>AWS</h4><p>AWS の CLI では、サービスによってデプロイされたリソースにアクセスし管理するための認証情報が必要です。このワークショップでは、Terraform と Python スクリプトの両方がタスクを実行するためにこれらの変数を必要とします。</p><ul><li><p>このワークショップのために <strong>awscli</strong> を <em><strong>access key ID</strong></em>、<em><strong>secret access key</strong></em> および <em><strong>region</strong></em> で構成します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws configure</span></span></code></pre></div><ul><li><p><em>このコマンドは以下のようなプロンプトを表示するはずです：</em></p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>AWS Access Key ID <span class=o>[</span>None<span class=o>]</span>: XXXXXXXXXXXXXXXX
</span></span><span class=line><span class=cl>AWS Secret Acces Key <span class=o>[</span>None<span class=o>]</span>: XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
</span></span><span class=line><span class=cl>Default region name <span class=o>[</span>None<span class=o>]</span>: us-east-1
</span></span><span class=line><span class=cl>Default outoput format <span class=o>[</span>None<span class=o>]</span>:</span></span></code></pre></div></li></ul></li><li><p>インスタンスで <strong>awscli</strong> が設定されていない場合は、次のコマンドを実行し、インストラクターから提供される値を入力してください。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws configure</span></span></code></pre></div></li></ul><h4 id=terraform-1>Terraform</h4><p>Terraform では、機密情報や動的データを.tf 設定ファイルにハードコーディングさせない、またはそれらの値をリソース定義全体で再利用できるようにするため、変数の受け渡しをサポートしています。</p><p>このワークショップでは、OpenTelemetry Lambda layer の適切な値で Lambda 関数をデプロイするため、Splunk Observability Cloud の取り込み値のため、そして環境とリソースを独自で即座に認識できるようにするための変数を Terraform で必要とします。</p><p>Terraform 変数(variable)は以下の方法で定義されます：</p><ul><li>変数を <em><strong>main.tf</strong></em> ファイルまたは <em><strong>variables.tf</strong></em> に定義する</li><li>以下のいずれかの方法で変数の値を設定する：<ul><li>ホストレベルで環境変数を設定し、その定義と同じ変数名を使用して、接頭辞として <em><strong>TF_VAR</strong></em> をつける</li><li><em><strong>terraform.tfvars</strong></em> ファイルに変数の値を設定する</li><li>terraform apply 実行時に引数として値を渡す</li></ul></li></ul><p>このワークショップでは、<em><strong>variables.tf</strong></em> と <em><strong>terraform.tfvars</strong></em> ファイルの組み合わせを使用して変数を設定します。</p><ul><li><p><strong>vi</strong> または <strong>nano</strong> のいずれかを使用して、<strong>auto</strong> または <strong>manual</strong> ディレクトリにある <em><strong>terraform.tfvars</strong></em> ファイルを開きます</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi ~/o11y-lambda-workshop/auto/terraform.tfvars</span></span></code></pre></div></li><li><p>変数に値を設定します。<strong>CHANGEME</strong> プレースホルダーをインストラクターから提供された値に置き換えてください。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>o11y_access_token</span> <span class=o>=</span> <span class=s2>&#34;CHANGEME&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>o11y_realm</span>        <span class=o>=</span> <span class=s2>&#34;CHANGEME&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>otel_lambda_layer</span> <span class=o>=</span> <span class=o>[</span><span class=s2>&#34;CHANGEME&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>prefix</span>            <span class=o>=</span> <span class=s2>&#34;CHANGEME&#34;</span></span></span></code></pre></div><ul><li><em>引用符（"）や括弧 ( [ ] ) はそのまま残し、プレースホルダー<code>CHANGEME</code>のみを変更してください。</em></li><li><em><strong>prefix</strong></em> は、他の参加者のリソースと区別するため、任意の文字列で設定する固有の識別子です。氏名やメールアドレスのエイリアスを使用することをお勧めします。</li><li><em><strong>prefix</strong> には小文字のみを使用してください。S3 のような特定の AWS リソースでは、大文字を使用するとエラーが発生します。</em></li></ul></li><li><p>ファイルを保存してエディタを終了します。</p></li><li><p>最後に、編集した <em><strong>terraform.tfvars</strong></em> ファイルを他のディレクトリにコピーします。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cp ~/o11y-lambda-workshop/auto/terraform.tfvars ~/o11y-lambda-workshop/manual</span></span></code></pre></div><ul><li><em>これは、自動計装と手動計装の両方の部分で同じ値を使用するためです</em></li></ul></li></ul><h3 id=ファイル権限>ファイル権限</h3><p>他のすべてのファイルはそのままでよいですが、<code>auto</code>と<code>manual</code>の両方にある<strong>send_message.py</strong>スクリプトは、ワークショップの一部として実行する必要があります。そのため、期待通りに実行するには、適切な権限が必要です。以下の手順に従って設定してください。</p><ul><li><p>まず、<code>o11y-lambda-workshop</code>ディレクトリにいることを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop</span></span></code></pre></div></li><li><p>次に、以下のコマンドを実行して<code>send_message.py</code>スクリプトに実行権限を設定します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo chmod <span class=m>755</span> auto/send_message.py manual/send_message.py</span></span></code></pre></div></li></ul><p>これで前提条件が整いましたので、ワークショップを始めることができます！</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/05/29</span></span></footer></article><article class=default><header class=headline></header><h1 id=自動計装>自動計装</h1><p>ワークショップの最初の部分では、OpenTelemetry による自動計装がどのようにして OpenTelemetry Collector に関数がどの言語で書かれているかを自動検出させ、それらの関数のトレースの取得を開始させるかを示します。</p><h3 id=自動計装ワークショップディレクトリとコンテンツ>自動計装ワークショップディレクトリとコンテンツ</h3><p>まず、<code>o11y-lambda-workshop/auto</code>ディレクトリとそのファイルの一部を見てみましょう。ここにはワークショップの自動計装部分のすべてのコンテンツがあります。</p><h4 id=auto-ディレクトリ><code>auto</code> ディレクトリ</h4><ul><li><p>以下のコマンドを実行して <strong>o11y-lambda-workshop/auto</strong> ディレクトリに移動します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/auto</span></span></code></pre></div></li><li><p>このディレクトリの内容を確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ls</span></span></code></pre></div><ul><li><p><em>出力には以下のファイルとディレクトリが含まれるはずです：</em></p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>handler             outputs.tf          terraform.tf        variables.tf
</span></span><span class=line><span class=cl>main.tf             send_message.py     terraform.tfvars</span></span></code></pre></div></li><li><p><em>出力には以下のファイルとディレクトリが含まれるはずです：</em></p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>get_logs.py    main.tf       send_message.py
</span></span><span class=line><span class=cl>handler        outputs.tf    terraform.tf</span></span></code></pre></div></li></ul></li></ul><h4 id=maintf-ファイル><code>main.tf</code> ファイル</h4><ul><li><p><code>main.tf</code> ファイルをより詳しく見てみましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat main.tf</span></span></code></pre></div></li></ul><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
ワークショップの質問</summary><div class=box-content><ul><li>このテンプレートによってどの AWS リソースが作成されているか特定できますか？</li><li>OpenTelemetry 計装がどこでセットアップされているか特定できますか？<ul><li><em>ヒント: Lambda 関数の定義を調べてください</em></li></ul></li><li>以前に設定した環境変数によってどの計装情報が提供されているか判断できますか？</li></ul></div></details><p>各 Lambda 関数の環境変数が設定されているセクションが見つかるはずです。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>environment <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>variables</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>SPLUNK_ACCESS_TOKEN</span> <span class=o>=</span> var.o11y_access_token
</span></span><span class=line><span class=cl>    <span class=nv>SPLUNK_REALM</span> <span class=o>=</span> var.o11y_realm
</span></span><span class=line><span class=cl>    <span class=nv>OTEL_SERVICE_NAME</span> <span class=o>=</span> <span class=s2>&#34;producer-lambda&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>OTEL_RESOURCE_ATTRIBUTES</span> <span class=o>=</span> <span class=s2>&#34;deployment.environment=</span><span class=si>${</span><span class=nv>var</span><span class=p>.prefix</span><span class=si>}</span><span class=s2>-lambda-shop&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>AWS_LAMBDA_EXEC_WRAPPER</span> <span class=o>=</span> <span class=s2>&#34;/opt/nodejs-otel-handler&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>KINESIS_STREAM</span> <span class=o>=</span> aws_kinesis_stream.lambda_streamer.name
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div><p>これらの環境変数を使用することで、いくつかの方法で自動計装を構成しています：</p><ul><li><p>環境変数を設定して、データのエクスポート先となる Splunk Observability Cloud 組織を OpenTelemetry collector に伝えています。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>SPLUNK_ACCESS_TOKEN</span> <span class=o>=</span> var.o11y_access_token
</span></span><span class=line><span class=cl><span class=nv>SPLUNK_ACCESS_TOKEN</span> <span class=o>=</span> var.o11y_realm</span></span></code></pre></div></li><li><p>また、OpenTelemetry が関数/サービスを識別し、それが属する環境/アプリケーションを認識するのに役立つ変数も設定しています。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>OTEL_SERVICE_NAME</span> <span class=o>=</span> <span class=s2>&#34;producer-lambda&#34;</span> <span class=c1># consumer関数の場合はconsumer-lambda</span>
</span></span><span class=line><span class=cl><span class=nv>OTEL_RESOURCE_ATTRIBUTES</span> <span class=o>=</span> <span class=s2>&#34;deployment.environment=</span><span class=si>${</span><span class=nv>var</span><span class=p>.prefix</span><span class=si>}</span><span class=s2>-lambda-shop&#34;</span></span></span></code></pre></div></li><li><p>コード言語に基づいて、関数のハンドラーに自動的にトレースデータを取得するために適用する必要があるラッパーを OpenTelemetry に知らせる環境変数を設定しています。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>AWS_LAMBDA_EXEC_WRAPPER - <span class=s2>&#34;/opt/nodejs-otel-handler&#34;</span></span></span></code></pre></div></li><li><p><code>producer-lambda</code>関数の場合、レコードを配置する Kinesis ストリームを関数に知らせるための環境変数を設定しています。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KINESIS_STREAM</span> <span class=o>=</span> aws_kinesis_stream.lambda_streamer.name</span></span></code></pre></div></li><li><p>これらの値は、「前提条件」セクションで設定した環境変数、および、この Terraform 構成ファイルの一部としてデプロイされるリソースから取得されます。</p></li></ul><p>また、各関数に Splunk OpenTelemetry Lambda layer を設定する引数も確認できるはずです</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>layers</span> <span class=o>=</span> var.otel_lambda_layer</span></span></code></pre></div><ul><li><p>OpenTelemetry Lambda layer は、Lambda 関数の呼び出し時に計測データを収集、処理、およびエクスポートするために必要なライブラリと依存関係を含むパッケージです。</p></li><li><p>すべての OpenTelemetry サポート言語のライブラリと依存関係を持つ一般的な OTel Lambda layer がありますが、関数をさらに軽量化するための言語固有の Lambda layer も存在します。</p><ul><li><em>各 AWS リージョンの関連する Splunk OpenTelemetry Lambda layer ARN（Amazon Resource Name）と最新バージョンは<a href=https://github.com/signalfx/lambda-layer-versions/blob/main/splunk-apm/splunk-apm.md rel=external target=_blank>こちら</a>で確認できます</em></li></ul></li></ul><h4 id=producermjs-ファイル><code>producer.mjs</code> ファイル</h4><p>次に、<code>producer-lambda</code>関数のコードを見てみましょう：</p><ul><li><p>以下のコマンドを実行して<code>producer.mjs</code>ファイルの内容を表示します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/o11y-lambda-workshop/auto/handler/producer.mjs</span></span></code></pre></div><ul><li>この NodeJS モジュールにはプロデューサー関数のコードが含まれています。</li><li>基本的に、この関数はメッセージを受け取り、そのメッセージを対象の Kinesis ストリームにレコードとして配置します</li></ul></li></ul><h3 id=lambda-関数のデプロイとトレースデータの生成>Lambda 関数のデプロイとトレースデータの生成</h3><p><code>auto</code>ディレクトリの内容に慣れたところで、ワークショップ用のリソースをデプロイし、Lambda 関数からトレースデータを生成していきます。</p><h4 id=autoディレクトリで-terraform-を初期化する><code>auto</code>ディレクトリで Terraform を初期化する</h4><p><code>main.tf</code>ファイルで定義されたリソースをデプロイするには、まず Terraform がそのファイルと同じフォルダで初期化されていることを確認する必要があります。</p><ul><li><p><code>auto</code> ディレクトリにいることを確認します:</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwd</span></span></code></pre></div><ul><li><em>予想される出力は <strong>~/o11y-lambda-workshop/auto</strong> です</em></li></ul></li><li><p><code>auto</code> ディレクトリにいない場合は、次のコマンドを実行します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/auto</span></span></code></pre></div></li><li><p>次のコマンドを実行して、このディレクトリで Terraform を初期化します</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform init</span></span></code></pre></div><ul><li>このコマンドは同じフォルダにいくつかの要素を作成します：<ul><li><code>.terraform.lock.hcl</code> ファイル：リソースを提供するために使用するプロバイダーを記録します</li><li><code>.terraform</code> ディレクトリ：プロバイダーの構成を保存します</li></ul></li><li>上記のファイルに加えて、<code>apply</code> サブコマンドを使用して terraform を実行すると、デプロイされたリソースの状態を追跡するために <code>terraform.tfstate</code> ファイルが作成されます。</li><li>これらにより、Terraform は <code>auto</code> ディレクトリの <code>main.tf</code> ファイル内で定義されたとおりに、リソースの作成、状態、破棄を管理できます</li></ul></li></ul><h4 id=lambda-関数とその他の-aws-リソースをデプロイする>Lambda 関数とその他の AWS リソースをデプロイする</h4><p>このディレクトリで Terraform を初期化したら、リソースのデプロイに進むことができます。</p><ul><li><p>まず、<strong>terraform plan</strong> コマンドを実行して、Terraform が問題なくリソースを作成できることを確認します。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform plan</span></span></code></pre></div><ul><li><em>これにより、リソースをデプロイするプランといくつかのデータが出力され、意図したとおりに動作することを確認できます。</em></li><li><em>プランに表示される値の一部は、作成後に判明するか、セキュリティ上の理由でマスクされていることに注意してください。</em></li></ul></li><li><p>次に、<strong>terraform apply</strong> コマンドを実行して、<strong>main.tf</strong> ファイルから Lambda 関数とその他のサポートリソースをデプロイします：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform apply</span></span></code></pre></div><ul><li><p><em><strong>Enter a value:</strong> プロンプトが表示されたら <strong>yes</strong> と応答します</em></p></li><li><p>これにより、以下のような出力が得られます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Outputs:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>base_url</span> <span class=o>=</span> <span class=s2>&#34;https://______.amazonaws.com/serverless_stage/producer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>consumer_function_name</span> <span class=o>=</span> <span class=s2>&#34;_____-consumer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>consumer_log_group_arn</span> <span class=o>=</span> <span class=s2>&#34;arn:aws:logs:us-east-1:############:log-group:/aws/lambda/______-consumer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>consumer_log_group_name</span> <span class=o>=</span> <span class=s2>&#34;/aws/lambda/______-consumer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>environment</span> <span class=o>=</span> <span class=s2>&#34;______-lambda-shop&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>lambda_bucket_name</span> <span class=o>=</span> <span class=s2>&#34;lambda-shop-______-______&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>producer_function_name</span> <span class=o>=</span> <span class=s2>&#34;______-producer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>producer_log_group_arn</span> <span class=o>=</span> <span class=s2>&#34;arn:aws:logs:us-east-1:############:log-group:/aws/lambda/______-producer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>producer_log_group_name</span> <span class=o>=</span> <span class=s2>&#34;/aws/lambda/______-producer&#34;</span></span></span></code></pre></div><ul><li><em>Terraform 出力は <strong>outputs.tf</strong> ファイルで定義されています。</em></li><li><em>これらの出力は、ワークショップの他の部分でもプログラム的に使用されます。</em></li></ul></li></ul></li></ul><h4 id=producer-lambda-url-base_url-にトラフィックを送信する><code>producer-lambda</code> URL (<code>base_url</code>) にトラフィックを送信する</h4><p>デプロイした Lambda 関数からトレースを取得し始めるには、トラフィックを生成する必要があります。<code>producer-lambda</code>関数のエンドポイントにメッセージを送信し、それを Kinesis ストリームにレコードとして配置し、その後<code>consumer-lambda</code>関数によってストリームから取得されるようにします。</p><ul><li><p><code>auto</code> ディレクトリにいることを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwd</span></span></code></pre></div><ul><li><em>予想される出力は <strong>~/o11y-lambda-workshop/auto</strong> です</em></li></ul></li><li><p><code>auto</code> ディレクトリにいない場合は、次のコマンドを実行します</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/auto</span></span></code></pre></div></li></ul><p><code>send_message.py</code> スクリプトは、コマンドラインで入力を受け取り、JSON ディクショナリに追加し、while ループの一部として <code>producer-lambda</code> 関数のエンドポイントに繰り返し送信する Python スクリプトです。</p><ul><li><p>Run the <code>send_message.py</code> script as a background process</p><ul><li><em><code>--name</code> と <code>--superpower</code> 引数が必要です</em></li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nohup ./send_message.py --name CHANGEME --superpower CHANGEME <span class=p>&amp;</span></span></span></code></pre></div><ul><li><p>メッセージが成功した場合は、以下のような出力が表示されるはずです</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>1<span class=o>]</span> <span class=m>79829</span>
</span></span><span class=line><span class=cl>user@host manual % appending output to nohup.out</span></span></code></pre></div><ul><li><em>ここで重要な情報は 2 つあります:</em><ul><li><em>1 行目のプロセス ID（この例では <code>79829</code>）、および</em></li><li><em><code>appending output to nohup.out</code> メッセージ</em></li></ul></li><li><em><code>nohup</code> コマンドはスクリプトがバックグラウンドに送られた時に切断されないようにします。また、コマンドからの curl 出力を、現在いるフォルダと同じフォルダにある nohup.out ファイルにキャプチャします。</em></li><li><em><code>&</code> はシェルプロセスにこのプロセスをバックグラウンドで実行するよう指示し、シェルが他のコマンドを実行できるようにします。</em></li></ul></li></ul></li><li><p>次に、<code>response.logs</code> ファイルの内容を確認して、<code>producer-lambda</code> エンドポイントへのリクエストが成功したことを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat response.logs</span></span></code></pre></div><ul><li>メッセージが成功していれば、画面に印刷された行の中に次の出力が表示されるはずです：</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Message placed in the Event Stream: {prefix}-lambda_stream&#34;</span><span class=o>}</span></span></span></code></pre></div><ul><li>失敗した場合は、次のように表示されます：</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Internal server error&#34;</span><span class=o>}</span></span></span></code></pre></div></li></ul><details open class="box cstyle notices important"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-bolt"></i>
重要</summary><div class=box-content><p>この場合は、ワークショップ進行役の一人に支援を求めてください。</p></div></details><h4 id=lambda-関数のログを表示する>Lambda 関数のログを表示する</h4><p>次に、Lambda 関数のログを確認しましょう。</p><ul><li><p><strong>producer-lambda</strong> ログを表示するには、<strong>producer.logs</strong> ファイルを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat producer.logs</span></span></code></pre></div></li><li><p><strong>consumer-lambda</strong> ログを表示するには、<strong>consumer.logs</strong> ファイルを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat consumer.logs</span></span></code></pre></div></li></ul><p>ログを注意深く調べてください。</p><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
ワークショップの質問</summary><div class=box-content><ul><li>OpenTelemetry が読み込まれているのが見えますか？<code>splunk-extension-wrapper</code>のある行に注目してください<ul><li><ul><li><em><strong>splunk-extension-wrapper</strong>が読み込まれているのを見るために<code>head -n 50 producer.logs</code>または<code>head -n 50 consumer.logs</code>の実行を検討してください。</em></li></ul></li></ul></li></ul></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/05/29</span></span></footer></article><article class=default><header class=headline></header><h1 id=splunk-apmlambda関数およびトレース>Splunk APM、Lambda関数およびトレース</h1><p>Lambda 関数は相当量のトレースデータを生成しているはずで、それを確認する必要があります。Lambda 関数のリソース定義で構成された環境変数と OpenTelemetry Lambda layer の組み合わせにより、Splunk APM で関数とトレースを表示する準備が整いました。</p><h4 id=splunk-apm-概要で環境名を確認する>Splunk APM 概要で環境名を確認する</h4><p>まず、Splunk APM が受信しているトレースデータから<code>Environment</code>を認識していることを確認しましょう。これは<code>main.tf</code>の Lambda 関数定義で設定した<code>OTEL_RESOURCE_ATTRIBUTES</code>変数の一部として設定した<code>deployment.name</code>です。これは先ほど実行した<code>terraform apply</code>コマンドの出力の 1 つでもありました。</p><p>Splunk Observability Cloud で：</p><ul><li><p>左側のメインメニューから<code>APM</code>ボタンをクリックします。これにより Splunk APM 概要に移動します。</p></li><li><p><code>Environment:</code>ドロップダウンからあなたの APM 環境を選択します。</p><ul><li><em>APM 環境は<code>PREFIX-lambda-shop</code>形式になっているはずです。<code>PREFIX</code>は前提条件セクションで設定した環境変数から取得されます</em></li></ul></li></ul><details open class="box cstyle notices note"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-exclamation-circle"></i>
メモ</summary><div class=box-content><p>トレースが Splunk APM に表示されるまで数分かかる場合があります。環境のリストにあなたの環境名が表示されるまで、ブラウザの更新ボタンを押してみてください</p></div></details><p><a href=#R-image-cf292ae052267e5ab43d7f18397e3836 class=lightbox-link><img alt="Splunk APM, Environment Name" class="lazy lightbox figure-image" loading=lazy src=../images/02-Auto-APM-EnvironmentName.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-cf292ae052267e5ab43d7f18397e3836><img alt="Splunk APM, Environment Name" class="lazy lightbox lightbox-image" loading=lazy src=../images/02-Auto-APM-EnvironmentName.png></a></p><h4 id=環境のサービスマップを表示する>環境のサービスマップを表示する</h4><p>Environment ドロップダウンから環境名を選択したら、Lambda 関数のサービスマップを確認できます。</p><ul><li>APM 概要ページの右側にある<code>Service Map</code>ボタンをクリックします。これによりサービスマップビューに移動します。</li></ul><p><a href=#R-image-d261d31ada76be4d76681b2505ea8b22 class=lightbox-link><img alt="Splunk APM、サービスマップボタン" class="lazy lightbox figure-image" loading=lazy src=../images/03-Auto-ServiceMapButton.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d261d31ada76be4d76681b2505ea8b22><img alt="Splunk APM、サービスマップボタン" class="lazy lightbox lightbox-image" loading=lazy src=../images/03-Auto-ServiceMapButton.png></a></p><p><code>producer-lambda</code>関数とそのレコードを配置するために Kinesis ストリームに対して行っている呼び出しが表示されるはずです。</p><p><a href=#R-image-a05d1c7bd10d1322cb1b45d17c656758 class=lightbox-link><img alt="Splunk APM、サービスマップ" class="lazy lightbox figure-image" loading=lazy src=../images/04-Auto-ServiceMap.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-a05d1c7bd10d1322cb1b45d17c656758><img alt="Splunk APM、サービスマップ" class="lazy lightbox lightbox-image" loading=lazy src=../images/04-Auto-ServiceMap.png></a></p><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
ワークショップの質問</summary><div class=box-content><p>あなたの<code>consumer-lambda</code>関数はどうなっていますか？</p></div></details><h4 id=lambda-関数からのトレースを調査する>Lambda 関数からのトレースを調査する</h4><ul><li><code>Traces</code>ボタンをクリックしてトレースアナライザーを表示します。</li></ul><p><a href=#R-image-4cb1bf8546b7d59d527edb0d2e7f053c class=lightbox-link><img alt="Splunk APM、トレースボタン" class="lazy lightbox figure-image" loading=lazy src=../images/05-Auto-TraceButton.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-4cb1bf8546b7d59d527edb0d2e7f053c><img alt="Splunk APM、トレースボタン" class="lazy lightbox lightbox-image" loading=lazy src=../images/05-Auto-TraceButton.png></a></p><p>このページでは、<code>producer-lambda</code>関数の OpenTelemetry Lambda layer から取り込まれたトレースを確認できます。</p><p><a href=#R-image-5b1cf869bcaf39646763c3ba6f37bb2c class=lightbox-link><img alt="Splunk APM、トレースアナライザー" class="lazy lightbox figure-image" loading=lazy src=../images/06-Auto-TraceAnalyzer.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5b1cf869bcaf39646763c3ba6f37bb2c><img alt="Splunk APM、トレースアナライザー" class="lazy lightbox lightbox-image" loading=lazy src=../images/06-Auto-TraceAnalyzer.png></a></p><ul><li>リストからハイパーリンクされた<code>Trace ID</code>をクリックして、調査するトレースを選択します。</li></ul><p><a href=#R-image-d5d96bb21ecdcc230c438e7b44a15c2f class=lightbox-link><img alt="Splunk APM、トレースとスパン" class="lazy lightbox figure-image" loading=lazy src=../images/07-Auto-TraceNSpans.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d5d96bb21ecdcc230c438e7b44a15c2f><img alt="Splunk APM、トレースとスパン" class="lazy lightbox lightbox-image" loading=lazy src=../images/07-Auto-TraceNSpans.png></a></p><p><code>producer-lambda</code>関数が Kinesis ストリームにレコードを配置しているのが確認できます。しかし、<code>consumer-lambda</code>関数のアクションが見当たりません！</p><p>これはトレースコンテキストが伝播されていないためです。このワークショップの時点では、Kinesis サービスはトレースコンテキスト伝播をすぐには対応していません。分散トレースは Kinesis サービスで止まっており、そのコンテキストがストリームを通じて自動的に伝播されないため、それ以上先を見ることができません。</p><p>少なくとも、今はまだ&mldr;</p><p>次のセクションでこの問題にどう対処するか見ていきましょう。しかしその前に、後片付けをしましょう！</p><h3 id=クリーンアップ>クリーンアップ</h3><p>この自動計装演習の一部としてデプロイしたリソースはクリーンアップする必要があります。同様に、<code>producer-lambda</code>エンドポイントに対してトラフィックを生成していたスクリプトも、まだ実行中であれば停止する必要があります。以下の手順に従ってクリーンアップを行ってください。</p><h4 id=send_messageの停止><code>send_message</code>の停止</h4><ul><li><p><code>send_message.py</code>スクリプトがまだ実行中の場合は、次のコマンドで停止します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>fg</span></span></code></pre></div><ul><li>これによりバックグラウンドプロセスがフォアグラウンドに移動します。</li><li>次に<code>[CONTROL-C]</code>を押してプロセスを終了できます。</li></ul></li></ul><h4 id=全ての-aws-リソースを破棄する>全ての AWS リソースを破棄する</h4><p>Terraform は個々のリソースの状態をデプロイメントとして管理するのに優れています。定義に変更があっても、デプロイされたリソースを更新することもできます。しかし、一からやり直すために、リソースを破棄し、このワークショップの手動計装部分の一部として再デプロイします。</p><p>以下の手順に従ってリソースを破棄してください：</p><ul><li><p><code>auto</code>ディレクトリにいることを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwd</span></span></code></pre></div><ul><li><em>期待される出力は <strong>~/o11y-lambda-workshop/auto</strong> です</em></li></ul></li><li><p><code>auto</code>ディレクトリにいない場合は、以下のコマンドを実行します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/auto</span></span></code></pre></div></li><li><p>先ほどデプロイした Lambda 関数とその他の AWS リソースを破棄します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform destroy</span></span></code></pre></div><ul><li><code>Enter a value:</code>プロンプトが表示されたら<code>yes</code>と応答します</li><li>これによりリソースが破棄され、クリーンな環境が残ります</li></ul></li></ul><p>このプロセスにより、私たちの活動の結果として作成されたファイルとディレクトリは残ります。それらについては心配する必要はありません。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/05/29</span></span></footer></article><article class=default><header class=headline></header><h1 id=手動計装>手動計装</h1><p>ワークショップの第 2 部では、OpenTelemetry による手動計装が計測データ収集を強化する方法を実演することに焦点を当てます。より具体的には、今回のケースでは、<code>producer-lambda</code>関数から<code>consumer-lambda</code>関数にトレースコンテキストデータを伝播させることができるようになります。これにより、現在は自動コンテキスト伝播をサポートしていない Kinesis ストリームを介しても、2 つの関数間の関係を見ることができるようになります。</p><h3 id=手動計装ワークショップディレクトリとコンテンツ>手動計装ワークショップディレクトリとコンテンツ</h3><p>再度、作業ディレクトリとそのファイルの一部を確認することから始めます。今回は <code>o11y-lambda-workshop/manual</code> ディレクトリです。ここにはワークショップの手動計装部分のすべてのコンテンツがあります。</p><h4 id=manual-ディレクトリ><code>manual</code> ディレクトリ</h4><ul><li><p>以下のコマンドを実行して <code>o11y-lambda-workshop/manual</code> ディレクトリに移動します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/manual</span></span></code></pre></div></li><li><p><code>ls</code> コマンドでこのディレクトリの内容を確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ls</span></span></code></pre></div><ul><li><p><em>出力には以下のファイルとディレクトリが含まれるはずです：</em></p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>handler             outputs.tf          terraform.tf        variables.tf
</span></span><span class=line><span class=cl>main.tf             send_message.py     terraform.tfvars</span></span></code></pre></div></li></ul></li></ul><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
ワークショップの質問</summary><div class=box-content><p>このディレクトリと最初に始めた auto ディレクトリに何か違いがありますか？</p></div></details><h4 id=auto-と-manual-のファイルを比較する><code>auto</code> と <code>manual</code> のファイルを比較する</h4><p>見た目が同じように見えるこれらのファイルが実際に同じかどうか確認しましょう。</p><ul><li><p><code>auto</code> と <code>manual</code> ディレクトリの <code>main.tf</code> ファイルを比較します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>diff ~/o11y-lambda-workshop/auto/main.tf ~/o11y-lambda-workshop/manual/main.tf</span></span></code></pre></div><ul><li>違いはありません！<em>(違いがあるはずはありません。もし違いがあれば、ワークショップ進行役に支援を求めてください)</em></li></ul></li><li><p>次に、<code>producer.mjs</code> ファイルを比較してみましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>diff ~/o11y-lambda-workshop/auto/handler/producer.mjs ~/o11y-lambda-workshop/manual/handler/producer.mjs</span></span></code></pre></div><ul><li>ここにはかなりの違いがあります！</li></ul></li><li><p>ファイル全体を表示してその内容を調べたい場合は以下を実行します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/o11y-lambda-workshop/handler/producer.mjs</span></span></code></pre></div><ul><li>必要な手動計装タスクを処理するために、いくつかの OpenTelemetry オブジェクトを関数に直接インポートしていることに注目してください。</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>context</span><span class=p>,</span> <span class=nx>propagation</span><span class=p>,</span> <span class=nx>trace</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;@opentelemetry/api&#34;</span><span class=p>;</span></span></span></code></pre></div><ul><li>プロデューサー関数でコンテキストを伝播するために、<a href=https://www.npmjs.com/package/@opentelemetry/api rel=external target=_blank>@opentelemetry/api</a> から次のオブジェクトをインポートしています：<ul><li>context</li><li>propagation</li><li>trace</li></ul></li></ul></li><li><p>最後に、<code>consumer.mjs</code> ファイルを比較します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>diff ~/o11y-lambda-workshop/auto/handler/consumer.mjs ~/o11y-lambda-workshop/manual/handler/consumer.mjs</span></span></code></pre></div><ul><li><p>ここにもいくつかの注目すべき違いがあります。より詳しく見てみましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat handler/consumer.mjs</span></span></code></pre></div><ul><li>このファイルでは、次の <a href=https://www.npmjs.com/package/@opentelemetry/api rel=external target=_blank>@opentelemetry/api</a> オブジェクトをインポートしています：<ul><li>propagation</li><li>trace</li><li>ROOT_CONTEXT</li></ul></li><li>これらを使用して、プロデューサー関数から伝播されたトレースコンテキストを抽出します</li><li>その後、抽出したトレースコンテキストに <code>name</code> と <code>superpower</code> に基づいた新しいスパン属性を追加します</li></ul></li></ul></li></ul><h4 id=プロデューサー関数からのトレースコンテキスト伝播>プロデューサー関数からのトレースコンテキスト伝播</h4><p>以下のコードはプロデューサー関数内で次のステップを実行します：</p><ol><li>このトレース用のトレーサーを取得する</li><li>コンテキストキャリアオブジェクトを初期化する</li><li>アクティブスパンのコンテキストをキャリアオブジェクトに注入する</li><li>Kinesis ストリームに配置しようとしているレコードを修正し、アクティブスパンのコンテキストをコンシューマーに運ぶキャリアを含める</li></ol><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>context</span><span class=p>,</span> <span class=nx>propagation</span><span class=p>,</span> <span class=nx>trace</span><span class=p>,</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;@opentelemetry/api&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>tracer</span> <span class=o>=</span> <span class=nx>trace</span><span class=p>.</span><span class=nx>getTracer</span><span class=p>(</span><span class=s1>&#39;lambda-app&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>tracer</span><span class=p>.</span><span class=nx>startActiveSpan</span><span class=p>(</span><span class=s1>&#39;put-record&#39;</span><span class=p>,</span> <span class=kr>async</span><span class=p>(</span><span class=nx>span</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>carrier</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=nx>propagation</span><span class=p>.</span><span class=nx>inject</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>active</span><span class=p>(),</span> <span class=nx>carrier</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>eventBody</span> <span class=o>=</span> <span class=nx>Buffer</span><span class=p>.</span><span class=nx>from</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>body</span><span class=p>,</span> <span class=s1>&#39;base64&#39;</span><span class=p>).</span><span class=nx>toString</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>data</span> <span class=o>=</span> <span class=s2>&#34;{\&#34;tracecontext\&#34;: &#34;</span> <span class=o>+</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>carrier</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34;, \&#34;record\&#34;: &#34;</span> <span class=o>+</span> <span class=nx>eventBody</span> <span class=o>+</span> <span class=s2>&#34;}&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=sb>`Record with Trace Context added:
</span></span></span><span class=line><span class=cl><span class=sb>      </span><span class=si>${</span><span class=nx>data</span><span class=si>}</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>await</span> <span class=nx>kinesis</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=nx>PutRecordCommand</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>StreamName</span><span class=o>:</span> <span class=nx>streamName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>PartitionKey</span><span class=o>:</span> <span class=s2>&#34;1234&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>Data</span><span class=o>:</span> <span class=nx>data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>}),</span>
</span></span><span class=line><span class=cl>        <span class=nx>message</span> <span class=o>=</span> <span class=sb>`Message placed in the Event Stream: </span><span class=si>${</span><span class=nx>streamName</span><span class=si>}</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>span</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span></span></span></code></pre></div><h4 id=コンシューマー関数でのトレースコンテキスト抽出>コンシューマー関数でのトレースコンテキスト抽出</h4><p>以下のコードはコンシューマー関数内で次のステップを実行します：</p><ol><li><code>producer-lambda</code>から取得したコンテキストをキャリアオブジェクトに抽出する</li><li>現在のコンテキストからトレーサーを抽出する</li><li>抽出したコンテキスト内でトレーサーを使用して新しいスパンを開始する</li><li>ボーナス：メッセージからの値を含むカスタム属性など、追加の属性をスパンに追加する！</li><li>完了したら、スパンを終了する</li></ol><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>propagation</span><span class=p>,</span> <span class=nx>trace</span><span class=p>,</span> <span class=nx>ROOT_CONTEXT</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;@opentelemetry/api&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>carrier</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span> <span class=nx>message</span> <span class=p>).</span><span class=nx>tracecontext</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>parentContext</span> <span class=o>=</span> <span class=nx>propagation</span><span class=p>.</span><span class=nx>extract</span><span class=p>(</span><span class=nx>ROOT_CONTEXT</span><span class=p>,</span> <span class=nx>carrier</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>tracer</span> <span class=o>=</span> <span class=nx>trace</span><span class=p>.</span><span class=nx>getTracer</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>OTEL_SERVICE_NAME</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>span</span> <span class=o>=</span> <span class=nx>tracer</span><span class=p>.</span><span class=nx>startSpan</span><span class=p>(</span><span class=s2>&#34;Kinesis.getRecord&#34;</span><span class=p>,</span> <span class=kc>undefined</span><span class=p>,</span> <span class=nx>parentContext</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>span</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s2>&#34;span.kind&#34;</span><span class=p>,</span> <span class=s2>&#34;server&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>body</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span> <span class=nx>message</span> <span class=p>).</span><span class=nx>record</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>body</span><span class=p>.</span><span class=nx>name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>span</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s2>&#34;custom.tag.name&#34;</span><span class=p>,</span> <span class=nx>body</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>body</span><span class=p>.</span><span class=nx>superpower</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>span</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s2>&#34;custom.tag.superpower&#34;</span><span class=p>,</span> <span class=nx>body</span><span class=p>.</span><span class=nx>superpower</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>      <span class=nx>span</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span></span></span></code></pre></div><p>これでどのような違いが生まれるか見てみましょう！</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/05/13</span></span></footer></article><article class=default><header class=headline></header><h1 id=lambda関数のデプロイとトレースデータの生成>Lambda関数のデプロイとトレースデータの生成</h1><p>トレースデータを収集したい関数やサービスに手動計装を適用する方法がわかったので、Lambda 関数を再度デプロイして、<code>producer-lambda</code>エンドポイントに対するトラフィックを生成していきましょう。</p><h4 id=manual-ディレクトリで-terraform-を初期化する><code>manual</code> ディレクトリで Terraform を初期化する</h4><p>新しいディレクトリにいるので、ここでもう一度 Terraform を初期化する必要があります。</p><ul><li><p><code>manual</code> ディレクトリにいることを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwd</span></span></code></pre></div><ul><li><em>予想される出力は <strong>~/o11y-lambda-workshop/manual</strong> です</em></li></ul></li><li><p><code>manual</code> ディレクトリにいない場合は、次のコマンドを実行します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/manual</span></span></code></pre></div></li><li><p>次のコマンドを実行して、このディレクトリで Terraform を初期化します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform init</span></span></code></pre></div></li></ul><h4 id=lambda-関数とその他の-aws-リソースをデプロイする>Lambda 関数とその他の AWS リソースをデプロイする</h4><p>それでは、これらのリソースを再度デプロイしましょう！</p><ul><li><p>問題がないことを確認するために、<strong>terraform plan</strong> コマンドを実行します。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform plan</span></span></code></pre></div></li><li><p>続いて、<strong>terraform apply</strong> コマンドを使用して <strong>main.tf</strong> ファイルから Lambda 関数とその他のサポートリソースをデプロイします：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform apply</span></span></code></pre></div><ul><li><p><em><strong>Enter a value:</strong> プロンプトが表示されたら <strong>yes</strong> と応答します</em></p></li><li><p>これにより、以下のような出力が得られます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Outputs:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>base_url</span> <span class=o>=</span> <span class=s2>&#34;https://______.amazonaws.com/serverless_stage/producer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>consumer_function_name</span> <span class=o>=</span> <span class=s2>&#34;_____-consumer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>consumer_log_group_arn</span> <span class=o>=</span> <span class=s2>&#34;arn:aws:logs:us-east-1:############:log-group:/aws/lambda/______-consumer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>consumer_log_group_name</span> <span class=o>=</span> <span class=s2>&#34;/aws/lambda/______-consumer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>environment</span> <span class=o>=</span> <span class=s2>&#34;______-lambda-shop&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>lambda_bucket_name</span> <span class=o>=</span> <span class=s2>&#34;lambda-shop-______-______&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>producer_function_name</span> <span class=o>=</span> <span class=s2>&#34;______-producer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>producer_log_group_arn</span> <span class=o>=</span> <span class=s2>&#34;arn:aws:logs:us-east-1:############:log-group:/aws/lambda/______-producer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>producer_log_group_name</span> <span class=o>=</span> <span class=s2>&#34;/aws/lambda/______-producer&#34;</span></span></span></code></pre></div></li></ul></li></ul><p>見ての通り、base_url の最初の部分とログループ ARN 以外は、このワークショップの自動計装部分をこの同じ時点まで実行したときと出力は概ね同じはずです。</p><h4 id=producer-lambda-エンドポイント-base_url-にトラフィックを送信する><code>producer-lambda</code> エンドポイント (base_url) にトラフィックを送信する</h4><p>もう一度、<code>name</code> と <code>superpower</code> をメッセージとしてエンドポイントに送信します。これはトレースコンテキストとともに、Kinesis ストリーム内のレコードに追加されます。</p><ul><li><p><code>manual</code> ディレクトリにいることを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwd</span></span></code></pre></div><ul><li><em>予想される出力は <strong>~/o11y-lambda-workshop/manual</strong> です</em></li></ul></li><li><p><code>manual</code> ディレクトリにいない場合は、次のコマンドを実行します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/manual</span></span></code></pre></div></li><li><p><code>send_message.py</code> スクリプトをバックグラウンドプロセスとして実行します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nohup ./send_message.py --name CHANGEME --superpower CHANGEME <span class=p>&amp;</span></span></span></code></pre></div></li><li><p>次に、response.logs ファイルの内容を確認して、<strong>producer-lambda</strong>エンドポイントへの呼び出しが成功しているか確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat response.logs</span></span></code></pre></div><ul><li><p>メッセージが成功していれば、画面に表示される行の中に次の出力が表示されるはずです：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Message placed in the Event Stream: hostname-eventStream&#34;</span><span class=o>}</span></span></span></code></pre></div></li><li><p>失敗した場合は、次のように表示されます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Internal server error&#34;</span><span class=o>}</span></span></span></code></pre></div></li></ul></li></ul><details open class="box cstyle notices important"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-bolt"></i>
重要</summary><div class=box-content><p>これが発生した場合は、ワークショップ進行役の一人に支援を求めてください。</p></div></details><h4 id=lambda-関数のログの確認>Lambda 関数のログの確認</h4><p>ログがどのようになっているか見てみましょう。</p><ul><li><p><strong>producer.logs</strong> ファイルを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat producer.logs</span></span></code></pre></div></li><li><p>そして <strong>consumer.logs</strong> ファイルを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat consumer.logs</span></span></code></pre></div></li></ul><p>ログを注意深く調べてください。</p><h5 id=ワークショップの質問><em>ワークショップの質問</em></h5><blockquote><p>違いに気づきましたか？</p></blockquote><h4 id=consumer-lambda-ログからのトレース-id-のコピー><code>consumer-lambda</code> ログからのトレース ID のコピー</h4><p>今回は、consumer-lambda のロググループが、我々が伝播した<code>tracecontext</code>とともに、メッセージを<code>record</code>としてログに記録しているのが確認できます。</p><p>トレース ID をコピーするには：</p><ul><li><code>Kinesis Message</code>ログの 1 つを見てみましょう。その中には<code>data</code>ディクショナリがあります</li><li>ネストされた<code>tracecontext</code>ディクショナリを見るために、<code>data</code>をより詳しく見てください</li><li><code>tracecontext</code>ディクショナリ内には、<code>traceparent</code>というキーと値のペアがあります</li><li><code>traceparent</code>キーと値のペアには、私たちが探しているトレース ID が含まれています<ul><li><code>-</code>で区切られた 4 つの値のグループがあります。トレース ID は 2 番目の文字グループです</li></ul></li><li><strong>トレース ID をコピーして保存してください。</strong> このワークショップの後のステップで必要になります</li></ul><p><a href=#R-image-38079270a8f5fb2182826d1192378075 class=lightbox-link><img alt="Lambda Consumer Logs、手動計装" class="lazy lightbox figure-image" loading=lazy src=../images/08-Manual-ConsumerLogs.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-38079270a8f5fb2182826d1192378075><img alt="Lambda Consumer Logs、手動計装" class="lazy lightbox lightbox-image" loading=lazy src=../images/08-Manual-ConsumerLogs.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/05/29</span></span></footer></article><article class=default><header class=headline></header><h1 id=splunk-apmlambda関数とトレース再び>Splunk APM、Lambda関数とトレース、再び！</h1><p>ログの外部でコンテキスト伝播の結果を確認するために、もう一度<a href=https://app.us1.signalfx.com/#/apm rel=external target=_blank>Splunk APM UI</a>を参照します。</p><h4 id=splunk-apm-サービスマップで-lambda-関数を表示する>Splunk APM サービスマップで Lambda 関数を表示する</h4><p>もう一度 APM で環境のサービスマップを確認してみましょう。</p><p>Splunk Observability Cloud で：</p><ul><li><p>メインメニューの<code>APM</code>ボタンをクリックします。</p></li><li><p><code>Environment:</code>ドロップダウンからあなたの APM 環境を選択します。</p></li><li><p>APM 概要ページの右側にある<code>Service Map</code>ボタンをクリックします。これによりサービスマップビューに移動します。</p></li></ul><details open class="box cstyle notices note"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-exclamation-circle"></i>
> <em>注意：トレースが Splunk APM に表示されるまで数分かかる場合があります。環境のリストにあなたの環境名が表示されるまで、ブラウザの更新ボタンを押してみてください</em></summary></details><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
ワークショップの質問</summary><div class=box-content><p>違いに気づきましたか？</p></div></details><ul><li>今回は、伝播されたコンテキストによってリンクされた<code>producer-lambda</code>と<code>consumer-lambda</code>関数が見えるはずです！</li></ul><p><a href=#R-image-1e05594767bd0e1923d8a15109bb457b class=lightbox-link><img alt="Splunk APM、サービスマップ" class="lazy lightbox figure-image" loading=lazy src=../images/09-Manual-ServiceMap.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-1e05594767bd0e1923d8a15109bb457b><img alt="Splunk APM、サービスマップ" class="lazy lightbox lightbox-image" loading=lazy src=../images/09-Manual-ServiceMap.png></a></p><h4 id=トレース-id-で-lambda-トレースを調査する>トレース ID で Lambda トレースを調査する</h4><p>次に、環境に関連するトレースをもう一度確認します。</p><ul><li>コンシューマー関数のログからコピーしたトレース ID を、Traces 下の<code>View Trace ID</code>検索ボックスに貼り付け、<code>Go</code>をクリックします</li></ul><p><a href=#R-image-da0f3238712b4d5dc88a98540a922671 class=lightbox-link><img alt="Splunk APM、トレースボタン" class="lazy lightbox figure-image" loading=lazy src=../images/10-Manual-TraceButton.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-da0f3238712b4d5dc88a98540a922671><img alt="Splunk APM、トレースボタン" class="lazy lightbox lightbox-image" loading=lazy src=../images/10-Manual-TraceButton.png></a></p><details open class="box cstyle notices note"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-exclamation-circle"></i>
メモ</summary><div class=box-content><p>トレース ID は、私たちが伝播したトレースコンテキストの一部でした。</p></div></details><p>最も一般的な 2 つの伝播規格について読むことができます：</p><ol><li><a href=https:///www.w3.org/TR/trace-context/#traceparent-header rel=external target=_blank>W3C</a></li><li><a href=https://github.com/openzipkin/b3-propagation#overall-process rel=external target=_blank>B3</a></li></ol><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
ワークショップの質問</summary><div class=box-content><p>私たちはどちらを使用していますか？</p><ul><li><em>私たちの NodeJS 関数をサポートする Splunk Distribution of Opentelemetry JS は、<a href=https://docs.splunk.com/observability/en/gdi/get-data-in/application/nodejs/splunk-nodejs-otel-distribution.html#defaults-of-the-splunk-distribution-of-opentelemetry-js rel=external target=_blank>デフォルト</a>で<code>W3C</code>標準を使用しています</em></li></ul></div></details><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
ワークショップの質問</summary><div class=box-content><p>ボーナス質問：W3C ヘッダーと B3 ヘッダーを混在させるとどうなりますか？</p></div></details><p><a href=#R-image-3c325ba5ad94e124134c6e9620abf6d1 class=lightbox-link><img alt="Splunk APM、IDによるトレース" class="lazy lightbox figure-image" loading=lazy src=../images/11-Manual-TraceByID.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-3c325ba5ad94e124134c6e9620abf6d1><img alt="Splunk APM、IDによるトレース" class="lazy lightbox lightbox-image" loading=lazy src=../images/11-Manual-TraceByID.png></a></p><p><code>consumer-lambda</code>スパンをクリックしてください。</p><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
ワークショップの質問</summary><div class=box-content><p>あなたのメッセージからの属性を見つけることができますか？</p></div></details><p><a href=#R-image-736b9f292b5f8c3771ccf48daff3bd74 class=lightbox-link><img alt="Splunk APM、スパンタグ" class="lazy lightbox figure-image" loading=lazy src=../images/12-Manual-SpanTags.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-736b9f292b5f8c3771ccf48daff3bd74><img alt="Splunk APM、スパンタグ" class="lazy lightbox lightbox-image" loading=lazy src=../images/12-Manual-SpanTags.png></a></p><h3 id=クリーンアップ>クリーンアップ</h3><p>いよいよワークショップの最後に来ました。後片付けをしましょう！</p><h4 id=send_messageの停止><code>send_message</code>の停止</h4><ul><li><p><code>send_message.py</code>スクリプトがまだ実行中の場合は、次のコマンドで停止します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>fg</span></span></code></pre></div><ul><li>これによりバックグラウンドプロセスがフォアグラウンドに移動します。</li><li>次に<code>[CONTROL-C]</code>を押してプロセスを終了できます。</li></ul></li></ul><h4 id=すべての-aws-リソースを破棄する>すべての AWS リソースを破棄する</h4><p>Terraform は個々のリソースの状態をデプロイメントとして管理するのに優れています。定義に変更があっても、デプロイされたリソースを更新することもできます。しかし、一からやり直すために、リソースを破棄し、このワークショップの手動計装部分の一部として再デプロイします。</p><p>以下の手順に従ってリソースを破棄してください：</p><ul><li><p><code>manual</code>ディレクトリにいることを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwd</span></span></code></pre></div><ul><li><em>予想される出力は <strong>~/o11y-lambda-workshop/manual</strong> です</em></li></ul></li><li><p><code>manual</code>ディレクトリにいない場合は、次のコマンドを実行します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/manual</span></span></code></pre></div></li><li><p>以前にデプロイした Lambda 関数とその他の AWS リソースを破棄します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform destroy</span></span></code></pre></div><ul><li><code>Enter a value:</code>プロンプトが表示されたら<code>yes</code>と応答します</li><li>これにより、リソースが破棄され、クリーンな環境が残ります</li></ul></li></ul><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/05/13</span></span></footer></article><article class=default><header class=headline></header><h1 id=結論>結論</h1><p>Lambda Tracing ワークショップを終えたことをおめでとうございます！自動計装を手動のステップで補完して、<code>producer-lambda</code>関数のコンテキストを Kinesis ストリーム内のレコードを介して<code>consumer-lambda</code>関数に送信する方法を見てきました。これにより、期待される分散トレースを構築し、Splunk APM で両方の関数間の関係をコンテキスト化することができました。</p><p><a href=#R-image-e2e7086e224f9fc0b0164ad8a5f5c1da class=lightbox-link><img alt=完全に計装されたLambdaアプリケーション class="lazy lightbox figure-image" loading=lazy src=../images/13-Architecture_Instrumented.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e2e7086e224f9fc0b0164ad8a5f5c1da><img alt=完全に計装されたLambdaアプリケーション class="lazy lightbox lightbox-image" loading=lazy src=../images/13-Architecture_Instrumented.png></a></p><p>これで、2 つの異なる関数を手動でリンクしてトレースを構築することができます。これは、自動計装や第三者のシステムがコンテキスト伝播を標準でサポートしていない場合や、より関連性の高いトレース分析のためにカスタム属性をトレースに追加したい場合に役立ちます。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/05/13</span></span></footer></article></section></div></main></div><script src=/observability-workshop/v6.8/js/clipboard/clipboard.min.js?1759784486 defer></script><script src=/observability-workshop/v6.8/js/perfect-scrollbar/perfect-scrollbar.min.js?1759784486 defer></script><script src=/observability-workshop/v6.8/js/theme.min.js?1759784486 defer></script></body></html>