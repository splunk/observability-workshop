<!doctype html><html id=R-html lang=en dir=ltr itemscope itemtype=http://schema.org/Article data-r-output-format=print><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.145.0"><meta name=generator content="Relearn 9.0.3+9bc97fdf9eaf3af61af9bcc11db2e010de83af95"><meta name=description content="This workshop will equip you with how a distributed trace is constructed for a small serverless application that runs on AWS Lambda, producing and consuming a message via AWS Kinesis"><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Build a Distributed Trace in Lambda and Kinesis :: Splunk Observability Cloud Workshops"><meta name=twitter:description content="This workshop will equip you with how a distributed trace is constructed for a small serverless application that runs on AWS Lambda, producing and consuming a message via AWS Kinesis"><meta property="og:url" content="https://splunk.github.io/observability-workshop/en/unsupported-field-workshops/6-lambda-kinesis/index.html"><meta property="og:site_name" content="Splunk Observability Cloud Workshops"><meta property="og:title" content="Build a Distributed Trace in Lambda and Kinesis :: Splunk Observability Cloud Workshops"><meta property="og:description" content="This workshop will equip you with how a distributed trace is constructed for a small serverless application that runs on AWS Lambda, producing and consuming a message via AWS Kinesis"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta itemprop=name content="Build a Distributed Trace in Lambda and Kinesis :: Splunk Observability Cloud Workshops"><meta itemprop=description content="This workshop will equip you with how a distributed trace is constructed for a small serverless application that runs on AWS Lambda, producing and consuming a message via AWS Kinesis"><meta itemprop=dateModified content="2024-10-25T15:51:05+01:00"><meta itemprop=wordCount content="98"><title>Build a Distributed Trace in Lambda and Kinesis :: Splunk Observability Cloud Workshops</title>
<link href=https://splunk.github.io/observability-workshop/en/unsupported-field-workshops/6-lambda-kinesis/index.html rel=canonical type=text/html title="Build a Distributed Trace in Lambda and Kinesis :: Splunk Observability Cloud Workshops"><link href=/observability-workshop/images/favicon.ico?1770895853 rel=icon type=image/x-icon sizes=any><link href=/observability-workshop/css/auto-complete/auto-complete.min.css?1770895853 rel=stylesheet><script src=/observability-workshop/js/auto-complete/auto-complete.min.js?1770895853 defer></script><script src=/observability-workshop/js/search-lunr.min.js?1770895853 defer></script><script src=/observability-workshop/js/search.min.js?1770895853 defer></script><script>window.relearn=window.relearn||{},window.relearn.index_js_url="/observability-workshop/searchindex.en.js?1770895853"</script><script src=/observability-workshop/js/lunr/lunr.min.js?1770895853 defer></script><script src=/observability-workshop/js/lunr/lunr.stemmer.support.min.js?1770895853 defer></script><script src=/observability-workshop/js/lunr/lunr.multi.min.js?1770895853 defer></script><script src=/observability-workshop/js/lunr/lunr.en.min.js?1770895853 defer></script><script>window.relearn=window.relearn||{},window.relearn.contentLangs=["en"]</script><link href=/observability-workshop/fonts/fontawesome/css/all.min.css?1770895853 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/fonts/fontawesome/css/all.min.css?1770895853 rel=stylesheet></noscript><link href=/observability-workshop/css/perfect-scrollbar/perfect-scrollbar.min.css?1770895853 rel=stylesheet><link href=/observability-workshop/css/theme.min.css?1770895853 rel=stylesheet><link href=/observability-workshop/css/format-print.min.css?1770895853 rel=stylesheet id=R-format-style><script>window.relearn=window.relearn||{},window.relearn.min=`.min`,window.relearn.path="/unsupported-field-workshops/6-lambda-kinesis/index.html",window.relearn.relBasePath="../../..",window.relearn.relBaseUri="../../../..",window.relearn.absBaseUri="https://splunk.github.io/observability-workshop",window.relearn.disableInlineCopyToClipboard=!0,window.relearn.enableBlockCodeWrap=!0,window.T_Copy_to_clipboard=`Copy text to clipboard`,window.T_Copied_to_clipboard=`Text copied to clipboard!`,window.T_Link_copied_to_clipboard=`Link copied to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`,window.T_Browser_unsupported_feature=`This browser doesn't support this feature`,window.relearn.themevariants=["auto","splunk-light","splunk-dark"],window.relearn.customvariantprefix="my-custom-",window.relearn.changeVariant=function(e){var t=document.documentElement.dataset.rThemeVariant;window.localStorage.setItem(window.relearn.absBaseUri+"/variant",e),document.documentElement.dataset.rThemeVariant=e,t!=e&&(document.dispatchEvent(new CustomEvent("themeVariantLoaded",{detail:{variant:e,oldVariant:t}})),window.relearn.markVariant())},window.relearn.markVariant=function(){var e=window.localStorage.getItem(window.relearn.absBaseUri+"/variant");document.querySelectorAll(".R-variantswitcher select").forEach(t=>{t.value=e})},window.relearn.initVariant=function(){var e=window.localStorage.getItem(window.relearn.absBaseUri+"/variant")??"";(!e||!e.startsWith(window.relearn.customvariantprefix)&&!window.relearn.themevariants.includes(e)||e.startsWith(window.relearn.customvariantprefix)&&!window.localStorage.getItem(window.relearn.absBaseUri+"/variantstylesheet-"+e))&&(e=window.relearn.themevariants[0],window.localStorage.setItem(window.relearn.absBaseUri+"/variant",e)),document.documentElement.dataset.rThemeVariant=e},window.relearn.initVariant(),window.relearn.markVariant()</script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js crossorigin=anonymous></script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web-session-recorder.js crossorigin=anonymous></script><script>SplunkRum.init({realm:"us1",rumAccessToken:"h7q1NLX6lJz0h_5-OqQJkg",applicationName:"observability-workshop",deploymentEnvironment:"splunk.github.io",version:"1.0"}),SplunkSessionRecorder.init({appplicationName:"observability-workshop",realm:"us1",rumAccessToken:"h7q1NLX6lJz0h_5-OqQJkg",recorder:"splunk",features:{video:!0}})</script></script><style>:root{--MAIN-WIDTH-MAX:130rem;--MENU-WIDTH-L:23rem}p{margin:.75rem 0}.highlight{max-height:500px;overflow-y:auto}pre:not(.mermaid){margin:0}</style></head><body class="mobile-support print" data-origin=/observability-workshop/en/unsupported-field-workshops/6-lambda-kinesis/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar class=default-animation><div class="topbar-wrapper default-animation"><div class="topbar-sidebar-divider default-animation"></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar default-animation" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><span class="btn cstyle button link noborder notitle interactive"><button onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></span></div><div class="topbar-button topbar-button-toc default-animation" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle button link noborder notitle interactive"><button onclick=toggleTopbarFlyout(this) type=button title="Table of Contents (CTRL+ALT+t)"><i class="fa-fw fas fa-table-list"></i></button></span><div class=topbar-content><div class=topbar-content-wrapper></div></div></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/en/index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/en/unsupported-field-workshops/index.html><span itemprop=name>Unsupported Field Workshops</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Lambda Tracing and Kinesis</span><meta itemprop=position content="3"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-print default-animation" data-content-empty=disable data-width-s=area-more data-width-m=show data-width-l=show><span class="btn cstyle button link noborder notitle interactive"><a href=/observability-workshop/en/unsupported-field-workshops/6-lambda-kinesis/index.print.html title="Print whole chapter (CTRL+ALT+p)"><i class="fa-fw fas fa-print"></i></a></span></div><div class="topbar-button topbar-button-prev default-animation" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle button link noborder notitle interactive"><a href=/observability-workshop/en/unsupported-field-workshops/3-nodejs-kubernetes/6-logs/index.html title="Logs - Payment Service (ðŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a></span></div><div class="topbar-button topbar-button-next default-animation" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle button link noborder notitle interactive"><a href=/observability-workshop/en/unsupported-field-workshops/6-lambda-kinesis/1-setup/index.html title="Setup (ðŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a></span></div><div class="topbar-button topbar-button-more default-animation" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle button link noborder notitle interactive"><button onclick=toggleTopbarFlyout(this) type=button title=More><i class="fa-fw fas fa-ellipsis-v"></i></button></span><div class=topbar-content><div class=topbar-content-wrapper><div class="topbar-area topbar-area-more" data-area=more></div></div></div></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable unsupported-field-workshops" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=build-a-distributed-trace-in-lambda-and-kinesis>Build a Distributed Trace in Lambda and Kinesis</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>45 minutes</span>
</span>&nbsp;
<span class="badge cstyle blue badge-with-title"><span class=badge-title class=text-muted>Author
</span><span class=badge-content>Katie Hymers</span></span><p>This workshop will equip you with how a distributed trace is constructed for a small serverless application that runs on AWS Lambda, producing and consuming a message via AWS Kinesis.</p><p>We will see how auto-instrumentation works with manual steps to force a Producer function&rsquo;s context to be sent to Consumer function via a Record put on a Kinesis stream.</p><p>For this workshop Splunk has prepared an Ubuntu Linux instance in AWS/EC2 all pre-configured for you.</p><p>To get access to the instance that you will be using in the workshop, please visit the URL provided by the workshop leader.d</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Oct 25, 2024</span></span></footer></article><section><h1 class=a11y-only>Subsections of Lambda Tracing and Kinesis</h1><article class=default><header class=headline></header><h1 id=setup>Setup</h1><p>This lab will make a tracing superhero out of you!</p><p>In this lab you will learn how a distributed trace is constructed for a small serverless application that runs on AWS Lambda, producing and consuming your message via AWS Kinesis.</p><p><a href=#R-image-93b9fb0e0431520d687200a39a154d2f class=lightbox-link><img alt=1-architecture class="lazy lightbox figure-image" loading=lazy src=../images/1-architecture.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-93b9fb0e0431520d687200a39a154d2f><img alt=1-architecture class="lazy lightbox lightbox-image" loading=lazy src=../images/1-architecture.png></a></p><h2 id=pre-requisites>Pre-requisites<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>You should already have the lab content available on your EC2 lab host.</p><p>Ensure that this lab&rsquo;s required folder o11y-lambda-lab is on your home directory:</p><div class=tab-panel data-tab-group=R-tabs-d4370d54c81f6cc3e05cd51bff817742><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-0b7b2321893f367c17376ba1b5878987 aria-expanded=true data-tab-item=R-tab-ee97be03cb04119af45014d815621ce1 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-d4370d54c81f6cc3e05cd51bff817742","R-tab-ee97be03cb04119af45014d815621ce1")'>
<span class=tab-nav-text>Command</span>
</button>
<button aria-controls=R-tab-id-b137f5bedd8ef249b521fe2f9090e4fc aria-expanded=false data-tab-item=R-tab-29c2c02a361c9d7028472e5d92cd4a54 class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-d4370d54c81f6cc3e05cd51bff817742","R-tab-29c2c02a361c9d7028472e5d92cd4a54")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div id=R-tab-id-0b7b2321893f367c17376ba1b5878987 data-tab-item=R-tab-ee97be03cb04119af45014d815621ce1 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~ <span class=o>&amp;&amp;</span> ls</span></span></code></pre></div></div></div><div id=R-tab-id-b137f5bedd8ef249b521fe2f9090e4fc data-tab-item=R-tab-29c2c02a361c9d7028472e5d92cd4a54 class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>o11y-lambda-lab</span></span></code></pre></div></div></div></div></div><details open class="box cstyle notices note"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-exclamation-circle"></i>
Note</summary><div class=box-content><p>If you don&rsquo;t see it, fetch the lab contents by running the following command:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone https://github.com/kdroukman/o11y-lambda-lab.git</span></span></code></pre></div></div></details><h2 id=set-environment-variables>Set Environment Variables<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>In your Splunk Observability Cloud Organisation (Org) obtain your Access Token and Realm Values.</p><p>Please reset your environment variables from the earlier lab. Take care that for this lab we may be using different names - make sure to match the Environment Variable names below.</p><div class=tab-panel data-tab-group=R-tabs-3429ae7d7545467e6039c5404de73cf0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-84c67af09eff1667e0ab0f3fd552600f aria-expanded=true data-tab-item=R-tab-f5a9608bf07a7e3aa3cf7c4bba847093 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-3429ae7d7545467e6039c5404de73cf0","R-tab-f5a9608bf07a7e3aa3cf7c4bba847093")'>
<span class=tab-nav-text>Export Environment Variables</span></button></div><div class=tab-content-container><div id=R-tab-id-84c67af09eff1667e0ab0f3fd552600f data-tab-item=R-tab-f5a9608bf07a7e3aa3cf7c4bba847093 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>export ACCESS_TOKEN</span><span class=o>=</span><span class=s>CHANGE_ME \</span>
</span></span><span class=line><span class=cl><span class=na>export REALM</span><span class=o>=</span><span class=s>CHANGE_ME \</span>
</span></span><span class=line><span class=cl><span class=na>export PREFIX</span><span class=o>=</span><span class=s>$INSTANCE</span></span></span></code></pre></div></div></div></div></div><h2 id=update-auto-instrumentation-serverless-template>Update Auto-instrumentation serverless template<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Update your auto-instrumentation Serverless template to include new values from the Enviornment variables.</p><div class=tab-panel data-tab-group=R-tabs-26fdfac3cf9d9a53d329d10b63243c82><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-17fcb489d3fa93c213de4282a797345a aria-expanded=true data-tab-item=R-tab-b6996505d36254c1f558b8bd39750c7e class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-26fdfac3cf9d9a53d329d10b63243c82","R-tab-b6996505d36254c1f558b8bd39750c7e")'>
<span class=tab-nav-text>Substitute Environment Variables</span></button></div><div class=tab-content-container><div id=R-tab-id-17fcb489d3fa93c213de4282a797345a data-tab-item=R-tab-b6996505d36254c1f558b8bd39750c7e class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/o11y-lambda-lab/auto/serverless_unset.yml <span class=p>|</span> envsubst &gt; ~/o11y-lambda-lab/auto/serverless.yml</span></span></code></pre></div></div></div></div></div><p>Examine the output of the updated serverless.yml contents (you may need to scroll up to the relevant section).</p><div class=tab-panel data-tab-group=R-tabs-4ba49ef0942fda46fc4b4dc958b7a43a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-205dc7d78e361d0e20147a25de6a5410 aria-expanded=true data-tab-item=R-tab-5c2a6230c56f72bddbffa681cc579ff0 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-4ba49ef0942fda46fc4b4dc958b7a43a","R-tab-5c2a6230c56f72bddbffa681cc579ff0")'>
<span class=tab-nav-text>Check file contents</span>
</button>
<button aria-controls=R-tab-id-d4b8fee38e0b1895a301b541570c5995 aria-expanded=false data-tab-item=R-tab-ae72dbeb917678c6a8d6aba651fa0517 class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-4ba49ef0942fda46fc4b4dc958b7a43a","R-tab-ae72dbeb917678c6a8d6aba651fa0517")'>
<span class=tab-nav-text>Expected Content</span></button></div><div class=tab-content-container><div id=R-tab-id-205dc7d78e361d0e20147a25de6a5410 data-tab-item=R-tab-5c2a6230c56f72bddbffa681cc579ff0 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/o11y-lambda-lab/auto/serverless.yml</span></span></code></pre></div></div></div><div id=R-tab-id-d4b8fee38e0b1895a301b541570c5995 data-tab-item=R-tab-ae72dbeb917678c6a8d6aba651fa0517 class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># USER SET VALUES =====================              </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>custom</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessToken</span><span class=p>:</span><span class=w> </span><span class=l>&lt;updated to your Access Token&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>realm</span><span class=p>:</span><span class=w> </span><span class=l>&lt;updated to your Realm&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prefix</span><span class=p>:</span><span class=w> </span><span class=l>&lt;updated to your Hostname&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#====================================== </span></span></span></code></pre></div></div></div></div></div><h2 id=update-manual-instrumentation-template>Update Manual instrumentation template<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Update your manual instrumentation Serverless template to include new values from the Enviornment variables.</p><div class=tab-panel data-tab-group=R-tabs-0957aae5dbd06bddd2ffcc08938644de><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-7e84e3070495af0b4ee45e4d1a8a6bb4 aria-expanded=true data-tab-item=R-tab-b6996505d36254c1f558b8bd39750c7e class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-0957aae5dbd06bddd2ffcc08938644de","R-tab-b6996505d36254c1f558b8bd39750c7e")'>
<span class=tab-nav-text>Substitute Environment Variables</span></button></div><div class=tab-content-container><div id=R-tab-id-7e84e3070495af0b4ee45e4d1a8a6bb4 data-tab-item=R-tab-b6996505d36254c1f558b8bd39750c7e class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/o11y-lambda-lab/manual/serverless_unset.yml <span class=p>|</span> envsubst &gt; ~/o11y-lambda-lab/manual/serverless.yml</span></span></code></pre></div></div></div></div></div><p>Examine the output of the updated serverless.yml contents (you may need to scroll up to the relevant section).</p><div class=tab-panel data-tab-group=R-tabs-389061bb5fbfa33d0344233f12067816><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-abc3850dc7df578e8b16720141bc6e77 aria-expanded=true data-tab-item=R-tab-5c2a6230c56f72bddbffa681cc579ff0 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-389061bb5fbfa33d0344233f12067816","R-tab-5c2a6230c56f72bddbffa681cc579ff0")'>
<span class=tab-nav-text>Check file contents</span>
</button>
<button aria-controls=R-tab-id-552d53f456517d745f2762f91a7261fb aria-expanded=false data-tab-item=R-tab-ae72dbeb917678c6a8d6aba651fa0517 class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-389061bb5fbfa33d0344233f12067816","R-tab-ae72dbeb917678c6a8d6aba651fa0517")'>
<span class=tab-nav-text>Expected Content</span></button></div><div class=tab-content-container><div id=R-tab-id-abc3850dc7df578e8b16720141bc6e77 data-tab-item=R-tab-5c2a6230c56f72bddbffa681cc579ff0 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/o11y-lambda-lab/manual/serverless.yml</span></span></code></pre></div></div></div><div id=R-tab-id-552d53f456517d745f2762f91a7261fb data-tab-item=R-tab-ae72dbeb917678c6a8d6aba651fa0517 class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># USER SET VALUES =====================              </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>custom</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessToken</span><span class=p>:</span><span class=w> </span><span class=l>&lt;updated to your Access Token&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>realm</span><span class=p>:</span><span class=w> </span><span class=l>&lt;updated to your Realm&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prefix</span><span class=p>:</span><span class=w> </span><span class=l>&lt;updated to your Hostname&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#====================================== </span></span></span></code></pre></div></div></div></div></div><h2 id=set-your-aws-credentials>Set your AWS Credentials<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>You will be provided with AWS Access Key ID and AWS Secret Access Key values - substitue these values in place of AWS_ACCESS_KEY_ID and AWS_ACCESS_KEY_SECRET in the bellow command:</p><div class=tab-panel data-tab-group=R-tabs-23aec1b7a15dce7f9b119a746941a63a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-b9e9a1a7a34884a217f8577b1897762a aria-expanded=true data-tab-item=R-tab-5df97bd56f53a7aacc35ddc93d844bd0 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-23aec1b7a15dce7f9b119a746941a63a","R-tab-5df97bd56f53a7aacc35ddc93d844bd0")'>
<span class=tab-nav-text>Set AWS Credentials</span></button></div><div class=tab-content-container><div id=R-tab-id-b9e9a1a7a34884a217f8577b1897762a data-tab-item=R-tab-5df97bd56f53a7aacc35ddc93d844bd0 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sls config credentials --provider aws --key AWS_ACCCESS_KEY_ID --secret AWS_ACCESS_KEY_SECRET</span></span></code></pre></div></div></div></div></div><p>This command will create a file <code>~/.aws/credentials</code> with your AWS Credentials populated.</p><p>Note that we are using sls here, which is a Serverless framework for developing and deploying AWS Lambda functions. We will be using this command throughout the lab.</p><p>Now you are set up and ready go!</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=auto-instrumentation>Auto-Instrumentation</h1><h2 id=auto-instrumentation>Auto-Instrumentation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Navigate to the auto directory that contains auto-instrumentation code.</p><div class=tab-panel data-tab-group=R-tabs-63975a89bd0e0755dc78d13b0292f3c7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-70e4d90f92b2a45071673ee766051042 aria-expanded=true data-tab-item=R-tab-ee97be03cb04119af45014d815621ce1 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-63975a89bd0e0755dc78d13b0292f3c7","R-tab-ee97be03cb04119af45014d815621ce1")'>
<span class=tab-nav-text>Command</span></button></div><div class=tab-content-container><div id=R-tab-id-70e4d90f92b2a45071673ee766051042 data-tab-item=R-tab-ee97be03cb04119af45014d815621ce1 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>cd ~/o11y-lambda-lab/auto</code></pre></div></div></div></div></div><p>Inspect the contents of the files in this directory. Take a look at the serverless.yml template.</p><div class=tab-panel data-tab-group=R-tabs-5d5c64bd6bd7b78946d4bde9d07f522c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-46aec6904611498c58825d446f8ab391 aria-expanded=true data-tab-item=R-tab-ee97be03cb04119af45014d815621ce1 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-5d5c64bd6bd7b78946d4bde9d07f522c","R-tab-ee97be03cb04119af45014d815621ce1")'>
<span class=tab-nav-text>Command</span></button></div><div class=tab-content-container><div id=R-tab-id-46aec6904611498c58825d446f8ab391 data-tab-item=R-tab-ee97be03cb04119af45014d815621ce1 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>cat serverless.yml</code></pre></div></div></div></div></div><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><ul><li>Can you identify which AWS entities are being created by this template?</li><li>Can you identify where OpenTelemetry instrumentation is being set up?</li><li>Can you determine which instrumentation information is being provided by the Environment Variables?</li></ul></div></details><p>You should see the Splunk OpenTelemetry Lambda layer being added to each fuction.</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>layers:
      - arn:aws:lambda:us-east-1:254067382080:layer:splunk-apm:70</code></pre></div><p>You can see the relevant layer ARNs (Amazon Resource Name) and latest versions for each AWS region here: <a href=https://github.com/signalfx/lambda-layer-versions/blob/main/splunk-apm/splunk-apm.md rel=external>https://github.com/signalfx/lambda-layer-versions/blob/main/splunk-apm/splunk-apm.md</a></p><p>You should also see a section where the Environment variables that are being set.</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>environment:
  AWS_LAMBDA_EXEC_WRAPPER: /opt/nodejs-otel-handler
  OTEL_RESOURCE_ATTRIBUTES: deployment.environment=${self:custom.prefix}-apm-lambda
  OTEL_SERVICE_NAME: consumer-lambda
  SPLUNK_ACCESS_TOKEN: ${self:custom.accessToken}
  SPLUNK_REALM: ${self:custom.realm}</code></pre></div><p>Using the environment variables we are configuring and enriching our auto-instrumentation.</p><p>Here we provide minimum information, such as NodeJS wrapper location in the Splunk APM Layer, environment name, service name, and our Splunk Org credentials. We are sending trace data directly to Splunk Observability Cloud. You could alternatively export traces to an OpenTelemetry Collector set up in Gateway mode.</p><p>Take a look at the function code.</p><div class=tab-panel data-tab-group=R-tabs-7322799fe7e7c9500bf0997ccd15b034><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-5452a0d3c50c5e9216c6c9715dc66b29 aria-expanded=true data-tab-item=R-tab-ee97be03cb04119af45014d815621ce1 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-7322799fe7e7c9500bf0997ccd15b034","R-tab-ee97be03cb04119af45014d815621ce1")'>
<span class=tab-nav-text>Command</span></button></div><div class=tab-content-container><div id=R-tab-id-5452a0d3c50c5e9216c6c9715dc66b29 data-tab-item=R-tab-ee97be03cb04119af45014d815621ce1 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>cat handler.js</code></pre></div></div></div></div></div><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><ul><li>Can you identify the code for producer function?</li><li>Can you identify the code for consumer function?</li></ul></div></details><p>Notice there is no mention of Splunk or OpenTelemetry in the code. We are adding the instrumentation using the Lambda layer and Environment Variables only.</p><h2 id=deploy-your-lambdas>Deploy your Lambdas<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Run the following command to deploy your Lambda Functions:</p><div class=tab-panel data-tab-group=R-tabs-e78c7f0e0b5357f978543c9f4e12ce2d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-6d69bec243f84403daccd51df3e86ef9 aria-expanded=true data-tab-item=R-tab-78a8e5ef80384303f31396739e4d1109 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-e78c7f0e0b5357f978543c9f4e12ce2d","R-tab-78a8e5ef80384303f31396739e4d1109")'>
<span class=tab-nav-text>Deploy Command</span>
</button>
<button aria-controls=R-tab-id-8b7206ff38c69ddd5866a828bb7ee1d9 aria-expanded=false data-tab-item=R-tab-324f6ca1444bddd49ddfc55e21de1113 class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-e78c7f0e0b5357f978543c9f4e12ce2d","R-tab-324f6ca1444bddd49ddfc55e21de1113")'>
<span class=tab-nav-text>Expected Output</span></button></div><div class=tab-content-container><div id=R-tab-id-6d69bec243f84403daccd51df3e86ef9 data-tab-item=R-tab-78a8e5ef80384303f31396739e4d1109 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>sls deploy</code></pre></div></div></div><div id=R-tab-id-8b7206ff38c69ddd5866a828bb7ee1d9 data-tab-item=R-tab-324f6ca1444bddd49ddfc55e21de1113 class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>Deploying hostname-lambda-lab to stage dev (us-east-1)
...
...
endpoint: POST - https://randomstring.execute-api.us-east-1.amazonaws.com/dev/producer
functions:
  producer: hostname-lambda-lab-dev-producer (1.6 kB)
  consumer: hostname-lambda-lab-dev-consumer (1.6 kB)</code></pre></div></div></div></div></div><p>This command will follow the instructions in your serverless.yml template to create your Lambda functions and your Kinesis stream. Note it may take a 1-2 minutes to execute.</p><details open class="box cstyle notices note"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-exclamation-circle"></i>
Note</summary><div class=box-content>serverless.yml is in fact a CloudFormation template. CloudFormation is an infrastructure as code service from AWS. You can read more about it here - <a href=https://aws.amazon.com/cloudformation/ rel=external>https://aws.amazon.com/cloudformation/</a></div></details><p>Check the details of your serverless functions:</p><div class=tab-panel data-tab-group=R-tabs-9e5556b14388d34fe87b8452558731f5><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-f0d6365de22cba9bcee0c0414f2c50bb aria-expanded=true data-tab-item=R-tab-ee97be03cb04119af45014d815621ce1 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-9e5556b14388d34fe87b8452558731f5","R-tab-ee97be03cb04119af45014d815621ce1")'>
<span class=tab-nav-text>Command</span></button></div><div class=tab-content-container><div id=R-tab-id-f0d6365de22cba9bcee0c0414f2c50bb data-tab-item=R-tab-ee97be03cb04119af45014d815621ce1 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>sls info</code></pre></div></div></div></div></div><p>Take note of your endpoint value:
<a href=#R-image-5cc2d3d60efee8f29e88858c982f588d class=lightbox-link><img alt=2-auto-1-endpoint-value class="lazy lightbox figure-image" loading=lazy src=../images/2-auto-1-endpoint-value.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5cc2d3d60efee8f29e88858c982f588d><img alt=2-auto-1-endpoint-value class="lazy lightbox lightbox-image" loading=lazy src=../images/2-auto-1-endpoint-value.png></a></p><h2 id=send-some-traffic>Send some Traffic<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Use the curl command to send a payload to your producer function. Note the command option -d is followed by your message payload.</p><p>Try changing the value of name to your name and telling the Lambda function about your superpower. Replace YOUR_ENDPOINT with the endpoint from your previous step.</p><div class=tab-panel data-tab-group=R-tabs-d6ac84b1aebe3fedb8c7e048cbbac79d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-14fe7508064a1afafbb30487d3330285 aria-expanded=true data-tab-item=R-tab-ee97be03cb04119af45014d815621ce1 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-d6ac84b1aebe3fedb8c7e048cbbac79d","R-tab-ee97be03cb04119af45014d815621ce1")'>
<span class=tab-nav-text>Command</span></button></div><div class=tab-content-container><div id=R-tab-id-14fe7508064a1afafbb30487d3330285 data-tab-item=R-tab-ee97be03cb04119af45014d815621ce1 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>curl -d &#39;{ &#34;name&#34;: &#34;CHANGE_ME&#34;, &#34;superpower&#34;: &#34;CHANGE_ME&#34; }&#39; YOUR_ENDPOINT</code></pre></div></div></div></div></div><p>For example:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>curl -d &#39;{ &#34;name&#34;: &#34;Kate&#34;, &#34;superpower&#34;: &#34;Distributed Tracing&#34; }&#39; https://xvq043lj45.execute-api.us-east-1.amazonaws.com/dev/producer</code></pre></div><p>You should see the following output if your message is successful:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>{&#34;message&#34;:&#34;Message placed in the Event Stream: hostname-eventSteam&#34;}</code></pre></div><p>If unsuccessful, you will see:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>{&#34;message&#34;: &#34;Internal server error&#34;}</code></pre></div><p>If this occurs, ask one of the lab facilitators for assistance.</p><p>If you see a success message, generate more load: re-send that messate 5+ times. You should keep seeing a success message after each send.</p><p>Check the lambda logs output:</p><p>Producer function logs:</p><div class=tab-panel data-tab-group=R-tabs-a981d7137d58c30060df5171903e45dd><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-5b1d92ab2d60c155c4e47e1aaa2df3c7 aria-expanded=true data-tab-item=R-tab-61d566b4fa1db37b3cab62ea4ed9002d class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-a981d7137d58c30060df5171903e45dd","R-tab-61d566b4fa1db37b3cab62ea4ed9002d")'>
<span class=tab-nav-text>Producer Function Logs</span></button></div><div class=tab-content-container><div id=R-tab-id-5b1d92ab2d60c155c4e47e1aaa2df3c7 data-tab-item=R-tab-61d566b4fa1db37b3cab62ea4ed9002d class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>sls logs -f producer</code></pre></div></div></div></div></div><p>Consumer function logs:</p><div class=tab-panel data-tab-group=R-tabs-9f45754442544cd2d59e107dc56fe0cc><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-c523eee1c4c85e24e3ec2f2f51af93b3 aria-expanded=true data-tab-item=R-tab-2f56cc025faeef811cb06788ec1866ab class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-9f45754442544cd2d59e107dc56fe0cc","R-tab-2f56cc025faeef811cb06788ec1866ab")'>
<span class=tab-nav-text>Consumer Function Logs</span></button></div><div class=tab-content-container><div id=R-tab-id-c523eee1c4c85e24e3ec2f2f51af93b3 data-tab-item=R-tab-2f56cc025faeef811cb06788ec1866ab class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>sls logs -f consumer</code></pre></div></div></div></div></div><p>Examine the logs carefully.</p><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><p>Do you see OpenTelemetry being loaded? Look out for lines with splunk-extension-wrapper.</p></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=lambdas-in-splunk-apm>Lambdas in Splunk APM</h1><h2 id=lambdas-in-splunk-apm>Lambdas in Splunk APM<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Now it&rsquo;s time to check how your Lambda traffic has been captured in Splunk APM.</p><h2 id=navigate-to-your-splunk-observability-cloud>Navigate to your Splunk Observability Cloud<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Select APM from the Main Menu and then select your APM Environment. Your APM environment should be in the format <code>$INSTANCE-apm-lambda</code> where the hostname value is a four letter name of your lab host. (Check it by looking at your command prompt, or by running <code>echo $INSTANCE</code>).</p><details open class="box cstyle notices note"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-exclamation-circle"></i>
Note</summary><div class=box-content>It may take a few minutes for you traces to appear in Splunk APM. Try hitting refresh on your browser until you find your environement name in the list of Envrionments</div></details><p><a href=#R-image-1d13ccb30ea66dbb924ba8ce9cfa7446 class=lightbox-link><img alt=3-splunk-1-filter class="lazy lightbox figure-image" loading=lazy src=../images/3-splunk-1-filter.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-1d13ccb30ea66dbb924ba8ce9cfa7446><img alt=3-splunk-1-filter class="lazy lightbox lightbox-image" loading=lazy src=../images/3-splunk-1-filter.png></a></p><p>Go to <code>Explore</code> the Service Map to see the Dependencies between your Lambda Functions.</p><p><a href=#R-image-7fc03bcce2d4ed3e7d4c473d0b76d10d class=lightbox-link><img alt=3-splunk-2-explore class="lazy lightbox figure-image" loading=lazy src=../images/3-splunk-2-explore.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-7fc03bcce2d4ed3e7d4c473d0b76d10d><img alt=3-splunk-2-explore class="lazy lightbox lightbox-image" loading=lazy src=../images/3-splunk-2-explore.png></a></p><p>You should be able to see the <code>producer-lambda</code> and the call it is making to <code>Kinesis</code> service.</p><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><p>What about your <code>consumer-lambda</code>?</p></div></details><p><a href=#R-image-41ca9d2130d34d2df1d35317675cea45 class=lightbox-link><img alt=3-splunk-3-map-producer class="lazy lightbox figure-image" loading=lazy src=../images/3-splunk-3-map-producer.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-41ca9d2130d34d2df1d35317675cea45><img alt=3-splunk-3-map-producer class="lazy lightbox lightbox-image" loading=lazy src=../images/3-splunk-3-map-producer.png></a></p><p>Click into <code>Traces</code> and examine some traces that container procuder function calls and traces with consumer function calls.</p><p><a href=#R-image-ca7660930ee34192c3919dbfce328c90 class=lightbox-link><img alt=3-splunk-4-trace-producer.png class="lazy lightbox figure-image" loading=lazy src=../images/3-splunk-4-trace-producer.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ca7660930ee34192c3919dbfce328c90><img alt=3-splunk-4-trace-producer.png class="lazy lightbox lightbox-image" loading=lazy src=../images/3-splunk-4-trace-producer.png></a></p><p>We can see the <code>producer-lambda</code> putting a Record on the Kinesis stream. But the action of <code>consumer-function</code> is disconnected!</p><p>This is because the Trace Context is not being propagated.</p><p>This is not something that is supported automatically Out-of-the-Box by Kinesis service at the time of this lab. Our Distributed Trace stops at Kinesis inferred service, and we can&rsquo;t see the propagation any further.</p><p>Not yet&mldr;</p><p>Let&rsquo;s see how we work around this in the next section of this lab.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=manual-instrumentation>Manual Instrumentation</h1><h2 id=manual-instrumentation>Manual Instrumentation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Navigate to the manual directory that contains manually instrumentated code.</p><div class=tab-panel data-tab-group=R-tabs-747ac8baf6f9bcf7773a157826469fab><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-2600edef86433eebad7d4f57e28b1685 aria-expanded=true data-tab-item=R-tab-ee97be03cb04119af45014d815621ce1 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-747ac8baf6f9bcf7773a157826469fab","R-tab-ee97be03cb04119af45014d815621ce1")'>
<span class=tab-nav-text>Command</span></button></div><div class=tab-content-container><div id=R-tab-id-2600edef86433eebad7d4f57e28b1685 data-tab-item=R-tab-ee97be03cb04119af45014d815621ce1 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-lab/manual</span></span></code></pre></div></div></div></div></div><p>Inspect the contents of the files in this directory. Take a look at the serverless.yml template.</p><div class=tab-panel data-tab-group=R-tabs-175a051d1b5c15f2e16aae845998e306><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-234bc1352ae47f6c808e3fe5e8d43c99 aria-expanded=true data-tab-item=R-tab-ee97be03cb04119af45014d815621ce1 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-175a051d1b5c15f2e16aae845998e306","R-tab-ee97be03cb04119af45014d815621ce1")'>
<span class=tab-nav-text>Command</span></button></div><div class=tab-content-container><div id=R-tab-id-234bc1352ae47f6c808e3fe5e8d43c99 data-tab-item=R-tab-ee97be03cb04119af45014d815621ce1 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat serverless.yml</span></span></code></pre></div></div></div></div></div><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><p>Do you see any difference from the same file in your auto directory?</p></div></details><p>You can try to compare them with a diff command:</p><div class=tab-panel data-tab-group=R-tabs-76368bda9c6d5a177d21f07d8c48e294><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-e3fa611c1ec30d950d39ca7ad4d92fbe aria-expanded=true data-tab-item=R-tab-3022c8fcf21316271d57f743964c1cbc class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-76368bda9c6d5a177d21f07d8c48e294","R-tab-3022c8fcf21316271d57f743964c1cbc")'>
<span class=tab-nav-text>Diff Command</span>
</button>
<button aria-controls=R-tab-id-0f8eee6ae158ece491eb63084e51ca9b aria-expanded=false data-tab-item=R-tab-324f6ca1444bddd49ddfc55e21de1113 class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-76368bda9c6d5a177d21f07d8c48e294","R-tab-324f6ca1444bddd49ddfc55e21de1113")'>
<span class=tab-nav-text>Expected Output</span></button></div><div class=tab-content-container><div id=R-tab-id-e3fa611c1ec30d950d39ca7ad4d92fbe data-tab-item=R-tab-3022c8fcf21316271d57f743964c1cbc class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>diff ~/o11y-lambda-lab/auto/serverless.yml ~/o11y-lambda-lab/manual/serverless.yml </span></span></code></pre></div></div></div><div id=R-tab-id-0f8eee6ae158ece491eb63084e51ca9b data-tab-item=R-tab-324f6ca1444bddd49ddfc55e21de1113 class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>19c19
</span></span><span class=line><span class=cl>&lt; #======================================    
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>&gt; #======================================   </span></span></code></pre></div></div></div></div></div><p>There is no difference! (Well, there shouldn&rsquo;t be. Ask your lab facilitator to assist you if there is)</p><p>Now compare handler.js it with the same file in auto directory using the diff command:</p><div class=tab-panel data-tab-group=R-tabs-8751223477b5d50e22b88e3a10b9cfb8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-de5b0b7b45240dbe28a2fcbf56794d22 aria-expanded=true data-tab-item=R-tab-3022c8fcf21316271d57f743964c1cbc class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-8751223477b5d50e22b88e3a10b9cfb8","R-tab-3022c8fcf21316271d57f743964c1cbc")'>
<span class=tab-nav-text>Diff Command</span></button></div><div class=tab-content-container><div id=R-tab-id-de5b0b7b45240dbe28a2fcbf56794d22 data-tab-item=R-tab-3022c8fcf21316271d57f743964c1cbc class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>diff ~/o11y-lambda-lab/auto/handler.js ~/o11y-lambda-lab/manual/handler.js </span></span></code></pre></div></div></div></div></div><p>Look at all these differences!</p><p>You may wish to view the entire file with <code>cat handler.js</code> command and examine its content.</p><p>Notice how we are now importing some OpenTelemetry libraries directly into our function to handle some of the manual instrumenation tasks we require.</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>otelapi</span>  <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;@opentelemetry/api&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>otelcore</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;@opentelemetry/core&#39;</span><span class=p>);</span></span></span></code></pre></div><p>We are using <a href=https://www.npmjs.com/package/@opentelemetry/api rel=external>https://www.npmjs.com/package/@opentelemetry/api</a> to manipulate the tracing logic in our functions. We are using <a href=https://www.npmjs.com/package/@opentelemetry/core rel=external>https://www.npmjs.com/package/@opentelemetry/core</a> to access the Propagator objects that we will use to manually propagate our context with.</p><h2 id=inject-trace-context-in-producer-function>Inject Trace Context in Producer Function<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The below code executes the following steps inside the Producer function:</p><ol><li>Get the current Active Span.</li><li>Create a Propagator.</li><li>Initialize a context carrier object.</li><li>Inject the context of the active span into the carrier object.</li><li>Modify the record we are about to put on our Kinesis stream to include the carrier that will carry the active span&rsquo;s context to the consumer.</li></ol><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>activeSpan</span> <span class=o>=</span> <span class=nx>otelapi</span><span class=p>.</span><span class=nx>trace</span><span class=p>.</span><span class=nx>getSpan</span><span class=p>(</span><span class=nx>otelapi</span><span class=p>.</span><span class=nx>context</span><span class=p>.</span><span class=nx>active</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>propagator</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>otelcore</span><span class=p>.</span><span class=nx>W3CTraceContextPropagator</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>carrier</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl><span class=nx>propagator</span><span class=p>.</span><span class=nx>inject</span><span class=p>(</span><span class=nx>otelapi</span><span class=p>.</span><span class=nx>trace</span><span class=p>.</span><span class=nx>setSpanContext</span><span class=p>(</span><span class=nx>otelapi</span><span class=p>.</span><span class=nx>ROOT_CONTEXT</span><span class=p>,</span> <span class=nx>activeSpan</span><span class=p>.</span><span class=nx>spanContext</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>    <span class=nx>carrier</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>otelapi</span><span class=p>.</span><span class=nx>defaultTextMapSetter</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>data</span> <span class=o>=</span> <span class=s2>&#34;{\&#34;tracecontext\&#34;: &#34;</span> <span class=o>+</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>carrier</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34;, \&#34;record\&#34;:&#34;</span> <span class=o>+</span> <span class=nx>event</span><span class=p>.</span><span class=nx>body</span> <span class=o>+</span> <span class=s2>&#34;}&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`Record with Trace Context added: 
</span></span></span><span class=line><span class=cl><span class=sb>  </span><span class=si>${</span><span class=nx>data</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span></span></span></code></pre></div><h2 id=extract-trace-context-in-consumer-function>Extract Trace Context in Consumer Function<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The bellow code executes the following steps inside the Consumer function:</p><ol><li>Extract the context that we obtained from the Producer into a carrier object.</li><li>Create a Propagator.</li><li>Extract the context from the carrier object in Customer function&rsquo;s parent span context.</li><li>Start a new span with the parent span context.</li><li>Bonus: Add extra attributes to your span, including custom ones with the values from your message!</li><li>Once completed, end the span.</li></ol><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>carrier</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span> <span class=nx>message</span> <span class=p>).</span><span class=nx>tracecontext</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>propagator</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>otelcore</span><span class=p>.</span><span class=nx>W3CTraceContextPropagator</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>parentContext</span> <span class=o>=</span> <span class=nx>propagator</span><span class=p>.</span><span class=nx>extract</span><span class=p>(</span><span class=nx>otelapi</span><span class=p>.</span><span class=nx>ROOT_CONTEXT</span><span class=p>,</span> <span class=nx>carrier</span><span class=p>,</span> <span class=nx>otelapi</span><span class=p>.</span><span class=nx>defaultTextMapGetter</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>tracer</span> <span class=o>=</span> <span class=nx>otelapi</span><span class=p>.</span><span class=nx>trace</span><span class=p>.</span><span class=nx>getTracer</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>OTEL_SERVICE_NAME</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>span</span> <span class=o>=</span> <span class=nx>tracer</span><span class=p>.</span><span class=nx>startSpan</span><span class=p>(</span><span class=s2>&#34;Kinesis.getRecord&#34;</span><span class=p>,</span> <span class=kc>undefined</span><span class=p>,</span> <span class=nx>parentContext</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                         
</span></span><span class=line><span class=cl><span class=nx>span</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s2>&#34;span.kind&#34;</span><span class=p>,</span> <span class=s2>&#34;server&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>body</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span> <span class=nx>message</span> <span class=p>).</span><span class=nx>record</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>body</span><span class=p>.</span><span class=nx>name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>span</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s2>&#34;custom.tag.name&#34;</span><span class=p>,</span> <span class=nx>body</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=p>(</span><span class=nx>body</span><span class=p>.</span><span class=nx>superpower</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>span</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s2>&#34;custom.tag.superpower&#34;</span><span class=p>,</span> <span class=nx>body</span><span class=p>.</span><span class=nx>superpower</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=o>---</span> <span class=kd>function</span> <span class=nx>does</span> <span class=nx>some</span> <span class=nx>work</span>
</span></span><span class=line><span class=cl> <span class=nx>span</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span></span></span></code></pre></div><p>Now let&rsquo;s see the difference this makes.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=redeploy-lambdas>Redeploy Lambdas</h1><h2 id=re-deploy-your-lambdas>Re-deploy your Lambdas<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>While remaining in your manual directory, run the following commandd to re-deploy your Lambda Functions:</p><div class=tab-panel data-tab-group=R-tabs-6082ebc97f2d238753816689a93fdc32><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-49a78cfda66cfa323132db9a353cfb7e aria-expanded=true data-tab-item=R-tab-4c731a9ae67b620023bce641ba65a97c class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-6082ebc97f2d238753816689a93fdc32","R-tab-4c731a9ae67b620023bce641ba65a97c")'>
<span class=tab-nav-text>Deploy Producer Code</span>
</button>
<button aria-controls=R-tab-id-672be05417ce3697df64df810c5d7949 aria-expanded=false data-tab-item=R-tab-324f6ca1444bddd49ddfc55e21de1113 class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-6082ebc97f2d238753816689a93fdc32","R-tab-324f6ca1444bddd49ddfc55e21de1113")'>
<span class=tab-nav-text>Expected Output</span></button></div><div class=tab-content-container><div id=R-tab-id-49a78cfda66cfa323132db9a353cfb7e data-tab-item=R-tab-4c731a9ae67b620023bce641ba65a97c class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sls deploy -f producer</span></span></code></pre></div></div></div><div id=R-tab-id-672be05417ce3697df64df810c5d7949 data-tab-item=R-tab-324f6ca1444bddd49ddfc55e21de1113 class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Deploying function producer to stage dev (us-east-1)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>âœ” Function code deployed (6s)
</span></span><span class=line><span class=cl>Configuration did not change. Configuration update skipped. (6s)</span></span></code></pre></div></div></div></div></div><div class=tab-panel data-tab-group=R-tabs-5d5e37ced87229e18071ccdb6fe3bae6><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-e01c16c1d74157b0916b6c7128e615a0 aria-expanded=true data-tab-item=R-tab-1ac89110602f5f86c8277e90608754e7 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-5d5e37ced87229e18071ccdb6fe3bae6","R-tab-1ac89110602f5f86c8277e90608754e7")'>
<span class=tab-nav-text>Deploy Consumer Code</span>
</button>
<button aria-controls=R-tab-id-fcf61ac73e34786fe3ea04ded1926268 aria-expanded=false data-tab-item=R-tab-324f6ca1444bddd49ddfc55e21de1113 class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-5d5e37ced87229e18071ccdb6fe3bae6","R-tab-324f6ca1444bddd49ddfc55e21de1113")'>
<span class=tab-nav-text>Expected Output</span></button></div><div class=tab-content-container><div id=R-tab-id-e01c16c1d74157b0916b6c7128e615a0 data-tab-item=R-tab-1ac89110602f5f86c8277e90608754e7 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sls deploy -f consumer</span></span></code></pre></div></div></div><div id=R-tab-id-fcf61ac73e34786fe3ea04ded1926268 data-tab-item=R-tab-324f6ca1444bddd49ddfc55e21de1113 class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Deploying function consumer to stage dev (us-east-1)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>âœ” Function code deployed (6s)
</span></span><span class=line><span class=cl>Configuration did not change. Configuration update skipped. (6s)</span></span></code></pre></div></div></div></div></div><p>Note that this deployment now only updates the code changes within the function. Our configuration remains the same.</p><p>Check the details of your serverless functions:</p><div class=tab-panel data-tab-group=R-tabs-de15742369ac2b22b2c18aaf968748d0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-62301d54a4061047afeeda6917821dbc aria-expanded=true data-tab-item=R-tab-ee97be03cb04119af45014d815621ce1 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-de15742369ac2b22b2c18aaf968748d0","R-tab-ee97be03cb04119af45014d815621ce1")'>
<span class=tab-nav-text>Command</span></button></div><div class=tab-content-container><div id=R-tab-id-62301d54a4061047afeeda6917821dbc data-tab-item=R-tab-ee97be03cb04119af45014d815621ce1 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sls info</span></span></code></pre></div></div></div></div></div><p>You endpoint value should remain the same:</p><p><a href=#R-image-4003e72ea7ed8edc5e01e9dd7883b4ce class=lightbox-link><img alt=5-redeploy-1-endpoint-value class="lazy lightbox figure-image" loading=lazy src=../images/5-redeploy-1-endpoint-value.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-4003e72ea7ed8edc5e01e9dd7883b4ce><img alt=5-redeploy-1-endpoint-value class="lazy lightbox lightbox-image" loading=lazy src=../images/5-redeploy-1-endpoint-value.png></a></p><h2 id=send-some-traffic-again>Send some Traffic again<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Use the <code>curl</code> command to send a payload to your producer function. Note the command option <code>-d</code> is followed by your message payload.</p><p>Try changing the value of name to your name and telling the Lambda function about your superpower. Replace <code>YOUR_ENDPOINT</code> with the endpoint from your previous step.</p><div class=tab-panel data-tab-group=R-tabs-ed07c706545c0112e973c104c7251ac9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-21cb05617d0d2ef01e77a95fd1b9039a aria-expanded=true data-tab-item=R-tab-ee97be03cb04119af45014d815621ce1 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-ed07c706545c0112e973c104c7251ac9","R-tab-ee97be03cb04119af45014d815621ce1")'>
<span class=tab-nav-text>Command</span></button></div><div class=tab-content-container><div id=R-tab-id-21cb05617d0d2ef01e77a95fd1b9039a data-tab-item=R-tab-ee97be03cb04119af45014d815621ce1 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -d <span class=s1>&#39;{ &#34;name&#34;: &#34;CHANGE_ME&#34;, &#34;superpower&#34;: &#34;CHANGE_ME&#34; }&#39;</span> YOUR_ENDPOINT</span></span></code></pre></div></div></div></div></div><p>For example:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -d <span class=s1>&#39;{ &#34;name&#34;: &#34;Kate&#34;, &#34;superpower&#34;: &#34;Distributed Tracing&#34; }&#39;</span> https://xvq043lj45.execute-api.us-east-1.amazonaws.com/dev/producer</span></span></code></pre></div><p>You should see the following output if your message is successful:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;message&#34;</span><span class=p>:</span><span class=s2>&#34;Message placed in the Event Stream: hostname-eventSteam&#34;</span><span class=p>}</span></span></span></code></pre></div><p>If unsuccessful, you will see:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Internal server error&#34;</span><span class=p>}</span></span></span></code></pre></div><p>If this occurs, ask one of the lab facilitators for assistance.</p><p>If you see a success message, generate more load: re-send that messate 5+ times. You should keep seeing a success message after each send.</p><p>Check the lambda logs output:</p><div class=tab-panel data-tab-group=R-tabs-4dfd13e98a92ec8e0f633a68a352ab4c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-e2f4d2885e999346b51c03032bf3a4a5 aria-expanded=true data-tab-item=R-tab-61d566b4fa1db37b3cab62ea4ed9002d class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-4dfd13e98a92ec8e0f633a68a352ab4c","R-tab-61d566b4fa1db37b3cab62ea4ed9002d")'>
<span class=tab-nav-text>Producer Function Logs</span></button></div><div class=tab-content-container><div id=R-tab-id-e2f4d2885e999346b51c03032bf3a4a5 data-tab-item=R-tab-61d566b4fa1db37b3cab62ea4ed9002d class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sls logs -f producer</span></span></code></pre></div></div></div></div></div><div class=tab-panel data-tab-group=R-tabs-486827eeb807f15f80cd5aaf050dbc02><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-248ddc6c7647327c19c4f08b72969e41 aria-expanded=true data-tab-item=R-tab-2f56cc025faeef811cb06788ec1866ab class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-486827eeb807f15f80cd5aaf050dbc02","R-tab-2f56cc025faeef811cb06788ec1866ab")'>
<span class=tab-nav-text>Consumer Function Logs</span></button></div><div class=tab-content-container><div id=R-tab-id-248ddc6c7647327c19c4f08b72969e41 data-tab-item=R-tab-2f56cc025faeef811cb06788ec1866ab class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sls logs -f consumer</span></span></code></pre></div></div></div></div></div><p>Examine the logs carefully.</p><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><p>Do you notice the difference?</p></div></details><p>Note that we are logging our Record together with the Trace context that we have added to it. Copy one of the underlined sub-sections of your trace parent context, and save it for later.</p><p><a href=#R-image-b32540d41eccf55eadc2d01098c2e087 class=lightbox-link><img alt=5-redeploy-2-logs class="lazy lightbox figure-image" loading=lazy src=../images/5-redeploy-2-logs.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b32540d41eccf55eadc2d01098c2e087><img alt=5-redeploy-2-logs class="lazy lightbox lightbox-image" loading=lazy src=../images/5-redeploy-2-logs.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=updated-lambdas-in-splunk-apm>Updated Lambdas in Splunk APM</h1><p>Navigate back to APM in <a href=https://app.us1.signalfx.com/#/apm rel=external>Splunk Observabilty Cloud</a></p><p>Go back to your Service Dependency map.</p><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><p>Notice the difference?</p></div></details><p><a href=#R-image-2835031650916a5a3d67b03495be2729 class=lightbox-link><img alt=6-updated-1-map class="lazy lightbox figure-image" loading=lazy src=../images/6-updated-1-map.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-2835031650916a5a3d67b03495be2729><img alt=6-updated-1-map class="lazy lightbox lightbox-image" loading=lazy src=../images/6-updated-1-map.png></a></p><p>You should be able to see the <code>consumer-lambda</code> now clearly connected to the <code>producer-lambda</code>.</p><p>Remember the value you copied from your producer logs? You can run <code>sls logs -f consumer</code> command again on your EC2 lab host to fetch one.</p><p>Take that value, and paste it into trace search:</p><p><a href=#R-image-b342cc9a40239db1f6aad25d86c24afc class=lightbox-link><img alt=6-updated-2-trace-search class="lazy lightbox figure-image" loading=lazy src=../images/6-updated-2-trace-search.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b342cc9a40239db1f6aad25d86c24afc><img alt=6-updated-2-trace-search class="lazy lightbox lightbox-image" loading=lazy src=../images/6-updated-2-trace-search.png></a></p><p>Click on Go and you should be able to find the logged Trace:</p><p><a href=#R-image-a8dd9be800efc9bd4d2cd1117536cdaf class=lightbox-link><img alt=6-updated-3-trace class="lazy lightbox figure-image" loading=lazy src=../images/6-updated-3-trace.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-a8dd9be800efc9bd4d2cd1117536cdaf><img alt=6-updated-3-trace class="lazy lightbox lightbox-image" loading=lazy src=../images/6-updated-3-trace.png></a></p><p>Notice that the <code>Trace ID</code> is something that makes up the trace context that we propagated.</p><p>You can read up on the two common propagation standards:</p><ol><li>W3C: <a href=https://www.w3.org/TR/trace-context/#traceparent-header rel=external>https://www.w3.org/TR/trace-context/#traceparent-header</a></li><li>B3: <a href=https://github.com/openzipkin/b3-propagation#overall-process rel=external>https://github.com/openzipkin/b3-propagation#overall-process</a></li></ol><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><p>Which one are we using?</p></div></details><p>It should be self-explanatory from the Propagator we are creating in the Functions</p><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><p>Bonus Question: What happens if we mix and match the W3C and B3 headers?</p></div></details><p>Expand the <code>consumer-lambda</code> span.</p><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
Workshop Question</summary><div class=box-content><p>Can you find the attributes from your message?</p></div></details><p><a href=#R-image-97821f191ba6add83967d2e16fba4224 class=lightbox-link><img alt=6-updated-4-attributes class="lazy lightbox figure-image" loading=lazy src=../images/6-updated-4-attributes.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-97821f191ba6add83967d2e16fba4224><img alt=6-updated-4-attributes class="lazy lightbox lightbox-image" loading=lazy src=../images/6-updated-4-attributes.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article><article class=default><header class=headline></header><h1 id=summary>Summary</h1><h2 id=before-you-go>Before you Go<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Please kindly clean up your lab using the following command:</p><div class=tab-panel data-tab-group=R-tabs-e84171d25b4dd36af07673bd889de269><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-6299206178fe6a68acabdd16cc89348b aria-expanded=true data-tab-item=R-tab-6733a7ea866f3f0ea175c061f1c4a3a1 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-e84171d25b4dd36af07673bd889de269","R-tab-6733a7ea866f3f0ea175c061f1c4a3a1")'>
<span class=tab-nav-text>Remove Functions</span></button></div><div class=tab-content-container><div id=R-tab-id-6299206178fe6a68acabdd16cc89348b data-tab-item=R-tab-6733a7ea866f3f0ea175c061f1c4a3a1 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sls remove</span></span></code></pre></div></div></div></div></div><h2 id=conclusion>Conclusion<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Congratuations on finishing the lab. You have seen how we complement auto-instrumentation with manual steps to force <code>Producer</code> function&rsquo;s context to be sent to <code>Consumer</code> function via a Record put on a Kinesis stream. This allowed us to build the expected Distributed Trace.</p><p><a href=#R-image-3249897ba1f11f93cd3ae8fbc27a857f class=lightbox-link><img alt=7-conclusion-1-architecture class="lazy lightbox figure-image" loading=lazy src=../images/7-conclusion-1-architecture.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-3249897ba1f11f93cd3ae8fbc27a857f><img alt=7-conclusion-1-architecture class="lazy lightbox lightbox-image" loading=lazy src=../images/7-conclusion-1-architecture.png></a></p><p>You can now build out a Trace manually by linking two different functions together. This is very powerful when your auto-instrumenation, or third-party systems, do not support context propagation out of the box.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Sep 19, 2024</span></span></footer></article></section></div></main></div><script src=/observability-workshop/js/perfect-scrollbar/perfect-scrollbar.min.js?1770895853 defer></script><script src=/observability-workshop/js/theme.min.js?1770895853 defer></script><div id=toast-container role=status aria-live=polite aria-atomic=false></div></body></html>