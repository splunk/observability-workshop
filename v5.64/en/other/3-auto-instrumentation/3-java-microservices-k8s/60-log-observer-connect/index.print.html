<!doctype html><html lang=en dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.125.5"><meta name=generator content="Relearn 6.0.0+tip"><meta name=description content="1. Introduction Until this point, we have not touched or changed our code, yet we did receive Trace & Profiling/DB Query performance information. If we want to get more out of our Java application, we can introduce a small change to our application log setup.
This change will configure the Spring PetClinic application to use an Otel-based format to write logs, This will allow the (Auto)-instrumentation to add Otel relevant information into the logs."><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Log Observer :: Splunk Observability Cloud Workshops"><meta name=twitter:description content="1. Introduction Until this point, we have not touched or changed our code, yet we did receive Trace & Profiling/DB Query performance information. If we want to get more out of our Java application, we can introduce a small change to our application log setup.
This change will configure the Spring PetClinic application to use an Otel-based format to write logs, This will allow the (Auto)-instrumentation to add Otel relevant information into the logs."><meta property="og:url" content="https://splunk.github.io/observability-workshop/v5.64/en/other/3-auto-instrumentation/3-java-microservices-k8s/60-log-observer-connect/index.html"><meta property="og:site_name" content="Splunk Observability Cloud Workshops"><meta property="og:title" content="Log Observer :: Splunk Observability Cloud Workshops"><meta property="og:description" content="1. Introduction Until this point, we have not touched or changed our code, yet we did receive Trace & Profiling/DB Query performance information. If we want to get more out of our Java application, we can introduce a small change to our application log setup.
This change will configure the Spring PetClinic application to use an Otel-based format to write logs, This will allow the (Auto)-instrumentation to add Otel relevant information into the logs."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="Ninja Workshops"><meta property="article:modified_time" content="2024-05-17T16:28:10+02:00"><meta itemprop=name content="Log Observer :: Splunk Observability Cloud Workshops"><meta itemprop=description content="1. Introduction Until this point, we have not touched or changed our code, yet we did receive Trace & Profiling/DB Query performance information. If we want to get more out of our Java application, we can introduce a small change to our application log setup.
This change will configure the Spring PetClinic application to use an Otel-based format to write logs, This will allow the (Auto)-instrumentation to add Otel relevant information into the logs."><meta itemprop=dateModified content="2024-05-17T16:28:10+02:00"><meta itemprop=wordCount content="1469"><title>Log Observer :: Splunk Observability Cloud Workshops</title>
<link href=https://splunk.github.io/observability-workshop/v5.64/en/other/3-auto-instrumentation/3-java-microservices-k8s/60-log-observer-connect/index.html rel=canonical type=text/html title="Log Observer :: Splunk Observability Cloud Workshops"><link href=/observability-workshop/v5.64/images/favicon.ico?1721291801 rel=icon type=image/x-icon sizes=any><link href=/observability-workshop/v5.64/css/fontawesome-all.min.css?1721291801 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v5.64/css/fontawesome-all.min.css?1721291801 rel=stylesheet></noscript><link href=/observability-workshop/v5.64/css/nucleus.css?1721291801 rel=stylesheet><link href=/observability-workshop/v5.64/css/auto-complete.css?1721291801 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v5.64/css/auto-complete.css?1721291801 rel=stylesheet></noscript><link href=/observability-workshop/v5.64/css/perfect-scrollbar.min.css?1721291801 rel=stylesheet><link href=/observability-workshop/v5.64/css/fonts.css?1721291801 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v5.64/css/fonts.css?1721291801 rel=stylesheet></noscript><link href=/observability-workshop/v5.64/css/theme.css?1721291801 rel=stylesheet><link href=/observability-workshop/v5.64/css/theme-splunk-light.css?1721291801 rel=stylesheet id=R-variant-style><link href=/observability-workshop/v5.64/css/chroma-relearn-light.css?1721291801 rel=stylesheet id=R-variant-chroma-style><link href=/observability-workshop/v5.64/css/variant.css?1721291801 rel=stylesheet><link href=/observability-workshop/v5.64/css/print.css?1721291801 rel=stylesheet media=print><link href=/observability-workshop/v5.64/css/format-print.css?1721291801 rel=stylesheet><script src=/observability-workshop/v5.64/js/variant.js?1721291801></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../../../../..",window.relearn.relBaseUri="../../../../../../..",window.relearn.absBaseUri="https://splunk.github.io/observability-workshop/v5.64",window.index_js_url="/observability-workshop/v5.64/en/index.search.js?1721291801",window.variants&&variants.init(["splunk-light","splunk-dark"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js crossorigin=anonymous></script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web-session-recorder.js crossorigin=anonymous></script><script>SplunkRum.init({realm:"eu0",rumAccessToken:"TR9BBfgYo7qJfqrfgqjoqA",applicationName:"observability-workshop",deploymentEnvironment:"splunk.github.io",version:"1.0"}),SplunkSessionRecorder.init({app:"observability-workshop",realm:"eu0",rumAccessToken:"TR9BBfgYo7qJfqrfgqjoqA"})</script></script><style>:root{--MAIN-WIDTH-MAX:130rem;--MENU-WIDTH-L:23rem}</style></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=/observability-workshop/v5.64/en/other/3-auto-instrumentation/3-java-microservices-k8s/60-log-observer-connect/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v5.64/en/index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v5.64/en/other/index.html><span itemprop=name>Ninja Workshops</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v5.64/en/other/3-auto-instrumentation/index.html><span itemprop=name>Auto-Instrumentation Workshops</span></a><meta itemprop=position content="3">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v5.64/en/other/3-auto-instrumentation/3-java-microservices-k8s/index.html><span itemprop=name>PetClinic Java Microservices Workshop (Kubernetes)</span></a><meta itemprop=position content="4">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>60. Log Observer</span><meta itemprop=position content="5"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v5.64/en/other/3-auto-instrumentation/3-java-microservices-k8s/50-profiling-db-query/index.html title="Splunk APM Always-on Profiling & Database Query Performance (ðŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v5.64/en/other/4-hpa/index.html title="Monitoring Horizontal Pod Autoscaling in Kubernetes (ðŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=log-observer>Log Observer</h1><h2 id=1-introduction>1. Introduction</h2><p>Until this point, we have not touched or changed our code, yet we did receive Trace & Profiling/DB Query performance information.
If we want to get more out of our Java application, we can introduce a small change to our application log setup.</p><p>This change will configure the Spring PetClinic application to use an Otel-based format to write logs, This will allow the (Auto)-instrumentation to add Otel relevant information into the logs.</p><p>The Splunk Log Observer component is used to view the logs and with this information can automatically relate log information with APM Services and Traces. This feature called <strong>Related Content</strong> will also work with Infrastructure.</p><p>Lets grab the actual code for the application now.</p><h2 id=2-downloading-the-spring-microservices-petclinic-application>2. Downloading the Spring Microservices PetClinic Application</h2><p>For this exercise, we will use the Spring microservices PetClinic application. This is a very popular sample Java application built with the Spring framework (Springboot) and we are using a version with actual microservices.</p><p>First, clone the PetClinic GitHub repository, as we will need this later in the workshop to compile, build, package and containerize the application:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~<span class=p>;</span>git clone https://github.com/hagen-p/spring-petclinic-microservices.git</span></span></code></pre></div><p>Then change into the spring-petclinic directory:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/spring-petclinic-microservices</span></span></code></pre></div><h2 id=3-update-logback-config-for-the-services>3. Update Logback config for the services</h2><p>The Spring PetClinic application can be configured to use several different Java logging libraries. In this scenario, the application is using <code>logback</code>. To make sure we get the OTel information in the logs we need to update a file named <code>logback.xml</code> with the log structure, and add an Otel dependency to the <code>pom.xml</code> of each of the services in the petclinic microservices folders.</p><p>First, let&rsquo;s set the Log Structure/Format:</p><p>Spring boot will allow you to set a global template, but for ease of use, we will replace the existing content of the <code>logback-spring.xml</code> files of each service with the following XML content using a prepared script:
Note the following entries that will be added:</p><ul><li>trace_id</li><li>span_id</li><li>trace_flags</li><li>service.name</li><li>deployment.environment
These fields allow the <strong>Splunk</strong> Observability Cloud Suite** to display <strong>Related Content</strong> when used in a pattern shown below:</li></ul><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl>  <span class=nt>&lt;pattern&gt;</span>
</span></span><span class=line><span class=cl>    logback: %d{HH:mm:ss.SSS} [%thread] severity=%-5level %logger{36} - trace_id=%X{trace_id} span_id=%X{span_id} service.name=%property{otel.resource.service.name} trace_flags=%X{trace_flags} - %msg %kvp{DOUBLE}%n
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/pattern&gt;</span></span></span></code></pre></div><p>So let&rsquo;s run the script that will update the files with the log structure with the format above:</p><div class=tab-panel data-tab-group=47dfe718989c59f63f90fbf1e4f69fbf><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=update-logback-files class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("47dfe718989c59f63f90fbf1e4f69fbf","update-logback-files")'>
<span class=tab-nav-text>Update Logback files</span>
</button>
<button data-tab-item=replace-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("47dfe718989c59f63f90fbf1e4f69fbf","replace-output")'>
<span class=tab-nav-text>Replace Output</span></button></div><div class=tab-content-container><div data-tab-item=update-logback-files class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ~/workshop/petclinic/scripts/update_logback.sh</span></span></code></pre></div></div></div><div data-tab-item=replace-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Overwritten /home/splunk/spring-petclinic-microservices/spring-petclinic-admin-server/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Overwritten /home/splunk/spring-petclinic-microservices/spring-petclinic-api-gateway/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Overwritten /home/splunk/spring-petclinic-microservices/spring-petclinic-config-server/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Overwritten /home/splunk/spring-petclinic-microservices/spring-petclinic-customers-service/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Overwritten /home/splunk/spring-petclinic-microservices/spring-petclinic-discovery-server/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Overwritten /home/splunk/spring-petclinic-microservices/spring-petclinic-vets-service/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Overwritten /home/splunk/spring-petclinic-microservices/spring-petclinic-visits-service/src/main/resources/logback-spring.xml with new XML content.
</span></span><span class=line><span class=cl>Script execution completed.</span></span></code></pre></div></div></div></div></div><p>We can verify if the replacement has been successful by examining the spring-logback.xml file from one of the services</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat /home/splunk/spring-petclinic-microservices/spring-petclinic-customers-service/src/main/resources/logback-spring.xml</span></span></code></pre></div><h2 id=4-reconfigure-and-build-the-services-locally>4. Reconfigure and build the services locally</h2><p>Before we can build the new services with the updated log format we need to add the Opentelemetry dependency tht handles field injection to the <code>Pom.xml</code> of our services:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ~/workshop/petclinic/scripts/add_otel.sh</span></span></code></pre></div><p>The Services are now ready to be built, so run the script that will use the <code>maven</code> command to compile/build/package the PetClinic microservices (Note the -P buildDocker, this will build the new containers):<div class=tab-panel data-tab-group=b7b350a53dec9ed940697cd5b1d4ffe8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=running-maven class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b7b350a53dec9ed940697cd5b1d4ffe8","running-maven")'>
<span class=tab-nav-text>Running maven</span>
</button>
<button data-tab-item=maven-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("b7b350a53dec9ed940697cd5b1d4ffe8","maven-output")'>
<span class=tab-nav-text>Maven Output</span></button></div><div class=tab-content-container><div data-tab-item=running-maven class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./mvnw clean install -D skipTests -P buildDocker</span></span></code></pre></div></div></div><div data-tab-item=maven-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Successfully tagged quay.io/phagen/spring-petclinic-api-gateway:latest
</span></span><span class=line><span class=cl>[INFO] Built quay.io/phagen/spring-petclinic-api-gateway
</span></span><span class=line><span class=cl>[INFO] ------------------------------------------------------------------------
</span></span><span class=line><span class=cl>[INFO] Reactor Summary:
</span></span><span class=line><span class=cl>[INFO] 
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-microservices 0.0.1 ............... SUCCESS [  0.770 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-admin-server ...................... SUCCESS [01:03 min]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-customers-service ................. SUCCESS [ 29.031 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-vets-service ...................... SUCCESS [ 22.145 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-visits-service .................... SUCCESS [ 20.451 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-config-server ..................... SUCCESS [ 12.260 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-discovery-server .................. SUCCESS [ 14.174 s]
</span></span><span class=line><span class=cl>[INFO] spring-petclinic-api-gateway 0.0.1 ................. SUCCESS [ 29.832 s]
</span></span><span class=line><span class=cl>[INFO] ------------------------------------------------------------------------
</span></span><span class=line><span class=cl>[INFO] BUILD SUCCESS
</span></span><span class=line><span class=cl>[INFO] ------------------------------------------------------------------------
</span></span><span class=line><span class=cl>[INFO] Total time: 03:14 min
</span></span><span class=line><span class=cl>[INFO] Finished at: 2024-01-02T12:43:20Z
</span></span><span class=line><span class=cl>[INFO] ------------------------------------------------------------------------</span></span></code></pre></div></div></div></div></div></p><p>Given that Kubernetes needs to pull these freshly built images from somewhere, we are going to store them in the repository we tested earlier. To do this, run the script that will push the newly built containers into our local repository:</p><div class=tab-panel data-tab-group=175c43c5224ebe60c314647d93135e80><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=pushing-containers class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("175c43c5224ebe60c314647d93135e80","pushing-containers")'>
<span class=tab-nav-text>pushing Containers</span>
</button>
<button data-tab-item=docker-push-output-partial class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("175c43c5224ebe60c314647d93135e80","docker-push-output-partial")'>
<span class=tab-nav-text>Docker Push Output (partial)</span></button></div><div class=tab-content-container><div data-tab-item=pushing-containers class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ~/workshop/petclinic/scripts/push_docker.sh </span></span></code></pre></div></div></div><div data-tab-item=docker-push-output-partial class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>The push refers to repository [localhost:5000/spring-petclinic-vets-service]
</span></span><span class=line><span class=cl>0391386bcb2a: Preparing 
</span></span><span class=line><span class=cl>bbb67f51a186: Preparing 
</span></span><span class=line><span class=cl>105351d0ada3: Preparing 
</span></span><span class=line><span class=cl>49cfeae6cb9f: Preparing 
</span></span><span class=line><span class=cl>b4da5101fcde: Preparing 
</span></span><span class=line><span class=cl>49cfeae6cb9f: Pushed 
</span></span><span class=line><span class=cl>e742c14be110: Mounted from spring-petclinic-visits-service 
</span></span><span class=line><span class=cl>540aa741fede: Mounted from spring-petclinic-visits-service 
</span></span><span class=line><span class=cl>a1dfe59d4939: Mounted from spring-petclinic-visits-service 
</span></span><span class=line><span class=cl>1e99e92c46bf: Mounted from spring-petclinic-visits-service 
</span></span><span class=line><span class=cl>f5aa38537736: Mounted from spring-petclinic-visits-service 
</span></span><span class=line><span class=cl>d2210512edb4: Mounted from spring-petclinic-visits-service 
</span></span><span class=line><span class=cl>8e87ff28f1b5: Mounted from spring-petclinic-visits-service 
</span></span><span class=line><span class=cl>local: digest: sha256:42337b2a4ff7d0ac9b7c2cf3c70aa20b7b52d092f1e05d351e031dd7fad956fc size: 3040
</span></span><span class=line><span class=cl>The push refers to repository [localhost:5000/spring-petclinic-customers-service]
</span></span><span class=line><span class=cl>15d54d9adca8: Preparing 
</span></span><span class=line><span class=cl>886f6def5b35: Preparing 
</span></span><span class=line><span class=cl>1575ae90e858: Preparing 
</span></span><span class=line><span class=cl>ccc884d92d18: Preparing 
</span></span><span class=line><span class=cl>b4da5101fcde: Preparing 
</span></span><span class=line><span class=cl>ccc884d92d18: Pushed 
</span></span><span class=line><span class=cl>e742c14be110: Mounted from spring-petclinic-vets-service 
</span></span><span class=line><span class=cl>540aa741fede: Mounted from spring-petclinic-vets-service 
</span></span><span class=line><span class=cl>a1dfe59d4939: Mounted from spring-petclinic-vets-service 
</span></span><span class=line><span class=cl>1e99e92c46bf: Mounted from spring-petclinic-vets-service 
</span></span><span class=line><span class=cl>f5aa38537736: Mounted from spring-petclinic-vets-service 
</span></span><span class=line><span class=cl>d2210512edb4: Mounted from spring-petclinic-vets-service 
</span></span><span class=line><span class=cl>8e87ff28f1b5: Mounted from spring-petclinic-vets-service 
</span></span><span class=line><span class=cl>local: digest: sha256:3601c6e7f58224001946058fb0400483fbb8f1b0ea8a6dbaf403c62b4c1908be size: 3042</span></span></code></pre></div></div></div></div></div><p>The containers should now be stored in the local repository, lets confirm by checking the catalog,</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl> curl -X GET http://localhost:9999/v2/_catalog </span></span></code></pre></div><p>The result should be :</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>{&#34;repositories&#34;:[&#34;spring-petclinic-admin-server&#34;,&#34;spring-petclinic-api-gateway&#34;,&#34;spring-petclinic-config-server&#34;,&#34;spring-petclinic-customers-service&#34;,&#34;spring-petclinic-discovery-server&#34;,&#34;spring-petclinic-vets-service&#34;,&#34;spring-petclinic-visits-service&#34;]}</span></span></code></pre></div><h2 id=5-deploy-new-services-to-kubernetes>5. Deploy new services to Kubernetes</h2><p>To see the changes in effect, we need to redeploy the services, First, let&rsquo;s change the location of the images from the external repo to the local one by running the following script:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ~/workshop/petclinic/scripts/set_local.sh</span></span></code></pre></div><p>The result is a new file on disk called <strong>petclinic-local.yaml</strong>. Let&rsquo;s switch to the local versions by using the new version of the <code>deployment yaml</code>. First delete the old containers from the original deployment with:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl delete -f ~/workshop/petclinic/petclinic-local.yaml</span></span></code></pre></div><p>followed by:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f ~/workshop/petclinic/petclinic-local.yaml</span></span></code></pre></div><p>This will cause the containers to be replaced with the local version, you can verify this by checking the containers:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe pods api-gateway <span class=p>|</span>grep Image:</span></span></code></pre></div><p>The resulting output should say <code>localhost:9999</code> :</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>  Image:         localhost:9999/spring-petclinic-api-gateway:local</span></span></code></pre></div><p>However, as we only patched the deployment before, the new deployment does not have the right annotations for zero config auto-instrumentation, so lets fix that now by running the patch command again:</p><p>Note, there will be no change for the <em>config-server & discovery-server</em> as they do hav e the annotation included in the deployment.</p><div class=tab-panel data-tab-group=4f4f56dbd17daa801c643275bb066b09><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=patch-all-petclinic-services class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4f4f56dbd17daa801c643275bb066b09","patch-all-petclinic-services")'>
<span class=tab-nav-text>Patch all Petclinic services</span>
</button>
<button data-tab-item=kubectl-patch-output class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("4f4f56dbd17daa801c643275bb066b09","kubectl-patch-output")'>
<span class=tab-nav-text>kubectl patch Output</span></button></div><div class=tab-content-container><div data-tab-item=patch-all-petclinic-services class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get deployments -l app.kubernetes.io/part-of<span class=o>=</span>spring-petclinic -o name <span class=p>|</span> xargs -I % kubectl patch % -p <span class=s2>&#34;{\&#34;spec\&#34;: {\&#34;template\&#34;:{\&#34;metadata\&#34;:{\&#34;annotations\&#34;:{\&#34;instrumentation.opentelemetry.io/inject-java\&#34;:\&#34;default/splunk-otel-collector\&#34;}}}}}&#34;</span></span></span></code></pre></div></div></div><div data-tab-item=kubectl-patch-output class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>deployment.apps/config-server patched (no change)
</span></span><span class=line><span class=cl>deployment.apps/admin-server patched
</span></span><span class=line><span class=cl>deployment.apps/customers-service patched
</span></span><span class=line><span class=cl>deployment.apps/visits-service patched
</span></span><span class=line><span class=cl>deployment.apps/discovery-server patched (no change)
</span></span><span class=line><span class=cl>deployment.apps/vets-service patched
</span></span><span class=line><span class=cl>deployment.apps/api-gateway patched</span></span></code></pre></div></div></div></div></div><p>Lets check the <code>api-gateway</code> container again</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe pods api-gateway <span class=p>|</span>grep Image:</span></span></code></pre></div><p>The resulting output should say (again if you see double, its the old container being terminated, give it a few seconds):</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>  Image:         ghcr.io/signalfx/splunk-otel-java/splunk-otel-java:v1.30.0
</span></span><span class=line><span class=cl>  Image:         localhost:9999/spring-petclinic-api-gateway:local</span></span></code></pre></div><h2 id=6-view-logs>6. View Logs</h2><p>Once the containers are patched they will be restarted, let&rsquo;s go back to the <strong>Splunk Observability Cloud</strong> with the URL provided by the Instructor to check our cluster in the Kubernetes Navigator.</p><p>After a couple of minutes or so you should see that the Pods are being restarted by the operator and the Zero config container will be added. This will look similar to the screenshot below:</p><p><a href=#R-image-3f058e46301d8b562b2a36bd5425bf4f class=lightbox-link><img alt=restart class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.64/en/other/3-auto-instrumentation/3-java-microservices-k8s/60-log-observer-connect/../images/k8s-navigator-restarted-pods.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-3f058e46301d8b562b2a36bd5425bf4f><img alt=restart class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.64/en/other/3-auto-instrumentation/3-java-microservices-k8s/60-log-observer-connect/../images/k8s-navigator-restarted-pods.png></a></p><p>Wait for the pods to turn green again.(You may want to refresh the screen), then from the left-hand menu click on <strong>Log Observer</strong> <a href=#R-image-4bb938829364d4c1eb44f9deec2967f7 class=lightbox-link><img alt=Logo class="noborder inline lazy lightbox noshadow figure-image" loading=lazy src="/observability-workshop/v5.64/en/other/3-auto-instrumentation/3-java-microservices-k8s/60-log-observer-connect/../images/logo-icon.png?classes=inline&height=25px" style=height:25px;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-4bb938829364d4c1eb44f9deec2967f7><img alt=Logo class="noborder inline lazy lightbox noshadow lightbox-image" loading=lazy src="/observability-workshop/v5.64/en/other/3-auto-instrumentation/3-java-microservices-k8s/60-log-observer-connect/../images/logo-icon.png?classes=inline&height=25px"></a> and ensure <strong>Index</strong> is set to <strong>splunk4rookies-workshop</strong>.</p><p>Next, click <strong>Add Filter</strong> search for the field <code>deployment.environment</code> and select the value of rou Workshop (Remember the INSTANCE value ?) and click <code>=</code> (include). You should now see only the log messages from your PetClinic application.</p><p>Next search for the field <code>service_name</code> select the value <code>customers-service</code> and click <code>=</code> (include). Now the log files should be reduce to just the lines from your <code>customers-service</code>.</p><p>Wait for Log Lines to show up with an injected trace-id like trace_id=08b5ce63e46ddd0ce07cf8cfd2d6161a as show below <strong>(1)</strong>:</p><p><a href=#R-image-e8e8d6788526b8093621f00e5973c630 class=lightbox-link><img alt="Log Observer" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.64/en/other/3-auto-instrumentation/3-java-microservices-k8s/60-log-observer-connect/../images/log-observer-trace-info.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e8e8d6788526b8093621f00e5973c630><img alt="Log Observer" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.64/en/other/3-auto-instrumentation/3-java-microservices-k8s/60-log-observer-connect/../images/log-observer-trace-info.png></a></p><p>Click on a line with an injected trace_id, this should be all log lines created by your services that are part of a trace <strong>(1)</strong>.
A Side pane opens where you can see the related information about your logs. including the relevant Trace and Span Id&rsquo;s <strong>(2)</strong>.</p><p>Also, at the bottom next to APM, there should be a number, this is the number of related AP Content items for this log line. click on the APM pane <strong>(1)</strong> as show below:
<a href=#R-image-8bcaaa4d396f7f86217abead2722f497 class=lightbox-link><img alt=RC class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.64/en/other/3-auto-instrumentation/3-java-microservices-k8s/60-log-observer-connect/../images/log-apm-rc.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8bcaaa4d396f7f86217abead2722f497><img alt=RC class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.64/en/other/3-auto-instrumentation/3-java-microservices-k8s/60-log-observer-connect/../images/log-apm-rc.png></a></p><ul><li>The <em>Map for customers-service</em> <strong>(2)</strong> brings us to the APM dependency map with the workflow focused on Customer Services, allowing you to quick understand how this log line is related to the overall flow of service interaction.</li><li>The <em>Trace for 34c98cbf7b300ef3dedab49da71a6ce3</em> <strong>(3)</strong> will bring us to the waterfall in APM for this specific trace that this log line was generated in.</li></ul><p>As a last exercise, click on the Trace for Link, this will bering you to the waterfall for this specific trace:</p><p><a href=#R-image-2b574f276981d5ba8d5b9b329472ac01 class=lightbox-link><img alt="waterfall logs" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=/observability-workshop/v5.64/en/other/3-auto-instrumentation/3-java-microservices-k8s/60-log-observer-connect/../images/waterfall-with-logs.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-2b574f276981d5ba8d5b9b329472ac01><img alt="waterfall logs" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=/observability-workshop/v5.64/en/other/3-auto-instrumentation/3-java-microservices-k8s/60-log-observer-connect/../images/waterfall-with-logs.png></a></p><p>Note that you now have Logs Related Content Pane <strong>(1)</strong> appear, clicking on this will bring you back to log observer with all the logs line that are part of this Trace.
This will help you to quickly find relevant log lines for an interaction or a problem.</p><h2 id=7-summary>7. Summary</h2><p>This is the end of the workshop and we have certainly covered a lot of ground. At this point, you should have metrics, traces, logs, database query performance and code profiling being reported into Splunk Observability Cloud.</p><p><strong>Congratulations!</strong></p><footer class=footline><span class="badge cstyle tip badge-with-title"><span class=badge-title class=text-muted>Last Modified By
</span><span class=badge-content>Maciej Lisowski</span>
</span>&nbsp;
<span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted><i class="fa-fw fas fa-calendar"></i>
</span><span class=badge-content>May 17, 2024</span></span></footer></article></div></main></div><script src=/observability-workshop/v5.64/js/clipboard.min.js?1721291801 defer></script><script src=/observability-workshop/v5.64/js/perfect-scrollbar.min.js?1721291801 defer></script><script src=/observability-workshop/v5.64/js/theme.js?1721291801 defer></script></body></html>