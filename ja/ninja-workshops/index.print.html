<!doctype html><html lang=ja dir=ltr itemscope itemtype=http://schema.org/Article data-r-output-format=print><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.145.0"><meta name=generator content="Relearn 8.2.0+9cac649a184a2967957ef9bbececf9402192846c"><meta name=description content="The following workshops require Ninja skills, wax on, wax off."><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Splunk4Ninjas Workshops :: Splunk Observability Cloud Workshops"><meta name=twitter:description content="The following workshops require Ninja skills, wax on, wax off."><meta property="og:url" content="https://splunk.github.io/observability-workshop/ja/ninja-workshops/index.html"><meta property="og:site_name" content="Splunk Observability Cloud Workshops"><meta property="og:title" content="Splunk4Ninjas Workshops :: Splunk Observability Cloud Workshops"><meta property="og:description" content="The following workshops require Ninja skills, wax on, wax off."><meta property="og:locale" content="ja"><meta property="og:type" content="website"><meta itemprop=name content="Splunk4Ninjas Workshops :: Splunk Observability Cloud Workshops"><meta itemprop=description content="The following workshops require Ninja skills, wax on, wax off."><meta itemprop=dateModified content="2025-09-29T12:26:47+01:00"><meta itemprop=wordCount content="19"><title>Splunk4Ninjas Workshops :: Splunk Observability Cloud Workshops</title>
<link href=https://splunk.github.io/observability-workshop/en/ninja-workshops/index.html rel=alternate hreflang=x-default><link href=https://splunk.github.io/observability-workshop/en/ninja-workshops/index.html rel=alternate hreflang=en><link href=https://splunk.github.io/observability-workshop/ja/ninja-workshops/index.html rel=alternate hreflang=ja><link href=https://splunk.github.io/observability-workshop/ja/ninja-workshops/index.html rel=canonical type=text/html title="Splunk4Ninjas Workshops :: Splunk Observability Cloud Workshops"><link href=/observability-workshop/images/favicon.ico?1765303813 rel=icon type=image/x-icon sizes=any><link href=/observability-workshop/css/auto-complete/auto-complete.min.css?1765303813 rel=stylesheet><script src=/observability-workshop/js/auto-complete/auto-complete.min.js?1765303813 defer></script><script src=/observability-workshop/js/search-lunr.min.js?1765303813 defer></script><script src=/observability-workshop/js/search.min.js?1765303813 defer></script><script>window.relearn=window.relearn||{},window.relearn.index_js_url="/observability-workshop/searchindex.ja.js?1765303813"</script><script src=/observability-workshop/js/lunr/lunr.min.js?1765303813 defer></script><script src=/observability-workshop/js/lunr/lunr.stemmer.support.min.js?1765303813 defer></script><script src=/observability-workshop/js/lunr/lunr.multi.min.js?1765303813 defer></script><script src=/observability-workshop/js/lunr/tinyseg.js?1765303813 defer></script><script src=/observability-workshop/js/lunr/lunr.ja.min.js?1765303813 defer></script><script>window.relearn=window.relearn||{},window.relearn.contentLangs=["ja"]</script><link href=/observability-workshop/fonts/fontawesome/css/fontawesome-all.min.css?1765303813 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/fonts/fontawesome/css/fontawesome-all.min.css?1765303813 rel=stylesheet></noscript><link href=/observability-workshop/css/perfect-scrollbar/perfect-scrollbar.min.css?1765303813 rel=stylesheet><link href=/observability-workshop/css/theme.min.css?1765303813 rel=stylesheet><link href=/observability-workshop/css/format-print.min.css?1765303813 rel=stylesheet id=R-format-style><script>window.relearn=window.relearn||{},window.relearn.min=`.min`,window.relearn.path="/ninja-workshops/index.html",window.relearn.relBasePath="../..",window.relearn.relBaseUri="../../..",window.relearn.absBaseUri="https://splunk.github.io/observability-workshop",window.relearn.disableAnchorCopy=!1,window.relearn.disableAnchorScrolling=!1,window.relearn.disableInlineCopyToClipboard=!0,window.relearn.enableBlockCodeWrap=!0,window.relearn.getItem=(e,t)=>e.getItem(t),window.relearn.setItem=(e,t,n)=>e.setItem(t,n),window.relearn.removeItem=(e,t)=>e.removeItem(t),window.T_Copy_to_clipboard=`クリップボードにコピー`,window.T_Copied_to_clipboard=`クリップボードにコピー!`,window.T_Copy_link_to_clipboard=`リンクをクリップボードにコピー`,window.T_Link_copied_to_clipboard=`リンクをクリップボードにコピーしました!`,window.T_Reset_view=`ビューのリセット`,window.T_View_reset=`リセットを見る`,window.T_No_results_found=`"{0}" の結果が見つかりません`,window.T_N_results_found=`"{0}" で {1} 件の結果が見つかりました`,window.relearn.themevariants=["auto","splunk-light","splunk-dark"],window.relearn.customvariantname="my-custom-variant",window.relearn.changeVariant=function(e){var t=document.documentElement.dataset.rThemeVariant;window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e),document.documentElement.dataset.rThemeVariant=e,t!=e&&(document.dispatchEvent(new CustomEvent("themeVariantLoaded",{detail:{variant:e,oldVariant:t}})),window.relearn.markVariant())},window.relearn.markVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant");document.querySelectorAll(".R-variantswitcher select").forEach(t=>{t.value=e})},window.relearn.initVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant")??"";e==window.relearn.customvariantname||(!e||!window.relearn.themevariants.includes(e))&&(e=window.relearn.themevariants[0],window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e)),document.documentElement.dataset.rThemeVariant=e},window.relearn.initVariant(),window.relearn.markVariant()</script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js crossorigin=anonymous></script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web-session-recorder.js crossorigin=anonymous></script><script>SplunkRum.init({realm:"us1",rumAccessToken:"h7q1NLX6lJz0h_5-OqQJkg",applicationName:"observability-workshop",deploymentEnvironment:"splunk.github.io",version:"1.0"}),SplunkSessionRecorder.init({appplicationName:"observability-workshop",realm:"us1",rumAccessToken:"h7q1NLX6lJz0h_5-OqQJkg",recorder:"splunk",features:{video:!0}})</script></script><style>:root{--MAIN-WIDTH-MAX:130rem;--MENU-WIDTH-L:23rem}p{margin:.75rem 0}.highlight{max-height:500px;overflow-y:auto}pre:not(.mermaid){margin:0}</style></head><body class="mobile-support print" data-url=/observability-workshop/ja/ninja-workshops/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><span class="btn cstyle link noborder notitle interactive"><button onclick=toggleNav() type=button title="メニュー (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></span></div><div class="topbar-button topbar-button-toc" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle link noborder notitle interactive"><button onclick=toggleTopbarFlyout(this) type=button title="目次 (CTRL+ALT+t)"><i class="fa-fw fas fa-list-alt"></i></button></span><div class=topbar-content><div class=topbar-content-wrapper></div></div></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/ja/index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Splunk4Ninjas Workshops</span><meta itemprop=position content="2"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-print" data-content-empty=disable data-width-s=area-more data-width-m=show data-width-l=show><span class="btn cstyle link noborder notitle interactive"><a href=/observability-workshop/ja/ninja-workshops/index.print.html title="章全体を印刷する (CTRL+ALT+p)"><i class="fa-fw fas fa-print"></i></a></span></div><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle link noborder notitle interactive"><a href=/observability-workshop/ja/splunk4rookies/observability-cloud/10-wrap-up/key-takeaways/index.html title="主要なポイント (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a></span></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle link noborder notitle interactive"><a href=/observability-workshop/ja/ninja-workshops/1-automatic-discovery/index.html title="自動ディスカバリー (Automatic Discovery) ワークショップ (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a></span></div><div class="topbar-button topbar-button-more" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle link noborder notitle interactive"><button onclick=toggleTopbarFlyout(this) type=button title=更に><i class="fa-fw fas fa-ellipsis-v"></i></button></span><div class=topbar-content><div class=topbar-content-wrapper><div class="topbar-area topbar-area-more" data-area=more></div></div></div></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable ninja-workshops" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=splunk4ninjas-workshops>Splunk4Ninjas Workshops</h1><div class="children children-type-card children-sort-"><ul class=card-container><li><article class="card card-popout" aria-labelledby=R-card-ccf087e8d5debc723af4f5f96612da5d><div class=card-content><div class=card-title id=R-card-ccf087e8d5debc723af4f5f96612da5d><a href=/observability-workshop/ja/ninja-workshops/1-automatic-discovery/index.html>自動ディスカバリー (Automatic Discovery) ワークショップ</a></div><div class=card-content-text>Java アプリケーション向けの Splunk 自動ディスカバリーおよび設定機能の活用方法を学びます。これらのワークショップでは、ゼロコード計装 (zero-code instrumentation) を使用して、モノリスおよび Kubernetes デプロイメント全体でメトリクス、トレース、ログを即座に生成し、包括的なオブザーバビリティを実現する方法をデモンストレーションします。</div></div></article></li><li><article class="card card-popout" aria-labelledby=R-card-d3844cc9a281fa0ce1acc0a885fa05f8><div class=card-content><div class=card-title id=R-card-d3844cc9a281fa0ce1acc0a885fa05f8><a href=/observability-workshop/ja/ninja-workshops/6-lambda-kinesis/index.html>Lambdaトレーシング</a></div><div class=card-content-text>このワークショップでは、AWS Lambdaで実行される小規模なサーバーレスアプリケーションの分散トレースを構築し、AWS Kinesisを介してメッセージをproduceおよびconsumeする方法を学びます</div></div><div class=card-image><img src=/observability-workshop/ja/ninja-workshops/6-lambda-kinesis/images/01-Architecture.png></div></article></li><li><article class="card card-popout" aria-labelledby=R-card-c079beb4c236bf50fadf0e848c1b494b><div class=card-content><div class=card-title id=R-card-c079beb4c236bf50fadf0e848c1b494b><a href=/observability-workshop/ja/ninja-workshops/8-docker-k8s-otel/index.html>OpenTelemetry、Docker、K8sを実践で学ぶ</a></div><div class=card-content-text>このワークショップでは、これらの概念を説明するためにシンプルな.NETアプリケーションを使用します。さあ、始めましょう！ワークショップの終わりまでに、OpenTelemetryを使用した.NETアプリケーションの計装の実践経験を積み、そのアプリケーションのDocker化およびKubernetesへのデプロイを行います。また、Helmを使用したOpenTelemetryコレクターのデプロイ、コレクター設定のカスタマイズ、コレクター設定の問題のトラブルシューティングの経験も得られます。</div></div><div class=card-image><img src=/observability-workshop/ja/ninja-workshops/8-docker-k8s-otel/images/NetInstrumentation.png></div></article></li></ul></div><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/09/29</span></span></footer></article><section><h1 class=a11y-only>Splunk4Ninjas Workshopsのサブセクション</h1><article class=default><header class=headline></header><h1 id=自動ディスカバリー-automatic-discovery-ワークショップ>自動ディスカバリー (Automatic Discovery) ワークショップ</h1><div class="children children-type-card children-sort-"><ul class=card-container><li><article class="card card-popout" aria-labelledby=R-card-75c9da584b94293997063c98dfb33edc><div class=card-content><div class=card-title id=R-card-75c9da584b94293997063c98dfb33edc><a href=/observability-workshop/ja/ninja-workshops/1-automatic-discovery/1-petclinic-monolith/index.html>PetClinic モノリスワークショップ</a></div><div class=card-content-text>Spring PetClinic サンプルアプリケーションを使用して、Java アプリケーション向けの Splunk Observability Cloud の自動ディスカバリーおよび設定機能をデモンストレーションするハンズオンワークショップです。</div></div><div class=card-image><img src=/observability-workshop/ja/ninja-workshops/1-automatic-discovery/1-petclinic-monolith/images/log-observer.png></div></article></li><li><article class="card card-popout" aria-labelledby=R-card-50ab8c7184ad7a055eb3ae2553ccb703><div class=card-content><div class=card-title id=R-card-50ab8c7184ad7a055eb3ae2553ccb703><a href=/observability-workshop/ja/ninja-workshops/1-automatic-discovery/2-petclinic-kubernetes/index.html>PetClinic Kubernetes ワークショップ</a></div><div class=card-content-text>Kubernetes で実行される Java ベースのアプリケーション向けの自動ディスカバリーおよび設定を有効にする方法を学びます。リアルタイムモニタリングを体験し、エンドツーエンドの可視性でアプリケーションの動作を最大限に活用しましょう。</div></div><div class=card-image><img src=/observability-workshop/ja/ninja-workshops/1-automatic-discovery/2-petclinic-kubernetes/images/aa.png></div></article></li></ul></div><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article><section><h1 class=a11y-only>自動ディスカバリー (Automatic Discovery) ワークショップのサブセクション</h1><article class=default><header class=headline></header><h1 id=petclinic-モノリスワークショップ>PetClinic モノリスワークショップ</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>30 minutes</span>
</span>&nbsp;
<span class="badge cstyle blue badge-with-title"><span class=badge-title class=text-muted>Author
</span><span class=badge-content>Robert Castley</span></span><p>このワークショップの目的は、<strong>Splunk Observability Cloud</strong> プラットフォームの以下のコンポーネントを設定するための基本的な手順を説明することです：</p><ul><li>Splunk Infrastructure Monitoring (IM)</li><li>Splunk Automatic Discovery for Java (APM)<ul><li>Database Query Performance</li><li>AlwaysOn Profiling</li></ul></li><li>Splunk Real User Monitoring (RUM)</li><li>RUM から APM への相関 (Correlation)</li><li>Splunk Log Observer (LO)</li></ul><p>また、サンプル Java アプリケーション（Spring PetClinic）のクローン（ダウンロード）方法、およびアプリケーションのコンパイル、パッケージ化、実行方法についても説明します。</p><p>アプリケーションが起動して実行されると、<strong>Splunk APM</strong> 製品で使用される Java 2.x 向けの<strong>自動ディスカバリーおよび設定</strong>機能により、メトリクス、トレース、ログが即座に表示されるようになります。</p><p>その後、<strong>Splunk OpenTelemetry Javascript Libraries (RUM)</strong> を使用して PetClinic のエンドユーザーインターフェース（アプリケーションがレンダリングする HTML ページ）を計装します。これにより、エンドユーザーが実行するすべてのクリックやページ読み込みに対して RUM トレースが生成されます。</p><p>最後に、PetClinic アプリケーションログへのトレースメタデータの自動インジェクション (injection) によって生成されたログを確認します。</p><details open class="box cstyle notices primary"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info"></i>
前提条件</summary><div class=box-content><ul><li>ポート <code>2222</code> へのアウトバウンド SSH アクセス</li><li>ポート <code>8083</code> へのアウトバウンド HTTP アクセス</li><li><code>bash</code> シェルおよび <code>vi/vim</code> エディタの基本的な知識</li></ul></div></details><p><a href=#R-image-9f8b93d7669df1d26b3f803492e3d446 class=lightbox-link><img alt="PetClinic Exercise" class="lazy lightbox figure-image" loading=lazy src=/observability-workshop/ja/ninja-workshops/1-automatic-discovery/1-petclinic-monolith/images/petclinic-exercise.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-9f8b93d7669df1d26b3f803492e3d446><img alt="PetClinic Exercise" class="lazy lightbox lightbox-image" loading=lazy src=/observability-workshop/ja/ninja-workshops/1-automatic-discovery/1-petclinic-monolith/images/petclinic-exercise.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article><section><h1 class=a11y-only>PetClinic モノリスワークショップのサブセクション</h1><article class=default><header class=headline></header><h1 id=opentelemetry-collector-のインストール>OpenTelemetry Collector のインストール</h1><p>Splunk OpenTelemetry Collector は、インフラストラクチャとアプリケーションの計装における中核コンポーネントです。その役割は以下のデータを収集して送信することです：</p><ul><li>インフラストラクチャメトリクス（ディスク、CPU、メモリなど）</li><li>Application Performance Monitoring (APM) トレース</li><li>プロファイリングデータ</li><li>ホストおよびアプリケーションのログ</li></ul><details open class="box cstyle notices warning"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-exclamation-triangle"></i>
既存の OpenTelemetry Collector の削除</summary><div class=box-content><p>Splunk IM ワークショップを完了している場合は、続行する前に Kubernetes で実行中の Collector を削除してください。以下のコマンドを実行して削除できます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm delete splunk-otel-collector</span></span></code></pre></div><p>EC2 インスタンスには、古いバージョンの Collector がすでにインストールされている場合があります。Collector をアンインストールするには、以下のコマンドを実行してください：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -sSL https://dl.signalfx.com/splunk-otel-collector.sh &gt; /tmp/splunk-otel-collector.sh
</span></span><span class=line><span class=cl>sudo sh /tmp/splunk-otel-collector.sh --uninstall</span></span></code></pre></div></div></details><p>インスタンスが正しく設定されていることを確認するために、このワークショップに必要な環境変数が正しく設定されているか確認する必要があります。ターミナルで以下のコマンドを実行してください：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ~/workshop/petclinic/scripts/check_env.sh</span></span></code></pre></div><p>出力で、以下のすべての環境変数が存在し、値が設定されていることを確認してください。不足している場合は、インストラクターに連絡してください：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>ACCESS_TOKEN
</span></span><span class=line><span class=cl>REALM
</span></span><span class=line><span class=cl>RUM_TOKEN
</span></span><span class=line><span class=cl>HEC_TOKEN
</span></span><span class=line><span class=cl>HEC_URL
</span></span><span class=line><span class=cl>INSTANCE</span></span></code></pre></div><p>これで Collector のインストールに進むことができます。インストールスクリプトには、いくつかの追加パラメータが渡されます：</p><ul><li><code>--with-instrumentation</code> - Splunk ディストリビューションの OpenTelemetry Java からエージェントをインストールします。これにより、PetClinic Java アプリケーションの起動時に自動的にロードされます。設定は不要です！</li><li><code>--deployment-environment</code> - リソース属性 <code>deployment.environment</code> を指定された値に設定します。これは UI でビューをフィルタリングするために使用されます。</li><li><code>--enable-profiler</code> - Java アプリケーションのプロファイラを有効にします。これによりアプリケーションの CPU プロファイルが生成されます。</li><li><code>--enable-profiler-memory</code> - Java アプリケーションのプロファイラを有効にします。これによりアプリケーションのメモリプロファイルが生成されます。</li><li><code>--enable-metrics</code> - Micrometer メトリクスのエクスポートを有効にします</li><li><code>--hec-token</code> - Collector が使用する HEC トークンを設定します</li><li><code>--hec-url</code> - Collector が使用する HEC URL を設定します</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -sSL https://dl.signalfx.com/splunk-otel-collector.sh &gt; /tmp/splunk-otel-collector.sh <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>sudo sh /tmp/splunk-otel-collector.sh --realm <span class=nv>$REALM</span> -- <span class=nv>$ACCESS_TOKEN</span> --mode agent --without-fluentd --with-instrumentation --deployment-environment <span class=nv>$INSTANCE</span>-petclinic --enable-profiler --enable-profiler-memory --enable-metrics --hec-token <span class=nv>$HEC_TOKEN</span> --hec-url <span class=nv>$HEC_URL</span></span></span></code></pre></div><p>次に、Collector にパッチを適用して、AWS インスタンス ID ではなくインスタンスのホスト名を公開するようにします。これにより、UI でのデータのフィルタリングが容易になります：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo sed -i <span class=s1>&#39;s/gcp, ecs, ec2, azure, system/system, gcp, ecs, ec2, azure/g&#39;</span> /etc/otel/collector/agent_config.yaml</span></span></code></pre></div><p><code>agent_config.yaml</code> にパッチを適用したら、Collector を再起動する必要があります：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl restart splunk-otel-collector</span></span></code></pre></div><p>インストールが完了したら、<strong>Hosts with agent installed</strong> ダッシュボードに移動して、ホストからのデータを確認できます。<strong>Dashboards → Hosts with agent installed</strong> の順に移動してください。</p><p>ダッシュボードフィルタを使用して <code>host.name</code> を選択し、ワークショップインスタンスのホスト名を入力または選択してください（これはターミナルセッションのコマンドプロンプトから取得できます）。ホストのデータが流れていることを確認したら、APM コンポーネントの作業を開始する準備が整いました。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article><article class=default><header class=headline></header><h1 id=spring-petclinic-アプリケーションのビルド>Spring PetClinic アプリケーションのビルド</h1><p>APM をセットアップするために最初に必要なのは&mldr;そう、アプリケーションです。この演習では、Spring PetClinic アプリケーションを使用します。これは、Spring フレームワーク（Springboot）で構築された非常に人気のあるサンプル Java アプリケーションです。</p><p>まず、PetClinic の GitHub リポジトリをクローンし、その後アプリケーションのコンパイル、ビルド、パッケージ化、テストを行います：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone https://github.com/spring-projects/spring-petclinic</span></span></code></pre></div><p><code>spring-petclinic</code> ディレクトリに移動します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> spring-petclinic
</span></span><span class=line><span class=cl>git checkout b26f235250627a235a2974a22f2317dbef27338d</span></span></code></pre></div><p>Docker を使用して、PetClinic が使用する MySQL データベースを起動します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run -d -e <span class=nv>MYSQL_USER</span><span class=o>=</span>petclinic -e <span class=nv>MYSQL_PASSWORD</span><span class=o>=</span>petclinic -e <span class=nv>MYSQL_ROOT_PASSWORD</span><span class=o>=</span>root -e <span class=nv>MYSQL_DATABASE</span><span class=o>=</span>petclinic -p 3306:3306 docker.io/biarms/mysql:5.7</span></span></code></pre></div><p>次に、PetClinic アプリケーションにシンプルなトラフィックを生成する Locust を実行する別のコンテナを起動します。Locust は、Web アプリケーションにトラフィックを生成するために使用できるシンプルな負荷テストツールです。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run --network<span class=o>=</span><span class=s2>&#34;host&#34;</span> -d -p 8090:8090 -v ~/workshop/petclinic:/mnt/locust docker.io/locustio/locust -f /mnt/locust/locustfile.py --headless -u <span class=m>1</span> -r <span class=m>1</span> -H http://127.0.0.1:8083</span></span></code></pre></div><p>次に、<code>maven</code> を使用して PetClinic をコンパイル、ビルド、パッケージ化します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./mvnw package -Dmaven.test.skip<span class=o>=</span>true</span></span></code></pre></div><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info-circle"></i>
情報</summary><div class=box-content><p>初回実行時は数分かかり、アプリケーションをコンパイルする前に多くの依存関係をダウンロードします。以降のビルドはより高速になります。</p></div></details><p>ビルドが完了したら、実行しているインスタンスのパブリック IP アドレスを取得する必要があります。以下のコマンドを実行して取得できます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://ifconfig.me</span></span></code></pre></div><p>IP アドレスが返されます。アプリケーションが実行されていることを確認するために必要になるので、この IP アドレスをメモしておいてください。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article><article class=default><header class=headline></header><h1 id=3-real-user-monitoring>3. Real User Monitoring</h1><p>Real User Monitoring (RUM) の計装では、ページに OpenTelemetry Javascript スニペット <a href=https://github.com/signalfx/splunk-otel-js-web rel=external><strong>https://github.com/signalfx/splunk-otel-js-web</strong></a> を追加します。ウィザードを使用して <strong>Data Management → Add Integration → RUM Instrumentation → Browser Instrumentation</strong> の順に進みます。</p><p>インストラクターがドロップダウンから使用するトークンを指示します。<strong>Next</strong> をクリックしてください。以下の形式で <strong>App name</strong> と <strong>Environment</strong> を入力します：</p><ul><li><code>&lt;INSTANCE>-petclinic-service</code> - <code>&lt;INSTANCE></code> を先ほどメモした値に置き換えてください。</li><li><code>&lt;INSTANCE>-petclinic-env</code> - <code>&lt;INSTANCE></code> を先ほどメモした値に置き換えてください。</li></ul><p>ウィザードは、ページの <code>&lt;head></code> セクションの先頭に配置する必要がある HTML コードスニペットを表示します。以下は例です（このスニペットは使用せず、ウィザードが生成したものを使用してください）：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>/*
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>IMPORTANT: Replace the <span class=p>&lt;</span><span class=nt>version</span><span class=p>&gt;</span> placeholder in the src URL with a
</span></span><span class=line><span class=cl>version from https://github.com/signalfx/splunk-otel-js-web/releases
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>*/
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js&#34;</span> <span class=na>crossorigin</span><span class=o>=</span><span class=s>&#34;anonymous&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nx>SplunkRum</span><span class=p>.</span><span class=nx>init</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>realm</span><span class=o>:</span> <span class=s2>&#34;eu0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>rumAccessToken</span><span class=o>:</span> <span class=s2>&#34;&lt;redacted&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>applicationName</span><span class=o>:</span> <span class=s2>&#34;petclinic-1be0-petclinic-service&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>deploymentEnvironment</span><span class=o>:</span> <span class=s2>&#34;petclinic-1be0-petclinic-env&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div><p>Spring PetClinic アプリケーションは、アプリケーションのすべてのページで再利用される単一の HTML ページを「レイアウト」ページとして使用しています。Splunk RUM 計装ライブラリを挿入するには、すべてのページで自動的に読み込まれるため、この場所が最適です。</p><p>それでは、レイアウトページを編集しましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi src/main/resources/templates/fragments/layout.html</span></span></code></pre></div><p>次に、上記で生成したスニペットをページの <code>&lt;head></code> セクションに挿入します。コメントは含めず、ソース URL の <code>&lt;version></code> を <code>latest</code> に置き換えてください：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!doctype html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span> <span class=na>th:fragment</span><span class=o>=</span><span class=s>&#34;layout (template, menu)&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js&#34;</span> <span class=na>crossorigin</span><span class=o>=</span><span class=s>&#34;anonymous&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nx>SplunkRum</span><span class=p>.</span><span class=nx>init</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>realm</span><span class=o>:</span> <span class=s2>&#34;eu0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>rumAccessToken</span><span class=o>:</span> <span class=s2>&#34;&lt;redacted&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>applicationName</span><span class=o>:</span> <span class=s2>&#34;petclinic-1be0-petclinic-service&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>deploymentEnvironment</span><span class=o>:</span> <span class=s2>&#34;petclinic-1be0-petclinic-env&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>...</span></span></code></pre></div><p>コード変更が完了したら、アプリケーションを再ビルドして再度実行する必要があります。<code>maven</code> コマンドを実行して PetClinic をコンパイル/ビルド/パッケージ化します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./mvnw package -Dmaven.test.skip<span class=o>=</span>true</span></span></code></pre></div><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>java <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dserver.port<span class=o>=</span><span class=m>8083</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dotel.service.name<span class=o>=</span><span class=nv>$INSTANCE</span>-petclinic-service <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dotel.resource.attributes<span class=o>=</span>deployment.environment<span class=o>=</span><span class=nv>$INSTANCE</span>-petclinic-env,version<span class=o>=</span>0.314 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-jar target/spring-petclinic-*.jar --spring.profiles.active<span class=o>=</span>mysql</span></span></code></pre></div><p>次に、ブラウザを使用してアプリケーション <code>http://&lt;IP_ADDRESS>:8083</code> にアクセスし、実際のユーザートラフィックを生成します。</p><p>RUM で、上記の RUM スニペットで定義された環境にフィルタリングし、ダッシュボードをクリックして開きます。</p><p>RUM トレースをドリルダウンすると、スパン内に APM へのリンクが表示されます。トレース ID をクリックすると、現在の RUM トレースに対応する APM トレースに移動します。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article><article class=default><header class=headline></header><h1 id=java-向け自動ディスカバリーおよび設定>Java 向け自動ディスカバリーおよび設定</h1><p>以下のコマンドでアプリケーションを起動できます。<code>mysql</code> プロファイルをアプリケーションに渡していることに注目してください。これにより、先ほど起動した MySQL データベースを使用するようアプリケーションに指示します。また、<code>otel.service.name</code> と <code>otel.resource.attributes</code> をインスタンス名を使用した論理名に設定しています。これらは UI でのフィルタリングにも使用されます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>java <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dserver.port<span class=o>=</span><span class=m>8083</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dotel.service.name<span class=o>=</span><span class=nv>$INSTANCE</span>-petclinic-service <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dotel.resource.attributes<span class=o>=</span>deployment.environment<span class=o>=</span><span class=nv>$INSTANCE</span>-petclinic-env <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-jar target/spring-petclinic-*.jar --spring.profiles.active<span class=o>=</span>mysql</span></span></code></pre></div><p><code>http://&lt;IP_ADDRESS>:8083</code>（<code>&lt;IP_ADDRESS></code> を先ほど取得した IP アドレスに置き換えてください）にアクセスして、アプリケーションが実行されていることを確認できます。</p><p>Collector をインストールした際、<strong>AlwaysOn Profiling</strong> と <strong>Metrics</strong> を有効にするように設定しました。これにより、Collector はアプリケーションの CPU およびメモリプロファイルを自動的に生成し、Splunk Observability Cloud に送信します。</p><p>PetClinic アプリケーションを起動すると、Collector がアプリケーションを自動的に検出し、トレースとプロファイリングのために計装するのが確認できます。</p><div class=tab-panel data-tab-group=R-tabs-5ca0f048585284d6e86089b1e1fbb45c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-023d5f8c42687e9948e37511af4f7726 aria-expanded=true data-tab-item=R-tab-022e401a0cdb9f22931069a5fda6aa70 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-5ca0f048585284d6e86089b1e1fbb45c","R-tab-022e401a0cdb9f22931069a5fda6aa70")'>
<span class=tab-nav-text>出力例</span></button></div><div class=tab-content-container><div id=R-tab-id-023d5f8c42687e9948e37511af4f7726 data-tab-item=R-tab-022e401a0cdb9f22931069a5fda6aa70 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Picked up JAVA_TOOL_OPTIONS: -javaagent:/usr/lib/splunk-instrumentation/splunk-otel-javaagent.jar
</span></span><span class=line><span class=cl>OpenJDK 64-Bit Server VM warning: Sharing is only supported for boot loader classes because bootstrap classpath has been appended
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:58:970 +0000] [main] INFO io.opentelemetry.javaagent.tooling.VersionLogger - opentelemetry-javaagent - version: splunk-2.6.0-otel-2.6.0
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:730 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger - -----------------------
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:730 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger - Profiler configuration:
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:730 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -                  splunk.profiler.enabled : true
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:731 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -                splunk.profiler.directory : /tmp
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:731 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -       splunk.profiler.recording.duration : 20s
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:731 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -               splunk.profiler.keep-files : false
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:732 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -            splunk.profiler.logs-endpoint : null
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:732 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -              otel.exporter.otlp.endpoint : null
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:732 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -           splunk.profiler.memory.enabled : true
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:732 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -        splunk.profiler.memory.event.rate : 150/s
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:732 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -      splunk.profiler.call.stack.interval : PT10S
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:733 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -  splunk.profiler.include.internal.stacks : false
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:733 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -      splunk.profiler.tracing.stacks.only : false
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:733 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger - -----------------------
</span></span><span class=line><span class=cl>[otel.javaagent 2024-08-20 11:35:59:733 +0000] [main] INFO com.splunk.opentelemetry.profiler.JfrActivator - Profiler is active.</span></span></code></pre></div></div></div></div></div><p>Splunk APM UI にアクセスして、アプリケーションコンポーネント、トレース、プロファイリング、DB Query パフォーマンス、メトリクスを確認できます。左側のメニューから <strong>APM</strong> をクリックし、<strong>Environment</strong> ドロップダウンをクリックして、ご自身の環境（例：<code>&lt;INSTANCE>-petclinic</code>、<code>&lt;INSTANCE></code> は先ほどメモした値に置き換えてください）を選択します。</p><p>検証が完了したら、<code>Ctrl-c</code> を押してアプリケーションを停止できます。</p><p>リソース属性は、報告されるすべてのスパンに追加できます。例えば <code>version=0.314</code> のように指定します。カンマ区切りのリソース属性リストも定義できます（例：<code>key1=val1,key2=val2</code>）。</p><p>新しいリソース属性を使用して PetClinic を再度起動しましょう。実行コマンドにリソース属性を追加すると、Collector のインストール時に定義された内容が上書きされることに注意してください。新しいリソース属性 <code>version=0.314</code> を追加しましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>java <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dserver.port<span class=o>=</span><span class=m>8083</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dotel.service.name<span class=o>=</span><span class=nv>$INSTANCE</span>-petclinic-service <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-Dotel.resource.attributes<span class=o>=</span>deployment.environment<span class=o>=</span><span class=nv>$INSTANCE</span>-petclinic-env,version<span class=o>=</span>0.314 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-jar target/spring-petclinic-*.jar --spring.profiles.active<span class=o>=</span>mysql</span></span></code></pre></div><p>Splunk APM UI に戻り、最近のトレースをドリルダウンすると、スパン内に新しい <code>version</code> 属性が表示されます。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article><article class=default><header class=headline></header><h1 id=4-log-observer>4. Log Observer</h1><p>Splunk Log Observer コンポーネントでは、Splunk OpenTelemetry Collector が Spring PetClinic アプリケーションからログを自動的に収集し、OTLP エクスポーターを使用して Splunk Observability Cloud に送信します。その際、ログイベントに <code>trace_id</code>、<code>span_id</code>、トレースフラグを付与します。</p><p>Log Observer は、アプリケーションとインフラストラクチャからのログをリアルタイムで表示します。ログの検索、フィルタリング、分析を行って、問題のトラブルシューティングや環境の監視が可能です。</p><p>PetClinic Web アプリケーションに戻り、<strong>Error</strong> リンクを数回クリックしてください。これにより、PetClinic アプリケーションログにいくつかのログメッセージが生成されます。</p><p><a href=#R-image-4b696f8c4c5910c689b89ebf3b94d761 class=lightbox-link><img alt="PetClinic Error" class="lazy lightbox figure-image" loading=lazy src=../images/petclinic-error.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-4b696f8c4c5910c689b89ebf3b94d761><img alt="PetClinic Error" class="lazy lightbox lightbox-image" loading=lazy src=../images/petclinic-error.png></a></p><p>左側のメニューから <strong>Log Observer</strong> をクリックし、<strong>Index</strong> が <strong>splunk4rookies-workshop</strong> に設定されていることを確認してください。</p><p>次に、<strong>Add Filter</strong> をクリックし、フィールド <code>service.name</code> を検索して、値 <code>&lt;INSTANCE>-petclinic-service</code> を選択し、<code>=</code>（include）をクリックします。これで、PetClinic アプリケーションからのログメッセージのみが表示されるはずです。</p><p>PetClinic アプリケーションの <strong>Error</strong> リンクをクリックして生成されたログエントリの1つを選択してください。ログメッセージと、ログメッセージに自動的にインジェクションされたトレースメタデータが表示されます。また、APM と Infrastructure の Related Content が利用可能であることにも注目してください。</p><p><a href=#R-image-70d9d437de8d1b6c361eed3c8135aad5 class=lightbox-link><img alt="Log Observer" class="lazy lightbox figure-image" loading=lazy src=../images/log-observer.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-70d9d437de8d1b6c361eed3c8135aad5><img alt="Log Observer" class="lazy lightbox lightbox-image" loading=lazy src=../images/log-observer.png></a></p><p>これでワークショップは終了です。多くの内容をカバーしました。この時点で、メトリクス、トレース（APM と RUM）、ログ、データベースクエリパフォーマンス、コードプロファイリングが Splunk Observability Cloud に報告されているはずです。しかも、PetClinic アプリケーションのコードを変更することなく実現できました（RUM を除く）。</p><p><strong>おめでとうございます！</strong></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=kubernetes-上の-spring-petclinic-springboot-ベースのマイクロサービス>Kubernetes 上の Spring PetClinic SpringBoot ベースのマイクロサービス</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>90 minutes</span>
</span>&nbsp;
<span class="badge cstyle blue badge-with-title"><span class=badge-title class=text-muted>Author
</span><span class=badge-content>Pieter Hagen</span></span><p>このワークショップの目的は、Java 向けの Splunk <strong>自動ディスカバリーおよび設定</strong>機能を紹介することです。</p><p>ワークショップのシナリオは、Kubernetes にシンプルな（<strong>計装されていない</strong>）Java マイクロサービスアプリケーションをインストールすることで作成されます。</p><p>既存の Java ベースのデプロイメント向けに自動ディスカバリー機能付きの Splunk OpenTelemetry Collector をインストールする簡単な手順に従うことで、メトリクス、トレース、ログを <strong>Splunk Observability Cloud</strong> に送信することがいかに簡単かを確認できます。</p><details open class="box cstyle notices splunk"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-circle-info"></i>
前提条件</summary><div class=box-content><ul><li>ポート <strong>2222</strong> へのアウトバウンド SSH アクセス</li><li>ポート <strong>81</strong> へのアウトバウンド HTTP アクセス</li><li>Linux コマンドラインの基本的な知識</li></ul></div></details><p>このワークショップでは、以下のコンポーネントをカバーします：</p><ul><li>Splunk Infrastructure Monitoring (<strong>IM</strong>)</li><li>Splunk automatic discovery and configuration for Java (<strong>APM</strong>)<ul><li>Database Query Performance</li><li>AlwaysOn Profiling</li></ul></li><li>Splunk Log Observer (<strong>LO</strong>)</li><li>Splunk Real User Monitoring (<strong>RUM</strong>)</li></ul><p><em>Splunk Synthetics は少し寂しそうですが、他のワークショップでカバーしています</em> <i class="fa-fw fas fa-heart"></i></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article><section><h1 class=a11y-only>PetClinic Kubernetes ワークショップのサブセクション</h1><article class=default><header class=headline></header><h1 id=アーキテクチャ>アーキテクチャ</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>5 minutes</span>
</span>&nbsp;<p>Spring PetClinic Java アプリケーションは、フロントエンドとバックエンドのサービスで構成されるシンプルなマイクロサービスアプリケーションです。フロントエンドサービスは、バックエンドサービスと対話するための Web インターフェースを提供する Spring Boot アプリケーションです。バックエンドサービスは、MySQL データベースと対話するための RESTful API を提供する Spring Boot アプリケーションです。</p><p>このワークショップを終えるころには、Kubernetes で実行される Java ベースのアプリケーション向けの<strong>自動ディスカバリーおよび設定</strong>を有効にする方法をより深く理解できるようになります。</p><p>以下の図は、Splunk OpenTelemetry Operator と自動ディスカバリーおよび設定を有効にした状態で Kubernetes 上で実行される Spring PetClinic Java アプリケーションのアーキテクチャを詳しく示しています。</p><p><a href=#R-image-5abb3f8985b3321ff820a68fefed664e class=lightbox-link><img alt="Splunk Otel Architecture" class="lazy lightbox figure-image" loading=lazy src=../images/auto-instrumentation-java-diagram.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5abb3f8985b3321ff820a68fefed664e><img alt="Splunk Otel Architecture" class="lazy lightbox lightbox-image" loading=lazy src=../images/auto-instrumentation-java-diagram.png></a></p><hr><p><strong>Josh Voravong</strong> が作成した<a href=https://github.com/signalfx/splunk-otel-collector-chart/blob/main/examples/enable-operator-and-auto-instrumentation/spring-petclinic-java.md rel=external><strong>サンプル</strong></a>に基づいています。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article><article class=default><header class=headline></header><h1 id=ワークショップインスタンスの準備>ワークショップインスタンスの準備</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>15 minutes</span>
</span>&nbsp;<p>インストラクターが、このワークショップで使用するインスタンスのログイン情報を提供します。</p><p>インスタンスに初めてログインすると、以下のような Splunk ロゴが表示されます。ワークショップインスタンスへの接続に問題がある場合は、インストラクターにお問い合わせください。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ ssh -p 2222 splunk@&lt;IP-ADDRESS&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>███████╗██████╗ ██╗     ██╗   ██╗███╗   ██╗██╗  ██╗    ██╗
</span></span><span class=line><span class=cl>██╔════╝██╔══██╗██║     ██║   ██║████╗  ██║██║ ██╔╝    ╚██╗
</span></span><span class=line><span class=cl>███████╗██████╔╝██║     ██║   ██║██╔██╗ ██║█████╔╝      ╚██╗
</span></span><span class=line><span class=cl>╚════██║██╔═══╝ ██║     ██║   ██║██║╚██╗██║██╔═██╗      ██╔╝
</span></span><span class=line><span class=cl>███████║██║     ███████╗╚██████╔╝██║ ╚████║██║  ██╗    ██╔╝
</span></span><span class=line><span class=cl>╚══════╝╚═╝     ╚══════╝ ╚═════╝ ╚═╝  ╚═══╝╚═╝  ╚═╝    ╚═╝
</span></span><span class=line><span class=cl>Last login: Mon Feb  5 11:04:54 2024 from [Redacted]
</span></span><span class=line><span class=cl>splunk@show-no-config-i-0d1b29d967cb2e6ff ~ $</span></span></code></pre></div><p>インスタンスが正しく設定されていることを確認するために、このワークショップに必要な環境変数が正しく設定されているか確認する必要があります。ターミナルで以下のスクリプトを実行し、環境変数が存在し、実際の有効な値が設定されていることを確認してください：</p><div class=tab-panel data-tab-group=R-tabs-1d0310570c66b77c3ab1e783dcdc7ca9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-80b744902a1ea1f00f7a3c4c9a552691 aria-expanded=true data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-1d0310570c66b77c3ab1e783dcdc7ca9","R-tab-f907e651164789346ae0a1e257c462d8")'>
<span class=tab-nav-text>Script</span>
</button>
<button aria-controls=R-tab-id-a6248b01550987470921581cf406105b aria-expanded=false data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-1d0310570c66b77c3ab1e783dcdc7ca9","R-tab-4c50e65a8a1f9aa989870396b5c0a12b")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div id=R-tab-id-80b744902a1ea1f00f7a3c4c9a552691 data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. ~/workshop/petclinic/scripts/check_env.sh</span></span></code></pre></div></div></div><div id=R-tab-id-a6248b01550987470921581cf406105b data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>ACCESS_TOKEN</span> <span class=o>=</span> &lt;redacted&gt;
</span></span><span class=line><span class=cl><span class=nv>REALM</span> <span class=o>=</span> &lt;e.g. eu0, us1, us2, jp0, au0 etc.&gt;
</span></span><span class=line><span class=cl><span class=nv>RUM_TOKEN</span> <span class=o>=</span> &lt;redacted&gt;
</span></span><span class=line><span class=cl><span class=nv>HEC_TOKEN</span> <span class=o>=</span> &lt;redacted&gt;
</span></span><span class=line><span class=cl><span class=nv>HEC_URL</span> <span class=o>=</span> https://&lt;...&gt;/services/collector/event
</span></span><span class=line><span class=cl><span class=nv>INSTANCE</span> <span class=o>=</span> &lt;instance_name&gt;</span></span></code></pre></div></div></div></div></div><p><code>INSTANCE</code> 環境変数の値をメモしておいてください。後で <strong>Splunk Observability Cloud</strong> でデータをフィルタリングする際に使用します。</p><p>このワークショップでは、上記の環境変数が<strong>すべて</strong>必要です。値が不足しているものがある場合は、インストラクターに連絡してください。</p><details open class="box cstyle notices splunk"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-circle-info"></i>
既存の OpenTelemetry Collector の削除</summary><div class=box-content><p>この EC2 インスタンスを使用して以前に Splunk Observability ワークショップを完了している場合は、
既存の Splunk OpenTelemetry Collector のインストールが削除されていることを確認する必要があります。
これは以下のコマンドを実行することで行えます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm delete splunk-otel-collector</span></span></code></pre></div></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article><section><h1 class=a11y-only>2. 準備のサブセクション</h1><article class=default><header class=headline></header><h1 id=splunk-opentelemetry-collector-のデプロイ>Splunk OpenTelemetry Collector のデプロイ</h1><p>オブザーバビリティシグナル（<strong>メトリクス、トレース</strong>、<strong>ログ</strong>）を <strong>Splunk Observability Cloud</strong> に送信するには、Kubernetes クラスターに Splunk OpenTelemetry Collector をデプロイする必要があります。</p><p>このワークショップでは、Splunk OpenTelemetry Collector Helm Chart を使用します。まず、Helm chart リポジトリを Helm に追加し、<code>helm repo update</code> を実行して最新バージョンを確認します：</p><div class=tab-panel data-tab-group=R-tabs-aa7fa134f17f9c7547e3172731bb3bcf><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-84566e3dc56078618fe2955f9483adee aria-expanded=true data-tab-item=R-tab-62904166d08e5d1c0cd759a707578288 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-aa7fa134f17f9c7547e3172731bb3bcf","R-tab-62904166d08e5d1c0cd759a707578288")'>
<span class=tab-nav-text>Install Helm Chart</span>
</button>
<button aria-controls=R-tab-id-421f5bb2bbc0638c719ad3cae76b80e7 aria-expanded=false data-tab-item=R-tab-29c2c02a361c9d7028472e5d92cd4a54 class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-aa7fa134f17f9c7547e3172731bb3bcf","R-tab-29c2c02a361c9d7028472e5d92cd4a54")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div id=R-tab-id-84566e3dc56078618fe2955f9483adee data-tab-item=R-tab-62904166d08e5d1c0cd759a707578288 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm repo add splunk-otel-collector-chart https://signalfx.github.io/splunk-otel-collector-chart <span class=o>&amp;&amp;</span> helm repo update</span></span></code></pre></div></div></div><div id=R-tab-id-421f5bb2bbc0638c719ad3cae76b80e7 data-tab-item=R-tab-29c2c02a361c9d7028472e5d92cd4a54 class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Using ACCESS_TOKEN={REDACTED}
</span></span><span class=line><span class=cl>Using REALM=eu0
</span></span><span class=line><span class=cl>&#34;splunk-otel-collector-chart&#34; has been added to your repositories
</span></span><span class=line><span class=cl>Using ACCESS_TOKEN={REDACTED}
</span></span><span class=line><span class=cl>Using REALM=eu0
</span></span><span class=line><span class=cl>Hang tight while we grab the latest from your chart repositories...
</span></span><span class=line><span class=cl>...Successfully got an update from the &#34;splunk-otel-collector-chart&#34; chart repository
</span></span><span class=line><span class=cl>Update Complete. ⎈Happy Helming!⎈</span></span></code></pre></div></div></div></div></div><p><strong>Splunk Observability Cloud</strong> では、Kubernetes 上での OpenTelemetry Collector のセットアップを案内する UI ウィザードが提供されていますが、時間の都合上、以下の Helm install コマンドを使用します。自動ディスカバリーおよび設定とコードプロファイリング用のオペレーターを有効にするための追加パラメータが設定されています。</p><ul><li><code>--set="operator.enabled=true"</code> - 自動ディスカバリーおよび設定を処理するための OpenTelemetry オペレーターをインストールします。</li><li><code>--set="splunkObservability.profilingEnabled=true"</code> - オペレーター経由でコードプロファイリングを有効にします。</li></ul><p>Collector をインストールするには、以下のコマンドを実行してください。これを編集<strong>しないでください</strong>：</p><div class=tab-panel data-tab-group=R-tabs-fbd92074ae9a4dd8e460802fc54a77f7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-5819735438e870425033aee0fe69ca38 aria-expanded=true data-tab-item=R-tab-5ade205167430c5bf55768631515900b class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-fbd92074ae9a4dd8e460802fc54a77f7","R-tab-5ade205167430c5bf55768631515900b")'>
<span class=tab-nav-text>Helm Install</span>
</button>
<button aria-controls=R-tab-id-93c1c86ab25abfa0e37cb465725f1202 aria-expanded=false data-tab-item=R-tab-29c2c02a361c9d7028472e5d92cd4a54 class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-fbd92074ae9a4dd8e460802fc54a77f7","R-tab-29c2c02a361c9d7028472e5d92cd4a54")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div id=R-tab-id-5819735438e870425033aee0fe69ca38 data-tab-item=R-tab-5ade205167430c5bf55768631515900b class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm install splunk-otel-collector --version 0.136.0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;operatorcrds.install=true&#34;</span>, <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;operator.enabled=true&#34;</span>, <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.realm=</span><span class=nv>$REALM</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.accessToken=</span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;clusterName=</span><span class=nv>$INSTANCE</span><span class=s2>-k3s-cluster&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkObservability.profilingEnabled=true&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;agent.service.enabled=true&#34;</span>  <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;environment=</span><span class=nv>$INSTANCE</span><span class=s2>-workshop&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkPlatform.endpoint=</span><span class=nv>$HEC_URL</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkPlatform.token=</span><span class=nv>$HEC_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--set<span class=o>=</span><span class=s2>&#34;splunkPlatform.index=splunk4rookies-workshop&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>splunk-otel-collector-chart/splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-f ~/workshop/k3s/otel-collector.yaml</span></span></code></pre></div></div></div><div id=R-tab-id-93c1c86ab25abfa0e37cb465725f1202 data-tab-item=R-tab-29c2c02a361c9d7028472e5d92cd4a54 class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>LAST DEPLOYED: Fri Apr 19 09:39:54 2024
</span></span><span class=line><span class=cl>NAMESPACE: default
</span></span><span class=line><span class=cl>STATUS: deployed
</span></span><span class=line><span class=cl>REVISION: 1
</span></span><span class=line><span class=cl>NOTES:
</span></span><span class=line><span class=cl>Splunk OpenTelemetry Collector is installed and configured to send data to Splunk Platform endpoint &#34;https://http-inputs-o11y-workshop-eu0.splunkcloud.com:443/services/collector/event&#34;.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Splunk OpenTelemetry Collector is installed and configured to send data to Splunk Observability realm eu0.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[INFO] You&#39;ve enabled the operator&#39;s auto-instrumentation feature (operator.enabled=true)! The operator can automatically instrument Kubernetes hosted applications.
</span></span><span class=line><span class=cl>  - Status: Instrumentation language maturity varies. See `operator.instrumentation.spec` and documentation for utilized instrumentation details.
</span></span><span class=line><span class=cl>  - Splunk Support: We offer full support for Splunk distributions and best-effort support for native OpenTelemetry distributions of auto-instrumentation libraries.</span></span></code></pre></div></div></div></div></div><p>続行する前に、Pod が <strong>Running</strong> として報告されていることを確認してください（通常約30秒かかります）。</p><div class=tab-panel data-tab-group=R-tabs-e67ffd8b34a0123dfb8fc075b3356bd8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-604376493445b09669f7b19802da9ef4 aria-expanded=true data-tab-item=R-tab-380f56daf2c41382fed5e183e4f1fbe1 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-e67ffd8b34a0123dfb8fc075b3356bd8","R-tab-380f56daf2c41382fed5e183e4f1fbe1")'>
<span class=tab-nav-text>kubectl get pods</span>
</button>
<button aria-controls=R-tab-id-81d53465aa2b925889fca08057e367b4 aria-expanded=false data-tab-item=R-tab-29c2c02a361c9d7028472e5d92cd4a54 class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-e67ffd8b34a0123dfb8fc075b3356bd8","R-tab-29c2c02a361c9d7028472e5d92cd4a54")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div id=R-tab-id-604376493445b09669f7b19802da9ef4 data-tab-item=R-tab-380f56daf2c41382fed5e183e4f1fbe1 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pods <span class=p>|</span> grep splunk-otel</span></span></code></pre></div></div></div><div id=R-tab-id-81d53465aa2b925889fca08057e367b4 data-tab-item=R-tab-29c2c02a361c9d7028472e5d92cd4a54 class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>splunk-otel-collector-k8s-cluster-receiver-6bd5567d95-5f8cj     1/1     Running   0          10m
</span></span><span class=line><span class=cl>splunk-otel-collector-agent-tspd2                               1/1     Running   0          10m
</span></span><span class=line><span class=cl>splunk-otel-collector-operator-69d476cb7-j7zwd                  2/2     Running   0          10m</span></span></code></pre></div></div></div></div></div><p>Splunk OpenTelemetry Collector からエラーが報告されていないことを確認してください（<code>ctrl + c</code> で終了）。または、インストール済みの<strong>素晴らしい</strong> <code>k9s</code> ターミナル UI を使用するとボーナスポイントです！</p><div class=tab-panel data-tab-group=R-tabs-1e99802ad79ac55e34c8337c1ae2fad5><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-e232a5e2d904198c9cac5ab54ee1b26d aria-expanded=true data-tab-item=R-tab-66b92e950fb2f856e1fdec23c736e201 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-1e99802ad79ac55e34c8337c1ae2fad5","R-tab-66b92e950fb2f856e1fdec23c736e201")'>
<span class=tab-nav-text>kubectl logs</span>
</button>
<button aria-controls=R-tab-id-a9c67fdb9efedfdb9bbce16e2951e228 aria-expanded=false data-tab-item=R-tab-29c2c02a361c9d7028472e5d92cd4a54 class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-1e99802ad79ac55e34c8337c1ae2fad5","R-tab-29c2c02a361c9d7028472e5d92cd4a54")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div id=R-tab-id-e232a5e2d904198c9cac5ab54ee1b26d data-tab-item=R-tab-66b92e950fb2f856e1fdec23c736e201 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl logs -l <span class=nv>app</span><span class=o>=</span>splunk-otel-collector -f --container otel-collector</span></span></code></pre></div></div></div><div id=R-tab-id-a9c67fdb9efedfdb9bbce16e2951e228 data-tab-item=R-tab-29c2c02a361c9d7028472e5d92cd4a54 class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>2021-03-21T16:11:10.900Z        INFO    service/service.go:364  Starting receivers...
</span></span><span class=line><span class=cl>2021-03-21T16:11:10.900Z        INFO    builder/receivers_builder.go:70 Receiver is starting... {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;prometheus&#34;, &#34;component_name&#34;: &#34;prometheus&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    builder/receivers_builder.go:75 Receiver started.       {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;prometheus&#34;, &#34;component_name&#34;: &#34;prometheus&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    builder/receivers_builder.go:70 Receiver is starting... {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    k8sclusterreceiver@v0.21.0/watcher.go:195       Configured Kubernetes MetadataExporter  {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;, &#34;exporter_name&#34;: &#34;signalfx&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    builder/receivers_builder.go:75 Receiver started.       {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    healthcheck/handler.go:128      Health Check state change       {&#34;component_kind&#34;: &#34;extension&#34;, &#34;component_type&#34;: &#34;health_check&#34;, &#34;component_name&#34;: &#34;health_check&#34;, &#34;status&#34;: &#34;ready&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    service/service.go:267  Everything is ready. Begin running and processing data.
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.009Z        INFO    k8sclusterreceiver@v0.21.0/receiver.go:59       Starting shared informers and wait for initial cache sync.      {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;}
</span></span><span class=line><span class=cl>2021-03-21T16:11:11.281Z        INFO    k8sclusterreceiver@v0.21.0/receiver.go:75       Completed syncing shared informer caches.       {&#34;component_kind&#34;: &#34;receiver&#34;, &#34;component_type&#34;: &#34;k8s_cluster&#34;, &#34;component_name&#34;: &#34;k8s_cluster&#34;}</span></span></code></pre></div></div></div></div></div><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info-circle"></i>
失敗したインストールの削除</summary><div class=box-content><p>OpenTelemetry Collector のインストールでエラーが発生した場合は、
以下のコマンドでインストールを削除してやり直すことができます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm delete splunk-otel-collector</span></span></code></pre></div></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article><article class=default><header class=headline></header><h1 id=petclinic-アプリケーションのデプロイ>PetClinic アプリケーションのデプロイ</h1><p>アプリケーションの最初のデプロイメントでは、ビルド済みのコンテナを使用して、観測を開始したい Kubernetes で実行される通常の Java マイクロサービスベースのアプリケーションという基本シナリオを作成します。それでは、アプリケーションをデプロイしましょう：</p><div class=tab-panel data-tab-group=R-tabs-4e1d65d4c7a0a9c6cb1ba313f138b2fa><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-bab031c55d5bb58c49cb204ee8e4e143 aria-expanded=true data-tab-item=R-tab-8666ad26e93cd530823e6e5a5c706f5a class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-4e1d65d4c7a0a9c6cb1ba313f138b2fa","R-tab-8666ad26e93cd530823e6e5a5c706f5a")'>
<span class=tab-nav-text>kubectl apply</span>
</button>
<button aria-controls=R-tab-id-7d5e2870a5fa2b187f3f1bfcaab3392a aria-expanded=false data-tab-item=R-tab-29c2c02a361c9d7028472e5d92cd4a54 class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-4e1d65d4c7a0a9c6cb1ba313f138b2fa","R-tab-29c2c02a361c9d7028472e5d92cd4a54")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div id=R-tab-id-bab031c55d5bb58c49cb204ee8e4e143 data-tab-item=R-tab-8666ad26e93cd530823e6e5a5c706f5a class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f ~/workshop/petclinic/deployment.yaml</span></span></code></pre></div></div></div><div id=R-tab-id-7d5e2870a5fa2b187f3f1bfcaab3392a data-tab-item=R-tab-29c2c02a361c9d7028472e5d92cd4a54 class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>deployment.apps/config-server created
</span></span><span class=line><span class=cl>service/config-server created
</span></span><span class=line><span class=cl>deployment.apps/discovery-server created
</span></span><span class=line><span class=cl>service/discovery-server created
</span></span><span class=line><span class=cl>deployment.apps/api-gateway created
</span></span><span class=line><span class=cl>service/api-gateway created
</span></span><span class=line><span class=cl>service/api-gateway-external created
</span></span><span class=line><span class=cl>deployment.apps/customers-service created
</span></span><span class=line><span class=cl>service/customers-service created
</span></span><span class=line><span class=cl>deployment.apps/vets-service created
</span></span><span class=line><span class=cl>service/vets-service created
</span></span><span class=line><span class=cl>deployment.apps/visits-service created
</span></span><span class=line><span class=cl>service/visits-service created
</span></span><span class=line><span class=cl>deployment.apps/admin-server created
</span></span><span class=line><span class=cl>service/admin-server created
</span></span><span class=line><span class=cl>service/petclinic-db created
</span></span><span class=line><span class=cl>deployment.apps/petclinic-db created
</span></span><span class=line><span class=cl>configmap/petclinic-db-initdb-config created
</span></span><span class=line><span class=cl>deployment.apps/petclinic-loadgen-deployment created
</span></span><span class=line><span class=cl>configmap/scriptfile created</span></span></code></pre></div></div></div></div></div><p>この時点で、Pod が実行されていることを確認してデプロイメントを検証できます。コンテナのダウンロードと起動が必要なため、数分かかる場合があります。</p><div class=tab-panel data-tab-group=R-tabs-2c7d0d65fae306f1ce86e0c232157d9c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-40f26d254a73d185c7ab176841dab865 aria-expanded=true data-tab-item=R-tab-380f56daf2c41382fed5e183e4f1fbe1 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-2c7d0d65fae306f1ce86e0c232157d9c","R-tab-380f56daf2c41382fed5e183e4f1fbe1")'>
<span class=tab-nav-text>kubectl get pods</span>
</button>
<button aria-controls=R-tab-id-b6cda2565f7cf12c24783992b6b4fe10 aria-expanded=false data-tab-item=R-tab-29c2c02a361c9d7028472e5d92cd4a54 class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-2c7d0d65fae306f1ce86e0c232157d9c","R-tab-29c2c02a361c9d7028472e5d92cd4a54")'>
<span class=tab-nav-text>Output</span></button></div><div class=tab-content-container><div id=R-tab-id-40f26d254a73d185c7ab176841dab865 data-tab-item=R-tab-380f56daf2c41382fed5e183e4f1fbe1 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pods</span></span></code></pre></div></div></div><div id=R-tab-id-b6cda2565f7cf12c24783992b6b4fe10 data-tab-item=R-tab-29c2c02a361c9d7028472e5d92cd4a54 class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>NAME                                                            READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>splunk-otel-collector-k8s-cluster-receiver-655dcd9b6b-dcvkb     1/1     Running   <span class=m>0</span>          114s
</span></span><span class=line><span class=cl>splunk-otel-collector-agent-dg2vj                               1/1     Running   <span class=m>0</span>          114s
</span></span><span class=line><span class=cl>splunk-otel-collector-operator-57cbb8d7b4-dk5wf                 2/2     Running   <span class=m>0</span>          114s
</span></span><span class=line><span class=cl>petclinic-db-64d998bb66-2vzpn                                   1/1     Running   <span class=m>0</span>          58s
</span></span><span class=line><span class=cl>api-gateway-d88bc765-jd5lg                                      1/1     Running   <span class=m>0</span>          58s
</span></span><span class=line><span class=cl>visits-service-7f97b6c579-bh9zj                                 1/1     Running   <span class=m>0</span>          58s
</span></span><span class=line><span class=cl>admin-server-76d8b956c5-mb2zv                                   1/1     Running   <span class=m>0</span>          58s
</span></span><span class=line><span class=cl>customers-service-847db99f79-mzlg2                              1/1     Running   <span class=m>0</span>          58s
</span></span><span class=line><span class=cl>vets-service-7bdcd7dd6d-2tcfd                                   1/1     Running   <span class=m>0</span>          58s
</span></span><span class=line><span class=cl>petclinic-loadgen-deployment-5d69d7f4dd-xxkn4                   1/1     Running   <span class=m>0</span>          58s
</span></span><span class=line><span class=cl>config-server-67f7876d48-qrsr5                                  1/1     Running   <span class=m>0</span>          58s
</span></span><span class=line><span class=cl>discovery-server-554b45cfb-bqhgt                                1/1     Running   <span class=m>0</span>          58s</span></span></code></pre></div></div></div></div></div><p><code>kubectl get pods</code> の出力が、上記の Output タブに示されている出力と一致することを確認してください。すべてのサービスが <strong>Running</strong> と表示されていることを確認してください（または <code>k9s</code> を使用してステータスを継続的に監視できます）。</p><p>アプリケーションをテストするには、インスタンスのパブリック IP アドレスを取得する必要があります。以下のコマンドを実行して取得できます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://ifconfig.me</span></span></code></pre></div><p><strong>http://&lt;IP_ADDRESS>:81</strong>（<strong>&lt;IP_ADDRESS></strong> を上記で取得した IP アドレスに置き換えてください）にアクセスして、アプリケーションが実行されていることを確認してください。PetClinic アプリケーションが実行されているのが確認できるはずです。アプリケーションはポート <strong>80</strong> と <strong>443</strong> でも実行されているので、これらを使用するか、ポート <strong>81</strong> に到達できない場合はそちらを使用してください。</p><p><a href=#R-image-e3d2e9a62e42863d83e23171595ff042 class=lightbox-link><img alt="Pet shop" class="lazy lightbox figure-image" loading=lazy src=../../images/petclinic.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e3d2e9a62e42863d83e23171595ff042><img alt="Pet shop" class="lazy lightbox lightbox-image" loading=lazy src=../../images/petclinic.png></a></p><p><strong>All Owners</strong> <strong>(1)</strong> タブと <strong>Veterinarians</strong> <strong>(2)</strong> タブにアクセスして、各ページに名前のリストが表示されることを確認し、アプリケーションが正しく動作していることを確認してください。</p><p><a href=#R-image-4de429fbe487b4f895c5d6181f143e16 class=lightbox-link><img alt=Owners class="lazy lightbox figure-image" loading=lazy src=../../images/petclinic-owners.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-4de429fbe487b4f895c5d6181f143e16><img alt=Owners class="lazy lightbox lightbox-image" loading=lazy src=../../images/petclinic-owners.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=kubernetes-クラスターメトリクスの確認>Kubernetes クラスターメトリクスの確認</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<p>インストールが完了したら、<strong>Splunk Observability Cloud</strong> にログインして、Kubernetes クラスターからメトリクスが流れてきていることを確認できます。</p><p>左側のメニューから <strong>Infrastructure</strong> をクリックし、<strong>Kubernetes</strong> を選択してから、<strong>Kubernetes nodes</strong> タイルを選択します。</p><p><a href=#R-image-40ff47c298b4285a545e0f9113746bfa class=lightbox-link><img alt=NavigatorList class="lazy lightbox figure-image" loading=lazy src=../images/navigatorlist.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-40ff47c298b4285a545e0f9113746bfa><img alt=NavigatorList class="lazy lightbox lightbox-image" loading=lazy src=../images/navigatorlist.png></a></p><p><strong>Kubernetes nodes</strong> の概要画面に入ったら、<strong>Time</strong> フィルタを <strong>-1h</strong> から過去15分 <strong>(-15m)</strong> に変更して最新のデータに焦点を当て、次に <strong>Table</strong> を選択してメトリクスを報告しているすべてのノードをリスト表示します。</p><p>次に、<strong>Refine by:</strong> パネルで <strong>Cluster name</strong> を選択し、リストからご自身のクラスターを選択します。</p><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-lightbulb"></i>
Tip</summary><div class=box-content><p>特定のクラスターを識別するには、セットアップ中に実行したシェルスクリプト出力の <code>INSTANCE</code> 値を使用してください。この一意の識別子により、リスト内の他のノードの中からワークショップクラスターを見つけることができます。</p></div></details><p>これにより、ご自身のクラスターのノードのみを表示するようにリストがフィルタリングされます。</p><p><a href=#R-image-bdec9d6bfe105969b830d2e386a0d791 class=lightbox-link><img alt="K8s Nodes" class="lazy lightbox figure-image" loading=lazy src=../images/k8s-nodes.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-bdec9d6bfe105969b830d2e386a0d791><img alt="K8s Nodes" class="lazy lightbox lightbox-image" loading=lazy src=../images/k8s-nodes.png></a></p><p><strong>K8s node logs</strong> ビューに切り替えて、ノードからのログを確認します。</p><p><a href=#R-image-7776a0fcfdd56aaee44ebfcb8ac99f62 class=lightbox-link><img alt=Logs class="lazy lightbox figure-image" loading=lazy src=../images/k8s-peek-at-logs.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-7776a0fcfdd56aaee44ebfcb8ac99f62><img alt=Logs class="lazy lightbox lightbox-image" loading=lazy src=../images/k8s-peek-at-logs.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article><article class=default><header class=headline></header><h1 id=apmの自動検出と設定のセットアップ>APMの自動検出と設定のセットアップ</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10分</span>
</span>&nbsp;<p>このセクションでは、Kubernetes上で実行されているJavaサービスに対して<strong>自動検出と設定</strong>を有効化します。これにより、OpenTelemetry CollectorがPodアノテーションを検索し、JavaアプリケーションにSplunk OpenTelemetry Javaエージェントでインストゥルメンテーション (instrumentation) を行う必要があることを示します。これにより、クラスター上で実行されているJavaサービスからトレース (trace)、スパン (span)、およびプロファイリング (profiling) データを取得できるようになります。</p><details open class="box cstyle notices note"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-exclamation-circle"></i>
自動検出と設定</summary><div class=box-content><p>自動検出と設定は、<strong>コード変更や再コンパイルを必要とせず</strong>にアプリケーションから<strong>トレース、スパン、およびプロファイリング</strong>データを取得するように設計されていることを理解することが重要です。</p><p>これはAPMを始めるための優れた方法ですが、手動インストゥルメンテーション (manual instrumentation) の<strong>代替ではありません</strong>。手動インストゥルメンテーションでは、カスタムスパン、タグ、ログをアプリケーションに追加でき、トレースにより多くのコンテキストと詳細を提供できます。</p></div></details><p>Javaアプリケーションの場合、OpenTelemetry Collectorは<code>instrumentation.opentelemetry.io/inject-java</code>というアノテーションを検索します。</p><p>このアノテーションの値は<code>true</code>に設定するか、OpenTelemetry Collectorの<code>namespace/daemonset</code>（例：<code>default/splunk-otel-collector</code>）に設定できます。これにより、名前空間をまたいで動作することができ、このワークショップではこれを使用します。</p><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info-circle"></i>
deployment.yamlの使用</summary><div class=box-content><p>Podが自動的にトレースを送信するようにしたい場合は、以下に示すように<code>deployment.yaml</code>にアノテーションを追加できます。これにより、初期デプロイメント (deployment) 時にインストゥルメンテーションライブラリが追加されます。時間を節約するために、以下のPodに対してこれを実施済みです：</p><ul><li><strong>admin-server</strong></li><li><strong>config-server</strong></li><li><strong>discovery-server</strong></li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>admin-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/part-of</span><span class=p>:</span><span class=w> </span><span class=l>spring-petclinic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>admin-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>admin-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>instrumentation.opentelemetry.io/inject-java</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;default/splunk-otel-collector&#34;</span></span></span></code></pre></div></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article><section><h1 class=a11y-only>4. 自動検出と設定のサブセクション</h1><article class=default><header class=headline></header><h1 id=デプロイメントのパッチ適用>デプロイメントのパッチ適用</h1><p><strong>自動検出と設定</strong>を構成するには、デプロイメント (deployment) にインストゥルメンテーションアノテーションを追加するためのパッチを適用する必要があります。パッチが適用されると、OpenTelemetry Collectorが自動検出と設定ライブラリを注入し、Podが再起動されてトレース (trace) とプロファイリング (profiling) データの送信が開始されます。まず、以下を実行して<code>api-gateway</code>に<code>splunk-otel-java</code>イメージがないことを確認します：</p><div class=tab-panel data-tab-group=R-tabs-814124da647a1e2631b8b4a6585aabae><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-59b200f1475524409a082d082f743363 aria-expanded=true data-tab-item=R-tab-147de2e4d489d131e220c244ab59800a class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-814124da647a1e2631b8b4a6585aabae","R-tab-147de2e4d489d131e220c244ab59800a")'>
<span class=tab-nav-text>Describe api-gateway</span>
</button>
<button aria-controls=R-tab-id-213a129c3e4d3819a4659fb2d7458204 aria-expanded=false data-tab-item=R-tab-397382ef4cd20471e3d9c9fecb6c01a7 class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-814124da647a1e2631b8b4a6585aabae","R-tab-397382ef4cd20471e3d9c9fecb6c01a7")'>
<span class=tab-nav-text>Describe Output</span></button></div><div class=tab-content-container><div id=R-tab-id-59b200f1475524409a082d082f743363 data-tab-item=R-tab-147de2e4d489d131e220c244ab59800a class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe pods api-gateway <span class=p>|</span> grep Image:</span></span></code></pre></div></div></div><div id=R-tab-id-213a129c3e4d3819a4659fb2d7458204 data-tab-item=R-tab-397382ef4cd20471e3d9c9fecb6c01a7 class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Image:         quay.io/phagen/spring-petclinic-api-gateway:0.0.2</span></span></code></pre></div></div></div></div></div><p>次に、デプロイメントにアノテーションを追加して、すべてのサービスのJava自動検出と設定を有効にします。以下のコマンドは、すべてのデプロイメントにパッチを適用します。これにより、OpenTelemetry Operatorが<code>splunk-otel-java</code>イメージをPodに注入します：</p><div class=tab-panel data-tab-group=R-tabs-f255a1f2ba4ab1503484aaad312bf060><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-436e2e69b2f67dc56cb9ef736da5904b aria-expanded=true data-tab-item=R-tab-095a030c413da2306699957e31df046b class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-f255a1f2ba4ab1503484aaad312bf060","R-tab-095a030c413da2306699957e31df046b")'>
<span class=tab-nav-text>Patch all PetClinic services</span>
</button>
<button aria-controls=R-tab-id-51ab998a3c6dc78fc1686d50f1976d7f aria-expanded=false data-tab-item=R-tab-c7f3c9adf1663130bcb611eae74c77dc class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-f255a1f2ba4ab1503484aaad312bf060","R-tab-c7f3c9adf1663130bcb611eae74c77dc")'>
<span class=tab-nav-text>Patch Output</span></button></div><div class=tab-content-container><div id=R-tab-id-436e2e69b2f67dc56cb9ef736da5904b data-tab-item=R-tab-095a030c413da2306699957e31df046b class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get deployments -l app.kubernetes.io/part-of<span class=o>=</span>spring-petclinic -o name <span class=p>|</span> xargs -I % kubectl patch % -p <span class=s2>&#34;{\&#34;spec\&#34;: {\&#34;template\&#34;:{\&#34;metadata\&#34;:{\&#34;annotations\&#34;:{\&#34;instrumentation.opentelemetry.io/inject-java\&#34;:\&#34;default/splunk-otel-collector\&#34;}}}}}&#34;</span></span></span></code></pre></div></div></div><div id=R-tab-id-51ab998a3c6dc78fc1686d50f1976d7f data-tab-item=R-tab-c7f3c9adf1663130bcb611eae74c77dc class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>deployment.apps/config-server patched (no change)
</span></span><span class=line><span class=cl>deployment.apps/admin-server patched (no change)
</span></span><span class=line><span class=cl>deployment.apps/customers-service patched
</span></span><span class=line><span class=cl>deployment.apps/visits-service patched
</span></span><span class=line><span class=cl>deployment.apps/discovery-server patched (no change)
</span></span><span class=line><span class=cl>deployment.apps/vets-service patched
</span></span><span class=line><span class=cl>deployment.apps/api-gateway patched</span></span></code></pre></div></div></div></div></div><p><strong>config-server</strong>、<strong>discovery-server</strong>、<strong>admin-server</strong>については、すでにパッチが適用されているため変更はありません。</p><p><code>api-gateway</code> Podのコンテナイメージを再度確認するには、以下のコマンドを実行します：</p><div class=tab-panel data-tab-group=R-tabs-1adce46f728d78db1c05a9df40fa9dec><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-645335a94c94a895ac3cf48905290d7d aria-expanded=true data-tab-item=R-tab-147de2e4d489d131e220c244ab59800a class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-1adce46f728d78db1c05a9df40fa9dec","R-tab-147de2e4d489d131e220c244ab59800a")'>
<span class=tab-nav-text>Describe api-gateway</span>
</button>
<button aria-controls=R-tab-id-2e9c98c6ebc06d06ba30da4e61df4d6a aria-expanded=false data-tab-item=R-tab-397382ef4cd20471e3d9c9fecb6c01a7 class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-1adce46f728d78db1c05a9df40fa9dec","R-tab-397382ef4cd20471e3d9c9fecb6c01a7")'>
<span class=tab-nav-text>Describe Output</span></button></div><div class=tab-content-container><div id=R-tab-id-645335a94c94a895ac3cf48905290d7d data-tab-item=R-tab-147de2e4d489d131e220c244ab59800a class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe pods api-gateway <span class=p>|</span> grep Image:</span></span></code></pre></div></div></div><div id=R-tab-id-2e9c98c6ebc06d06ba30da4e61df4d6a data-tab-item=R-tab-397382ef4cd20471e3d9c9fecb6c01a7 class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Image:         ghcr.io/signalfx/splunk-otel-java/splunk-otel-java:v1.30.0
</span></span><span class=line><span class=cl>Image:         quay.io/phagen/spring-petclinic-api-gateway:0.0.2</span></span></code></pre></div></div></div></div></div><p><code>api-gateway</code>に新しいイメージが追加され、<code>ghcr.io</code>から<code>splunk-otel-java</code>がプルされます（注：2つの<code>api-gateway</code>コンテナが表示される場合、元のコンテナがまだ終了処理中の可能性があるため、数秒待ってください）。</p><p><strong>Splunk Observability Cloud</strong>のKubernetes Navigatorに戻ります。数分後、Podがオペレーターによって再起動され、自動検出と設定コンテナが追加されることが確認できます。以下のスクリーンショットのような表示になります：</p><p><a href=#R-image-6dc8b7db3b175a4023b4d00d5fa48926 class=lightbox-link><img alt=restart class="lazy lightbox figure-image" loading=lazy src=../../images/k8s-navigator-restarted-pods.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-6dc8b7db3b175a4023b4d00d5fa48926><img alt=restart class="lazy lightbox lightbox-image" loading=lazy src=../../images/k8s-navigator-restarted-pods.png></a></p><p>Kubernetes NavigatorでPodが緑色になるまで待ってから、次のセクションに進んでください。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article><article class=default><header class=headline></header><h1 id=splunk-apmでのデータの表示>Splunk APMでのデータの表示</h1><p>左側のメニューで<strong>APM</strong>をクリックして、新しくインストゥルメンテーション (instrumentation) されたサービスからのトレース (trace) によって生成されたデータを確認します。</p><p>ドロップダウンボックスで<strong>Environment</strong>フィルター <strong>(1)</strong> をワークショップインスタンスの名前に変更します。</p><details open class="box cstyle notices note"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-exclamation-circle"></i>
メモ</summary><div class=box-content><p>これは**<code>&lt;INSTANCE>-workshop</code><strong>になります。ここで</strong><code>INSTANCE</code>**は、先ほど実行したシェルスクリプトの値です。これのみが選択されていることを確認してください。</p></div></details><p><a href=#R-image-1da133f870df998787871a3bbce399e4 class=lightbox-link><img alt=apm class="lazy lightbox figure-image" loading=lazy src=../../images/zero-config-first-services-overview.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-1da133f870df998787871a3bbce399e4><img alt=apm class="lazy lightbox lightbox-image" loading=lazy src=../../images/zero-config-first-services-overview.png></a></p><p><strong>Service Map</strong> <strong>(2)</strong> ペインをクリックして、次のセクションの準備をします。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=apm-features>APM Features</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>15 minutes</span>
</span>&nbsp;<p>前のセクションで見てきたように、サービスで<strong>自動検出と設定 (automatic discovery and configuration)</strong> を有効にすると、トレース (trace) が<strong>Splunk Observability Cloud</strong>に送信されます。</p><p>これらのトレースにより、Splunkは自動的に<strong>Service Maps</strong>と<strong>RED Metrics</strong>を生成します。これらは、サービスの動作とサービス間の相互作用を理解するための最初のステップです。</p><p>次のセクションでは、トレース自体と、コードに触れることなくサービスの動作を理解するのに役立つ情報を詳しく見ていきます。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article><section><h1 class=a11y-only>5. APM Featuresのサブセクション</h1><article class=default><header class=headline></header><h1 id=apm-service-map>APM Service Map</h1><p><a href=#R-image-4da50ff27ecfd0c7ab0a170d7ca19847 class=lightbox-link><img alt="apm map" class="lazy lightbox figure-image" loading=lazy src=../../images/zero-config-first-services-map.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-4da50ff27ecfd0c7ab0a170d7ca19847><img alt="apm map" class="lazy lightbox lightbox-image" loading=lazy src=../../images/zero-config-first-services-map.png></a></p><p>上記のマップは、すべてのサービス間のすべての相互作用を示しています。PetClinic Microserviceアプリケーションが起動して完全に同期するまで数分かかるため、マップはまだ中間状態にある可能性があります。時間フィルタを**-2m<strong>と入力してカスタム時間の</strong>2分<strong>に減らすと役立ちます。画面右上の</strong>Refresh<strong>ボタン</strong>(1)**をクリックできます。赤い円で示される初期起動関連のエラーは最終的に消えます。</p><p>次に、各サービスで利用可能なメトリクス (metric) を調べるために、リクエスト、エラー、期間（RED）メトリクスダッシュボード (dashboard) を見てみましょう。</p><p>この演習では、サービスオペレーション (operation) が高いレイテンシ (latency) やエラー (error) を示している場合に使用する一般的なシナリオを使用します。</p><p>依存関係マップで<strong>customers-service</strong>をクリックし、<strong>Services</strong>ドロップダウンボックス**(1)<strong>で<code>customers-service</code>が選択されていることを確認します。次に、サービス名に隣接するOperationsドロップダウン</strong>(2)**から<code>GET /owners</code>を選択します。</p><p>これにより、以下に示すように<code>GET /owners</code>でフィルタリングされたワークフロー (workflow) が表示されます：</p><p><a href=#R-image-353d18f0033aedac63672e6c2ee700cf class=lightbox-link><img alt="select a trace" class="lazy lightbox figure-image" loading=lazy src=../../images/select-workflow.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-353d18f0033aedac63672e6c2ee700cf><img alt="select a trace" class="lazy lightbox lightbox-image" loading=lazy src=../../images/select-workflow.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article><article class=default><header class=headline></header><h1 id=apm-trace>APM Trace</h1><p>トレース (trace) を選択するには、<code>Service Requests & Errors</code>チャート**(1)**の線を選択します。関連するトレースの選択肢が表示されます。</p><p>関連するトレースのリストが表示されたら、青い**(2)** Trace ID Linkをクリックします。選択するトレースがServicesカラムに記載されている3つのサービスと同じものであることを確認してください。</p><p><a href=#R-image-86a39e1f6dd213836fd6b050225c0ab6 class=lightbox-link><img alt=workflow-trace-pick class="lazy lightbox figure-image" loading=lazy src=../../images/selecting-a-trace.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-86a39e1f6dd213836fd6b050225c0ab6><img alt=workflow-trace-pick class="lazy lightbox lightbox-image" loading=lazy src=../../images/selecting-a-trace.png></a></p><p>これにより、ウォーターフォール (Waterfall) ビュー (view) で選択されたトレースが表示されます：</p><p>ここにはいくつかのセクションがあります：</p><ul><li>Waterfall Pane <strong>(1)</strong>：トレースとスパン (span) として表示されるすべてのインストルメント (instrument) された関数が、その期間表示と順序/関係とともに表示されます。</li><li>Trace Info Pane <strong>(2)</strong>：選択されたスパン情報が表示されます（Waterfall Pane内でスパンの周りにボックスでハイライトされています）。</li><li>Span Pane <strong>(3)</strong>：選択されたスパンで送信されたすべてのタグ (tag) を見つけることができます。下にスクロールしてすべてを確認できます。</li><li>Process Pane：スパンを作成したプロセス (process) に関連するタグが表示されます（スクリーンショットに含まれていないため、下にスクロールして確認してください）。</li><li>Trace Properties：ペインの右上にあり、デフォルトでは折りたたまれています。</li></ul><p><a href=#R-image-3848dab5bc93fc7917d151556a0370f7 class=lightbox-link><img alt=waterfall class="lazy lightbox figure-image" loading=lazy src=../../images/waterfall-view.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-3848dab5bc93fc7917d151556a0370f7><img alt=waterfall class="lazy lightbox lightbox-image" loading=lazy src=../../images/waterfall-view.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article><article class=default><header class=headline></header><h1 id=apm-span>APM Span</h1><p>スパン (span) を調べる際、トレーシング (tracing) の上で<strong>自動検出と設定 (automatic discovery and configuration)</strong> を使用すると、<strong>コード変更なし</strong>で得られるいくつかの標準機能を見てみましょう：</p><p>まず、Waterfall Paneで、以下のスクリーンショットに示すように<code>customers-service:SELECT petclinic</code>または類似のスパンが選択されていることを確認してください：</p><p><a href=#R-image-a98954156b831e0cb09ca6aab74b3d16 class=lightbox-link><img alt=DB-query class="lazy lightbox figure-image" loading=lazy src=../../images/db-query.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-a98954156b831e0cb09ca6aab74b3d16><img alt=DB-query class="lazy lightbox lightbox-image" loading=lazy src=../../images/db-query.png></a></p><ul><li>基本的なレイテンシ (latency) 情報は、インストルメント (instrument) された関数または呼び出しのバーとして表示されます。上記の例では、17.8ミリ秒かかりました。</li><li>いくつかの類似したスパン**(1)**は、スパンが複数回繰り返される場合にのみ表示されます。この場合、例では10回の繰り返しがあります。<code>10x</code>をクリックすると、すべてのスパンが順番に表示されるように表示/非表示を切り替えることができます。</li><li><strong>Inferred Services</strong>：インストルメントされていない外部システムへの呼び出しは、グレーの「推測された (inferred)」スパンとして表示されます。この例のInferred Serviceまたはスパンは、上記に示すようにMysqlデータベース (Database) <code>mysql:petclinic SELECT petclinic</code> **(2)**への呼び出しです。</li><li><strong>Span Tags</strong>：Tag Paneには、自動検出と設定によって生成された標準タグが表示されます。この場合、スパンはデータベースを呼び出しているため、<code>db.statement</code>タグ**(3)**が含まれています。このタグは、このスパン中に実行されたデータベース呼び出しで使用されるDBクエリ (query) ステートメント (statement) を保持します。これはDB-Query Performance機能で使用されます。DB-Query Performanceについては次のセクションで見ていきます。</li><li><strong>Always-on Profiling</strong>：システムがスパンのライフサイクル (life cycle) 中にプロファイリング (Profiling) データをキャプチャ (capture) するように設定されている<strong>場合</strong>、スパンのタイムライン (timeline) でキャプチャされたコールスタック (Call Stack) の数が表示されます。上記の例では、<code>customer-service:GET /owners</code>スパンに対して18個のコールスタックがあることがわかります。<strong>(4)</strong></li></ul><p>次のセクションでプロファイリングを見ていきます。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article><article class=default><header class=headline></header><h1 id=service-centric-view>Service Centric View</h1><p>Splunk APMは、エンジニア (engineer) に1つの集中ビュー (view) でサービスパフォーマンス (performance) の深い理解を提供する<strong>Service Centric Views</strong>を提供します。すべてのサービスにわたって、エンジニアはサービスの基盤となるインフラストラクチャ (infrastructure) からのエラー (error) やボトルネック (bottleneck) を迅速に特定し、新しいデプロイ (deploy) によるパフォーマンス低下を特定し、すべてのサードパーティ依存関係の健全性を可視化できます。</p><p><code>api-gateway</code>のこのダッシュボード (dashboard) を表示するには、左側のメニューから<strong>APM</strong>をクリックし、リストの<code>api-gateway</code>サービスをクリックします。これにより、Service Centric Viewダッシュボードが表示されます：</p><p><a href=#R-image-97a305c3d64a0ff105dc00b9d34436e4 class=lightbox-link><img alt=service_maps class="lazy lightbox figure-image" loading=lazy src=../../images/service-view.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-97a305c3d64a0ff105dc00b9d34436e4><img alt=service_maps class="lazy lightbox lightbox-image" loading=lazy src=../../images/service-view.png></a></p><p>インストルメント (instrument) された各サービスで利用可能なこのビューは、<strong>Service metrics</strong>、<strong>Error breakdown</strong>、<strong>Runtime metrics (Java)</strong>、<strong>Infrastructure metrics</strong>の概要を提供します。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=always-on-profiling--db-query-performance>Always-On Profiling & DB Query Performance</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>15 minutes</span>
</span>&nbsp;<p>前の章で見てきたように、APMを使用して、コードに触れることなく、さまざまなサービス間のインタラクション (interaction) をトレース (trace) することができ、問題をより迅速に特定できます。</p><p>トレーシング (tracing) に加えて、<strong>automatic discovery and configuration</strong>は、問題をさらに迅速に発見するのに役立つ追加機能を最初から提供します。このセクションでは、そのうちの2つを見ていきます：</p><ul><li><strong>Always-on Profiling and Java Metrics</strong></li><li><strong>Database Query Performance</strong></li></ul><p>Always-on ProfilingまたはDB-Queryパフォーマンス (performance) についてさらに深く学びたい場合は、<a href=/en/scenarios/debug_problems/><strong>Debug Problems in Microservices</strong></a>という別のNinja Workshopがありますので、そちらをご覧ください。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article><section><h1 class=a11y-only>6. Advanced Featuresのサブセクション</h1><article class=default><header class=headline></header><h1 id=always-on-profiling--metrics>Always-On Profiling & Metrics</h1><p>先ほどHelmチャート (chart) を使用してSplunk Distribution of the OpenTelemetry Collectorをインストール (install) した際、<strong>AlwaysOn Profiling</strong>と<strong>Metrics</strong>を有効にするように設定しました。これにより、OpenTelemetry Javaはアプリケーション (application) のCPUとメモリ (memory) のプロファイリング (profiling) を自動的に生成し、Splunk Observability Cloudに送信します。</p><p>PetClinicアプリケーションをデプロイ (deploy) してアノテーション (annotation) を設定すると、collectorは自動的にアプリケーションを検出し、トレース (trace) とプロファイリング (profiling) のためにインストルメント (instrument) します。これを確認するために、次のスクリプト (script) を実行して、インストルメント (instrument) しているJavaコンテナ (container) の1つの起動ログ (log) を調べることができます：</p><p>ログ (log) には、Javaの自動検出と設定によって取得されたフラグ (flag) が表示されます：</p><p><div class=tab-panel data-tab-group=R-tabs-f883e5502929ca8b21bb32baaf8e81e4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-739ed12b5272b5bf6a0144000892a3fe aria-expanded=true data-tab-item=R-tab-c3d2921cc9f4b101462512ad1f1676da class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-f883e5502929ca8b21bb32baaf8e81e4","R-tab-c3d2921cc9f4b101462512ad1f1676da")'>
<span class=tab-nav-text>Run the script</span>
</button>
<button aria-controls=R-tab-id-0aca983f926f7bd04d35274165b41b2a aria-expanded=false data-tab-item=R-tab-587b796170a9abac4701cd8aa1bb38cb class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-f883e5502929ca8b21bb32baaf8e81e4","R-tab-587b796170a9abac4701cd8aa1bb38cb")'>
<span class=tab-nav-text>Example output</span></button></div><div class=tab-content-container><div id=R-tab-id-739ed12b5272b5bf6a0144000892a3fe data-tab-item=R-tab-c3d2921cc9f4b101462512ad1f1676da class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0><code class=language-logs data-lang=logs>.  ~/workshop/petclinic/scripts/get_logs.sh</code></pre></div></div></div><div id=R-tab-id-0aca983f926f7bd04d35274165b41b2a data-tab-item=R-tab-587b796170a9abac4701cd8aa1bb38cb class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>2024/02/15 09:42:00 Problem with dial: dial tcp 10.43.104.25:8761: connect: connection refused. Sleeping 1s
</span></span><span class=line><span class=cl>2024/02/15 09:42:01 Problem with dial: dial tcp 10.43.104.25:8761: connect: connection refused. Sleeping 1s
</span></span><span class=line><span class=cl>2024/02/15 09:42:02 Connected to tcp://discovery-server:8761
</span></span><span class=line><span class=cl>Picked up JAVA_TOOL_OPTIONS:  -javaagent:/otel-auto-instrumentation-java/javaagent.jar
</span></span><span class=line><span class=cl>Picked up _JAVA_OPTIONS: -Dspring.profiles.active=docker,mysql -Dsplunk.profiler.call.stack.interval=150
</span></span><span class=line><span class=cl>OpenJDK 64-Bit Server VM warning: Sharing is only supported for boot loader classes because bootstrap classpath has been appended
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:03:056 +0000] [main] INFO io.opentelemetry.javaagent.tooling.VersionLogger - opentelemetry-javaagent - version: splunk-1.30.1-otel-1.32.1
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:03:768 +0000] [main] INFO com.splunk.javaagent.shaded.io.micrometer.core.instrument.push.PushMeterRegistry - publishing metrics for SignalFxMeterRegistry every 30s
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:478 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger - -----------------------
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:478 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger - Profiler configuration:
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:480 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -                  splunk.profiler.enabled : true
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:505 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -                splunk.profiler.directory : /tmp
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:505 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -       splunk.profiler.recording.duration : 20s
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:506 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -               splunk.profiler.keep-files : false
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:510 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -            splunk.profiler.logs-endpoint : http://10.13.2.38:4317
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:513 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -              otel.exporter.otlp.endpoint : http://10.13.2.38:4317
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:513 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -           splunk.profiler.memory.enabled : true
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:515 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -             splunk.profiler.tlab.enabled : true
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:516 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -        splunk.profiler.memory.event.rate : 150/s
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:516 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -      splunk.profiler.call.stack.interval : PT0.15S
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:517 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -  splunk.profiler.include.internal.stacks : false
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:517 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger -      splunk.profiler.tracing.stacks.only : false
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:517 +0000] [main] INFO com.splunk.opentelemetry.profiler.ConfigurationLogger - -----------------------
</span></span><span class=line><span class=cl>[otel.javaagent 2024-02-15 09:42:07:518 +0000] [main] INFO com.splunk.opentelemetry.profiler.JfrActivator - Profiler is active.</span></span></code></pre></div></div></div></div></div>私たちが注目しているのは、<code>com.splunk.opentelemetry.profiler.ConfigurationLogger</code>によって書き込まれたセクション、つまり<strong>Profiling Configuration</strong>です。</p><p><code>splunk.profiler.directory</code>など、制御できるさまざまな設定を確認できます。これは、エージェント (agent) がSplunkに送信する前にコールスタック (call stack) を書き込む場所です。（これは、コンテナ (container) の設定方法によって異なる場合があります。）</p><p>変更したいもう1つのパラメータ (parameter) は<code>splunk.profiler.call.stack.interval</code>です。これは、システム (system) がCPU Stack traceをキャプチャ (capture) する頻度です。Pet Clinicアプリケーションのような短いスパン (span) がある場合は、このインターバル (interval) 設定を短くすることをお勧めします。デモ (demo) アプリケーションでは、デフォルト (default) のインターバル (interval) 値を変更しなかったため、スパン (span) に常にCPU Call Stackが関連付けられているとは限りません。</p><p>これらのパラメータ (parameter) を設定する方法は<a href=https://help.splunk.com/en/splunk-observability-cloud/manage-data/available-data-sources/supported-integrations-in-splunk-observability-cloud/apm-instrumentation/instrument-a-java-application/configure-the-java-agent#profiling-configuration-java rel=external>こちら</a>で確認できます。以下の例では、<code>deployment.yaml</code>でコールスタック (call stack) のより高い収集レート (rate) を設定する方法を示しています。これは、JAVA_OPTIONS configセクション (section) でこの値を設定することで行います。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>JAVA_OPTIONS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;-Xdebug -Dsplunk.profiler.call.stack.interval=150&#34;</span></span></span></code></pre></div><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article><article class=default><header class=headline></header><h1 id=trace-waterfall内のalways-on-profiling>Trace Waterfall内のAlways-On Profiling</h1><p>APM Waterfall ビューでオリジナルの Trace & Span <strong>(1)</strong>（または類似のもの）を選択し、右側のペイン (pane) から**Memory Stack Traces (2)**を選択してください：</p><p><a href=#R-image-b0fcdff7afd8212d4c33d8d42bc71db7 class=lightbox-link><img alt="profiling from span" class="lazy lightbox figure-image" loading=lazy src=../../images/flamechart-in-waterfall.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b0fcdff7afd8212d4c33d8d42bc71db7><img alt="profiling from span" class="lazy lightbox lightbox-image" loading=lazy src=../../images/flamechart-in-waterfall.png></a></p><p>ペイン (pane) に Memory Stack Trace Flame Graph **(3)**が表示されます。スクロール (scroll) するか、ペイン (pane) の右側をドラッグ (drag) して拡大できます。</p><p>AlwaysOn Profiling は、アプリケーション (application) のコード (code) のスナップショット (snapshot)、つまりスタックトレース (stack trace) を常に取得しています。何千ものスタックトレース (stack trace) を読まなければならないことを想像してみてください！それは現実的ではありません。これを支援するために、AlwaysOn Profiling はプロファイリング (profiling) データ (data) を集約して要約し、<strong>Flame Graph</strong>と呼ばれるビュー (view) で Call Stacks を探索する便利な方法を提供します。これは、アプリケーション (application) からキャプチャ (capture) されたすべてのスタックトレース (stack trace) の要約を表します。Flame Graph を使用して、パフォーマンス (performance) の問題を引き起こしている可能性のあるコード (code) の行を発見し、コード (code) に加えた変更が意図した効果を持っているかどうかを確認できます。</p><p>Always-on Profiling をさらに詳しく調べるには、<strong>Memory Stack Traces</strong>の下の Profiling Pane で上の画像で参照されている Span **(3)**を選択してください。これにより、Always-on Profiling のメイン (main) 画面が開き、Memory ビュー (view) があらかじめ選択されています：</p><p><a href=#R-image-da7e59179d59f2cf722aeb27684156d0 class=lightbox-link><img alt="Profiling main" class="lazy lightbox figure-image" loading=lazy src=../../images/profiling-memory.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-da7e59179d59f2cf722aeb27684156d0><img alt="Profiling main" class="lazy lightbox lightbox-image" loading=lazy src=../../images/profiling-memory.png></a></p><ul><li>Time フィルタ (filter) は、選択したスパン (span) の時間枠に設定されます <strong>(1)</strong></li><li>Java Memory Metric Charts **(2)**では、<code>Heap Memoryのモニター (monitor)</code>、<code>Memory Allocation Rate</code>や<code>Garbage Collecting</code> Metrics などの<code>Application Activity</code>を確認できます。</li><li>スパン (span) **(3)**に関連するメトリクス (metrics) と Stack Traces のみにフォーカス/表示する機能。これにより、必要に応じて Java アプリケーション (application) で実行されているバックグラウンド (background) アクティビティ (activity) をフィルタ (filter) で除外できます。</li><li>識別された Java Function calls **(4)**により、その関数から呼び出されたメソッド (method) にドリルダウン (drill down) できます。</li><li>プロファイル (profile) されたサービス (service) のスタックトレース (stack trace) に基づく階層の視覚化を持つ Flame Graph <strong>(5)</strong>。</li><li>サービス (service) が複数のバージョン (version) を起動する場合に備えて、Service instance **(6)**を選択する機能。</li></ul><p>さらなる調査のために、UI ではスタックトレース (stack trace) をクリックして、呼び出された関数と、フレームチャート (flame chart) から関連する行を確認できます。これを使用して、コーディング (coding) プラットフォーム (platform) で実際のコード (code) の行を表示できます（もちろん、お好みのコーディング (coding) プラットフォーム (platform) によって異なります）。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article><article class=default><header class=headline></header><h1 id=database-query-performance>Database Query Performance</h1><p>Database Query Performanceを使用すると、Splunk APMで直接、データベース (database) クエリ (query) がサービス (service) の可用性に与える影響をモニター (monitor) できます。これにより、データベース (database) をインストルメント (instrument) することなく、長時間実行されるクエリ (query)、最適化されていないクエリ (query)、または重いクエリ (query) を迅速に特定し、それらが引き起こしている可能性のある問題を軽減できます。</p><p>データベース (database) クエリ (query) のパフォーマンス (performance) を確認するには、ブラウザ (browser) で戻るか、メニュー (menu) バー (bar) のAPMセクション (section) に移動してAPMの<strong>Service Map</strong>ページ (page) に移動し、<strong>Service Map</strong>タイル (tile) をクリックします。</p><p>Dependency mapで推論されたデータベース (database) サービス (service) <code>mysql:petclinic</code> Inferred Database serverを選択し <strong>(1)</strong>、次に右側のペイン (pane) をスクロール (scroll) して<strong>Database Query Performance</strong> Pane **(2)**を見つけます。</p><p><a href=#R-image-cd5c1a3aa3920edf54921bbf42cace88 class=lightbox-link><img alt="DB-query from map" class="lazy lightbox figure-image" loading=lazy src=../../images/db-query-map.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-cd5c1a3aa3920edf54921bbf42cace88><img alt="DB-query from map" class="lazy lightbox lightbox-image" loading=lazy src=../../images/db-query-map.png></a></p><p>マップ (map) で選択したサービス (service) が実際に（推論された）データベース (database) サーバー (server) である場合、このペイン (pane) には期間に基づく上位90%（P90）のデータベース (database) コール (call) が表示されます。db-queryパフォーマンス (performance) 機能をさらに詳しく調べるには、ペイン (pane) の上部にある<strong>Database Query Performance</strong>という単語のどこかをクリックします。</p><p>これにより、DB-query Performanceの概要画面が表示されます：</p><p><a href=#R-image-d1df119412ee434bf592f983fb23670c class=lightbox-link><img alt="DB-query full" class="lazy lightbox figure-image" loading=lazy src=../../images/db-query-full.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d1df119412ee434bf592f983fb23670c><img alt="DB-query full" class="lazy lightbox lightbox-image" loading=lazy src=../../images/db-query-full.png></a></p><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info-circle"></i>
Database Query Normalization</summary><div class=box-content><p>デフォルト (default) では、Splunk APMインストルメンテーション (instrumentation) はデータベース (database) クエリ (query) をサニタイズ (sanitize) して、<code>db.statements</code>からシークレット (secret) や個人を特定できる情報（PII）などの機密データ (data) を削除またはマスク (mask) します。データベース (database) クエリ (query) の正規化 (normalization) をオフにする方法は<a href=https://help.splunk.com/en/splunk-observability-cloud/monitor-application-performance/monitor-database-query-performance/troubleshoot-database-query-performance#turn-off-database-query-normalization rel=external>こちら</a>で確認できます。</p></div></details><p>この画面には、Splunk Observability Cloudに送信されたTraces & Spansに基づいて、アプリケーション (application) からデータベース (database) に対して実行されたすべてのDatabase queries **(1)**が表示されます。時間ブロック (block) 間で比較したり、Total Time、P90 Latency & Requests **(2)**でソート (sort) したりできることに注意してください。</p><p>リスト (list) 内の各Database queryについて、時間ウィンドウ (window) 中の最高レイテンシ (latency)、コール (call) の総数、および1秒あたりのリクエスト (request) 数 **(3)**が表示されます。これにより、クエリ (query) を最適化できる場所を特定できます。</p><p>右側のペイン (pane) **(5)**の2つのチャート (chart) を使用して、Database Callsを含むトレース (trace) を選択できます。Tag Spotlightペイン (pane) **(6)**を使用して、エンドポイント (endpoint) やタグ (tag) に基づいて、データベース (database) コール (call) に関連するタグ (tag) を確認します。</p><p>クエリ (query) の詳細ビュー (view) を表示する必要がある場合：</p><p><a href=#R-image-c1ec216a94e9d034bf142149742e67a7 class=lightbox-link><img alt=details class="lazy lightbox figure-image" loading=lazy src=../../images/query-details.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c1ec216a94e9d034bf142149742e67a7><img alt=details class="lazy lightbox lightbox-image" loading=lazy src=../../images/query-details.png></a></p><p>特定のQuery **(1)**をクリックします。これにより、Query Details pane **(2)**が開き、より詳細な調査に使用できます。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=log-observer>Log Observer</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<p>この時点まで、<strong>コード変更は一切なく</strong>、トレース (tracing)、プロファイリング (profiling)、データベースクエリパフォーマンス (Database Query Performance) のデータが Splunk Observability Cloud に送信されています。</p><p>次に、<strong>Splunk Log Observer</strong> を使用して Spring PetClinic アプリケーションからログデータ (log data) を取得します。</p><p><strong>Splunk OpenTelemetry Collector</strong> は、Spring PetClinic アプリケーションからログを自動的に収集し、OTLP エクスポーター (exporter) を使用して Splunk Observability Cloud に送信します。その際、ログイベントには <code>trace_id</code>、<code>span_id</code>、トレースフラグ (trace flags) が付与されます。</p><p><strong>Splunk Log Observer</strong> を使用してログを表示し、ログ情報をサービス (services) やトレース (traces) と自動的に関連付けます。</p><p>この機能は <a href=https://help.splunk.com/en/splunk-observability-cloud/data-tools/related-content rel=external><strong>Related Content</strong></a> と呼ばれています。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article><section><h1 class=a11y-only>7. Log Observerのサブセクション</h1><article class=default><header class=headline></header><h1 id=ログを確認する>ログを確認する</h1><p>ログを表示するには、左側のメニューで <a href=#R-image-c8dbcf93b2f59c16d7ae818cae1cc773 class=lightbox-link><img alt=Logo class="inline lazy lightbox figure-image" loading=lazy src="../images/logo-icon.png?classes=inline&height=25px" style=height:25px;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c8dbcf93b2f59c16d7ae818cae1cc773><img alt=Logo class="inline lazy lightbox lightbox-image" loading=lazy src="../images/logo-icon.png?classes=inline&height=25px"></a> <strong>Log Observer</strong> をクリックします。Log Observer に入ったら、フィルターバー (filter bar) の <strong>Index</strong> が <strong>splunk4rookies-workshop</strong> に設定されていることを確認してください。<strong>(1)</strong></p><p>次に、<strong>Add Filter</strong> をクリックし、<em>Fields</em> <strong>(2)</strong> オプションを使用して <code>deployment.environment</code> フィールド <strong>(3)</strong> を検索します。ドロップダウンリストから、あなたのワークショップインスタンスを選択し <strong>(4)</strong>、<code>=</code> (含める) をクリックします。これで、PetClinic アプリケーションからのログメッセージのみが表示されます。</p><p><a href=#R-image-99757f62846a552d1a1b2ae8e8f175d7 class=lightbox-link><img alt="Log Observer sort" class="lazy lightbox figure-image" loading=lazy src=../../images/log-observer-sort.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-99757f62846a552d1a1b2ae8e8f175d7><img alt="Log Observer sort" class="lazy lightbox lightbox-image" loading=lazy src=../../images/log-observer-sort.png></a></p><p>次に、<code>service.name</code> フィールドを検索し、値 <code>customers-service</code> を選択して <code>=</code> (含める) をクリックします。これがフィルターバー <strong>(1)</strong> に表示されます。次に、<strong>Run Search</strong> ボタン <strong>(2)</strong> をクリックします。</p><p><a href=#R-image-2dde8bf574993a1c8e74b077aea14563 class=lightbox-link><img alt="Log Observer run" class="lazy lightbox figure-image" loading=lazy src=../../images/log-observer-run.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-2dde8bf574993a1c8e74b077aea14563><img alt="Log Observer run" class="lazy lightbox lightbox-image" loading=lazy src=../../images/log-observer-run.png></a></p><p>これによりログエントリがリフレッシュされ、<code>customers-service</code> からのエントリのみが表示されるように絞り込まれます。</p><p><a href=#R-image-358df914c0f99a0c7134b566f4fea90c class=lightbox-link><img alt="Log Observer" class="lazy lightbox figure-image" loading=lazy src=../../images/log-observer-trace-info.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-358df914c0f99a0c7134b566f4fea90c><img alt="Log Observer" class="lazy lightbox lightbox-image" loading=lazy src=../../images/log-observer-trace-info.png></a></p><p><em>&ldquo;Saving pet&rdquo;</em> で始まるエントリ <strong>(1)</strong> をクリックします。サイドペーンが開き、関連するトレース ID (trace ID) やスパン ID (span ID) <strong>(2)</strong> を含む詳細情報を確認できます。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article><article class=default><header class=headline></header><h1 id=related-content>Related Content</h1><p>下部のペインには、関連するコンテンツが表示されます。以下のスクリーンショットでは、APM がこのログ行に関連するトレースを見つけたことがわかります <strong>(1)</strong>:</p><p><a href=#R-image-db4bfb057e55ee3cafc6a06d39e218fe class=lightbox-link><img alt=RC class="lazy lightbox figure-image" loading=lazy src=../../images/log-apm-rc.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-db4bfb057e55ee3cafc6a06d39e218fe><img alt=RC class="lazy lightbox lightbox-image" loading=lazy src=../../images/log-apm-rc.png></a></p><p><strong>Trace for 960432ac9f16b98be84618778905af50</strong> <strong>(2)</strong> をクリックすると、このログ行が生成された特定のトレースの APM ウォーターフォール (waterfall) に移動します:</p><p><a href=#R-image-62a1548dabc98f8543eb366e2f924241 class=lightbox-link><img alt="waterfall logs" class="lazy lightbox figure-image" loading=lazy src=../../images/waterfall-with-logs.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-62a1548dabc98f8543eb366e2f924241><img alt="waterfall logs" class="lazy lightbox lightbox-image" loading=lazy src=../../images/waterfall-with-logs.png></a></p><p>ログに関する <strong>Related Content</strong> ペーンが表示されていることに注意してください <strong>(1)</strong>。これをクリックすると、Log Observer に戻り、このトレースの一部であるすべてのログ行が表示されます。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=real-user-monitoring>Real User Monitoring</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<p>アプリケーションに Real User Monitoring (RUM) インストルメンテーション (instrumentation) を有効にするには、コードベースに Open Telemetry Javascript <a href=https://github.com/signalfx/splunk-otel-js-web rel=external><strong>https://github.com/signalfx/splunk-otel-js-web</strong></a> スニペット (snippet) を追加する必要があります。</p><p>Spring PetClinic アプリケーションは、アプリケーションのすべてのビューで再利用される単一の <a href=https://github.com/spring-petclinic/spring-petclinic-microservices/blob/main/spring-petclinic-api-gateway/src/main/resources/static/index.html rel=external><strong>index</strong></a> HTML ページを使用しています。これは、Splunk RUM インストルメンテーションライブラリを挿入するのに最適な場所です。すべてのページで自動的に読み込まれるためです。</p><p><code>api-gateway</code> サービスはすでにインストルメンテーションを実行しており、RUM トレースを Splunk Observability Cloud に送信しています。次のセクションでデータを確認します。</p><p>スニペットを確認したい場合は、ブラウザでページを右クリックして <strong>View Page Source</strong> を選択することで、ページソースを表示できます。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;/env.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js&#34;</span> <span class=na>crossorigin</span><span class=o>=</span><span class=s>&#34;anonymous&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web-session-recorder.js&#34;</span> <span class=na>crossorigin</span><span class=o>=</span><span class=s>&#34;anonymous&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>realm</span> <span class=o>=</span> <span class=nx>env</span><span class=p>.</span><span class=nx>RUM_REALM</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Realm:&#39;</span><span class=p>,</span> <span class=nx>realm</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>auth</span> <span class=o>=</span> <span class=nx>env</span><span class=p>.</span><span class=nx>RUM_AUTH</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>appName</span> <span class=o>=</span> <span class=nx>env</span><span class=p>.</span><span class=nx>RUM_APP_NAME</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>environmentName</span> <span class=o>=</span> <span class=nx>env</span><span class=p>.</span><span class=nx>RUM_ENVIRONMENT</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>realm</span> <span class=o>&amp;&amp;</span> <span class=nx>auth</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>SplunkRum</span><span class=p>.</span><span class=nx>init</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=nx>realm</span><span class=o>:</span> <span class=nx>realm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>rumAccessToken</span><span class=o>:</span> <span class=nx>auth</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>applicationName</span><span class=o>:</span> <span class=nx>appName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>deploymentEnvironment</span><span class=o>:</span> <span class=nx>environmentName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>version</span><span class=o>:</span> <span class=s1>&#39;1.0.0&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nx>SplunkSessionRecorder</span><span class=p>.</span><span class=nx>init</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=nx>applicationName</span><span class=o>:</span> <span class=nx>appName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>realm</span><span class=o>:</span> <span class=nx>realm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>rumAccessToken</span><span class=o>:</span> <span class=nx>auth</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=nx>recorder</span><span class=o>:</span> <span class=s2>&#34;splunk&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=nx>features</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>video</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>Provider</span> <span class=o>=</span> <span class=nx>SplunkRum</span><span class=p>.</span><span class=nx>provider</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kd>var</span> <span class=nx>tracer</span><span class=o>=</span><span class=nx>Provider</span><span class=p>.</span><span class=nx>getTracer</span><span class=p>(</span><span class=s1>&#39;appModuleLoader&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Realm or auth is empty, provide default values or skip initialization
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Realm or auth is empty. Skipping Splunk Rum initialization.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>     <span class=c>&lt;!-- Section added for  RUM --&gt;</span></span></span></code></pre></div><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article><section><h1 class=a11y-only>8. Real User Monitoringのサブセクション</h1><article class=default><header class=headline></header><h1 id=select-the-rum-view-for-the-petclinic-app>Select the RUM view for the Petclinic App</h1><p>左側のメニューで <strong>RUM</strong> をクリックして、RUM の簡単な概要ツアーを始めましょう。次に、<strong>Environment</strong> フィルター <strong>(1)</strong> をドロップダウンボックスから変更し、ワークショップインスタンスの名前 <strong><code>&lt;INSTANCE>-workshop</code></strong> <strong>(1)</strong> を選択します (ここで <strong><code>INSTANCE</code></strong> は、以前に実行したシェルスクリプトの値です)。これのみが選択されていることを確認してください。</p><p>次に、<strong>App</strong> <strong>(2)</strong> ドロップダウンボックスをアプリの名前に変更します。これは <strong><code>&lt;INSTANCE>-store</code></strong> になります。</p><p><a href=#R-image-d0a4c450fecc12544553079743bb4a9a class=lightbox-link><img alt="rum select" class="lazy lightbox figure-image" loading=lazy src=../../images/rum-env-select.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d0a4c450fecc12544553079743bb4a9a><img alt="rum select" class="lazy lightbox lightbox-image" loading=lazy src=../../images/rum-env-select.png></a></p><p><strong>Environment</strong> と <strong>App</strong> を選択すると、アプリケーションの RUM ステータスを示す概要ページが表示されます。(Summary Dashboard が単一行の数値だけの場合は、縮小表示になっています。アプリケーション名の前にある <strong>> (1)</strong> をクリックして展開できます)。JavaScript エラーが発生した場合は、以下のように表示されます:</p><p><a href=#R-image-93df91c76e11794fb8b9b4f471cd91d3 class=lightbox-link><img alt="rum overview" class="lazy lightbox figure-image" loading=lazy src=../../images/rum-overview.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-93df91c76e11794fb8b9b4f471cd91d3><img alt="rum overview" class="lazy lightbox lightbox-image" loading=lazy src=../../images/rum-overview.png></a></p><p>続けるには、青いリンク (ワークショップ名) をクリックして詳細ページに移動します。これにより、UX Metrics、Front-end Health、Back-end Health、Custom Events によるインタラクションの内訳が表示され、過去のメトリクス (metrics) (デフォルトでは 1 時間) と比較される新しいダッシュボードビューが表示されます。</p><p><a href=#R-image-14dd93d33a1b2320f76aa361dee5a390 class=lightbox-link><img alt="rum  main" class="lazy lightbox figure-image" loading=lazy src=../../images/rum-main.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-14dd93d33a1b2320f76aa361dee5a390><img alt="rum  main" class="lazy lightbox lightbox-image" loading=lazy src=../../images/rum-main.png></a>
通常、最初のチャートには 1 つの線のみがあります。Petclinic ショップに関連するリンクをクリックしてください。
この例では http://198.19.249.202:81 です:</p><p>これにより、Tag Spotlight ページに移動します。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article><article class=default><header class=headline></header><h1 id=rum-trace-waterfall-view--linking-to-apm>RUM trace Waterfall view & linking to APM</h1><p>TAG Spotlight ビューでは、RUM データに関連付けられたすべてのタグ (tags) が表示されます。タグは、データを識別するために使用されるキーバリューペア (key-value pairs) です。この場合、タグは OpenTelemetry インストルメンテーションによって自動的に生成されます。タグは、データをフィルタリングし、チャートやテーブルを作成するために使用されます。Tag Spotlight ビューでは、動作の傾向を検出し、ユーザーセッション (user session) にドリルダウンできます。</p><p><a href=#R-image-5a791306341c44125b9900ad574d325a class=lightbox-link><img alt="RUM TAG" class="lazy lightbox figure-image" loading=lazy src=../../images/rum-tag-spotlight.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5a791306341c44125b9900ad574d325a><img alt="RUM TAG" class="lazy lightbox lightbox-image" loading=lazy src=../../images/rum-tag-spotlight.png></a></p><p>User Sessions <strong>(1)</strong> をクリックすると、タイムウィンドウ (time window) 中に発生したユーザーセッションのリストが表示されます。</p><p>セッションの 1 つを見たいので、<em>Duration</em> <strong>(2)</strong> をクリックして期間でソートし、長いものの 1 つのリンク <strong>(3)</strong> をクリックしてください:</p><p><a href=#R-image-b137de3d4f2cbc9027ab943cb4854ff5 class=lightbox-link><img alt="User sessions" class="lazy lightbox figure-image" loading=lazy src=../../images/rum-user-sessions.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b137de3d4f2cbc9027ab943cb4854ff5><img alt="User sessions" class="lazy lightbox lightbox-image" loading=lazy src=../../images/rum-user-sessions.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article><article class=default><header class=headline></header><h1 id=rum-trace-waterfall-view--linking-to-apm>RUM trace Waterfall view & linking to APM</h1><p>RUM トレースウォーターフォール (waterfall) を見ています。これは、ユーザーが petclinic アプリケーションのページにアクセスしたときに、ユーザーデバイス上で何が起こったかを示します。</p><p>ウォーターフォールを下にスクロールして、右側の <strong>#!/owners/details</strong> セグメント <strong>(1)</strong> を見つけてクリックすると、Vets リクエストの処理中に発生したアクションのリストが表示されます。HTTP リクエストには、リターンコードの前に青い <strong>APM</strong> リンクがあることに注意してください。1 つを選択し、APM リンクをクリックします。これにより、Kubernetes でホストされているこのバックエンドサービスコールの APM 情報が表示されます。</p><p><a href=#R-image-1099316672ad55527f8d255b8e9731d8 class=lightbox-link><img alt="rum apm link" class="lazy lightbox figure-image" loading=lazy src=../../images/rum-trace.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-1099316672ad55527f8d255b8e9731d8><img alt="rum apm link" class="lazy lightbox lightbox-image" loading=lazy src=../../images/rum-trace.png></a></p><p>リクエストで何が起こったかを確認するためにドリルダウンしたい場合は、Trace ID の URL をクリックしてください。</p><p>これにより、RUM からのリクエストに関連するトレースが表示されます:</p><p><a href=#R-image-3fc1f0e80a18126fafed8baf52ee7dd3 class=lightbox-link><img alt="RUm-apm linked" class="lazy lightbox figure-image" loading=lazy src=../../images/rum-apm-waterfall.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-3fc1f0e80a18126fafed8baf52ee7dd3><img alt="RUm-apm linked" class="lazy lightbox lightbox-image" loading=lazy src=../../images/rum-apm-waterfall.png></a></p><p>サービスへのエントリーポイントに <strong>RUM (1)</strong> 関連コンテンツリンクが追加されており、バックエンドサービスで何が起こったかを確認した後、RUM セッションに戻ることができるようになっていることがわかります。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=workshop-wrap-up->Workshop Wrap-up 🎁</h1><p>おめでとうございます。<strong>Get the Most Out of Your Existing Kubernetes Java Applications Using Automatic Discovery and Configuration With OpenTelemetry</strong> ワークショップを完了しました。</p><p>今日、既存の Kubernetes 上の Java アプリケーションにトレース (Tracing)、コードプロファイリング (Code Profiling)、データベースクエリパフォーマンス (Database Query Performance) を追加することがいかに簡単かを学びました。</p><p><strong>Automatic Discovery and Configuration</strong> を使用して、コードや設定に一切触れることなく、アプリケーションとインフラストラクチャの可観測性を即座に向上させました。</p><p>また、シンプルな設定変更により、さらに多くの可観測性 (<strong>logging</strong> や <strong>RUM</strong>) をアプリケーションに追加して、エンドツーエンドの可観測性を提供できることも学びました。</p><p><a href=#R-image-51b47bfe2457da47e97945464392fdd6 class=lightbox-link><img alt=Champagne class="lazy lightbox figure-image" loading=lazy src="/observability-workshop/ja/ninja-workshops/1-automatic-discovery/2-petclinic-kubernetes/9-wrap-up/images/champagne.png?width=45vw" style=height:auto;width:45vw></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-51b47bfe2457da47e97945464392fdd6><img alt=Champagne class="lazy lightbox lightbox-image" loading=lazy src="/observability-workshop/ja/ninja-workshops/1-automatic-discovery/2-petclinic-kubernetes/9-wrap-up/images/champagne.png?width=45vw"></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/12/05</span></span></footer></article></section></section><article class=default><header class=headline></header><h1 id=aws-lambda関数の分散トレーシング>AWS Lambda関数の分散トレーシング</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>45 minutes</span>
</span>&nbsp;
<span class="badge cstyle blue badge-with-title"><span class=badge-title class=text-muted>Author
</span><span class=badge-content>Guy-Francis Kono</span></span><p>このワークショップでは、AWS Lambda で実行される小規模なサーバーレスアプリケーションの分散トレースを構築し、AWS Kinesis を介してメッセージを produce および consume する方法を学びます。</p><p>まず、OpenTelemetry の自動計装がどのようにトレースをキャプチャし、選択した宛先にエクスポートするかを確認します。</p><p>次に、手動計装によってコンテキスト伝播を有効にする方法を見ていきます。</p><p>このワークショップのために、Splunk は AWS/EC2 上の Ubuntu Linux インスタンスを事前に構成しています。このインスタンスにアクセスするには、ワークショップインストラクターが提供する URL にアクセスしてください。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/05/29</span></span></footer></article><section><h1 class=a11y-only>Lambdaトレーシングのサブセクション</h1><article class=default><header class=headline></header><h1 id=セットアップ>セットアップ</h1><p><a href=#R-image-5e3d32e569d64cdb326525632dfe1e5c class=lightbox-link><img alt=手動計装されていないLambdaアプリケーション class="lazy lightbox figure-image" loading=lazy src=../images/01-Architecture.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5e3d32e569d64cdb326525632dfe1e5c><img alt=手動計装されていないLambdaアプリケーション class="lazy lightbox lightbox-image" loading=lazy src=../images/01-Architecture.png></a></p><h2 id=前提条件>前提条件</h2><h3 id=observability-ワークショップインスタンス>Observability ワークショップインスタンス</h3><p>Observability ワークショップは、多くの場合、Splunk が提供する事前設定済みの Ubuntu EC2 インスタンス上で実施されます。</p><p>ワークショップのインストラクターから、割り当てられたワークショップインスタンスの認証情報が提供されます。</p><p>インスタンスには以下の環境変数が既に設定されているはずです：</p><ul><li><strong>ACCESS_TOKEN</strong></li><li><strong>REALM</strong><ul><li><em>これらはワークショップ用の Splunk Observability Cloud の <strong>Access Token</strong> と <strong>Realm</strong> です。</em></li><li><em>これらは OpenTelemetry Collector によって、データを正しい Splunk Observability Cloud 組織に転送するために使用されます。</em></li></ul></li></ul><details open class="box cstyle notices note"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-exclamation-circle"></i><br></summary><div class=box-content><p><em>また、Multipass を使用してローカルの Observability ワークショップインスタンスをデプロイすることもできます。</em></p></div></details><h3 id=aws-command-line-interface-awscli>AWS Command Line Interface (awscli)</h3><p>AWS Command Line Interface、または<code>awscli</code>は、AWS リソースと対話するために使用される API です。このワークショップでは、特定のスクリプトがデプロイするリソースと対話するために使用されます。</p><p>Splunk が提供するワークショップインスタンスには、既に <strong>awscli</strong> がインストールされているはずです。</p><ul><li><p>インスタンスに <strong>aws</strong> コマンドがインストールされているか、次のコマンドで確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>which aws</span></span></code></pre></div><ul><li><em>予想される出力は <strong>/usr/local/bin/aws</strong> です</em></li></ul></li><li><p>インスタンスに <strong>aws</strong> コマンドがインストールされていない場合は、次のコマンドを実行します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt install awscli</span></span></code></pre></div></li></ul><h3 id=terraform>Terraform</h3><p>Terraform は、リソースを構成ファイルで定義することで、デプロイ、管理、破棄するための Infrastructure as Code（IaC）プラットフォームです。Terraform は HCL を使用してこれらのリソースを定義し、さまざまなプラットフォームやテクノロジのための複数のプロバイダーをサポートしています。</p><p>このワークショップでは、コマンドラインで Terraform を使用して、以下のリソースをデプロイします：</p><ol><li>AWS API Gateway</li><li>Lambda 関数</li><li>Kinesis Stream</li><li>CloudWatch ロググループ</li><li>S3 バケット<ul><li><em>およびその他のサポートリソース</em></li></ul></li></ol><p>Splunk が提供するワークショップインスタンスには、既に <strong>terraform</strong> がインストールされているはずです。</p><ul><li><p>インスタンスに <strong>terraform</strong> コマンドがインストールされているか確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>which terraform</span></span></code></pre></div><ul><li><em>予想される出力は <strong>/usr/local/bin/terraform</strong> です</em></li></ul></li><li><p>インスタンスに <strong>terraform</strong> コマンドがインストールされていない場合は、以下の Terraform が推奨するインストールコマンドを実行してください：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget -O- https://apt.releases.hashicorp.com/gpg <span class=p>|</span> sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com </span><span class=k>$(</span>lsb_release -cs<span class=k>)</span><span class=s2> main&#34;</span> <span class=p>|</span> sudo tee /etc/apt/sources.list.d/hashicorp.list
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sudo apt update <span class=o>&amp;&amp;</span> sudo apt install terraform</span></span></code></pre></div></li></ul><h3 id=ワークショップディレクトリ-o11y-lambda-workshop>ワークショップディレクトリ (o11y-lambda-workshop)</h3><p>ワークショップディレクトリ <code>o11y-lambda-workshop</code> は、今日使用する例の Lambda ベースのアプリケーションの自動計装と手動計装の両方を完了するための、すべての設定ファイルとスクリプトを含むリポジトリです。</p><ul><li><p>ホームディレクトリにワークショップディレクトリがあることを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> <span class=o>&amp;&amp;</span> ls</span></span></code></pre></div><ul><li><em>予想される出力には <strong>o11y-lambda-workshop</strong> が含まれるはずです</em></li></ul></li><li><p><strong>o11y-lambda-workshop</strong> ディレクトリがホームディレクトリにない場合は、次のコマンドでクローンします：</p></li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone https://github.com/gkono-splunk/o11y-lambda-workshop.git</span></span></code></pre></div><h3 id=aws--terraform-変数>AWS & Terraform 変数</h3><h4 id=aws>AWS</h4><p>AWS の CLI では、サービスによってデプロイされたリソースにアクセスし管理するための認証情報が必要です。このワークショップでは、Terraform と Python スクリプトの両方がタスクを実行するためにこれらの変数を必要とします。</p><ul><li><p>このワークショップのために <strong>awscli</strong> を <em><strong>access key ID</strong></em>、<em><strong>secret access key</strong></em> および <em><strong>region</strong></em> で構成します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws configure</span></span></code></pre></div><ul><li><p><em>このコマンドは以下のようなプロンプトを表示するはずです：</em></p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>AWS Access Key ID <span class=o>[</span>None<span class=o>]</span>: XXXXXXXXXXXXXXXX
</span></span><span class=line><span class=cl>AWS Secret Acces Key <span class=o>[</span>None<span class=o>]</span>: XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
</span></span><span class=line><span class=cl>Default region name <span class=o>[</span>None<span class=o>]</span>: us-east-1
</span></span><span class=line><span class=cl>Default outoput format <span class=o>[</span>None<span class=o>]</span>:</span></span></code></pre></div></li></ul></li><li><p>インスタンスで <strong>awscli</strong> が設定されていない場合は、次のコマンドを実行し、インストラクターから提供される値を入力してください。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws configure</span></span></code></pre></div></li></ul><h4 id=terraform-1>Terraform</h4><p>Terraform では、機密情報や動的データを.tf 設定ファイルにハードコーディングさせない、またはそれらの値をリソース定義全体で再利用できるようにするため、変数の受け渡しをサポートしています。</p><p>このワークショップでは、OpenTelemetry Lambda layer の適切な値で Lambda 関数をデプロイするため、Splunk Observability Cloud の取り込み値のため、そして環境とリソースを独自で即座に認識できるようにするための変数を Terraform で必要とします。</p><p>Terraform 変数(variable)は以下の方法で定義されます：</p><ul><li>変数を <em><strong>main.tf</strong></em> ファイルまたは <em><strong>variables.tf</strong></em> に定義する</li><li>以下のいずれかの方法で変数の値を設定する：<ul><li>ホストレベルで環境変数を設定し、その定義と同じ変数名を使用して、接頭辞として <em><strong>TF_VAR</strong></em> をつける</li><li><em><strong>terraform.tfvars</strong></em> ファイルに変数の値を設定する</li><li>terraform apply 実行時に引数として値を渡す</li></ul></li></ul><p>このワークショップでは、<em><strong>variables.tf</strong></em> と <em><strong>terraform.tfvars</strong></em> ファイルの組み合わせを使用して変数を設定します。</p><ul><li><p><strong>vi</strong> または <strong>nano</strong> のいずれかを使用して、<strong>auto</strong> または <strong>manual</strong> ディレクトリにある <em><strong>terraform.tfvars</strong></em> ファイルを開きます</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi ~/o11y-lambda-workshop/auto/terraform.tfvars</span></span></code></pre></div></li><li><p>変数に値を設定します。<strong>CHANGEME</strong> プレースホルダーをインストラクターから提供された値に置き換えてください。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>o11y_access_token</span> <span class=o>=</span> <span class=s2>&#34;CHANGEME&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>o11y_realm</span>        <span class=o>=</span> <span class=s2>&#34;CHANGEME&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>otel_lambda_layer</span> <span class=o>=</span> <span class=o>[</span><span class=s2>&#34;CHANGEME&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>prefix</span>            <span class=o>=</span> <span class=s2>&#34;CHANGEME&#34;</span></span></span></code></pre></div><ul><li><em>引用符（"）や括弧 ( [ ] ) はそのまま残し、プレースホルダー<code>CHANGEME</code>のみを変更してください。</em></li><li><em><strong>prefix</strong></em> は、他の参加者のリソースと区別するため、任意の文字列で設定する固有の識別子です。氏名やメールアドレスのエイリアスを使用することをお勧めします。</li><li><em><strong>prefix</strong> には小文字のみを使用してください。S3 のような特定の AWS リソースでは、大文字を使用するとエラーが発生します。</em></li></ul></li><li><p>ファイルを保存してエディタを終了します。</p></li><li><p>最後に、編集した <em><strong>terraform.tfvars</strong></em> ファイルを他のディレクトリにコピーします。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cp ~/o11y-lambda-workshop/auto/terraform.tfvars ~/o11y-lambda-workshop/manual</span></span></code></pre></div><ul><li><em>これは、自動計装と手動計装の両方の部分で同じ値を使用するためです</em></li></ul></li></ul><h3 id=ファイル権限>ファイル権限</h3><p>他のすべてのファイルはそのままでよいですが、<code>auto</code>と<code>manual</code>の両方にある<strong>send_message.py</strong>スクリプトは、ワークショップの一部として実行する必要があります。そのため、期待通りに実行するには、適切な権限が必要です。以下の手順に従って設定してください。</p><ul><li><p>まず、<code>o11y-lambda-workshop</code>ディレクトリにいることを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop</span></span></code></pre></div></li><li><p>次に、以下のコマンドを実行して<code>send_message.py</code>スクリプトに実行権限を設定します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo chmod <span class=m>755</span> auto/send_message.py manual/send_message.py</span></span></code></pre></div></li></ul><p>これで前提条件が整いましたので、ワークショップを始めることができます！</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/05/29</span></span></footer></article><article class=default><header class=headline></header><h1 id=自動計装>自動計装</h1><p>ワークショップの最初の部分では、OpenTelemetry による自動計装がどのようにして OpenTelemetry Collector に関数がどの言語で書かれているかを自動検出させ、それらの関数のトレースの取得を開始させるかを示します。</p><h3 id=自動計装ワークショップディレクトリとコンテンツ>自動計装ワークショップディレクトリとコンテンツ</h3><p>まず、<code>o11y-lambda-workshop/auto</code>ディレクトリとそのファイルの一部を見てみましょう。ここにはワークショップの自動計装部分のすべてのコンテンツがあります。</p><h4 id=auto-ディレクトリ><code>auto</code> ディレクトリ</h4><ul><li><p>以下のコマンドを実行して <strong>o11y-lambda-workshop/auto</strong> ディレクトリに移動します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/auto</span></span></code></pre></div></li><li><p>このディレクトリの内容を確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ls</span></span></code></pre></div><ul><li><p><em>出力には以下のファイルとディレクトリが含まれるはずです：</em></p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>handler             outputs.tf          terraform.tf        variables.tf
</span></span><span class=line><span class=cl>main.tf             send_message.py     terraform.tfvars</span></span></code></pre></div></li><li><p><em>出力には以下のファイルとディレクトリが含まれるはずです：</em></p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>get_logs.py    main.tf       send_message.py
</span></span><span class=line><span class=cl>handler        outputs.tf    terraform.tf</span></span></code></pre></div></li></ul></li></ul><h4 id=maintf-ファイル><code>main.tf</code> ファイル</h4><ul><li><p><code>main.tf</code> ファイルをより詳しく見てみましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat main.tf</span></span></code></pre></div></li></ul><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
ワークショップの質問</summary><div class=box-content><ul><li>このテンプレートによってどの AWS リソースが作成されているか特定できますか？</li><li>OpenTelemetry 計装がどこでセットアップされているか特定できますか？<ul><li><em>ヒント: Lambda 関数の定義を調べてください</em></li></ul></li><li>以前に設定した環境変数によってどの計装情報が提供されているか判断できますか？</li></ul></div></details><p>各 Lambda 関数の環境変数が設定されているセクションが見つかるはずです。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>environment <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>variables</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>SPLUNK_ACCESS_TOKEN</span> <span class=o>=</span> var.o11y_access_token
</span></span><span class=line><span class=cl>    <span class=nv>SPLUNK_REALM</span> <span class=o>=</span> var.o11y_realm
</span></span><span class=line><span class=cl>    <span class=nv>OTEL_SERVICE_NAME</span> <span class=o>=</span> <span class=s2>&#34;producer-lambda&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>OTEL_RESOURCE_ATTRIBUTES</span> <span class=o>=</span> <span class=s2>&#34;deployment.environment=</span><span class=si>${</span><span class=nv>var</span><span class=p>.prefix</span><span class=si>}</span><span class=s2>-lambda-shop&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>AWS_LAMBDA_EXEC_WRAPPER</span> <span class=o>=</span> <span class=s2>&#34;/opt/nodejs-otel-handler&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>KINESIS_STREAM</span> <span class=o>=</span> aws_kinesis_stream.lambda_streamer.name
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div><p>これらの環境変数を使用することで、いくつかの方法で自動計装を構成しています：</p><ul><li><p>環境変数を設定して、データのエクスポート先となる Splunk Observability Cloud 組織を OpenTelemetry collector に伝えています。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>SPLUNK_ACCESS_TOKEN</span> <span class=o>=</span> var.o11y_access_token
</span></span><span class=line><span class=cl><span class=nv>SPLUNK_ACCESS_TOKEN</span> <span class=o>=</span> var.o11y_realm</span></span></code></pre></div></li><li><p>また、OpenTelemetry が関数/サービスを識別し、それが属する環境/アプリケーションを認識するのに役立つ変数も設定しています。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>OTEL_SERVICE_NAME</span> <span class=o>=</span> <span class=s2>&#34;producer-lambda&#34;</span> <span class=c1># consumer関数の場合はconsumer-lambda</span>
</span></span><span class=line><span class=cl><span class=nv>OTEL_RESOURCE_ATTRIBUTES</span> <span class=o>=</span> <span class=s2>&#34;deployment.environment=</span><span class=si>${</span><span class=nv>var</span><span class=p>.prefix</span><span class=si>}</span><span class=s2>-lambda-shop&#34;</span></span></span></code></pre></div></li><li><p>コード言語に基づいて、関数のハンドラーに自動的にトレースデータを取得するために適用する必要があるラッパーを OpenTelemetry に知らせる環境変数を設定しています。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>AWS_LAMBDA_EXEC_WRAPPER - <span class=s2>&#34;/opt/nodejs-otel-handler&#34;</span></span></span></code></pre></div></li><li><p><code>producer-lambda</code>関数の場合、レコードを配置する Kinesis ストリームを関数に知らせるための環境変数を設定しています。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KINESIS_STREAM</span> <span class=o>=</span> aws_kinesis_stream.lambda_streamer.name</span></span></code></pre></div></li><li><p>これらの値は、「前提条件」セクションで設定した環境変数、および、この Terraform 構成ファイルの一部としてデプロイされるリソースから取得されます。</p></li></ul><p>また、各関数に Splunk OpenTelemetry Lambda layer を設定する引数も確認できるはずです</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>layers</span> <span class=o>=</span> var.otel_lambda_layer</span></span></code></pre></div><ul><li><p>OpenTelemetry Lambda layer は、Lambda 関数の呼び出し時に計測データを収集、処理、およびエクスポートするために必要なライブラリと依存関係を含むパッケージです。</p></li><li><p>すべての OpenTelemetry サポート言語のライブラリと依存関係を持つ一般的な OTel Lambda layer がありますが、関数をさらに軽量化するための言語固有の Lambda layer も存在します。</p><ul><li><em>各 AWS リージョンの関連する Splunk OpenTelemetry Lambda layer ARN（Amazon Resource Name）と最新バージョンは<a href=https://github.com/signalfx/lambda-layer-versions/blob/main/splunk-apm/splunk-apm.md rel=external>こちら</a>で確認できます</em></li></ul></li></ul><h4 id=producermjs-ファイル><code>producer.mjs</code> ファイル</h4><p>次に、<code>producer-lambda</code>関数のコードを見てみましょう：</p><ul><li><p>以下のコマンドを実行して<code>producer.mjs</code>ファイルの内容を表示します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/o11y-lambda-workshop/auto/handler/producer.mjs</span></span></code></pre></div><ul><li>この NodeJS モジュールにはプロデューサー関数のコードが含まれています。</li><li>基本的に、この関数はメッセージを受け取り、そのメッセージを対象の Kinesis ストリームにレコードとして配置します</li></ul></li></ul><h3 id=lambda-関数のデプロイとトレースデータの生成>Lambda 関数のデプロイとトレースデータの生成</h3><p><code>auto</code>ディレクトリの内容に慣れたところで、ワークショップ用のリソースをデプロイし、Lambda 関数からトレースデータを生成していきます。</p><h4 id=autoディレクトリで-terraform-を初期化する><code>auto</code>ディレクトリで Terraform を初期化する</h4><p><code>main.tf</code>ファイルで定義されたリソースをデプロイするには、まず Terraform がそのファイルと同じフォルダで初期化されていることを確認する必要があります。</p><ul><li><p><code>auto</code> ディレクトリにいることを確認します:</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwd</span></span></code></pre></div><ul><li><em>予想される出力は <strong>~/o11y-lambda-workshop/auto</strong> です</em></li></ul></li><li><p><code>auto</code> ディレクトリにいない場合は、次のコマンドを実行します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/auto</span></span></code></pre></div></li><li><p>次のコマンドを実行して、このディレクトリで Terraform を初期化します</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform init</span></span></code></pre></div><ul><li>このコマンドは同じフォルダにいくつかの要素を作成します：<ul><li><code>.terraform.lock.hcl</code> ファイル：リソースを提供するために使用するプロバイダーを記録します</li><li><code>.terraform</code> ディレクトリ：プロバイダーの構成を保存します</li></ul></li><li>上記のファイルに加えて、<code>apply</code> サブコマンドを使用して terraform を実行すると、デプロイされたリソースの状態を追跡するために <code>terraform.tfstate</code> ファイルが作成されます。</li><li>これらにより、Terraform は <code>auto</code> ディレクトリの <code>main.tf</code> ファイル内で定義されたとおりに、リソースの作成、状態、破棄を管理できます</li></ul></li></ul><h4 id=lambda-関数とその他の-aws-リソースをデプロイする>Lambda 関数とその他の AWS リソースをデプロイする</h4><p>このディレクトリで Terraform を初期化したら、リソースのデプロイに進むことができます。</p><ul><li><p>まず、<strong>terraform plan</strong> コマンドを実行して、Terraform が問題なくリソースを作成できることを確認します。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform plan</span></span></code></pre></div><ul><li><em>これにより、リソースをデプロイするプランといくつかのデータが出力され、意図したとおりに動作することを確認できます。</em></li><li><em>プランに表示される値の一部は、作成後に判明するか、セキュリティ上の理由でマスクされていることに注意してください。</em></li></ul></li><li><p>次に、<strong>terraform apply</strong> コマンドを実行して、<strong>main.tf</strong> ファイルから Lambda 関数とその他のサポートリソースをデプロイします：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform apply</span></span></code></pre></div><ul><li><p><em><strong>Enter a value:</strong> プロンプトが表示されたら <strong>yes</strong> と応答します</em></p></li><li><p>これにより、以下のような出力が得られます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Outputs:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>base_url</span> <span class=o>=</span> <span class=s2>&#34;https://______.amazonaws.com/serverless_stage/producer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>consumer_function_name</span> <span class=o>=</span> <span class=s2>&#34;_____-consumer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>consumer_log_group_arn</span> <span class=o>=</span> <span class=s2>&#34;arn:aws:logs:us-east-1:############:log-group:/aws/lambda/______-consumer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>consumer_log_group_name</span> <span class=o>=</span> <span class=s2>&#34;/aws/lambda/______-consumer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>environment</span> <span class=o>=</span> <span class=s2>&#34;______-lambda-shop&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>lambda_bucket_name</span> <span class=o>=</span> <span class=s2>&#34;lambda-shop-______-______&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>producer_function_name</span> <span class=o>=</span> <span class=s2>&#34;______-producer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>producer_log_group_arn</span> <span class=o>=</span> <span class=s2>&#34;arn:aws:logs:us-east-1:############:log-group:/aws/lambda/______-producer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>producer_log_group_name</span> <span class=o>=</span> <span class=s2>&#34;/aws/lambda/______-producer&#34;</span></span></span></code></pre></div><ul><li><em>Terraform 出力は <strong>outputs.tf</strong> ファイルで定義されています。</em></li><li><em>これらの出力は、ワークショップの他の部分でもプログラム的に使用されます。</em></li></ul></li></ul></li></ul><h4 id=producer-lambda-url-base_url-にトラフィックを送信する><code>producer-lambda</code> URL (<code>base_url</code>) にトラフィックを送信する</h4><p>デプロイした Lambda 関数からトレースを取得し始めるには、トラフィックを生成する必要があります。<code>producer-lambda</code>関数のエンドポイントにメッセージを送信し、それを Kinesis ストリームにレコードとして配置し、その後<code>consumer-lambda</code>関数によってストリームから取得されるようにします。</p><ul><li><p><code>auto</code> ディレクトリにいることを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwd</span></span></code></pre></div><ul><li><em>予想される出力は <strong>~/o11y-lambda-workshop/auto</strong> です</em></li></ul></li><li><p><code>auto</code> ディレクトリにいない場合は、次のコマンドを実行します</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/auto</span></span></code></pre></div></li></ul><p><code>send_message.py</code> スクリプトは、コマンドラインで入力を受け取り、JSON ディクショナリに追加し、while ループの一部として <code>producer-lambda</code> 関数のエンドポイントに繰り返し送信する Python スクリプトです。</p><ul><li><p>Run the <code>send_message.py</code> script as a background process</p><ul><li><em><code>--name</code> と <code>--superpower</code> 引数が必要です</em></li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nohup ./send_message.py --name CHANGEME --superpower CHANGEME <span class=p>&amp;</span></span></span></code></pre></div><ul><li><p>メッセージが成功した場合は、以下のような出力が表示されるはずです</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>1<span class=o>]</span> <span class=m>79829</span>
</span></span><span class=line><span class=cl>user@host manual % appending output to nohup.out</span></span></code></pre></div><ul><li><em>ここで重要な情報は 2 つあります:</em><ul><li><em>1 行目のプロセス ID（この例では <code>79829</code>）、および</em></li><li><em><code>appending output to nohup.out</code> メッセージ</em></li></ul></li><li><em><code>nohup</code> コマンドはスクリプトがバックグラウンドに送られた時に切断されないようにします。また、コマンドからの curl 出力を、現在いるフォルダと同じフォルダにある nohup.out ファイルにキャプチャします。</em></li><li><em><code>&</code> はシェルプロセスにこのプロセスをバックグラウンドで実行するよう指示し、シェルが他のコマンドを実行できるようにします。</em></li></ul></li></ul></li><li><p>次に、<code>response.logs</code> ファイルの内容を確認して、<code>producer-lambda</code> エンドポイントへのリクエストが成功したことを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat response.logs</span></span></code></pre></div><ul><li>メッセージが成功していれば、画面に印刷された行の中に次の出力が表示されるはずです：</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Message placed in the Event Stream: {prefix}-lambda_stream&#34;</span><span class=o>}</span></span></span></code></pre></div><ul><li>失敗した場合は、次のように表示されます：</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Internal server error&#34;</span><span class=o>}</span></span></span></code></pre></div></li></ul><details open class="box cstyle notices important"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-bolt"></i>
重要</summary><div class=box-content><p>この場合は、ワークショップ進行役の一人に支援を求めてください。</p></div></details><h4 id=lambda-関数のログを表示する>Lambda 関数のログを表示する</h4><p>次に、Lambda 関数のログを確認しましょう。</p><ul><li><p><strong>producer-lambda</strong> ログを表示するには、<strong>producer.logs</strong> ファイルを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat producer.logs</span></span></code></pre></div></li><li><p><strong>consumer-lambda</strong> ログを表示するには、<strong>consumer.logs</strong> ファイルを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat consumer.logs</span></span></code></pre></div></li></ul><p>ログを注意深く調べてください。</p><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
ワークショップの質問</summary><div class=box-content><ul><li>OpenTelemetry が読み込まれているのが見えますか？<code>splunk-extension-wrapper</code>のある行に注目してください<ul><li><ul><li><em><strong>splunk-extension-wrapper</strong>が読み込まれているのを見るために<code>head -n 50 producer.logs</code>または<code>head -n 50 consumer.logs</code>の実行を検討してください。</em></li></ul></li></ul></li></ul></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/05/29</span></span></footer></article><article class=default><header class=headline></header><h1 id=splunk-apmlambda関数およびトレース>Splunk APM、Lambda関数およびトレース</h1><p>Lambda 関数は相当量のトレースデータを生成しているはずで、それを確認する必要があります。Lambda 関数のリソース定義で構成された環境変数と OpenTelemetry Lambda layer の組み合わせにより、Splunk APM で関数とトレースを表示する準備が整いました。</p><h4 id=splunk-apm-概要で環境名を確認する>Splunk APM 概要で環境名を確認する</h4><p>まず、Splunk APM が受信しているトレースデータから<code>Environment</code>を認識していることを確認しましょう。これは<code>main.tf</code>の Lambda 関数定義で設定した<code>OTEL_RESOURCE_ATTRIBUTES</code>変数の一部として設定した<code>deployment.name</code>です。これは先ほど実行した<code>terraform apply</code>コマンドの出力の 1 つでもありました。</p><p>Splunk Observability Cloud で：</p><ul><li><p>左側のメインメニューから<code>APM</code>ボタンをクリックします。これにより Splunk APM 概要に移動します。</p></li><li><p><code>Environment:</code>ドロップダウンからあなたの APM 環境を選択します。</p><ul><li><em>APM 環境は<code>PREFIX-lambda-shop</code>形式になっているはずです。<code>PREFIX</code>は前提条件セクションで設定した環境変数から取得されます</em></li></ul></li></ul><details open class="box cstyle notices note"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-exclamation-circle"></i>
メモ</summary><div class=box-content><p>トレースが Splunk APM に表示されるまで数分かかる場合があります。環境のリストにあなたの環境名が表示されるまで、ブラウザの更新ボタンを押してみてください</p></div></details><p><a href=#R-image-d5204aaebe5e2fb7177e289764bd18ca class=lightbox-link><img alt="Splunk APM, Environment Name" class="lazy lightbox figure-image" loading=lazy src=../images/02-Auto-APM-EnvironmentName.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d5204aaebe5e2fb7177e289764bd18ca><img alt="Splunk APM, Environment Name" class="lazy lightbox lightbox-image" loading=lazy src=../images/02-Auto-APM-EnvironmentName.png></a></p><h4 id=環境のサービスマップを表示する>環境のサービスマップを表示する</h4><p>Environment ドロップダウンから環境名を選択したら、Lambda 関数のサービスマップを確認できます。</p><ul><li>APM 概要ページの右側にある<code>Service Map</code>ボタンをクリックします。これによりサービスマップビューに移動します。</li></ul><p><a href=#R-image-0c3c7aca1120a66b0df30d4d33d56daf class=lightbox-link><img alt="Splunk APM、サービスマップボタン" class="lazy lightbox figure-image" loading=lazy src=../images/03-Auto-ServiceMapButton.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-0c3c7aca1120a66b0df30d4d33d56daf><img alt="Splunk APM、サービスマップボタン" class="lazy lightbox lightbox-image" loading=lazy src=../images/03-Auto-ServiceMapButton.png></a></p><p><code>producer-lambda</code>関数とそのレコードを配置するために Kinesis ストリームに対して行っている呼び出しが表示されるはずです。</p><p><a href=#R-image-81be1679ac80686f02ba6ff81d9c0653 class=lightbox-link><img alt="Splunk APM、サービスマップ" class="lazy lightbox figure-image" loading=lazy src=../images/04-Auto-ServiceMap.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-81be1679ac80686f02ba6ff81d9c0653><img alt="Splunk APM、サービスマップ" class="lazy lightbox lightbox-image" loading=lazy src=../images/04-Auto-ServiceMap.png></a></p><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
ワークショップの質問</summary><div class=box-content><p>あなたの<code>consumer-lambda</code>関数はどうなっていますか？</p></div></details><h4 id=lambda-関数からのトレースを調査する>Lambda 関数からのトレースを調査する</h4><ul><li><code>Traces</code>ボタンをクリックしてトレースアナライザーを表示します。</li></ul><p><a href=#R-image-e4e5155e6869e7f280401c661d49a20a class=lightbox-link><img alt="Splunk APM、トレースボタン" class="lazy lightbox figure-image" loading=lazy src=../images/05-Auto-TraceButton.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e4e5155e6869e7f280401c661d49a20a><img alt="Splunk APM、トレースボタン" class="lazy lightbox lightbox-image" loading=lazy src=../images/05-Auto-TraceButton.png></a></p><p>このページでは、<code>producer-lambda</code>関数の OpenTelemetry Lambda layer から取り込まれたトレースを確認できます。</p><p><a href=#R-image-e7cd77df110be046a66c9be25ae6bdee class=lightbox-link><img alt="Splunk APM、トレースアナライザー" class="lazy lightbox figure-image" loading=lazy src=../images/06-Auto-TraceAnalyzer.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e7cd77df110be046a66c9be25ae6bdee><img alt="Splunk APM、トレースアナライザー" class="lazy lightbox lightbox-image" loading=lazy src=../images/06-Auto-TraceAnalyzer.png></a></p><ul><li>リストからハイパーリンクされた<code>Trace ID</code>をクリックして、調査するトレースを選択します。</li></ul><p><a href=#R-image-9c28e8515d204326a756747c1458e54d class=lightbox-link><img alt="Splunk APM、トレースとスパン" class="lazy lightbox figure-image" loading=lazy src=../images/07-Auto-TraceNSpans.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-9c28e8515d204326a756747c1458e54d><img alt="Splunk APM、トレースとスパン" class="lazy lightbox lightbox-image" loading=lazy src=../images/07-Auto-TraceNSpans.png></a></p><p><code>producer-lambda</code>関数が Kinesis ストリームにレコードを配置しているのが確認できます。しかし、<code>consumer-lambda</code>関数のアクションが見当たりません！</p><p>これはトレースコンテキストが伝播されていないためです。このワークショップの時点では、Kinesis サービスはトレースコンテキスト伝播をすぐには対応していません。分散トレースは Kinesis サービスで止まっており、そのコンテキストがストリームを通じて自動的に伝播されないため、それ以上先を見ることができません。</p><p>少なくとも、今はまだ&mldr;</p><p>次のセクションでこの問題にどう対処するか見ていきましょう。しかしその前に、後片付けをしましょう！</p><h3 id=クリーンアップ>クリーンアップ</h3><p>この自動計装演習の一部としてデプロイしたリソースはクリーンアップする必要があります。同様に、<code>producer-lambda</code>エンドポイントに対してトラフィックを生成していたスクリプトも、まだ実行中であれば停止する必要があります。以下の手順に従ってクリーンアップを行ってください。</p><h4 id=send_messageの停止><code>send_message</code>の停止</h4><ul><li><p><code>send_message.py</code>スクリプトがまだ実行中の場合は、次のコマンドで停止します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>fg</span></span></code></pre></div><ul><li>これによりバックグラウンドプロセスがフォアグラウンドに移動します。</li><li>次に<code>[CONTROL-C]</code>を押してプロセスを終了できます。</li></ul></li></ul><h4 id=全ての-aws-リソースを破棄する>全ての AWS リソースを破棄する</h4><p>Terraform は個々のリソースの状態をデプロイメントとして管理するのに優れています。定義に変更があっても、デプロイされたリソースを更新することもできます。しかし、一からやり直すために、リソースを破棄し、このワークショップの手動計装部分の一部として再デプロイします。</p><p>以下の手順に従ってリソースを破棄してください：</p><ul><li><p><code>auto</code>ディレクトリにいることを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwd</span></span></code></pre></div><ul><li><em>期待される出力は <strong>~/o11y-lambda-workshop/auto</strong> です</em></li></ul></li><li><p><code>auto</code>ディレクトリにいない場合は、以下のコマンドを実行します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/auto</span></span></code></pre></div></li><li><p>先ほどデプロイした Lambda 関数とその他の AWS リソースを破棄します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform destroy</span></span></code></pre></div><ul><li><code>Enter a value:</code>プロンプトが表示されたら<code>yes</code>と応答します</li><li>これによりリソースが破棄され、クリーンな環境が残ります</li></ul></li></ul><p>このプロセスにより、私たちの活動の結果として作成されたファイルとディレクトリは残ります。それらについては心配する必要はありません。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/05/29</span></span></footer></article><article class=default><header class=headline></header><h1 id=手動計装>手動計装</h1><p>ワークショップの第 2 部では、OpenTelemetry による手動計装が計測データ収集を強化する方法を実演することに焦点を当てます。より具体的には、今回のケースでは、<code>producer-lambda</code>関数から<code>consumer-lambda</code>関数にトレースコンテキストデータを伝播させることができるようになります。これにより、現在は自動コンテキスト伝播をサポートしていない Kinesis ストリームを介しても、2 つの関数間の関係を見ることができるようになります。</p><h3 id=手動計装ワークショップディレクトリとコンテンツ>手動計装ワークショップディレクトリとコンテンツ</h3><p>再度、作業ディレクトリとそのファイルの一部を確認することから始めます。今回は <code>o11y-lambda-workshop/manual</code> ディレクトリです。ここにはワークショップの手動計装部分のすべてのコンテンツがあります。</p><h4 id=manual-ディレクトリ><code>manual</code> ディレクトリ</h4><ul><li><p>以下のコマンドを実行して <code>o11y-lambda-workshop/manual</code> ディレクトリに移動します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/manual</span></span></code></pre></div></li><li><p><code>ls</code> コマンドでこのディレクトリの内容を確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ls</span></span></code></pre></div><ul><li><p><em>出力には以下のファイルとディレクトリが含まれるはずです：</em></p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>handler             outputs.tf          terraform.tf        variables.tf
</span></span><span class=line><span class=cl>main.tf             send_message.py     terraform.tfvars</span></span></code></pre></div></li></ul></li></ul><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
ワークショップの質問</summary><div class=box-content><p>このディレクトリと最初に始めた auto ディレクトリに何か違いがありますか？</p></div></details><h4 id=auto-と-manual-のファイルを比較する><code>auto</code> と <code>manual</code> のファイルを比較する</h4><p>見た目が同じように見えるこれらのファイルが実際に同じかどうか確認しましょう。</p><ul><li><p><code>auto</code> と <code>manual</code> ディレクトリの <code>main.tf</code> ファイルを比較します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>diff ~/o11y-lambda-workshop/auto/main.tf ~/o11y-lambda-workshop/manual/main.tf</span></span></code></pre></div><ul><li>違いはありません！<em>(違いがあるはずはありません。もし違いがあれば、ワークショップ進行役に支援を求めてください)</em></li></ul></li><li><p>次に、<code>producer.mjs</code> ファイルを比較してみましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>diff ~/o11y-lambda-workshop/auto/handler/producer.mjs ~/o11y-lambda-workshop/manual/handler/producer.mjs</span></span></code></pre></div><ul><li>ここにはかなりの違いがあります！</li></ul></li><li><p>ファイル全体を表示してその内容を調べたい場合は以下を実行します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat ~/o11y-lambda-workshop/handler/producer.mjs</span></span></code></pre></div><ul><li>必要な手動計装タスクを処理するために、いくつかの OpenTelemetry オブジェクトを関数に直接インポートしていることに注目してください。</li></ul><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>context</span><span class=p>,</span> <span class=nx>propagation</span><span class=p>,</span> <span class=nx>trace</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;@opentelemetry/api&#34;</span><span class=p>;</span></span></span></code></pre></div><ul><li>プロデューサー関数でコンテキストを伝播するために、<a href=https://www.npmjs.com/package/@opentelemetry/api rel=external>@opentelemetry/api</a> から次のオブジェクトをインポートしています：<ul><li>context</li><li>propagation</li><li>trace</li></ul></li></ul></li><li><p>最後に、<code>consumer.mjs</code> ファイルを比較します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>diff ~/o11y-lambda-workshop/auto/handler/consumer.mjs ~/o11y-lambda-workshop/manual/handler/consumer.mjs</span></span></code></pre></div><ul><li><p>ここにもいくつかの注目すべき違いがあります。より詳しく見てみましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat handler/consumer.mjs</span></span></code></pre></div><ul><li>このファイルでは、次の <a href=https://www.npmjs.com/package/@opentelemetry/api rel=external>@opentelemetry/api</a> オブジェクトをインポートしています：<ul><li>propagation</li><li>trace</li><li>ROOT_CONTEXT</li></ul></li><li>これらを使用して、プロデューサー関数から伝播されたトレースコンテキストを抽出します</li><li>その後、抽出したトレースコンテキストに <code>name</code> と <code>superpower</code> に基づいた新しいスパン属性を追加します</li></ul></li></ul></li></ul><h4 id=プロデューサー関数からのトレースコンテキスト伝播>プロデューサー関数からのトレースコンテキスト伝播</h4><p>以下のコードはプロデューサー関数内で次のステップを実行します：</p><ol><li>このトレース用のトレーサーを取得する</li><li>コンテキストキャリアオブジェクトを初期化する</li><li>アクティブスパンのコンテキストをキャリアオブジェクトに注入する</li><li>Kinesis ストリームに配置しようとしているレコードを修正し、アクティブスパンのコンテキストをコンシューマーに運ぶキャリアを含める</li></ol><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>context</span><span class=p>,</span> <span class=nx>propagation</span><span class=p>,</span> <span class=nx>trace</span><span class=p>,</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;@opentelemetry/api&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>tracer</span> <span class=o>=</span> <span class=nx>trace</span><span class=p>.</span><span class=nx>getTracer</span><span class=p>(</span><span class=s1>&#39;lambda-app&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>tracer</span><span class=p>.</span><span class=nx>startActiveSpan</span><span class=p>(</span><span class=s1>&#39;put-record&#39;</span><span class=p>,</span> <span class=kr>async</span><span class=p>(</span><span class=nx>span</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>carrier</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=nx>propagation</span><span class=p>.</span><span class=nx>inject</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>active</span><span class=p>(),</span> <span class=nx>carrier</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>eventBody</span> <span class=o>=</span> <span class=nx>Buffer</span><span class=p>.</span><span class=nx>from</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>body</span><span class=p>,</span> <span class=s1>&#39;base64&#39;</span><span class=p>).</span><span class=nx>toString</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>data</span> <span class=o>=</span> <span class=s2>&#34;{\&#34;tracecontext\&#34;: &#34;</span> <span class=o>+</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>carrier</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34;, \&#34;record\&#34;: &#34;</span> <span class=o>+</span> <span class=nx>eventBody</span> <span class=o>+</span> <span class=s2>&#34;}&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=sb>`Record with Trace Context added:
</span></span></span><span class=line><span class=cl><span class=sb>      </span><span class=si>${</span><span class=nx>data</span><span class=si>}</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>await</span> <span class=nx>kinesis</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=nx>PutRecordCommand</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>StreamName</span><span class=o>:</span> <span class=nx>streamName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>PartitionKey</span><span class=o>:</span> <span class=s2>&#34;1234&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>Data</span><span class=o>:</span> <span class=nx>data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>}),</span>
</span></span><span class=line><span class=cl>        <span class=nx>message</span> <span class=o>=</span> <span class=sb>`Message placed in the Event Stream: </span><span class=si>${</span><span class=nx>streamName</span><span class=si>}</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>span</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span></span></span></code></pre></div><h4 id=コンシューマー関数でのトレースコンテキスト抽出>コンシューマー関数でのトレースコンテキスト抽出</h4><p>以下のコードはコンシューマー関数内で次のステップを実行します：</p><ol><li><code>producer-lambda</code>から取得したコンテキストをキャリアオブジェクトに抽出する</li><li>現在のコンテキストからトレーサーを抽出する</li><li>抽出したコンテキスト内でトレーサーを使用して新しいスパンを開始する</li><li>ボーナス：メッセージからの値を含むカスタム属性など、追加の属性をスパンに追加する！</li><li>完了したら、スパンを終了する</li></ol><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>propagation</span><span class=p>,</span> <span class=nx>trace</span><span class=p>,</span> <span class=nx>ROOT_CONTEXT</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;@opentelemetry/api&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>carrier</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span> <span class=nx>message</span> <span class=p>).</span><span class=nx>tracecontext</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>parentContext</span> <span class=o>=</span> <span class=nx>propagation</span><span class=p>.</span><span class=nx>extract</span><span class=p>(</span><span class=nx>ROOT_CONTEXT</span><span class=p>,</span> <span class=nx>carrier</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>tracer</span> <span class=o>=</span> <span class=nx>trace</span><span class=p>.</span><span class=nx>getTracer</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>OTEL_SERVICE_NAME</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>span</span> <span class=o>=</span> <span class=nx>tracer</span><span class=p>.</span><span class=nx>startSpan</span><span class=p>(</span><span class=s2>&#34;Kinesis.getRecord&#34;</span><span class=p>,</span> <span class=kc>undefined</span><span class=p>,</span> <span class=nx>parentContext</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>span</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s2>&#34;span.kind&#34;</span><span class=p>,</span> <span class=s2>&#34;server&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>body</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span> <span class=nx>message</span> <span class=p>).</span><span class=nx>record</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>body</span><span class=p>.</span><span class=nx>name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>span</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s2>&#34;custom.tag.name&#34;</span><span class=p>,</span> <span class=nx>body</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>body</span><span class=p>.</span><span class=nx>superpower</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>span</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s2>&#34;custom.tag.superpower&#34;</span><span class=p>,</span> <span class=nx>body</span><span class=p>.</span><span class=nx>superpower</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>      <span class=nx>span</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span></span></span></code></pre></div><p>これでどのような違いが生まれるか見てみましょう！</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/05/13</span></span></footer></article><article class=default><header class=headline></header><h1 id=lambda関数のデプロイとトレースデータの生成>Lambda関数のデプロイとトレースデータの生成</h1><p>トレースデータを収集したい関数やサービスに手動計装を適用する方法がわかったので、Lambda 関数を再度デプロイして、<code>producer-lambda</code>エンドポイントに対するトラフィックを生成していきましょう。</p><h4 id=manual-ディレクトリで-terraform-を初期化する><code>manual</code> ディレクトリで Terraform を初期化する</h4><p>新しいディレクトリにいるので、ここでもう一度 Terraform を初期化する必要があります。</p><ul><li><p><code>manual</code> ディレクトリにいることを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwd</span></span></code></pre></div><ul><li><em>予想される出力は <strong>~/o11y-lambda-workshop/manual</strong> です</em></li></ul></li><li><p><code>manual</code> ディレクトリにいない場合は、次のコマンドを実行します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/manual</span></span></code></pre></div></li><li><p>次のコマンドを実行して、このディレクトリで Terraform を初期化します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform init</span></span></code></pre></div></li></ul><h4 id=lambda-関数とその他の-aws-リソースをデプロイする>Lambda 関数とその他の AWS リソースをデプロイする</h4><p>それでは、これらのリソースを再度デプロイしましょう！</p><ul><li><p>問題がないことを確認するために、<strong>terraform plan</strong> コマンドを実行します。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform plan</span></span></code></pre></div></li><li><p>続いて、<strong>terraform apply</strong> コマンドを使用して <strong>main.tf</strong> ファイルから Lambda 関数とその他のサポートリソースをデプロイします：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform apply</span></span></code></pre></div><ul><li><p><em><strong>Enter a value:</strong> プロンプトが表示されたら <strong>yes</strong> と応答します</em></p></li><li><p>これにより、以下のような出力が得られます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Outputs:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>base_url</span> <span class=o>=</span> <span class=s2>&#34;https://______.amazonaws.com/serverless_stage/producer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>consumer_function_name</span> <span class=o>=</span> <span class=s2>&#34;_____-consumer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>consumer_log_group_arn</span> <span class=o>=</span> <span class=s2>&#34;arn:aws:logs:us-east-1:############:log-group:/aws/lambda/______-consumer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>consumer_log_group_name</span> <span class=o>=</span> <span class=s2>&#34;/aws/lambda/______-consumer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>environment</span> <span class=o>=</span> <span class=s2>&#34;______-lambda-shop&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>lambda_bucket_name</span> <span class=o>=</span> <span class=s2>&#34;lambda-shop-______-______&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>producer_function_name</span> <span class=o>=</span> <span class=s2>&#34;______-producer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>producer_log_group_arn</span> <span class=o>=</span> <span class=s2>&#34;arn:aws:logs:us-east-1:############:log-group:/aws/lambda/______-producer&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>producer_log_group_name</span> <span class=o>=</span> <span class=s2>&#34;/aws/lambda/______-producer&#34;</span></span></span></code></pre></div></li></ul></li></ul><p>見ての通り、base_url の最初の部分とログループ ARN 以外は、このワークショップの自動計装部分をこの同じ時点まで実行したときと出力は概ね同じはずです。</p><h4 id=producer-lambda-エンドポイント-base_url-にトラフィックを送信する><code>producer-lambda</code> エンドポイント (base_url) にトラフィックを送信する</h4><p>もう一度、<code>name</code> と <code>superpower</code> をメッセージとしてエンドポイントに送信します。これはトレースコンテキストとともに、Kinesis ストリーム内のレコードに追加されます。</p><ul><li><p><code>manual</code> ディレクトリにいることを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwd</span></span></code></pre></div><ul><li><em>予想される出力は <strong>~/o11y-lambda-workshop/manual</strong> です</em></li></ul></li><li><p><code>manual</code> ディレクトリにいない場合は、次のコマンドを実行します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/manual</span></span></code></pre></div></li><li><p><code>send_message.py</code> スクリプトをバックグラウンドプロセスとして実行します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nohup ./send_message.py --name CHANGEME --superpower CHANGEME <span class=p>&amp;</span></span></span></code></pre></div></li><li><p>次に、response.logs ファイルの内容を確認して、<strong>producer-lambda</strong>エンドポイントへの呼び出しが成功しているか確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat response.logs</span></span></code></pre></div><ul><li><p>メッセージが成功していれば、画面に表示される行の中に次の出力が表示されるはずです：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Message placed in the Event Stream: hostname-eventStream&#34;</span><span class=o>}</span></span></span></code></pre></div></li><li><p>失敗した場合は、次のように表示されます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Internal server error&#34;</span><span class=o>}</span></span></span></code></pre></div></li></ul></li></ul><details open class="box cstyle notices important"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-bolt"></i>
重要</summary><div class=box-content><p>これが発生した場合は、ワークショップ進行役の一人に支援を求めてください。</p></div></details><h4 id=lambda-関数のログの確認>Lambda 関数のログの確認</h4><p>ログがどのようになっているか見てみましょう。</p><ul><li><p><strong>producer.logs</strong> ファイルを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat producer.logs</span></span></code></pre></div></li><li><p>そして <strong>consumer.logs</strong> ファイルを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat consumer.logs</span></span></code></pre></div></li></ul><p>ログを注意深く調べてください。</p><h5 id=ワークショップの質問><em>ワークショップの質問</em></h5><blockquote><p>違いに気づきましたか？</p></blockquote><h4 id=consumer-lambda-ログからのトレース-id-のコピー><code>consumer-lambda</code> ログからのトレース ID のコピー</h4><p>今回は、consumer-lambda のロググループが、我々が伝播した<code>tracecontext</code>とともに、メッセージを<code>record</code>としてログに記録しているのが確認できます。</p><p>トレース ID をコピーするには：</p><ul><li><code>Kinesis Message</code>ログの 1 つを見てみましょう。その中には<code>data</code>ディクショナリがあります</li><li>ネストされた<code>tracecontext</code>ディクショナリを見るために、<code>data</code>をより詳しく見てください</li><li><code>tracecontext</code>ディクショナリ内には、<code>traceparent</code>というキーと値のペアがあります</li><li><code>traceparent</code>キーと値のペアには、私たちが探しているトレース ID が含まれています<ul><li><code>-</code>で区切られた 4 つの値のグループがあります。トレース ID は 2 番目の文字グループです</li></ul></li><li><strong>トレース ID をコピーして保存してください。</strong> このワークショップの後のステップで必要になります</li></ul><p><a href=#R-image-61050b4b94ff58cd916557b315ffb067 class=lightbox-link><img alt="Lambda Consumer Logs、手動計装" class="lazy lightbox figure-image" loading=lazy src=../images/08-Manual-ConsumerLogs.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-61050b4b94ff58cd916557b315ffb067><img alt="Lambda Consumer Logs、手動計装" class="lazy lightbox lightbox-image" loading=lazy src=../images/08-Manual-ConsumerLogs.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/05/29</span></span></footer></article><article class=default><header class=headline></header><h1 id=splunk-apmlambda関数とトレース再び>Splunk APM、Lambda関数とトレース、再び！</h1><p>ログの外部でコンテキスト伝播の結果を確認するために、もう一度<a href=https://app.us1.signalfx.com/#/apm rel=external>Splunk APM UI</a>を参照します。</p><h4 id=splunk-apm-サービスマップで-lambda-関数を表示する>Splunk APM サービスマップで Lambda 関数を表示する</h4><p>もう一度 APM で環境のサービスマップを確認してみましょう。</p><p>Splunk Observability Cloud で：</p><ul><li><p>メインメニューの<code>APM</code>ボタンをクリックします。</p></li><li><p><code>Environment:</code>ドロップダウンからあなたの APM 環境を選択します。</p></li><li><p>APM 概要ページの右側にある<code>Service Map</code>ボタンをクリックします。これによりサービスマップビューに移動します。</p></li></ul><details open class="box cstyle notices note"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-exclamation-circle"></i>
> <em>注意：トレースが Splunk APM に表示されるまで数分かかる場合があります。環境のリストにあなたの環境名が表示されるまで、ブラウザの更新ボタンを押してみてください</em></summary></details><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
ワークショップの質問</summary><div class=box-content><p>違いに気づきましたか？</p></div></details><ul><li>今回は、伝播されたコンテキストによってリンクされた<code>producer-lambda</code>と<code>consumer-lambda</code>関数が見えるはずです！</li></ul><p><a href=#R-image-5f7283ab5914dfc0abfd372aaf3d6063 class=lightbox-link><img alt="Splunk APM、サービスマップ" class="lazy lightbox figure-image" loading=lazy src=../images/09-Manual-ServiceMap.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5f7283ab5914dfc0abfd372aaf3d6063><img alt="Splunk APM、サービスマップ" class="lazy lightbox lightbox-image" loading=lazy src=../images/09-Manual-ServiceMap.png></a></p><h4 id=トレース-id-で-lambda-トレースを調査する>トレース ID で Lambda トレースを調査する</h4><p>次に、環境に関連するトレースをもう一度確認します。</p><ul><li>コンシューマー関数のログからコピーしたトレース ID を、Traces 下の<code>View Trace ID</code>検索ボックスに貼り付け、<code>Go</code>をクリックします</li></ul><p><a href=#R-image-bbb1e499033551db45722abc8ac58413 class=lightbox-link><img alt="Splunk APM、トレースボタン" class="lazy lightbox figure-image" loading=lazy src=../images/10-Manual-TraceButton.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-bbb1e499033551db45722abc8ac58413><img alt="Splunk APM、トレースボタン" class="lazy lightbox lightbox-image" loading=lazy src=../images/10-Manual-TraceButton.png></a></p><details open class="box cstyle notices note"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-exclamation-circle"></i>
メモ</summary><div class=box-content><p>トレース ID は、私たちが伝播したトレースコンテキストの一部でした。</p></div></details><p>最も一般的な 2 つの伝播規格について読むことができます：</p><ol><li><a href=https:///www.w3.org/TR/trace-context/#traceparent-header rel=external>W3C</a></li><li><a href=https://github.com/openzipkin/b3-propagation#overall-process rel=external>B3</a></li></ol><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
ワークショップの質問</summary><div class=box-content><p>私たちはどちらを使用していますか？</p><ul><li><em>私たちの NodeJS 関数をサポートする Splunk Distribution of Opentelemetry JS は、<a href=https://docs.splunk.com/observability/en/gdi/get-data-in/application/nodejs/splunk-nodejs-otel-distribution.html#defaults-of-the-splunk-distribution-of-opentelemetry-js rel=external>デフォルト</a>で<code>W3C</code>標準を使用しています</em></li></ul></div></details><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
ワークショップの質問</summary><div class=box-content><p>ボーナス質問：W3C ヘッダーと B3 ヘッダーを混在させるとどうなりますか？</p></div></details><p><a href=#R-image-68e5382bf865bc2ecd4876518a331c06 class=lightbox-link><img alt="Splunk APM、IDによるトレース" class="lazy lightbox figure-image" loading=lazy src=../images/11-Manual-TraceByID.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-68e5382bf865bc2ecd4876518a331c06><img alt="Splunk APM、IDによるトレース" class="lazy lightbox lightbox-image" loading=lazy src=../images/11-Manual-TraceByID.png></a></p><p><code>consumer-lambda</code>スパンをクリックしてください。</p><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-question"></i>
ワークショップの質問</summary><div class=box-content><p>あなたのメッセージからの属性を見つけることができますか？</p></div></details><p><a href=#R-image-fb64a090decfa926430c362abbaa61a2 class=lightbox-link><img alt="Splunk APM、スパンタグ" class="lazy lightbox figure-image" loading=lazy src=../images/12-Manual-SpanTags.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-fb64a090decfa926430c362abbaa61a2><img alt="Splunk APM、スパンタグ" class="lazy lightbox lightbox-image" loading=lazy src=../images/12-Manual-SpanTags.png></a></p><h3 id=クリーンアップ>クリーンアップ</h3><p>いよいよワークショップの最後に来ました。後片付けをしましょう！</p><h4 id=send_messageの停止><code>send_message</code>の停止</h4><ul><li><p><code>send_message.py</code>スクリプトがまだ実行中の場合は、次のコマンドで停止します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>fg</span></span></code></pre></div><ul><li>これによりバックグラウンドプロセスがフォアグラウンドに移動します。</li><li>次に<code>[CONTROL-C]</code>を押してプロセスを終了できます。</li></ul></li></ul><h4 id=すべての-aws-リソースを破棄する>すべての AWS リソースを破棄する</h4><p>Terraform は個々のリソースの状態をデプロイメントとして管理するのに優れています。定義に変更があっても、デプロイされたリソースを更新することもできます。しかし、一からやり直すために、リソースを破棄し、このワークショップの手動計装部分の一部として再デプロイします。</p><p>以下の手順に従ってリソースを破棄してください：</p><ul><li><p><code>manual</code>ディレクトリにいることを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwd</span></span></code></pre></div><ul><li><em>予想される出力は <strong>~/o11y-lambda-workshop/manual</strong> です</em></li></ul></li><li><p><code>manual</code>ディレクトリにいない場合は、次のコマンドを実行します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/o11y-lambda-workshop/manual</span></span></code></pre></div></li><li><p>以前にデプロイした Lambda 関数とその他の AWS リソースを破棄します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform destroy</span></span></code></pre></div><ul><li><code>Enter a value:</code>プロンプトが表示されたら<code>yes</code>と応答します</li><li>これにより、リソースが破棄され、クリーンな環境が残ります</li></ul></li></ul><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/05/13</span></span></footer></article><article class=default><header class=headline></header><h1 id=結論>結論</h1><p>Lambda Tracing ワークショップを終えたことをおめでとうございます！自動計装を手動のステップで補完して、<code>producer-lambda</code>関数のコンテキストを Kinesis ストリーム内のレコードを介して<code>consumer-lambda</code>関数に送信する方法を見てきました。これにより、期待される分散トレースを構築し、Splunk APM で両方の関数間の関係をコンテキスト化することができました。</p><p><a href=#R-image-6c30ffb23de5b05352719c4930cb599c class=lightbox-link><img alt=完全に計装されたLambdaアプリケーション class="lazy lightbox figure-image" loading=lazy src=../images/13-Architecture_Instrumented.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-6c30ffb23de5b05352719c4930cb599c><img alt=完全に計装されたLambdaアプリケーション class="lazy lightbox lightbox-image" loading=lazy src=../images/13-Architecture_Instrumented.png></a></p><p>これで、2 つの異なる関数を手動でリンクしてトレースを構築することができます。これは、自動計装や第三者のシステムがコンテキスト伝播を標準でサポートしていない場合や、より関連性の高いトレース分析のためにカスタム属性をトレースに追加したい場合に役立ちます。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/05/13</span></span></footer></article></section><article class=default><header class=headline></header><h1 id=opentelemetrydockerk8sを実践で学ぶ>OpenTelemetry、Docker、K8sを実践で学ぶ</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>2 minutes</span>
</span>&nbsp;
<span class="badge cstyle blue badge-with-title"><span class=badge-title class=text-muted>Author
</span><span class=badge-content>Derek Mitchell</span></span><p>このワークショップでは、以下の項目について実践経験を積むことができます：</p><ul><li>Linux および Kubernetes 環境で、Splunk ディストリビューションの OpenTelemetry .NET を使用してコレクターのデプロイと.NET アプリケーションの計装を実践します。</li><li>.NET アプリケーションの「Docker 化」、Docker での実行、そして Splunk OpenTelemetry 計装の追加を実践します。</li><li>Helm を使用した K8s 環境での Splunk ディストロのコレクターのデプロイを実践します。その後、コレクター設定をカスタマイズし、問題のトラブルシューティングを行います。</li></ul><details open class="box cstyle notices primary"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-lightbulb"></i>
Tip</summary><div class=box-content><p>このワークショップを最も簡単にナビゲートする方法は以下を使用することです：</p><ul><li>このページの右上にある左右の矢印（<strong>&lt;</strong> | <strong>></strong>）</li><li>キーボードの左（◀️）と右（▶️）のカーソルキー</li></ul></div></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/06/17</span></span></footer></article><section><h1 class=a11y-only>OpenTelemetry、Docker、K8sを実践で学ぶのサブセクション</h1><article class=default><header class=headline></header><h1 id=ec2インスタンスへの接続>EC2インスタンスへの接続</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>5 minutes</span>
</span>&nbsp;<h2 id=ec2-インスタンスへ接続>EC2 インスタンスへ接続</h2><p>各参加者のために、AWS/EC2 に Ubuntu Linux インスタンスを用意しました。</p><p>インストラクターから提供された IP アドレスとパスワードを使用して、以下のいずれかの方法で EC2 インスタンスに接続してください：</p><ul><li>Mac OS / Linux<ul><li>ssh splunk@IP アドレス</li></ul></li><li>Windows 10+<ul><li>OpenSSH クライアントを使用</li></ul></li><li>以前のバージョンの Windows<ul><li>Putty を使用</li></ul></li></ul><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/06/16</span></span></footer></article><article class=default><header class=headline></header><h1 id=opentelemetryコレクターのデプロイ>OpenTelemetryコレクターのデプロイ</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<h2 id=opentelemetry-コレクターのアンインストール>OpenTelemetry コレクターのアンインストール</h2><p>EC2 インスタンスには、すでに Splunk Distribution の OpenTelemetry コレクターの古いバージョンが
インストールされている可能性があります。先に進む前に、次のコマンドを使用してアンインストールしましょう：</p><div class=tab-panel data-tab-group=R-tabs-dbd72531ce1793761f28f776f6280ee4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-d2bf21f2bf34f7a8c999bff8c3ca68f0 aria-expanded=true data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-dbd72531ce1793761f28f776f6280ee4","R-tab-f907e651164789346ae0a1e257c462d8")'>
<span class=tab-nav-text>Script</span>
</button>
<button aria-controls=R-tab-id-5a95c1cd260b7e9d39c1467770ee24a8 aria-expanded=false data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-dbd72531ce1793761f28f776f6280ee4","R-tab-4c50e65a8a1f9aa989870396b5c0a12b")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div id=R-tab-id-d2bf21f2bf34f7a8c999bff8c3ca68f0 data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -sSL https://dl.signalfx.com/splunk-otel-collector.sh &gt; /tmp/splunk-otel-collector.sh<span class=p>;</span>
</span></span><span class=line><span class=cl>sudo sh /tmp/splunk-otel-collector.sh --uninstall</span></span></code></pre></div></div></div><div id=R-tab-id-5a95c1cd260b7e9d39c1467770ee24a8 data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Reading package lists... Done
</span></span><span class=line><span class=cl>Building dependency tree... Done
</span></span><span class=line><span class=cl>Reading state information... Done
</span></span><span class=line><span class=cl>The following packages will be REMOVED:
</span></span><span class=line><span class=cl>  splunk-otel-collector*
</span></span><span class=line><span class=cl><span class=m>0</span> upgraded, <span class=m>0</span> newly installed, <span class=m>1</span> to remove and <span class=m>167</span> not upgraded.
</span></span><span class=line><span class=cl>After this operation, <span class=m>766</span> MB disk space will be freed.
</span></span><span class=line><span class=cl><span class=o>(</span>Reading database ... <span class=m>157441</span> files and directories currently installed.<span class=o>)</span>
</span></span><span class=line><span class=cl>Removing splunk-otel-collector <span class=o>(</span>0.92.0<span class=o>)</span> ...
</span></span><span class=line><span class=cl><span class=o>(</span>Reading database ... <span class=m>147373</span> files and directories currently installed.<span class=o>)</span>
</span></span><span class=line><span class=cl>Purging configuration files <span class=k>for</span> splunk-otel-collector <span class=o>(</span>0.92.0<span class=o>)</span> ...
</span></span><span class=line><span class=cl>Scanning processes...
</span></span><span class=line><span class=cl>Scanning candidates...
</span></span><span class=line><span class=cl>Scanning linux images...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Running kernel seems to be up-to-date.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Restarting services...
</span></span><span class=line><span class=cl> systemctl restart fail2ban.service falcon-sensor.service
</span></span><span class=line><span class=cl>Service restarts being deferred:
</span></span><span class=line><span class=cl> systemctl restart networkd-dispatcher.service
</span></span><span class=line><span class=cl> systemctl restart unattended-upgrades.service
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>No containers need to be restarted.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>No user sessions are running outdated binaries.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>No VM guests are running outdated hypervisor <span class=o>(</span>qemu<span class=o>)</span> binaries on this host.
</span></span><span class=line><span class=cl>Successfully removed the splunk-otel-collector package</span></span></code></pre></div></div></div></div></div><h2 id=opentelemetry-collector-のデプロイ>OpenTelemetry collector のデプロイ</h2><p>Linux EC2 インスタンスに、Splunk Distribution の OpenTelemetry コレクターの最新バージョンをデプロイしましょう。</p><p>これは<code>curl</code>を使用してコレクターバイナリをダウンロードし、特定の引数を指定して実行することで可能です。
これらの引数は、データを送信する realm、使用するアクセストークン、
およびデータを送信するデプロイメント環境をコレクターに指示します。</p><blockquote><p>Splunk Observability Cloud におけるデプロイメント環境とは、システムまたはアプリケーションの個別のデプロイメントであり、同じアプリケーションの他のデプロイメントの設定と重複しない設定を行うことができます。</p></blockquote><div class=tab-panel data-tab-group=R-tabs-c1d753ff0601879d96c81b318050e6da><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-a499a1ce972fe7d8cfa104265d69884d aria-expanded=true data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-c1d753ff0601879d96c81b318050e6da","R-tab-f907e651164789346ae0a1e257c462d8")'>
<span class=tab-nav-text>Script</span>
</button>
<button aria-controls=R-tab-id-aaae144c567e3c174e38c8b15db13c0f aria-expanded=false data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-c1d753ff0601879d96c81b318050e6da","R-tab-4c50e65a8a1f9aa989870396b5c0a12b")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div id=R-tab-id-a499a1ce972fe7d8cfa104265d69884d data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -sSL https://dl.signalfx.com/splunk-otel-collector.sh &gt; /tmp/splunk-otel-collector.sh<span class=p>;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>sudo sh /tmp/splunk-otel-collector.sh <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--realm <span class=nv>$REALM</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--mode agent <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--without-instrumentation <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--deployment-environment otel-<span class=nv>$INSTANCE</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-- <span class=nv>$ACCESS_TOKEN</span></span></span></code></pre></div></div></div><div id=R-tab-id-aaae144c567e3c174e38c8b15db13c0f data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Splunk OpenTelemetry Collector Version: latest
</span></span><span class=line><span class=cl>Memory Size in MIB: <span class=m>512</span>
</span></span><span class=line><span class=cl>Realm: us1
</span></span><span class=line><span class=cl>Ingest Endpoint: https://ingest.us1.signalfx.com
</span></span><span class=line><span class=cl>API Endpoint: https://api.us1.signalfx.com
</span></span><span class=line><span class=cl>HEC Endpoint: https://ingest.us1.signalfx.com/v1/log
</span></span><span class=line><span class=cl>etc.</span></span></code></pre></div></div></div></div></div><p>詳細については、<a href=https://docs.splunk.com/observability/en/gdi/opentelemetry/collector-linux/install-linux.html#otel-install-linux rel=external>インストーラースクリプトを使用した Linux 用コレクターのインストール</a>
を参照してください。</p><h2 id=コレクターが実行中であることを確認>コレクターが実行中であることを確認</h2><p>インスタンスでコレクターが正常に実行されていることを確認しましょう。</p><blockquote><p>ステータスコマンドを終了するには、Ctrl + C を押します。</p></blockquote><div class=tab-panel data-tab-group=R-tabs-c0dea386582701268766e4e2507fdacc><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-56dc22099ee07062d5c1df98d7bdc7c2 aria-expanded=true data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-c0dea386582701268766e4e2507fdacc","R-tab-f907e651164789346ae0a1e257c462d8")'>
<span class=tab-nav-text>Script</span>
</button>
<button aria-controls=R-tab-id-eb33ded88947d2c344a85dcd7f3a2f01 aria-expanded=false data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-c0dea386582701268766e4e2507fdacc","R-tab-4c50e65a8a1f9aa989870396b5c0a12b")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div id=R-tab-id-56dc22099ee07062d5c1df98d7bdc7c2 data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl status splunk-otel-collector</span></span></code></pre></div></div></div><div id=R-tab-id-eb33ded88947d2c344a85dcd7f3a2f01 data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>● splunk-otel-collector.service - Splunk OpenTelemetry Collector
</span></span><span class=line><span class=cl>     Loaded: loaded <span class=o>(</span>/lib/systemd/system/splunk-otel-collector.service<span class=p>;</span> enabled<span class=p>;</span> vendor preset: enabled<span class=o>)</span>
</span></span><span class=line><span class=cl>    Drop-In: /etc/systemd/system/splunk-otel-collector.service.d
</span></span><span class=line><span class=cl>             └─service-owner.conf
</span></span><span class=line><span class=cl>     Active: active <span class=o>(</span>running<span class=o>)</span> since Fri 2024-12-20 00:13:14 UTC<span class=p>;</span> 45s ago
</span></span><span class=line><span class=cl>   Main PID: <span class=m>14465</span> <span class=o>(</span>otelcol<span class=o>)</span>
</span></span><span class=line><span class=cl>      Tasks: <span class=m>9</span> <span class=o>(</span>limit: 19170<span class=o>)</span>
</span></span><span class=line><span class=cl>     Memory: 117.4M
</span></span><span class=line><span class=cl>        CPU: 681ms
</span></span><span class=line><span class=cl>     CGroup: /system.slice/splunk-otel-collector.service
</span></span><span class=line><span class=cl>             └─14465 /usr/bin/otelcol</span></span></code></pre></div></div></div></div></div><h2 id=コレクターログの確認方法>コレクターログの確認方法</h2><p><code>journalctl</code>を使用してコレクターログを表示できます：</p><blockquote><p>ログの監視を終了するには、Ctrl + C を押します。</p></blockquote><div class=tab-panel data-tab-group=R-tabs-ae3f0403640989f629e02099f251830b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-b54d93d3755da7b4f506ef4a299620b6 aria-expanded=true data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-ae3f0403640989f629e02099f251830b","R-tab-f907e651164789346ae0a1e257c462d8")'>
<span class=tab-nav-text>Script</span>
</button>
<button aria-controls=R-tab-id-e68ef4c90911d6758be75e160137f6ed aria-expanded=false data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-ae3f0403640989f629e02099f251830b","R-tab-4c50e65a8a1f9aa989870396b5c0a12b")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div id=R-tab-id-b54d93d3755da7b4f506ef4a299620b6 data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo journalctl -u splunk-otel-collector -f -n <span class=m>100</span></span></span></code></pre></div></div></div><div id=R-tab-id-e68ef4c90911d6758be75e160137f6ed data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Dec <span class=m>20</span> 00:13:14 derek-1 systemd<span class=o>[</span>1<span class=o>]</span>: Started Splunk OpenTelemetry Collector.
</span></span><span class=line><span class=cl>Dec <span class=m>20</span> 00:13:14 derek-1 otelcol<span class=o>[</span>14465<span class=o>]</span>: 2024/12/20 00:13:14 settings.go:483: Set config to /etc/otel/collector/agent_config.yaml
</span></span><span class=line><span class=cl>Dec <span class=m>20</span> 00:13:14 derek-1 otelcol<span class=o>[</span>14465<span class=o>]</span>: 2024/12/20 00:13:14 settings.go:539: Set memory limit to <span class=m>460</span> MiB
</span></span><span class=line><span class=cl>Dec <span class=m>20</span> 00:13:14 derek-1 otelcol<span class=o>[</span>14465<span class=o>]</span>: 2024/12/20 00:13:14 settings.go:524: Set soft memory limit <span class=nb>set</span> to <span class=m>460</span> MiB
</span></span><span class=line><span class=cl>Dec <span class=m>20</span> 00:13:14 derek-1 otelcol<span class=o>[</span>14465<span class=o>]</span>: 2024/12/20 00:13:14 settings.go:373: Set garbage collection target percentage <span class=o>(</span>GOGC<span class=o>)</span> to <span class=m>400</span>
</span></span><span class=line><span class=cl>Dec <span class=m>20</span> 00:13:14 derek-1 otelcol<span class=o>[</span>14465<span class=o>]</span>: 2024/12/20 00:13:14 settings.go:414: <span class=nb>set</span> <span class=s2>&#34;SPLUNK_LISTEN_INTERFACE&#34;</span> to <span class=s2>&#34;127.0.0.1&#34;</span>
</span></span><span class=line><span class=cl>etc.</span></span></code></pre></div></div></div></div></div><h2 id=コレクターの設定>コレクターの設定</h2><p>このコレクターが使用している設定はどこで見つけられるでしょうか？</p><p>その設定は<code>/etc/otel/collector</code>ディレクトリにあります。コレクターを<code>agent</code>モードで
インストールしたため、コレクター設定は<code>agent_config.yaml</code>ファイルにあります。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/06/17</span></span></footer></article><article class=default><header class=headline></header><h1 id=netアプリケーションのデプロイ>.NETアプリケーションのデプロイ</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<h2 id=前提条件>前提条件</h2><p>アプリケーションをデプロイする前に、インスタンスに.NET 8 SDK をインストールする必要があります。</p><div class=tab-panel data-tab-group=R-tabs-748ab4691760a445608d96a7ec308cb1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-4157d25c5b6c154af06bd23084f4c143 aria-expanded=true data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-748ab4691760a445608d96a7ec308cb1","R-tab-f907e651164789346ae0a1e257c462d8")'>
<span class=tab-nav-text>Script</span>
</button>
<button aria-controls=R-tab-id-4bb65f893b7dfdae024b2fc10597dfe3 aria-expanded=false data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-748ab4691760a445608d96a7ec308cb1","R-tab-4c50e65a8a1f9aa989870396b5c0a12b")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div id=R-tab-id-4157d25c5b6c154af06bd23084f4c143 data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt-get update <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  sudo apt-get install -y dotnet-sdk-8.0</span></span></code></pre></div></div></div><div id=R-tab-id-4bb65f893b7dfdae024b2fc10597dfe3 data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Hit:1 http://us-west-1.ec2.archive.ubuntu.com/ubuntu jammy InRelease
</span></span><span class=line><span class=cl>Hit:2 http://us-west-1.ec2.archive.ubuntu.com/ubuntu jammy-updates InRelease
</span></span><span class=line><span class=cl>Hit:3 http://us-west-1.ec2.archive.ubuntu.com/ubuntu jammy-backports InRelease
</span></span><span class=line><span class=cl>Hit:4 http://security.ubuntu.com/ubuntu jammy-security InRelease
</span></span><span class=line><span class=cl>Ign:5 https://splunk.jfrog.io/splunk/otel-collector-deb release InRelease
</span></span><span class=line><span class=cl>Hit:6 https://splunk.jfrog.io/splunk/otel-collector-deb release Release
</span></span><span class=line><span class=cl>Reading package lists... Done
</span></span><span class=line><span class=cl>Reading package lists... Done
</span></span><span class=line><span class=cl>Building dependency tree... Done
</span></span><span class=line><span class=cl>Reading state information... Done
</span></span><span class=line><span class=cl>The following additional packages will be installed:
</span></span><span class=line><span class=cl>  aspnetcore-runtime-8.0 aspnetcore-targeting-pack-8.0 dotnet-apphost-pack-8.0 dotnet-host-8.0 dotnet-hostfxr-8.0 dotnet-runtime-8.0 dotnet-targeting-pack-8.0 dotnet-templates-8.0 liblttng-ust-common1
</span></span><span class=line><span class=cl>  liblttng-ust-ctl5 liblttng-ust1 netstandard-targeting-pack-2.1-8.0
</span></span><span class=line><span class=cl>The following NEW packages will be installed:
</span></span><span class=line><span class=cl>  aspnetcore-runtime-8.0 aspnetcore-targeting-pack-8.0 dotnet-apphost-pack-8.0 dotnet-host-8.0 dotnet-hostfxr-8.0 dotnet-runtime-8.0 dotnet-sdk-8.0 dotnet-targeting-pack-8.0 dotnet-templates-8.0
</span></span><span class=line><span class=cl>  liblttng-ust-common1 liblttng-ust-ctl5 liblttng-ust1 netstandard-targeting-pack-2.1-8.0
</span></span><span class=line><span class=cl><span class=m>0</span> upgraded, <span class=m>13</span> newly installed, <span class=m>0</span> to remove and <span class=m>0</span> not upgraded.
</span></span><span class=line><span class=cl>Need to get <span class=m>138</span> MB of archives.
</span></span><span class=line><span class=cl>After this operation, <span class=m>495</span> MB of additional disk space will be used.
</span></span><span class=line><span class=cl>etc.</span></span></code></pre></div></div></div></div></div><p>詳細については、<a href="https://learn.microsoft.com/en-us/dotnet/core/install/linux-ubuntu-install?tabs=dotnet8&pivots=os-linux-ubuntu-2404" rel=external>Ubuntu に.NET SDK または.NET Runtime をインストールする</a>
を参照してください。</p><h2 id=net-アプリケーションの確認>.NET アプリケーションの確認</h2><p>ターミナルで、アプリケーションディレクトリに移動します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/workshop/docker-k8s-otel/helloworld</span></span></code></pre></div><p>このワークショップでは、シンプルな「Hello World」.NET アプリケーションを使用します。主要なロジックは
HelloWorldController.cs ファイルにあります：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kd>public</span> <span class=k>class</span> <span class=nc>HelloWorldController</span> <span class=p>:</span> <span class=n>ControllerBase</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>ILogger</span><span class=p>&lt;</span><span class=n>HelloWorldController</span><span class=p>&gt;</span> <span class=n>logger</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>HelloWorldController</span><span class=p>(</span><span class=n>ILogger</span><span class=p>&lt;</span><span class=n>HelloWorldController</span><span class=p>&gt;</span> <span class=n>logger</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=n>logger</span> <span class=p>=</span> <span class=n>logger</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>    [HttpGet(&#34;/hello/{name?}&#34;)]</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>string</span> <span class=n>Hello</span><span class=p>(</span><span class=kt>string</span> <span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>IsNullOrEmpty</span><span class=p>(</span><span class=n>name</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>           <span class=n>logger</span><span class=p>.</span><span class=n>LogInformation</span><span class=p>(</span><span class=s>&#34;/hello endpoint invoked anonymously&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>           <span class=k>return</span> <span class=s>&#34;Hello, World!&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=p>.</span><span class=n>LogInformation</span><span class=p>(</span><span class=s>&#34;/hello endpoint invoked by {name}&#34;</span><span class=p>,</span> <span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>String</span><span class=p>.</span><span class=n>Format</span><span class=p>(</span><span class=s>&#34;Hello, {0}!&#34;</span><span class=p>,</span> <span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h2 id=net-アプリケーションのビルドと実行>.NET アプリケーションのビルドと実行</h2><p>以下のコマンドを使用してアプリケーションをビルドできます：</p><div class=tab-panel data-tab-group=R-tabs-7f4eeedcea0e19ab2bb03fe389d9d70c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-f6bb69bdb43ae0bb5b3a59464ebb3654 aria-expanded=true data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-7f4eeedcea0e19ab2bb03fe389d9d70c","R-tab-f907e651164789346ae0a1e257c462d8")'>
<span class=tab-nav-text>Script</span>
</button>
<button aria-controls=R-tab-id-6b97632adeda1a0178e910a9fd1a45ee aria-expanded=false data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-7f4eeedcea0e19ab2bb03fe389d9d70c","R-tab-4c50e65a8a1f9aa989870396b5c0a12b")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div id=R-tab-id-f6bb69bdb43ae0bb5b3a59464ebb3654 data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dotnet build</span></span></code></pre></div></div></div><div id=R-tab-id-6b97632adeda1a0178e910a9fd1a45ee data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>MSBuild version 17.8.5+b5265ef37 <span class=k>for</span> .NET
</span></span><span class=line><span class=cl>  Determining projects to restore...
</span></span><span class=line><span class=cl>  All projects are up-to-date <span class=k>for</span> restore.
</span></span><span class=line><span class=cl>  helloworld -&gt; /home/splunk/workshop/docker-k8s-otel/helloworld/bin/Debug/net8.0/helloworld.dll
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Build succeeded.
</span></span><span class=line><span class=cl>    <span class=m>0</span> Warning<span class=o>(</span>s<span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=m>0</span> Error<span class=o>(</span>s<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Time Elapsed 00:00:02.04</span></span></code></pre></div></div></div></div></div><p>ビルドが成功したら、次のように実行できます：</p><div class=tab-panel data-tab-group=R-tabs-ba95965326e680055d304e4900a98f44><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-f9b08167523143b96d2cf51a254ef3ee aria-expanded=true data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-ba95965326e680055d304e4900a98f44","R-tab-f907e651164789346ae0a1e257c462d8")'>
<span class=tab-nav-text>Script</span>
</button>
<button aria-controls=R-tab-id-563527799225cee8b0a34f2e936a872a aria-expanded=false data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-ba95965326e680055d304e4900a98f44","R-tab-4c50e65a8a1f9aa989870396b5c0a12b")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div id=R-tab-id-f9b08167523143b96d2cf51a254ef3ee data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dotnet run</span></span></code></pre></div></div></div><div id=R-tab-id-563527799225cee8b0a34f2e936a872a data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Building...
</span></span><span class=line><span class=cl>info: Microsoft.Hosting.Lifetime<span class=o>[</span>14<span class=o>]</span>
</span></span><span class=line><span class=cl>      Now listening on: http://localhost:8080
</span></span><span class=line><span class=cl>info: Microsoft.Hosting.Lifetime<span class=o>[</span>0<span class=o>]</span>
</span></span><span class=line><span class=cl>      Application started. Press Ctrl+C to shut down.
</span></span><span class=line><span class=cl>info: Microsoft.Hosting.Lifetime<span class=o>[</span>0<span class=o>]</span>
</span></span><span class=line><span class=cl>      Hosting environment: Development
</span></span><span class=line><span class=cl>info: Microsoft.Hosting.Lifetime<span class=o>[</span>0<span class=o>]</span>
</span></span><span class=line><span class=cl>      Content root path: /home/splunk/workshop/docker-k8s-otel/helloworld</span></span></code></pre></div></div></div></div></div><p>実行したら、Ubuntu インスタンスへの SSH 接続を 2 つ目のターミナルで開き、curl を使用してアプリケーションにアクセスします：</p><div class=tab-panel data-tab-group=R-tabs-89281805f3700ca2fe49eb91c327ffdf><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-9ff4b9a4f4e66e13133dabc073ef8f22 aria-expanded=true data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-89281805f3700ca2fe49eb91c327ffdf","R-tab-f907e651164789346ae0a1e257c462d8")'>
<span class=tab-nav-text>Script</span>
</button>
<button aria-controls=R-tab-id-4a5a08ea20c41b44234a67a54de8381a aria-expanded=false data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-89281805f3700ca2fe49eb91c327ffdf","R-tab-4c50e65a8a1f9aa989870396b5c0a12b")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div id=R-tab-id-9ff4b9a4f4e66e13133dabc073ef8f22 data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://localhost:8080/hello</span></span></code></pre></div></div></div><div id=R-tab-id-4a5a08ea20c41b44234a67a54de8381a data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Hello, World!</span></span></code></pre></div></div></div></div></div><p>名前を渡すこともできます：</p><div class=tab-panel data-tab-group=R-tabs-6b3b4251dcb770bfb72a69e9a6756dcb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-cf1f3559bd2819ecc438b68ac2f07295 aria-expanded=true data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-6b3b4251dcb770bfb72a69e9a6756dcb","R-tab-f907e651164789346ae0a1e257c462d8")'>
<span class=tab-nav-text>Script</span>
</button>
<button aria-controls=R-tab-id-58eee56bf6ce540b1c235c5ed9c425bb aria-expanded=false data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-6b3b4251dcb770bfb72a69e9a6756dcb","R-tab-4c50e65a8a1f9aa989870396b5c0a12b")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div id=R-tab-id-cf1f3559bd2819ecc438b68ac2f07295 data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://localhost:8080/hello/Tom</span></span></code></pre></div></div></div><div id=R-tab-id-58eee56bf6ce540b1c235c5ed9c425bb data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Hello, Tom!</span></span></code></pre></div></div></div></div></div><blockquote><p>次のステップに進む前に、Ctrl + C を押して Helloworld アプリを終了してください。</p></blockquote><h2 id=次のステップ>次のステップ</h2><p>アプリケーションを OpenTelemetry で計装するために使用できる 3 つの方法は何でしょうか？</p><p><a href=#R-image-26ee47ee2ec25d4f55a225b1584fecde class=lightbox-link><img alt=Traces class="lazy lightbox figure-image" loading=lazy src=../images/NetInstrumentation.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-26ee47ee2ec25d4f55a225b1584fecde><img alt=Traces class="lazy lightbox lightbox-image" loading=lazy src=../images/NetInstrumentation.png></a></p><p>オプションの詳細については、<a href=https://docs.splunk.com/observability/en/gdi/get-data-in/application/otel-dotnet/instrumentation/instrument-dotnet-application.html rel=external>Splunk Observability Cloud 用の.NET アプリケーションの計装</a>
を参照してください。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/06/17</span></span></footer></article><article class=default><header class=headline></header><h1 id=opentelemetryでnetアプリケーションを計装する>OpenTelemetryで.NETアプリケーションを計装する</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>20 minutes</span>
</span>&nbsp;<h2 id=splunk-distribution-of-opentelemetry-のダウンロード>Splunk Distribution of OpenTelemetry のダウンロード</h2><p>このワークショップでは、NuGet パッケージを使用せず、Splunk Distribution of OpenTelemetry を
手動でインストールします。</p><p>最新の<code>splunk-otel-dotnet-install.sh</code>ファイルをダウンロードすることから始めます。
これを使用して.NET アプリケーションを計装します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/workshop/docker-k8s-otel/helloworld
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>curl -sSfL https://github.com/signalfx/splunk-otel-dotnet/releases/latest/download/splunk-otel-dotnet-install.sh -O</span></span></code></pre></div><p>インストールプロセスの詳細については、<a href=https://docs.splunk.com/observability/en/gdi/get-data-in/application/otel-dotnet/instrumentation/instrument-dotnet-application.html#install-the-splunk-distribution-of-opentelemetry-net-manually rel=external>Splunk Distribution of OpenTelemetry .NET の手動インストール</a>
を参照してください。</p><h2 id=ディストリビューションのインストール>ディストリビューションのインストール</h2><p>ターミナルで、以下のようにディストリビューションをインストールします</p><div class=tab-panel data-tab-group=R-tabs-cad19e7147a47b3e85664d2956350640><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-f6b81d379c46a5e35b077131c558361a aria-expanded=true data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-cad19e7147a47b3e85664d2956350640","R-tab-f907e651164789346ae0a1e257c462d8")'>
<span class=tab-nav-text>Script</span>
</button>
<button aria-controls=R-tab-id-bad7fdde9a066c6d097175743ba0b7d9 aria-expanded=false data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-cad19e7147a47b3e85664d2956350640","R-tab-4c50e65a8a1f9aa989870396b5c0a12b")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div id=R-tab-id-f6b81d379c46a5e35b077131c558361a data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sh ./splunk-otel-dotnet-install.sh</span></span></code></pre></div></div></div><div id=R-tab-id-bad7fdde9a066c6d097175743ba0b7d9 data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Downloading v1.8.0 <span class=k>for</span> linux-glibc <span class=o>(</span>/tmp/tmp.m3tSdtbmge/splunk-opentelemetry-dotnet-linux-glibc-x64.zip<span class=o>)</span>...</span></span></code></pre></div></div></div></div></div><blockquote><p>注意：上記のコマンドを実行する際には、ARCHITECTURE 環境変数を含める必要がある場合があります：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>ARCHITECTURE</span><span class=o>=</span>x64 sh ./splunk-otel-dotnet-install.sh</span></span></code></pre></div></blockquote><h2 id=計装の有効化>計装の有効化</h2><p>次に、OpenTelemetry 計装を有効化できます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>. <span class=nv>$HOME</span>/.splunk-otel-dotnet/instrument.sh</span></span></code></pre></div><h2 id=デプロイメント環境の設定>デプロイメント環境の設定</h2><p>デプロイメント環境を設定して、データが Splunk Observability Cloud 内の独自の
環境に流れるようにしましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>OTEL_RESOURCE_ATTRIBUTES</span><span class=o>=</span>deployment.environment<span class=o>=</span>otel-<span class=nv>$INSTANCE</span></span></span></code></pre></div><h2 id=計装を使用したアプリケーションの実行>計装を使用したアプリケーションの実行</h2><p>以下のようにアプリケーションを実行できます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dotnet run</span></span></code></pre></div><h2 id=チャレンジ>チャレンジ</h2><p>Linux インスタンスから C#アプリケーションによってエクスポートされているトレースをどのように確認できるでしょうか？</p><details><summary><b>答えを見るにはここをクリック</b></summary><p>これを行う方法は 2 つあります：</p><ol><li><code>dotnet run</code>コマンドの開始時に<code>OTEL_TRACES_EXPORTER=otlp,console</code>を追加することで、トレースが OTLP 経由でコレクターに書き込まれるとともに、コンソールにも書き込まれるようになります。</li></ol><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>OTEL_TRACES_EXPORTER</span><span class=o>=</span>otlp,console dotnet run</span></span></code></pre></div><ol start=2><li>あるいは、コレクター設定にデバッグエクスポーターを追加し、それをトレースパイプラインに追加することで、トレースがコレクターログに書き込まれるようになります。</li></ol><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbosity</span><span class=p>:</span><span class=w> </span><span class=l>detailed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>jaeger, otlp, zipkin]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlphttp, signalfx, debug]</span></span></span></code></pre></div></details><h2 id=アプリケーションへのアクセス>アプリケーションへのアクセス</h2><p>アプリケーションが実行中になったら、2 つ目の SSH ターミナルを使用して curl でアクセスします：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://localhost:8080/hello</span></span></code></pre></div><p>以前と同様に、<code>Hello, World!</code>が返されるはずです。</p><p>トレースログを有効にした場合は、以下のようなトレースがコンソールまたはコレクターログに書き込まれているのを確認できるはずです：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>info: Program<span class=o>[</span>0<span class=o>]</span>
</span></span><span class=line><span class=cl>      /hello endpoint invoked anonymously
</span></span><span class=line><span class=cl>Activity.TraceId:            c7bbf57314e4856447508cd8addd49b0
</span></span><span class=line><span class=cl>Activity.SpanId:             1c92ac653c3ece27
</span></span><span class=line><span class=cl>Activity.TraceFlags:         Recorded
</span></span><span class=line><span class=cl>Activity.ActivitySourceName: Microsoft.AspNetCore
</span></span><span class=line><span class=cl>Activity.DisplayName:        GET /hello/<span class=o>{</span>name?<span class=o>}</span>
</span></span><span class=line><span class=cl>Activity.Kind:               Server
</span></span><span class=line><span class=cl>Activity.StartTime:          2024-12-20T00:45:25.6551267Z
</span></span><span class=line><span class=cl>Activity.Duration:           00:00:00.0006464
</span></span><span class=line><span class=cl>Activity.Tags:
</span></span><span class=line><span class=cl>    server.address: localhost
</span></span><span class=line><span class=cl>    server.port: <span class=m>8080</span>
</span></span><span class=line><span class=cl>    http.request.method: GET
</span></span><span class=line><span class=cl>    url.scheme: http
</span></span><span class=line><span class=cl>    url.path: /hello
</span></span><span class=line><span class=cl>    network.protocol.version: 1.1
</span></span><span class=line><span class=cl>    user_agent.original: curl/7.81.0
</span></span><span class=line><span class=cl>    http.route: /hello/<span class=o>{</span>name?<span class=o>}</span>
</span></span><span class=line><span class=cl>    http.response.status_code: <span class=m>200</span>
</span></span><span class=line><span class=cl>Resource associated with Activity:
</span></span><span class=line><span class=cl>    splunk.distro.version: 1.8.0
</span></span><span class=line><span class=cl>    telemetry.distro.name: splunk-otel-dotnet
</span></span><span class=line><span class=cl>    telemetry.distro.version: 1.8.0
</span></span><span class=line><span class=cl>    service.name: helloworld
</span></span><span class=line><span class=cl>    os.type: linux
</span></span><span class=line><span class=cl>    os.description: Ubuntu 22.04.5 LTS
</span></span><span class=line><span class=cl>    os.build_id: 6.8.0-1021-aws
</span></span><span class=line><span class=cl>    os.name: Ubuntu
</span></span><span class=line><span class=cl>    os.version: 22.04
</span></span><span class=line><span class=cl>    host.name: derek-1
</span></span><span class=line><span class=cl>    host.id: 20cf15fcc7054b468647b73b8f87c556
</span></span><span class=line><span class=cl>    process.owner: splunk
</span></span><span class=line><span class=cl>    process.pid: <span class=m>16997</span>
</span></span><span class=line><span class=cl>    process.runtime.description: .NET 8.0.11
</span></span><span class=line><span class=cl>    process.runtime.name: .NET
</span></span><span class=line><span class=cl>    process.runtime.version: 8.0.11
</span></span><span class=line><span class=cl>    container.id: <span class=m>2</span>
</span></span><span class=line><span class=cl>    telemetry.sdk.name: opentelemetry
</span></span><span class=line><span class=cl>    telemetry.sdk.language: dotnet
</span></span><span class=line><span class=cl>    telemetry.sdk.version: 1.9.0
</span></span><span class=line><span class=cl>    deployment.environment: otel-derek-1</span></span></code></pre></div><h2 id=splunk-observability-cloud-でのアプリケーションの確認>Splunk Observability Cloud でのアプリケーションの確認</h2><p>セットアップが完了したので、トレースが<strong>Splunk Observability Cloud</strong>に送信されていることを確認しましょう。アプリケーションが初回デプロイされた場合、データが表示されるまでに数分かかる場合があることに注意してください。</p><p>APM にナビゲートし、Environment ドロップダウンを使用してあなたの環境（つまり<code>otel-instancename</code>）を選択します。</p><p>すべてが正しくデプロイされている場合、サービスのリストに<code>helloworld</code>が表示されるはずです：</p><p><a href=#R-image-ec055fd2911cbaff6a2c7873244bdf65 class=lightbox-link><img alt="APM Overview" class="lazy lightbox figure-image" loading=lazy src=../images/apm_overview.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ec055fd2911cbaff6a2c7873244bdf65><img alt="APM Overview" class="lazy lightbox lightbox-image" loading=lazy src=../images/apm_overview.png></a></p><p>右側の<strong>Service Map</strong>をクリックしてサービスマップを表示します。</p><p><a href=#R-image-99b84429f75583261676dc75a2b1ea78 class=lightbox-link><img alt="Service Map" class="lazy lightbox figure-image" loading=lazy src=../images/service_map.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-99b84429f75583261676dc75a2b1ea78><img alt="Service Map" class="lazy lightbox lightbox-image" loading=lazy src=../images/service_map.png></a></p><p>次に、右側の<strong>Traces</strong>をクリックして、このアプリケーションでキャプチャされたトレースを確認します。</p><p><a href=#R-image-3387aa870012d6694346ba82c38fcea6 class=lightbox-link><img alt=Traces class="lazy lightbox figure-image" loading=lazy src=../images/traces.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-3387aa870012d6694346ba82c38fcea6><img alt=Traces class="lazy lightbox lightbox-image" loading=lazy src=../images/traces.png></a></p><p>個別のトレースは以下のように表示されるはずです：</p><p><a href=#R-image-afb13bc014eb8578d9389a45d53e5b46 class=lightbox-link><img alt=Traces class="lazy lightbox figure-image" loading=lazy src=../images/trace.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-afb13bc014eb8578d9389a45d53e5b46><img alt=Traces class="lazy lightbox lightbox-image" loading=lazy src=../images/trace.png></a></p><blockquote><p>次のステップに進む前に、Ctrl + C を押して Helloworld アプリを終了してください。</p></blockquote><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/06/17</span></span></footer></article><article class=default><header class=headline></header><h1 id=アプリケーションのdocker化>アプリケーションのDocker化</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>15 minutes</span>
</span>&nbsp;<p>このワークショップの後半では、.NET アプリケーションを Kubernetes クラスターにデプロイします。</p><p>しかし、どのようにそれを行うのでしょうか？</p><p>最初のステップは、アプリケーション用の Docker イメージを作成することです。これは
アプリケーションの「Docker 化」として知られており、プロセスは<code>Dockerfile</code>の作成から始まります。</p><p>しかし、まず重要な用語を定義しましょう。</p><h2 id=重要な用語>重要な用語</h2><h3 id=docker-とは何ですか>Docker とは何ですか？</h3><blockquote><p>「Docker は、コンテナと呼ばれる緩い分離環境でアプリケーションをパッケージ化して実行する機能を提供します。分離とセキュリティにより、指定されたホスト上で同時に多くのコンテナを実行できます。コンテナは軽量で、アプリケーションの実行に必要なすべてを含んでいるため、ホストにインストールされているものに依存する必要がありません。」</p></blockquote><p>ソース: <a href=https://docs.docker.com/get-started/docker-overview/ rel=external>https://docs.docker.com/get-started/docker-overview/</a></p><h3 id=コンテナとは何ですか>コンテナとは何ですか？</h3><blockquote><p>「コンテナは、アプリのコンポーネントごとの分離されたプロセスです。各コンポーネントは&mldr;独自の分離された環境で実行され、マシン上の他のすべてのものから完全に分離されています。」</p></blockquote><p>ソース: <a href=https://docs.docker.com/get-started/docker-concepts/the-basics/what-is-a-container/ rel=external>https://docs.docker.com/get-started/docker-concepts/the-basics/what-is-a-container/</a></p><h3 id=コンテナイメージとは何ですか>コンテナイメージとは何ですか？</h3><blockquote><p>「コンテナイメージは、コンテナを実行するためのすべてのファイル、バイナリ、ライブラリ、および設定を含む標準化されたパッケージです。」</p></blockquote><h3 id=dockerfile>Dockerfile</h3><blockquote><p>「Dockerfile は、コンテナイメージを作成するために使用されるテキストベースのドキュメントです。実行するコマンド、コピーするファイル、起動コマンドなどに関するイメージビルダーへの指示を提供します。」</p></blockquote><h2 id=dockerfile-の作成>Dockerfile の作成</h2><p><code>/home/splunk/workshop/docker-k8s-otel/helloworld</code>ディレクトリに<code>Dockerfile</code>という名前のファイルを作成しましょう。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /home/splunk/workshop/docker-k8s-otel/helloworld</span></span></code></pre></div><p>ファイルの作成には vi または nano を使用できます。vi を使用した例を示します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi Dockerfile</span></span></code></pre></div><p>新しく開いたファイルに以下の内容をコピー＆ペーストします：</p><blockquote><p>以下のテキストを貼り付ける前に、vi で「i」を押して挿入モードに入ってください。</p></blockquote><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> mcr.microsoft.com/dotnet/aspnet:8.0 AS base</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>USER</span><span class=s> app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>EXPOSE</span><span class=s> 8080</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> mcr.microsoft.com/dotnet/sdk:8.0 AS build</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>BUILD_CONFIGURATION</span><span class=o>=</span>Release
</span></span><span class=line><span class=cl><span class=k>WORKDIR</span><span class=s> /src</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> <span class=o>[</span><span class=s2>&#34;helloworld.csproj&#34;</span>, <span class=s2>&#34;helloworld/&#34;</span><span class=o>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet restore <span class=s2>&#34;./helloworld/./helloworld.csproj&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> &#34;/src/helloworld&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet build <span class=s2>&#34;./helloworld.csproj&#34;</span> -c <span class=nv>$BUILD_CONFIGURATION</span> -o /app/build<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> build AS publish</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>BUILD_CONFIGURATION</span><span class=o>=</span>Release
</span></span><span class=line><span class=cl><span class=k>RUN</span> dotnet publish <span class=s2>&#34;./helloworld.csproj&#34;</span> -c <span class=nv>$BUILD_CONFIGURATION</span> -o /app/publish /p:UseAppHost<span class=o>=</span>false<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> base AS final</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>publish /app/publish .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;dotnet&#34;</span><span class=p>,</span> <span class=s2>&#34;helloworld.dll&#34;</span><span class=p>]</span></span></span></code></pre></div><blockquote><p>vi での変更を保存するには、<code>esc</code>キーを押してコマンドモードに入り、<code>:wq!</code>と入力してから<code>enter/return</code>キーを押します。</p></blockquote><p>これはすべて何を意味するのでしょうか？詳しく見てみましょう。</p><h2 id=dockerfile-の詳細解説>Dockerfile の詳細解説</h2><p>この例では、マルチステージ Dockerfile を使用しており、Docker イメージ作成プロセスを以下のステージに分けています：</p><ul><li>Base（ベース）</li><li>Build（ビルド）</li><li>Publish（パブリッシュ）</li><li>Final（最終）</li></ul><p>マルチステージアプローチはより複雑ですが、デプロイメント用により
軽量なランタイムイメージを作成することができます。以下では、
これらの各ステージの目的を説明します。</p><h3 id=ベースステージ>ベースステージ</h3><p>ベースステージでは、アプリを実行するユーザー、作業ディレクトリを定義し、
アプリにアクセスするために使用されるポートを公開します。
これは Microsoft の<code>mcr.microsoft.com/dotnet/aspnet:8.0</code>イメージをベースにしています：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> mcr.microsoft.com/dotnet/aspnet:8.0 AS base</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>USER</span><span class=s> app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>EXPOSE</span><span class=s> 8080</span></span></span></code></pre></div><p>なお、<code>mcr.microsoft.com/dotnet/aspnet:8.0</code>イメージには.NET runtime のみが含まれており、
SDK は含まれていないため、比較的軽量です。これは Debian 12 Linux
distribution がベースになっています。ASP.NET Core Runtime Docker イメージの詳細については
<a href=https://github.com/dotnet/dotnet-docker/blob/main/README.aspnet.md rel=external>GitHub</a>で確認できます。</p><h3 id=build-ステージ>Build ステージ</h3><p>Dockerfile の次のステージは build ステージです。このステージでは、
<code>mcr.microsoft.com/dotnet/sdk:8.0</code>イメージが使用されます。これも Debian 12 がベースになっていますが、
runtime だけでなく完全な<a href=https://github.com/dotnet/dotnet-docker/blob/main/README.sdk.md rel=external>.NET SDK</a>が含まれています。</p><p>このステージでは<code>.csproj</code>ファイルを build イメージにコピーし、その後<code>dotnet restore</code>を使用して
アプリケーションが使用する依存関係をダウンロードします。</p><p>次に、アプリケーションコードを build イメージにコピーし、
<code>dotnet build</code>を使用してプロジェクトとその依存関係を
<code>.dll</code>バイナリのセットにビルドします：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> mcr.microsoft.com/dotnet/sdk:8.0 AS build</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>BUILD_CONFIGURATION</span><span class=o>=</span>Release
</span></span><span class=line><span class=cl><span class=k>WORKDIR</span><span class=s> /src</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> <span class=o>[</span><span class=s2>&#34;helloworld.csproj&#34;</span>, <span class=s2>&#34;helloworld/&#34;</span><span class=o>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet restore <span class=s2>&#34;./helloworld/./helloworld.csproj&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> &#34;/src/helloworld&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet build <span class=s2>&#34;./helloworld.csproj&#34;</span> -c <span class=nv>$BUILD_CONFIGURATION</span> -o /app/build</span></span></code></pre></div><h3 id=publish-ステージ>Publish ステージ</h3><p>3 番目のステージは publish で、これは Microsoft イメージではなく build ステージイメージをベースにしています。このステージでは、<code>dotnet publish</code>を使用して
アプリケーションとその依存関係を deployment 用にパッケージ化します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> build AS publish</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>BUILD_CONFIGURATION</span><span class=o>=</span>Release
</span></span><span class=line><span class=cl><span class=k>RUN</span> dotnet publish <span class=s2>&#34;./helloworld.csproj&#34;</span> -c <span class=nv>$BUILD_CONFIGURATION</span> -o /app/publish /p:UseAppHost<span class=o>=</span>false</span></span></code></pre></div><h3 id=final-ステージ>Final ステージ</h3><p>4 番目のステージは最終ステージで、これは base
ステージイメージをベースにしています（build と publish ステージよりも軽量）。publish ステージイメージからの出力をコピーし、
アプリケーションの entry point を定義します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> base AS final</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>publish /app/publish .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;dotnet&#34;</span><span class=p>,</span> <span class=s2>&#34;helloworld.dll&#34;</span><span class=p>]</span></span></span></code></pre></div><h2 id=docker-イメージのビルド>Docker イメージのビルド</h2><p><code>Dockerfile</code>ができたので、これを使用してアプリケーションを含む Docker イメージを
ビルドできます：</p><div class=tab-panel data-tab-group=R-tabs-fbb15c82ce6982b13cb647f9182a18a8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-2921a1865f47d4f20d3607b4807e5730 aria-expanded=true data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-fbb15c82ce6982b13cb647f9182a18a8","R-tab-f907e651164789346ae0a1e257c462d8")'>
<span class=tab-nav-text>Script</span>
</button>
<button aria-controls=R-tab-id-4fd24dcf3afc2f0b1db8c9023a753edb aria-expanded=false data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-fbb15c82ce6982b13cb647f9182a18a8","R-tab-4c50e65a8a1f9aa989870396b5c0a12b")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div id=R-tab-id-2921a1865f47d4f20d3607b4807e5730 data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker build -t helloworld:1.0 .</span></span></code></pre></div></div></div><div id=R-tab-id-4fd24dcf3afc2f0b1db8c9023a753edb data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>DEPRECATED: The legacy builder is deprecated and will be removed in a future release.
</span></span><span class=line><span class=cl>            Install the buildx component to build images with BuildKit:
</span></span><span class=line><span class=cl>            https://docs.docker.com/go/buildx/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Sending build context to Docker daemon  281.1kB
</span></span><span class=line><span class=cl>Step 1/19 : FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS base
</span></span><span class=line><span class=cl>8.0: Pulling from dotnet/aspnet
</span></span><span class=line><span class=cl>af302e5c37e9: Pull <span class=nb>complete</span>
</span></span><span class=line><span class=cl>91ab5e0aabf0: Pull <span class=nb>complete</span>
</span></span><span class=line><span class=cl>1c1e4530721e: Pull <span class=nb>complete</span>
</span></span><span class=line><span class=cl>1f39ca6dcc3a: Pull <span class=nb>complete</span>
</span></span><span class=line><span class=cl>ea20083aa801: Pull <span class=nb>complete</span>
</span></span><span class=line><span class=cl>64c242a4f561: Pull <span class=nb>complete</span>
</span></span><span class=line><span class=cl>Digest: sha256:587c1dd115e4d6707ff656d30ace5da9f49cec48e627a40bbe5d5b249adc3549
</span></span><span class=line><span class=cl>Status: Downloaded newer image <span class=k>for</span> mcr.microsoft.com/dotnet/aspnet:8.0
</span></span><span class=line><span class=cl> ---&gt; 0ee5d7ddbc3b
</span></span><span class=line><span class=cl>Step 2/19 : USER app
</span></span><span class=line><span class=cl>etc,</span></span></code></pre></div></div></div></div></div><p>これは、現在のディレクトリの<code>Dockerfile</code>を使用して<code>helloworld:1.0</code>のタグでイメージをビルドするよう Docker に指示します。</p><p>以下のコマンドで正常に作成されたことを確認できます：</p><div class=tab-panel data-tab-group=R-tabs-696bd68f45988a9c62a2b3bc2c61fb32><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-7ebb208713741ebb820b7c8471541377 aria-expanded=true data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-696bd68f45988a9c62a2b3bc2c61fb32","R-tab-f907e651164789346ae0a1e257c462d8")'>
<span class=tab-nav-text>Script</span>
</button>
<button aria-controls=R-tab-id-01eee1b005a92fd21c6ad7d15bad2319 aria-expanded=false data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-696bd68f45988a9c62a2b3bc2c61fb32","R-tab-4c50e65a8a1f9aa989870396b5c0a12b")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div id=R-tab-id-7ebb208713741ebb820b7c8471541377 data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker images</span></span></code></pre></div></div></div><div id=R-tab-id-01eee1b005a92fd21c6ad7d15bad2319 data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>REPOSITORY   TAG       IMAGE ID       CREATED          SIZE
</span></span><span class=line><span class=cl>helloworld   1.0       db19077b9445   <span class=m>20</span> seconds ago   217MB</span></span></code></pre></div></div></div></div></div><h2 id=docker-イメージのテスト>Docker イメージのテスト</h2><blockquote><p>続行する前に、以前に開始したアプリケーションがインスタンス上で実行されていないことを確認してください。</p></blockquote><p>Docker イメージを使用して以下のようにアプリケーションを実行できます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run --name helloworld <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--detach <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--expose <span class=m>8080</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--network<span class=o>=</span>host <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>helloworld:1.0</span></span></code></pre></div><blockquote><p>注意：<code>--network=host</code>パラメータを含めて、Docker コンテナが
インスタンス上のリソースにアクセスできるようにしています。これは後でアプリケーションが
localhost 上で実行されているコレクターにデータを送信する必要がある場合に重要です。</p></blockquote><p>Docker コンテナが実行されていることを確認しましょう：</p><div class=tab-panel data-tab-group=R-tabs-b6e44071c9625d71185e6951e0514c3d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-9362b7328cad43cc1f61da8225735469 aria-expanded=true data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-b6e44071c9625d71185e6951e0514c3d","R-tab-f907e651164789346ae0a1e257c462d8")'>
<span class=tab-nav-text>Script</span>
</button>
<button aria-controls=R-tab-id-7015d4d44936c76cde18cfb5517ab723 aria-expanded=false data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-b6e44071c9625d71185e6951e0514c3d","R-tab-4c50e65a8a1f9aa989870396b5c0a12b")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div id=R-tab-id-9362b7328cad43cc1f61da8225735469 data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker ps</span></span></code></pre></div></div></div><div id=R-tab-id-7015d4d44936c76cde18cfb5517ab723 data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ docker ps
</span></span><span class=line><span class=cl>CONTAINER ID   IMAGE            COMMAND                  CREATED       STATUS       PORTS     NAMES
</span></span><span class=line><span class=cl>5f5b9cd56ac5   helloworld:1.0   <span class=s2>&#34;dotnet helloworld.d…&#34;</span>   <span class=m>2</span> mins ago    Up <span class=m>2</span> mins              helloworld</span></span></code></pre></div></div></div></div></div><p>以前と同様にアプリケーションにアクセスできます：</p><div class=tab-panel data-tab-group=R-tabs-0ab9aaa1ea1ab43a890c299e960fc6e0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-a8430e6274d77bb29a5da324bb0f53c9 aria-expanded=true data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-0ab9aaa1ea1ab43a890c299e960fc6e0","R-tab-f907e651164789346ae0a1e257c462d8")'>
<span class=tab-nav-text>Script</span>
</button>
<button aria-controls=R-tab-id-f49559b2615d61f009d81ba086813ae7 aria-expanded=false data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-0ab9aaa1ea1ab43a890c299e960fc6e0","R-tab-4c50e65a8a1f9aa989870396b5c0a12b")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div id=R-tab-id-a8430e6274d77bb29a5da324bb0f53c9 data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://localhost:8080/hello/Docker</span></span></code></pre></div></div></div><div id=R-tab-id-f49559b2615d61f009d81ba086813ae7 data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Hello, Docker!</span></span></code></pre></div></div></div></div></div><p>おめでとうございます。ここまで到達したということは、.NET アプリケーションの Docker 化に成功したということです。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/06/17</span></span></footer></article><article class=default><header class=headline></header><h1 id=dockerfileに計装を追加する>Dockerfileに計装を追加する</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<p>アプリケーションを正常に Docker 化したので、次に OpenTelemetry による計装 を追加しましょう。</p><p>これは、Linux で実行しているアプリケーションを計装した際の手順と似ていますが、
注意すべきいくつかの重要な違いがあります。</p><h2 id=dockerfile-の更新>Dockerfile の更新</h2><p><code>/home/splunk/workshop/docker-k8s-otel/helloworld</code>ディレクトリの<code>Dockerfile</code>を更新しましょう。</p><p>Dockerfile で.NET アプリケーションがビルドされた後、以下の操作を行いたいと思います：</p><ul><li><code>splunk-otel-dotnet-install.sh</code>をダウンロードして実行するために必要な依存関係を追加する</li><li>Splunk OTel .NET インストーラーをダウンロードする</li><li>ディストリビューションをインストールする</li></ul><p>Dockerfile のビルドステージに以下を追加できます。vi で Dockerfile を開きましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi /home/splunk/workshop/docker-k8s-otel/helloworld/Dockerfile</span></span></code></pre></div><blockquote><p>vi では「i」キーを押して編集モードに入ります
&lsquo;NEW CODE&rsquo;とマークされている行を Dockerfile のビルドステージセクションに貼り付けてください：</p></blockquote><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=c># CODE ALREADY IN YOUR DOCKERFILE:</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> mcr.microsoft.com/dotnet/sdk:8.0 AS build</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>BUILD_CONFIGURATION</span><span class=o>=</span>Release
</span></span><span class=line><span class=cl><span class=k>WORKDIR</span><span class=s> /src</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> <span class=o>[</span><span class=s2>&#34;helloworld.csproj&#34;</span>, <span class=s2>&#34;helloworld/&#34;</span><span class=o>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet restore <span class=s2>&#34;./helloworld/./helloworld.csproj&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> &#34;/src/helloworld&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet build <span class=s2>&#34;./helloworld.csproj&#34;</span> -c <span class=nv>$BUILD_CONFIGURATION</span> -o /app/build<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: add dependencies for splunk-otel-dotnet-install.sh</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apt-get update <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> apt-get install -y unzip<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: download Splunk OTel .NET installer</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> curl -sSfL https://github.com/signalfx/splunk-otel-dotnet/releases/latest/download/splunk-otel-dotnet-install.sh -O<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: install the distribution</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> sh ./splunk-otel-dotnet-install.sh</span></span></code></pre></div><p>次に、以下の変更で Dockerfile の最終ステージを更新します：</p><ul><li>ビルドイメージから最終イメージに/root/.splunk-otel-dotnet/をコピーする</li><li>entrypoint.sh ファイルもコピーする</li><li><code>OTEL_SERVICE_NAME</code>と<code>OTEL_RESOURCE_ATTRIBUTES</code>環境変数を設定する</li><li><code>ENTRYPOINT</code>を<code>entrypoint.sh</code>に設定する</li></ul><p>最も簡単な方法は、最終ステージ全体を以下の内容で置き換えることです：</p><blockquote><p><strong>重要</strong> Dockerfile の<code>$INSTANCE</code>をあなたのインスタンス名に置き換えてください。
インスタンス名は<code>echo $INSTANCE</code>を実行することで確認できます。</p></blockquote><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=c># CODE ALREADY IN YOUR DOCKERFILE</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> base AS final</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: Copy instrumentation file tree</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> &#34;//home/app/.splunk-otel-dotnet&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>build /root/.splunk-otel-dotnet/ .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># CODE ALREADY IN YOUR DOCKERFILE</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>publish /app/publish .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: copy the entrypoint.sh script</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> entrypoint.sh .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: set OpenTelemetry environment variables</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> <span class=nv>OTEL_SERVICE_NAME</span><span class=o>=</span>helloworld
</span></span><span class=line><span class=cl><span class=k>ENV</span> <span class=nv>OTEL_RESOURCE_ATTRIBUTES</span><span class=o>=</span><span class=s1>&#39;deployment.environment=otel-$INSTANCE&#39;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: replace the prior ENTRYPOINT command with the following two lines</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;sh&#34;</span><span class=p>,</span> <span class=s2>&#34;entrypoint.sh&#34;</span><span class=p>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;dotnet&#34;</span><span class=p>,</span> <span class=s2>&#34;helloworld.dll&#34;</span><span class=p>]</span></span></span></code></pre></div><blockquote><p>vi での変更を保存するには、<code>esc</code>キーを押してコマンドモードに入り、<code>:wq!</code>と入力してから<code>enter/return</code>キーを押します。</p></blockquote><p>これらすべての変更の後、Dockerfile は以下のようになるはずです：</p><blockquote><p><strong>重要</strong> このコンテンツを自分の Dockerfile にコピー＆ペーストする場合は、
Dockerfile の<code>$INSTANCE</code>をあなたのインスタンス名に置き換えてください。
インスタンス名は<code>echo $INSTANCE</code>を実行することで確認できます。</p></blockquote><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> mcr.microsoft.com/dotnet/aspnet:8.0 AS base</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>USER</span><span class=s> app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>EXPOSE</span><span class=s> 8080</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> mcr.microsoft.com/dotnet/sdk:8.0 AS build</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>BUILD_CONFIGURATION</span><span class=o>=</span>Release
</span></span><span class=line><span class=cl><span class=k>WORKDIR</span><span class=s> /src</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> <span class=o>[</span><span class=s2>&#34;helloworld.csproj&#34;</span>, <span class=s2>&#34;helloworld/&#34;</span><span class=o>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet restore <span class=s2>&#34;./helloworld/./helloworld.csproj&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> &#34;/src/helloworld&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dotnet build <span class=s2>&#34;./helloworld.csproj&#34;</span> -c <span class=nv>$BUILD_CONFIGURATION</span> -o /app/build<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: add dependencies for splunk-otel-dotnet-install.sh</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apt-get update <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> apt-get install -y unzip<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: download Splunk OTel .NET installer</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> curl -sSfL https://github.com/signalfx/splunk-otel-dotnet/releases/latest/download/splunk-otel-dotnet-install.sh -O<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: install the distribution</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> sh ./splunk-otel-dotnet-install.sh<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> build AS publish</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>BUILD_CONFIGURATION</span><span class=o>=</span>Release
</span></span><span class=line><span class=cl><span class=k>RUN</span> dotnet publish <span class=s2>&#34;./helloworld.csproj&#34;</span> -c <span class=nv>$BUILD_CONFIGURATION</span> -o /app/publish /p:UseAppHost<span class=o>=</span>false<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> base AS final</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: Copy instrumentation file tree</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> &#34;//home/app/.splunk-otel-dotnet&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>build /root/.splunk-otel-dotnet/ .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>publish /app/publish .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: copy the entrypoint.sh script</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> entrypoint.sh .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: set OpenTelemetry environment variables</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> <span class=nv>OTEL_SERVICE_NAME</span><span class=o>=</span>helloworld
</span></span><span class=line><span class=cl><span class=k>ENV</span> <span class=nv>OTEL_RESOURCE_ATTRIBUTES</span><span class=o>=</span><span class=s1>&#39;deployment.environment=otel-$INSTANCE&#39;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># NEW CODE: replace the prior ENTRYPOINT command with the following two lines</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;sh&#34;</span><span class=p>,</span> <span class=s2>&#34;entrypoint.sh&#34;</span><span class=p>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;dotnet&#34;</span><span class=p>,</span> <span class=s2>&#34;helloworld.dll&#34;</span><span class=p>]</span></span></span></code></pre></div><h2 id=entrypointsh-ファイルの作成>entrypoint.sh ファイルの作成</h2><p>また、<code>/home/splunk/workshop/docker-k8s-otel/helloworld</code>フォルダに<code>entrypoint.sh</code>という名前のファイルを
以下の内容で作成する必要があります：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi /home/splunk/workshop/docker-k8s-otel/helloworld/entrypoint.sh</span></span></code></pre></div><p>次に、新しく作成したファイルに以下のコードを貼り付けます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># Read in the file of environment settings</span>
</span></span><span class=line><span class=cl>. /<span class=nv>$HOME</span>/.splunk-otel-dotnet/instrument.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Then run the CMD</span>
</span></span><span class=line><span class=cl><span class=nb>exec</span> <span class=s2>&#34;</span><span class=nv>$@</span><span class=s2>&#34;</span></span></span></code></pre></div><blockquote><p>vi での変更を保存するには、<code>esc</code>キーを押してコマンドモードに入り、<code>:wq!</code>と入力してから<code>enter/return</code>キーを押します。</p></blockquote><p><code>entrypoint.sh</code>スクリプトは、計装に含まれる instrument.sh スクリプトが環境変数を<strong>コンテナ起動時に</strong>取得するために必要です。これにより、各プラットフォームに対して環境変数が正しく設定されることが保証されます。</p><blockquote><p>「なぜ Linux ホスト上で OpenTelemetry .NET instrumentation を有効化したときのように、
Dockerfile に以下のコマンドを含めるだけではだめなのか？」と疑問に思うかもしれません。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>RUN</span> . <span class=nv>$HOME</span>/.splunk-otel-dotnet/instrument.sh</span></span></code></pre></div><p>この方法の問題点は、各 Dockerfile RUN ステップが新しいコンテナと新しいシェルで実行されることです。
あるシェルで環境変数を設定しようとしても、後で見ることはできません。
この問題は、ここで行ったようにエントリポイントスクリプトを使用することで解決されます。
この問題についての詳細は、こちらの<a href=https://stackoverflow.com/questions/55921914/how-to-source-a-script-with-environment-variables-in-a-docker-build-process rel=external>Stack Overflow の投稿</a>を参照してください。</p></blockquote><h2 id=docker-イメージのビルド>Docker イメージのビルド</h2><p>OpenTelemetry .NET instrumentation を含む新しい Docker イメージをビルドしましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker build -t helloworld:1.1 .</span></span></code></pre></div><blockquote><p>注：以前のバージョンと区別するために、異なるバージョン（1.1）を使用しています。
古いバージョンをクリーンアップするには、以下のコマンドでコンテナ ID を取得します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker ps -a</span></span></code></pre></div><p>次に、以下のコマンドでコンテナを削除します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker rm &lt;old container id&gt; --force</span></span></code></pre></div><p>次にコンテナイメージ ID を取得します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker images <span class=p>|</span> grep 1.0</span></span></code></pre></div><p>最後に、以下のコマンドで古いイメージを削除できます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker image rm &lt;old image id&gt;</span></span></code></pre></div></blockquote><h2 id=アプリケーションの実行>アプリケーションの実行</h2><p>新しい Docker イメージを実行しましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run --name helloworld <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--detach <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--expose <span class=m>8080</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--network<span class=o>=</span>host <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>helloworld:1.1</span></span></code></pre></div><p>以下を使用してアプリケーションにアクセスできます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://localhost:8080/hello</span></span></code></pre></div><p>トラフィックを生成するために上記のコマンドを数回実行しましょう。</p><p>1 分ほど経過したら、Splunk Observability Cloud に新しいトレースが表示されることを確認します。</p><blockquote><p>あなたの特定の環境でトレースを探すことを忘れないでください。</p></blockquote><h2 id=トラブルシューティング>トラブルシューティング</h2><p>Splunk Observability Cloud にトレースが表示されない場合は、以下のようにトラブルシューティングを行うことができます。</p><p>まず、コレクター設定ファイルを編集用に開きます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo vi /etc/otel/collector/agent_config.yaml</span></span></code></pre></div><p>次に、トレースパイプラインにデバッグエクスポーターを追加します。これにより、トレースがコレクターログに書き込まれるようになります：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>extensions</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>health_check, http_forwarder, zpages, smartagent]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>jaeger, otlp, zipkin]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#- resource/add_environment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># NEW CODE: デバッグエクスポーターをここに追加</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>otlphttp, signalfx, debug]</span></span></span></code></pre></div><p>その後、コレクターを再起動して設定変更を適用します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl restart splunk-otel-collector</span></span></code></pre></div><p><code>journalctl</code>を使用してコレクターログを表示できます：</p><blockquote><p>ログの追跡を終了するには、Ctrl + C を押します。</p></blockquote><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo journalctl -u splunk-otel-collector -f -n <span class=m>100</span></span></span></code></pre></div><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/06/17</span></span></footer></article><article class=default><header class=headline></header><h1 id=k8sでopentelemetryコレクターをインストール>K8sでOpenTelemetryコレクターをインストール</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>15 minutes</span>
</span>&nbsp;<h2 id=ワークショップパート-1-の振り返り>ワークショップパート 1 の振り返り</h2><p>ワークショップのこの時点で、以下を正常に完了しました：</p><ul><li>Linux ホストに Splunk distribution of OpenTelemetry コレクターをデプロイ</li><li>Splunk Observability Cloud にトレースとメトリクスを送信するよう設定</li><li>.NET アプリケーションをデプロイし、OpenTelemetry で計装</li><li>.NET アプリケーションを Docker 化し、o11y cloud にトレースが流れることを確認</li></ul><p>上記のステップを<strong>完了していない</strong>場合は、ワークショップの残りの部分に進む前に以下のコマンドを実行してください：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cp /home/splunk/workshop/docker-k8s-otel/docker/Dockerfile /home/splunk/workshop/docker-k8s-otel/helloworld/
</span></span><span class=line><span class=cl>cp /home/splunk/workshop/docker-k8s-otel/docker/entrypoint.sh /home/splunk/workshop/docker-k8s-otel/helloworld/</span></span></code></pre></div><blockquote><p><strong>重要</strong> これらのファイルがコピーされたら、<code>/home/splunk/workshop/docker-k8s-otel/helloworld/Dockerfile</code> を
エディターで開き、Dockerfile の <code>$INSTANCE</code> をあなたのインスタンス名に置き換えてください。
インスタンス名は <code>echo $INSTANCE</code> を実行することで確認できます。</p></blockquote><h2 id=ワークショップパート-2-の紹介>ワークショップパート 2 の紹介</h2><p>ワークショップの次の部分では、Kubernetes でアプリケーションを実行したいと思います。
そのため、Kubernetes クラスターに Splunk distribution of OpenTelemetry コレクターを
デプロイする必要があります。</p><p>まず、いくつかの重要な用語を定義しましょう。</p><h3 id=重要な用語>重要な用語</h3><h4 id=kubernetes-とは何ですか>Kubernetes とは何ですか？</h4><p><em>「Kubernetes は、宣言的な設定と自動化の両方を促進する、コンテナ化されたワークロードとサービスを管理するためのポータブルで拡張可能なオープンソースプラットフォームです。」</em></p><p>Source: <a href=https://kubernetes.io/docs/concepts/overview/ rel=external>https://kubernetes.io/docs/concepts/overview/</a></p><p>Dockerfile に小さな修正を加えた後、アプリケーション用に以前ビルドした Docker イメージを
Kubernetes クラスターにデプロイします。</p><h4 id=helm-とは何ですか>Helm とは何ですか？</h4><p>Helm は Kubernetes 用のパッケージマネージャーです。</p><p><em>「最も複雑な Kubernetes アプリケーションだとしても、定義、インストール、アップグレード役立ちます」</em></p><h4 id=helm-を使用したコレクターのインストール>Helm を使用したコレクターのインストール</h4><p>プロダクト内ウィザードではなくコマンドラインを使用して、コレクターをインストールするための独自の
<code>helm</code>コマンドを作成しましょう。</p><p>まず、helm リポジトリを追加する必要があります：ます。」</p><p>Source: <a href=https://helm.sh/ rel=external>https://helm.sh/</a></p><p>Helm を使用して K8s クラスターに OpenTelemetry コレクターをデプロイします。</p><h4 id=helm-の利点>Helm の利点</h4><ul><li>複雑性の管理<ul><li>数十のマニフェストファイルではなく、単一の values.yaml ファイルを扱う</li></ul></li><li>簡単な更新<ul><li>インプレースアップグレード</li></ul></li><li>ロールバックサポート<ul><li>helm rollback を使用してリリースの古いバージョンにロールバック</li></ul></li></ul><h2 id=ホストコレクターのアンインストール>ホストコレクターのアンインストール</h2><p>先に進む前に、Linux ホストに先ほどインストールしたコレクターを削除しましょう：
\</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -sSL https://dl.signalfx.com/splunk-otel-collector.sh &gt; /tmp/splunk-otel-collector.sh<span class=p>;</span>
</span></span><span class=line><span class=cl>sudo sh /tmp/splunk-otel-collector.sh --uninstall</span></span></code></pre></div><h2 id=helm-を利用して-collector-をインストールする>Helm を利用して Collector をインストールする</h2><p>ウィザードの代わりに、コマンドラインを利用して collector をインストールします。</p><p>まず初めに、Helm リポジトリに登録する必要があります</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm repo add splunk-otel-collector-chart https://signalfx.github.io/splunk-otel-collector-chart</span></span></code></pre></div><p>リポジトリが最新であることを確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm repo update</span></span></code></pre></div><p>helm チャートのデプロイメントを設定するために、<code>/home/splunk</code>ディレクトリに<code>values.yaml</code>という名前の新しいファイルを作成しましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># swith to the /home/splunk dir</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> /home/splunk
</span></span><span class=line><span class=cl><span class=c1># create a values.yaml file in vi</span>
</span></span><span class=line><span class=cl>vi values.yaml</span></span></code></pre></div><blockquote><p>Press ‘i’ to enter into insert mode in vi before pasting the text below.　&ldquo;i"を押下すると vi はインサートモードになります。ペースト前に押下してください</p></blockquote><p>そして、下記のコードをコピーしてください</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>logsEngine</span><span class=p>:</span><span class=w> </span><span class=l>otel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>agent</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hostmetrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>collection_interval</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>root_path</span><span class=p>:</span><span class=w> </span><span class=l>/hostfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>scrapers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>disk</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>filesystem</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>exclude_mount_points</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>match_type</span><span class=p>:</span><span class=w> </span><span class=l>regexp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>mount_points</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>/var/*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>/snap/*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>/boot/*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>/boot</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>/opt/orbstack/*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>/mnt/machines/*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>/Users/*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>load</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>network</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>paging</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>processes</span><span class=p>:</span><span class=w> </span><span class=kc>null</span></span></span></code></pre></div><blockquote><p>vi での変更を保存するには、<code>esc</code>キーを押してコマンドモードに入り、<code>:wq!</code>と入力してから<code>enter/return</code>キーを押します。</p></blockquote><p>次のコマンドを使用してコレクターをインストールできます：</p><div class=tab-panel data-tab-group=R-tabs-87c05e571bf00d7cc4ab868675a7b7e1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-0d731341be6727ed0e84f48d2b09a97a aria-expanded=true data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-87c05e571bf00d7cc4ab868675a7b7e1","R-tab-f907e651164789346ae0a1e257c462d8")'>
<span class=tab-nav-text>Script</span>
</button>
<button aria-controls=R-tab-id-2103bf52850cd0c1ed3e2b6a160c839b aria-expanded=false data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-87c05e571bf00d7cc4ab868675a7b7e1","R-tab-4c50e65a8a1f9aa989870396b5c0a12b")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div id=R-tab-id-0d731341be6727ed0e84f48d2b09a97a data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>  helm install splunk-otel-collector --version 0.136.0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkObservability.realm=</span><span class=nv>$REALM</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkObservability.accessToken=</span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;clusterName=</span><span class=nv>$INSTANCE</span><span class=s2>-cluster&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;environment=otel-</span><span class=nv>$INSTANCE</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.token=</span><span class=nv>$HEC_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.endpoint=</span><span class=nv>$HEC_URL</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.index=splunk4rookies-workshop&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -f values.yaml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  splunk-otel-collector-chart/splunk-otel-collector</span></span></code></pre></div></div></div><div id=R-tab-id-2103bf52850cd0c1ed3e2b6a160c839b data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>NAME: splunk-otel-collector
</span></span><span class=line><span class=cl>LAST DEPLOYED: Fri Dec <span class=m>20</span> 01:01:43 <span class=m>2024</span>
</span></span><span class=line><span class=cl>NAMESPACE: default
</span></span><span class=line><span class=cl>STATUS: deployed
</span></span><span class=line><span class=cl>REVISION: <span class=m>1</span>
</span></span><span class=line><span class=cl>TEST SUITE: None
</span></span><span class=line><span class=cl>NOTES:
</span></span><span class=line><span class=cl>Splunk OpenTelemetry Collector is installed and configured to send data to Splunk Observability realm us1.</span></span></code></pre></div></div></div></div></div><h2 id=コレクターが実行中であることを確認>コレクターが実行中であることを確認</h2><p>以下のコマンドでコレクターが実行されているかどうかを確認できます：</p><div class=tab-panel data-tab-group=R-tabs-065f6c89e65094c5801be22ba954d2dd><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-84a6453f361b27c2abf2985c1256da51 aria-expanded=true data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-065f6c89e65094c5801be22ba954d2dd","R-tab-f907e651164789346ae0a1e257c462d8")'>
<span class=tab-nav-text>Script</span>
</button>
<button aria-controls=R-tab-id-4f4cc2c609bdf9abd7bbac0388f91f9b aria-expanded=false data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-065f6c89e65094c5801be22ba954d2dd","R-tab-4c50e65a8a1f9aa989870396b5c0a12b")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div id=R-tab-id-84a6453f361b27c2abf2985c1256da51 data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pods</span></span></code></pre></div></div></div><div id=R-tab-id-4f4cc2c609bdf9abd7bbac0388f91f9b data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>NAME                                                         READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>splunk-otel-collector-agent-8xvk8                            1/1     Running   <span class=m>0</span>          49s
</span></span><span class=line><span class=cl>splunk-otel-collector-k8s-cluster-receiver-d54857c89-tx7qr   1/1     Running   <span class=m>0</span>          49s</span></span></code></pre></div></div></div></div></div><h2 id=o11y-cloud-で-k8s-クラスターを確認>O11y Cloud で K8s クラスターを確認</h2><p>Splunk Observability Cloud で、<strong>Infrastructure</strong> -> <strong>Kubernetes</strong> -> <strong>Kubernetes Clusters</strong>にナビゲートし、
クラスター名（<code>$INSTANCE-cluster</code>）を検索します：</p><p><a href=#R-image-fee52e7d53772486929977d53c41d061 class=lightbox-link><img alt="Kubernetes node" class="lazy lightbox figure-image" loading=lazy src=../images/k8snode.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-fee52e7d53772486929977d53c41d061><img alt="Kubernetes node" class="lazy lightbox lightbox-image" loading=lazy src=../images/k8snode.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/09/08</span></span></footer></article><article class=default><header class=headline></header><h1 id=アプリケーションをk8sにデプロイ>アプリケーションをK8sにデプロイ</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>15 minutes</span>
</span>&nbsp;<h2 id=dockerfile-の更新>Dockerfile の更新</h2><p>Kubernetes では、環境変数は通常、Docker イメージに組み込むのではなく<code>.yaml</code>マニフェストファイルで管理されます。そこで、Dockerfile から以下の 2 つの環境変数を削除しましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi /home/splunk/workshop/docker-k8s-otel/helloworld/Dockerfile</span></span></code></pre></div><p>次に、以下の 2 つの環境変数を削除します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>ENV</span> <span class=nv>OTEL_SERVICE_NAME</span><span class=o>=</span>helloworld
</span></span><span class=line><span class=cl><span class=k>ENV</span> <span class=nv>OTEL_RESOURCE_ATTRIBUTES</span><span class=o>=</span><span class=s1>&#39;deployment.environment=otel-$INSTANCE&#39;</span></span></span></code></pre></div><blockquote><p>vi での変更を保存するには、<code>esc</code>キーを押してコマンドモードに入り、<code>:wq!</code>と入力してから<code>enter/return</code>キーを押します。</p></blockquote><h2 id=新しい-docker-イメージのビルド>新しい Docker イメージのビルド</h2><p>環境変数を除外した新しい Docker イメージをビルドしましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /home/splunk/workshop/docker-k8s-otel/helloworld
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>docker build -t helloworld:1.2 .</span></span></code></pre></div><blockquote><p>Note: we&rsquo;ve used a different version (1.2) to distinguish the image from our earlier version.
To clean up the older versions, run the following command to get the container id:</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker ps -a</span></span></code></pre></div><p>Then run the following command to delete the container:</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker rm &lt;old container id&gt; --force</span></span></code></pre></div><p>Now we can get the container image id:</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker images <span class=p>|</span> grep 1.1</span></span></code></pre></div><p>Finally, we can run the following command to delete the old image:</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker image rm &lt;old image id&gt;</span></span></code></pre></div></blockquote><h2 id=docker-イメージを-kubernetes-にインポート>Docker イメージを Kubernetes にインポート</h2><p>通常であれば、Docker イメージを Docker Hub などのリポジトリにプッシュします。
しかし、今回のセッションでは、k3s に直接インポートする回避策を使用します。</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /home/splunk
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Import the image into k3d</span>
</span></span><span class=line><span class=cl>sudo k3d image import helloworld:1.2 --cluster <span class=nv>$INSTANCE</span>-cluster</span></span></code></pre></div><h2 id=net-アプリケーションのデプロイ>.NET アプリケーションのデプロイ</h2><blockquote><p>ヒント：vi で編集モードに入るには「i」キーを押します。変更を保存するには、<code>esc</code>キーを押してコマンドモードに入り、<code>:wq!</code>と入力してから<code>enter/return</code>キーを押します。</p></blockquote><p>.NET アプリケーションを K8s にデプロイするために、<code>/home/splunk</code>に<code>deployment.yaml</code>という名前のファイルを作成しましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi /home/splunk/deployment.yaml</span></span></code></pre></div><p>そして以下を貼り付けます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/library/helloworld:1.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>PORT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;8080&#34;</span></span></span></code></pre></div><details class="box cstyle notices tip expand"><summary class=box-label><i class="expander-icon fa-fw fas fa-chevron-right"></i>
<i class="fa-fw fas fa-lightbulb"></i>
Kubernetes における Deployment とは？</summary><div class=box-content><p>deployment.yaml ファイルは、deployment リソースを定義するために使用される kubernetes 設定ファイルです。このファイルは Kubernetes でアプリケーションを管理するための基盤となります！deployment 設定は deployment の <strong><em>望ましい状態</em></strong> を定義し、Kubernetes が <strong><em>実際の状態</em></strong> がそれと一致するよう保証します。これにより、アプリケーション pod の自己修復が可能になり、アプリケーションの簡単な更新やロールバックも可能になります。</p></div></details><p>次に、同じディレクトリに<code>service.yaml</code>という名前の 2 つ目のファイルを作成します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi /home/splunk/service.yaml</span></span></code></pre></div><p>そして以下を貼り付けます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span></span></span></code></pre></div><details class="box cstyle notices tip expand"><summary class=box-label><i class="expander-icon fa-fw fas fa-chevron-right"></i>
<i class="fa-fw fas fa-lightbulb"></i>
Kubernetes における Service とは？</summary><div class=box-content><p>Kubernetes の Service は抽象化レイヤーであり、仲介者のような役割を果たします。Pod にアクセスするための固定 IP アドレスや DNS 名を提供し、時間の経過とともに Pod が追加、削除、または交換されても同じままです。</p></div></details><p>これらのマニフェストファイルを使用してアプリケーションをデプロイできます：</p><div class=tab-panel data-tab-group=R-tabs-a43db78916c3a6c518f1b91923415205><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-86bfda41fa814cb7804f473f1b46a7f2 aria-expanded=true data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-a43db78916c3a6c518f1b91923415205","R-tab-f907e651164789346ae0a1e257c462d8")'>
<span class=tab-nav-text>Script</span>
</button>
<button aria-controls=R-tab-id-37fd1bde453420f2379a8721a5b86544 aria-expanded=false data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-a43db78916c3a6c518f1b91923415205","R-tab-4c50e65a8a1f9aa989870396b5c0a12b")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div id=R-tab-id-86bfda41fa814cb7804f473f1b46a7f2 data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># create the deployment</span>
</span></span><span class=line><span class=cl>kubectl apply -f deployment.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># create the service</span>
</span></span><span class=line><span class=cl>kubectl apply -f service.yaml</span></span></code></pre></div></div></div><div id=R-tab-id-37fd1bde453420f2379a8721a5b86544 data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>deployment.apps/helloworld created
</span></span><span class=line><span class=cl>service/helloworld created</span></span></code></pre></div></div></div></div></div><h2 id=アプリケーションのテスト>アプリケーションのテスト</h2><p>アプリケーションにアクセスするには、まず IP アドレスを取得する必要があります：</p><div class=tab-panel data-tab-group=R-tabs-13ee530b1c9eb1816ce9a4142a6ca889><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-0d8861c5abbb0e414397623dfe7de584 aria-expanded=true data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-13ee530b1c9eb1816ce9a4142a6ca889","R-tab-f907e651164789346ae0a1e257c462d8")'>
<span class=tab-nav-text>Script</span>
</button>
<button aria-controls=R-tab-id-2b84c53bf36a5a29658d978a90eb2c75 aria-expanded=false data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-13ee530b1c9eb1816ce9a4142a6ca889","R-tab-4c50e65a8a1f9aa989870396b5c0a12b")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div id=R-tab-id-0d8861c5abbb0e414397623dfe7de584 data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe svc helloworld <span class=p>|</span> grep IP:</span></span></code></pre></div></div></div><div id=R-tab-id-2b84c53bf36a5a29658d978a90eb2c75 data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>IP:                10.43.102.103</span></span></code></pre></div></div></div></div></div><p>その後、前のコマンドから返された Cluster IP を使用してアプリケーションにアクセスできます。
例：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://10.43.102.103:8080/hello/Kubernetes</span></span></code></pre></div><h2 id=opentelemetry-の設定>OpenTelemetry の設定</h2><p>.NET OpenTelemetry 計装はすでに Docker イメージに組み込まれています。しかし、データの送信先を指定するためにいくつかの環境変数を設定する必要があります。</p><p>先ほど作成した<code>deployment.yaml</code>ファイルに以下を追加します：</p><blockquote><p><strong>重要</strong> 以下の YAML の<code>$INSTANCE</code>をあなたのインスタンス名に置き換えてください。
インスタンス名は<code>echo $INSTANCE</code>を実行することで確認できます。</p></blockquote><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>PORT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;8080&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>NODE_IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>status.hostIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_EXPORTER_OTLP_ENDPOINT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;http://$(NODE_IP):4318&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_SERVICE_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;helloworld&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_RESOURCE_ATTRIBUTES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;deployment.environment=otel-$INSTANCE&#34;</span></span></span></code></pre></div><p>完全な<code>deployment.yaml</code>ファイルは以下のようになります（<code>$INSTANCE</code>ではなく<strong>あなたの</strong>インスタンス名を使用してください）：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/library/helloworld:1.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>PORT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;8080&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>NODE_IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>status.hostIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_EXPORTER_OTLP_ENDPOINT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;http://$(NODE_IP):4318&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_SERVICE_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;helloworld&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_RESOURCE_ATTRIBUTES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;deployment.environment=otel-$INSTANCE&#34;</span></span></span></code></pre></div><p>以下のコマンドで変更を適用します：</p><div class=tab-panel data-tab-group=R-tabs-bd9fb42124fffeb3fc048e6ce8ad0513><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-2df3d4ef39a8d61e5396e550f011d577 aria-expanded=true data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-bd9fb42124fffeb3fc048e6ce8ad0513","R-tab-f907e651164789346ae0a1e257c462d8")'>
<span class=tab-nav-text>Script</span>
</button>
<button aria-controls=R-tab-id-5b109c4b7c42bbd6737c75e548f52f78 aria-expanded=false data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-bd9fb42124fffeb3fc048e6ce8ad0513","R-tab-4c50e65a8a1f9aa989870396b5c0a12b")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div id=R-tab-id-2df3d4ef39a8d61e5396e550f011d577 data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f deployment.yaml</span></span></code></pre></div></div></div><div id=R-tab-id-5b109c4b7c42bbd6737c75e548f52f78 data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>deployment.apps/helloworld configured</span></span></code></pre></div></div></div></div></div><p>その後、<code>curl</code>を使用してトラフィックを生成します。</p><p>1 分ほど経過すると、o11y cloud でトレースが流れているのが確認できるはずです。ただし、より早くトレースを確認したい場合は、以下の方法があります&mldr;</p><h2 id=チャレンジ>チャレンジ</h2><p>開発者として、トレース ID を素早く取得するか、コンソールフィードバックを見たい場合、deployment.yaml ファイルにどのような環境変数を追加できるでしょうか？</p><details><summary><b>答えを見るにはここをクリック</b></summary><p>セクション 4「.NET Application を OpenTelemetry で計装する」のチャレンジで思い出していただければ、<code>OTEL_TRACES_EXPORTER</code>環境変数を使って trace を console に書き込むトリックをお見せしました。この変数を deployment.yaml に追加し、アプリケーションを再 deploy して、helloworld アプリから log を tail することで、trace id を取得して Splunk Observability Cloud で trace を見つけることができます。（ワークショップの次のセクションでは、debug exporter の使用についても説明します。これは K8s 環境でアプリケーションを debug する際の典型的な方法です。）</p><p>まず、vi で deployment.yaml ファイルを開きます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vi deployment.yaml</span></span></code></pre></div><p>次に、<code>OTEL_TRACES_EXPORTER</code>環境変数を追加します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>PORT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;8080&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>NODE_IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>status.hostIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_EXPORTER_OTLP_ENDPOINT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;http://$(NODE_IP):4318&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_SERVICE_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;helloworld&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_RESOURCE_ATTRIBUTES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;deployment.environment=YOURINSTANCE&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># NEW VALUE HERE:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_TRACES_EXPORTER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;otlp,console&#34;</span></span></span></code></pre></div><p>変更を保存してからアプリケーションを再 deploy します：</p><div class=tab-panel data-tab-group=R-tabs-0402eab808a10d8814dc822c6ba91567><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-b34fbf67bed0ab5bf648088cb42a1897 aria-expanded=true data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-0402eab808a10d8814dc822c6ba91567","R-tab-f907e651164789346ae0a1e257c462d8")'>
<span class=tab-nav-text>Script</span>
</button>
<button aria-controls=R-tab-id-76def43d69b162d05d9f1a9674214101 aria-expanded=false data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-0402eab808a10d8814dc822c6ba91567","R-tab-4c50e65a8a1f9aa989870396b5c0a12b")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div id=R-tab-id-b34fbf67bed0ab5bf648088cb42a1897 data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f deployment.yaml</span></span></code></pre></div></div></div><div id=R-tab-id-76def43d69b162d05d9f1a9674214101 data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>deployment.apps/helloworld configured</span></span></code></pre></div></div></div></div></div><p>helloworld の log を tail します：</p><div class=tab-panel data-tab-group=R-tabs-b63b67de348ea7cc4e988847d7368a31><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-b41884afba60ee820e23176d9dba938b aria-expanded=true data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-b63b67de348ea7cc4e988847d7368a31","R-tab-f907e651164789346ae0a1e257c462d8")'>
<span class=tab-nav-text>Script</span>
</button>
<button aria-controls=R-tab-id-1cc509f95c78bc9cb2123c037ccb72d5 aria-expanded=false data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-b63b67de348ea7cc4e988847d7368a31","R-tab-4c50e65a8a1f9aa989870396b5c0a12b")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div id=R-tab-id-b41884afba60ee820e23176d9dba938b data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl logs -l <span class=nv>app</span><span class=o>=</span>helloworld -f</span></span></code></pre></div></div></div><div id=R-tab-id-1cc509f95c78bc9cb2123c037ccb72d5 data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>info: HelloWorldController<span class=o>[</span>0<span class=o>]</span>
</span></span><span class=line><span class=cl>      /hello endpoint invoked by K8s9
</span></span><span class=line><span class=cl>Activity.TraceId:            5bceb747cc7b79a77cfbde285f0f09cb
</span></span><span class=line><span class=cl>Activity.SpanId:             ac67afe500e7ad12
</span></span><span class=line><span class=cl>Activity.TraceFlags:         Recorded
</span></span><span class=line><span class=cl>Activity.ActivitySourceName: Microsoft.AspNetCore
</span></span><span class=line><span class=cl>Activity.DisplayName:        GET hello/<span class=o>{</span>name?<span class=o>}</span>
</span></span><span class=line><span class=cl>Activity.Kind:               Server
</span></span><span class=line><span class=cl>Activity.StartTime:          2025-02-04T15:22:48.2381736Z
</span></span><span class=line><span class=cl>Activity.Duration:           00:00:00.0027334
</span></span><span class=line><span class=cl>Activity.Tags:
</span></span><span class=line><span class=cl>    server.address: 10.43.226.224
</span></span><span class=line><span class=cl>    server.port: <span class=m>8080</span>
</span></span><span class=line><span class=cl>    http.request.method: GET
</span></span><span class=line><span class=cl>    url.scheme: http
</span></span><span class=line><span class=cl>    url.path: /hello/K8s9
</span></span><span class=line><span class=cl>    network.protocol.version: 1.1
</span></span><span class=line><span class=cl>    user_agent.original: curl/7.81.0
</span></span><span class=line><span class=cl>    http.route: hello/<span class=o>{</span>name?<span class=o>}</span>
</span></span><span class=line><span class=cl>    http.response.status_code: <span class=m>200</span>
</span></span><span class=line><span class=cl>Resource associated with Activity:
</span></span><span class=line><span class=cl>    splunk.distro.version: 1.8.0
</span></span><span class=line><span class=cl>    telemetry.distro.name: splunk-otel-dotnet
</span></span><span class=line><span class=cl>    telemetry.distro.version: 1.8.0
</span></span><span class=line><span class=cl>    os.type: linux
</span></span><span class=line><span class=cl>    os.description: Debian GNU/Linux <span class=m>12</span> <span class=o>(</span>bookworm<span class=o>)</span>
</span></span><span class=line><span class=cl>    os.build_id: 6.2.0-1018-aws
</span></span><span class=line><span class=cl>    os.name: Debian GNU/Linux
</span></span><span class=line><span class=cl>    os.version: <span class=m>12</span>
</span></span><span class=line><span class=cl>    host.name: helloworld-69f5c7988b-dxkwh
</span></span><span class=line><span class=cl>    process.owner: app
</span></span><span class=line><span class=cl>    process.pid: <span class=m>1</span>
</span></span><span class=line><span class=cl>    process.runtime.description: .NET 8.0.12
</span></span><span class=line><span class=cl>    process.runtime.name: .NET
</span></span><span class=line><span class=cl>    process.runtime.version: 8.0.12
</span></span><span class=line><span class=cl>    container.id: 39c2061d7605d8c390b4fe5f8054719f2fe91391a5c32df5684605202ca39ae9
</span></span><span class=line><span class=cl>    telemetry.sdk.name: opentelemetry
</span></span><span class=line><span class=cl>    telemetry.sdk.language: dotnet
</span></span><span class=line><span class=cl>    telemetry.sdk.version: 1.9.0
</span></span><span class=line><span class=cl>    service.name: helloworld
</span></span><span class=line><span class=cl>    deployment.environment: otel-jen-tko-1b75</span></span></code></pre></div></div></div></div></div><p>次に、別の terminal window で curl コマンドを使って trace を生成します。log を tail している console で trace id が表示されるはずです。<code>Activity.TraceId:</code>の値をコピーして、APM の Trace 検索フィールドに貼り付けてください。</p></details><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/10/27</span></span></footer></article><article class=default><header class=headline></header><h1 id=opentelemetryコレクター設定のカスタマイズ>OpenTelemetryコレクター設定のカスタマイズ</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>20 minutes</span>
</span>&nbsp;<p>デフォルト設定を使用して K8s クラスターに Splunk Distribution of OpenTelemetry コレクターを
デプロイしました。このセクションでは、コレクター設定をカスタマイズする方法をいくつかの例で
説明します。</p><h2 id=コレクター設定の取得>コレクター設定の取得</h2><p>コレクター設定をカスタマイズする前に、現在の設定がどのようになっているかを
どのように確認するのでしょうか？</p><p>Kubernetes 環境では、コレクター設定は Config Map を使用して保存されます。</p><p>以下のコマンドで、クラスターに存在する config map を確認できます：</p><div class=tab-panel data-tab-group=R-tabs-406645ca713994e73255ba9c7ecc66c0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-bf61bb2cf82eeadaf8c1586a057a0fee aria-expanded=true data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-406645ca713994e73255ba9c7ecc66c0","R-tab-f907e651164789346ae0a1e257c462d8")'>
<span class=tab-nav-text>Script</span>
</button>
<button aria-controls=R-tab-id-a6a95b8d020ef2614cebcf4aa78bdbb2 aria-expanded=false data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-406645ca713994e73255ba9c7ecc66c0","R-tab-4c50e65a8a1f9aa989870396b5c0a12b")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div id=R-tab-id-bf61bb2cf82eeadaf8c1586a057a0fee data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get cm -l <span class=nv>app</span><span class=o>=</span>splunk-otel-collector</span></span></code></pre></div></div></div><div id=R-tab-id-a6a95b8d020ef2614cebcf4aa78bdbb2 data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>NAME                                                 DATA   AGE
</span></span><span class=line><span class=cl>splunk-otel-collector-otel-k8s-cluster-receiver   <span class=m>1</span>      3h37m
</span></span><span class=line><span class=cl>splunk-otel-collector-otel-agent                  <span class=m>1</span>      3h37m</span></span></code></pre></div></div></div></div></div><blockquote><p>なぜ 2 つの config map があるのでしょうか？</p></blockquote><p>次に、以下のようにコレクターエージェントの config map を表示できます：</p><div class=tab-panel data-tab-group=R-tabs-5369d5f2e8d68a483b072808654fd64a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-0ac65d6b42cb411e7134b7feb467d6b7 aria-expanded=true data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-5369d5f2e8d68a483b072808654fd64a","R-tab-f907e651164789346ae0a1e257c462d8")'>
<span class=tab-nav-text>Script</span>
</button>
<button aria-controls=R-tab-id-62be8339ecffce429b06ca09404f9290 aria-expanded=false data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-5369d5f2e8d68a483b072808654fd64a","R-tab-4c50e65a8a1f9aa989870396b5c0a12b")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div id=R-tab-id-0ac65d6b42cb411e7134b7feb467d6b7 data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe cm splunk-otel-collector-otel-agent</span></span></code></pre></div></div></div><div id=R-tab-id-62be8339ecffce429b06ca09404f9290 data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Name:         splunk-otel-collector-otel-agent
</span></span><span class=line><span class=cl>Namespace:    default
</span></span><span class=line><span class=cl>Labels:       <span class=nv>app</span><span class=o>=</span>splunk-otel-collector
</span></span><span class=line><span class=cl>              app.kubernetes.io/instance<span class=o>=</span>splunk-otel-collector
</span></span><span class=line><span class=cl>              app.kubernetes.io/managed-by<span class=o>=</span>Helm
</span></span><span class=line><span class=cl>              app.kubernetes.io/name<span class=o>=</span>splunk-otel-collector
</span></span><span class=line><span class=cl>              app.kubernetes.io/version<span class=o>=</span>0.113.0
</span></span><span class=line><span class=cl>              <span class=nv>chart</span><span class=o>=</span>splunk-otel-collector-0.113.0
</span></span><span class=line><span class=cl>              helm.sh/chart<span class=o>=</span>splunk-otel-collector-0.113.0
</span></span><span class=line><span class=cl>              <span class=nv>heritage</span><span class=o>=</span>Helm
</span></span><span class=line><span class=cl>              <span class=nv>release</span><span class=o>=</span>splunk-otel-collector
</span></span><span class=line><span class=cl>Annotations:  meta.helm.sh/release-name: splunk-otel-collector
</span></span><span class=line><span class=cl>              meta.helm.sh/release-namespace: default
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>Data</span>
</span></span><span class=line><span class=cl><span class=o>====</span>
</span></span><span class=line><span class=cl>relay:
</span></span><span class=line><span class=cl>----
</span></span><span class=line><span class=cl>exporters:
</span></span><span class=line><span class=cl>  otlphttp:
</span></span><span class=line><span class=cl>    headers:
</span></span><span class=line><span class=cl>      X-SF-Token: <span class=si>${</span><span class=nv>SPLUNK_OBSERVABILITY_ACCESS_TOKEN</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    metrics_endpoint: https://ingest.us1.signalfx.com/v2/datapoint/otlp
</span></span><span class=line><span class=cl>    traces_endpoint: https://ingest.us1.signalfx.com/v2/trace/otlp
</span></span><span class=line><span class=cl>    <span class=o>(</span>followed by the rest of the collector config in yaml format<span class=o>)</span></span></span></code></pre></div></div></div></div></div><h2 id=k8s-でコレクター設定を更新する方法>K8s でコレクター設定を更新する方法</h2><p>Linux インスタンスでコレクターを実行した以前の例では、コレクター設定は
<code>/etc/otel/collector/agent_config.yaml</code>ファイルで利用可能でした。その場合にコレクター設定を
変更する必要があれば、単純にこのファイルを編集し、変更を保存してから
コレクターを再起動すればよかったのです。</p><p>K8s では、少し異なる動作をします。<code>agent_config.yaml</code>を直接変更する代わりに、
helm チャートをデプロイするために使用される<code>values.yaml</code>ファイルを変更することで
コレクター設定をカスタマイズします。</p><p><a href=https://github.com/signalfx/splunk-otel-collector-chart/blob/main/helm-charts/splunk-otel-collector/values.yaml rel=external>GitHub</a>の values.yaml ファイルには、
利用可能なカスタマイズオプションが記載されています。</p><p>例を見てみましょう。</p><h2 id=infrastructure-events-monitoring-の追加>Infrastructure Events Monitoring の追加</h2><p>最初の例として、K8s クラスターの infrastructure events monitoring を有効にしましょう。</p><blockquote><p>これにより、charts の Events Feed セクションの一部として Kubernetes イベントを確認できるようになります。
cluster receiver は、kubernetes-events
monitor を使用して Smart Agent receiver で設定され、custom イベントを送信します。詳細については<a href=https://docs.splunk.com/observability/en/gdi/opentelemetry/collector-kubernetes/kubernetes-config-logs.html#collect-kubernetes-events rel=external>Collect Kubernetes events</a>を参照してください。</p></blockquote><p>これは<code>values.yaml</code>ファイルに以下の行を追加することで実行されます：</p><blockquote><p>ヒント：vi での開き方と保存方法は前のステップにあります。</p></blockquote><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>logsEngine</span><span class=p>:</span><span class=w> </span><span class=l>otel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>splunkObservability</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>infrastructureMonitoringEventsEnabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>agent:</span></span></span></code></pre></div><p>ファイルが保存されたら、以下のコマンドで変更を適用できます：</p><div class=tab-panel data-tab-group=R-tabs-d49cb0fe6fcfe4185992df492d3facc9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-662c7fb2f44bc8a47eeca949cb8f1dc8 aria-expanded=true data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-d49cb0fe6fcfe4185992df492d3facc9","R-tab-f907e651164789346ae0a1e257c462d8")'>
<span class=tab-nav-text>Script</span>
</button>
<button aria-controls=R-tab-id-4acfab75467f17e7e075b1a7bf3b5464 aria-expanded=false data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-d49cb0fe6fcfe4185992df492d3facc9","R-tab-4c50e65a8a1f9aa989870396b5c0a12b")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div id=R-tab-id-662c7fb2f44bc8a47eeca949cb8f1dc8 data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm upgrade splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkObservability.realm=</span><span class=nv>$REALM</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkObservability.accessToken=</span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;clusterName=</span><span class=nv>$INSTANCE</span><span class=s2>-cluster&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;environment=otel-</span><span class=nv>$INSTANCE</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.token=</span><span class=nv>$HEC_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.endpoint=</span><span class=nv>$HEC_URL</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.index=splunk4rookies-workshop&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -f values.yaml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>splunk-otel-collector-chart/splunk-otel-collector</span></span></code></pre></div></div></div><div id=R-tab-id-4acfab75467f17e7e075b1a7bf3b5464 data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Release <span class=s2>&#34;splunk-otel-collector&#34;</span> has been upgraded. Happy Helming!
</span></span><span class=line><span class=cl>NAME: splunk-otel-collector
</span></span><span class=line><span class=cl>LAST DEPLOYED: Fri Dec <span class=m>20</span> 01:17:03 <span class=m>2024</span>
</span></span><span class=line><span class=cl>NAMESPACE: default
</span></span><span class=line><span class=cl>STATUS: deployed
</span></span><span class=line><span class=cl>REVISION: <span class=m>2</span>
</span></span><span class=line><span class=cl>TEST SUITE: None
</span></span><span class=line><span class=cl>NOTES:
</span></span><span class=line><span class=cl>Splunk OpenTelemetry Collector is installed and configured to send data to Splunk Observability realm us1.</span></span></code></pre></div></div></div></div></div><p>その後、config map を表示して変更が適用されたことを確認できます：</p><div class=tab-panel data-tab-group=R-tabs-c9e03f33f7bcb152849c68d0f861caf8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-048250ebd294bf4f10d9a4e8e8b98949 aria-expanded=true data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-c9e03f33f7bcb152849c68d0f861caf8","R-tab-f907e651164789346ae0a1e257c462d8")'>
<span class=tab-nav-text>Script</span>
</button>
<button aria-controls=R-tab-id-dfdc57fdaaa61d5b3ce30bc0f71d4e15 aria-expanded=false data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-c9e03f33f7bcb152849c68d0f861caf8","R-tab-4c50e65a8a1f9aa989870396b5c0a12b")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div id=R-tab-id-048250ebd294bf4f10d9a4e8e8b98949 data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe cm splunk-otel-collector-otel-k8s-cluster-receiver</span></span></code></pre></div></div></div><div id=R-tab-id-dfdc57fdaaa61d5b3ce30bc0f71d4e15 data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><p><code>smartagent/kubernetes-events</code>が agent config に含まれていることを確認してください：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>  smartagent/kubernetes-events:
</span></span><span class=line><span class=cl>    alwaysClusterReporter: <span class=nb>true</span>
</span></span><span class=line><span class=cl>    type: kubernetes-events
</span></span><span class=line><span class=cl>    whitelistedEvents:
</span></span><span class=line><span class=cl>    - involvedObjectKind: Pod
</span></span><span class=line><span class=cl>      reason: Created
</span></span><span class=line><span class=cl>    - involvedObjectKind: Pod
</span></span><span class=line><span class=cl>      reason: Unhealthy
</span></span><span class=line><span class=cl>    - involvedObjectKind: Pod
</span></span><span class=line><span class=cl>      reason: Failed
</span></span><span class=line><span class=cl>    - involvedObjectKind: Job
</span></span><span class=line><span class=cl>      reason: FailedCreate</span></span></code></pre></div></div></div></div></div><blockquote><p>これらの特定の変更が適用されるのは
cluster receiver config map なので、そちらを指定していることに注意してください。</p></blockquote><h2 id=debug-exporter-の追加>Debug Exporter の追加</h2><p>collector に送信される trace と log を確認して、
Splunk に送信する前に検査したいとします。この目的のために debug exporter を使用できます。これは
OpenTelemetry 関連の問題のトラブルシューティングに役立ちます。</p><p>values.yaml ファイルの下部に以下のように debug exporter を追加しましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>logsEngine</span><span class=p>:</span><span class=w> </span><span class=l>otel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>splunkObservability</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>infrastructureMonitoringEventsEnabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>agent</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>verbosity</span><span class=p>:</span><span class=w> </span><span class=l>detailed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>debug</span></span></span></code></pre></div><p>ファイルが保存されたら、以下のコマンドで変更を適用できます：</p><div class=tab-panel data-tab-group=R-tabs-36cd4f2ad2924aa630e46d419b5f2c0f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-058c7f162a601bc9551d8452bd1b1618 aria-expanded=true data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-36cd4f2ad2924aa630e46d419b5f2c0f","R-tab-f907e651164789346ae0a1e257c462d8")'>
<span class=tab-nav-text>Script</span>
</button>
<button aria-controls=R-tab-id-ed6bc7e08a36253e8f42daa0f80e8d7c aria-expanded=false data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-36cd4f2ad2924aa630e46d419b5f2c0f","R-tab-4c50e65a8a1f9aa989870396b5c0a12b")'>
<span class=tab-nav-text>Example Output</span></button></div><div class=tab-content-container><div id=R-tab-id-058c7f162a601bc9551d8452bd1b1618 data-tab-item=R-tab-f907e651164789346ae0a1e257c462d8 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm upgrade splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkObservability.realm=</span><span class=nv>$REALM</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkObservability.accessToken=</span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;clusterName=</span><span class=nv>$INSTANCE</span><span class=s2>-cluster&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;environment=otel-</span><span class=nv>$INSTANCE</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.token=</span><span class=nv>$HEC_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.endpoint=</span><span class=nv>$HEC_URL</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.index=splunk4rookies-workshop&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -f values.yaml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>splunk-otel-collector-chart/splunk-otel-collector</span></span></code></pre></div></div></div><div id=R-tab-id-ed6bc7e08a36253e8f42daa0f80e8d7c data-tab-item=R-tab-4c50e65a8a1f9aa989870396b5c0a12b class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Release <span class=s2>&#34;splunk-otel-collector&#34;</span> has been upgraded. Happy Helming!
</span></span><span class=line><span class=cl>NAME: splunk-otel-collector
</span></span><span class=line><span class=cl>LAST DEPLOYED: Fri Dec <span class=m>20</span> 01:32:03 <span class=m>2024</span>
</span></span><span class=line><span class=cl>NAMESPACE: default
</span></span><span class=line><span class=cl>STATUS: deployed
</span></span><span class=line><span class=cl>REVISION: <span class=m>3</span>
</span></span><span class=line><span class=cl>TEST SUITE: None
</span></span><span class=line><span class=cl>NOTES:
</span></span><span class=line><span class=cl>Splunk OpenTelemetry Collector is installed and configured to send data to Splunk Observability realm us1.</span></span></code></pre></div></div></div></div></div><p>curl を使用してアプリケーションを数回実行してから、以下のコマンドで agent collector の log を tail します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl logs -l <span class=nv>component</span><span class=o>=</span>otel-collector-agent -f</span></span></code></pre></div><p>以下のような trace が agent collector の log に書き込まれているのが確認できるはずです：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code>2024-12-20T01:43:52.929Z info Traces {&#34;kind&#34;: &#34;exporter&#34;, &#34;data_type&#34;: &#34;traces&#34;, &#34;name&#34;: &#34;debug&#34;, &#34;resource spans&#34;: 1, &#34;spans&#34;: 2}
2024-12-20T01:43:52.929Z info ResourceSpans #0
Resource SchemaURL: https://opentelemetry.io/schemas/1.6.1
Resource attributes:
     -&gt; splunk.distro.version: Str(1.8.0)
     -&gt; telemetry.distro.name: Str(splunk-otel-dotnet)
     -&gt; telemetry.distro.version: Str(1.8.0)
     -&gt; os.type: Str(linux)
     -&gt; os.description: Str(Debian GNU/Linux 12 (bookworm))
     -&gt; os.build_id: Str(6.8.0-1021-aws)
     -&gt; os.name: Str(Debian GNU/Linux)
     -&gt; os.version: Str(12)
     -&gt; host.name: Str(derek-1)
     -&gt; process.owner: Str(app)
     -&gt; process.pid: Int(1)
     -&gt; process.runtime.description: Str(.NET 8.0.11)
     -&gt; process.runtime.name: Str(.NET)
     -&gt; process.runtime.version: Str(8.0.11)
     -&gt; container.id: Str(78b452a43bbaa3354a3cb474010efd6ae2367165a1356f4b4000be031b10c5aa)
     -&gt; telemetry.sdk.name: Str(opentelemetry)
     -&gt; telemetry.sdk.language: Str(dotnet)
     -&gt; telemetry.sdk.version: Str(1.9.0)
     -&gt; service.name: Str(helloworld)
     -&gt; deployment.environment: Str(otel-derek-1)
     -&gt; k8s.pod.ip: Str(10.42.0.15)
     -&gt; k8s.pod.labels.app: Str(helloworld)
     -&gt; k8s.pod.name: Str(helloworld-84865965d9-nkqsx)
     -&gt; k8s.namespace.name: Str(default)
     -&gt; k8s.pod.uid: Str(38d39bc6-1309-4022-a569-8acceef50942)
     -&gt; k8s.node.name: Str(derek-1)
     -&gt; k8s.cluster.name: Str(derek-1-cluster)</code></pre></div><p>そして以下のような log エントリも確認できます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code>2024-12-20T01:43:53.215Z info Logs {&#34;kind&#34;: &#34;exporter&#34;, &#34;data_type&#34;: &#34;logs&#34;, &#34;name&#34;: &#34;debug&#34;, &#34;resource logs&#34;: 1, &#34;log records&#34;: 2}
2024-12-20T01:43:53.215Z info ResourceLog #0
Resource SchemaURL: https://opentelemetry.io/schemas/1.6.1
Resource attributes:
     -&gt; splunk.distro.version: Str(1.8.0)
     -&gt; telemetry.distro.name: Str(splunk-otel-dotnet)
     -&gt; telemetry.distro.version: Str(1.8.0)
     -&gt; os.type: Str(linux)
     -&gt; os.description: Str(Debian GNU/Linux 12 (bookworm))
     -&gt; os.build_id: Str(6.8.0-1021-aws)
     -&gt; os.name: Str(Debian GNU/Linux)
     -&gt; os.version: Str(12)
     -&gt; host.name: Str(derek-1)
     -&gt; process.owner: Str(app)
     -&gt; process.pid: Int(1)
     -&gt; process.runtime.description: Str(.NET 8.0.11)
     -&gt; process.runtime.name: Str(.NET)
     -&gt; process.runtime.version: Str(8.0.11)
     -&gt; container.id: Str(78b452a43bbaa3354a3cb474010efd6ae2367165a1356f4b4000be031b10c5aa)
     -&gt; telemetry.sdk.name: Str(opentelemetry)
     -&gt; telemetry.sdk.language: Str(dotnet)
     -&gt; telemetry.sdk.version: Str(1.9.0)
     -&gt; service.name: Str(helloworld)
     -&gt; deployment.environment: Str(otel-derek-1)
     -&gt; k8s.node.name: Str(derek-1)
     -&gt; k8s.cluster.name: Str(derek-1-cluster)</code></pre></div><p>ただし、Splunk Observability Cloud に戻ると、アプリケーションから trace と log が
もはやそこに送信されていないことに気づくでしょう。</p><p>なぜそうなったと思いますか？次のセクションで詳しく説明します。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/06/17</span></span></footer></article><article class=default><header class=headline></header><h1 id=troubleshoot-opentelemetry-collector-issues>Troubleshoot OpenTelemetry Collector Issues</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>20 minutes</span>
</span>&nbsp;<p>前のセクションでは、debug エクスポーターをコレクターの設定に追加し、
トレースとログのパイプラインの一部にしました。期待通りに、debug 出力が
エージェントコレクターのログに書き込まれているのが確認できます。</p><p>しかし、トレースが o11y cloud に送信されなくなっています。なぜなのかを把握して修正しましょう。</p><h2 id=コレクター設定を確認する>コレクター設定を確認する</h2><p><code>values.yaml</code>ファイルを通じてコレクター設定が変更された場合は、
config map を確認してコレクターに実際に適用された設定を確認することが役立ちます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe cm splunk-otel-collector-otel-agent</span></span></code></pre></div><p>エージェントコレクター設定のログとトレースのパイプラインを確認しましょう。次のようになっているはずです：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>k8sattributes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>filter/logs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/logs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_environment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>filelog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>fluentforward</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>memory_limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>k8sattributes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>batch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resourcedetection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>resource/add_environment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>otlp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>jaeger</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>smartagent/signalfx-forwarder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>zipkin</span></span></span></code></pre></div><p>問題がわかりますか？debug エクスポーターのみがトレースとログのパイプラインに含まれています。
以前のトレースパイプライン設定にあった<code>otlphttp</code>と<code>signalfx</code>エクスポーターがなくなっています。
これが、もう o11y cloud でトレースが見えなくなった理由です。ログパイプラインについても、<code>splunk_hec/platform_logs</code>
エクスポーターが削除されています。</p><blockquote><p>どのような特定のエクスポーターが以前含まれていたかをどのように知ったか？それを見つけるには、
以前のカスタマイズを元に戻してから、config map を確認して
トレースパイプラインに元々何が含まれていたかを見ることもできました。あるいは、
<a href=https://github.com/signalfx/splunk-otel-collector-chart/blob/main/examples/default/rendered_manifests/configmap-agent.yaml rel=external>splunk-otel-collector-chart の GitHub リポジトリ</a>
の例を参照することもでき、これにより Helm チャートで使用されるデフォルトのエージェント設定が分かります。</p></blockquote><h2 id=これらのエクスポーターはどのように削除されたのか>これらのエクスポーターはどのように削除されたのか？</h2><p><code>values.yaml</code>ファイルに追加したカスタマイズを確認しましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>logsEngine</span><span class=p>:</span><span class=w> </span><span class=l>otel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>splunkObservability</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>infrastructureMonitoringEventsEnabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>agent</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>verbosity</span><span class=p>:</span><span class=w> </span><span class=l>detailed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>debug</span></span></span></code></pre></div><p><code>helm upgrade</code>を使ってコレクターに<code>values.yaml</code>ファイルを適用したとき、
カスタム設定は以前のコレクター設定とマージされました。
これが発生すると、リストを含む<code>yaml</code>設定のセクション、
例えばパイプラインセクションのエクスポーターのリストは、<code>values.yaml</code>ファイルに
含めたもの（debug エクスポーターのみ）で置き換えられます。</p><h2 id=問題を修正しましょう>問題を修正しましょう</h2><p>既存のパイプラインをカスタマイズする場合、設定のその部分を完全に再定義する必要があります。
したがって、<code>values.yaml</code>ファイルを次のように更新する必要があります：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>logsEngine</span><span class=p>:</span><span class=w> </span><span class=l>otel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>splunkObservability</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>infrastructureMonitoringEventsEnabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>agent</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>verbosity</span><span class=p>:</span><span class=w> </span><span class=l>detailed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>pipelines</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>traces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>otlphttp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>signalfx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>splunk_hec/platform_logs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>debug</span></span></span></code></pre></div><p>変更を適用しましょう：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm upgrade splunk-otel-collector <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkObservability.realm=</span><span class=nv>$REALM</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkObservability.accessToken=</span><span class=nv>$ACCESS_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;clusterName=</span><span class=nv>$INSTANCE</span><span class=s2>-cluster&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;environment=otel-</span><span class=nv>$INSTANCE</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.token=</span><span class=nv>$HEC_TOKEN</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.endpoint=</span><span class=nv>$HEC_URL</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set<span class=o>=</span><span class=s2>&#34;splunkPlatform.index=splunk4rookies-workshop&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -f values.yaml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>splunk-otel-collector-chart/splunk-otel-collector</span></span></code></pre></div><p>それからエージェント config map を確認します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe cm splunk-otel-collector-otel-agent</span></span></code></pre></div><p>今度は、ログとトレースの両方について完全に定義されたエクスポーターパイプラインが表示されるはずです：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>  pipelines:
</span></span><span class=line><span class=cl>    logs:
</span></span><span class=line><span class=cl>      exporters:
</span></span><span class=line><span class=cl>      - splunk_hec/platform_logs
</span></span><span class=line><span class=cl>      - debug
</span></span><span class=line><span class=cl>      processors:
</span></span><span class=line><span class=cl>      ...
</span></span><span class=line><span class=cl>    traces:
</span></span><span class=line><span class=cl>      exporters:
</span></span><span class=line><span class=cl>      - otlphttp
</span></span><span class=line><span class=cl>      - signalfx
</span></span><span class=line><span class=cl>      - debug
</span></span><span class=line><span class=cl>      processors:
</span></span><span class=line><span class=cl>      ...</span></span></code></pre></div><h2 id=ログ出力の確認>ログ出力の確認</h2><p><strong>Splunk Distribution of OpenTelemetry .NET</strong>は、ログに使用するアプリケーション
（サンプルアプリでも使用している）から、トレースコンテキストで強化されたログを自動的にエクスポートします。</p><p>アプリケーションログはトレースメタデータで強化され、その後
OpenTelemetry Collector のローカルインスタンスに OTLP 形式でエクスポートされます。</p><p>debug エクスポーターによってキャプチャされたログを詳しく見て、それが発生しているかを確認しましょう。
コレクターログを tail するには、次のコマンドを使用できます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl logs -l <span class=nv>component</span><span class=o>=</span>otel-collector-agent -f</span></span></code></pre></div><p>ログを tail したら、curl を使ってさらにトラフィックを生成できます。そうすると
次のようなものが表示されるはずです：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0><code>2024-12-20T21:56:30.858Z info Logs {&#34;kind&#34;: &#34;exporter&#34;, &#34;data_type&#34;: &#34;logs&#34;, &#34;name&#34;: &#34;debug&#34;, &#34;resource logs&#34;: 1, &#34;log records&#34;: 1}
2024-12-20T21:56:30.858Z info ResourceLog #0
Resource SchemaURL: https://opentelemetry.io/schemas/1.6.1
Resource attributes:
     -&gt; splunk.distro.version: Str(1.8.0)
     -&gt; telemetry.distro.name: Str(splunk-otel-dotnet)
     -&gt; telemetry.distro.version: Str(1.8.0)
     -&gt; os.type: Str(linux)
     -&gt; os.description: Str(Debian GNU/Linux 12 (bookworm))
     -&gt; os.build_id: Str(6.8.0-1021-aws)
     -&gt; os.name: Str(Debian GNU/Linux)
     -&gt; os.version: Str(12)
     -&gt; host.name: Str(derek-1)
     -&gt; process.owner: Str(app)
     -&gt; process.pid: Int(1)
     -&gt; process.runtime.description: Str(.NET 8.0.11)
     -&gt; process.runtime.name: Str(.NET)
     -&gt; process.runtime.version: Str(8.0.11)
     -&gt; container.id: Str(5bee5b8f56f4b29f230ffdd183d0367c050872fefd9049822c1ab2aa662ba242)
     -&gt; telemetry.sdk.name: Str(opentelemetry)
     -&gt; telemetry.sdk.language: Str(dotnet)
     -&gt; telemetry.sdk.version: Str(1.9.0)
     -&gt; service.name: Str(helloworld)
     -&gt; deployment.environment: Str(otel-derek-1)
     -&gt; k8s.node.name: Str(derek-1)
     -&gt; k8s.cluster.name: Str(derek-1-cluster)
ScopeLogs #0
ScopeLogs SchemaURL:
InstrumentationScope HelloWorldController
LogRecord #0
ObservedTimestamp: 2024-12-20 21:56:28.486804 +0000 UTC
Timestamp: 2024-12-20 21:56:28.486804 +0000 UTC
SeverityText: Information
SeverityNumber: Info(9)
Body: Str(/hello endpoint invoked by {name})
Attributes:
     -&gt; name: Str(Kubernetes)
Trace ID: 78db97a12b942c0252d7438d6b045447
Span ID: 5e9158aa42f96db3
Flags: 1
 {&#34;kind&#34;: &#34;exporter&#34;, &#34;data_type&#34;: &#34;logs&#34;, &#34;name&#34;: &#34;debug&#34;}</code></pre></div><p>この例では、Trace ID と Span ID が
OpenTelemetry .NET 計装によってログ出力に自動的に書き込まれていることがわかります。これにより、
Splunk Observability Cloud でログとトレースを関連付けることができます。</p><p>ただし、Helm を使って K8s クラスターに OpenTelemetry collector をデプロイし、
ログ収集オプションを含める場合、OpenTelemetry collector は File Log receiver を使用して
コンテナーログを自動的にキャプチャすることを覚えておいてください。</p><p>これにより、アプリケーションの重複ログがキャプチャされることになります。例えば、次のスクリーンショットでは
サービスへの各リクエストに対して 2 つのログエントリーが表示されています：</p><p><a href=#R-image-9ec4d966977326b4382050bc6746d94b class=lightbox-link><img alt="Duplicate Log Entries" class="lazy lightbox figure-image" loading=lazy src=../images/duplicate_logs.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-9ec4d966977326b4382050bc6746d94b><img alt="Duplicate Log Entries" class="lazy lightbox lightbox-image" loading=lazy src=../images/duplicate_logs.png></a></p><p>これをどのように回避しますか？</p><h2 id=k8s-での重複ログの回避>K8s での重複ログの回避</h2><p>重複ログをキャプチャしないようにするには、<code>OTEL_LOGS_EXPORTER</code>環境変数を<code>none</code>に設定して、
Splunk Distribution of OpenTelemetry .NET が OTLP を使用してコレクターにログをエクスポートしないようにできます。
これは、<code>deployment.yaml</code>ファイルに<code>OTEL_LOGS_EXPORTER</code>環境変数を追加することで実行できます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>PORT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;8080&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>NODE_IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>status.hostIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_EXPORTER_OTLP_ENDPOINT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;http://$(NODE_IP):4318&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_SERVICE_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;helloworld&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_RESOURCE_ATTRIBUTES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;deployment.environment=otel-$INSTANCE&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OTEL_LOGS_EXPORTER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;none&#34;</span></span></span></code></pre></div><p>それから次を実行します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># update the deployment</span>
</span></span><span class=line><span class=cl>kubectl apply -f deployment.yaml</span></span></code></pre></div><p><code>OTEL_LOGS_EXPORTER</code>環境変数を<code>none</code>に設定するのは簡単です。しかし、Trace ID と
Span ID はアプリケーションによって生成された stdout ログに書き込まれないため、
ログとトレースを関連付けることができなくなります。</p><p>これを解決するには、
<code>/home/splunk/workshop/docker-k8s-otel/helloworld/SplunkTelemetryConfigurator.cs</code>で定義されている例のような、カスタムロガーを定義する必要があります。</p><p>次のように<code>Program.cs</code>ファイルを更新することで、これをアプリケーションに含めることができます：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>using</span> <span class=nn>SplunkTelemetry</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>Microsoft.Extensions.Logging.Console</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>builder</span> <span class=p>=</span> <span class=n>WebApplication</span><span class=p>.</span><span class=n>CreateBuilder</span><span class=p>(</span><span class=n>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>builder</span><span class=p>.</span><span class=n>Services</span><span class=p>.</span><span class=n>AddControllers</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>SplunkTelemetryConfigurator</span><span class=p>.</span><span class=n>ConfigureLogger</span><span class=p>(</span><span class=n>builder</span><span class=p>.</span><span class=n>Logging</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>app</span> <span class=p>=</span> <span class=n>builder</span><span class=p>.</span><span class=n>Build</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=p>.</span><span class=n>MapControllers</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=p>.</span><span class=n>Run</span><span class=p>();</span></span></span></code></pre></div><p>その後、カスタムログ設定を含む新しい Docker イメージをビルドします：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /home/splunk/workshop/docker-k8s-otel/helloworld
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>docker build -t helloworld:1.3 .</span></span></code></pre></div><p>それから更新されたイメージを Kubernetes にインポートします：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /home/splunk
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Import the image into k3d</span>
</span></span><span class=line><span class=cl>sudo k3d image import helloworld:1.3 --cluster <span class=nv>$INSTANCE</span>-cluster</span></span></code></pre></div><p>最後に、<code>deployment.yaml</code>ファイルを更新してコンテナーイメージの 1.3 バージョンを使用する必要があります：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>helloworld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/library/helloworld:1.3</span></span></span></code></pre></div><p>それから変更を適用します：</p><div class="highlight wrap-code" dir=auto><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># update the deployment</span>
</span></span><span class=line><span class=cl>kubectl apply -f deployment.yaml</span></span></code></pre></div><p>これで重複したログエントリーが排除されたことがわかります。そして
残りのログエントリーは JSON としてフォーマットされ、span と trace ID が含まれています：</p><p><a href=#R-image-1ef083f03bc1b1f4c4b17f99512cef8f class=lightbox-link><img alt="JSON Format Logs" class="lazy lightbox figure-image" loading=lazy src=../images/logs_json_format.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-1ef083f03bc1b1f4c4b17f99512cef8f><img alt="JSON Format Logs" class="lazy lightbox lightbox-image" loading=lazy src=../images/logs_json_format.png></a></p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/10/27</span></span></footer></article><article class=default><header class=headline></header><h1 id=summary>Summary</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>2 minutes</span>
</span>&nbsp;<p>このワークショップでは、以下の概念についてハンズオンで体験しました：</p><ul><li>Linux ホストに<strong>Splunk Distribution of the OpenTelemetry Collector</strong>をデプロイする方法。</li><li><strong>Splunk Distribution of OpenTelemetry .NET</strong>で.NET アプリケーションを計装する方法。</li><li>.NET アプリケーションを「Docker 化」し、<strong>Splunk Distribution of OpenTelemetry .NET</strong>で計装する方法。</li><li>Helm を使用して Kubernetes クラスターに<strong>Splunk Distribution of the OpenTelemetry Collector</strong>をデプロイする方法。</li><li>コレクター設定をカスタマイズして問題をトラブルシューティングする方法。</li></ul><p>他の言語と環境で OpenTelemetry がどのように計装されるかを確認するには、
<a href=https://github.com/signalfx/splunk-opentelemetry-examples rel=external>Splunk OpenTelemetry Examples GitHub リポジトリ</a>をご覧ください。</p><p>将来このワークショップを独自に実行するには、これらの手順を参照して、Splunk Show の<strong>Splunk4Rookies - Observability</strong>
ワークショップテンプレートを使用して EC2 インスタンスをプロビジョニングしてください。</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>2025/06/16</span></span></footer></article></section></section></div></main></div><script src=/observability-workshop/js/clipboard/clipboard.min.js?1765303813 defer></script><script src=/observability-workshop/js/perfect-scrollbar/perfect-scrollbar.min.js?1765303813 defer></script><script src=/observability-workshop/js/theme.min.js?1765303813 defer></script></body></html>